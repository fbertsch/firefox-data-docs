<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Mozilla Data Documentation</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="dtmo.css">
        
        <link rel="stylesheet" href="mermaid.css">
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Mozilla Data Documentation</a></li><li class="chapter-item expanded "><a href="concepts/getting_started.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="concepts/terminology.html"><strong aria-hidden="true">1.1.</strong> Terminology</a></li><li class="chapter-item expanded "><a href="concepts/gaining_access.html"><strong aria-hidden="true">1.2.</strong> Gaining Access</a></li><li class="chapter-item expanded "><a href="concepts/analysis_intro.html"><strong aria-hidden="true">1.3.</strong> Analysis Quick Start</a></li><li class="chapter-item expanded "><a href="tools/interfaces.html"><strong aria-hidden="true">1.4.</strong> Tools for Data Analysis</a></li><li class="chapter-item expanded "><a href="concepts/analysis_gotchas.html"><strong aria-hidden="true">1.5.</strong> Common Analysis Gotchas</a></li><li class="chapter-item expanded "><a href="concepts/choosing_a_dataset.html"><strong aria-hidden="true">1.6.</strong> Choosing a Desktop Dataset</a></li><li class="chapter-item expanded "><a href="concepts/choosing_a_dataset_mobile.html"><strong aria-hidden="true">1.7.</strong> Choosing a Mobile Dataset</a></li><li class="chapter-item expanded "><a href="concepts/getting_help.html"><strong aria-hidden="true">1.8.</strong> Getting Help</a></li><li class="chapter-item expanded "><a href="concepts/reporting_a_problem.html"><strong aria-hidden="true">1.9.</strong> Reporting a problem</a></li></ol></li><li class="chapter-item expanded "><a href="metrics/index.html"><strong aria-hidden="true">2.</strong> Metrics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="metrics/definitions.html"><strong aria-hidden="true">2.1.</strong> Definitions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="metrics/metrics.html"><strong aria-hidden="true">2.1.1.</strong> Metrics</a></li><li class="chapter-item expanded "><a href="metrics/usage.html"><strong aria-hidden="true">2.1.2.</strong> Usage Criteria</a></li><li class="chapter-item expanded "><a href="metrics/dimensions.html"><strong aria-hidden="true">2.1.3.</strong> Slicing Dimensions</a></li></ol></li><li class="chapter-item expanded "><a href="metrics/policy.html"><strong aria-hidden="true">2.2.</strong> Metrics Standardization and Policy</a></li></ol></li><li class="chapter-item expanded "><a href="cookbooks/index.html"><strong aria-hidden="true">3.</strong> Tutorials &amp; Cookbooks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cookbooks/analysis/index.html"><strong aria-hidden="true">3.1.</strong> Analysis</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cookbooks/public_data.html"><strong aria-hidden="true">3.1.1.</strong> Accessing Public Data</a></li><li class="chapter-item expanded "><a href="cookbooks/bigquery.html"><strong aria-hidden="true">3.1.2.</strong> Accessing and working with BigQuery</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cookbooks/bigquery/access.html"><strong aria-hidden="true">3.1.2.1.</strong> Access</a></li><li class="chapter-item expanded "><a href="cookbooks/bigquery/querying.html"><strong aria-hidden="true">3.1.2.2.</strong> Writing Queries</a></li><li class="chapter-item expanded "><a href="cookbooks/bigquery/optimization.html"><strong aria-hidden="true">3.1.2.3.</strong> Optimization</a></li><li class="chapter-item expanded "><a href="tools/spark.html"><strong aria-hidden="true">3.1.2.4.</strong> Custom analysis with Spark</a></li></ol></li><li class="chapter-item expanded "><a href="tools/stmo.html"><strong aria-hidden="true">3.1.3.</strong> Introduction to STMO</a></li><li class="chapter-item expanded "><a href="concepts/glean/accessing_glean_data.html"><strong aria-hidden="true">3.1.4.</strong> Accessing Glean data</a></li><li class="chapter-item expanded "><a href="cookbooks/dataset_specific.html"><strong aria-hidden="true">3.1.5.</strong> Dataset-Specific</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cookbooks/normandy_events.html"><strong aria-hidden="true">3.1.5.1.</strong> Working with Normandy events</a></li><li class="chapter-item expanded "><a href="cookbooks/crash_pings.html"><strong aria-hidden="true">3.1.5.2.</strong> Working with Crash Pings</a></li><li class="chapter-item expanded "><a href="cookbooks/clients_last_seen_bits.html"><strong aria-hidden="true">3.1.5.3.</strong> Working with Bit Patterns in Clients Last Seen</a></li><li class="chapter-item expanded "><a href="cookbooks/main_ping_exponential_histograms.html"><strong aria-hidden="true">3.1.5.4.</strong> Visualizing Percentiles of an Main Ping Exponential Histogram</a></li></ol></li><li class="chapter-item expanded "><a href="cookbooks/realtime.html"><strong aria-hidden="true">3.1.6.</strong> Real-time</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cookbooks/view_pings_cep.html"><strong aria-hidden="true">3.1.6.1.</strong> Seeing Your Own Pings</a></li></ol></li><li class="chapter-item expanded "><a href="cookbooks/metrics.html"><strong aria-hidden="true">3.1.7.</strong> Metrics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cookbooks/dau.html"><strong aria-hidden="true">3.1.7.1.</strong> Daily Active Users (DAU and MAU)</a></li><li class="chapter-item expanded "><a href="cookbooks/active_dau.html"><strong aria-hidden="true">3.1.7.2.</strong> Active DAU (aDAU)</a></li><li class="chapter-item expanded "><a href="cookbooks/retention.html"><strong aria-hidden="true">3.1.7.3.</strong> Retention</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="cookbooks/operational/index.html"><strong aria-hidden="true">3.2.</strong> Operational</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cookbooks/gcp-projects.html"><strong aria-hidden="true">3.2.1.</strong> Creating a Prototype Data Project on Google Cloud Platform</a></li><li class="chapter-item expanded "><a href="cookbooks/operational/protosaur.html"><strong aria-hidden="true">3.2.2.</strong> Creating Static Dashboards with Protosaur</a></li><li class="chapter-item expanded "><a href="cookbooks/bigquery-airflow.html"><strong aria-hidden="true">3.2.3.</strong> Scheduling BigQuery Queries in Airflow</a></li><li class="chapter-item expanded "><a href="cookbooks/deploying-containers.html"><strong aria-hidden="true">3.2.4.</strong> Building and Deploying Containers to GCR with CircleCI</a></li><li class="chapter-item expanded "><a href="cookbooks/publishing_datasets.html"><strong aria-hidden="true">3.2.5.</strong> Publishing Datasets</a></li></ol></li><li class="chapter-item expanded "><a href="datasets/new_data.html"><strong aria-hidden="true">3.3.</strong> Sending telemetry</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cookbooks/client_guidelines.html"><strong aria-hidden="true">3.3.1.</strong> Implementing Experiments</a></li><li class="chapter-item expanded "><a href="cookbooks/events_best_practices.html"><strong aria-hidden="true">3.3.2.</strong> Sending Events</a></li><li class="chapter-item expanded "><a href="cookbooks/new_ping.html"><strong aria-hidden="true">3.3.3.</strong> Sending a Custom Ping</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="reference/index.html"><strong aria-hidden="true">4.</strong> Data Platform Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tools/guiding_principles.html"><strong aria-hidden="true">4.1.</strong> Guiding Principles for Data Infrastructure</a></li><li class="chapter-item expanded "><a href="concepts/glean/glean.html"><strong aria-hidden="true">4.2.</strong> Glean overview</a></li><li class="chapter-item expanded "><a href="concepts/pipeline/gcp_data_pipeline.html"><strong aria-hidden="true">4.3.</strong> Overview of Mozilla's Data Pipeline</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="concepts/pipeline/http_edge_spec.html"><strong aria-hidden="true">4.3.1.</strong> HTTP Edge Server Specification</a></li><li class="chapter-item expanded "><a href="concepts/pipeline/event_pipeline.html"><strong aria-hidden="true">4.3.2.</strong> Event Pipeline Detail</a></li><li class="chapter-item expanded "><a href="concepts/pipeline/schemas.html"><strong aria-hidden="true">4.3.3.</strong> Schemas</a></li><li class="chapter-item expanded "><a href="concepts/channels/channel_normalization.html"><strong aria-hidden="true">4.3.4.</strong> Channel Normalization</a></li><li class="chapter-item expanded "><a href="concepts/sample_id.html"><strong aria-hidden="true">4.3.5.</strong> Sampling</a></li><li class="chapter-item expanded "><a href="concepts/pipeline/filtering.html"><strong aria-hidden="true">4.3.6.</strong> Filtering</a></li></ol></li><li class="chapter-item expanded "><a href="concepts/sql_style.html"><strong aria-hidden="true">4.4.</strong> SQL Style Guide</a></li><li class="chapter-item expanded "><a href="concepts/index.html"><strong aria-hidden="true">4.5.</strong> Telemetry Behavior Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="concepts/history.html"><strong aria-hidden="true">4.5.1.</strong> History of Telemetry</a></li><li class="chapter-item expanded "><a href="concepts/profile/index.html"><strong aria-hidden="true">4.5.2.</strong> Profile Behavior</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="concepts/profile/profile_creation.html"><strong aria-hidden="true">4.5.2.1.</strong> Profile Creation</a></li><li class="chapter-item expanded "><a href="concepts/profile/realworldusage.html"><strong aria-hidden="true">4.5.2.2.</strong> Real World Usage</a></li><li class="chapter-item expanded "><a href="concepts/profile/profilehistory.html"><strong aria-hidden="true">4.5.2.3.</strong> Profile History</a></li></ol></li><li class="chapter-item expanded "><a href="concepts/engagement.html"><strong aria-hidden="true">4.5.3.</strong> Engagement metrics</a></li><li class="chapter-item expanded "><a href="concepts/segments.html"><strong aria-hidden="true">4.5.4.</strong> User states/Segments</a></li></ol></li><li class="chapter-item expanded "><a href="tools/projects.html"><strong aria-hidden="true">4.6.</strong> Project Glossary</a></li></ol></li><li class="chapter-item expanded "><a href="datasets/reference.html"><strong aria-hidden="true">5.</strong> Dataset Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datasets/pings.html"><strong aria-hidden="true">5.1.</strong> Pings</a></li><li class="chapter-item expanded "><a href="datasets/derived.html"><strong aria-hidden="true">5.2.</strong> Derived Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datasets/active_profiles.html"><strong aria-hidden="true">5.2.1.</strong> Active Profiles</a></li><li class="chapter-item expanded "><a href="datasets/batch_view/addons/reference.html"><strong aria-hidden="true">5.2.2.</strong> Addons</a></li><li class="chapter-item expanded "><a href="datasets/other/addons_daily/reference.html"><strong aria-hidden="true">5.2.3.</strong> Addons Daily</a></li><li class="chapter-item expanded "><a href="datasets/other/asn_aggregates/reference.html"><strong aria-hidden="true">5.2.4.</strong> Autonomous System Aggregates</a></li><li class="chapter-item expanded "><a href="datasets/other/attitudes_daily/reference.html"><strong aria-hidden="true">5.2.5.</strong> Attitudes Daily</a></li><li class="chapter-item expanded "><a href="datasets/batch_view/clients_daily/reference.html"><strong aria-hidden="true">5.2.6.</strong> Clients Daily</a></li><li class="chapter-item expanded "><a href="datasets/bigquery/clients_last_seen/reference.html"><strong aria-hidden="true">5.2.7.</strong> Clients Last Seen</a></li><li class="chapter-item expanded "><a href="datasets/batch_view/events/reference.html"><strong aria-hidden="true">5.2.8.</strong> Events</a></li><li class="chapter-item expanded "><a href="datasets/bigquery/exact_mau/reference.html"><strong aria-hidden="true">5.2.9.</strong> Exact MAU</a></li><li class="chapter-item expanded "><a href="datasets/main_ping_tables.html"><strong aria-hidden="true">5.2.10.</strong> Main Ping Tables</a></li><li class="chapter-item expanded "><a href="datasets/batch_view/main_summary/reference.html"><strong aria-hidden="true">5.2.11.</strong> Main Summary</a></li><li class="chapter-item expanded "><a href="datasets/other/socorro_crash/reference.html"><strong aria-hidden="true">5.2.12.</strong> Socorro Crash Reports</a></li><li class="chapter-item expanded "><a href="datasets/other/ssl/reference.html"><strong aria-hidden="true">5.2.13.</strong> SSL Ratios (public)</a></li><li class="chapter-item expanded "><a href="datasets/batch_view/telemetry_aggregates/reference.html"><strong aria-hidden="true">5.2.14.</strong> Telemetry Aggregates</a></li></ol></li><li class="chapter-item expanded "><a href="tools/experiments.html"><strong aria-hidden="true">5.3.</strong> Experiment Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datasets/jetstream.html"><strong aria-hidden="true">5.3.1.</strong> Jetstream</a></li><li class="chapter-item expanded "><a href="datasets/heartbeat.html"><strong aria-hidden="true">5.3.2.</strong> Accessing Heartbeat data</a></li><li class="chapter-item expanded "><a href="datasets/shield.html"><strong aria-hidden="true">5.3.3.</strong> Accessing Shield Study data</a></li><li class="chapter-item expanded "><a href="datasets/dynamic_telemetry.html"><strong aria-hidden="true">5.3.4.</strong> Dynamic telemetry</a></li><li class="chapter-item expanded "><a href="datasets/experiment_monitoring.html"><strong aria-hidden="true">5.3.5.</strong> Experiment monitoring</a></li></ol></li><li class="chapter-item expanded "><a href="datasets/search.html"><strong aria-hidden="true">5.4.</strong> Search Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datasets/search/search_aggregates/reference.html"><strong aria-hidden="true">5.4.1.</strong> Search Aggregates</a></li><li class="chapter-item expanded "><a href="datasets/search/search_clients_daily/reference.html"><strong aria-hidden="true">5.4.2.</strong> Search Clients Daily</a></li><li class="chapter-item expanded "><a href="datasets/search/search_clients_last_seen/reference.html"><strong aria-hidden="true">5.4.3.</strong> Search Clients Last Seen</a></li><li class="chapter-item expanded "><a href="datasets/search/client_ltv/reference.html"><strong aria-hidden="true">5.4.4.</strong> Client LTV</a></li></ol></li><li class="chapter-item expanded "><a href="datasets/non_desktop.html"><strong aria-hidden="true">5.5.</strong> Non-Desktop Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datasets/non_desktop/day_2_7_activation/reference.html"><strong aria-hidden="true">5.5.1.</strong> Day 2-7 Activation</a></li><li class="chapter-item expanded "><a href="datasets/non_desktop/google_play_store/reference.html"><strong aria-hidden="true">5.5.2.</strong> Google Play Store</a></li><li class="chapter-item expanded "><a href="datasets/non_desktop/apple_app_store/reference.html"><strong aria-hidden="true">5.5.3.</strong> Apple App Store</a></li><li class="chapter-item expanded "><a href="datasets/non_desktop/events_daily/reference.html"><strong aria-hidden="true">5.5.4.</strong> Events Daily</a></li></ol></li><li class="chapter-item expanded "><a href="datasets/other.html"><strong aria-hidden="true">5.6.</strong> Other Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datasets/other/hgpush/reference.html"><strong aria-hidden="true">5.6.1.</strong> hgpush</a></li><li class="chapter-item expanded "><a href="datasets/other/stub_installer/reference.html"><strong aria-hidden="true">5.6.2.</strong> Stub installer ping</a></li><li class="chapter-item expanded "><a href="datasets/other/activity-stream/reference.html"><strong aria-hidden="true">5.6.3.</strong> Activity Stream</a></li><li class="chapter-item expanded "><a href="datasets/other/bmobugs/reference.html"><strong aria-hidden="true">5.6.4.</strong> bmobugs</a></li></ol></li><li class="chapter-item expanded "><a href="datasets/fxa.html"><strong aria-hidden="true">5.7.</strong> Firefox Accounts Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datasets/fxa_metrics/attribution.html"><strong aria-hidden="true">5.7.1.</strong> Firefox Account Attribution</a></li><li class="chapter-item expanded "><a href="datasets/fxa_metrics/funnels.html"><strong aria-hidden="true">5.7.2.</strong> Firefox Account Funnel Metrics</a></li><li class="chapter-item expanded "><a href="datasets/fxa_metrics/emails.html"><strong aria-hidden="true">5.7.3.</strong> Firefox Account Email Metrics</a></li></ol></li><li class="chapter-item expanded "><a href="datasets/static.html"><strong aria-hidden="true">5.8.</strong> Static Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datasets/static/normalized_os.html"><strong aria-hidden="true">5.8.1.</strong> Normalized OS Names And Versions</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="historical/index.html"><strong aria-hidden="true">6.</strong> Historical Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="concepts/pipeline/data_pipeline.html"><strong aria-hidden="true">6.1.</strong> Previous AWS Pipeline Overview</a></li><li class="chapter-item expanded "><a href="concepts/pipeline/data_pipeline_detail.html"><strong aria-hidden="true">6.2.</strong> In-depth AWS Data Pipeline Detail</a></li><li class="chapter-item expanded "><a href="concepts/censuses.html"><strong aria-hidden="true">6.3.</strong> Legacy Census Metrics</a></li><li class="chapter-item expanded "><a href="datasets/obsolete.html"><strong aria-hidden="true">6.4.</strong> Obsolete Datasets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datasets/obsolete/churn/reference.html"><strong aria-hidden="true">6.4.1.</strong> Churn</a></li><li class="chapter-item expanded "><a href="datasets/obsolete/client_count/reference.html"><strong aria-hidden="true">6.4.2.</strong> Client Count</a></li><li class="chapter-item expanded "><a href="datasets/obsolete/client_count_daily/reference.html"><strong aria-hidden="true">6.4.3.</strong> Client Count Daily</a></li><li class="chapter-item expanded "><a href="datasets/obsolete/crash_aggregates/reference.html"><strong aria-hidden="true">6.4.4.</strong> Crash Aggregates</a></li><li class="chapter-item expanded "><a href="datasets/obsolete/crash_summary/reference.html"><strong aria-hidden="true">6.4.5.</strong> Crash Summary</a></li><li class="chapter-item expanded "><a href="datasets/obsolete/error_aggregates/reference.html"><strong aria-hidden="true">6.4.6.</strong> Error Aggregates</a></li><li class="chapter-item expanded "><a href="datasets/obsolete/first_shutdown_summary/reference.html"><strong aria-hidden="true">6.4.7.</strong> First Shutdown Summary</a></li><li class="chapter-item expanded "><a href="datasets/obsolete/heavy_users/reference.html"><strong aria-hidden="true">6.4.8.</strong> Heavy Users</a></li><li class="chapter-item expanded "><a href="datasets/obsolete/longitudinal/reference.html"><strong aria-hidden="true">6.4.9.</strong> Longitudinal</a></li><li class="chapter-item expanded "><a href="datasets/obsolete/retention/reference.html"><strong aria-hidden="true">6.4.10.</strong> Retention</a></li><li class="chapter-item expanded "><a href="datasets/obsolete/sync_summary/reference.html"><strong aria-hidden="true">6.4.11.</strong> Sync Summary</a></li><li class="chapter-item expanded "><a href="datasets/obsolete/update/reference.html"><strong aria-hidden="true">6.4.12.</strong> Update</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="contributing/index.html"><strong aria-hidden="true">7.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="contributing/style_guide.html"><strong aria-hidden="true">7.1.</strong> Style Guide</a></li><li class="chapter-item expanded "><a href="contributing/structure.html"><strong aria-hidden="true">7.2.</strong> Structure</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Mozilla Data Documentation</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/mozilla/data-docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#mozilla-data-documentation" id="mozilla-data-documentation">Mozilla Data Documentation</a></h1>
<p>This documentation helps Mozilla's developers and data scientists analyze and interpret the data gathered
by the Mozilla Telemetry system.</p>
<p>At <a href="https://www.mozilla.org">Mozilla</a>, our data-gathering and data-handling practices are anchored in our
<a href="https://www.mozilla.org/en-US/privacy/principles/">Data Privacy Principles</a> and elaborated in the
<a href="https://www.mozilla.org/en-US/privacy/">Mozilla Privacy Policy</a>. You can learn more about what data Firefox
collects and the choices you can make as a Firefox user in the
<a href="https://www.mozilla.org/en-US/privacy/firefox/">Firefox Privacy Notice</a>.</p>
<p>If there's information missing from these docs, or if you'd like to contribute, see <a href="contributing/index.html">this article on contributing</a>,
and feel free to <a href="https://bugzilla.mozilla.org/enter_bug.cgi?assigned_to=nobody%40mozilla.org&amp;bug_file_loc=http%3A%2F%2F&amp;bug_ignored=0&amp;bug_severity=normal&amp;bug_status=NEW&amp;cf_fx_iteration=---&amp;cf_fx_points=---&amp;component=Documentation%20and%20Knowledge%20Repo%20%28RTMO%29&amp;contenttypemethod=autodetect&amp;contenttypeselection=text%2Fplain&amp;defined_groups=1&amp;flag_type-4=X&amp;flag_type-607=X&amp;flag_type-800=X&amp;flag_type-803=X&amp;flag_type-916=X&amp;form_name=enter_bug&amp;maketemplate=Remember%20values%20as%20bookmarkable%20template&amp;op_sys=Linux&amp;priority=--&amp;product=Data%20Platform%20and%20Tools&amp;rep_platform=x86_64&amp;target_milestone=---&amp;version=unspecified">file a bug here</a>.</p>
<p>You can locate the source for this documentation in the <a href="https://github.com/mozilla/data-docs">data-docs repository</a> on GitHub.</p>
<h2><a class="header" href="#using-this-document" id="using-this-document">Using this document</a></h2>
<p>This documentation is divided into the following sections:</p>
<h3><a class="header" href="#a-hrefconceptsgetting_startedhtmlgetting-starteda" id="a-hrefconceptsgetting_startedhtmlgetting-starteda"><a href="concepts/getting_started.html">Getting Started</a></a></h3>
<p>This section provides a <strong>quick introduction</strong> to analyzing telemetry data.
After reading these articles, you will be able to confidently perform analysis
over telemetry data.</p>
<h3><a class="header" href="#a-hrefmetricsindexhtmlstandard-metricsa" id="a-hrefmetricsindexhtmlstandard-metricsa"><a href="metrics/index.html">Standard Metrics</a></a></h3>
<p>This section provides an overview of standard metrics used at Mozilla. Here you'll
find the definitions and descriptions for each.</p>
<h3><a class="header" href="#a-hrefcookbooksindexhtmlcookbooks--tutorialsa" id="a-hrefcookbooksindexhtmlcookbooks--tutorialsa"><a href="cookbooks/index.html">Cookbooks &amp; Tutorials</a></a></h3>
<p>This section contains tutorials presented in a simple problem/solution format, organized by topic.</p>
<h3><a class="header" href="#a-hrefreferenceindexhtmldata-platform-referencea" id="a-hrefreferenceindexhtmldata-platform-referencea"><a href="reference/index.html">Data Platform Reference</a></a></h3>
<p>This section contains detailed reference material on the Mozilla data platform, including links to other resources where appropriate.</p>
<h3><a class="header" href="#a-hrefdatasetsreferencehtmldataset-referencea" id="a-hrefdatasetsreferencehtmldataset-referencea"><a href="datasets/reference.html">Dataset Reference</a></a></h3>
<p>Describes all available data we have from our products.
For each dataset, we include a description of the dataset's purpose,
what data is included, how the data is collected,
and how you can change or augment the dataset.
You do not need to read this section end-to-end.</p>
<h3><a class="header" href="#a-hrefhistoricalindexhtmlhistorical-referencea" id="a-hrefhistoricalindexhtmlhistorical-referencea"><a href="historical/index.html">Historical Reference</a></a></h3>
<p>This section contains some documentation of things that used to be part of the Mozilla Data Platform, but are no
longer. You can generally safely ignore this section, it is intended only to answer questions like &quot;what happened to X?&quot;.</p>
<p>You can find the <a href="https://docs.telemetry.mozilla.org">fully-rendered documentation here</a>,
rendered with <a href="https://github.com/rust-lang/mdBook">mdBook</a>, and hosted on Github pages.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/introduction.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#getting-started" id="getting-started">Getting Started</a></h1>
<p>This document is meant to be a complete guide to using Mozilla Data,
so it can look overwhelming at first.
These readings will <strong>get you up and running quickly</strong>.
After these readings you should be able to produce simple analyses
but you should definitely get your analyses reviewed.</p>
<p>This section is meant to introduce new analysts to our data.
A &quot;new analyst&quot; is an employee
or contributor who is interested in working with Mozilla's data
but is new to our data platform and systems.
They could be technical or non-technical: engineer, product manager, or data scientist.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/getting_started.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#terminology" id="terminology">Terminology</a></h1>
<h2><a class="header" href="#table-of-contents" id="table-of-contents">Table of Contents</a></h2>
<p>This glossary provides definitions for commonly-used terms at Mozilla.</p>
<ul>
<li><a href="concepts/terminology.html#aet">AET</a></li>
<li><a href="concepts/terminology.html#analyst">Analyst</a></li>
<li><a href="concepts/terminology.html#amplitude">Amplitude</a></li>
<li><a href="concepts/terminology.html#bigquery">BigQuery</a></li>
<li><a href="concepts/terminology.html#client-id">Client ID</a></li>
<li><a href="concepts/terminology.html#data-analyst">Data Analyst</a></li>
<li><a href="concepts/terminology.html#data-engineer">Data Engineer</a></li>
<li><a href="concepts/terminology.html#data-practitioner">Data Practitioner</a></li>
<li><a href="concepts/terminology.html#data-scientist">Data Scientist</a></li>
<li><a href="concepts/terminology.html#dataset">Dataset</a></li>
<li><a href="concepts/terminology.html#dau">DAU</a></li>
<li><a href="concepts/terminology.html#derived-dataset">Derived Dataset</a></li>
<li><a href="concepts/terminology.html#glean">Glean</a></li>
<li><a href="concepts/terminology.html#gcp">GCP</a></li>
<li><a href="concepts/terminology.html#geoip">GeoIP</a></li>
<li><a href="concepts/terminology.html#ingestion">Ingestion</a></li>
<li><a href="concepts/terminology.html#intensity">Intensity</a></li>
<li><a href="concepts/terminology.html#metric">Metric</a></li>
<li><a href="concepts/terminology.html#mau">MAU</a></li>
<li><a href="concepts/terminology.html#ping">Ping</a></li>
<li><a href="concepts/terminology.html#ping-table">Ping Table</a></li>
<li><a href="concepts/terminology.html#pipeline">Pipeline</a></li>
<li><a href="concepts/terminology.html#probe">Probe</a></li>
<li><a href="concepts/terminology.html#profile">Profile</a></li>
<li><a href="concepts/terminology.html#query">Query</a></li>
<li><a href="concepts/terminology.html#retention">Retention</a></li>
<li><a href="concepts/terminology.html#schema">Schema</a></li>
<li><a href="concepts/terminology.html#session">Session</a></li>
<li><a href="concepts/terminology.html#subsession">Subsession</a></li>
<li><a href="concepts/terminology.html#stmo-sqltelemetrymozillaorg">STMO (sql.telemetry.mozilla.org)</a></li>
<li><a href="concepts/terminology.html#telemetry">Telemetry</a>
<ul>
<li><a href="concepts/terminology.html#wau">WAU</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#aet" id="aet">AET</a></h2>
<p>Account Ecosystem Telemetry; see the <a href="https://docs.google.com/document/d/1yRLiD8JuaZIIaKhs6DhXEa7aH8jwOau5yW0kHaldFQU/edit#">PRD</a></p>
<h2><a class="header" href="#analyst" id="analyst">Analyst</a></h2>
<p>See <a href="concepts/terminology.html#data-analyst">Data Analyst</a>.</p>
<h2><a class="header" href="#amplitude" id="amplitude">Amplitude</a></h2>
<p>A third-party product used by several teams within Mozilla for analysis of user events.</p>
<h2><a class="header" href="#bigquery" id="bigquery">BigQuery</a></h2>
<p><a href="https://cloud.google.com/bigquery">BigQuery</a> is Google Cloud's managed data warehouse. Most of the data described on this site is stored and queried using BigQuery. See <a href="concepts/../cookbooks/bigquery.html">Accessing and working with BigQuery</a> for more details.</p>
<h2><a class="header" href="#client-id" id="client-id">Client ID</a></h2>
<p>A unique id identifying the client who sent a <a href="concepts/terminology.html#ping">ping</a>.</p>
<h2><a class="header" href="#data-analyst" id="data-analyst">Data Analyst</a></h2>
<p>This is a common job title for someone who spends a large amount of their time analyzing data. At Mozilla, we tend not to use this term or title, favoring <a href="concepts/terminology.html#data-practitioner">Data Practitioner</a> or <a href="concepts/terminology.html#data-scientist">Data Scientist</a> instead.</p>
<h2><a class="header" href="#data-engineer" id="data-engineer">Data Engineer</a></h2>
<p>A &quot;Data Engineer&quot; at Mozilla generally refers to someone on the Data Engineering team. They implement and maintain the data platform and tools described in this document. They may also assist data scientists or other data practitioners, as needed.</p>
<h2><a class="header" href="#data-practitioner" id="data-practitioner">Data Practitioner</a></h2>
<p>A data practitioner is someone who looks at data, identifies trends and other qualitative measurements in them, and creates charts and dashboards. It could be anyone: engineer, product manager, data engineer or data scientist.</p>
<h2><a class="header" href="#data-scientist" id="data-scientist">Data Scientist</a></h2>
<p>A &quot;Data Scientist&quot; at Mozilla generally refers to someone on the Data Science team. They have a broad array of technical backgrounds and a core set of common professional skills:</p>
<ul>
<li>applying statistical methods to noisy data to answer questions about what, how, or why something is happening</li>
<li>transform unstructured data into usable metrics and models</li>
<li>augmenting strategic product and decision-making with empirical evidence created and curated by the team</li>
</ul>
<h2><a class="header" href="#dataset" id="dataset">Dataset</a></h2>
<p>A set of data, which includes ping data, derived datasets, etc.; sometimes it is used synonymously with “table”; sometimes it is used technically to refer to a <a href="concepts/terminology.html#bigquery">BigQuery</a> dataset, which represents a container for one or more tables.</p>
<h2><a class="header" href="#dau" id="dau">DAU</a></h2>
<p>The number of unique profiles active on each day.</p>
<h2><a class="header" href="#derived-dataset" id="derived-dataset">Derived Dataset</a></h2>
<p>A processed dataset, such as <a href="concepts/../datasets/batch_view/clients_daily/reference.html">Clients Daily</a>. At Mozilla, this is in contrast to a raw ping table which represents (more or less) the raw data submitted by our users.</p>
<h2><a class="header" href="#glean" id="glean">Glean</a></h2>
<p>Glean is Mozilla’s product analytics &amp; telemetry solution that provides a consistent experience and behavior across all of our products. Most of Mozilla's mobile apps, including Fenix, have been adapted to use the Glean SDK. For more information, see the <a href="concepts/./glean/glean.html">Glean Overview</a>.</p>
<h2><a class="header" href="#gcp" id="gcp">GCP</a></h2>
<p>Google Cloud Platform (GCP) is a suite of cloud-computing services that runs on the same infrastructure that Google uses internally for its end-user products.</p>
<h2><a class="header" href="#geoip" id="geoip">GeoIP</a></h2>
<p>IP Geolocation involves attempting to discover the location of an IP address in the real world. IP addresses are assigned to an organization, and as these are ever-changing associations, it can be difficult to determine exactly where in the world an IP address is located. Mozilla’s ingestion infrastructure attempts to perform GeoIP lookup during the data decoding process and subsequently discards the IP address before the message arrives in long-term storage.</p>
<h2><a class="header" href="#ingestion" id="ingestion">Ingestion</a></h2>
<p>Mozilla's core data platform has been built to support structured ingestion of arbitrary JSON payloads whether they come from browser products on client devices or from server-side applications that have nothing to do with Firefox; any team at Mozilla can hook into structured ingestion by defining a schema and registering it with pipeline. Once a schema is registered, everything else is automatically provisioned, from an HTTPS endpoint for accepting payloads to a set of tables in BigQuery for holding the processed data.</p>
<h2><a class="header" href="#intensity" id="intensity">Intensity</a></h2>
<p>Intuitively, how many days per week do users use the product? Among profiles active at least once in the week ending on the date specified, the number of days on average they were active during that one-week window.</p>
<h2><a class="header" href="#metric" id="metric">Metric</a></h2>
<p>A metric is anything that you want to (and can) measure. This differs from a dimension which is a qualitative attribute of data.</p>
<h2><a class="header" href="#mau" id="mau">MAU</a></h2>
<p>Monthly Active Users - the number of unique profiles active in the 28-day period ending on a given day. The number of unique profiles active at least once during the 28-day window
ending on the specified day.</p>
<h2><a class="header" href="#ping" id="ping">Ping</a></h2>
<p>A ping represents a message that is sent from the Firefox browser to Mozilla’s Telemetry servers. It typically includes information about the browser’s state, user actions, etc.
<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/common-ping.html">for more details</a></p>
<h2><a class="header" href="#ping-table" id="ping-table">Ping Table</a></h2>
<p>A set of pings that is stored in a BigQuery table. See article on <a href="concepts/../datasets/pings.html">raw ping datasets</a>.</p>
<h2><a class="header" href="#pipeline" id="pipeline">Pipeline</a></h2>
<p>Mozilla’s data pipeline, which is used to collect Telemetry data from Mozilla’s products and logs from various services.
The bulk of the data that is handled by this pipeline is Firefox Telemetry data. The same tool-chain is used to collect, store, and analyze data that comes from many sources.</p>
<p>For more information, see <a href="concepts/./pipeline/gcp_data_pipeline.html">An overview of Mozilla’s Data Pipeline</a>.</p>
<h2><a class="header" href="#probe" id="probe">Probe</a></h2>
<p>Measurements for a specific aspect of Firefox are called probes. A single telemetry ping sends many different probes. Probes are either Histograms (recording distributions of data points) or Scalars (recording a single value).</p>
<p>You can search for details about probes by using the <a href="https://probes.telemetry.mozilla.org/">Probe Dictionary</a>. For each probe, the probe dictionary provides:</p>
<ul>
<li>A description of the probe</li>
<li>When a probe started being collected</li>
<li>Whether data from this probe is collected in the release channel</li>
</ul>
<h2><a class="header" href="#profile" id="profile">Profile</a></h2>
<p>All of the changes a user makes in Firefox, like the home page, what toolbars you use, installed addons, saved passwords and your bookmarks, are all stored in a special folder, called a profile. Telemetry stores archived and pending pings in the profile directory as well as metadata like the <a href="concepts/terminology.html#client-id">client id</a>. See also <a href="concepts/./profile/profile_creation.html">Profile Creation</a></p>
<h2><a class="header" href="#query" id="query">Query</a></h2>
<p>Typically refers to a query written in the SQL syntax, run on (for example) <a href="concepts/terminology.html#stmo">STMO</a>.</p>
<h2><a class="header" href="#retention" id="retention">Retention</a></h2>
<ul>
<li>
<p>As in “Data retention” - how long data is stored before it is automatically deleted/archived</p>
</li>
<li>
<p>As in “User retention” - how likely is a user to continue using a product</p>
</li>
</ul>
<h2><a class="header" href="#schema" id="schema">Schema</a></h2>
<p>A schema is the organization or structure for our data. We use schemas at many levels (in data ingestion and storage) to make sure the data we submit is valid and possible to be processed efficiently.</p>
<h2><a class="header" href="#session" id="session">Session</a></h2>
<p>The period of time that it takes between Firefox being started until it is shut down. See also <a href="concepts/terminology.html#subsession">subsession</a>.</p>
<h2><a class="header" href="#subsession" id="subsession">Subsession</a></h2>
<p>In Firefox, <a href="concepts/terminology.html#sessions">Sessions</a> are split into subsessions after every 24-hour time period has passed or the environment has changed.
(<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/concepts/sessions.html?highlight=subsession">for more details</a>)</p>
<h2><a class="header" href="#stmo-sqltelemetrymozillaorg" id="stmo-sqltelemetrymozillaorg">STMO (sql.telemetry.mozilla.org)</a></h2>
<p>A service for creating queries and dashboards. See <a href="concepts/../tools/interfaces.html#sqltelemetrymozillaorg-stmo">STMO under analysis tools</a>.</p>
<h2><a class="header" href="#telemetry" id="telemetry">Telemetry</a></h2>
<p>As you use Firefox, Telemetry measures and collects non-personal information, such as performance, hardware, usage and customizations. It then sends this information to Mozilla on a daily basis and we use it to improve Firefox.</p>
<h3><a class="header" href="#wau" id="wau">WAU</a></h3>
<p>The number of unique profiles active at least once during the 7-day window
ending on the specified day.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/terminology.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#accessing-telemetry-data" id="accessing-telemetry-data">Accessing Telemetry data</a></h1>
<h2><a class="header" href="#public-data" id="public-data">Public Data</a></h2>
<p>Aggregated information on the Firefox user population (including hardware, operating system, and other usage characteristics) is available at the <a href="https://data.firefox.com/">Firefox Public Data Report</a> portal.</p>
<p>In addition, a set of curated datasets are available to the public for research purposes. See the <a href="concepts/../cookbooks/public_data.html">public data cookbook</a> for more information.</p>
<h2><a class="header" href="#non-public-data" id="non-public-data">Non-public Data</a></h2>
<p>Access to other Telemetry data is limited to two groups:</p>
<ol>
<li>Mozilla employees and contractors</li>
<li>Contributors who have signed a <a href="https://wiki.mozilla.org/NDA">non-disclosure agreement</a>, have a sustained track record of contribution, and have a demonstrated need to access this data</li>
</ol>
<p>If you are an employee or contractor, you should already have the necessary permissions.</p>
<p>If you are a contributor and want to request access to Mozilla Telemetry data, <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Data%20Platform%20and%20Tools&amp;component=Operations">file a bug in the operations component</a>
and ask an established Mozilla contributor or employee to vouch for you.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/gaining_access.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#get-started-with-firefox-desktop-data" id="get-started-with-firefox-desktop-data">Get Started with Firefox Desktop Data</a></h1>
<p>The following topics describe Firefox Desktop Telemetry data that has been captured for many years. The modern data collection is based on the <a href="concepts/glean/glean.html">Glean platform</a>.
Older mobile product data used different platforms, that are described
in <a href="concepts/choosing_a_dataset_mobile.html">Choosing a Mobile Dataset</a>.</p>
<p>Firefox clients send data as <em>pings</em>. <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/main-ping.html"><code>Main</code> pings</a> include some combination of <em>environment</em> data (e.g., information about operating system, hardware, and Firefox versions), <a href="https://probes.telemetry.mozilla.org/"><em>measurements</em></a>
(e.g., information about the maximum number of open tabs and time spent running in JavaScript garbage collections),
and <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/events.html"><em>events</em></a> (be aware that desktop events have largely been migrated
to a separate <code>event</code> ping).</p>
<p>Most of the data for Firefox Desktop data is received from <code>main</code> pings.</p>
<h2><a class="header" href="#measurement-types" id="measurement-types">Measurement Types</a></h2>
<p>Measurements for a specific aspect of a product are called <em>probes</em>. A single telemetry ping sends many different probes. Probes are either <em>Histograms</em> (recording distributions of data points) or <em>Scalars</em> (recording a single value).</p>
<p>You can search for details about probes by using the <a href="https://probes.telemetry.mozilla.org/">Probe Dictionary</a>. For each probe, the probe dictionary will give you:</p>
<ul>
<li>A description of the probe</li>
<li>When a probe started being collected</li>
<li>Whether data from this probe is collected in the release channel</li>
</ul>
<p>Histograms are represented as bucketed counts. The <a href="https://github.com/mozilla/gecko-dev/blob/master/toolkit/components/telemetry/Histograms.json"><code>Histograms.json</code></a> file includes definitions for all histograms. The definitions include information about the minimum, maximum, and number of buckets. Any recorded value instead just increments its associated bucket.</p>
<p>The following main types of histograms are available:</p>
<ul>
<li>Boolean - Only two buckets, associated with true and false</li>
<li>Enumerated - Integer buckets, where usually each bucket has a label</li>
<li>Linear - Buckets are divided evenly between the minimum and maximum
e.g., [1-2] is a bucket and so is [100-101]</li>
<li>Exponential - Larger valued buckets cover a larger range
e.g., [1-2] is a bucket, and so is [100-200]</li>
</ul>
<p>You can visualize how some of these types of histograms work using <a href="https://telemetry.mozilla.org/histogram-simulator">Histogram Simulator</a>.</p>
<p>Scalars are represented as a single value.
The <a href="https://searchfox.org/mozilla-central/source/toolkit/components/telemetry/Scalars.yaml"><code>Scalars.yaml</code></a> file includes definitions for all scalars.
These values can be integers, strings, or booleans.</p>
<h2><a class="header" href="#telemetrymozillaorg" id="telemetrymozillaorg"><code>telemetry.mozilla.org</code></a></h2>
<p>If you want to view probe data, go to <a href="https://telemetry.mozilla.org/"><code>telemetry.mozilla.org</code></a> (<a href="https://telemetry.mozilla.org/">TMO</a>). You can then choose either the <a href="https://telemetry.mozilla.org/new-pipeline/dist.html">Measurement Dashboard</a>
or the <a href="https://telemetry.mozilla.org/new-pipeline/evo.html">Evolution Dashboard</a>. You can then compare a probe's value between populations (e.g., <code>GC_MS</code> for 64 bit vs. 32 bit) and even track it across builds.</p>
<p>The <a href="https://telemetry.mozilla.org/new-pipeline/dist.html">Measurement Dashboard</a> represents a snapshot that shows how data is aggregated from all chosen dimensions. The Y axis represents the percentage (%) of samples while the X axis represents a bucket. Although you can use the Measurement Dashboard to compare between dimensions, you cannot view how data changes data over time. If you want to investigate this issue further, you must use the <a href="https://telemetry.mozilla.org/new-pipeline/evo.html">Evolution Dashboard</a>.</p>
<p>The <a href="https://telemetry.mozilla.org/new-pipeline/evo.html">Evolution Dashboard</a> shows how data changes over time. You can choose the statistics that you want to plot over time, e.g., Median or 95th percentile.
The X axis represents time and the Y axis represents the value for the statistics that you have chosen. As an example, this <a href="https://telemetry.mozilla.org/new-pipeline/evo.html#!aggregates=median!95th-percentile&amp;cumulative=0&amp;end_date=2017-06-13&amp;keys=!__none__!__none__&amp;max_channel_version=nightly%252F56&amp;measure=GC_MS&amp;min_channel_version=nightly%252F53&amp;processType=*&amp;product=Firefox&amp;sanitize=1&amp;sort_keys=submissions&amp;start_date=2017-06-12&amp;trim=1&amp;use_submission_date=0">dashboard</a> shows how <code>GC_MS</code> improves from
nightly 53 to nightly 56! While the median does not change much, the 95th percentile trends down to indicate that long garbage collections are being shortened.</p>
<p>The X axis on the Evolution Dashboard shows either a Build ID (a date) or a Submission Date. Although submissions may be received from many builds on any single date, aggregating data by Build ID indicates that a change occurred because a new build was created.</p>
<p>The second plot on the Evolution View represents the number of pings that are included in a
probe (Metric Count).</p>
<h3><a class="header" href="#caveats" id="caveats">Caveats</a></h3>
<ul>
<li>Data is aggregated on a <em>per-ping</em> basis, which indicates that you <em>cannot use these dashboards to say anything definitive about users</em>.
Please repeat that to yourself.
A trend in the evolution view may be caused not by a change affecting lots of
users, but a change affecting <em>one</em> single user who is now sending 50% of
the pings we see.
<a href="https://mozilla.report/post/projects%2Fproblematic_client.kp">And yes, it has occurred.</a></li>
<li>Sometimes it looks like no data is present even though you think there it should appear.
Check under advanced settings and &quot;Don't Sanitize&quot; and &quot;Don't Trim Buckets&quot;.
If you are still unable to locate the data, see <a href="concepts/getting_help.html">getting help</a>.</li>
<li>TMO Measurement Dashboards do not currently show release-channel data.
Release-channel data <a href="https://medium.com/georg-fritzsche/data-preference-changes-in-firefox-58-2d5df9c428b5">ceased being aggregated</a> as of Firefox 58.
This issue is being evaluated at this time and is under consideration for getting corrected in the near future.</li>
</ul>
<h2><a class="header" href="#where-to-go-next" id="where-to-go-next">Where to go next</a></h2>
<p>Read through <a href="concepts/../tools/interfaces.html">Analysis Interfaces</a> for more information on tools available for analysis and then work through the rest of the material in this section.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/analysis_intro.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#tools-for-data-analysis" id="tools-for-data-analysis">Tools for Data Analysis</a></h1>
<p>This is a starting point for making sense of the tools used for analyzing Mozilla data. There are different tools available, each with their own strengths, tailored to a variety of use cases and skill sets.</p>
<ul>
<li><a href="tools/interfaces.html#high-level-tools">High-level tools</a>
<ul>
<li><a href="tools/interfaces.html#mozilla-growth--usage-dashboard-gud">Mozilla Growth &amp; Usage Dashboard (GUD)</a></li>
<li><a href="tools/interfaces.html#glean-aggregated-metrics-dashboard-glam">Glean Aggregated Metrics Dashboard (GLAM)</a></li>
<li><a href="tools/interfaces.html#telemetry-measurement-dashboard">Telemetry Measurement Dashboard</a></li>
</ul>
</li>
<li><a href="tools/interfaces.html#lower-level-tools">Lower-level tools</a>
<ul>
<li><a href="tools/interfaces.html#sqltelemetrymozillaorg-stmo">sql.telemetry.mozilla.org (STMO)</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#high-level-tools" id="high-level-tools">High-level tools</a></h2>
<p>These web-based tools do not require specialized technical knowledge (e.g. how to write an SQL query, deep knowledge of BigQuery). This is where you should start.</p>
<h3><a class="header" href="#mozilla-growth--usage-dashboard-gud" id="mozilla-growth--usage-dashboard-gud">Mozilla Growth &amp; Usage Dashboard (GUD)</a></h3>
<p>The <a href="https://gud.telemetry.mozilla.org/">Mozilla Growth &amp; Usage Dashboard</a> (GUD) is a tool to visualize growth metrics in a standard way across Mozilla’s products. This is the first place you should look if you have a question like &quot;how many people are using X?&quot;.</p>
<h3><a class="header" href="#glean-aggregated-metrics-dashboard-glam" id="glean-aggregated-metrics-dashboard-glam">Glean Aggregated Metrics Dashboard (GLAM)</a></h3>
<p>The <a href="https://glam.telemetry.mozilla.org/">Glean Aggregated Metrics Dashboard</a> (GLAM) is an interactive dashboard that is Mozilla’s primary self-service tool for examining the distributions of values of specific individual telemetry metrics, over time and across different user populations. It is similar to GUD in that it is meant to be usable by everyone; no specific data analysis or coding skills are needed. But while GUD is focused on a relatively small number of high level, derived product metrics about user engagement (e.g. MAU, DAU, retention, etc) GLAM is focused on a diverse and plentiful set of probes and data points that engineers capture in code and transmit back from Firefox and other Mozilla products.</p>
<p>As of this writing, GLAM is in active development but is already usable.</p>
<h3><a class="header" href="#telemetry-measurement-dashboard" id="telemetry-measurement-dashboard">Telemetry Measurement Dashboard</a></h3>
<p>The <a href="https://telemetry.mozilla.org/new-pipeline/dist.html">Telemetry Measurement Dashboard</a> (TMO) site is the
'venerable standby' of Firefox telemetry analysis tools. It is the predecessor to GLAM (see above) and is still maintained until GLAM is considered production ready.</p>
<h2><a class="header" href="#lower-level-tools" id="lower-level-tools">Lower-level tools</a></h2>
<p>These tools require more specialized knowledge to use.</p>
<h3><a class="header" href="#sqltelemetrymozillaorg-stmo" id="sqltelemetrymozillaorg-stmo">sql.telemetry.mozilla.org (STMO)</a></h3>
<p>The <a href="https://sql.telemetry.mozilla.org"><code>sql.telemetry.mozilla.org</code></a> (STMO) site
is an instance of the very fine <a href="https://redash.io/">Redash</a> software, allowing
for SQL-based exploratory analysis and visualization / dashboard
construction. Requires (surprise!) familiarity with SQL, and for your data to
be explicitly exposed as an STMO data source. You can learn more about how to use it in <a href="tools/./stmo.html">Introduction to STMO</a>. Bugs or feature requests can be reported in Mozilla's <a href="https://github.com/mozilla/redash/issues">issue tracker</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/tools/interfaces.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#analysis-gotchas" id="analysis-gotchas">Analysis Gotchas</a></h1>
<p>When you perform an analysis on any data, there are some mistakes that are easy to make:</p>
<ul>
<li>Do you know what question that you hope to answer?</li>
<li>Is your sample representative of your population?</li>
<li>Is your result &quot;real&quot;? How precisely can you state your conclusion?</li>
</ul>
<p>This section is not about those traps. Instead, it is about quirks and pitfalls that are specific to Mozilla's data systems.</p>
<h2><a class="header" href="#table-of-contents-1" id="table-of-contents-1">Table of Contents</a></h2>
<ul>
<li><a href="concepts/analysis_gotchas.html#intermittent-issues">Intermittent issues</a></li>
<li><a href="concepts/analysis_gotchas.html#notable-historic-events">Notable historic events</a></li>
<li><a href="concepts/analysis_gotchas.html#pseudo-replication">Pseudo-replication</a></li>
<li><a href="concepts/analysis_gotchas.html#profiles-vs-users">Profiles vs Users</a></li>
<li><a href="concepts/analysis_gotchas.html#opt-in-versus-opt-out">Opt-in versus Opt-out</a></li>
<li><a href="concepts/analysis_gotchas.html#trusting-dates">Trusting Dates</a></li>
<li><a href="concepts/analysis_gotchas.html#date-formats">Date Formats</a></li>
<li><a href="concepts/analysis_gotchas.html#delays">Delays</a>
<ul>
<li><a href="concepts/analysis_gotchas.html#pingsender">Pingsender</a></li>
<li><a href="concepts/analysis_gotchas.html#submission-date">Submission Date</a></li>
</ul>
</li>
<li><a href="concepts/analysis_gotchas.html#pings-from-robots">Pings from Robots</a></li>
<li><a href="concepts/analysis_gotchas.html#build-ids">Build Ids</a></li>
</ul>
<h2><a class="header" href="#intermittent-issues" id="intermittent-issues">Intermittent issues</a></h2>
<p>Despite best efforts, problems may occur from time to time with the ingestion of data or the faithful creation of datasets.</p>
<p>Issues undergoing investigation are marked with the <code>[data-quality]</code> whiteboard tag in Bugzilla. See <a href="https://bugzilla.mozilla.org/buglist.cgi?bug_status=UNCONFIRMED&amp;bug_status=NEW&amp;bug_status=ASSIGNED&amp;bug_status=REOPENED&amp;classification=Client%20Software&amp;classification=Developer%20Infrastructure&amp;classification=Components&amp;classification=Server%20Software&amp;classification=Other&amp;priority=P1&amp;priority=P2&amp;priority=P3&amp;priority=--&amp;product=Data%20Platform%20and%20Tools&amp;resolution=---&amp;status_whiteboard=%5Bdata-quality%5D&amp;status_whiteboard_type=allwordssubstr&amp;list_id=15179084">currently open issues</a>.</p>
<p>Especially severe problems with production data are announced on the <code>fx-data-dev</code> mailing list (see <a href="concepts/getting_help.html">getting help</a>). Subscribing to this mailing list is recommended if you are a current or aspiring data practitioner.</p>
<h2><a class="header" href="#notable-historic-events" id="notable-historic-events">Notable historic events</a></h2>
<p>When you start to evaluate trends, be aware of events from the past that may invite comparisons with history. Here are a few to keep in mind:</p>
<ul>
<li><strong>August 6, 2020</strong> - <a href="https://github.com/mozilla/bigquery-etl/pull/1215">Pings with &quot;automation&quot; tag in X-Source-Tags will no longer appear in stable tables</a>
This is particularly relevant for removing pings related to automated testing of Fenix.</li>
<li><strong>July 20, 2020</strong> - <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1653244">Glean dropping application lifetime metrics from <code>metrics</code> pings</a>.
Glean Android bindings from version <code>v25.0.0</code> up to and including <code>v31.4.0</code> had a bug that would cause metrics with “lifetime: application” to be cleared before they could be collected for metrics pings sent during startup. This can result in application lifetime metrics like experiment information being randomly missing from the data.</li>
<li><strong>April 14, 2020</strong> - <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1630096">Telemetry edge server rejects pings for an hour</a>.
Clients generally retry periodically until success is achieved. Therefore, most of these messages were eventually ingested; submission timestamps appear later than normal. A small number of pings are attributed to a later day or were never sent due to the client never being reopened.</li>
<li><strong>February 11, 2020</strong> - Firefox 73 was released and began the start of <a href="https://docs.google.com/document/d/1oJhnvAOx2c8Mp-Xpk-3j-2d45yu_fghYS2yAbn1aeNY/edit#heading=h.iba82gckexg7">4-week release cycles</a>. There was a gradual transition from 7/8 week ones to 4 week ones.</li>
<li><strong>December 4 2019</strong> - <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1598815">AWS Ingestion Pipeline decommissioned</a>.
Specifically, the last ping relayed through the AWS machinery had a
timestamp of <code>2019-12-04 22:04:45.912204 UTC</code>.</li>
<li><strong>October 29 2019</strong> - Glean SDK Timing Distribution(s) report buckets
1 nanosecond apart. This occurred because of a potential rounding bug in Glean SDK
versions less than <code>19.0.0</code>. See <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1591938">Bug 1591938</a>.</li>
<li><strong>October 23 2019</strong> - <a href="https://docs.google.com/document/d/1gQF-iU3E21SG985Cl2Ius4LoRXduUrNa5In9hafLIqs/edit">Hot-fix shipped through add-ons</a> that
reset the Telemetry endpoint preference back to the default for a large number of users.</li>
<li><strong>September 1 - October 18 2019</strong> - BigQuery Ping tables are
<a href="https://github.com/mozilla-services/cloudops-infra/pull/1491">missing the <code>X-PingSender-Version</code> header information</a>.
This data is available before and after this time period.</li>
<li><strong>May 4 - May 11 2019</strong> - <a href="https://blog.mozilla.org/blog/2019/05/09/what-we-do-when-things-go-wrong/">Telemetry source data deleted</a>.
No source data is available for this period and derived tables may have
missing days or imputed values.
Derived tables that depend on multiple days may have have affected dates
beyond the deletion region.</li>
<li><strong>January 31 2019</strong> - <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1474285">Profile-per-install</a> landed in <code>mozilla-central</code>
and affected how new profiles were created.
See <a href="https://github.com/mozilla/bigquery-etl/issues/212">discussion in <code>bigquery-etl#212</code></a>.</li>
<li><strong>October 25 2018</strong> - many <code>client_id</code>s on Firefox Android were reset to the
same <code>client_id</code>.
For more information, see the <a href="https://docs.google.com/document/d/1r1PDQnqhsrPkft0pB46v9uhXGxR_FzK4laKJLGttXdA">post-mortem</a>
or <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1501329">Bug 1501329</a>.</li>
<li><strong>November 2017</strong> - Quantum Launch. There was a surge in new profiles and usage.</li>
<li><strong>June 1 and 5, 2016</strong> - <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1482509">Main Summary <code>v4</code> data is missing</a>
for these two days.</li>
<li><strong>March 2016</strong> - Unified Telemetry launched.</li>
</ul>
<h2><a class="header" href="#pseudo-replication" id="pseudo-replication">Pseudo-replication</a></h2>
<p>Telemetry data is a collection of pings.
A single main-ping represents a single subsession.
Some clients have more subsessions than others.</p>
<p>When you say <a href="https://mzl.la/2q75dbF">&quot;63% of beta 53 has Firefox set as its default browser&quot;</a>, you need to specify that it is 63% of <em>pings</em> because it represents only around 46% of clients.
(Apparently users with Firefox Beta 53 set as their default browser submitted
more main-pings than users who did not).</p>
<h2><a class="header" href="#profiles-vs-users" id="profiles-vs-users">Profiles vs Users</a></h2>
<p>You may have noticed that the term &quot;clients&quot; and not &quot;users&quot; was applied in the above-listed section because of all the things can be counted, users is not one of them:</p>
<p>Users can have multiple Firefox profiles that runs on the same system at
the same time (like developers).</p>
<p>Users can have the same Firefox profile that runs on several systems on
different days of the week (also developers).</p>
<p>The only things we can count are pings and clients.
Clients can be counted because a <code>client_id</code> is sent with each ping that uniquely
identifies the profile from which it originated.
This is generally close enough to the idea of a so-called &quot;user&quot; that can be considered for counting profiles and calling them users. However, you may run into some instances
where the distinction matters.</p>
<p>When in doubt, be precise. You count <em>clients</em>.</p>
<p><a href="concepts/./profile/index.html">This article</a> describes the concept of &quot;profiles&quot; in detail.</p>
<h2><a class="header" href="#opt-in-versus-opt-out" id="opt-in-versus-opt-out">Opt-in versus Opt-out</a></h2>
<p>Mozilla does not collect the same information from everyone.</p>
<p>Every profile that does not have Telemetry disabled sends &quot;opt-out&quot; Telemetry, which
includes:</p>
<ul>
<li>Nearly all the data in the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/environment.html">Environment</a></li>
<li>Some specific <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/histograms.html">Histograms</a>, <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/scalars.html">Scalars</a>, and <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/events.html">Events</a> that are marked
<code>&quot;releaseChannelCollection&quot;: &quot;opt-out&quot;</code></li>
</ul>
<p>Most probes are &quot;opt-in&quot;: No information is received from the probes unless a user
opts into sending this information by installing any pre-release version of Firefox:
Beta, Nightly or Developer Edition (the latter is similar to Beta).</p>
<p>If you want to encourage users to collect good information for Mozilla, ask them to install a Beta release.</p>
<h2><a class="header" href="#trusting-dates" id="trusting-dates">Trusting Dates</a></h2>
<p>Do not assume that the time reported by an instance of Firefox desktop is correct. The situation is somewhat better on mobile devices, but you should still be cautious.</p>
<p>Any timestamp recorded by the user is subject to &quot;clock skew.&quot;
The user's clock can be set (purposefully or accidentally) to any time at all.
SSL certificates tend to keep timestamps in a certain relatively-accurate window
because a user whose clock has been set too far in the past or too far in the future
may confuse certain expiration-date-checking code.</p>
<p>Examples of client times from Firefox desktop pings:</p>
<ul>
<li><code>crashDate</code></li>
<li><code>crashTime</code></li>
<li><code>meta/Date</code></li>
<li><code>sessionStartDate</code></li>
<li><code>subsessionStartDate</code></li>
<li><code>profile/creationDate</code></li>
</ul>
<p>Examples of client times from Glean pings:</p>
<ul>
<li><a href="https://mozilla.github.io/glean/book/user/pings/index.html#the-ping_info-section"><code>ping_info.end_time</code></a></li>
</ul>
<p>Examples of server times that you can trust:</p>
<ul>
<li><code>submission_timestamp</code></li>
<li><code>submission_date</code></li>
</ul>
<p><em>Note</em> <code>submission_date</code> does not appear in the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/common-ping.html">ping documentation</a>
because it is added in post-processing.</p>
<h2><a class="header" href="#date-formats" id="date-formats">Date Formats</a></h2>
<p>Not all dates and times are created equal.
Most of the dates and times in Telemetry pings are <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a>.
Most are full timestamps, though their resolution may differ from per-second to per-day.</p>
<p>Then there's <code>profile/creationDate</code> which is just a number of days since epoch (January 1, 1970).
Like <code>17177</code> for the date 2017-01-11.</p>
<p><strong>Tip:</strong> If you want to convert <code>profile/creationDate</code> to a usable date in SQL:
<code>DATE_FROM_UNIX_DATE(SAFE_CAST(environment.profile.creation_date AS INT64))</code></p>
<p>In derived datasets ISO dates are sometimes converted to strings using one of
the following formats: <code>%Y-%m-%d</code> or <code>%Y%m%d</code>.</p>
<p>The date formats for different rows in <code>main_summary</code> are described on the
<a href="concepts/../datasets/batch_view/main_summary/reference.html#time-formats"><code>main_summary</code> reference page</a>.</p>
<p>Although build IDs look like dates, they are not. If you take the first eight characters, you can use them as a proxy for the day when the build was released.</p>
<p><code>metadata.header.date</code> represents an HTTP Date header in a <a href="http://tools.ietf.org/html/rfc7231#section-7.1.1.1">RFC 7231</a>-compatible format.</p>
<p><strong>Tip:</strong> If you want to parse <code>metadata/Date</code> to become a usable date in SQL:
<code>SAFE.PARSE_TIMESTAMP('%a, %d %b %Y %T %Z', REPLACE(metadata.header.date, 'GMT+00:00', 'GMT'))</code>
Alternatively, you can use the already parsed version that is available in user-facing views (<code>metatdata.header.parsed_date</code>)</p>
<h2><a class="header" href="#delays" id="delays">Delays</a></h2>
<p>There is an inherent delay between Telemetry data being created on the client and it being received by Mozilla.
Most Telemetry data produced by desktop Firefox is represented in the main ping. It is sent at the beginning of a client's <em>next</em> Firefox session.
If the user shuts down Firefox for the weekend, Firefox does not receive any data that has been generated on Friday data until Monday morning.</p>
<p>Generally speaking, data from two days ago is usually fairly representative.</p>
<p>If you'd like to read more about this subject, there is a series of blog posts <a href="https://chuttenblog.wordpress.com/2017/02/09/data-science-is-hard-client-delays-for-crash-pings/">here</a>, <a href="https://chuttenblog.wordpress.com/2017/07/12/latency-improvements-or-yet-another-satisfying-graph/">here</a> and <a href="https://chuttenblog.wordpress.com/2017/09/12/two-days-or-how-long-until-the-data-is-in/">here</a>.</p>
<h3><a class="header" href="#pingsender" id="pingsender">Pingsender</a></h3>
<p>Pingsender greatly reduces any delay before sending pings to Mozilla.
However, only some types of pings are sent by Pingsender.
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1310703">Bug 1310703</a> introduced Pingsender for crash pings and was merged in Firefox 54,
which was included in release on June 13, 2017.
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1336360">Bug 1336360</a> moved shutdown pings to Pingsender and was merged in Firefox 55,
which was included in release on August 8, 2017.
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1374270">Bug 1374270</a> added sending health pings on shutdown using Pingsender and was
merged in Firefox 56, which was included in release on Sept 28, 2017.
Other types of pings are not sent with Pingsender.
This is usually okay because Firefox is expected to continue to run long
enough to send these pings.</p>
<p>Mobile clients do not have Pingsender. Therefore, a delay occurs as described in <a href="https://sql.telemetry.mozilla.org/queries/49867#134105">this query</a>.</p>
<h3><a class="header" href="#submission-date" id="submission-date">Submission Date</a></h3>
<p><code>submission_date</code> or <code>submission_timestamp</code> represents the server time at which a ping is received from a client. It is used as a partitioning column (useful for both query optimization and restricting the range of data under consideration) and should be considered reliable.</p>
<p>In <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1422892">bug 1422892</a> it was decided
to standardize on using <code>submission_date</code> as opposed to client-generated dates.</p>
<p>Summary of reasons for this decision:</p>
<ul>
<li>not subject to client clock skew</li>
<li>doesn't require normalization</li>
<li>good for backfill</li>
<li>good for daily processing</li>
<li>and usually good enough</li>
</ul>
<h2><a class="header" href="#pings-from-robots" id="pings-from-robots">Pings from Robots</a></h2>
<p>In general, data coming from an application instance not run by a human is not wanted in analysis. As of this writing, <a href="https://github.com/mozilla/geckodriver">GeckoDriver</a> (one of the official mechanisms to launch and control an automated version of Firefox for e.g. web compatibility testing) is <a href="https://searchfox.org/mozilla-central/rev/baf1cd492406a9ac31d9ccb7a51c924c7fbb151f/testing/geckodriver/src/prefs.rs#154">configured <em>not</em> to send Telemetry by default</a> but we can't control for other things people might do in the field.</p>
<p>On desktop, one field to watch out for is headless mode (<code>environment.system.gfx.headless</code> in the main ping): if that field is set, you are for certain not working with a version of Firefox being operated by a real human. You can see an example of some client pings with this field set skewing the nightly numbers in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1643341">bug 1643341</a>. An easy solution is to just filter out these types of clients in your analysis. You can see an example of this pattern in <a href="https://sql.telemetry.mozilla.org/queries/71781/source">this query</a>.</p>
<h2><a class="header" href="#build-ids" id="build-ids">Build Ids</a></h2>
<p>Generally speaking, application versions are monotonically increasing multipart alphanumeric strings like &quot;89.0a1&quot; or &quot;68.0.3&quot;.
Build Ids are not this.
A Build Id is a sequence of characters that is unique to a specific build of a product.
Since the application version may not vary across shipped versions (for example, a Firefox nightly version stays the same across its entire cycle), a build id helps identify which code changes were included in a build as well as what features may have been enabled for it.
For example, in Firefox Desktop, the build id is the date and time the build was built in yyyymmddhhmmss format.
A build id might be formatted in any way and contain the time or version control system revision of the code included in the build.</p>
<p>Do not assume build id's are consistent across the products we ship. A build id format may vary between products, between channels of the same product, or over time within the same channel of the same product.
The build id format for Firefox Desktop has been very stable over time thus far, but even it can be different for different platforms in some respin circumstances (if e.g. only one platform's builder failed).</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/analysis_gotchas.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#choosing-a-desktop-product-dataset" id="choosing-a-desktop-product-dataset">Choosing a Desktop Product Dataset</a></h1>
<p>This document will help you find the best data source for a given analysis. It focuses on <em>descriptive</em> datasets and does not cover anything attempting to explain <em>why</em> something is observed. This guide will help if you need to answer questions like:</p>
<ul>
<li>How many Firefox users are active in Germany?</li>
<li>How many crashes occur each day?</li>
<li>How many users have installed a specific add-on?</li>
</ul>
<p>If you want to know whether a causal link occurs between two events, you can learn more at <a href="concepts/../tools/experiments.html">tools for experimentation</a>.</p>
<p>There are two types of datasets that you might want to use: those based on raw pings and those derived from them.</p>
<h2><a class="header" href="#raw-ping-datasets" id="raw-ping-datasets">Raw Ping Datasets</a></h2>
<p>We receive data from Firefox users via <strong>pings</strong>: small JSON payloads sent by clients at specified intervals.
There are many types of pings, each containing different measurements and sent for different purposes.</p>
<p>These pings are then <a href="concepts/../cookbooks/bigquery/querying.html#structure-of-ping-tables-in-bigquery">aggregated into ping-level datasets</a> that can be retrieved using BigQuery.
Pings can be difficult to work with and expensive to query: where possible, you should use a derived dataset to answer your question.</p>
<p>For more information on pings and how to use them, see <a href="concepts/../datasets/pings.html">Raw Ping Data</a>.</p>
<h2><a class="header" href="#derived-datasets" id="derived-datasets">Derived Datasets</a></h2>
<p>Derived datasets are built using the raw ping data above with various transformations to make them easier to work with and help you avoid the pitfall of <a href="https://docs.telemetry.mozilla.org/concepts/analysis_gotchas.html#pseudo-replication">pseudo-replication</a>.
You can find a full list of them in the <a href="concepts/../datasets/derived.html">derived datasets section</a>, but two commonly used ones are &quot;Clients Daily&quot; and &quot;Clients Last Seen&quot;.</p>
<h3><a class="header" href="#clients-daily" id="clients-daily">Clients Daily</a></h3>
<p>Many questions about Firefox take the form &quot;What did clients with
characteristics X, Y, and Z do during the period S to E?&quot; The
<code>clients_daily</code> table aims to answer these questions. Each row in
the table is a (<code>client_id</code>, <code>submission_date</code>) and contains a
number of aggregates about that day's activity.</p>
<p>See the <a href="concepts/../datasets/batch_view/clients_daily/reference.html"><code>clients_daily</code> reference</a> for more information.</p>
<h3><a class="header" href="#clients-last-seen" id="clients-last-seen">Clients Last Seen</a></h3>
<p>The <code>clients_last_seen</code> dataset is useful for efficiently determining exact
user counts such as <a href="concepts/../../../cookbooks/dau.html">DAU and MAU</a>.
It can also allow efficient calculation of other windowed usage metrics like retention via its
<a href="concepts/../../../cookbooks/clients_last_seen_bits.html">bit pattern fields</a>.
It includes the most recent values in a 28 day window for all columns in the
<a href="concepts//datasets/batch_view/clients_daily/reference.html"><code>clients_daily</code> dataset</a>.</p>
<p>See the <a href="concepts/../datasets/bigquery/clients_last_seen/reference.html"><code>clients_last_seen</code> reference</a> for more information.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/choosing_a_dataset.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#choosing-a-mobile-product-dataset" id="choosing-a-mobile-product-dataset">Choosing a Mobile Product Dataset</a></h1>
<h2><a class="header" href="#products-overview" id="products-overview">Products Overview</a></h2>
<p>Mobile products may send either legacy telemetry (see &quot;Legacy ping tables&quot; below), Glean telemetry, or both.</p>
<table><thead><tr><th>Marketing name</th><th>OS</th><th>Legacy <code>app_name</code></th><th>Glean dataset</th><th>Notes</th></tr></thead><tbody>
<tr><td>Firefox for Android</td><td>Android</td><td></td><td><code>org_mozilla_firefox</code> (release), <code>org_mozilla_firefox_beta</code> (beta), <code>org_mozilla_fenix</code> (nightly)</td><td>formerly Fenix; uses Glean (see below)</td></tr>
<tr><td>Firefox Android (old)</td><td>iOS</td><td><code>Fennec</code></td><td></td><td>End-of-life; replaced by above</td></tr>
<tr><td>Firefox iOS</td><td>iOS</td><td><code>Fennec</code></td><td><code>org_mozilla_ios_firefox</code> (release), <code>org_mozilla_ios_firefoxbeta</code> (beta), <code>org_mozilla_ios_fennec</code> (dev)</td><td></td></tr>
<tr><td>Focus Android</td><td>Android</td><td><code>Focus</code></td><td></td><td>Privacy browser</td></tr>
<tr><td>Focus iOS</td><td>iOS</td><td><code>Focus</code></td><td></td><td>Privacy browser</td></tr>
<tr><td>Klar</td><td>Android</td><td><code>Klar</code></td><td></td><td>German Focus release</td></tr>
<tr><td>Firefox for Fire TV</td><td>Android</td><td><code>FirefoxForFireTV</code></td><td><code>org_mozilla_tv_firefox </code></td><td></td></tr>
<tr><td>Firefox for Echo Show</td><td>Android</td><td><code>FirefoxConnect</code></td><td><code>org_mozilla_connect_firefox</code></td><td></td></tr>
<tr><td>Firefox Lite</td><td>Android</td><td><code>Zerda</code></td><td></td><td>Formerly Rocket (See below)</td></tr>
<tr><td>Firefox Reality</td><td>Android</td><td><code>FirefoxReality</code></td><td><code>org_mozilla_vrbrowser</code></td><td>Headset VR browser</td></tr>
<tr><td>Reference Browser</td><td>Android</td><td></td><td><code>org_mozilla_reference_browser</code></td><td>GeckoView integration testbed</td></tr>
</tbody></table>
<p>Some other app names are documented in the <a href="https://mozilla.github.io/bigquery-etl/mozfun/norm/#product_info-udf">ETL documentation</a>.</p>
<p>Firefox Lite was formerly known as Rocket. It is only available in certain countries in Asia Pacific. For more information on Firefox Lite data, see the <a href="https://github.com/mozilla-tw/FirefoxLite/blob/master/docs/telemetry.md">telemetry documentation</a>.</p>
<p>Focus is known as the privacy-focused mobile browser that blocks trackers by default. It does not store a browsing history.</p>
<p>Klar is the known release name for Focus in Germany.</p>
<p>For more information on how telemetry is sent for iOS apps, see the <a href="https://github.com/mozilla-mobile/telemetry-ios">telemetry documentation</a>.</p>
<p>Some telemetry is also sent by non-Mozilla forks of our browsers.
When consulting legacy telemetry, filter on app name to make sure that you are looking at only the app for which you want to analyze data.</p>
<h2><a class="header" href="#legacy-ping-tables" id="legacy-ping-tables">Legacy ping tables</a></h2>
<p>Legacy (pre-Glean) mobile data is structured differently than desktop data. Instead of sending a <code>main</code> ping, mobile has provides the following key types of pings:</p>
<ul>
<li><code>core</code></li>
<li><code>events</code></li>
</ul>
<p>The core ping is sent once for each session. It includes a much smaller set of
metrics than the main ping because of network and data size constraints. All mobile apps send the core ping. For more information on the core ping, see the telemetry documentation <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/obsolete/core-ping.html">here</a>.</p>
<p>Event pings are not sent for all products. They are sent by Focus Android, Focus iOS, Klar, Firefox for FireTV, Firefox for Echo Show, and Firefox Lite.
Event pings are sent more frequently than core pings, at most once per 10 minute interval.
If a ping records 10,000 events, it is sent immediately unless it is within 10 minutes of the last event ping sent: in this case some data may be lost.</p>
<p>Mobile legacy event pings follow generally the same format as the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/event-ping.html">desktop <code>event</code> ping</a>.</p>
<p>Fennec (Firefox Android) does not send event pings. Instead, it includes a
<code>saved_session</code> ping with the same format as <code>main</code> pings. However, it is only
available for users who have installed a pre-release and a few users who have installed a release. In both cases, they must have opted into signing up for telemetry collection.
Data from this collection must be treated with caution because it is based on a biased
population and therefore should not be used to make conclusions about Fennec users.</p>
<p>For more information on the implementation of the event pings and to view event
descriptions for <a href="https://github.com/mozilla-mobile/focus-android/blob/master/docs/Telemetry.md">Focus</a>, <a href="https://github.com/mozilla-mobile/firefox-tv/blob/master/docs/telemetry.md">Firefox for FireTV</a>, or <a href="https://github.com/mozilla-mobile/firefox-echo-show/blob/master/docs/telemetry.md">Firefox for Echo Show</a>, see the following documentation:</p>
<h3><a class="header" href="#core-ping-derived-datasets" id="core-ping-derived-datasets">Core Ping Derived Datasets</a></h3>
<h4><a class="header" href="#telemetrycore" id="telemetrycore"><code>telemetry.core</code></a></h4>
<p>For most analyses of mobile data, you need to use the <code>telemetry.core</code> table. It includes data for all the non-desktop Firefox applications that send core pings.</p>
<p>You need to filter on <code>app_name</code> and <code>os</code> because Firefox iOS and Firefox Android
have the same <code>app_name</code>. It is recommended that you always filter on <code>app_name</code>, <code>os</code>, app version (found as <code>metadata_app_version</code>) and release channel (it is located under metadata as <code>metadata.normalized_channel</code>).</p>
<p>Versioned tables are available for core ping storage for historical reference, but a table without a version suffix always represents an up-to-date table. It is recommended that you use the unversioned table, so you can be sure your analysis is based on up-to-date information.</p>
<p>The <code>seq</code> field indicates the order in which pings are sent. A record includes <code>seq = 1</code>, which represents the first ping that is received for a client id. It can be used as a proxy to identify new users.</p>
<h3><a class="header" href="#event-ping-derived-datasets" id="event-ping-derived-datasets">Event Ping Derived Datasets</a></h3>
<p>There are two tables for mobile event data: <code>telemetry.focus_event</code> and <code>telemetry.mobile_event</code>.</p>
<p>As the name suggests, one table includes the event pings from Focus (iOS, Android
and Klar). The other table includes the event data for other apps. Both tables use the same format and columns.</p>
<h4><a class="header" href="#telemetrymobile_events" id="telemetrymobile_events"><code>telemetry.mobile_events</code></a></h4>
<p>The <code>telemetry.mobile_events</code> table includes event data for Firefox for Fire TV, Firefox for Echo Show, and Firefox Lite. A metadata column with a list of metrics is also included.</p>
<p>Like when querying <code>telemetry.core</code>, multiple applications are included in each table. It is recommended that you filter at least <code>app_name</code> and <code>os</code>. Be sure that no <code>app_version</code> field is included in these tables: if you want to filter or join a specific version, you must have already identified the corresponding <code>metadata.app_build_id</code>(s) for the <code>app_version</code> by contacting the engineering team that has created the app.</p>
<p>A few other applications also send event data to this table, including Lockbox and FirefoxReality. For more information about the event data that is sent from these applications, see their documentation.</p>
<h4><a class="header" href="#telemetryfocus_events" id="telemetryfocus_events"><code>telemetry.focus_events</code></a></h4>
<p>The <code>telemetry.focus_events</code> table includes event data for Focus Android, Focus iOS, and Klar.</p>
<p>Like when querying <code>telemetry.core</code>, multiple apps are included in each table. It is recommended that you filter on at least <code>app_name</code> and <code>os</code>. Be sure that no <code>app_version</code> field is included in these tables. If you want to filter or join a specific version, you must have already identified the corresponding <code>app_build_id</code>(s) for the <code>app_version</code> by contacting the engineering team that has created the app.</p>
<p>A few other applications send data to this table. However, it is recommended that you use
this table only for analysis of event data from Focus and its related apps.</p>
<h3><a class="header" href="#notes" id="notes">Notes</a></h3>
<p>Each app uses a unique set of release channels. Most apps include a <code>nightly</code>, <code>beta</code>, <code>release</code>, and an <code>other</code> channel. Each channel is used during various stages of development: generally users sign up to test a pre-release version (anything other than <code>release</code>). In Focus Android, the <code>beta</code> channel uses the same APK in the Google Play Store as the <code>release</code> channel. However, beta users get access to this version earlier than users who receive the final release.</p>
<p>As soon as the <code>release</code> version is published, beta users work with the same version
of the app as users who have received the final released version. Both versions of the software become indistinguishable from each other unless you perform a query that flags them by <code>client_id</code>. Beta releases have <code>normalized_channel</code> tagged as <code>release</code>. If you want to filter for beta users, you can only identify the beta users by checking for a higher version number than the version number and date that have been assigned to the official release.</p>
<h3><a class="header" href="#glean-1" id="glean-1">Glean</a></h3>
<p>Most of Mozilla's newer mobile apps, including Fenix, have been adapted to use <em>Glean</em>, the new telemetry SDK. Glean now sends <code>baseline</code>, <code>metrics</code>, and <code>events</code> pings instead of <code>core</code> and <code>event</code> pings. For more information, see the <a href="concepts/./glean/glean.html">Glean Overview</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/choosing_a_dataset_mobile.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#getting-help" id="getting-help">Getting Help</a></h1>
<h2><a class="header" href="#mailing-lists" id="mailing-lists">Mailing lists</a></h2>
<p>Telemetry-related announcements that include new datasets, outages, feature
releases, etc. are sent to <a href="https://mail.mozilla.org/listinfo/fx-data-dev"><code>fx-data-dev@mozilla.org</code></a>, a public
mailing list. Follow the link for archives and information on how to subscribe.</p>
<h2><a class="header" href="#matrix" id="matrix">Matrix</a></h2>
<p>You can locate us in the <a href="https://chat.mozilla.org/#/room/#telemetry:mozilla.org">#telemetry:mozilla.org</a> channel on <a href="https://wiki.mozilla.org/Matrix">Mozilla's instance of matrix</a>.</p>
<h2><a class="header" href="#slack" id="slack">Slack</a></h2>
<p>You can ask questions (and get answers!) in <a href="https://mozilla.slack.com/messages/data-help"><code>#data-help</code></a> on Mozilla Internal's
Slack. See also <a href="https://mozilla.slack.com/messages/data"><code>#data</code></a> for general data-related discussion.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/getting_help.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#reporting-a-problem" id="reporting-a-problem">Reporting a problem</a></h1>
<p>If you see a problem with data tools, datasets, or other pieces of infrastructure,
report it!</p>
<p>Defects in the data platform and tools are tracked in Bugzilla in the <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Data%20Platform%20and%20Tools">Data Platform and Tools</a> product.</p>
<p>Bugs need to be filed in the closest-matching component in the Data Platform and Tools
product. If you are not able to locate an appropriate component for the item in question, file an issue
in the <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Data%20Platform%20and%20Tools&amp;component=General">General component</a>.</p>
<p>Components are triaged at least weekly by the component owner(s). For any issues that need
urgent attention, it is recommended that you use the <code>needinfo</code> flag to attract attention
from a specific person. If an issue does not receive the appropriate attention in a
week (or it is urgent), see <a href="concepts/getting_help.html">getting help</a>.</p>
<p>When a bug is triaged, it is assigned a <strong>priority</strong> and <strong>points</strong>. <strong>Priorities</strong> are processed as follows:</p>
<ul>
<li><strong><code>P1</code></strong>: in active development in the current sprint</li>
<li><strong><code>P2</code></strong>: planned to be worked on in the current quarter</li>
<li><strong><code>P3</code></strong>: planned to be worked on next quarter</li>
<li><strong><code>P4</code></strong> and beyond: nice to have, would accept a patch, but not actively being worked on.</li>
</ul>
<p><strong>Points</strong> reflect the amount of effort that is required for a bug. They are assigned as follows:</p>
<ul>
<li><strong>1 point</strong>: one day or less of effort</li>
<li><strong>2 points</strong>: two days of effort</li>
<li><strong>3 points</strong>: three days to a week of effort</li>
<li><strong>5 points</strong> or more: SO MUCH EFFORT, major project.</li>
</ul>
<h3><a class="header" href="#problems-with-the-data" id="problems-with-the-data">Problems with the data</a></h3>
<p>There are Bugzilla components for several core datasets, as
described in this documentation. If at all possible, assign a specific component to the issue.</p>
<p>If there is an issue with a dataset to which you are unable to assign its own component,
file an issue in the <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Data%20Platform%20and%20Tools&amp;component=Datasets%3A%20General">Datasets: General component</a>.</p>
<h3><a class="header" href="#problems-with-tools" id="problems-with-tools">Problems with tools</a></h3>
<p>There are Bugzilla components for several of the <a href="concepts/../tools/interfaces.html">tools</a> that
comprise the <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Data%20Platform%20and%20Tools">Data Platform</a>.
File a bug in the specific component that most closely matches the tool in question.</p>
<p>Operational bugs, such as services being unavailable, need to be filed either in
the component for the service itself or in the <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Data%20Platform%20and%20Tools&amp;component=Operations">Operations component</a>.</p>
<h3><a class="header" href="#other-issues" id="other-issues">Other issues</a></h3>
<p>When in doubt, file issues in the <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Data%20Platform%20and%20Tools&amp;component=General">General component</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/reporting_a_problem.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#standard-metrics" id="standard-metrics">Standard Metrics</a></h1>
<p>This section provides an overview of standard metrics used at Mozilla.
Here you'll find the definitions and descriptions for each.</p>
<p>For a deep dive into these metrics, see <a href="https://mozilla.github.io/gud/">the GUD documentation</a>.</p>
<p>The <a href="metrics/../concepts/index.html">Telemetry Behavior Reference</a> section also provides
information related to the definitions below.</p>
<p>We are now in the process of setting up the metrics top-level section here. This information will be moved into the appropriate subsection and this page will be replaced with an overview.</p>
<h2><a class="header" href="#activity" id="activity">Activity</a></h2>
<h3><a class="header" href="#dau-1" id="dau-1">DAU</a></h3>
<p>The number of unique profiles active on each day.</p>
<h3><a class="header" href="#wau-1" id="wau-1">WAU</a></h3>
<p>The number of unique profiles active at least once during the 7-day window
ending on the specified day.</p>
<h3><a class="header" href="#mau-1" id="mau-1">MAU</a></h3>
<p>The number of unique profiles active at least once during the 28-day window
ending on the specified day.</p>
<h3><a class="header" href="#intensity-1" id="intensity-1">Intensity</a></h3>
<p>Intuitively, how many days per week do users use the product? Among profiles
active at least once in the week ending on the date specified, the number of
days on average they were active during that one-week window.</p>
<h2><a class="header" href="#retention-1" id="retention-1">Retention</a></h2>
<h3><a class="header" href="#1-week-new-profile-retention" id="1-week-new-profile-retention">1-Week New Profile Retention</a></h3>
<p>Among new profiles created on the day specified, what proportion (out of 1) are
active during the week beginning one week after the day specified.</p>
<h3><a class="header" href="#1-week-retention" id="1-week-retention">1-Week Retention</a></h3>
<p>Among profiles that were active at least once in the week starting on the
specified day, what proportion (out of 1) are active during the following week.</p>
<h2><a class="header" href="#frequently-asked-questions" id="frequently-asked-questions">Frequently Asked Questions</a></h2>
<ul>
<li>Why isn't &quot;New Users&quot; a metric?
<ul>
<li>&quot;New Users&quot; is considered a <a href="https://mozilla.github.io/gud#data-model">usage criterion</a>, which means it may be used
to filter other metrics, rather than itself being a metric. For example,
you can compute &quot;New User DAU&quot;, which would be the subset of DAU that match
the &quot;New User&quot; criterion. The exception here is 1-Week New Profile
Retention, which is so common that it makes sense to include with all
usage criteria.</li>
</ul>
</li>
<li>What dates are used to determine activity for things like MAU and DAU?
<ul>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1422892">Submission dates</a> are used for determining when activity happened (<em>not</em>
client-side activity dates).</li>
</ul>
</li>
<li>What <a href="metrics/../datasets/pings.html">pings</a> are used as a signal of activity?
<ul>
<li>For Firefox Desktop, we use the <code>main</code> ping to determine activity.</li>
<li>For products instrumented using Glean, we use the <code>baseline</code> ping.</li>
</ul>
</li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/metrics/index.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#metric-definitions" id="metric-definitions">Metric Definitions</a></h1>
<p>These sections provide the lists of our standardized metrics, usage criteria, and slicing dimensions. All three are important to provide a holistic view of product usage and performance.</p>
<ul>
<li>
<p>A <a href="metrics/./usage.html"><code>usage criterion</code></a> tells us what has to happen for us to consider a product to have been used in a certain way and is needed to define metrics like MAU, which count users that use our products. For example, “Any Fenix Activity” measures activity for all Fenix profiles that have sent a <code>baseline</code> ping. Similarly, “Opened DevTools” means that we measure activity for all desktop Firefox profiles that have sent a telemetry ping indicating that DevTools was opened. We are working towards developing a standard usage criteria for each product, which operationalizes the idea that the product was &quot;used&quot;.</p>
</li>
<li>
<p>A <a href="metrics/./dimensions.html"><code>dimension</code></a> allows slicing to a subset of profiles according to characteristics of those profiles. Some dimensions include: country, channel, OS, etc. A <code>slice</code> is a set of particular values within dimensions, for example, “country is US” is one <code>slice</code> and “country is either US or DE and channel is release” is another.</p>
</li>
<li>
<p>A <a href="metrics/./metrics.html"><code>metric</code></a> is any quantity that we can calculate using our data and that, to some degree, measures some quantity of interest.</p>
</li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/metrics/definitions.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#metrics" id="metrics">Metrics</a></h1>
<p>This section contains definitions and information about standard metrics used at Mozilla. You may wish to refer to the <a href="metrics/../concepts/terminology.html">terminology section</a> while reading this document, in case a particular concept is not clear.</p>
<h2><a class="header" href="#table-of-contents-2" id="table-of-contents-2">Table of Contents</a></h2>
<ul>
<li><a href="metrics/metrics.html#daily-active-users-dau">Daily Active Users (DAU)</a>
<ul>
<li><a href="metrics/metrics.html#overview">Overview</a></li>
<li><a href="metrics/metrics.html#details">Details</a></li>
<li><a href="metrics/metrics.html#caveats">Caveats</a></li>
<li><a href="metrics/metrics.html#dashboards">Dashboards</a></li>
<li><a href="metrics/metrics.html#tables">Tables</a></li>
</ul>
</li>
<li><a href="metrics/metrics.html#day-2-7-activation">Day 2-7 Activation</a>
<ul>
<li><a href="metrics/metrics.html#overview-1">Overview</a></li>
<li><a href="metrics/metrics.html#details-1">Details</a></li>
<li><a href="metrics/metrics.html#caveats-1">Caveats</a></li>
<li><a href="metrics/metrics.html#dashboards-1">Dashboards</a></li>
<li><a href="metrics/metrics.html#tables-1">Tables</a></li>
</ul>
</li>
</ul>
<hr />
<h2><a class="header" href="#daily-active-users-dau" id="daily-active-users-dau">Daily Active Users (DAU)</a></h2>
<h3><a class="header" href="#overview" id="overview">Overview</a></h3>
<p>Daily Active Users or DAU counts the number of unique profiles active in the product on each day. This is intended to approximate the number of people using the product each day.</p>
<h3><a class="header" href="#details" id="details">Details</a></h3>
<p>DAU counts unique profiles. Keep in mind that a <a href="metrics/../concepts/analysis_gotchas.html#profiles-vs-users">profile is not necessarily a user</a>.</p>
<p>The standard concept of active varies by product, but generally, active users are defined as unique profiles that have sent a <code>main</code> ping (on desktop) or a <code>baseline</code> ping (on mobile). The precise criteria are defined in the <a href="metrics/./usage.html"><code>usage criterion</code></a> section of this documentation.</p>
<p>We can also restrict the metric to alternative usage criteria. It's <strong>critical to clearly state any non-standard usage criteria on the metric</strong>. The metrics team suggest the following format: <code>DAU(usage criterion)</code>. For example, we might be interested in the count of profiles that have viewed more than 5 URIs in a day. We'd denote that metric as <code>DAU(URI &gt; 5)</code>.</p>
<p>Some common alternative usage criteria documented in the <a href="metrics/./usage.html"><code>usage criterion</code> section</a>.</p>
<h3><a class="header" href="#caveats-1" id="caveats-1">Caveats</a></h3>
<p>If the number of users stays constant, but the average number of active profiles per user increases, this metric will tend to increase. For more details on the relationship between users and profiles, see <a href="metrics/../concepts/analysis_gotchas.html#profiles-vs-users">the profiles vs users section in analysis gotchas</a>.</p>
<h3><a class="header" href="#dashboards" id="dashboards">Dashboards</a></h3>
<p>This metric is available on the <a href="https://go.corp.mozilla.com/gud">standard Growth and Usage Dashboard (GUD)</a> for most products and with some slicing available.</p>
<h3><a class="header" href="#tables" id="tables">Tables</a></h3>
<p>DAU can easily be calculated from the <a href="metrics/../datasets/bigquery/exact_mau/reference.html">Exact MAU tables</a>; for example:</p>
<pre><code class="language-sql">SELECT
  submission_date,
  SUM(dau) AS dau
FROM
  mozdata.telemetry.firefox_desktop_exact_mau28_by_dimensions_v1
WHERE
  -- You define your slice using additional filters here.
  country IN ('US', 'GB', 'CA', 'FR', 'DE')

GROUP BY
  submission_date
</code></pre>
<p>You can run this query on <a href="https://sql.telemetry.mozilla.org/queries/72012/source">STMO</a>.</p>
<hr />
<h2><a class="header" href="#day-2-7-activation" id="day-2-7-activation">Day 2-7 Activation</a></h2>
<h3><a class="header" href="#overview-1" id="overview-1">Overview</a></h3>
<p>This measure attempts to tell us whether, after creating a profile, the user returned at any point in the next 6 days. This is meant to measure whether a product is successful in engaging users early on: at present, many users churn after the first run and we want to measure whether efforts to make them stick around are succeeding.</p>
<p>This metric is used for all mobile applications, excluding Fenix and Firefox Preview, and is a top-level OKR inside Mozilla for 2020. It can apply both on the level of a specific product (e.g. Firefox iOS, Lockwise for Android) as well as an aggregate measure across all mobile products and devices. This metric is <em>not</em> used for Firefox desktop.</p>
<h3><a class="header" href="#details-1" id="details-1">Details</a></h3>
<p>The day 2-7 activation metric is calculated as:</p>
<p>\[ \frac{\text{Activated New Profiles (day 2-7)}}{\text{New Profiles (day 1-7)}} \]</p>
<p>Activated New Profiles (day 2-7): Unique count of client ids who use the product at any point starting the day after they created a profile up to 6 days after.</p>
<p>New Profiles: Unique count of client ids with a given profile creation date. As not all initial pings are received exactly on the day of profile creation, we wait for 7 days after the profile creation date before establishing the New Profile cohort to ensure the data is complete.</p>
<p>E.g. For a cohort acquired (with a profile creation date) of Mar 1, they are considered activated in day 2-7 if they show up in DAU at any time between Mar 2nd and Mar 7th.</p>
<h3><a class="header" href="#caveats-2" id="caveats-2">Caveats</a></h3>
<p>As stated above, this measure is not currently used with Fenix or Firefox Preview. These products may send pings more frequently than for other mobile applications, and thus not be a fair comparison. Work is undergoing to make the reporting comparable and Fenix and Firefox Preview will be included once this is complete. Please see <a href="https://jira.mozilla.com/browse/DS-696"><code>JIRA DS-696</code></a> for more information and current status.</p>
<h3><a class="header" href="#dashboards-1" id="dashboards-1">Dashboards</a></h3>
<p>The <a href="https://datastudio.google.com/u/0/reporting/1L7dsFyqjT8XZHrYprYS-HCP5_k_gZGIb/page/0iERB">non-desktop day 2-7 dashboard</a> tracks this measure.</p>
<h3><a class="header" href="#tables-1" id="tables-1">Tables</a></h3>
<p>You can calculate this measure via the <code>firefox_nondesktop_day_2_7_activation</code> table in BigQuery. Here is a sample query:</p>
<pre><code class="language-sql">SELECT
  cohort_date,
  product,
  SUM(day_2_7_activated) as day_2_7_activated,
  SUM(new_profiles) as new_profiles,
  SAFE_DIVIDE(SUM(day_2_7_activated), SUM(new_profiles)) as day_2_7_activation
FROM
  `moz-fx-data-shared-prod.telemetry.firefox_nondesktop_day_2_7_activation`
WHERE
  cohort_date = &quot;2020-03-01&quot;
GROUP BY 1,2
ORDER BY 1
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/72054/source">link</a></p>
<hr />
<p>Reference below.</p>
<p>{{Metric name}}</p>
<p>TL;DR: two sentence max.</p>
<p>E.g: MAU counts the number of distinct users we see over a 28-day period. Desktop and Mobile MAU are both corporate KPIs for 2020.</p>
<ul>
<li>Overview:</li>
<li>What the metric measures</li>
<li>Calculation:</li>
<li>Definitions for both Mobile and Desktop, if applicable.</li>
<li>What is the easiest way to calculate this metric? E.g. MAU over <code>clients_last_seen</code>.</li>
<li>At least one working definition</li>
<li>Link to a scheduled Redash query (link with <code>stmocli</code>?)</li>
<li>Possibly an API-linked graph from STMO</li>
<li>If it’s non-obvious, examples for how to stratify. E.g. calculating MAU from <code>clients_daily</code></li>
<li>Common Issues: Failures and Gotchas</li>
<li>Resources</li>
<li>Link to the STMO query from Definition section</li>
<li>Notable dashboards for the metric</li>
<li>Similar metrics</li>
</ul>
<hr />
<p>Next metric</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/metrics/metrics.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#usage-criteria" id="usage-criteria">Usage Criteria</a></h1>
<p>Here we provide definitions and information about our standard definitions of usage of our products.</p>
<p>Table of contents with links to all products and criteria.</p>
<hr />
<h2><a class="header" href="#product-name" id="product-name">{{Product Name}}</a></h2>
<h3><a class="header" href="#usage-criteria-name" id="usage-criteria-name">{{Usage Criteria Name}}</a></h3>
<p>TL;DR: two sentence max.</p>
<ul>
<li>Overview:</li>
<li>What type of usage we want to capture</li>
<li>Calculation:</li>
<li>Definitions of what user has to do to qualify</li>
<li>Definitions of what telemetry must be sent to qualify.</li>
<li>At least one working definition</li>
<li>Link to a scheduled STMO query (link with <code>stmocli</code>?)</li>
<li>Possibly an API-linked graph from STMO</li>
<li>Common Issues: Failures and Gotchas</li>
<li>Resources</li>
<li>Similar criteria</li>
</ul>
<h3><a class="header" href="#next-usage-criteria-name" id="next-usage-criteria-name">{{Next Usage Criteria Name}}</a></h3>
<hr />
<h2><a class="header" href="#next-product-name" id="next-product-name">{{Next Product Name}}</a></h2>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/metrics/usage.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#slicing-dimensions" id="slicing-dimensions">Slicing Dimensions</a></h1>
<p>Here we provide definitions and information about our standard slicing dimensions.</p>
<p>Table of contents with links to dimensions.</p>
<hr />
<h2><a class="header" href="#dimension-name" id="dimension-name">{{Dimension Name}}</a></h2>
<p>TL;DR: two sentence max.</p>
<ul>
<li>Overview:</li>
<li>What segmentation do we want to capture</li>
<li>Calculation:</li>
<li>Definitions of what user has to do to qualify</li>
<li>Definitions of what telemetry must be sent to qualify.</li>
<li>At least one working definition</li>
<li>Link to a scheduled STMO query (link with <code>stmocli</code>?)</li>
<li>Possibly an API-linked graph from STMO</li>
<li>Common Issues: Failures and Gotchas</li>
<li>Resources</li>
<li>Similar dimensions</li>
</ul>
<hr />
<h2><a class="header" href="#next-dimension-name" id="next-dimension-name">{{Next Dimension Name}}</a></h2>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/metrics/dimensions.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#metric-policies" id="metric-policies">Metric Policies</a></h1>
<p>Metric standards are maintained by the Metrics Standardization Group (MSG) (link to contact information).</p>
<h2><a class="header" href="#how-to-get-more-information" id="how-to-get-more-information">How to get more information</a></h2>
<h2><a class="header" href="#how-to-propose-a-new-standard-metric-criteria-or-dimensions" id="how-to-propose-a-new-standard-metric-criteria-or-dimensions">How to propose a new standard metric, criteria, or dimensions</a></h2>
<h2><a class="header" href="#how-to-propose-a-change-to-a-standards" id="how-to-propose-a-change-to-a-standards">How to propose a change to a standards</a></h2>
<h2><a class="header" href="#recommendations-around-citing-standards-for-presentations-to-senior-audiences" id="recommendations-around-citing-standards-for-presentations-to-senior-audiences">Recommendations around citing standards for presentations to senior audiences</a></h2>
<p>Something about how all metrics presented should have references to definitions here or explanations as to why a nonstandard metric was used.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/metrics/policy.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#tutorials--cookbooks" id="tutorials--cookbooks">Tutorials &amp; Cookbooks</a></h1>
<p>This section contains documentation describing how to perform specific tasks. It includes the following sections:</p>
<ul>
<li><a href="cookbooks/analysis/index.html">Analysis Cookbooks</a>: Tutorials on analyzing data.</li>
<li><a href="cookbooks/operational/index.html">Operational Cookbooks</a>: Tutorials describing how to perform various operational tasks.</li>
<li><a href="cookbooks//datasets/new_data.html">Sending Telemetry</a>: Tutorials on adding new Telemetry.</li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/index.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#analysis" id="analysis">Analysis</a></h1>
<p>This section contains tutorials on how to analyze Telemetry data.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/analysis/index.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#accessing-public-data" id="accessing-public-data">Accessing Public Data</a></h1>
<p>A public dataset is a dataset in <a href="https://cloud.google.com/bigquery">BigQuery</a> which is made available to the general public
in BigQuery or through our <a href="https://public-data.telemetry.mozilla.org">public HTTP endpoint</a>.</p>
<h2><a class="header" href="#table-of-contents-3" id="table-of-contents-3">Table of Contents</a></h2>
<ul>
<li><a href="cookbooks/public_data.html#accessing-public-data-in-bigquery">Accessing Public Data in BigQuery</a></li>
<li><a href="cookbooks/public_data.html#accessing-public-data-through-the-public-http-endpoint">Accessing Public Data Through the Public HTTP Endpoint</a></li>
<li><a href="cookbooks/public_data.html#let-us-know">Let us know!</a></li>
</ul>
<h2><a class="header" href="#accessing-public-data-in-bigquery" id="accessing-public-data-in-bigquery">Accessing Public Data in BigQuery</a></h2>
<p>To access public datasets in BigQuery, a <a href="https://cloud.google.com">Google Cloud Platform</a> (GCP) account is required.
GCP also offers <a href="https://cloud.google.com/free">a free tier</a> which offers free credits to use and run queries in BigQuery. <a href="https://cloud.google.com/blog/products/data-analytics/query-without-a-credit-card-introducing-bigquery-sandbox">BigQuery sandbox</a> enables users to use BigQuery for free without requiring payment information.</p>
<p>To get started, log into the <a href="https://console.cloud.google.com/bigquery">BigQuery console</a> or use the
<a href="https://cloud.google.com/bigquery/docs/bq-command-line-tool">BigQuery command line tools</a> to <a href="https://cloud.google.com/appengine/docs/standard/nodejs/building-app/creating-project">create a new project</a>.
After selecting the project, Mozilla's public datasets in the <code>mozilla-public-data</code> project can
be accessed and queried. For example:</p>
<pre><code class="language-sql">SELECT *
FROM `mozilla-public-data.telemetry_derived.ssl_ratios_v1`
WHERE submission_date = &quot;2020-04-16&quot;
</code></pre>
<h2><a class="header" href="#accessing-public-data-through-the-public-http-endpoint" id="accessing-public-data-through-the-public-http-endpoint">Accessing Public Data Through the Public HTTP Endpoint</a></h2>
<p>Some BigQuery datasets are also published as gzipped JSON files through the public HTTP endpoint:
<a href="https://public-data.telemetry.mozilla.org">https://public-data.telemetry.mozilla.org</a>.</p>
<p>A list of available public datasets is available at: <a href="https://public-data.telemetry.mozilla.org/all-datasets.json">https://public-data.telemetry.mozilla.org/all-datasets.json</a>
This list contains the names of available datasets, additional metadata and links to the
storage locations of the files containing the data.</p>
<p>For example:</p>
<pre><code class="language-json">{
  &quot;telemetry_derived&quot;: {
    // ^ dataset name
    &quot;deviations&quot;: {
      // ^ table name
      &quot;v1&quot;: {
        // ^ table version
        &quot;friendly_name&quot;: &quot;Deviations&quot;,
        &quot;description&quot;: &quot;Deviation of different metrics from forecast.&quot;,
        &quot;incremental&quot;: true,
        &quot;incremental_export&quot;: false,
        &quot;review_link&quot;: &quot;https://bugzilla.mozilla.org/show_bug.cgi?id=1624528&quot;,
        &quot;files_uri&quot;: &quot;https://public-data.telemetry.mozilla.org/api/v1/tables/telemetry_derived/deviations/v1/files&quot;,
        &quot;last_updated&quot;: &quot;https://public-data.telemetry.mozilla.org/api/v1/tables/telemetry_derived/deviations/v1/last_updated&quot;
      }
    },
    &quot;ssl_ratios&quot;: {
      &quot;v1&quot;: {
        &quot;friendly_name&quot;: &quot;SSL Ratios&quot;,
        &quot;description&quot;: &quot;Percentages of page loads Firefox users have performed that were  conducted over SSL broken down by country.&quot;,
        &quot;incremental&quot;: true,
        &quot;incremental_export&quot;: false,
        &quot;review_link&quot;: &quot;https://bugzilla.mozilla.org/show_bug.cgi?id=1414839&quot;,
        &quot;files_uri&quot;: &quot;https://public-data.telemetry.mozilla.org/api/v1/tables/telemetry_derived/ssl_ratios/v1/files&quot;,
        &quot;last_updated&quot;: &quot;https://public-data.telemetry.mozilla.org/api/v1/tables/telemetry_derived/ssl_ratios/v1/last_updated&quot;
      }
    }
    // [...]
  }
}
</code></pre>
<p>The keys within each dataset have the following meanings:</p>
<ul>
<li><code>incremental</code>:
<ul>
<li><code>true</code>: data gets incrementally updated which means that new data gets added periodically
(for most datasets on a daily basis)</li>
<li><code>false</code>: the entire table data gets updated periodically</li>
</ul>
</li>
<li><code>incremental_export</code>:
<ul>
<li><code>true</code>: data for each <code>submission_date</code> gets exported into separate directories (e.g.
<code>files/2020-04-15</code>, <code>files/2020-04-16</code>, ...)</li>
<li><code>false</code>: all data gets exported into one <code>files/</code> directory</li>
</ul>
</li>
<li><code>review_link</code>: links to the Bugzilla bug for the data review</li>
<li><code>files_uri</code>: lists links to all available data files</li>
<li><code>last_updated</code>: link to a <code>last_updated</code> file containing the timestamp for when the data files were
last updated</li>
</ul>
<p>Data files are gzipped and up to 1 GB in size. If the data exceeds 1 GB, then it gets split up into multiple
files named <code>000000000000.json</code>, <code>000000000001.json</code>, ...
For example: <a href="https://public-data.telemetry.mozilla.org/api/v1/tables/telemetry_derived/ssl_ratios/v1/files/000000000000.json">https://public-data.telemetry.mozilla.org/api/v1/tables/telemetry_derived/ssl_ratios/v1/files/000000000000.json</a></p>
<h2><a class="header" href="#let-us-know" id="let-us-know">Let us know!</a></h2>
<p>If this public data has proved useful to your research, or you've built a cool visualization with it, let us know! You can email <a href="mailto:publicdata@mozilla.com"><code>publicdata@mozilla.com</code></a> or reach us on the <a href="https://chat.mozilla.org/#/room/#telemetry:mozilla.org">#telemetry:mozilla.org</a> channel on <a href="https://wiki.mozilla.org/Matrix">Mozilla's instance of matrix</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/public_data.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#accessing-and-working-with-bigquery" id="accessing-and-working-with-bigquery">Accessing and working with BigQuery</a></h1>
<p>With the transition to <a href="https://cloud.google.com">GCP</a> in 2019 having been completed, BigQuery has become Mozilla's primary data warehouse and SQL Query engine.</p>
<p>The following topics provide an introduction to working with data that is stored
in <a href="https://cloud.google.com/bigquery/">BigQuery</a>:</p>
<ul>
<li><a href="cookbooks/./bigquery/access.html">Accessing BigQuery</a></li>
<li><a href="cookbooks/./bigquery/querying.html">Writing BigQuery Queries</a></li>
<li><a href="cookbooks/./bigquery/optimization.html">Optimizing BigQuery Queries</a></li>
</ul>
<p>There is a <a href="https://cloud.google.com/bigquery/pricing">cost associated with using BigQuery</a> based on operations. The on-demand pricing for queries is based on how much data a query scans. Before using BigQuery, please see <a href="cookbooks/./bigquery/optimization.html">Optimizing BigQuery Queries</a> above for information on how to understand and minimize costs.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/bigquery.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#accessing-bigquery" id="accessing-bigquery">Accessing BigQuery</a></h1>
<p>There are many methods that you can use to access BigQuery: both interactive and programmatic. This document provides some basic information and pointers on how to get started with each.</p>
<p>It is worth pointing out that all internal access to BigQuery is logged and periodically audited by Data Engineering and Operations for cost and other purposes.</p>
<h2><a class="header" href="#table-of-contents-4" id="table-of-contents-4">Table of Contents</a></h2>
<ul>
<li><a href="cookbooks/bigquery/access.html#interfaces">Interfaces</a>
<ul>
<li><a href="cookbooks/bigquery/access.html#stmo-sqltelemetrymozillaorg">STMO (<code>sql.telemetry.mozilla.org</code>)</a></li>
<li><a href="cookbooks/bigquery/access.html#bigquery-console">BigQuery Console</a></li>
<li><a href="cookbooks/bigquery/access.html#using-the-bq-command-line-tool">Using the <code>bq</code> Command-Line Tool</a></li>
<li><a href="cookbooks/bigquery/access.html#api-access">API Access</a>
<ul>
<li><a href="cookbooks/bigquery/access.html#service-accounts">Service Accounts</a></li>
</ul>
</li>
<li><a href="cookbooks/bigquery/access.html#spark">Spark</a></li>
<li><a href="cookbooks/bigquery/access.html#colaboratory">Colaboratory</a></li>
<li><a href="cookbooks/bigquery/access.html#ai-platform-notebooks">AI Platform Notebooks</a></li>
</ul>
</li>
<li><a href="cookbooks/bigquery/access.html#bigquery-access-request">BigQuery Access Request</a></li>
</ul>
<h2><a class="header" href="#interfaces" id="interfaces">Interfaces</a></h2>
<h3><a class="header" href="#stmo-sqltelemetrymozillaorg-1" id="stmo-sqltelemetrymozillaorg-1">STMO (<code>sql.telemetry.mozilla.org</code>)</a></h3>
<blockquote>
<p><strong>⚠</strong> Queries made from STMO are read-only: you cannot create views or tables.</p>
</blockquote>
<p>All users with access to <a href="cookbooks/bigquery/../../tools/stmo.html">STMO</a> can access BigQuery using the following data sources:</p>
<ul>
<li><code>Telemetry (BigQuery)</code></li>
<li><code>Telemetry Search (BigQuery)</code></li>
</ul>
<h3><a class="header" href="#bigquery-console" id="bigquery-console">BigQuery Console</a></h3>
<blockquote>
<p><strong>⚠</strong> This method requires <a href="cookbooks/bigquery/access.html#bigquery-access-request">BigQuery Access</a> to be provisioned.</p>
</blockquote>
<p>The BigQuery console is similar to STMO, but allows write access to views and tables. Some
people also prefer its user interface, though note that results that you get from it can
only be shared with others who also have BigQuery access provisioned.</p>
<ul>
<li>Visit <a href="https://console.cloud.google.com/bigquery">GCP BigQuery Console</a></li>
<li>Switch to <code>mozdata</code> or the project provided to you during your access request e.g <code>moz-fx-data-bq-&lt;team-name&gt;</code></li>
<li>Write and run your queries</li>
</ul>
<p>Note that if you are trying to query telemetry datasets from a team-specific project,
you will need to explicitly specify
the project (<code>mozdata</code>) that the view lives in, since you're querying from a different one. For example:</p>
<pre><code class="language-sql">SELECT
  client_id
FROM
  mozdata.telemetry.main
WHERE
  DATE(submission_timestamp) = '2020-04-20'
  AND sample_id = 42
  AND application.channel='nightly'
</code></pre>
<p>For more details, see <a href="https://cloud.google.com/bigquery/docs/bigquery-web-ui">Google's Documentation on the GCP Console</a>.</p>
<h3><a class="header" href="#using-the-bq-command-line-tool" id="using-the-bq-command-line-tool">Using the <code>bq</code> Command-Line Tool</a></h3>
<blockquote>
<p><strong>⚠</strong> This method requires <a href="cookbooks/bigquery/access.html#bigquery-access-request">BigQuery Access</a> to be provisioned.</p>
</blockquote>
<p>Steps to use:</p>
<ul>
<li>Install the <a href="https://cloud.google.com/sdk/">GCP SDK</a></li>
<li>Authorize <code>gcloud</code> with either your user account or provisioned service account. See documentation <a href="https://cloud.google.com/sdk/docs/authorizing">here</a>.
<ul>
<li><code>gcloud auth login</code></li>
</ul>
</li>
<li>Set your google project to your team project
<ul>
<li><code>gcloud config set project moz-fx-data-bq-&lt;team-name&gt;</code></li>
<li>project name will be provided for you when your account is provisioned.</li>
</ul>
</li>
</ul>
<p>Once configured, you can now use the <code>bq</code> command-line client. The following example
lists the tables and views in a BigQuery dataset:</p>
<pre><code class="language-bash">bq ls mozdata:telemetry
</code></pre>
<p>And here's another which gets the count of entries in <code>telemetry.main</code> on <code>2019-08-22</code> in the nightly channel:</p>
<pre><code class="language-bash">bq query --nouse_legacy_sql 'select count(*) from mozdata.telemetry.main where submission_date = &quot;2019-08-22&quot; and normalized_channel=&quot;nightly&quot;'
</code></pre>
<p>Additional examples and documentation can be found <a href="https://cloud.google.com/bigquery/docs/bq-command-line-tool">in the BigQuery command-line reference</a>.</p>
<h3><a class="header" href="#api-access" id="api-access">API Access</a></h3>
<blockquote>
<p><strong>⚠</strong> This method requires <a href="cookbooks/bigquery/access.html#bigquery-access-request">BigQuery Access</a> to be provisioned.</p>
</blockquote>
<p>For advanced use cases involving programmatic access -- including automated workloads, ETL, <a href="https://cloud.google.com/bigquery/docs/reference/storage/">BigQuery Storage API</a>.</p>
<p>You can locate a list of supported BigQuery client libraries <a href="https://cloud.google.com/bigquery/docs/reference/libraries">here</a>.</p>
<p>Although you typically want to use a client library, Google also provides a <a href="https://cloud.google.com/bigquery/docs/reference/rest/">detailed reference of their underlying REST API</a>.</p>
<h4><a class="header" href="#service-accounts" id="service-accounts">Service Accounts</a></h4>
<p>Client SDKs do not access credentials the same way as the <code>gcloud</code> and <code>bq</code>
command-line tools. The client SDKs generally assume that the machine is configured with
a service account and looks for JSON-based credentials in several well-known locations
rather than looking for user credentials.</p>
<p>If you have service account credentials, you can point client SDKs at them
by setting:</p>
<pre><code class="language-bash">export GOOGLE_APPLICATION_CREDENTIALS=/path/to/creds.json
</code></pre>
<p>If you do not have appropriate service account credentials, but your GCP user
account has sufficient access, you can have your user credentials mimic a
service account by running:</p>
<pre><code class="language-bash">gcloud auth application-default login
</code></pre>
<p>Once you've followed the browser flow to grant access, you should be able to,
for example, access BigQuery from Python:</p>
<pre><code class="language-bash">pip install google-cloud-bigquery
python -c 'from google.cloud import bigquery; print([d.dataset_id for d in bigquery.Client().list_datasets()])'
</code></pre>
<h3><a class="header" href="#spark" id="spark">Spark</a></h3>
<p><a href="https://spark.apache.org/">Apache Spark</a> is a data processing engine designed to be fast and easy to use. There are several methods you can use to access BigQuery via Spark, depending on your needs. See <a href="cookbooks/bigquery/../../tools/spark.html">Custom Analysis with Spark</a> for more information and examples.</p>
<h3><a class="header" href="#colaboratory" id="colaboratory">Colaboratory</a></h3>
<blockquote>
<p><strong>⚠</strong> This method requires <a href="cookbooks/bigquery/access.html#bigquery-access-request">BigQuery Access</a> to be provisioned.</p>
</blockquote>
<p><a href="https://colab.research.google.com">Colaboratory</a> (Colab) is Jupyter notebook environment, managed by Google and running in the cloud. Notebooks are stored in Google Drive and can be shared in a similar way to Google Docs.</p>
<p>Colab can be used to easily access BigQuery and perform analyses. See the <a href="https://colab.research.google.com/drive/1uXmrPnqzDATiCVH2RNJKD8obIZuofFHx"><code>Telemetry Hello World</code> notebook</a> for an interactive example. Under the hood, it uses the BigQuery API to read and write to BigQuery tables, so access needs to be explicitly provisioned.</p>
<h3><a class="header" href="#ai-platform-notebooks" id="ai-platform-notebooks">AI Platform Notebooks</a></h3>
<blockquote>
<p><strong>⚠</strong> This method requires <a href="cookbooks/bigquery/access.html#bigquery-access-request">BigQuery Access</a> to be provisioned.</p>
</blockquote>
<p><a href="https://cloud.google.com/ai-platform/notebooks/docs">AI Platform Notebooks</a> is a managed JupyterLab service running on GCP. It gives you full control over the machine where your notebooks are running - you can install your own libraries and choose machine size depending on your needs.</p>
<p>To start, go to <a href="https://console.cloud.google.com">GCP console</a> and make sure you are in the correct project - most likely this will be your team project. Then navigate to the Notebooks page in the sidebar under AI Platform &gt; Notebooks (<a href="https://console.cloud.google.com/ai-platform/notebooks/list/instances">direct link</a>). There you can create new notebook server instances and connect to them (when your instance is ready, you'll see an <code>Open JupyterLab</code> button).</p>
<p>Please note that by default JupyterLab saves notebook files only locally, so they are lost if your instance is deleted. To make sure you don't lose your work, either push your files to a Git repository (via a pre-installed Git extension) or upload them to GCS (using <code>gsutil</code> command in a terminal session).</p>
<h2><a class="header" href="#bigquery-access-request" id="bigquery-access-request">BigQuery Access Request</a></h2>
<p>For access to BigQuery when using the GCP Console and API, <a href="https://bugzilla.mozilla.org/enter_bug.cgi?assigned_to=jthomas%40mozilla.com&amp;bug_file_loc=https%3A%2F%2Fmana.mozilla.org%2Fwiki%2Fx%2FiIPeB&amp;bug_ignored=0&amp;bug_severity=normal&amp;bug_status=NEW&amp;bug_type=task&amp;cf_fx_iteration=---&amp;cf_fx_points=---&amp;comment=Please%20grant%20me%20access%20to%20the%20BigQuery%20GCP%20console%20and%20API%20Access.%20I%20work%20on%20%3Cteam%3E.%0D%0A%0D%0AMy%20mozilla.com%20ldap%20login%20is%20%3Cyour%20ldap%20login%3E%40mozilla.com.&amp;component=Operations&amp;contenttypemethod=list&amp;contenttypeselection=text%2Fplain&amp;defined_groups=1&amp;flag_type-4=X&amp;flag_type-607=X&amp;flag_type-800=X&amp;flag_type-803=X&amp;flag_type-936=X&amp;form_name=enter_bug&amp;maketemplate=Remember%20values%20as%20bookmarkable%20template&amp;op_sys=Unspecified&amp;priority=--&amp;product=Data%20Platform%20and%20Tools&amp;qa_contact=jthomas%40mozilla.com&amp;rep_platform=Unspecified&amp;short_desc=BigQuery%20GCP%20Console%20and%20API%20Access%20for%20%3Cyour%20ldap%20login%3E%40mozilla.com&amp;target_milestone=---&amp;version=unspecified">file a bug</a>. You will be added to the appropriate Google Groups and a <a href="https://cloud.google.com/iam/docs/service-accounts">GCP Service Account</a> will be provisioned for you.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/bigquery/access.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#querying-bigquery-tables" id="querying-bigquery-tables">Querying BigQuery Tables</a></h1>
<h2><a class="header" href="#table-of-contents-5" id="table-of-contents-5">Table of Contents</a></h2>
<ul>
<li><a href="cookbooks/bigquery/querying.html#projects-datasets-and-tables-in-bigquery">Projects, Datasets, and Tables in BigQuery</a>
<ul>
<li><a href="cookbooks/bigquery/querying.html#caveats">Caveats</a></li>
<li><a href="cookbooks/bigquery/querying.html#projects-with-bigquery-datasets">Projects with BigQuery datasets</a></li>
<li><a href="cookbooks/bigquery/querying.html#table-layout-and-naming">Table Layout and Naming</a></li>
<li><a href="cookbooks/bigquery/querying.html#structure-of-ping-tables-in-bigquery">Structure of Ping Tables in BigQuery</a></li>
</ul>
</li>
<li><a href="cookbooks/bigquery/querying.html#writing-queries">Writing Queries</a>
<ul>
<li><a href="cookbooks/bigquery/querying.html#writing-query-results-to-a-permanent-table">Writing query results to a permanent table</a></li>
<li><a href="cookbooks/bigquery/querying.html#writing-results-to-gcs-object-store">Writing results to GCS (object store)</a></li>
</ul>
</li>
<li><a href="cookbooks/bigquery/querying.html#creating-a-view">Creating a View</a></li>
<li><a href="cookbooks/bigquery/querying.html#using-udfs">Using UDFs</a></li>
<li><a href="cookbooks/bigquery/querying.html#accessing-map-like-fields">Accessing map-like fields</a></li>
<li><a href="cookbooks/bigquery/querying.html#accessing-histograms">Accessing histograms</a></li>
</ul>
<h2><a class="header" href="#projects-datasets-and-tables-in-bigquery" id="projects-datasets-and-tables-in-bigquery">Projects, Datasets, and Tables in BigQuery</a></h2>
<p>In GCP a <a href="https://cloud.google.com/resource-manager/docs/creating-managing-projects">project</a> enables you to organize cloud resources. Mozilla uses multiple
projects to maintain BigQuery <a href="https://cloud.google.com/bigquery/docs/datasets-intro">datasets</a>.</p>
<blockquote>
<p><strong>Note</strong>: The term <em>dataset</em> has historically been used to describe a set of records that all follow the same schema, but this idea corresponds to a <em>table</em>
in BigQuery. In BigQuery terminology,
datasets represent top-level containers that are used to organize and
control access to tables and views.</p>
</blockquote>
<h3><a class="header" href="#caveats-3" id="caveats-3">Caveats</a></h3>
<ul>
<li>The date partition field (e.g., <code>submission_date_s3</code>, <code>submission_date</code>) is mostly used as a partitioning column.
However, it has changed from using a <code>YYYYMMDD</code> string form to a <code>DATE</code> type that uses string literals in the more standards-friendly <code>YYYY-MM-DD</code> form.</li>
<li>Unqualified queries can become very costly very easily. Restrictions have been placed on large tables to avoid accidental querying &quot;all data for all time&quot;. You must use the date partition fields for large tables (like <code>main_summary</code> or <code>clients_daily</code>).</li>
<li>Read the <a href="cookbooks/bigquery/./optimization.html"><em>Query Optimization Cookbook</em></a> that includes recommendations on how to reduce cost and improve query performance.</li>
<li>STMO BigQuery data sources have a 10 TB data-scanned limit for each query. <a href="cookbooks/bigquery/../../concepts/getting_help.html">Let us know</a> if this becomes an issue.</li>
<li>There is not any native map support available in BigQuery. Instead, structs are used with fields [key, value]. Convenience functions are available to access the like key-value maps, as described <a href="cookbooks/bigquery/querying.html#accessing-map-like-fields">below</a>.</li>
</ul>
<h3><a class="header" href="#projects-with-bigquery-datasets" id="projects-with-bigquery-datasets">Projects with BigQuery datasets</a></h3>
<table><thead><tr><th>Project</th><th>Dataset</th><th>Purpose</th></tr></thead><tbody>
<tr><td><code>mozdata</code></td><td></td><td>The primary home for user analysis; it has a short name that is easy to type and is filled with views that reference underlying tables in <code>moz-fx-data-shared-prod</code>; the default project for STMO and Looker</td></tr>
<tr><td></td><td><code>analysis</code></td><td>User-generated tables for analysis; please prefix tables with your username</td></tr>
<tr><td></td><td><code>tmp</code></td><td>User-generated tables for ephemeral analysis results; tables created here are automatically deleted after 7 days.</td></tr>
<tr><td></td><td><code>telemetry</code></td><td>Views into legacy desktop telemetry pings and many derived tables; see <em>user-facing (unsuffixed) datasets</em> below</td></tr>
<tr><td></td><td><code>&lt;namespace&gt;</code></td><td>See <em>user-facing (unsuffixed) datasets</em> below</td></tr>
<tr><td></td><td><code>search</code></td><td>Search data imported from parquet (<em>restricted</em>)</td></tr>
<tr><td></td><td><code>static</code></td><td>Static tables, often useful for data-enriching joins</td></tr>
<tr><td></td><td><code>udf</code></td><td>Internal persistent user-defined functions defined in SQL; see <a href="cookbooks/bigquery/querying.html#using-udfs">Using UDFs</a></td></tr>
<tr><td></td><td><code>udf_js</code></td><td>Internal user-defined functions defined in JavaScript; see <a href="cookbooks/bigquery/querying.html#using-udfs">Using UDFs</a></td></tr>
<tr><td><code>mozfun</code></td><td></td><td>The primary home for user-defined functions; see <a href="cookbooks/bigquery/querying.html#using-udfs">Using UDFs</a></td></tr>
<tr><td><code>moz-fx-data-bq-&lt;team-name&gt;</code></td><td></td><td>Some teams have specialized needs and can be provisioned a team-specific project</td></tr>
<tr><td><code>moz-fx-data-shared-prod</code></td><td></td><td>All production data including full pings and derived datasets defined in <a href="https://github.com/mozilla/bigquery-etl">bigquery-etl</a></td></tr>
<tr><td></td><td><code>&lt;namespace&gt;_live</code></td><td>See <em>live datasets</em> below</td></tr>
<tr><td></td><td><code>&lt;namespace&gt;_stable</code></td><td>See <em>stable datasets</em> below</td></tr>
<tr><td></td><td><code>&lt;namespace&gt;_derived</code></td><td>See <em>derived datasets</em> below</td></tr>
<tr><td></td><td><code>&lt;product&gt;_external</code></td><td>Tables that reference external resources; these may be native BigQuery tables populated by a job that queries an third-party API, or they may be <a href="https://cloud.google.com/bigquery/external-data-sources">federated data sources</a> that pull data from other GCP services like GCS at query time.</td></tr>
<tr><td></td><td><code>backfill</code></td><td>Temporary staging area for back-fills</td></tr>
<tr><td></td><td><code>blpadi</code></td><td>Blocklist ping derived data(<em>restricted</em>)</td></tr>
<tr><td></td><td><code>payload_bytes_raw</code></td><td>Raw JSON payloads as received from clients, used for reprocessing scenarios, a.k.a. &quot;landfill&quot; (<em>restricted</em>)</td></tr>
<tr><td></td><td><code>payload_bytes_decoded</code></td><td><code>gzip</code>-compressed decoded JSON payloads, used for reprocessing scenarios</td></tr>
<tr><td></td><td><code>payload_bytes_error</code></td><td><code>gzip</code>-compressed JSON payloads that were rejected in some phase of the pipeline; particularly useful for investigating schema validation errors</td></tr>
<tr><td></td><td><code>tmp</code></td><td>Temporary staging area for parquet data loads</td></tr>
<tr><td></td><td><code>validation</code></td><td>Temporary staging area for validation</td></tr>
<tr><td><code>moz-fx-data-derived-datasets</code></td><td></td><td>Legacy project that was a precursor to <code>mozdata</code></td></tr>
<tr><td><code>moz-fx-data-shar-nonprod-efed</code></td><td></td><td>Non-production data produced by stage ingestion infrastructure</td></tr>
</tbody></table>
<h3><a class="header" href="#table-layout-and-naming" id="table-layout-and-naming">Table Layout and Naming</a></h3>
<p>Under the single <code>moz-fx-data-shared-prod</code> project,
each document namespace (corresponding to folders underneath the <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/tree/master/schemas">schemas directory of <code>mozilla-pipeline-schemas</code></a>) has four BigQuery datasets provisioned with the following properties:</p>
<ul>
<li><em>Live datasets</em> (<code>telemetry_live</code>, <code>activity_stream_live</code>, etc.) contain live ping tables (see definitions of table types in the next paragraph)</li>
<li><em>Stable datasets</em> (<code>telemetry_stable</code>, <code>activity_stream_stable</code>, etc.) contain historical ping tables</li>
<li><em>Derived datasets</em> (<code>telemetry_derived</code>, <code>activity_stream_derived</code>, etc.) contain derived tables, primarily populated via nightly queries defined in <a href="https://github.com/mozilla/bigquery-etl">BigQuery ETL</a> and managed by Airflow</li>
<li><em>User-facing (unsuffixed) datasets</em> (<code>telemetry</code>, <code>activity_stream</code>, etc.) contain user-facing views on top of the tables in the corresponding stable and derived datasets.</li>
</ul>
<p>The table and view types referenced above are defined as follows:</p>
<ul>
<li><em>Live ping tables</em> are the final destination for the <a href="https://mozilla.github.io/gcp-ingestion/">telemetry ingestion pipeline</a>. Dataflow jobs process incoming ping payloads from clients, batch them together by document type, and load the results to these tables approximately every five minutes, although a few document types are opted in to a more expensive streaming path that makes records available in BigQuery within seconds of ingestion. These tables are partitioned by date according to <code>submission_timestamp</code> and are also clustered on that same field, so it is possible to make efficient queries over short windows of recent data such as the last hour. They have a rolling expiration period of 30 days, but that window may be shortened in the future. Analyses should only use these tables if they need results for the current (partial) day.</li>
<li><em>Historical ping tables</em> have exactly the same schema as their corresponding live ping tables, but they are populated only once per day via an Airflow job and have a 25 month retention period. These tables are superior to the live ping tables for historical analysis because they never contain partial days, they have additional deduplication applied, and they are clustered on <code>sample_id</code>, allowing efficient queries on a 1% sample of clients. It is guaranteed that <code>document_id</code> is distinct within each UTC day of each historical ping table, but it is still possible for a document to appear multiple times if a client sends the same payload across multiple days. Note that this requirement is relaxed for older telemetry ping data that was backfilled from AWS; approximately 0.5% of documents are duplicated in <code>telemetry.main</code> and other historical ping tables for 2019-04-30 and earlier dates.</li>
<li><em>Derived tables</em> are populated by nightly <a href="https://workflow.telemetry.mozilla.org/home">Airflow</a> jobs and are considered an implementation detail; their structure may change at any time at the discretion of the data platform team to allow refactoring or efficiency improvements.</li>
<li><em>User-facing views</em> are the schema objects that users are primarily expected to use in analyses. Many of these views correspond directly to an underlying historical ping table or derived table, but they provide the flexibility to hide deprecated columns or present additional calculated columns to users. These views are the schema contract with users and they should not change in backwards-incompatible ways without a version increase or an announcement to users about a breaking change.</li>
</ul>
<p>Spark and other applications relying on the BigQuery Storage API for data access need to reference derived tables or historical ping tables directly rather than user-facing views. Unless the query result is relatively large, we recommend instead that users run a query on top of user-facing views with the output saved in a destination table, which can then be accessed from Spark.</p>
<h3><a class="header" href="#structure-of-ping-tables-in-bigquery" id="structure-of-ping-tables-in-bigquery">Structure of Ping Tables in BigQuery</a></h3>
<p>Unlike with the previous AWS-based data infrastructure, we don't have different mechanisms for accessing entire pings vs. &quot;summary&quot; tables. As such, there are no longer special libraries or infrastructure necessary for accessing full pings, rather each document type maps to a user-facing view that can be queried in STMO. For example:</p>
<ul>
<li>&quot;main&quot; pings are accessible from view <code>telemetry.main</code> (<a href="cookbooks/bigquery/../../datasets/main_ping_tables.html">see docs for faster-to-query tables</a>)</li>
<li>&quot;crash&quot; pings are accessible from view <code>telemetry.crash</code></li>
<li>&quot;baseline&quot; pings for the release version of Firefox for Android (Fenix) are accessible from view <code>org_mozilla_firefox.baseline</code></li>
</ul>
<p>All fields in the incoming pings are accessible in these views, and (where possible) match the nested data structures of the original JSON. Field names are converted from <code>camelCase</code> form to <code>snake_case</code> for consistency and SQL compatibility.</p>
<p>Any fields not present in the ping schemas are present in an <code>additional_properties</code> field containing leftover JSON. BigQuery provides <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/json_functions">functions for parsing and manipulating JSON data via SQL</a>.</p>
<p>Later in this document, we demonstrate the use of a few Mozilla-specific
functions that we have defined to allow ergonomic querying of
<a href="cookbooks/bigquery/querying.html#accessing-map-like-fields">map-like fields</a> (which are represented as arrays of structs in BigQuery) and
<a href="cookbooks/bigquery/querying.html#accessing-histograms">histograms</a> (which are encoded as raw JSON strings).</p>
<h2><a class="header" href="#writing-queries" id="writing-queries">Writing Queries</a></h2>
<p>To query a BigQuery table you will need to specify the dataset and table name. It is good practice to specify the project however depending on which project the query
originates from this is optional.</p>
<pre><code class="language-sql">SELECT
    col1,
    col2
FROM
    `project.dataset.table`
WHERE
    -- data_partition_field will vary based on table
    date_partition_field &gt;= DATE_SUB(CURRENT_DATE, INTERVAL 1 MONTH)
</code></pre>
<p>An example query from <a href="cookbooks/bigquery/../../datasets/bigquery/clients_last_seen/reference.html">Clients Last Seen Reference</a></p>
<pre><code class="language-sql">SELECT
    submission_date,
    os,
    COUNT(*) AS count
FROM
    mozdata.telemetry.clients_last_seen
WHERE
    submission_date &gt;= DATE_SUB(CURRENT_DATE, INTERVAL 1 WEEK)
    AND days_since_seen = 0
GROUP BY
    submission_date,
    os
HAVING
    count &gt; 10 -- remove outliers
    AND lower(os) NOT LIKE '%windows%'
ORDER BY
    os,
    submission_date DESC
</code></pre>
<p>Check out the <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators">BigQuery Standard SQL Functions &amp; Operators</a> for detailed documentation.</p>
<h3><a class="header" href="#writing-query-results-to-a-permanent-table" id="writing-query-results-to-a-permanent-table">Writing query results to a permanent table</a></h3>
<p>You can write query results to a BigQuery table you have access via <a href="cookbooks/bigquery/access.html#gcp-bigquery-console">GCP BigQuery Console</a> or <a href="cookbooks/bigquery/access.html#gcp-bigquery-api-access">GCP BigQuery API Access</a></p>
<ul>
<li>Use the <code>mozdata.analysis</code> dataset.
<ul>
<li>Prefix your table with your username. If your username is <code>username@mozilla.com</code> create a table with <code>username_my_table</code>.</li>
</ul>
</li>
<li>See <a href="https://cloud.google.com/bigquery/docs/writing-results">Writing query results</a> documentation for detailed steps.</li>
</ul>
<h3><a class="header" href="#writing-results-to-gcs-object-store" id="writing-results-to-gcs-object-store">Writing results to GCS (object store)</a></h3>
<p>If a BigQuery table is not a suitable destination for your analysis results,
we also have a GCS bucket available for storing analysis results. It is usually
Spark jobs that will need to do this.</p>
<ul>
<li>Use bucket <code>gs://mozdata-analysis/</code>
<ul>
<li>Prefix object paths with your username. If your username is <code>username@mozilla.com</code>, you might store a file to <code>gs://mozdata-analysis/username/myresults.json</code>.</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#creating-a-view" id="creating-a-view">Creating a View</a></h2>
<p>You can create views in BigQuery if you have access via <a href="cookbooks/bigquery/access.html#gcp-bigquery-console">GCP BigQuery Console</a> or <a href="cookbooks/bigquery/access.html#gcp-bigquery-api-access">GCP BigQuery API Access</a>.</p>
<ul>
<li>Use the <code>mozdata.analysis</code> dataset.
<ul>
<li>Prefix your view with your username. If your username is <code>username@mozilla.com</code> create a table with <code>username_my_view</code>.</li>
</ul>
</li>
<li>See <a href="https://cloud.google.com/bigquery/docs/views">Creating Views</a> documentation for detailed steps.</li>
</ul>
<h2><a class="header" href="#using-udfs" id="using-udfs">Using UDFs</a></h2>
<p>BigQuery offers <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/user-defined-functions">user-defined functions</a> (UDFs) that can be defined in SQL or JavaScript as part of a query or as a persistent function stored in a dataset. We have defined a suite of public persistent functions to enable transformations specific to our data formats, available in <a href="https://mozilla.github.io/bigquery-etl/"><code>mozfun</code></a>. UDFs used internally in <code>moz-fx-data-shared-prod</code> are available in datasets <code>udf</code> (for functions defined in SQL) and <code>udf_js</code> (for functions defined in JavaScript). Note that JavaScript functions are potentially much slower than those defined in SQL, so use functions in <code>udf_js</code> with some caution, likely only after performing aggregation in your query.</p>
<p>We document a few of the most broadly useful UDFs below, but you can see the full list of <code>mozfun</code> UDFs in <a href="https://mozilla.github.io/bigquery-etl/">https://mozilla.github.io/bigquery-etl</a> and or UDFs with source code used within <code>moz-fx-data-shared-prod</code> in <a href="https://github.com/mozilla/bigquery-etl/tree/master/sql/moz-fx-data-shared-prod/udf"><code>bigquery-etl/sql/moz-fx-data-shared-prod/udf</code></a> and <a href="https://github.com/mozilla/bigquery-etl/tree/master/sql/moz-fx-data-shared-prod/udf_js"><code>bigquery-etl/sql/moz-fx-data-shared-prod/udf_js</code></a>.</p>
<h2><a class="header" href="#accessing-map-like-fields" id="accessing-map-like-fields">Accessing map-like fields</a></h2>
<p>BigQuery currently lacks native map support and our workaround is to use a STRUCT type with fields named [key, value]. We've created a UDF that provides key-based access with the signature: <code>mozfun.map.get_key(&lt;struct&gt;, &lt;key&gt;)</code>. The example below generates a count per <code>reason</code> key in the <code>event_map_values</code> field in the telemetry events table for Normandy unenrollment events from yesterday.</p>
<pre><code class="language-sql">SELECT mozfun.map.get_key(event_map_values, 'reason') AS reason,
       COUNT(*) AS EVENTS
FROM telemetry.events
WHERE submission_date = DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)
  AND event_category='normandy'
  AND event_method='unenroll'
GROUP BY 1
ORDER BY 2 DESC
</code></pre>
<h2><a class="header" href="#accessing-histograms" id="accessing-histograms">Accessing histograms</a></h2>
<p>We considered many potential ways to represent histograms as BigQuery fields
and found the most efficient encoding was actually to leave them as raw JSON
strings. To make these strings easier to use for analysis, you can convert them
into nested structures using <code>mozfun.hist.extract</code>:</p>
<pre><code class="language-sql">WITH
  extracted AS (
  SELECT
    submission_timestamp,
    mozfun.hist.extract(payload.histograms.a11y_consumers) AS a11y_consumers
  FROM
    telemetry.main )
  --
SELECT
  a11y_consumers.bucket_count,
  a11y_consumers.sum,
  a11y_consumers.range[ORDINAL(1)] AS range_low,
  udf.get_key(a11y_consumers.values, 11) AS value_11
FROM
  extracted
WHERE
  a11y_consumers.bucket_count IS NOT NULL
  AND DATE(submission_timestamp) = &quot;2019-08-09&quot;
LIMIT
  10
</code></pre>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/bigquery/querying.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#optimizing-bigquery-queries" id="optimizing-bigquery-queries">Optimizing BigQuery Queries</a></h1>
<p>When you write a query using <a href="https://sql.telemetry.mozilla.org">STMO</a> or the BigQuery console, you can improve performance and reduce costs by learning how data is stored, how databases function, and what you can change about a query to take advantage of the storage structure and the data function.</p>
<p><a href="https://cloud.google.com/bigquery/pricing#on_demand_pricing">Queries are charged by data scanned at $5 per terabyte (TB)</a> so each 200 gigabytes of data scanned will cost $1: on tables with hundreds of TBs of data (like the <a href="cookbooks/bigquery/../../datasets/pings.html#main-ping">main ping table</a> or <a href="cookbooks/bigquery/../../datasets/batch_view/clients_daily/reference.html"><code>clients_daily</code></a>), costs <strong>can add up very quickly</strong>. When trying to reduce the cost, the main thing to do is reduce the amount of data scanned: some of the advice in this article will improve your query's performance but will not scan a smaller amount of data, and thus cost the same.</p>
<h2><a class="header" href="#table-of-contents-6" id="table-of-contents-6">Table of Contents</a></h2>
<ul>
<li><a href="cookbooks/bigquery/optimization.html#tldr-what-to-implement-for-quick-improvements">TL;DR: What to implement for quick improvements</a>
<ul>
<li><a href="cookbooks/bigquery/optimization.html#how-to-improve-both-query-speed-and-cost">How to improve both query speed and cost</a></li>
<li><a href="cookbooks/bigquery/optimization.html#improvements-to-query-speed-only">Improvements to query speed only</a></li>
<li><a href="cookbooks/bigquery/optimization.html#caveats">Caveats</a></li>
</ul>
</li>
<li><a href="cookbooks/bigquery/optimization.html#some-explanations">Some Explanations</a>
<ul>
<li><a href="cookbooks/bigquery/optimization.html#what-are-these-databases">What are these databases?</a>
<ul>
<li><a href="cookbooks/bigquery/optimization.html#key-takeaways">Key takeaways</a></li>
</ul>
</li>
<li><a href="cookbooks/bigquery/optimization.html#how-is-the-data-stored">How is the data stored?</a>
<ul>
<li><a href="cookbooks/bigquery/optimization.html#traditional-row-stores">Traditional Row Stores</a></li>
<li><a href="cookbooks/bigquery/optimization.html#columnar-stores">Columnar Stores</a></li>
<li><a href="cookbooks/bigquery/optimization.html#data-partitions">Data partitions</a></li>
<li><a href="cookbooks/bigquery/optimization.html#data-ordering-clustering">Data Ordering (clustering)</a></li>
<li><a href="cookbooks/bigquery/optimization.html#key-takeaways-1">Key takeaways</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#tldr-what-to-implement-for-quick-improvements" id="tldr-what-to-implement-for-quick-improvements">TL;DR: What to implement for quick improvements</a></h2>
<h3><a class="header" href="#how-to-improve-both-query-speed-and-cost" id="how-to-improve-both-query-speed-and-cost">How to improve both query speed and cost</a></h3>
<ul>
<li>Filter on a partitioned column such as <code>submission_timestamp</code> or <code>submission_date</code> (<em>even</em> if you have a <code>LIMIT</code>: see <a href="cookbooks/bigquery/optimization.html#caveats">optimization caveats</a>)</li>
<li>Use a sample of the data that is based on the <code>sample_id</code> field. This can be helpful for initial development even if you later run the query using the entire
population (without sampling).
<ul>
<li>Tables that include a <code>sample_id</code> field will usually have that as one of the clustering fields and you can efficiently scan random samples of users by specifying <code>WHERE sample_id = 0</code> (1% sample), <code>WHERE sample_id &lt; 10</code> (10% sample), etc. This can be especially helpful with <code>main_summary</code>, <code>clients_daily</code>, and <code>clients_last_seen</code> which are very large tables and are all clustered on <code>sample_id</code>.</li>
</ul>
</li>
<li>Many datasets also cluster on <code>normalized_channel</code>, corresponding to the channel of the product. If you are working with data that has different channels (for example, Firefox desktop), limit your initial query to a channel with a limited population like Nightly (in the case of Firefox desktop, do this by adding <code>WHERE normalized_channel='nightly'</code> to your query)</li>
<li>Select only the columns that you want (<strong>Don't</strong> use <code>SELECT *</code>)
<ul>
<li>If you are experimenting with data or exploring data, use one of the <a href="https://cloud.google.com/bigquery/docs/best-practices-costs#preview-data">data preview options</a> instead of <code>SELECT *</code>.</li>
</ul>
</li>
<li>Reference the data size prediction (&quot;This query will process X bytes&quot;) in STMO and the BigQuery UI to help gauge the efficiency of your queries. You should see this number go down as you limit the range of <code>submission_date</code>s or include fewer fields in your <code>SELECT</code> statement.</li>
</ul>
<h3><a class="header" href="#improvements-to-query-speed-only" id="improvements-to-query-speed-only">Improvements to query speed only</a></h3>
<p>These are still worth doing!</p>
<ul>
<li>Use <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/approximate_aggregate_functions">approximate algorithms</a>: e.g., <code>approx_count_distinct(...)</code> instead of <code>COUNT(DISTINCT ...)</code></li>
<li>If using JOIN, trim the data to-be-joined before the query performs a JOIN. If you reduce data early in the processing cycle, shuffling and other complex operations only execute on the data that you need.
<ul>
<li>Use sub queries with filters or intermediate tables or views as a way of decreasing sides of a join, prior to the join itself.</li>
</ul>
</li>
</ul>
<h3><a class="header" href="#caveats-4" id="caveats-4">Caveats</a></h3>
<ul>
<li>For clustered tables, the data size prediction won't take into account benefits from <code>LIMIT</code>s and <code>WHERE</code> clauses on clustering fields, so you'll need to compare to the actual &quot;Data Scanned&quot; after the query is run.</li>
<li>Applying a <code>LIMIT</code> clause to a <code>SELECT *</code> query might not affect the amount of data read, depending on the table structure.
<ul>
<li>Many of our tables are configured to use <em>clustering</em> in which case a <code>LIMIT</code> clause does effectively limit the amount of data that needs to be scanned. To check whether your <code>LIMIT</code> and <code>WHERE</code> clauses are actually improving performance, you should see a lower value reported for actual &quot;Data Scanned&quot; by a query compared to the prediction (&quot;This query will process X bytes&quot;) in STMO or the BigQuery UI.</li>
</ul>
</li>
<li>Do not treat WITH clauses as prepared statements
<ul>
<li>WITH clauses are used primarily for readability because they are not materialized: if a query appears in more than one WITH clause, it executes in each clause. Do not rely on them to optimize your query!</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#some-explanations" id="some-explanations">Some Explanations</a></h2>
<h3><a class="header" href="#what-are-these-databases" id="what-are-these-databases">What are these databases?</a></h3>
<p>The primary data storage mechanism used at Mozilla, BigQuery, is not a traditional relational database like PostgreSQL or MySQL. Instead it is a <em>distributed SQL engine</em> where data is stored separately from computational resources used to retrieve it.</p>
<p>Multiple machines work together to get the result of your query. Because there is more than one system, you need to pay particular attention to <em>Data Shuffles</em>: when all systems have to send data to all other systems.</p>
<p>For example, consider the following query, which lists the number of rows that are present for each
<code>client_id</code>:</p>
<pre><code class="language-sql">SELECT client_id, COUNT(*)
FROM telemetry.main
GROUP BY client_id
</code></pre>
<p>During the execution of this query, the BigQuery cluster performs the following steps:</p>
<ol>
<li>Each system reads a different piece of the data and parses the <code>client_id</code> for
each row. Internally, it then computes the number of rows seen for each <code>client_id</code>,
<em>but only for the data that it read</em>.</li>
<li>Each system is then assigned a set of <code>client_id</code>s to aggregate. For example, the first
system may be given instructions to get the count of <code>client1</code>. It then has to send a request to every other system for the total seen for <code>client1</code>. It can then aggregate the total.</li>
<li>If every <code>client_id</code> has been aggregated, each system reports to the coordinator
the <code>client_id</code>s that it was responsible for, as well as the count of rows seen by each.
The coordinator is responsible for returning the result of the query to the client,
which in this example is STMO.</li>
</ol>
<p>A similar process occurs on data joins, where different systems are instructed to join on
different keys. In that case, data from both tables needs to be shuffled to every system.</p>
<h4><a class="header" href="#key-takeaways" id="key-takeaways">Key takeaways</a></h4>
<ul>
<li>Use <code>LIMIT</code> for query prototyping to dramatically reduce the volume of data scanned
as well as speeding up processing.</li>
<li>Use approximate algorithms. Then less data needs to be shuffled because
probabilistic data structures can be used instead of the raw data itself.</li>
<li>Specify large tables first in a <code>JOIN</code> operation. In this case, small tables can be sent to
every system to eliminate one data shuffle operation. Note that Spark supports a <code>broadcast</code>
command explicitly.</li>
</ul>
<h3><a class="header" href="#how-is-the-data-stored" id="how-is-the-data-stored">How is the data stored?</a></h3>
<p>The data is stored in columnar format.</p>
<h4><a class="header" href="#traditional-row-stores" id="traditional-row-stores">Traditional Row Stores</a></h4>
<p>Consider a typical CSV file, which represents an example of a row store.</p>
<pre><code class="language-cs">name,age,height
&quot;Ted&quot;,27,6.0
&quot;Emmanuel&quot;,45,5.9
&quot;Cadence&quot;,5,3.5
</code></pre>
<p>When this data is stored to disk, you can read an entire record in consecutive order. For example, if
the first <code>&quot;</code> is stored at block 1 on disk, then a sequential scan from 1 assigns the first row of
data: <code>&quot;ted&quot;,27,6.0</code>. Keep scanning and you get <code>\n&quot;Emm</code>... and so on.</p>
<p>You can use the following query that you can execute very quickly:</p>
<pre><code class="language-sql">SELECT *
FROM people
WHERE name == 'Ted'
</code></pre>
<p>The database can just scan the first row of data. However, the following is more difficult:</p>
<pre><code class="language-sql">SELECT name
FROM people
</code></pre>
<p>Now the database has to read <em>all</em> of the rows and then select the <code>name</code> column, which results in a lot
more overhead.</p>
<h4><a class="header" href="#columnar-stores" id="columnar-stores">Columnar Stores</a></h4>
<p>Columnar turns the data sideways. For example, you can make a columnar version of the above data
and still store it in CSV format:</p>
<pre><code class="language-cs">name,&quot;Ted&quot;,&quot;Emmanuel&quot;,&quot;Cadence&quot;
age,27,45,5
height,6.0,5.9,3.5
</code></pre>
<p>Now let's consider how we can query the data when it's stored this way:</p>
<pre><code class="language-sql">SELECT *
FROM people
WHERE name == &quot;ted&quot;
</code></pre>
<p>In this case, all the data must be read because the
<code>(name, age, height)</code> is not stored together.</p>
<p>Here's another query:</p>
<pre><code class="language-sql">SELECT name
FROM people
</code></pre>
<p>In this case, only the &quot;name&quot; row needs to be read. All the other lines of the
file can be skipped.</p>
<h4><a class="header" href="#data-partitions" id="data-partitions">Data partitions</a></h4>
<p>You can improve performance even further by taking advantage of partitions, grouping together data that shares a value for a column. For example, if everyone in the <code>people</code> table lived in <code>DE</code>, then you can add that to the filename: <code>/country=DE/people.csv</code>.</p>
<p>From there, a query engine would have to know how to read that path and understand that
all of these people share a country. You can query as follows:</p>
<pre><code class="language-sql">SELECT *
FROM people
WHERE country == 'US'
</code></pre>
<p>In this case, the query engine no longer even has to read the file. It could just look at the path and realize that there is nothing of interest.</p>
<p>Tables are usually partitioned based on dates; e.g., <code>submission_date</code> or <code>DATE(submission_timestamp)</code>.</p>
<h4><a class="header" href="#data-ordering-clustering" id="data-ordering-clustering">Data Ordering (clustering)</a></h4>
<p>Another way to improve query performance is to select a subset of data on a field that the data is ordered by. In BigQuery, this is called &quot;clustering&quot;. A clustered field is one which is sorted in the underlying data.</p>
<p>For example, if you wanted to get all of ages greater than age 40 in the table above, you might query like this:</p>
<pre><code class="language-sql">SELECT age FROM people WHERE age &gt; 45
</code></pre>
<p>This would scan all of the <code>age</code> field, starting from <code>27</code>, then <code>45</code>, and ending with <code>5</code>.</p>
<p>However, if instead data was sorted on that field, the table would look like this:</p>
<pre><code class="language-cs">name,&quot;Cadence&quot;,&quot;Ted&quot;,&quot;Emmanuel&quot;
age,5,27,45
height,3.5,6.0,5.9
</code></pre>
<p>Since data is stored on different files, we could ignore any <code>age</code> files that don't have data less than 40. So if Cadence and Ted's ages were in one file, and Emmanuel's in the next, we could skip reading that first file entirely. In that way, we can sometimes drastically reduce the amount of data we're reading.</p>
<h4><a class="header" href="#key-takeaways-1" id="key-takeaways-1">Key takeaways</a></h4>
<ul>
<li>Limit queries to a few columns that you need to reduce the volume of data that must be read</li>
<li>Filter the partitions to reduce the volume of data that you need</li>
<li>Filter on clustered fields</li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/bigquery/optimization.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#custom-analysis-with-spark" id="custom-analysis-with-spark">Custom Analysis with Spark</a></h1>
<ul>
<li><a href="tools/spark.html#introduction">Introduction</a></li>
<li><a href="tools/spark.html#accessing-bigquery-data-from-spark">Accessing BigQuery data from Spark</a>
<ul>
<li><a href="tools/spark.html#using-the-storage-api-connector">Using the Storage API Connector</a></li>
<li><a href="tools/spark.html#using-dataproc">Using Dataproc</a></li>
</ul>
</li>
<li><a href="tools/spark.html#reading-data-from-bigquery-into-spark">Reading data from BigQuery into Spark</a>
<ul>
<li><a href="tools/spark.html#storage-api">Storage API</a></li>
<li><a href="tools/spark.html#query-api">Query API</a></li>
</ul>
</li>
<li><a href="tools/spark.html#persisting-data">Persisting data</a></li>
</ul>
<h2><a class="header" href="#introduction" id="introduction">Introduction</a></h2>
<p><a href="https://spark.apache.org/">Apache Spark</a> is a general-purpose cluster computing system - it allows users to
run general execution graphs. APIs are available in Python, Scala, R, and Java. It is designed to be fast and easy to use.</p>
<p>Here are some useful introductory materials:</p>
<ul>
<li><a href="https://spark.apache.org/docs/latest/programming-guide.html">Spark Programming Guide</a></li>
<li><a href="https://spark.apache.org/docs/latest/sql-programming-guide.html">Spark SQL Programming Guide</a></li>
</ul>
<p>Spark can be used from <a href="https://cloud.google.com/dataproc/">Google's Dataproc</a>, and works with data stored in BigQuery.</p>
<p>There are a number of methods of both reading from and writing to BigQuery using Spark.</p>
<h2><a class="header" href="#accessing-bigquery-data-from-spark" id="accessing-bigquery-data-from-spark">Accessing BigQuery data from Spark</a></h2>
<h3><a class="header" href="#using-the-storage-api-connector" id="using-the-storage-api-connector">Using the Storage API Connector</a></h3>
<blockquote>
<p><strong>⚠</strong> This method requires <a href="tools/../cookbooks/bigquery/access.html#bigquery-access-request">BigQuery Access</a> to be provisioned.</p>
</blockquote>
<p>If you want to use Spark locally (or via an arbitrary GCP instance in the cloud), we recommend the <a href="https://github.com/GoogleCloudPlatform/spark-bigquery-connector">Storage API Connector</a> for accessing BigQuery tables in Spark as it is the most modern and actively developed connector. It works well with the BigQuery client library which is useful if you need to run arbitrary SQL queries and load their results into Spark.</p>
<h3><a class="header" href="#using-dataproc" id="using-dataproc">Using Dataproc</a></h3>
<blockquote>
<p><strong>⚠</strong> This method requires <a href="tools/../cookbooks/bigquery/access.html#bigquery-access-request">BigQuery Access</a> to be provisioned.</p>
</blockquote>
<p>Dataproc is Google's managed Spark cluster service.</p>
<p>You can spin up a Dataproc cluster with Jupyter using the following command. Insert your values for <code>cluster-name</code>, <code>bucket-name</code>, and <code>project-id</code> there. Your notebooks are stored in Cloud Storage under <code>gs://bucket-name/notebooks/jupyter</code>:</p>
<pre><code class="language-bash">gcloud beta dataproc clusters create cluster-name \
    --optional-components=ANACONDA,JUPYTER \
    --image-version=1.4 \
    --enable-component-gateway \
    --properties=^#^spark:spark.jars=gs://spark-lib/bigquery/spark-bigquery-latest.jar \
    --num-workers=3 \
    --max-idle=3h \
    --bucket bucket-name \
    --region=us-west1 \
    --project project-id
</code></pre>
<p>You can retrieve the Jupyter URL with the following command:</p>
<pre><code class="language-bash">gcloud beta dataproc clusters describe cluster-name --region=us-west1 --project project-id | grep Jupyter
</code></pre>
<p>After you've finished your work, it's a good practice to delete your cluster:</p>
<pre><code class="language-bash">gcloud beta dataproc clusters delete cluster-name --region=us-west1 --project project-id --quiet
</code></pre>
<h2><a class="header" href="#reading-data-from-bigquery-into-spark" id="reading-data-from-bigquery-into-spark">Reading data from BigQuery into Spark</a></h2>
<p>There are two main ways to read data from BigQuery into Spark: using either the storage API and the
query API.</p>
<h3><a class="header" href="#storage-api" id="storage-api">Storage API</a></h3>
<p>First, using the Storage API - this bypasses BigQuery's execution engine and
directly reads from the underlying storage.</p>
<p>This is the preferred method of loading data from BigQuery into Spark.</p>
<p>It is more efficient for reading large amounts of data into Spark, and
supports basic column and partitioning filters.</p>
<p>Example of using the Storage API from Databricks:</p>
<pre><code class="language-python">dbutils.library.installPyPI(&quot;google-cloud-bigquery&quot;, &quot;1.16.0&quot;)
dbutils.library.restartPython()

from google.cloud import bigquery


def get_table(view):
    &quot;&quot;&quot;Helper for determining what table underlies a user-facing view, since the Storage API can't read views.&quot;&quot;&quot;
    bq = bigquery.Client()
    view = view.replace(&quot;:&quot;, &quot;.&quot;)
    # partition filter is required, so try a couple options
    for partition_column in [&quot;DATE(submission_timestamp)&quot;, &quot;submission_date&quot;]:
        try:
            job = bq.query(
                f&quot;SELECT * FROM `{view}` WHERE {partition_column} = CURRENT_DATE&quot;,
                bigquery.QueryJobConfig(dry_run=True),
            )
            break
        except Exception:
            continue
    else:
        raise ValueError(&quot;could not determine partition column&quot;)
    assert len(job.referenced_tables) == 1, &quot;View combines multiple tables&quot;
    table = job.referenced_tables[0]
    return f&quot;{table.project}:{table.dataset_id}.{table.table_id}&quot;


# Read one day of main pings and select a subset of columns.
core_pings_single_day = spark.read.format(&quot;bigquery&quot;) \
    .option(&quot;table&quot;, get_table(&quot;moz-fx-data-shared-prod.telemetry.main&quot;)) \
    .load() \
    .where(&quot;submission_timestamp &gt;= to_date('2019-08-25') submission_timestamp &lt; to_date('2019-08-26')&quot;) \
    .select(&quot;client_id&quot;, &quot;experiments&quot;, &quot;normalized_channel&quot;)
</code></pre>
<p>A couple of things are worth noting in the above example.</p>
<ul>
<li><code>get_table</code> is necessary because an actual <em>table</em> name is required to read
from BigQuery here, fully qualified with project name and dataset name.
The Storage API does not support accessing <code>VIEW</code>s, so the convenience names
such as <code>telemetry.core</code> are not available via this API.</li>
<li>You must supply a filter on the table's date partitioning column, in this
case <code>submission_timestamp</code>.
Additionally, you must use the <code>to_date</code> function to make sure that predicate
push-down works properly for these filters.</li>
</ul>
<h3><a class="header" href="#query-api" id="query-api">Query API</a></h3>
<p>If you want to read the results of a query (rather than directly reading
tables), you may also use the Query API.</p>
<p>This pushes the execution of the query into BigQuery's computation engine,
and is typically suitable for reading smaller amounts of data. If you need
to read large amounts of data, prefer the Storage API as described above.</p>
<p>Example:</p>
<pre><code class="language-python">from google.cloud import bigquery

bq = bigquery.Client()

query = &quot;&quot;&quot;
SELECT
  event_string_value,
  count(distinct client_id) AS client_count
FROM
  mozdata.telemetry.events
WHERE
  event_category = 'normandy'
  AND event_method = 'enroll'
  AND submission_date = '2019-06-01'
GROUP BY
  event_string_value
ORDER BY
  client_count DESC
LIMIT 20
&quot;&quot;&quot;

query_job = bq.query(query)

# Wait for query execution, then fetch results as a pandas dataframe.
rows = query_job.result().to_dataframe()
</code></pre>
<h2><a class="header" href="#persisting-data" id="persisting-data">Persisting data</a></h2>
<p>You can save data resulting from your Spark analysis as a <a href="tools/../cookbooks/bigquery/querying.html#writing-query-results-to-a-permanent-table">BigQuery table</a>
or to <a href="tools/../cookbooks/bigquery/querying.html#writing-results-to-gcs-object-store">Google Cloud Storage</a>.</p>
<p>You can also save data to the <a href="https://docs.databricks.com/user-guide/databricks-file-system.html#dbfs">Databricks Filesystem</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/tools/spark.md">Edit this file on GitHub.</a></footer><h2><a class="header" href="#introduction-to-stmo" id="introduction-to-stmo">Introduction to STMO</a></h2>
<p><a href="https://sql.telemetry.mozilla.org"><code>sql.telemetry.mozilla.org</code></a> (STMO) is Mozilla's installation of the <a href="https://redash.io/">Redash</a> data analysis and dashboarding tool. As the name and URL imply, the effective use of this tool requires familiarity with <a href="https://en.wikipedia.org/wiki/SQL">SQL</a>, with which all of the tool's data extraction and analysis are performed.</p>
<p>Access to STMO is limited to Mozilla employees and designated contributors. For more information, see <a href="tools/../concepts/gaining_access.html">gaining access</a>.</p>
<h2><a class="header" href="#stmo-concepts" id="stmo-concepts">STMO Concepts</a></h2>
<p>You need to use the following building blocks from which analyses in STMO are constructed:</p>
<ul>
<li>Queries</li>
<li>Visualizations</li>
<li>Dashboards</li>
</ul>
<h4><a class="header" href="#queries" id="queries">Queries</a></h4>
<p>STMO's basic unit of analysis is a query. A query is a block of SQL code that
extracts and optionally transforms data from a single data source. Queries
can vary widely in complexity. Some queries are simply one liners (e.g., <code>SELECT some_field FROM tablename LIMIT 10</code>) while others span over many pages, almost like small programs.</p>
<p>The raw output from a query is tabular data. Each row represents one set of
return values for the query's output columns. You can run a query manually or specify a refresh schedule that executes automatically after a specified interval of time.</p>
<h4><a class="header" href="#visualizations" id="visualizations">Visualizations</a></h4>
<p>Tabular data is great, but rarely is a grid of values the best way to make
sense of your data. You can associate each query with multiple visualizations. Each visualization can render the extracted data in a format that makes it easy to interpret your data.</p>
<p>There are many visualization types, including charts (line, bar, area, pie, etc.), counters, maps, pivot tables, and more. You can use each visualization type that provides a set of configuration parameters to specify how to map from the raw query output to the desired visualization. Some visualization types make demands of the query output. For example, a map visualization requires each row to include a longitude value and a latitude value.</p>
<h4><a class="header" href="#dashboards-2" id="dashboards-2">Dashboards</a></h4>
<p>A dashboard is a collection of visualizations that is combined into a single visual
presentation for your convenience. A dashboard is decoupled from any particular queries. Although you can include multiple visualizations from a single query in one dashboard, it is not required. Users can add any visualizations that they can access to any dashboards they have created.</p>
<h2><a class="header" href="#data-sources" id="data-sources">Data Sources</a></h2>
<p>SQL provides the ability to extract and manipulate the data, but you won't get
very far without having some familiarity with what data is actually available,
and how that data is structured. Each query in STMO is associated with exactly
one data source, and you have to know ahead of time which data source contains
the information that you need. One of the most commonly used data sources is
called <em>Telemetry (BigQuery)</em>, which contains most of the data that is
obtained from telemetry pings received from Firefox clients. <em>BigQuery</em>
refers to Google's <a href="https://cloud.google.com/bigquery/">BigQuery</a> data warehouse.</p>
<p>Other available data sources include <em>Crash DB</em>, <em>Tiles</em>, <em>Sync Stats</em>, <em>Push</em>,
<em>Test Pilot</em>, and even a <em>Redash metadata</em> which connects to STMO's
own Redash database. If you want to learn more about all available data sets and how
to locate one that is suited for your development environment, see the <a href="tools/../concepts/choosing_a_dataset.html">Choosing a
dataset</a> page. If you have questions regarding data sets or would like to know if specific data is or can be made available
in STMO, see the <a href="tools/../concepts/getting_help.html">getting help</a> topic for more information on how to get in touch.</p>
<h2><a class="header" href="#create-an-example-dashboard" id="create-an-example-dashboard">Create an Example Dashboard</a></h2>
<p>The following topics describe the process of creating a simple dashboard using STMO.</p>
<h4><a class="header" href="#create-a-query" id="create-a-query">Create A Query</a></h4>
<p>Let's start by creating a query. The first query counts the number of client ids that Mozilla receives from each country, for the top N countries. If you click the 'New Query' button that is located at the top on the left-hand side of the site, the query editing page appears:</p>
<p><img src="tools/../assets/STMO_screenshots/new_query.png" alt="New Query Page" title="New Query page" /></p>
<p>For this and most other queries where each client IDs is counted, you want to use
<a href="tools/../datasets/bigquery/clients_last_seen/reference.html"><code>clients_last_seen</code></a>,
which is generated from Firefox telemetry pings.</p>
<ul>
<li>
<p>Search for the table in <code>Telemetry (BigQuery)</code></p>
<p>Click the 'Data Source' drop-down and select <code>Telemetry (BigQuery)</code>. Then, search for the table by typing <code>clients_last_seen</code> in the &quot;Search schema...&quot; field that is above the schema browser interface to the left of the main query Edit field.</p>
</li>
</ul>
<p>You should see a <code>clients_last_seen</code> entry (appearing as <code>telemetry.clients_last_seen</code>). You may also see versioned copies of the tables as <code>telemetry.clients_last_seen_v&lt;VERSION&gt;</code>.</p>
<ul>
<li>
<p>Introspect the available columns</p>
<p>Click <code>telemetry.clients_last_seen</code> in the schema browser to display the columns that are available in the table. The following columns are of interest for this query:</p>
<ul>
<li><code>country</code></li>
<li><code>days_since_seen</code></li>
<li><code>submission_date</code>.</li>
</ul>
</li>
</ul>
<p>If a query extracts all unique country values and the MAU for one day for each one, sorted from highest MAU to lowest MAU, the query then appears as follows:</p>
<pre><code class="language-sql">SELECT
  country,
  COUNTIF(days_since_seen &lt; 28) AS mau
FROM
  telemetry.clients_last_seen
WHERE
  submission_date = '2019-04-01'
GROUP BY
  country
ORDER BY
  mau DESC
</code></pre>
<p>If you type these parameters into the main query Edit field and then click the &quot;Execute&quot;
button, a blue bar then appears below the Edit field. It includes the text &quot;Executing query...&quot;, followed by a timer that indicates how long the query has run. After some period of time, usually less than a minute, the query typically completes its run. A table appears that displays a MAU value for each country. You have just created and run your first STMO query!</p>
<p>Next, click the large &quot;New Query&quot; text located at the top of the page. An Edit field appears so you can rename the query. It is recommended that you assign a unique prefix (such as your name) to the query to make it easy to find your query later. For example, <code>rmiller:Top Countries</code>.</p>
<h4><a class="header" href="#create-a-visualization" id="create-a-visualization">Create A Visualization</a></h4>
<p>After you have created a query, you may want to provide a simple visualization. The table with results from the first query execution now appears under the query Edit field. Another heading titled <code>+NEW VISUALIZATION</code> appears next to the <code>TABLE</code> heading:</p>
<p><img src="tools/../assets/STMO_screenshots/new_visualization.png" alt="New Visualization" title="New Visualization" /></p>
<p>Click the <code>+NEW VISUALIZATION</code> link to display the &quot;Visualization Editor&quot; screen. You can now specify a visualization name (&quot;Top Countries bar chart&quot;), a chart type (&quot;Bar&quot;), an x-axis column (<code>country</code>), and a y-axis column (<code>mau</code>):</p>
<p><img src="tools/../assets/STMO_screenshots/vis_editor.png" alt="Visualization Editor" title="Visualization Editor" /></p>
<p>After the <code>GENERAL</code> settings have been specified, you need to modify additional settings on the <code>X AXIS</code> tab. Click this tab and then change the 'Scale' setting to 'Category', and un-check the 'Sort Values' checkbox to enable the query's sort order to take precedence:</p>
<p><img src="tools/../assets/STMO_screenshots/x_axis_editor.png" alt="Visualization X Axis" title="Visualization X Axis" /></p>
<h4><a class="header" href="#a-note-about-limits" id="a-note-about-limits">A Note About Limits</a></h4>
<p>After you have saved the visualization settings and displayed the query source page, a bar graph appears near the bottom of the page. The graph includes quite a few entries. Rather than being able to view <em>all</em> of the countries, you may want to display only the first 20 entries by adding a <code>LIMIT</code> clause to the end of a query:</p>
<pre><code class="language-sql">SELECT
  country,
  COUNTIF(days_since_seen &lt; 28) AS mau
FROM
  telemetry.clients_last_seen
WHERE
  submission_date = '2019-04-01'
GROUP BY
  country
ORDER BY
  mau DESC
LIMIT
  20
</code></pre>
<p>If you edit the query to add a limit clause and then click 'Execute', a new bar graph only displays the 20 countries that have the highest number of unique clients. In this case, the full result set includes approximately 250 return values: limiting the result count improves readability.</p>
<p>In other cases, however, an unlimited query may return thousands or even millions of rows. Any queries that return millions of rows or lines can not only be unreadable but negatively impact the performance of all other users of STMO. Thus an important warning:</p>
<p><strong>ALL QUERIES SHOULD INCLUDE A &quot;LIMIT&quot; STATEMENT BY DEFAULT!</strong></p>
<p>It is highly recommended that you add a &quot;LIMIT 100&quot; clause to the end of all new queries to prevent a query from returning a large result set that causes user interface (UI) and performance problems. You may learn that the total result set is small enough that setting a limit becomes unnecessary. Specifying an explicit LIMIT helps prevent unnecessary issues.</p>
<h4><a class="header" href="#query-parameters" id="query-parameters">Query Parameters</a></h4>
<p>You can add user arguments to a query, which allows the user to specify parameters without modifying the query itself. Using the query in the previous section as an example, you can replace the <code>LIMIT 20</code> with a country count variable in double curly braces:</p>
<pre><code class="language-sql">SELECT
  country,
  COUNTIF(days_since_seen &lt; 28) AS mau
FROM
  telemetry.clients_last_seen
WHERE
  submission_date = '2019-04-01'
GROUP BY
  country
ORDER BY
  mau DESC
LIMIT
  {{country_count}}
</code></pre>
<p>After you have replaced the hard-coded limit value with <code>{{country_count}}</code>, an input field appears above the bar chart. If you type a numeric value in the input field and click 'Execute', the query will run with the specified limit. Click 'Save' to save the query. The query applies the parameter value that you typed as the default.</p>
<h4><a class="header" href="#create-a-dashboard" id="create-a-dashboard">Create A Dashboard</a></h4>
<p>You can create a dashboard to display visualization by selecting 'New Dashboard' from the 'Dashboards' dropdown that is located at the top left of the page. Choose a name for your dashboard and an empty page should appears. Click the '...' button near the top right of the page to select 'Add Widget'. The following dialog box appears:</p>
<p><img src="tools/../assets/STMO_screenshots/add_widget.png" alt="Add Widget" title="Add Widget" /></p>
<p>Type a unique prefix that has previously been used in a query name in the &quot;Search a query by name&quot; field to locate the query that you have created. You cannot yet execute this query because the query has not yet been published. As soon as you publish a query, you can search on the summary pages. Even though this is only an exercise, the query must be published briefly and then added to the dashboard. You can publish your query by clicking &quot;Publish&quot; on the query source page.</p>
<p>As soon as a query is published, it appears in the search results when you type a unique prefix in the &quot;Search a query by name&quot; field on the &quot;Add Widget&quot; dialog box. When you select a query, you can select a query's visualizations from the &quot;Choose Visualization&quot; dropdown. Select the bar chart that you created and then click &quot;Add to Dashboard&quot;. The dashboard now includes a bar chart. You can now edit the <code>country_count</code> value and click &quot;Refresh&quot; to change the number of countries that are included in the chart.</p>
<h4><a class="header" href="#completing-the-dashboard" id="completing-the-dashboard">Completing the Dashboard</a></h4>
<p>A dashboard with just one graph is often insufficient. Therefore, you may want to create additional queries, each with a very similar bar chart. The text that you need to apply to the queries is listed below. However, you need to create the queries and the visualizations and then link them to the dashboard. The queries are as follows:</p>
<ul>
<li>Top OSes (recommended <code>os_count</code> value == 6)</li>
</ul>
<pre><code class="language-sql">SELECT
  os,
  COUNTIF(days_since_seen &lt; 28) AS mau
FROM
  telemetry.clients_last_seen
WHERE
  submission_date = '2019-04-01'
GROUP BY
  os
ORDER BY
  mau DESC
LIMIT
  {{os_count}}
</code></pre>
<ul>
<li>Channel Counts</li>
</ul>
<pre><code class="language-sql">SELECT
  normalized_channel AS channel,
  COUNTIF(days_since_seen &lt; 28) AS mau
FROM
  telemetry.clients_last_seen
WHERE
  submission_date = '2019-04-01'
GROUP BY
  channel
ORDER BY
  mau DESC
</code></pre>
<ul>
<li>App Version Counts (recommended <code>app_version_count value</code> == 20)</li>
</ul>
<pre><code class="language-sql">SELECT
  app_name,
  app_version,
  COUNTIF(days_since_seen &lt; 28) AS mau
FROM
  telemetry.clients_last_seen
WHERE
  submission_date = '2019-04-01'
GROUP BY
  app_name,
  app_version
ORDER BY
  mau DESC
LIMIT
  {{app_version_count}}
</code></pre>
<p>Creating bar charts for these queries and adding them to the original dashboard
can result in a dashboard that resembles this:</p>
<p><img src="tools/../assets/STMO_screenshots/finished_dashboard.png" alt="Completed Dashboard" title="Completed Dashboard" /></p>
<p>Some final notes to help you create your dashboards:</p>
<ul>
<li>
<p>Remember to publish each of your queries before adding its visualizations to a dashboard.</p>
</li>
<li>
<p>Similarly, it is recommended to un-publish any test queries after you have used
them in a dashboard. This prevents everyone's search results from being contaminated
with your tests and experiments. Any queries that result from an actual
work-related analysis typically remain published. Others users can view these queries and
learn from them.</p>
</li>
<li>
<p>The 'Firefox' label on the 'App Version counts' graph is related to the use
of the 'Group by' visualization setting. It is recommended that you experiment with
the use of 'Group by' in your graphs to learn more about its usage.</p>
</li>
<li>
<p>This tutorial has only touched the surface of the wide variety of
sophisticated visualizations that STMO supports. You can view many
more sophisticated queries and dashboards by browsing and exploring
the work that has been published by others.</p>
</li>
<li>
<p>The <a href="https://redash.io/help/">Redash help center</a> is a useful resource for exploring Redash and all its capabilities.</p>
</li>
</ul>
<h4><a class="header" href="#prototyping-queries" id="prototyping-queries">Prototyping Queries</a></h4>
<p>You may want to start working on a query before data becomes available.
You can do this with most of the data sources by selecting a static test data
set and then work with it, as usual. You can also use this method to explore
how a particular SQL backend behaves.</p>
<p>Note that <code>UNION ALL</code> will retain duplicate rows while <code>UNION</code> will discard them.</p>
<p>Here are a couple of examples:</p>
<p><strong>Simple three-column test dataset</strong></p>
<pre><code class="language-sql">WITH test AS (
 SELECT 1 AS client_id, 'foo' AS v1, 'bar' AS v2 UNION ALL
 SELECT 2 AS client_id, 'bla' AS v1, 'baz' AS v2 UNION ALL
 SELECT 3 AS client_id, 'bla' AS v1, 'bar' AS v2 UNION ALL
 SELECT 2 AS client_id, 'bla' AS v1, 'baz' AS v2 UNION ALL
 SELECT 3 AS client_id, 'bla' AS v1, 'bar' AS v2
)

SELECT * FROM test
</code></pre>
<p><strong>Convert a semantic version string to a sortable array field</strong></p>
<pre><code class="language-sql">WITH foo AS (
 SELECT '1.0.1' AS v UNION
 SELECT '1.10.3' AS v UNION
 SELECT '1.0.2' AS v UNION
 SELECT '1.1' AS v UNION
 -- Doesn't work with these type of strings due to casting
 -- SELECT '1.3a1' AS v UNION
 SELECT '1.2.1' AS v
)

SELECT cast(split(v, '.') AS array&lt;bigint&gt;) FROM foo ORDER BY 1
</code></pre>
<p><strong>How do boolean fields get parsed from strings?</strong></p>
<pre><code class="language-sql">WITH bar AS (
 SELECT '1' AS b UNION
 SELECT '0' UNION
 SELECT 't' UNION
 SELECT 'f' UNION
 SELECT 'true' UNION
 SELECT 'false' UNION
 SELECT 'turkey'
)
SELECT b, try(cast(b AS boolean)) from bar
</code></pre>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/tools/stmo.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#accessing-glean-data" id="accessing-glean-data">Accessing Glean data</a></h1>
<p>This document describes how to access Glean data from an SQL query, such as in <a href="https://sql.telemetry.mozilla.org">Redash</a>.</p>
<h2><a class="header" href="#selecting-the-correct-table" id="selecting-the-correct-table">Selecting the correct table</a></h2>
<p>Each ping type is recorded in its own table, and these tables are named using <code>{application_id}.{ping_type}</code>.
For example, for Fenix, the application id is <code>org.mozilla.fenix</code>, so its <code>metrics</code> pings are available in the table <code>org_mozilla_fenix.metrics</code>.</p>
<h2><a class="header" href="#selecting-columns" id="selecting-columns">Selecting columns</a></h2>
<p>Fields are nested inside BigQuery STRUCTs to organize them into groups, and we can use dot notation to specify individual subfields in a query.
For example, columns containing Glean's built-in client information are in the <code>client_info</code> struct, so accessing its columns involves using a <code>client_info.</code> prefix.</p>
<p>The top-level groups are:</p>
<ul>
<li><code>client_info</code>: <a href="https://mozilla.github.io/glean/book/user/pings/index.html#the-client_info-section">Client information provided by Glean</a>.</li>
<li><code>ping_info</code>: <a href="https://mozilla.github.io/glean/book/user/pings/index.html#the-ping_info-section">Ping information provided by Glean</a>.</li>
<li><code>metrics</code>: <a href="https://mozilla.github.io/glean/book/user/metrics/index.html">Custom metrics</a> defined by the application and its libraries.</li>
<li><code>events</code>: <a href="https://mozilla.github.io/glean/book/user/metrics/event.html">Custom events</a> defined by the application and its libraries.</li>
</ul>
<h3><a class="header" href="#built-in-metrics" id="built-in-metrics">Built-in metrics</a></h3>
<p>Accessing columns from the <code>client_info</code>, and <code>ping_info</code> group is reasonably straightforward.</p>
<p>For example, to access the <code>client_id</code> of a ping, use the column <code>client_info.client_id</code>.</p>
<pre><code class="language-sql">-- Count unique Client IDs observed on a given day
SELECT
  count(distinct client_info.client_id)
FROM
  org_mozilla_fenix.baseline
WHERE
  date(submission_timestamp) = '2019-11-11'
</code></pre>
<h3><a class="header" href="#the-metrics-group" id="the-metrics-group">The <code>metrics</code> group</a></h3>
<p>Custom metrics in the <code>metrics</code> section have two additional levels of indirection in their column name: they are organized by the metric type, and then by their category: <code>metrics.{metric_type}.{category}_{name}</code>.</p>
<p>For example, suppose you had the following <code>boolean</code> metric defined in a <code>metrics.yaml</code> file (abridged for clarity):</p>
<pre><code class="language-yaml">browser:
  is_default:
    type: boolean
    description: &gt;
      Is this application the default browser?
    send_in_pings:
      - metrics
</code></pre>
<p>It would be available in the column <code>metrics.boolean.browser_is_default</code>.</p>
<pre><code class="language-sql">-- Count number of pings where Fenix is the default browser
SELECT
  COUNT(*),
  COUNTIF(metrics.boolean.browser_is_default)
FROM
  -- We give the table an alias so that the table name `metrics` and field name
  -- `metrics` don't conflict.
  org_mozilla_fenix.metrics AS m
WHERE
  date(submission_timestamp) = '2019-11-11'
</code></pre>
<h3><a class="header" href="#the-events-group" id="the-events-group">The <code>events</code> group</a></h3>
<p>Custom events in the <code>events</code> section have a different structure.</p>
<p>Documentation TBD. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1606836">See bug 1606836</a></p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/glean/accessing_glean_data.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#dataset-specific" id="dataset-specific">Dataset Specific</a></h1>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/dataset_specific.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#working-with-normandy-events" id="working-with-normandy-events">Working with Normandy events</a></h1>
<p>A common request is to count the number of users who have
enrolled or unenrolled from a SHIELD experiment.</p>
<p>The <a href="cookbooks/../datasets/batch_view/events/reference.html"><code>events</code> table</a>
includes Normandy enrollment and unenrollment events
for both pref-flip and add-on studies.
Note that the events table is updated nightly.</p>
<p>Normandy events have <code>event_category</code> <code>normandy</code>.
The <code>event_string_value</code> will contain the experiment slug (for pref-flip experiments)
or name (for add-on experiments).</p>
<p>Normandy events are described in detail in the
<a href="https://firefox-source-docs.mozilla.org/toolkit/components/normandy/normandy/data-collection.html#enrollment">Firefox source tree docs</a>.</p>
<p>Note that addon studies do not have branch information in the events table,
since addons, not Normandy, are responsible for branch assignment.
For studies built with the obsolete <a href="https://github.com/mozilla/shield-studies-addon-utils">add-on utilities</a>,
branch assignments are published to the
<a href="cookbooks/../datasets/shield.html#telemetryshield_study">shield_study</a> dataset.</p>
<h2><a class="header" href="#counting-pref-flip-enrollment-events-by-branch" id="counting-pref-flip-enrollment-events-by-branch">Counting pref-flip enrollment events by branch</a></h2>
<p>The <code>event_map_values</code> column of enroll events contains a <code>branch</code> key,
describing which branch the user enrolled in.</p>
<p>To fetch a count of events by branch in BigQuery SQL:</p>
<pre><code class="language-sql">SELECT
  submission_date,
  udf.get_key(event_map_values, 'branch') AS branch,
  COUNT(*) AS n
FROM telemetry.events
WHERE
  event_category = 'normandy'
  AND event_method = 'enroll'
  AND event_string_value = '{{experiment_slug}}'
  AND submission_date &gt;= '{{experiment_start}}'
GROUP BY 1, 2
ORDER BY 1, 2
</code></pre>
<h2><a class="header" href="#counting-pref-flip-unenrollment-events-by-branch" id="counting-pref-flip-unenrollment-events-by-branch">Counting pref-flip unenrollment events by branch</a></h2>
<p>The <code>event_map_values</code> column of unenroll events includes a <code>reason</code> key.
Reasons are described in the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/normandy/normandy/data-collection.html#enrollment">Normandy docs</a>.
Normal unenroll events at the termination of a study will occur for the reason <code>recipe-not-seen</code>.</p>
<p>To fetch a count of events by reason and branch:</p>
<pre><code class="language-sql">SELECT
  submission_date,
  udf.get_key(event_map_values, 'branch') AS branch,
  udf.get_key(event_map_values, 'reason') AS reason,
  COUNT(*) AS n
FROM telemetry.events
WHERE
  event_category = 'normandy'
  AND event_method = 'unenroll'
  AND event_string_value = '{{experiment_slug}}'
  AND submission_date &gt;= '{{experiment_start}}'
GROUP BY 1, 2, 3
ORDER BY 1, 2, 3
</code></pre>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/normandy_events.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#working-with-crash-pings" id="working-with-crash-pings">Working with Crash Pings</a></h1>
<p>You can use the following snippets to start querying <a href="cookbooks/../datasets/pings.html#crash-ping">crash pings</a> with <a href="cookbooks/../tools/stmo.html">STMO</a> and
<a href="cookbooks/../cookbooks/bigquery.html">BigQuery</a>. Using these tools, you can quickly get counts
and other information about crash pings that are submitted day-to-day.</p>
<p>The following example just counts all existing pings for a few days across several dimensions:</p>
<pre><code class="language-sql">SELECT date(submission_timestamp) AS crash_date,
       count(*) AS crash_count
FROM telemetry.crash
WHERE date(submission_timestamp) &gt;= DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY)
GROUP BY crash_date
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/67925/">Link to query in STMO</a>.</p>
<p>Although the total crash counts is not always useful, you may want to restrict
a query to a channel or some other dimensions, and also facet the results. Therefore, you can add a few more fields to the SQL:</p>
<pre><code class="language-sql">SELECT date(submission_timestamp) AS crash_date,
       normalized_os AS os,
       count(*) AS crash_count
FROM telemetry.crash
WHERE date(submission_timestamp) &gt;= DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY)
  AND normalized_channel='nightly'
GROUP BY normalized_os,
         crash_date
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/67927/">Link to query in STMO</a></p>
<p>These are just initial examples. You can query across all the fields in
a telemetry crash ping, which provides useful information about the crashes themselves. You can view a summary of the available fields in the STMO schema browser, referring to <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/data/crash-ping.html">the documentation on the Firefox crash ping</a>
for more information where necessary.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/crash_pings.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#working-with-bit-patterns-in-clients-last-seen" id="working-with-bit-patterns-in-clients-last-seen">Working with Bit Patterns in Clients Last Seen</a></h1>
<p>Monthly active users (MAU) is a windowed metric that requires joining data
per client across 28 days. Calculating this from individual pings or daily
aggregations can be computationally expensive, which motivated creation of the
<a href="cookbooks/../datasets/bigquery/clients_last_seen/reference.html"><code>clients_last_seen</code> dataset</a>
for desktop Firefox and similar datasets for other applications.</p>
<p>A powerful feature of the <code>clients_last_seen</code> methodology is that it doesn't
record specific metrics like MAU and WAU directly, but rather each row stores
a history of the discrete days on which a client was active in the past 28 days.
We could calculate active users in a 10 day or 25 day window just as efficiently
as a 7 day (WAU) or 28 day (MAU) window. But we can also define completely new
metrics based on these usage histories, such as various retention definitions.</p>
<p>The usage history is encoded as a &quot;bit pattern&quot; where the physical
type of the field is a BigQuery INT64, but logically the integer
represents an array of bits, with each 1 indicating a day where the given clients
was active and each 0 indicating a day where the client was inactive. This
article discusses the details of how we represent usage in bit patterns,
how to extract standard usage and retention metrics,
and how to build new metrics from them.</p>
<h2><a class="header" href="#table-of-contents-7" id="table-of-contents-7">Table of Contents</a></h2>
<ul>
<li><a href="cookbooks/clients_last_seen_bits.html#calculating-dau-wau-and-mau">Calculating DAU, WAU, and MAU</a></li>
<li><a href="cookbooks/clients_last_seen_bits.html#calculating-retention">Calculating retention</a></li>
<li><a href="cookbooks/clients_last_seen_bits.html#understanding-bit-patterns">Understanding bit patterns</a>
<ul>
<li><a href="cookbooks/clients_last_seen_bits.html#why-28-bits-instead-of-64">Why 28 bits instead of 64?</a></li>
<li><a href="cookbooks/clients_last_seen_bits.html#forward-looking-windows-and-backward-looking-windows">Forward-looking windows and backward-looking windows</a></li>
</ul>
</li>
<li><a href="cookbooks/clients_last_seen_bits.html#usage-backward-looking-windows">Usage: Backward-looking windows</a>
<ul>
<li><a href="cookbooks/clients_last_seen_bits.html#how-windows-shift-from-day-to-day">How windows shift from day to day</a></li>
</ul>
</li>
<li><a href="cookbooks/clients_last_seen_bits.html#retention-forward-looking-windows">Retention: Forward-looking windows</a>
<ul>
<li><a href="cookbooks/clients_last_seen_bits.html#n-day-retention">N-day Retention</a></li>
<li><a href="cookbooks/clients_last_seen_bits.html#retention-using-activity-date">Retention using activity date</a></li>
</ul>
</li>
<li><a href="cookbooks/clients_last_seen_bits.html#proposing-a-new-bit-pattern-field">Proposing a new bit pattern field</a></li>
<li><a href="cookbooks/clients_last_seen_bits.html#udf-reference">UDF Reference</a>
<ul>
<li><a href="cookbooks/clients_last_seen_bits.html#bits28to_string"><code>bits28.to_string</code></a></li>
<li><a href="cookbooks/clients_last_seen_bits.html#bits28from_string"><code>bits28.from_string</code></a></li>
<li><a href="cookbooks/clients_last_seen_bits.html#bits28to_dates"><code>bits28.to_dates</code></a></li>
<li><a href="cookbooks/clients_last_seen_bits.html#bits28days_since_seen"><code>bits28.days_since_seen</code></a></li>
<li><a href="cookbooks/clients_last_seen_bits.html#bits28range"><code>bits28.range</code></a></li>
<li><a href="cookbooks/clients_last_seen_bits.html#bits28active_in_range"><code>bits28.active_in_range</code></a></li>
<li><a href="cookbooks/clients_last_seen_bits.html#bits28retention"><code>bits28.retention</code></a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#calculating-dau-wau-and-mau" id="calculating-dau-wau-and-mau">Calculating DAU, WAU, and MAU</a></h2>
<p>The simplest application of usage bit patterns is for calculating metrics in
backward-looking windows. This is what we do for our canonical <em>usage</em> measures
DAU, WAU, and MAU.</p>
<p>To decide whether a given client should count towards DAU, WAU, and MAU, we
need to know how recently that client was active. If the client was seen
in the past 28 days, they count toward MAU. If they were active in the past 7
days, the count toward WAU. And only if they were active today do they count
toward DAU.</p>
<p>The user-facing <code>clients_last_seen</code> views present fields like <code>days_since_seen</code>
that extract this information for us from the underlying <code>days_seen_bits</code> field,
allowing us to easily express DAU, WAU, and MAU aggregates like:</p>
<pre><code class="language-sql">SELECT
  submission_date,
  COUNTIF(days_since_seen &lt; 28) AS mau,
  COUNTIF(days_since_seen &lt;  7) AS wau,
  COUNTIF(days_since_seen &lt;  1) AS dau
FROM
  telemetry.clients_last_seen
WHERE
  submission_date = '2020-01-28'
GROUP BY
  submission_date
ORDER BY
  submission_date
</code></pre>
<p>Under the hood, <code>days_since_seen</code> is calculated using the <code>bits28.days_since_seen</code>
UDF which is explained in more detail later in this article.</p>
<p>Note that the desktop <code>clients_last_seen</code> table also has additional bit pattern
fields corresponding to other <a href="cookbooks/../metrics/index.html">usage criteria</a>,
so other variants on MAU can be calculated like:</p>
<pre><code class="language-sql">SELECT
  submission_date,
  COUNTIF(days_since_visited_5_uri &lt; 28) AS visited_5_uri_mau,
  COUNTIF(days_since_opened_dev_tools &lt; 28) AS opened_dev_tools_mau
FROM
  telemetry.clients_last_seen
WHERE
  submission_date = '2020-01-28'
GROUP BY
  submission_date
ORDER BY
  submission_date
</code></pre>
<p>Adding a new usage criterion is possible, but requires some work especially
if a historical backfill is necessary, so
<a href="cookbooks/../concepts/reporting_a_problem.html">file a bug</a> to begin discussions on
new usage criteria.</p>
<p>Also note that non-desktop products also have derived tables following the
<code>clients_last_seen</code> methodology. Per-product MAU could be calculated as:</p>
<pre><code class="language-sql">SELECT
  submission_date,
  app_name,
  COUNTIF(days_since_seen &lt; 28) AS mau,
  COUNTIF(days_since_seen &lt;  7) AS wau,
  COUNTIF(days_since_seen &lt;  1) AS dau
FROM
  telemetry.nondesktop_clients_last_seen
WHERE
  submission_date = '2020-01-28'
GROUP BY
  submission_date, app_name
ORDER BY
  submission_date, app_name
</code></pre>
<h2><a class="header" href="#calculating-retention" id="calculating-retention">Calculating retention</a></h2>
<p>For retention calculations, we use forward-looking windows. This means that
when we report a retention value for 2020-01-01, we're talking about what
portion of clients active on 2020-01-01 are still active some number of days
later.</p>
<p>In particular, let's consider the &quot;1-Week Retention&quot; measure shown in <a href="https://gud.telemetry.mozilla.org/">GUD</a>
which considers a window of 14 days.
For each client active in &quot;week 0&quot; (days 0 through 6), we determine retention by
checking if they were also active in &quot;week 1&quot; (days 7 through 13).</p>
<p>We provide a UDF called <code>bits28.retention</code> that returns a rich STRUCT
type representing activity in various windows, with all the date and bit
offsets handled for you. You pass in a bit pattern and the corresponding <code>submission_date</code>,
and it returns fields like:</p>
<ul>
<li><code>day_13.metric_date</code></li>
<li><code>day_13.active_in_week_0</code></li>
<li><code>day_13.active_in_week_1</code></li>
</ul>
<p>Calculating GUD's retention aggregates and some other variants looks like:</p>
<pre><code class="language-sql">-- The struct returned by bits28.retention is nested.
-- The first level of nesting defines the beginning of our window;
-- in our case, we want day_13 to get retention in a 2-week window.
-- This base query uses day_13.* to make all the day_13 fields available:
--   - metric_date
--   - active_in_week_0
--   - active_in_week_1
--   - ...
--
WITH base AS (
  SELECT
    *,
    mozfun.bits28.retention(
      days_seen_bits, submission_date
      ).day_13.*,
    mozfun.bits28.retention(
      days_created_profile_bits, submission_date
      ).day_13.active_on_metric_date AS is_new_profile
  FROM
    telemetry.clients_last_seen )

SELECT
  metric_date, -- 2020-01-15 (13 days earlier than submission_date)

  -- 1-Week Retention matching GUD.
  SAFE_DIVIDE(
    COUNTIF(active_in_week_0 AND active_in_week_1),
    COUNTIF(active_in_week_0)
  ) AS retention_1_week,

  -- 1-Week New Profile Retention matching GUD.
  SAFE_DIVIDE(
    COUNTIF(is_new_profile AND active_in_week_1),
    COUNTIF(is_new_profile)
  ) AS retention_1_week_new_profile,

  -- NOT AN OFFICIAL METRIC
  -- A more restrictive 1-Week Retention definition that considers only clients
  -- active on day 0 rather than clients active on any day in week 0.
  SAFE_DIVIDE(
    COUNTIF(active_on_metric_date AND active_in_week_1),
    COUNTIF(active_on_metric_date)
  ) AS retention_1_week_active_on_day_0,

  -- NOT AN OFFICIAL METRIC
  -- A more restrictive 0-and-1-Week Retention definition where again the denominator
  -- is restricted to clients active on day 0 and the client must be active both in
  -- week 0 after the metric date and in week 1.
  SAFE_DIVIDE(
    COUNTIF(active_on_metric_date AND active_in_week_0_after_metric_date AND active_in_week_1),
    COUNTIF(active_on_metric_date)
  ) AS retention_0_and_1_week_active_on_day_0,

FROM
  base
WHERE
  submission_date = '2020-01-28'
GROUP BY
  metric_date
</code></pre>
<p>Notice that in each retention definition, the numerator always contains the exact
same condition as the denominator plus additional constraints (<code>AND ...</code>).
It is very easy to accidentally define a retention metric that is logically
inconsistent and can rise above 1.</p>
<p>Under the hood, <code>bits28.retention</code> is using a series of calls to the lower-level
<code>bits28.range</code> function, which is explained later in this article.
<code>bits28.range</code> is very powerful and can be used to construct novel metrics,
but it also introduces many opportunities for off-by-one errors and passing parameters
in incorrect order, so please fully read through this documentation before
attempting to use the lower-level functions.</p>
<h2><a class="header" href="#understanding-bit-patterns" id="understanding-bit-patterns">Understanding bit patterns</a></h2>
<p>If you look at the <code>days_seen_bits</code> field in <code>telemetry.clients_last_seen</code>,
you'll see seemingly random whole numbers, some as large as nine digits.
How should we interpret these?</p>
<p>For very small numbers, it may be possible to interpret the value by eye.
A value of <code>1</code> means the client was active on <code>submission_date</code> only
and wasn't seen in any of the 27 days previous. A value of <code>2</code> means
the client was seen 1 day ago, but not on <code>submission_date</code>. A value of <code>3</code>
means that the client was seen on <code>submission_date</code> <em>and</em> the day previous.</p>
<p>It's much easier to reason about these bit patterns, however, when we view them
as strings of ones and zeros. We've provided a UDF to convert these
values to &quot;bit strings&quot;:</p>
<pre><code class="language-sql">SELECT
  [ mozfun.bits28.to_string(1),
    mozfun.bits28.to_string(2),
    mozfun.bits28.to_string(3) ]

&gt;&gt;&gt; ['0000000000000000000000000001',
     '0000000000000000000000000010',
     '0000000000000000000000000011']
</code></pre>
<p>A value of <code>3</code> is equal to <code>2^1 + 2^0</code> and indeed we see that reading from
right to left in the string of bits, the &quot;lowest&quot; to bits are set (1) while
the rest of the bits are unset (0).</p>
<p>Let's consider a larger value <code>8256</code>. In terms of powers of two, this is equal
to <code>2^13 + 2^6</code> and its string representation should have two <code>1</code> values.
If we label the rightmost bit as &quot;offset 0&quot;, we would expect the set
bits to be at offsets <code>-13</code> and <code>-6</code>:</p>
<pre><code class="language-sql">SELECT mozfun.bits28.to_string(8256)

&gt;&gt;&gt; '0000000000000010000001000000'
</code></pre>
<p>We also provide the inverse of this function to take a string representation
of a bit pattern and return the associated integer:</p>
<pre><code class="language-sql">SELECT mozfun.bits28.from_string('0000000000000010000001000000')

&gt;&gt;&gt; 8256
</code></pre>
<p>Note that the leading zeros are optional for this function:</p>
<pre><code class="language-sql">SELECT mozfun.bits28.from_string('10000001000000')

&gt;&gt;&gt; 8256
</code></pre>
<p>Finally, we can translate this into an array of concrete dates by passing
a value for the date that corresponds to the rightmost bit:</p>
<pre><code class="language-sql">SELECT mozfun.bits28.to_dates(8256, '2020-01-28')

&gt;&gt;&gt; ['2020-01-15', '2020-01-22']
</code></pre>
<h3><a class="header" href="#why-28-bits-instead-of-64" id="why-28-bits-instead-of-64">Why 28 bits instead of 64?</a></h3>
<p>BigQuery has only one integer type (<code>INT64</code>) which is composed of 64 bits,
so we could technically store 64 days of history per bit pattern. Limiting
to 28 bits is a practical concern related to storage costs and reprocessing concerns.</p>
<p>Consider a client that is only active on a single day and then never shows up again.
A client that becomes inactive will eventually fall outside the 28-day usage
window and will thus not have a row in following days of <code>clients_last_seen</code>
and we no longer duplicate that client's data for those days.</p>
<p>Also, tables following the <code>clients_last_seen</code> methodology have to be populated
incrementally. For each new day of data, we have to reference the previous
day's rows in <code>clients_last_seen</code>, take the trailing 27 bits of each pattern
and appending a 0 or 1 to represent whether the client was active in the new
day.</p>
<p>Now, suppose we find that there was a processing error 10 days ago that affected
a table upstream of <code>clients_last_seen</code>. If we fix that error, we now have to
recompute each day of <code>clients_last_seen</code> from 10 days ago all the way to the
present.</p>
<p>We chose to encode only 28 days of history in these bit patterns as a compromise
that gives just enough history to calculate MAU on a rolling basis but otherwise
limits the amount of data that needs to be reprocessed to recover from errors.</p>
<h3><a class="header" href="#forward-looking-windows-and-backward-looking-windows" id="forward-looking-windows-and-backward-looking-windows">Forward-looking windows and backward-looking windows</a></h3>
<p>Bit patterns can be used to calculate a variety of windowed metrics,
but there are a number of ways we can choose to interpret a bit pattern
and define windows within it. In particular, we can choose to read a bit
pattern from right to left, looking <em>backwards</em> from the most recent day.
Or we can choose to read a bit pattern from left to right, looking
<em>forwards</em> from some chosen reference point.</p>
<p>MAU and WAU use <em>backward-looking windows</em> where the value for 2020-01-28
depends on activity from 2020-01-01 to 2020-01-28. You can calculate DAU,
WAU, and MAU for 2020-01-28 as soon data for that target date has been
processed. In other words, the <em>metric date</em> for usage metrics corresponds
directly to the <code>submission_date</code> in <code>clients_last_seen</code>.</p>
<p>Retention metrics, however, use <em>forward-looking windows</em> where the value for
2020-01-28 depends on activity happening on and <em>after</em> that date.
Be prepared for this to twist your mind a bit. What we call &quot;1-Week Retention&quot;
depends on activity in a 2-week window. If we want to calculate a 1-week
retention value for 2020-01-01, we need to consider activity from 2020-01-01
through 2020-01-14, so we cannot know the retention value for a given day
until we've fully processed data 13 days later. In other words, the <em>metric date</em>
for 1-week retention is always 13 days earlier than the <code>submission_date</code>
on which it can be calculated.</p>
<p>Using forward-looking windows initially seems awkward, but it turns out
to be necessary for consistency in how we define various retention metrics.
Consider if we wanted to compare 1-week, 2-week, and 3-week retention metrics on a
single plot. If we use forward-looking windows, then the point labeled 2020-01-01
describes the same set of users for all three metrics and how their activity
differs over time. If we use backwards-looking windows, then each of these three
metrics is considering a separate population of users.
We'll discuss this in more detail later.</p>
<h2><a class="header" href="#usage-backward-looking-windows" id="usage-backward-looking-windows">Usage: Backward-looking windows</a></h2>
<p>The simplest application of usage bit patterns is for calculating metrics in
backward-looking windows. This is what we do for our canonical <em>usage</em> measures
DAU, WAU, and MAU.</p>
<p>Let's imagine a single row from <code>clients_last_seen</code> with <code>submission_date = 2020-01-28</code>.
The <code>days_seen_bits</code> field records usage for a single client over a period of 28 days
<em>ending</em> on the given <code>submission_date</code>. We will call this metric date &quot;day 0&quot;
(2020-01-28 in this case) and count backwards to &quot;day -27&quot; (2020-01-01).</p>
<p>Let's suppose this client was only active on two days in the past month:
2020-01-22 (day -6) and 2020-01-15 (day -13). That client's <code>days_seen_bits</code>
value would show up as <code>8256</code>, which as we saw in the previous section can
be represented as bit string <code>'0000000000000010000001000000'</code>.</p>
<p>Let's dive more deeply into that bit string representation:</p>
<pre><code>    0  0  0  0  0  0  0  0  0  0  0  0  0  0  1  0  0  0  0  0  0  1  0  0  0  0  0  0
    ──────────────────────────────────────────────────────────────────────────────────
    │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │
    │-26  │-24  │-22  │-20  │-18  │-16  │-14  │-12  │-10  │ -8  │ -6  │ -4  │ -2  │  0
  -27   -25   -23   -21   -19   -17   -15   -13   -11    -9    -7    -5    -3    -1

  └──────────────────────────────────────────────────────────────────────────────────┘
  MAU                                                             └──────────────────┘
                                                                   WAU             └─┘
                                                                                   DAU
</code></pre>
<p>In this picture, we've annotated the windows for DAU (day 0 only),
WAU (days 0 through -6) and MAU (days 0 through -27). This particular client
won't count toward DAU for 2020-01-28, but the client does count towards both
WAU and MAU.</p>
<p>Note that for each of these usage metrics, the <em>number</em> of active days
does not matter but only the <em>recency</em> of the latest active day.
We provide a special function to tell us how many days have elapsed since
the most recent activity encoded in a bit pattern:</p>
<pre><code class="language-sql">SELECT mozfun.bits28.days_since_seen(mozfun.bits28.from_string('10000001000000'))

&gt;&gt;&gt; 6
</code></pre>
<p>Indeed, this is so commonly used that we build this function into user-facing
views, so that instead of referencing <code>days_seen_bits</code> with a UDF, you can
instead reference a field called <code>days_since_seen</code>. Counting MAU, WAU, and
DAU generally looks like:</p>
<pre><code class="language-sql">SELECT
  COUNTIF(days_since_seen &lt; 28) AS mau,
  COUNTIF(days_since_seen &lt;  7) AS wau,
  COUNTIF(days_since_seen &lt;  1) AS dau
FROM
  telemetry.clients_last_seen
</code></pre>
<h3><a class="header" href="#how-windows-shift-from-day-to-day" id="how-windows-shift-from-day-to-day">How windows shift from day to day</a></h3>
<p>Note that this particular client is about to fall outside the WAU window.
If the client doesn't send a main ping on 2020-01-29, the new <code>days_seen_bits</code>
pattern for this client will look like:</p>
<pre><code>    0  0  0  0  0  0  0  0  0  0  0  0  0  1  0  0  0  0  0  0  1  0  0  0  0  0  0  0
    ──────────────────────────────────────────────────────────────────────────────────
    │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │  │
    │-26  │-24  │-22  │-20  │-18  │-16  │-14  │-12  │-10  │ -8  │ -6  │ -4  │ -2  │  0
  -27   -25   -23   -21   -19   -17   -15   -13   -11    -9    -7    -5    -3    -1

  └──────────────────────────────────────────────────────────────────────────────────┘
  MAU                                                             └──────────────────┘
                                                                   WAU             └─┘
                                                                                   DAU
</code></pre>
<p>The entire pattern has simply shifted one offset to the left, with the leading zero
falling off (since it's now outside the 28-day range) and a trailing zero added
on the right (this would be a <code>1</code> instead if the user had been active on 2020-01-29).</p>
<p>The <code>days_since_seen</code> value is now <code>7</code>, which is outside the WAU window:</p>
<pre><code class="language-sql">SELECT mozfun.bits28.days_since_seen(mozfun.bits28.from_string('100000010000000'))

&gt;&gt;&gt; 7
</code></pre>
<h2><a class="header" href="#retention-forward-looking-windows" id="retention-forward-looking-windows">Retention: Forward-looking windows</a></h2>
<p>For retention calculations, we use forward-looking windows. This means that
when we report a retention value for 2020-01-01, we're talking about what
portion of clients active on 2020-01-01 are still active some number of days
later.</p>
<p>When we were talking about backward-looking windows, our metric date or &quot;day 0&quot;
was always the most recent day, corresponding to the rightmost bit.
When we define forward-looking windows, however, we always choose a metric date
some time in the past. How we number the individual bits depends on what
metric date we choose.</p>
<p>For example, in <a href="https://gud.telemetry.mozilla.org/">GUD</a>, we show a &quot;1-Week Retention&quot; which considers a window of 14 days.
For each client active in &quot;week 0&quot; (days 0 through 6), we determine retention by
checking if they were also active in &quot;week 1&quot; (days 7 through 13).</p>
<p>To make &quot;1-Week Retention&quot; more concrete,
let's consider the same client as before, grabbing the <code>days_seen_bits</code> value from
<code>clients_last_seen</code> with <code>submission_date = 2020-01-28</code>. We count back 13 bits in
the array to define our new &quot;day 0&quot; which corresponds to 2020-01-15:</p>
<pre><code>    0  0  0  0  0  0  0  0  0  0  0  0  0  0  1  0  0  0  0  0  0  1  0  0  0  0  0  0
    ──────────────────────────────────────────────────────────────────────────────────
                                              │  │  │  │  │  │  │  │  │  │  │  │  │  │
                                              │  1  │  3  │  5  │  7  │  9  │ 11  │ 13
                                              0     2     4     6     8    10    12
                                            └────────────────────┘
                                                    Week 0       └───────────────────┘
                                                                        Week 1
</code></pre>
<p>This client has a bit set in both week 0 and in week 1, so logically this client
can be considered retained; they should be counted in both the denominator and
in the numerator for the &quot;1-Week Retention&quot; value on 2020-01-15.</p>
<p>Also note there is some nuance in retention metrics as to what counts as &quot;week 0&quot;
because sometimes we want to measure a user as active in week 0 excluding the metric
date (&quot;day 0&quot;) itself. The client shown above would not count as &quot;active in week 0 after metric date&quot;:</p>
<pre><code>    0  0  0  0  0  0  0  0  0  0  0  0  0  0  1  0  0  0  0  0  0  1  0  0  0  0  0  0
    ──────────────────────────────────────────────────────────────────────────────────
                                              │  │  │  │  │  │  │  │  │  │  │  │  │  │
                                              │  1  │  3  │  5  │  7  │  9  │ 11  │ 13
                                              0     2     4     6     8    10    12
                             Metric Date    └──┘
                Week 0 After Metric Date       └─────────────────┘
                                  Week 0    └────────────────────┘
</code></pre>
<p>But how can we extract this usage per week information in a query?</p>
<p>Extracting the bits for a specific week can be achieved via UDF:</p>
<pre><code class="language-sql">SELECT
  -- Signature is bits28.range(offset_to_day_0, start_bit, number_of_bits)
  mozfun.bits28.range(days_seen_bits, -13 + 0, 7) AS week_0_bits,
  mozfun.bits28.range(days_seen_bits, -13 + 7, 7) AS week_1_bits
FROM
  telemetry.clients_last_seen
</code></pre>
<p>And then we can turn those bits into a boolean indicating whether the client
was active or not as:</p>
<pre><code class="language-sql">SELECT
  BIT_COUNT(mozfun.bits28.range(days_seen_bits, -13 + 0, 7)) &gt; 0 AS active_in_week_0
  BIT_COUNT(mozfun.bits28.range(days_seen_bits, -13 + 7, 7)) &gt; 0 AS active_in_week_1
FROM
  telemetry.clients_last_seen
</code></pre>
<p>This pattern of checking whether any bit is set within a given range is common
enough that we provide short-hand for it in <code>bits28.active_in_range</code>.
The above query can be made a bit cleaner as:</p>
<pre><code class="language-sql">SELECT
  mozfun.bits28.active_in_range(days_seen_bits, -13 + 0, 7) AS active_in_week_0
  mozfun.bits28.active_in_range(days_seen_bits, -13 + 7, 7) AS active_in_week_1
FROM
  telemetry.clients_last_seen
</code></pre>
<p>In terms of the higher-level <code>bits28.retention</code> function discussed earlier,
here's how this client looks:</p>
<pre><code class="language-sql">SELECT
  submission_date,
  mozfun.bits28.retention(days_seen_bits, submission_date).day_13.*
FROM
  telemetry.clients_last_seen

/*
                   submission_date = 2020-01-28
                       metric_date = 2020-01-15
                   active_on_day_0 = true
                  active_in_week_0 = true
active_in_week_0_after_metric_date = false
                  active_in_week_1 = true
*/
</code></pre>
<h3><a class="header" href="#n-day-retention" id="n-day-retention">N-day Retention</a></h3>
<p><em>Not an official metric. This section is intended solely as an example of advanced usage.</em></p>
<p>As an example of a novel metric that can be defined using the low-level
bit pattern UDFs, let's define <code>n</code>-day retention as the fraction of clients active on a given day
who are also active within the next <code>n</code> days. For example, 3-day retention would
have a denominator of all clients active on day 0 and a numerator of all clients
active on day 0 who were also active on days 1 or 2.</p>
<p>To calculate <code>n</code>-day retention, we need to use the lower-level <code>bits28.range</code>
function:</p>
<pre><code class="language-sql">DECLARE n INT64;
SET n = 3;

WITH base AS (
  SELECT
    *,
    mozfun.bits28.active_in_range(days_seen_bits, -n + 1, 1) AS seen_on_day_0,
    mozfun.bits28.active_in_range(days_seen_bits, -n + 2, n - 1) AS seen_after_day_0
  FROM
    telemetry.clients_last_seen )
SELECT
  DATE_SUB(submission_date, INTERVAL n DAY) AS metric_date,

  -- NOT AN OFFICIAL METRIC
  SAFE_DIVIDE(
    COUNTIF(seen_on_day_0 AND seen_after_day_0),
    COUNTIF(seen_on_day_0)
  ) AS retention_n_day
FROM
  base
WHERE
  submission_date = '2020-01-28'
GROUP BY
  metric_date
</code></pre>
<h3><a class="header" href="#retention-using-activity-date" id="retention-using-activity-date">Retention using activity date</a></h3>
<p><em>Not an official metric. This section is intended solely as an example of advanced usage.</em></p>
<p>GUD's canonical retention definitions are all based on ping submission dates rather
than logical activity dates taken from client-provided timestamps, but there is
interest in using client timestamps particularly for <code>n</code>-day retention calculations
for mobile products.</p>
<p>Let's consider Firefox Preview which sends telemetry via Glean. The
<code>org_mozilla_fenix.baseline_clients_last_seen</code> table includes two bit patterns
that encode client timestamps: <code>days_seen_session_start_bits</code> and
<code>days_seen_session_end_bits</code>. This table is still populated once per day based
on pings received over the previous day, but some of those pings will reflect
sessions that started on previous days. This introduces some new complexity
into retention calculations because we'll always be underestimating client
counts if we have our retention window end on <code>submission_date</code>.</p>
<p>When using activity date, it may be desirable to build in a few days of buffer
to ensure we are considering late-arriving pings. For example, if we wanted
to calculate 3-day retention but allow 2 days of cushion for late-arriving
pings, we would need to use an offset of 5 days from <code>submission_date</code>:</p>
<pre><code class="language-sql">DECLARE n, cushion_days, offset_to_day_0 INT64;
SET n = 3;
SET cushion_days = 2;
SET offset_to_day_0 = 1 - n - cushion_days;

WITH base AS (
  SELECT
    *,
    mozfun.bits28.active_in_range(days_seen_session_start_bits, offset_to_day_0, 1) AS seen_on_day_0,
    mozfun.bits28.active_in_range(days_seen_session_start_bits, offset_to_day_0 + 1, n - 1) AS seen_after_day_0
  FROM
    org_mozilla_fenix.baseline_clients_last_seen )
SELECT
  DATE_SUB(submission_date, INTERVAL offset_to_day_0 DAY) AS metric_date,

  -- NOT AN OFFICIAL METRIC
  SAFE_DIVIDE(
    COUNTIF(seen_on_day_0 AND seen_after_day_0),
    COUNTIF(seen_on_day_0)
  ) AS retention_n_day
FROM
  base
WHERE
  submission_date = '2020-01-28'
GROUP BY
  metric_date
</code></pre>
<h2><a class="header" href="#proposing-a-new-bit-pattern-field" id="proposing-a-new-bit-pattern-field">Proposing a new bit pattern field</a></h2>
<p>The operational logic required to produce a <code>clients_last_seen</code> table makes
it unwieldy for backfilling, so it has historically been difficult for data
scientists to experiment with new bit pattern fields on their own.</p>
<p>Below are sample queries for producing a small <code>clients_last_seen</code>-like table
that presents an experimental usage definition. In this approach, the temporary
analysis table we create actually stores a client's whole usage history as a
BYTES field, and then we rely on view logic to present this as per-day windows.
Much of the logic is boilerplate; the sections that would need to change for
your specific new field are marked between <code>-- BEGIN</code> and <code>-- END</code> comments.</p>
<p>The first example defines a new feature based on a measure that already exists
in <code>clients_daily</code>. It takes only a few minutes to run:</p>
<pre><code class="language-sql">DECLARE start_date DATE DEFAULT '2020-05-01';
DECLARE end_date DATE DEFAULT '2020-11-01';
DECLARE target_sample_id INT64 DEFAULT 0;

CREATE TEMP FUNCTION process_bits(bits BYTES) AS (
  STRUCT(
    bits,

    -- An INT64 version of the bits, compatible with bits28 functions
    CAST(CONCAT('0x', TO_HEX(RIGHT(bits, 4))) AS INT64) &lt;&lt; 36 &gt;&gt; 36 AS bits28,

    -- An INT64 version of the bits with 64 days of history
    CAST(CONCAT('0x', TO_HEX(RIGHT(bits, 4))) AS INT64) AS bits64,

    -- A field like days_since_seen from clients_last_seen.
    udf.bits_to_days_since_seen(bits) AS days_since_active,

    -- Days since first active, analogous to first_seen_date in clients_first_seen
    udf.bits_to_days_since_first_seen(bits) AS days_since_first_active
  )
);

CREATE OR REPLACE TABLE
  analysis.&lt;myuser&gt;_newfeature
PARTITION BY submission_date
CLUSTER BY sample_id
AS
WITH
alltime AS (
  SELECT
    sample_id,
    client_id,
    -- BEGIN
    -- Here we produce bit pattern fields based on the daily aggregates from the
    -- previous step;
    udf.bits_from_offsets(
      ARRAY_AGG(
        IF(active_hours_sum &gt;= 1,DATE_DIFF(end_date, submission_date, DAY), NULL)
        IGNORE NULLS
      )
    ) AS days_active_bits,
    -- END
  FROM
    telemetry.clients_daily
  WHERE
    sample_id = target_sample_id
    AND submission_date BETWEEN start_date AND end_date
  GROUP BY
    sample_id,
    client_id
)
SELECT
  end_date - i AS submission_date,
  sample_id,
  client_id,
  process_bits(days_active_bits &gt;&gt; i) AS days_active
FROM
  alltime
-- The cross join parses each input row into one row per day since the client
-- was first seen, emulating the format of the existing clients_last_seen table.
CROSS JOIN
  UNNEST(GENERATE_ARRAY(0, DATE_DIFF(end_date, start_date, DAY))) AS i
WHERE
  (days_active_bits &gt;&gt; i) IS NOT NULL
</code></pre>
<p>And here is a more complex example that references <code>main_v4</code> directly:</p>
<details>
<summary>Calculating a bit pattern field directly from `main_v4`</summary>
<pre><code class="language-sql">DECLARE start_date DATE DEFAULT '2020-05-01';
DECLARE end_date DATE DEFAULT '2020-11-01';
DECLARE target_sample_id INT64 DEFAULT 0;

CREATE TEMP FUNCTION process_bits(bits BYTES) AS (
  STRUCT(
    bits,

    -- An INT64 version of the bits, compatible with bits28 functions
    CAST(CONCAT('0x', TO_HEX(RIGHT(bits, 4))) AS INT64) &lt;&lt; 36 &gt;&gt; 36 AS bits28,

    -- An INT64 version of the bits with 64 days of history
    CAST(CONCAT('0x', TO_HEX(RIGHT(bits, 4))) AS INT64) AS bits64,

    -- A field like days_since_seen from clients_last_seen.
    udf.bits_to_days_since_seen(bits) AS days_since_active,

    -- Days since first active, analogous to first_seen_date in clients_first_seen
    udf.bits_to_days_since_first_seen(bits) AS days_since_first_active
  )
);

CREATE OR REPLACE TABLE
  analysis.&lt;myuser&gt;_newfeature
PARTITION BY submission_date
CLUSTER BY sample_id
AS
WITH
-- If clients_daily already contains a measure that suffices as the basis for
-- our new usage definition, we can skip this daily subquery and calculate
-- alltime based on clients_daily rather than `main`.
daily AS (
  SELECT
    DATE(submission_timestamp) AS submission_date,
    sample_id,
    client_id,
    -- BEGIN
    -- Here is where we put clients_daily-like aggregations that will be
    -- used as the basis for bit patterns in the next step.
    SUM(payload.processes.parent.scalars.browser_engagement_active_ticks)
      AS active_ticks_sum,
    -- END
  FROM
    telemetry.main
  WHERE
    sample_id = target_sample_id
    AND DATE(submission_timestamp) BETWEEN start_date AND end_date
  GROUP BY
    submission_date,
    sample_id,
    client_id ),
alltime AS (
  SELECT
    sample_id,
    client_id,
    -- BEGIN
    -- Here we produce bit pattern fields based on the daily aggregates from the
    -- previous step;
    udf.bits_from_offsets(
      ARRAY_AGG(
        IF(active_ticks_sum &gt;= 8,DATE_DIFF(end_date, submission_date, DAY), NULL)
        IGNORE NULLS
      )
    ) AS days_active_bits,
    -- END
  FROM
    daily
  GROUP BY
    sample_id,
    client_id
)
SELECT
  end_date - i AS submission_date,
  sample_id,
  client_id,
  process_bits(days_active_bits &gt;&gt; i) AS days_active
FROM
  alltime
-- The cross join parses each input row into one row per day since the client
-- was first seen, emulating the format of the existing clients_last_seen table.
CROSS JOIN
  UNNEST(GENERATE_ARRAY(0, DATE_DIFF(end_date, start_date, DAY))) AS i
WHERE
  (days_active_bits &gt;&gt; i) IS NOT NULL
</code></pre>
</details>
<p>This script takes about 10 minutes to run over 6 months of data as written above
and about an hour to run over the whole history of <code>main_v4</code> (starting at 2018-11-01).
A query over the whole history of <code>clients_daily</code> (starting in early 2016)
can run in about an hour as well.
The resultant table can be used on its own
or joined with <code>clients_daily</code> to pull per-client dimensions.</p>
<p>If the definition proves useful in validation, your variant of the query
above can serve as a good starting point for Data Engineering to integrate the new
definition into <code>clients_last_seen</code> (and <code>clients_daily</code> if necessary).
Once a new definition is integrated into the model, we can backfill two months of
data fairly easily. Complete backfills are expensive in terms of computational cost
and engineering effort, so cannot happen more than approximately quarterly.</p>
<h2><a class="header" href="#udf-reference" id="udf-reference">UDF Reference</a></h2>
<h3><a class="header" href="#bits28to_string" id="bits28to_string"><code>bits28.to_string</code></a></h3>
<p>Convert an INT64 field into a 28 character string representing the individual bits.</p>
<pre><code class="language-sql">bits28.to_string(bits INT64)

SELECT mozfun.bits28.to_string(18)
&gt;&gt; 0000000000000000000000010010
</code></pre>
<h3><a class="header" href="#bits28from_string" id="bits28from_string"><code>bits28.from_string</code></a></h3>
<p>Convert a string representing individual bits into an INT64.</p>
<pre><code class="language-sql">bits28.from_string(bits STRING)

SELECT mozfun.bits28.from_string('10010')
&gt;&gt; 18
</code></pre>
<h3><a class="header" href="#bits28to_dates" id="bits28to_dates"><code>bits28.to_dates</code></a></h3>
<p>Convert a bit pattern into an array of the dates is represents.</p>
<pre><code class="language-sql">bits28.to_dates(bits INT64, end_date DATE)

SELECT mozfun.bits28.to_dates(18, '2020-01-28')
&gt;&gt; ['2020-01-24', '2020-01-27']
</code></pre>
<h3><a class="header" href="#bits28days_since_seen" id="bits28days_since_seen"><code>bits28.days_since_seen</code></a></h3>
<p>Return the position of the rightmost set bit in an INT64 bit pattern.</p>
<pre><code class="language-sql">bits28.days_since_seen(bits INT64)

SELECT bits28.days_since_seen(18)
&gt;&gt; 1
</code></pre>
<h3><a class="header" href="#bits28range" id="bits28range"><code>bits28.range</code></a></h3>
<p>Return an INT64 representing a range of bits from a source bit pattern.</p>
<p>The <code>start_offset</code> must be zero or a negative number indicating an offset from
the rightmost bit in the pattern.</p>
<p><code>n_bits</code> is the number of bits to consider, counting right from the bit at <code>start_offset</code>.</p>
<pre><code class="language-sql">bits28.range(bits INT64, offset INT64, n_bits INT64)

SELECT mozfun.bits28.to_string(mozfun.bits28.range(18, 5, 6))
&gt;&gt; '010010'
SELECT mozfun.bits28.to_string(mozfun.bits28.range(18, 5, 2))
&gt;&gt; '01'
SELECT mozfun.bits28.to_string(mozfun.bits28.range(18, 5 - 2, 4))
&gt;&gt; '0010'
</code></pre>
<h3><a class="header" href="#bits28active_in_range" id="bits28active_in_range"><code>bits28.active_in_range</code></a></h3>
<p>Return a boolean indicating if any bits are set in the specified range of a bit pattern.</p>
<p>The <code>start_offset</code> must be zero or a negative number indicating an offset from
the rightmost bit in the pattern.</p>
<p><code>n_bits</code> is the number of bits to consider, counting right from the bit at <code>start_offset</code>.</p>
<pre><code class="language-sql">bits28.active_in_range(bits INT64, start_offset INT64, n_bits INT64)
</code></pre>
<h3><a class="header" href="#bits28retention" id="bits28retention"><code>bits28.retention</code></a></h3>
<p>Return a nested struct providing numerator and denominator fields for
the standard 1-Week, 2-Week, and 3-Week retention definitions.</p>
<pre><code class="language-sql">bits28.retention(bits INT64, submission_date DATE)
</code></pre>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/clients_last_seen_bits.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#visualizing-percentiles-of-a-main-ping-exponential-histogram" id="visualizing-percentiles-of-a-main-ping-exponential-histogram">Visualizing Percentiles of a Main Ping Exponential Histogram</a></h1>
<p><a href="https://glam.telemetry.mozilla.org/">GLAM</a> is great if you want to check out the behaviour of a histogram over a large population across a curated set of dimensions, but what if you have a follow-up question that doesn't fit into its UI model? This tutorial will go into the guts of how to reproduce a GLAM-like view using <code>sql.telemetry.mozilla.org</code> (STMO), along with some suggestions on how to dig deeper.</p>
<p>This tutorial tries to build up an understanding and intuition of how things work on a low-level before it gets to its main act of reproducing GLAM. If you don't care about the details, you can probably skip the earlier sections in this document.</p>
<p>Assumptions:</p>
<ul>
<li>You have some idea of what a histogram is (if not, the <a href="https://en.wikipedia.org/wiki/Histogram">Wikipedia article</a> is a great place to start), have at least skimmed over <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/collection/histograms.html">the Firefox documentation on histograms</a></li>
<li>You have read <a href="cookbooks/../tools/stmo.html">the introduction to STMO</a>.</li>
<li>You understand the <a href="cookbooks/../datasets/main_ping_tables.html">main ping tables</a> (<code>telemetry.main_1pct</code> and <code>telemetry.main_nightly</code>).</li>
</ul>
<h2><a class="header" href="#table-of-contents-8" id="table-of-contents-8">Table of Contents</a></h2>
<ul>
<li><a href="cookbooks/main_ping_exponential_histograms.html#setting-the-stage-tab-spinners-duration">Setting the stage: tab spinners duration</a></li>
<li><a href="cookbooks/main_ping_exponential_histograms.html#getting-client-level-data">Getting client-level data</a></li>
<li><a href="cookbooks/main_ping_exponential_histograms.html#getting-percentiles-from-a-set-of-histograms">Getting percentiles from a set of histograms</a></li>
<li><a href="cookbooks/main_ping_exponential_histograms.html#viewing-change-of-percentiles-over-time">Viewing change of percentiles over time</a></li>
<li><a href="cookbooks/main_ping_exponential_histograms.html#percentiles-from-client-normalized-histograms">Percentiles from client-normalized histograms</a></li>
<li><a href="cookbooks/main_ping_exponential_histograms.html#slicing-along-arbitrary-dimensions">Slicing along arbitrary dimensions</a></li>
</ul>
<h2><a class="header" href="#setting-the-stage-tab-spinners-duration" id="setting-the-stage-tab-spinners-duration">Setting the stage: tab spinners duration</a></h2>
<p>For the purposes of this tutorial, let's look at a typical performance-oriented histogram: <a href="https://probes.telemetry.mozilla.org/?view=detail&amp;probeId=histogram%2FFX_TAB_SWITCH_SPINNER_VISIBLE_MS"><code>FX_TAB_SWITCH_SPINNER_VISIBLE_MS</code></a> which we use to count the number of times a tab spinner appears after a switch tab operation in Firefox, along with the duration of
its appearance in milliseconds (ms). This is an unwanted operation (especially if it's long), as it makes the browser appear unresponsive and <a href="https://support.mozilla.org/en-US/questions/1198062">confuses / disturbs users</a>.</p>
<p><code>FX_TAB_SWITCH_SPINNER_VISIBLE_MS</code> is what's called an <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/collection/histograms.html#exponential">exponential histogram</a>: it represents an exponentially increasing distribution of values in each of its &quot;buckets&quot;. It's probably easier to visualize this using the histogram viewer than describe:</p>
<p><img src="cookbooks/../assets/exponential_histograms_tutorial/example_visualization_of_an_exponential_histogram.png" alt="example visualization of an exponential histogram" />
<a href="https://telemetry.mozilla.org/histogram-simulator/#low=1&amp;high=1000&amp;n_buckets=20&amp;kind=exponential&amp;generate=normal">link</a></p>
<p>This visualization above shows how a <a href="https://en.wikipedia.org/wiki/Normal_distribution">normal distribution</a> would map into the buckets: you'll see that it skews towards the end: the point of the exponential histogram is to be sensitive to lower values (which one would assume would be more frequent, so long as the tab spinner doesn't come up too frequently!). Each &quot;tick&quot; represents the range of a bucket (in milliseconds): so we have a bucket representing values between <code>1ms</code> and <code>2ms</code>, <code>2ms</code> and <code>3ms</code>, and so on. You'll note that this distribution caps out at 1000: any values greater than or equal to this will wind up in this bucket but we won't know their value with any precision. For tracking values higher than this, a separate histogram (<a href="https://probes.telemetry.mozilla.org/?view=detail&amp;probeId=histogram%2FFX_TAB_SWITCH_SPINNER_VISIBLE_LONG_MS"><code>FX_TAB_SWITCH_SPINNER_VISIBLE_LONG_MS</code></a>) was created.</p>
<h2><a class="header" href="#getting-client-level-data" id="getting-client-level-data">Getting client-level data</a></h2>
<p>Before we move on, let's do up a quick example of getting some client-level data using an SQL query, hopefully building up some intuition on how this stuff works on a low-level. From there, we can build up to aggregating it in interesting ways.</p>
<p>As of this writing, each main ping histogram is encoded as a JSON string inside the <code>telemetry.main</code> table inside BigQuery.</p>
<pre><code class="language-sql">SELECT
  payload.histograms.FX_TAB_SWITCH_SPINNER_VISIBLE_MS AS histogram_json,
FROM
  telemetry.main_nightly -- Use telemetry.main_1pct for a 1% sample across channels
WHERE
  sample_id = 42
  AND normalized_channel = 'nightly' -- Only technically necessary if using telemetry.main or telemetry.main_1pct (see above)
  AND DATE(submission_timestamp) = '2020-04-20'
  AND payload.histograms.FX_TAB_SWITCH_SPINNER_VISIBLE_MS IS NOT NULL
LIMIT
  3
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/71333/source">link</a></p>
<p>Running this query on STMO, we get the following output:</p>
<table><thead><tr><th><code>histogram_json</code></th></tr></thead><tbody>
<tr><td><code>{&quot;bucket_count&quot;:20,&quot;histogram_type&quot;:0,&quot;sum&quot;:118,&quot;range&quot;:[1,1000],&quot;values&quot;:{&quot;80&quot;:0,&quot;115&quot;:1,&quot;165&quot;:0}}</code></td></tr>
<tr><td><code>{&quot;bucket_count&quot;:20,&quot;histogram_type&quot;:0,&quot;sum&quot;:19145,&quot;range&quot;:[1,1000],&quot;values&quot;:{&quot;237&quot;:0,&quot;340&quot;:1,&quot;1000&quot;:1}}</code></td></tr>
<tr><td><code>{&quot;bucket_count&quot;:20,&quot;histogram_type&quot;:0,&quot;sum&quot;:1996,&quot;range&quot;:[1,1000],&quot;values&quot;:{&quot;698&quot;:0,&quot;1000&quot;:1}}</code></td></tr>
</tbody></table>
<p>In this representation, <code>bucket_count</code> and <code>range</code> represent the number of buckets and the range of possible values. <code>histogram_type</code> is an enumerated value that describes whether the histogram has linear, exponential, or categorical buckets; the values are <a href="https://searchfox.org/mozilla-central/rev/0c682c4f01442c3de0fa6cd286e9cadc8276b45f/toolkit/components/telemetry/core/nsITelemetry.idl#18-32">defined in the Firefox source code</a>.
<code>values</code> represents the number of instances in each of the buckets while <code>sum</code> represents the sum total of all histogram values recorded.
Note how the first column has one bucket with no elements in it (the &quot;165&quot; bucket), this is because Firefox adds a zero-count bucket on the left and right edges of the data (unless that would be one of the extremes and that bucket already has a count in it, as is the case for the &quot;1000&quot; bucket in the last two examples).</p>
<p>In general, it is best not to rely on this representation of the histogram in production code (it is quite likely to change in the future). Instead, use the <a href="https://mozilla.github.io/bigquery-etl/mozfun/hist/#extract"><code>mozfun.hist.extract</code></a> user-defined-function (UDF) and extract out the fields you need: for example, to just get the <code>sum</code> for all the histograms above, you could modify the query above to something like:</p>
<pre><code class="language-sql">WITH intermediate AS (
  SELECT
    mozfun.hist.extract(payload.histograms.FX_TAB_SWITCH_SPINNER_VISIBLE_MS) AS histogram,
  FROM
    telemetry.main_nightly -- Use telemetry.main_1pct for a 1% sample across channels
  WHERE
    sample_id = 42
    AND normalized_channel = 'nightly' -- Only technically necessary if using telemetry.main or telemetry.main_1pct (see above)
    AND DATE(submission_timestamp) = '2020-04-20'
    AND payload.histograms.FX_TAB_SWITCH_SPINNER_VISIBLE_MS IS NOT NULL
  LIMIT
    3
)
SELECT
  histogram.sum,
  histogram.bucket_count
FROM
  intermediate;
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/71408/source">link</a></p>
<p>Which yields:</p>
<table><thead><tr><th><code>sum</code></th><th><code>bucket_count</code></th></tr></thead><tbody>
<tr><td>118</td><td>20</td></tr>
<tr><td>19145</td><td>20</td></tr>
<tr><td>1996</td><td>20</td></tr>
</tbody></table>
<p>Note that these are the same values in the JSON histogram above.</p>
<p>Obviously this by itself is not particularly useful or meaningful - generally we are interested in <em>aggregate</em> behaviour across a larger set of clients. Let's look at how we might get that.</p>
<h2><a class="header" href="#getting-percentiles-from-a-set-of-histograms" id="getting-percentiles-from-a-set-of-histograms">Getting percentiles from a set of histograms</a></h2>
<p>Often, questions around histograms are framed as &quot;what's the 99th percentile?&quot; -- that is, what is the <em>maximum</em> value that 99% of users experience: this helps give perspective on data which may have a number of weird outliers (a.k.a the <em>Bill Gates walks into a bar and everyone inside becomes a millionaire</em> effect). Let's take an initial stab of grabbing some percentiles of the data we were looking at earlier using the <a href="https://mozilla.github.io/bigquery-etl/mozfun/hist/#merge"><code>mozfun.hist.merge</code></a> and <a href="https://mozilla.github.io/bigquery-etl/mozfun/hist/#percentiles"><code>mozfun.hist.percentiles</code></a> UDFs:</p>
<pre><code class="language-sql">WITH merged_histogram AS (
  SELECT
    mozfun.hist.merge(
      ARRAY_AGG(mozfun.hist.extract(payload.histograms.FX_TAB_SWITCH_SPINNER_VISIBLE_MS))
    ) AS spinner_visible_ms,
  FROM
    telemetry.main_nightly -- Use telemetry.main_1pct for a 1% sample across channels
  WHERE
    normalized_channel = 'nightly' -- Only technically necessary if using telemetry.main or telemetry.main_1pct (see above)
    AND normalized_os = 'Windows'
    AND DATE(submission_timestamp) = '2020-04-20'
),
percentiles AS (
  SELECT
    mozfun.hist.percentiles(spinner_visible_ms, [.05, .25, .5, .75, .95]) AS percentile_nested
  FROM
    merged_histogram
)
SELECT
  percentile,
  value
FROM
  percentiles
CROSS JOIN
  UNNEST(percentiles.percentile_nested);
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/71410/source">link</a></p>
<p>Which gives us this set of results:</p>
<table><thead><tr><th>Percentile</th><th>Value</th></tr></thead><tbody>
<tr><td>0.05</td><td>13</td></tr>
<tr><td>0.25</td><td>56</td></tr>
<tr><td>0.50</td><td>165</td></tr>
<tr><td>0.75</td><td>698</td></tr>
<tr><td>0.95</td><td>1,000</td></tr>
</tbody></table>
<p>So we see for this set of results that 95th percentile is <code>1000ms</code>, the 75th percentile is <code>698ms</code>, and so on.</p>
<p>There's a bit of intermediate-to-advanced SQL in the above query, due to the fact that the <code>mozfun.hist.percentiles</code> UDF returns an <em>array</em> of results in a column (rather than a full-blown table) -- we wrangle the results into something we can handle using the <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax#unnest"><code>UNNEST</code></a> operator combined with a cross-join at the end. If you don't immediately understand this, don't worry: it's just an implementation detail.</p>
<h2><a class="header" href="#viewing-change-of-percentiles-over-time" id="viewing-change-of-percentiles-over-time">Viewing change of percentiles over time</a></h2>
<p>Knowing the approximate distribution of results on a given day is sort of interesting, but probably not what we really want: what we're usually interested in is the evolution of results <em>over time</em>. In particular, segmenting by <code>build_id</code> (a date-like structure in the <code>main</code> ping representing when Firefox was built) is a useful technique, as it allows us to see if changes to Firefox itself may have caused the distribution to change.</p>
<p>We can do this simply by <em>grouping by</em> the build id field, and then merging the histograms corresponding to each:</p>
<pre><code class="language-sql">WITH per_build_day AS (
  SELECT
    PARSE_DATETIME(&quot;%Y%m%d%H%M%S&quot;, application.build_id) AS build_id,
    KEY,
    SUM(value) AS value,
  FROM
    telemetry.main_nightly -- Use telemetry.main_1pct for a 1% sample across channels,
    UNNEST(
      mozfun.hist.extract(
        payload.histograms.FX_TAB_SWITCH_SPINNER_VISIBLE_MS
      ).VALUES
    )
  WHERE
    normalized_channel = 'nightly' -- Only technically necessary if using telemetry.main or telemetry.main_1pct (see above)
    AND normalized_os = 'Windows'
    AND application.build_id &gt; FORMAT_DATE(&quot;%Y%m%d&quot;, DATE_SUB(CURRENT_DATE, INTERVAL 2 WEEK))
    AND application.build_id &lt;= FORMAT_DATE(&quot;%Y%m%d&quot;, CURRENT_DATE)
    AND DATE(submission_timestamp) &gt;= DATE_SUB(CURRENT_DATE, INTERVAL 2 WEEK)
    AND DATE(submission_timestamp) &lt;= CURRENT_DATE
  GROUP BY
    KEY,
    build_id
),
per_build_day_as_struct AS (
  SELECT
    build_id,
    STRUCT(ARRAY_AGG(STRUCT(KEY, value)) AS VALUES) AS spinner_visible_ms
  FROM
    per_build_day
  GROUP BY
    build_id
)
SELECT
  build_id,
  percentile,
  value
FROM
  per_build_day_as_struct
CROSS JOIN
  UNNEST(
    mozfun.hist.percentiles(
      spinner_visible_ms,
      [.05, .25, .5, .75, .95]
    )
  )
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/71472/source">link</a></p>
<p>As an implementation note, observe that we don't use <code>histogram_merge</code> here as we do above: doing so would require using <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#array_agg"><code>ARRAY_AGG</code></a> which can break down when processing large amounts of data. Instead we create an intermediate result (the <code>per_build_day</code> <code>WITH</code> statement) and then reprocess it into a structured representation. If you're curious what the version using <code>histogram_merge</code> would look like, see <a href="https://sql.telemetry.mozilla.org/queries/71413/source">this example</a>.</p>
<p>In any case, rendering the data this query returns, we get a chart like this:</p>
<p><img src="cookbooks/../assets/exponential_histograms_tutorial/example_visualization_of_histogram_percentiles.png" alt="example visualization of histogram percentiles" /></p>
<p>You'll note that the 75th and the 95th percentiles are often the same. Which is to say: in 25% of cases, the value was somewhere between <code>698ms</code> and <code>1000ms</code>. Does this mean that 25% of the time people are seeing a <em>very</em> long-running tab spinner? <em>No!</em> It actually points to a flaw in our methodology, which GLAM was explicitly designed to address. For the last part our tutorial, let's look into how it does it, and how to reproduce its approach.</p>
<h2><a class="header" href="#percentiles-from-client-normalized-histograms" id="percentiles-from-client-normalized-histograms">Percentiles from client-normalized histograms</a></h2>
<p>The example above basically created one <em>giant</em> histogram and then gathered the percentiles out of each one. But histograms are not created equal! At the extreme end of things for the tab spinner, consider a user on an extremely old computer with various kinds of malware installed, constantly interacting with complex and slow web sites. Such a condition is going to trigger the tab spinner frequently, and for long periods. But it is not representative of the overall population, and probably shouldn't <em>overtly</em> influence our decision-making process.</p>
<p>A solution used by GLAM is to give each client &quot;one vote&quot;: that is, the aggregate histogram for a client over a day must sum up to one. Even in the extreme case where all tab spinner measurements fall between <code>658ms</code> and <code>1000ms</code> (the range of the highest bucket), the <em>maximum</em> number for that bucket is just &quot;1&quot;.</p>
<p>We can reproduce this approach by using the <a href="https://mozilla.github.io/bigquery-etl/mozfun/hist/#normalize"><code>mozfun.hist.normalize</code></a> UDF, which explicitly takes a set of histograms and makes sure that the values for each one sum up to exactly one:</p>
<pre><code class="language-sql">WITH per_build_client_day AS (
  SELECT
    PARSE_DATETIME(&quot;%Y%m%d%H%M%S&quot;, application.build_id) AS build_id,
    client_id,
    mozfun.hist.normalize(
      mozfun.hist.merge(
        ARRAY_AGG(
          mozfun.hist.extract(
            payload.histograms.FX_TAB_SWITCH_SPINNER_VISIBLE_MS
          )
        )
      )
    ) AS tab_switch_visible_ms
  FROM
    telemetry.main_nightly -- Use telemetry.main_1pct for a 1% sample across channels
  WHERE
    normalized_channel = 'nightly' -- Only technically necessary if using telemetry.main or telemetry.main_1pct (see above)
    AND normalized_os = 'Windows'
    AND application.build_id &gt; FORMAT_DATE(&quot;%Y%m%d&quot;, DATE_SUB(CURRENT_DATE, INTERVAL 14 DAY))
    AND application.build_id &lt;= FORMAT_DATE(&quot;%Y%m%d&quot;, CURRENT_DATE)
    AND DATE(submission_timestamp) &gt;= DATE_SUB(CURRENT_DATE, INTERVAL 14 DAY)
    AND DATE(submission_timestamp) &lt;= CURRENT_DATE
  GROUP BY
    build_id,
    client_id
),
merged_histograms AS (
  SELECT
    build_id,
    KEY,
    SUM(value) AS value,
  FROM
    per_build_client_day,
    UNNEST(per_build_client_day.tab_switch_visible_ms.VALUES)
  GROUP BY
    KEY,
    build_id
),
as_struct AS (
  SELECT
    build_id,
    STRUCT(ARRAY_AGG(STRUCT(KEY, value)) AS VALUES) AS spinner_visible_long_ms
  FROM
    merged_histograms
  GROUP BY
    build_id
),
percentiles AS (
  SELECT
    build_id,
    mozfun.hist.percentiles(
      spinner_visible_long_ms,
      [.05, .25, .5, .75, .95]
    ) AS percentile_nested
  FROM
    as_struct
)
SELECT
  build_id,
  percentile,
  value
FROM
  percentiles
CROSS JOIN
  UNNEST(percentiles.percentile_nested);
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/71489/source">link</a></p>
<p>You'll notice this query groups by <code>client_id</code> in addition to <code>build_id</code> before <code>mozfun.hist.normalize</code>. Grouping by <code>client_id</code> gives each user equal representation and prevents &quot;power users&quot; from skewing the result.</p>
<p>In any case, the result of this query is this graph:</p>
<p><img src="cookbooks/../assets/exponential_histograms_tutorial/example_visualization_of_normalized_histogram_percentiles.png" alt="example visualization of normalized histogram percentiles" /></p>
<p>Things are looking much better! The 95th percentile is still capped out at 1000, but the other percentiles are much lower.</p>
<h2><a class="header" href="#slicing-along-arbitrary-dimensions" id="slicing-along-arbitrary-dimensions">Slicing along arbitrary dimensions</a></h2>
<p>OK, so we've reproduced GLAM, but that isn't particularly exciting in and of itself: if you just wanted to see a GLAM-like view of things, GLAM by itself is going to do a better job. The power of writing SQL comes when you want to see how things look on an arbitrary set of dimensions. Let's look at an arbitrary question: what do the tab spinner percentiles look like for Windows 7? These are likely to be much older machines, so we'd expect things to look worse. But how much?</p>
<p>We can filter our query to <em>just</em> that group of users by adding a <code>AND normalized_os_version=&quot;6.1&quot;</code> clause to our query above:</p>
<pre><code class="language-sql">WITH per_build_client_day AS (
  SELECT
    PARSE_DATETIME(&quot;%Y%m%d%H%M%S&quot;, application.build_id) AS build_id,
    client_id,
    mozfun.hist.normalize(
      mozfun.hist.merge(
        ARRAY_AGG(
          mozfun.hist.extract(
            payload.histograms.FX_TAB_SWITCH_SPINNER_VISIBLE_MS
          )
        )
      )
    ) AS tab_switch_visible_ms
  FROM
    telemetry.main_nightly -- Use telemetry.main_1pct for a 1% sample across channels
  WHERE
    normalized_channel = 'nightly' -- Only technically necessary if using telemetry.main or telemetry.main_1pct (see above)
    AND normalized_os = 'Windows'
    AND normalized_os_version = &quot;6.1&quot;
    AND application.build_id &gt; FORMAT_DATE(&quot;%Y%m%d&quot;, DATE_SUB(CURRENT_DATE, INTERVAL 14 DAY))
    AND application.build_id &lt;= FORMAT_DATE(&quot;%Y%m%d&quot;, CURRENT_DATE)
    AND DATE(submission_timestamp) &gt;= DATE_SUB(CURRENT_DATE, INTERVAL 14 DAY)
    AND DATE(submission_timestamp) &lt;= CURRENT_DATE
  GROUP BY
    build_id,
    client_id
),
merged_histograms AS (
  SELECT
    build_id,
    KEY,
    SUM(value) AS value,
  FROM
    per_build_client_day,
    UNNEST(per_build_client_day.tab_switch_visible_ms.VALUES)
  GROUP BY
    KEY,
    build_id
),
as_struct AS (
  SELECT
    build_id,
    STRUCT(ARRAY_AGG(STRUCT(KEY, value)) AS VALUES) AS spinner_visible_long_ms
  FROM
    merged_histograms
  GROUP BY
    build_id
),
percentiles AS (
  SELECT
    build_id,
    mozfun.hist.percentiles(
      spinner_visible_long_ms,
      [.05, .25, .5, .75, .95]
    ) AS percentile_nested
  FROM
    as_struct
)
SELECT
  build_id,
  percentile,
  value
FROM
  percentiles
CROSS JOIN
  UNNEST(percentiles.percentile_nested);
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/71437/source">link</a></p>
<p>If we do this, we see this chart:</p>
<p><img src="cookbooks/../assets/exponential_histograms_tutorial/example_visualization_of_normalized_histogram_percentiles_for_Windows_7.png" alt="example visualization of normalized histogram percentiles for Windows 7" /></p>
<p>As you can see, both the 75th and 100th percentile are now in the highest bucket, and the 50th percentile is much higher as well. From this we can intuit that the user experience for these users is likely considerably worse, which is exactly what we would have expected.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/main_ping_exponential_histograms.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#real-time" id="real-time">Real-time</a></h1>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/realtime.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#see-my-pings" id="see-my-pings">See My Pings</a></h1>
<p>So you want to see what you're sending the telemetry pipeline, huh?
Well follow these steps and we'll have you perusing your own data in no time.</p>
<h2><a class="header" href="#steps-to-viewing-your-pings" id="steps-to-viewing-your-pings">Steps to Viewing Your Pings</a></h2>
<ol>
<li>
<p>Get your <code>clientId</code> from whatever product you're using. For desktop, it's available in <code>about:telemetry</code>.</p>
</li>
<li>
<p>Go <a href="https://sql.telemetry.mozilla.org">STMO</a>.</p>
</li>
<li>
<p>Enter the following query:</p>
</li>
</ol>
<pre><code class="language-sql">SELECT
  submission_timestamp,
  document_id
FROM
  telemetry_live.main_v4 -- or crash, event, core, etc
WHERE
  submission_timestamp &gt; TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 HOUR)
  AND client_id = '&lt;your_client_id&gt;'
ORDER BY
  submission_timestamp DESC
LIMIT 10
</code></pre>
<p>This will show you the timestamp and document id of the ten most recent
<code>main</code> pings you've sent in the last 3 hours.
You may include any other fields here that might be of interest to you.</p>
<p>The tables in the <code>telemetry_live</code> dataset have only a few minutes of
latency, so you can query those tables for pings from your <code>client_id</code>
with minimal additional waiting.</p>
<p>One thing to note is that BigQuery has its own query cache, so if you
run the same query several times in a row, it may fetch results from
its cache. You can make any change at all (such as adding a comment)
to force the query to run again and fetch updated results.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/view_pings_cep.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#metrics-1" id="metrics-1">Metrics</a></h1>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/metrics.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#daily-and-monthly-active-users-dau-and-mau" id="daily-and-monthly-active-users-dau-and-mau">Daily and Monthly Active Users (DAU and MAU)</a></h1>
<p>For the purposes of DAU, a desktop profile is considered active if it sends any main ping.
See the next section for analogous definitions on top of mobile products.</p>
<ul>
<li>Dates are defined by <code>submission_date</code>.</li>
</ul>
<p><strong>DAU</strong> is the number of clients sending a main ping on a given day.</p>
<p><strong>MAU</strong> is the number of unique clients who have been a DAU on any day in the last <strong>28 days</strong>. In other words, any client that contributes to DAU in the last 28 days would also contribute to MAU for that day. Note that this is not simply the sum of DAU over 28 days, since any particular client could be active on many days.</p>
<p><strong>WAU</strong> is the number of unique clients who have been a DAU on any day in the last <strong>7 days</strong>. Caveats above for MAU also apply to WAU.</p>
<p>To make the time boundaries more clear, let's consider a particular date 2019-01-28. The DAU number assigned to 2019-01-28 should consider all main pings received during 2019-01-28 UTC. We cannot observe the full data until 2019-01-28 closes (and in practice we need to wait a bit longer since we are usually referencing derived datasets like <code>clients_daily</code> that are updated once per day over several hours following midnight UTC), so the earliest we can calculate this value is on 2019-01-29. If plotted as a time series, this value should always be plotted at the point labeled 2019-01-28. Likewise, MAU for 2019-01-28 should consider a 28 day range that includes main pings received on 2019-01-28 and back to beginning of day UTC 2019-01-01. Again, the earliest we can calculate the value is on 2019-01-29.</p>
<p>For quick analysis, using <a href="cookbooks/../datasets/bigquery/exact_mau/reference.html"><code>firefox_desktop_exact_mau28_by_dimensions</code></a> is recommended. Below is an example query for getting MAU, WAU, and DAU for 2018 using <code>firefox_desktop_exact_mau28_by_dimensions</code>.</p>
<pre><code class="language-sql">SELECT
  submission_date,
  SUM(mau) AS mau,
  SUM(wau) AS wau,
  SUM(dau) AS dau
FROM
  telemetry.firefox_desktop_exact_mau28_by_dimensions
WHERE
  submission_date_s3 &gt;= '2018-01-01'
  AND submission_date_s3 &lt; '2019-01-01'
GROUP BY
  submission_date
ORDER BY
  submission_date
</code></pre>
<p>For analysis of dimensions not available in <code>firefox_desktop_exact_mau28_by_dimensions</code>, using <a href="cookbooks/../datasets/bigquery/clients_last_seen/reference.html"><code>clients_last_seen</code></a> is recommended. Below is an example query for getting MAU, WAU, and DAU by <code>app_version</code> for 2018 using <code>clients_last_seen</code>.</p>
<pre><code class="language-sql">SELECT
  submission_date,
  app_version,
  -- days_since_seen is always between 0 and 28, so MAU could also be
  -- calculated with COUNT(days_since_seen) or COUNT(*)
  COUNTIF(days_since_seen &lt; 28) AS mau,
  COUNTIF(days_since_seen &lt; 7) AS wau,
  -- days_since_* values are always between 0 and 28 or null, so DAU could also
  -- be calculated with COUNTIF(days_since_seen = 0)
  COUNTIF(days_since_seen &lt; 1) AS dau
FROM
  telemetry.clients_last_seen
WHERE
  submission_date_s3 &gt;= '2018-01-01'
  AND submission_date_s3 &lt; '2019-01-01'
GROUP BY
  submission_date,
  app_version
ORDER BY
  submission_date,
  app_version
</code></pre>
<p>For analysis of only DAU, using <a href="cookbooks/../datasets/batch_view/clients_daily/reference.html"><code>clients_daily</code></a> is more efficient than <code>clients_last_seen</code>. Getting MAU and WAU from <code>clients_daily</code> is not recommended. Below is an example query for getting DAU for 2018 using <code>clients_daily</code>.</p>
<pre><code class="language-sql">SELECT
  submission_date_s3,
  COUNT(*) AS dau
FROM
  telemetry.clients_daily
WHERE
  -- In BigQuery use yyyy-MM-DD, e.g. '2018-01-01'
  submission_date_s3 &gt;= '20180101'
  AND submission_date_s3 &lt; '20190101'
GROUP BY
  submission_date_s3
ORDER BY
  submission_date_s3
</code></pre>
<p><a href="cookbooks/../datasets/batch_view/main_summary/reference.html"><code>main_summary</code></a> can also be used for getting DAU. Below is an example query using a 1% sample over March 2018 using <code>main_summary</code>:</p>
<pre><code class="language-sql">SELECT
  submission_date_s3,
  -- Note: this does not include NULL client_id in count where above methods do
  COUNT(DISTINCT client_id) * 100 AS DAU
FROM
  telemetry.main_summary
WHERE
  sample_id = '51'
  -- In BigQuery use yyyy-MM-DD, e.g. '2018-03-01'
  AND submission_date_s3 &gt;= '20180301'
  AND submission_date_s3 &lt; '20180401'
GROUP BY
  submission_date_s3
ORDER BY
  submission_date_s3
</code></pre>
<h2><a class="header" href="#mobile-products" id="mobile-products">Mobile Products</a></h2>
<p>The concept of usage is slightly different for mobile products compared to desktop Firefox.
A single session of desktop Firefox is likely to span multiple days and we
rely on a process to send a <code>main</code> ping once per day.
A single session of a mobile application is likely to last only a few minutes and
we have generally instrumented mobile applications to send a separate ping for
each user session:</p>
<ul>
<li><code>core</code> pings are the canonical measure for usage on legacy mobile products</li>
<li><code>baseline</code> pings are the canonical measure for usage on mobile products using the Glean SDK</li>
</ul>
<p>A given client is considered &quot;active&quot; for a given mobile product on a given day if we receive at
least one of the above pings. Otherwise, the definitions of DAU and MAU for individual mobile products
are identical to those used for desktop Firefox. See
<a href="cookbooks/../concepts/choosing_a_dataset_mobile.html">Choosing a Mobile Product Dataset</a> for an
overview of the various products and which telemetry approach they use.</p>
<p><em>Note:</em> As of March 2020, Fenix (the new Firefox for Android) is using a modified definition of usage
which considers a user active for a given day based on any <code>baseline</code> or <code>metrics</code> ping
being submitted on the given day. There is an open
<a href="https://docs.google.com/document/d/1Ym4eZyS0WngEP6WdwJjmCoxtoQbJSvORxlQwZpuSV2I/edit?ts=5e6f894f#">proposal for Fenix KPI reporting changes</a> to move Fenix reporting to consider only <code>baseline</code> pings.</p>
<p>For quick analysis, use <code>firefox_nondesktop_exact_mau28_by_dimensions</code>.
This table has a <code>product</code> dimension used to differentiate different applications.
Not that exact naming for applications and channels is sometimes different
between analyses. You can retrieve the list of names used here via query:</p>
<pre><code class="language-sql">SELECT
  product
FROM
  `moz-fx-data-shared-prod.telemetry.firefox_nondesktop_exact_mau28_by_dimensions`
WHERE
  submission_date = '2020-03-01'
GROUP BY
  product
ORDER BY
  COUNT(*) DESC

/*
Returns:
  Fennec Android
  Fennec iOS
  Focus Android
  Fenix
  FirefoxForFireTV
  Firefox Lite
  Focus iOS
  Lockwise Android
  FirefoxConnect
*/
</code></pre>
<h3><a class="header" href="#combining-metrics-from-multiple-products" id="combining-metrics-from-multiple-products">Combining metrics from multiple products</a></h3>
<p>Telemetry is collected independently for each Mozilla product.
To protect user privacy, we intentionally do not include any identifiers
that can be used to link a given client or user across multiple products.
As a result, when we consider overall &quot;mobile MAU&quot;, we are taking a simple sum of
MAU as measured independently for each product. Analyses should keep in mind
that any given user could be contributing multiple points to MAU by sending
telemetry from multiple applications. Forecasts should also generally only be
prepared per-product for this reason.</p>
<p>This causes some particularly interesting effects for the case of migrating users
from one application to another as is the case with Firefox for Android in 2020.
A highly active user who migrates will go from sending multiple Fennec <code>core</code> pings per
day to sending multiple Fenix <code>baseline</code> pings per day.
On the day of migration, they will have sent pings from both applications and thus
will count towards Fennec metrics <em>and</em> Fenix metrics. It will take a full 28 days
for the client to finally fall out of the MAU window for Fennec, so we should
expect to see inflation in the overall &quot;mobile MAU&quot; sum during periods of heavy
migration.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/dau.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#active-dau-and-active-mau" id="active-dau-and-active-mau">Active DAU and Active MAU</a></h1>
<p>An <strong>Active User</strong> is defined as a client who has <code>total_daily_uri</code> &gt;= 5 URI for a given date.</p>
<ul>
<li>
<p>Dates are defined by <code>submission_date</code> (<em>not</em> by <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1422892">client activity date</a>).</p>
</li>
<li>
<p>A client's <code>total_daily_uri</code> is defined as their sum of <code>scalar_parent_browser_engagement_total_uri_count</code> for a given date<sup></p>
<p><a href="cookbooks/active_dau.html#total_uri_count">1</a></sup>.</p>
</li>
</ul>
<p><strong>Active DAU</strong> (aDAU) is the number of Active Users on a given day.</p>
<p><strong>Active MAU</strong> (aMAU) is the number of unique clients who have been an Active User on any day in the last <strong>28 days</strong>. In other words, any client that contributes to aDAU in the last 28 days would also contribute to aMAU for that day. Note that this is not simply the sum of aDAU over 28 days, since any particular client could be active on many days.</p>
<p><strong>Active WAU</strong> (aWAU) is the number of unique clients who have been an Active User on any day in the last <strong>7 days</strong>. Caveats above for aMAU also apply to aWAU.</p>
<p>To make the time boundaries more clear, let's consider a particular date 2019-01-28. The aDAU number assigned to 2019-01-28 should consider all main pings received during 2019-01-28 UTC. We cannot observe the full data until 2019-01-28 closes (and in practice we need to wait a bit longer since we are usually referencing derived datasets like <code>clients_daily</code> that are updated once per day over several hours following midnight UTC), so the earliest we can calculate this value is on 2019-01-29. If plotted as a time series, this value should always be plotted at the point labeled 2019-01-28. Likewise, aMAU for 2019-01-28 should consider a 28 day range that includes main pings received on 2019-01-28 and back to beginning of day UTC 2019-01-01. Again, the earliest we can calculate the value is on 2019-01-29.</p>
<p>For quick analysis, using <a href="cookbooks/../datasets/bigquery/exact_mau/reference.html"><code>firefox_desktop_exact_mau28_by_dimensions</code></a> is recommended. Below is an example query for getting MAU, WAU, and DAU for 2018 using <code>firefox_desktop_exact_mau28_by_dimensions</code>.</p>
<pre><code class="language-sql">SELECT
  submission_date,
  SUM(visited_5_uri_mau) AS visited_5_uri_mau,
  SUM(visited_5_uri_wau) AS visited_5_uri_wau,
  SUM(visited_5_uri_dau) AS visited_5_uri_dau
FROM
  telemetry.firefox_desktop_exact_mau28_by_dimensions
WHERE
  submission_date_s3 &gt;= '2018-01-01'
  AND submission_date_s3 &lt; '2019-01-01'
GROUP BY
  submission_date
ORDER BY
  submission_date
</code></pre>
<p>For analysis of dimensions not available in <code>firefox_desktop_exact_mau28_by_dimensions</code>, using <a href="cookbooks/../datasets/bigquery/clients_last_seen/reference.html"><code>clients_last_seen</code></a> is recommended. Below is an example query for getting aMAU, aWAU, and aDAU by <code>app_version</code> for 2018 using <code>clients_last_seen</code>.</p>
<pre><code class="language-sql">SELECT
  submission_date,
  app_version,
  -- days_since_* values are always &lt; 28 or null, so aMAU could also be
  -- calculated with COUNT(days_since_visited_5_uri)
  COUNTIF(days_since_visited_5_uri &lt; 28) AS visited_5_uri_mau,
  COUNTIF(days_since_visited_5_uri &lt; 7) AS visited_5_uri_wau,
  -- days_since_* values are always &gt;= 0 or null, so aDAU could also be
  -- calculated with COUNTIF(days_since_visited_5_uri = 0)
  COUNTIF(days_since_visited_5_uri &lt; 1) AS visited_5_uri_dau
FROM
  telemetry.clients_last_seen
WHERE
  submission_date_s3 &gt;= '2018-01-01'
  AND submission_date_s3 &lt; '2019-01-01'
GROUP BY
  submission_date,
  app_version
ORDER BY
  submission_date,
  app_version
</code></pre>
<p>For analysis of only aDAU, using <a href="cookbooks/../datasets/batch_view/clients_daily/reference.html"><code>clients_daily</code></a> is more efficient than <code>clients_last_seen</code>. Getting aMAU and aWAU from <code>clients_daily</code> is not recommended. Below is an example query for getting aDAU for 2018 using <code>clients_daily</code>.</p>
<pre><code class="language-sql">SELECT
  submission_date_s3,
  COUNT(*) AS visited_5_uri_dau
FROM
  telemetry.clients_daily
WHERE
  scalar_parent_browser_engagement_total_uri_count_sum &gt;= 5
  -- In BigQuery use yyyy-MM-DD, e.g. '2018-01-01'
  AND submission_date_s3 &gt;= '20180101'
  AND submission_date_s3 &lt; '20190101'
GROUP BY
  submission_date_s3
ORDER BY
  submission_date_s3
</code></pre>
<p><a href="cookbooks/../datasets/batch_view/main_summary/reference.html"><code>main_summary</code></a> can also be used for getting aDAU. Below is an example query using a 1% sample over March 2018 using <code>main_summary</code>:</p>
<pre><code class="language-sql">SELECT
  submission_date_s3,
  COUNT(*) * 100 AS visited_5_uri_dau
FROM (
  SELECT
    submission_date_s3,
    client_id,
    SUM(scalar_parent_browser_engagement_total_uri_count) &gt;= 5 AS visited_5_uri
  FROM
    telemetry.main_summary
  WHERE
    sample_id = '51'
    -- In BigQuery use yyyy-MM-DD, e.g. '2018-03-01'
    AND submission_date_s3 &gt;= '20180301'
    AND submission_date_s3 &lt; '20180401'
  GROUP BY
    submission_date_s3,
    client_id)
WHERE
  visited_5_uri
GROUP BY
  submission_date_s3
ORDER BY
  submission_date_s3
</code></pre>
<span id="total_uri_count">
**1**</span>: Note, the probe measuring `scalar_parent_browser_engagement_total_uri_count` only exists in clients with Firefox 50 and up. Clients on earlier versions of Firefox won't be counted as an Active User (regardless of their use). Similarly, `scalar_parent_browser_engagement_total_uri_count` doesn't increment when a client is in Private Browsing mode, so that won't be included as well.
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/active_dau.md">Edit this file on GitHub.</a></footer><p><em>Authored by the Data Science Team. Please direct questions/concerns to Jesse McCrosky (<code>jmccrosky@mozilla.com</code>).</em></p>
<h1><a class="header" href="#retention-2" id="retention-2">Retention</a></h1>
<p>Retention measures the proportion of users that are <em>continuing</em> to use Firefox, making it one of the more important metrics we track - we generally expect that the more value our users receive from the product, the more likely they are to be retained. We commonly measure retention between releases, experiment cohorts, and various Firefox subpopulations to better understand how a change to the user experience or use of a specific feature affects retention behavior.</p>
<h2><a class="header" href="#state-of-retention" id="state-of-retention">State of Retention</a></h2>
<p>There is currently active research into retention metrics and we expect our conceptual and data model around retention to evolve in the coming months. This page will be updated. However, in the meantime, we want to be clear about our standard retention metrics for use right now.</p>
<p>You can also see the <a href="https://docs.google.com/document/d/1VtqNFQFB9eJNr57h3Mz-lldMcpSYQKHVn2jzMMjPFYY/"><em>Proposed Metric Definition: Retention</em> Google Doc</a> for a summary of our conceptual thinking about retention metrics.</p>
<h2><a class="header" href="#standard-retention-metrics" id="standard-retention-metrics">Standard Retention metrics</a></h2>
<p>Note that the definitions below refer to &quot;usage criterion&quot;. See the <a href="https://docs.google.com/document/d/1sIHCCaJhtfxj-dnbInfuIjlMRhCFbEhFiBESaezIRwM/edit#heading=h.ysqpvceb7pgt">GUD Data Model documentation</a> for more information. For normal Firefox Desktop retention, the usage criterion refers to simply sending any main ping.</p>
<h3><a class="header" href="#1-week-retention-1" id="1-week-retention-1">1-Week Retention</a></h3>
<p>Among profiles that were active in the specified usage criterion at least once in the week starting on the specified day (day 0), what proportion (out of 1) meet the usage criterion during the following week (days 7 through 13).</p>
<h3><a class="header" href="#1-week-new-profile-retention-1" id="1-week-new-profile-retention-1">1-Week New Profile Retention</a></h3>
<p>Among new profiles created on the day specified, what proportion (out of 1) meet the usage criterion during the week beginning one week after the day specified.</p>
<p>Note that we use a new profile definition that relies on the <code>profile_creation_date</code> and requires that a main ping be sent within one week of the <code>profile_creation_date</code>. This differs from analysis using new profile pings, but allows valid comparison over time. New profile pings do not allow comparison over time due to the increased adoption of versions of the browser recent enough to send new profile pings.</p>
<h2><a class="header" href="#accessing-retention-metrics" id="accessing-retention-metrics">Accessing Retention Metrics</a></h2>
<p>There are three standard methods for accessing retention metrics. These methods trade off between simplicity and flexibility.</p>
<h3><a class="header" href="#mozilla-growth--usage-dashboard-gud-1" id="mozilla-growth--usage-dashboard-gud-1">Mozilla Growth &amp; Usage Dashboard (GUD)</a></h3>
<p>The <a href="https://gud.telemetry.mozilla.org/">GUD</a> provides plots and exportable tables of both retention metrics over time. Metrics are available for most products and can be sliced by OS, language, country, and channel.</p>
<h3><a class="header" href="#querying-smoot-usage-tables" id="querying-smoot-usage-tables">Querying Smoot Usage Tables</a></h3>
<p>For programmatic access, the tables underlying GUD can be queried directly. For example:</p>
<pre><code class="language-sql">SELECT
  `date`,
  SAFE_DIVIDE(SUM(new_profile_active_in_week_1), SUM(new_profiles)) AS one_week_new_profile_retention,
  SAFE_DIVIDE(SUM(active_in_weeks_0_and_1), SUM(active_in_week_0)) AS one_week_retention
FROM `moz-fx-data-shared-prod.telemetry.smoot_usage_day_13`
WHERE
  usage = 'Any Firefox Desktop Activity'
  AND country IN ('US', 'GB', 'CA', 'FR', 'DE')
  AND `date` BETWEEN &quot;2019-11-01&quot; AND &quot;2019-11-07&quot;
GROUP BY `date` ORDER BY `date`
</code></pre>
<h3><a class="header" href="#querying-clients-daily-tables" id="querying-clients-daily-tables">Querying Clients Daily Tables</a></h3>
<p>For more custom access, use the <code>clients_last_seen tables</code>. You can restrict to an arbitrary population of users by joining the <code>base</code> table below against a table containing the <code>client_id</code>s of interest.</p>
<pre><code class="language-sql">WITH base AS (
  SELECT
    client_id,
    DATE_SUB(submission_date, INTERVAL 13 DAY) AS date,
    COUNTIF(udf.bitpos(days_created_profile_bits) = 13) AS new_profiles,
          COUNTIF(udf.active_n_weeks_ago(days_seen_bits, 1)) AS active_in_week_0,
          COUNTIF(udf.active_n_weeks_ago(days_seen_bits, 1)
            AND udf.active_n_weeks_ago(days_seen_bits, 0))
            AS active_in_weeks_0_and_1,
          COUNTIF(udf.bitpos(days_created_profile_bits) = 13 AND udf.active_n_weeks_ago(days_seen_bits, 0)) AS new_profile_active_in_week_1
  FROM
    telemetry.clients_last_seen
GROUP BY client_id, submission_date
)

SELECT
  SAFE_DIVIDE(SUM(new_profile_active_in_week_1), SUM(new_profiles)) AS one_week_new_profile_retention,
  SAFE_DIVIDE(SUM(active_in_weeks_0_and_1), SUM(active_in_week_0)) AS one_week_retention
FROM
  base
WHERE date = &quot;2019-12-01&quot;
</code></pre>
<h3><a class="header" href="#simplified-view-for-1-week-retention" id="simplified-view-for-1-week-retention">Simplified View for 1-week Retention</a></h3>
<p>You can also use the simplified <code>desktop_retention_1_week</code> view. This still supports restriction to an arbitrary population of users by joining against a table containing the <code>client_id</code>s of interest.</p>
<pre><code class="language-sql">SELECT
  AVG(IF(retained, 1, 0)) AS retention
FROM
  `moz-fx-data-shared-prod.telemetry.desktop_retention_1_week`
RIGHT JOIN
  my_cohort_t
USING
  (client_id)
WHERE
  date BETWEEN &quot;2020-03-01&quot; AND &quot;2020-03-07&quot;
GROUP BY
  date
</code></pre>
<h2><a class="header" href="#confounding-factors" id="confounding-factors">Confounding Factors</a></h2>
<p>When performing retention analysis it is important to understand that there are many reasons for retention differences between groups. Unless you are comparing two arms of a controlled experiment, in which case you can probably attribute any difference to the experimental treatment, it is impossible to make causal arguments about retention differences. For example, if you observe the users that save a large number of bookmarks tend to have higher retention than those who do not, it is more likely that the retention difference is simply a property of <em>the types of people</em> that save bookmarks, and an intervention to encourage saving more bookmarks is not necessarily likely to improve retention.</p>
<h2><a class="header" href="#confidence-intervals" id="confidence-intervals">Confidence Intervals</a></h2>
<p>It is good practice to always compute confidence intervals for retention metrics, especially when looking at specific slices of users or when making comparisons between different groups.</p>
<p>The <a href="https://gud.telemetry.mozilla.org/">Growth and Usage Dashboard</a> provides confidence intervals automatically using a jackknife resampling method over <code>client_id</code> buckets. This confidence intervals generated using this method should be considered the &quot;standard&quot;. We show below how to compute them using the data sources described above. These methods use UDFs <a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/udf_js/jackknife_ratio_ci/udf.sql">defined in bigquery-etl</a>.</p>
<p>We also note that it is fairly simple to calculate a confidence interval using any statistical method appropriate for proportions. The queries given above provide both numerators and denominators, so feel free to calculate confidence intervals in the manner you prefer. However, if you want to replicate the standard confidence intervals, please work from the example queries below.</p>
<h3><a class="header" href="#querying-smoot-usage-tables-1" id="querying-smoot-usage-tables-1">Querying Smoot Usage Tables</a></h3>
<pre><code class="language-sql">WITH bucketed AS (
  SELECT
    `date`,
    id_bucket,
    SUM(new_profile_active_in_week_1) AS new_profile_active_in_week_1,
    SUM(new_profiles) AS new_profiles
  FROM `moz-fx-data-shared-prod.telemetry.smoot_usage_day_13`
  WHERE
    usage = 'Any Firefox Desktop Activity'
    AND country IN ('US', 'GB', 'CA', 'FR', 'DE')
    AND `date` BETWEEN &quot;2019-11-01&quot; AND &quot;2019-11-07&quot;
  GROUP BY `date`, id_bucket
)

SELECT
  `date`,
  udf_js.jackknife_ratio_ci(20, ARRAY_AGG(STRUCT(CAST(new_profile_active_in_week_1 AS float64), CAST(new_profiles as FLOAT64)))) AS one_week_new_profile_retention
FROM bucketed
GROUP BY `date` ORDER BY `date`
</code></pre>
<h3><a class="header" href="#querying-clients-daily-tables-1" id="querying-clients-daily-tables-1">Querying Clients Daily Tables</a></h3>
<pre><code class="language-sql">WITH base AS (
  SELECT
    client_id,
    MOD(ABS(FARM_FINGERPRINT(MD5(client_id))), 20) AS id_bucket,
    DATE_SUB(submission_date, INTERVAL 13 DAY) AS date,
    COUNTIF(udf.bitpos(days_created_profile_bits) = 13) AS new_profiles,
          COUNTIF(udf.active_n_weeks_ago(days_seen_bits, 1)) AS active_in_week_0,
          COUNTIF(udf.active_n_weeks_ago(days_seen_bits, 1)
            AND udf.active_n_weeks_ago(days_seen_bits, 0))
            AS active_in_weeks_0_and_1,
          COUNTIF(udf.bitpos(days_created_profile_bits) = 13 AND udf.active_n_weeks_ago(days_seen_bits, 0)) AS new_profile_active_in_week_1
  FROM
    telemetry.clients_last_seen
  -- We need to &quot;rewind&quot; 13 days since retention is forward-looking;
  -- we calculate retention for &quot;day 0&quot; based on clients_last_seen data from &quot;day 13&quot;.
  WHERE DATE_SUB(submission_date, INTERVAL 13 DAY) = &quot;2019-10-01&quot;
  GROUP BY client_id, submission_date
),

bucketed AS (
  SELECT
    date,
    -- There are many options for hashing client_ids into buckets;
    -- the below is an easy option using native BigQuery SQL functions;
    -- see discussion in https://github.com/mozilla/bigquery-etl/issues/36
    MOD(ABS(FARM_FINGERPRINT(client_id)), 20) AS id_bucket,
    SUM(active_in_weeks_0_and_1) AS active_in_weeks_0_and_1,
    SUM(active_in_week_0) AS active_in_week_0
  FROM
    base
  WHERE
    id_bucket IS NOT NULL
  GROUP BY
    date,
    id_bucket
)

SELECT
  `date`,
  udf_js.jackknife_ratio_ci(20, ARRAY_AGG(STRUCT(CAST(active_in_weeks_0_and_1 AS float64), CAST(active_in_week_0 as FLOAT64)))) AS one_week_retention
FROM bucketed
GROUP BY `date` ORDER BY `date`
</code></pre>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/retention.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#operational" id="operational">Operational</a></h1>
<p>This section contains tutorials on operational tasks that a data practitioner might want to perform. It is intended for a broad audience.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/operational/index.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#creating-a-prototype-data-project-on-google-cloud-platform" id="creating-a-prototype-data-project-on-google-cloud-platform">Creating a Prototype Data Project on Google Cloud Platform</a></h1>
<p>If you are working on a more complex project (as opposed to ad-hoc or one-off analysis) which you intend to be run in production at some point, it may be worthwhile provisioning a separate <em>prototype</em> GCP project for it with access to our datasets. From the <a href="https://console.cloud.google.com/">Google Cloud Console</a>, you may then:</p>
<ul>
<li>Provision service accounts for querying BigQuery (including our production tables) or accessing other GCP resources from the command-line or inside Docker containers</li>
<li>Write and query data to private BigQuery tables, without worrying about interfering with what we have in production</li>
<li>Make Docker images available via the Google Container Registry (see <a href="cookbooks/deploying-containers.html">the cookbook on deploying containers</a>)</li>
<li>Create <a href="https://cloud.google.com/storage/">Google Cloud Storage</a> buckets for storing temporary data</li>
<li>Create <a href="https://cloud.google.com/compute/docs/instances">Google Compute Instances</a> for test-running software in the cloud</li>
<li>Create a temporary Kubernetes cluster for test-running a scheduled job with <a href="https://github.com/mozilla/telemetry-airflow">telemetry-airflow</a></li>
<li>Create static dashboards with protosaur (see <a href="cookbooks/./operational/protosaur.html">Creating Static Dashboards with Protosaur</a>)</li>
<li>Track the costs for all of the above using the Google Cost Dashboard feature of the GCP console</li>
</ul>
<p>This has a number of advantages over our traditional approach of creating bulk &quot;sandbox&quot; projects for larger teams:</p>
<ul>
<li>Easy to track costs of individual components</li>
<li>Can self-serve short-lived administrative credentials which exist only for the lifespan of the project.</li>
<li>Can easily spin down projects and resources which have run their course</li>
</ul>
<p>Note that these prototype GCP projects are not intended to be used for projects which are already in <em>production</em>-- those should be maintained on operations-supported projects, presumably after a development phase. Nor are they meant for ad-hoc analysis or experimentation-- for that, just file a request as outlined in the <a href="cookbooks/bigquery/access.html#access-request">Accessing BigQuery</a> cookbook.</p>
<p>Each sandbox project has a data engineering contact associated with it: this is the person that will create the project for you. Additionally, they are meant to be a resource you can freely ask for advice on how to query or use GCP, and how to build software that lends itself to productionization. If you are a data engineer, the data engineering contact may be yourself, but you should still follow the procedure below for tracking purposes in any case.</p>
<p>To request the creation of a prototype GCP project, <a href="https://bugzilla.mozilla.org/enter_bug.cgi?assigned_to=nobody%40mozilla.org&amp;bug_ignored=0&amp;bug_severity=normal&amp;bug_status=NEW&amp;bug_type=task&amp;cf_fx_iteration=---&amp;cf_fx_points=---&amp;comment=%2A%2A%20Please%20fill%20out%20the%20following%20information%20and%20needinfo%20the%20data%20engineering%20contact%20you%20specified%20below%20%28unless%20the%20contact%20is%20yourself%29%2C%20don%27t%20forget%20to%20change%20the%20title%20to%20use%20your%20project%20name%21%20%2A%2A%0D%0A%0D%0AGCP-compatible%20project%20name%20%28e.g.%20missioncontrol-v2-dev%2C%20adi-forecasting-dev%29%3A%0D%0ALDAP%20of%20people%20who%20require%20administrative%20privileges%20for%20this%20project%3A%20%0D%0AProject%20timeline%20%28maximum%206%20months%2C%20projects%20may%20be%20renewed%20if%20development%20is%20still%20ongoing%20at%20the%20end%20of%20that%20period%29%3A%0D%0AApproximate%20budget%20for%20this%20project%20%28if%20expected%20to%20be%20greater%20than%20%241000%29%3A%0D%0AWhether%20this%20project%20will%20be%20used%20to%20import%20external%20data%20into%20GCP%2C%20and%20if%20so%2C%20from%20where%20%28if%20the%20answer%20is%20yes%2C%20needinfo%20a%20member%20of%20Data%20SRE%20for%20an%20ops%20evaluation%29%3A%0D%0AData%20Engineering%20contact%20for%20this%20project%3A%0D%0A%0D%0AFor%20more%20information%2C%20please%20see%20%5Bthe%20gcp%20project%20cookbook%5D%28https%3A%2F%2Fdocs.telemetry.mozilla.org%2Fcookbooks%2Fgcp-projects.html%29%20on%20docs.telemetry.mozilla.org.&amp;component=General&amp;contenttypemethod=list&amp;contenttypeselection=text%2Fplain&amp;defined_groups=1&amp;filed_via=standard_form&amp;flag_type-4=X&amp;flag_type-607=X&amp;flag_type-800=X&amp;flag_type-803=X&amp;flag_type-936=X&amp;form_name=enter_bug&amp;maketemplate=Remember%20values%20as%20bookmarkable%20template&amp;op_sys=Unspecified&amp;priority=--&amp;product=Data%20Platform%20and%20Tools&amp;rep_platform=Unspecified&amp;short_desc=New%20GCP%20Project%20Request%3A%20name-of-project&amp;status_whiteboard=%5Bgcp-project-request%5D&amp;target_milestone=---&amp;version=unspecified">file a bug</a> using the provided template.
Not sure if you need a project like this? Don't know who to specify as a Data Engineering contact? Not sure what your project budget might be? <a href="cookbooks/../concepts/getting_help.html">Get in touch with the data platform team</a>.</p>
<p>We are currently <a href="https://mana.mozilla.org/wiki/display/DATA/Active+GCP+Prototype+Projects">tracking these projects on mana</a> (link requires Mozilla LDAP)</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/gcp-projects.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#creating-static-dashboards-with-protosaur" id="creating-static-dashboards-with-protosaur">Creating Static Dashboards with Protosaur</a></h1>
<p><a href="https://protosaur.dev"><code>protosaur.dev</code></a> allows data practitioners at Mozilla to create <em>prototype</em> static dashboards behind Mozilla SSO (single-sign-on).
As the name implies, protosaur is intended for prototypes -- dashboards created using this system are not monitored or supported by Data Operations or Data Engineering.
Protosaur is a simple static hosting service: it does not provide form handling, databases, or any other kind of server-side operation.
However, for presenting dashboards and other types of data visualization, a static website is often all you need (see, for example, the galaxy of sites produced using <a href="https://pages.github.com/">GitHub Pages</a>).</p>
<p>Protosaur's architecture is simple: it serves files in a <a href="https://cloud.google.com/storage/">Google Cloud Storage</a> (GCS) bucket under the <a href="https://protosaur.dev"><code>protosaur.dev</code></a> domain. How you get the files into the bucket is entirely up to you: you can use CircleCI, Airflow, or any other method that you might choose.</p>
<p>The current procedure for creating a new protosaur dashboard is as follows:</p>
<ul>
<li>Find a GCP project to use for the GCS bucket. This could be a team project (if you have one already) or a <a href="cookbooks/operational/../gcp-projects.html">GCP prototype project</a>. Using a prototype project is preferred for larger efforts with multiple components in addition to a front-end dashboard.</li>
<li>Create a GCS bucket in said project.</li>
<li>Upload content into the bucket (e.g. via <a href="https://cloud.google.com/storage/docs/gsutil"><code>gsutil</code></a>).</li>
<li>Add the project to Protosaur's configuration, which currently lives in the <a href="https://github.com/mozilla/protodash">protodash repository</a> on GitHub. For up to date instructions on how to do this, <a href="https://github.com/mozilla/protodash/blob/master/README.md">see the project's README</a>.</li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/operational/protosaur.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#scheduling-bigquery-queries-in-airflow" id="scheduling-bigquery-queries-in-airflow">Scheduling BigQuery Queries in Airflow</a></h1>
<p>Queries in <a href="https://github.com/mozilla/bigquery-etl"><code>bigquery-etl</code></a> can be scheduled in
<a href="https://github.com/mozilla/telemetry-airflow">Airflow</a> to be run regularly with the results written to a table.</p>
<ul>
<li><a href="cookbooks/bigquery-airflow.html#in-bigquery-etl">In bigquery-etl</a></li>
<li><a href="cookbooks/bigquery-airflow.html#other-considerations">Other considerations</a></li>
</ul>
<h2><a class="header" href="#in-bigquery-etl" id="in-bigquery-etl">In bigquery-etl</a></h2>
<p>In the <a href="https://github.com/mozilla/bigquery-etl"><code>bigquery-etl</code></a> project, queries are written in <code>/sql</code>.
The directory structure is based on the destination table: <code>/sql/{project_id}/{dataset_id}/{table_name}</code>.
For example, <a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/core_clients_last_seen_v1/query.sql"><code>/sql/moz-fx-data-shared-prod/telemetry_derived/core_clients_last_seen_v1/query.sql</code></a>
is a query that will write results to the <code>core_clients_last_seen_v1</code> table in the <code>telemetry_derived</code> dataset.</p>
<p>If we want to create a new table of just <code>client_id</code>'s each day called <code>client_ids</code> in the <code>example</code> dataset
in the <code>moz-fx-data-shared-prod</code> project, we should create <code>/sql/moz-fx-data-shared-prod/example/client_ids/query.sql</code>:</p>
<pre><code class="language-sql">SELECT
  DISTINCT(client_id),
  submission_date
FROM
    telemetry_derived.main_summary_v4
WHERE
  submission_date = @submission_date
</code></pre>
<p><code>@submission_date</code> is a parameter that will be filled in by Airflow.</p>
<p>To schedule your query, create a <code>/sql/moz-fx-data-shared-prod/example/client_ids/metadata.yaml</code> file with the following content:</p>
<pre><code class="language-yaml">friendly_name: Client IDs
description: Unique client IDs, partitioned by day.
owners:
  - example@mozilla.com
labels:
  application: firefox
  incremental: true # incremental queries add data to existing tables
scheduling:
  dag_name: bqetl_client_ids
</code></pre>
<p>The <code>scheduling</code> section schedules the query as a task that is part of the <code>bqetl_clients_ids</code> DAG. Make sure that
the <code>bqetl_clients_ids</code> DAG is actually defined in <code>dags.yaml</code> and has the right scheduling interval, for example:</p>
<pre><code class="language-yaml">bqetl_clients_ids: # name of the DAG; must start with bqetl_
  schedule_interval: 0 2 * * * # query schedule; every day at 2am
  default_args:
    owner: example@mozilla.com
    start_date: &quot;2020-04-05&quot; # YYYY-MM-DD
    email: [&quot;example@mozilla.com&quot;]
    retries: 2 # number of retries if the query execution fails
    retry_delay: 30m
</code></pre>
<p>In this example, the <code>bqetl_clients_ids</code> DAG and the created query will be executed on a daily basis at 02:00 UTC.</p>
<p>Run <code>./script/generate_airflow_dags</code> to generate the Airflow DAG or generate the DAG using the <a href="https://github.com/mozilla/bigquery-etl#the-bqetl-cli"><code>bqetl</code> CLI</a>:
<code>bqetl dag generate bqetl_clients_ids</code>. Task dependencies that are defined in bigquery-etl and
dependencies to stable tables are determined automatically. Generated DAGs are written to the <code>dags/</code> directory and
will be automatically detected and scheduled by Airflow once the changes are committed to master in <code>bigquery-etl</code>.</p>
<h2><a class="header" href="#other-considerations" id="other-considerations">Other considerations</a></h2>
<ul>
<li>The Airflow task will overwrite the destination table partition
<ul>
<li>Destination table should be partitioned by <code>submission_date</code></li>
<li><code>date_partition_parameter</code> can be set to <code>null</code> to overwrite the whole table in the <code>scheduling</code> section
of the <code>metadata.yaml</code> file</li>
</ul>
</li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/bigquery-airflow.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#building-and-deploying-containers-to-google-container-registry-gcr-with-circleci" id="building-and-deploying-containers-to-google-container-registry-gcr-with-circleci">Building and Deploying Containers to Google Container Registry (GCR) with CircleCI</a></h1>
<p>The following cookbook describes how to set up automated build and deployment for containers with CircleCI, a useful pattern for scheduling custom jobs in Google Kubernetes Engine.</p>
<p>Note that this method intended for rapid prototyping rather than for production workloads.
If you need to transition a prototype to a production deployment,
<a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Data+Platform+and+Tools&amp;component=Operations">file a Data Platform and Tools &gt; Operations bug</a>
to start the conversation.</p>
<ul>
<li><a href="cookbooks/deploying-containers.html#assumptions">Assumptions</a></li>
<li><a href="cookbooks/deploying-containers.html#steps">Steps</a>
<ul>
<li><a href="cookbooks/deploying-containers.html#on-gcp">On GCP</a></li>
<li><a href="cookbooks/deploying-containers.html#on-circleci">On CircleCI</a></li>
<li><a href="cookbooks/deploying-containers.html#in-your-github-repo">In your GitHub Repo</a></li>
<li><a href="cookbooks/deploying-containers.html#optional">Optional</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#assumptions" id="assumptions">Assumptions</a></h2>
<ul>
<li>Your GitHub project's repository has a working Dockerfile at its root
<ul>
<li>If your file is not named <code>Dockerfile</code> or not located in the repo root, see the docs for the <a href="https://circleci.com/orbs/registry/orb/circleci/gcp-gcr">CircleCI GCP-GCR orb</a> for additional configuration</li>
</ul>
</li>
<li>The repository is in the <a href="https://github.com/mozilla"><code>mozilla</code> GitHub org</a> (or another org with a paid CircleCI account)</li>
</ul>
<h2><a class="header" href="#steps" id="steps">Steps</a></h2>
<h3><a class="header" href="#on-gcp" id="on-gcp">On GCP</a></h3>
<ul>
<li>Make sure &quot;Container Registry&quot; (https://console.cloud.google.com/gcr/images/&lt;your-project-id&gt;) is enabled for your GCP project</li>
<li>Create a service account, give it the &quot;Storage Admin&quot; role and create a key
<ul>
<li>Console Link: <a href="https://console.cloud.google.com/iam-admin/serviceaccounts">Google Cloud Platform</a></li>
<li>Additional documentation: <a href="https://cloud.google.com/container-registry/docs/access-control?hl=en_US">Configuring access control  |  Container Registry Documentation</a></li>
</ul>
</li>
</ul>
<h3><a class="header" href="#on-circleci" id="on-circleci">On CircleCI</a></h3>
<ul>
<li><strong>IMPORTANT SECURITY STEP</strong>
<ul>
<li>Go to your project’s CircleCI Advanced Settings Page (e.g. https://circleci.com/gh/mozilla/pensieve/edit#advanced-settings) and make sure that the &quot;<em>Pass secrets to builds from forked pull requests</em>&quot; option is TURNED OFF
<ul>
<li>This prevents a bad actor from creating a PR with a CI job that spits out your environment variables to the console, for instance</li>
</ul>
</li>
<li>If you can't access your project settings page, make sure you’re logged into CircleCI via your Mozilla GitHub account and that you are a project administrator</li>
</ul>
</li>
<li>On the CircleCI Environment Variables page (e.g. https://circleci.com/gh/mozilla/pensieve/edit#env-vars), add:
<ul>
<li><code>GOOGLE_PROJECT_ID</code>: the project ID that you created in step 1</li>
<li><code>GOOGLE_COMPUTE_ZONE</code>: any compute zone will do, apparently -- try <code>us-west1</code> if you're agnostic</li>
<li><code>GCLOUD_SERVICE_KEY</code>: paste in the entire text of the service account key that you generated in step 2</li>
<li>Check out the docs for the <a href="https://circleci.com/orbs/registry/orb/circleci/gcp-gcr">CircleCI GCP-GCR orb</a> for other environment variables that you may set</li>
</ul>
</li>
</ul>
<h3><a class="header" href="#in-your-github-repo" id="in-your-github-repo">In your GitHub Repo</a></h3>
<ul>
<li>In your CircleCI config file add a changeset like this:
<ul>
<li><a href="https://github.com/mozilla/pensieve/commit/b56f6f78b16d5893ff1cbf1ba895fa5bc85266c0">Add automated deployment of docker image to google container registry…</a></li>
<li>The <code>orb</code> directive allows the use of the <a href="https://circleci.com/orbs/registry/orb/circleci/gcp-gcr">CircleCI GCP-GCR orb</a> build-and-push-image job</li>
<li>In your <code>workflows</code> section, add <code>gcp-gcr/build-and-push-image</code> as a job and require any dependencies you’d like to pass before pushing a new image. Assuming you only want this deployment to occur on new commits to master, add a filter for only the master branch (as in the changeset above)</li>
</ul>
</li>
<li>Create and merge a pull request for this changeset and your newly built image should be in your project’s container registry in a few moments!</li>
</ul>
<h3><a class="header" href="#optional" id="optional">Optional</a></h3>
<p>If your repository is public, you may want to make its container registry publicly readable as well. Go to the GCP container registry’s Settings tab and in the &quot;Public access&quot; section change the visibility for <code>gcr.io</code> (the default host if you followed these instructions) to <code>Public</code>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/deploying-containers.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#making-datasets-publicly-available" id="making-datasets-publicly-available">Making Datasets Publicly Available</a></h1>
<p>Currently, only datasets and query results that are available in BigQuery and
defined in the <a href="https://github.com/mozilla/bigquery-etl">bigquery-etl</a> repository can be made publicly available.
See <a href="cookbooks/../cookbooks/bigquery-airflow.html">Scheduling BigQuery Queries in Airflow</a>
on how to create and schedule datasets. Before data can be published, a data review is
required.</p>
<p>To make query results publicly available, a <a href="https://github.com/mozilla/bigquery-etl#query-metadata"><code>metadata.yaml</code> file</a>
must be added alongside the query in <a href="https://github.com/mozilla/bigquery-etl">bigquery-etl</a>. For example:</p>
<pre><code class="language-yaml">friendly_name: SSL Ratios
description: &gt;-
  Percentages of page loads Firefox users have performed that were 
  conducted over SSL broken down by country.
owners:
  - example@mozilla.com
labels:
  application: firefox
  incremental: true # incremental queries add data to existing tables
  schedule: daily # scheduled in Airflow to run daily
  public_json: true
  public_bigquery: true
  review_bug: 1414839 # Bugzilla bug ID of data review
  incremental_export: false # non-incremental JSON export writes all data to a single location
</code></pre>
<p>The following options define how data is published:</p>
<ul>
<li><code>public_json</code>: data is available through the <a href="https://public-data.telemetry.mozilla.org">public HTTP endpoint</a></li>
<li><code>public_bigquery</code>: data is publicly available on BigQuery
<ul>
<li>tables will get published in the <code>mozilla-public-data</code> GCP project which is accessible
by everyone, also external users</li>
</ul>
</li>
<li><code>incremental_export</code>: determines how data gets split up
<ul>
<li><code>true</code>: data for each <code>submission_date</code> gets exported into separate directories (e.g.
<code>files/2020-04-15</code>, <code>files/2020-04-16</code>, ...)
<ul>
<li><code>false</code>: all data gets exported into one <code>files/</code> directory</li>
</ul>
</li>
</ul>
</li>
<li><code>incremental</code>: indicates how data gets updated based on the query and Airflow configuration
<ul>
<li><code>true</code>: data gets incrementally updated</li>
<li><code>false</code>: the entire table data gets updated</li>
</ul>
</li>
<li><code>review_bug</code>: Bugzilla bug number to the data review</li>
</ul>
<p>Data will get published when the query is executed in Airflow. Metadata of available public
data on Cloud Storage is updated daily through a separate Airflow task.</p>
<p>More information about accessing public data can be found in
<a href="cookbooks/../cookbooks/public_data.html">Accessing Public Data</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/publishing_datasets.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#collecting-new-data" id="collecting-new-data">Collecting New Data</a></h1>
<h2><a class="header" href="#guidelines" id="guidelines">Guidelines</a></h2>
<p>For information about what sorts of data may be collected,
and for information on getting a data collection request reviewed,
please read the <a href="https://wiki.mozilla.org/Firefox/Data_Collection">Data Collection Guidelines.</a></p>
<h2><a class="header" href="#mechanics" id="mechanics">Mechanics</a></h2>
<p>The mechanics of how to instrument new data collection in Firefox are covered in
<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/start/adding-a-new-probe.html">Adding a new Telemetry probe</a>.</p>
<p>For non-Telemetry data collection, we have a mechanism for streamlining
ingestion of structured (JSON) data that utilizes the same underlying
infrastructure. See <a href="datasets/../cookbooks/new_ping.html">this cookbook</a> for details on using it.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/new_data.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#client-implementation-guidelines-for-experiments" id="client-implementation-guidelines-for-experiments">Client Implementation Guidelines for Experiments</a></h1>
<p>There are three supported approaches for enabling experimental features for Firefox:</p>
<ul>
<li><a href="cookbooks/client_guidelines.html#prefs">Firefox Prefs</a>
<ul>
<li>Prefs can be used to control features that <strong>land in-tree</strong>.
<a href="cookbooks/client_guidelines.html#feature-gates">Feature Gates</a> provide a wrapper around prefs that can be used from JavaScript.</li>
</ul>
</li>
<li><a href="cookbooks/client_guidelines.html#extensions">Firefox Extensions</a> AKA &quot;<strong>Add-ons</strong>&quot;.
<ul>
<li>If the feature being tested should not land in the tree, or if it will ultimately ship as an extension, then an extension should be used.</li>
</ul>
</li>
</ul>
<p>New features go through the standard Firefox review, testing, and deployment processes, and are then enabled experimentally in the field using <a href="https://github.com/mozilla/normandy">Normandy</a>.</p>
<h2><a class="header" href="#prefs" id="prefs">Prefs</a></h2>
<p>Firefox Preferences (AKA &quot;prefs&quot;) are commonly used to enable and disable features. However, prefs are more complex to implement correctly than <a href="cookbooks/client_guidelines.html#feature-gates">feature gates</a>.</p>
<p><strong>Each pref should represent a different experimental treatment</strong>. If your experimental feature requires multiple prefs, then Normandy does not currently support this but will soon. In the meantime, an <a href="cookbooks/client_guidelines.html#extensions">extension</a> such as <a href="https://github.com/nhnt11/multipreffer">multipreffer</a> may be used.</p>
<p>There are three types of Prefs:</p>
<ol>
<li>Built-in prefs - shipped with Firefox, in <code>firefox.js</code>.</li>
<li><code>user branch</code> - set by the user, overriding built-in prefs.</li>
<li><code>default branch</code> - Overrides both built-in and <code>user branch</code> prefs. Only persists until the browser session ends, next restart will revert to either built-in or <code>user branch</code> (if set).</li>
</ol>
<p><a href="https://github.com/mozilla/normandy">Normandy</a> supports overriding both the <code>user</code> and <code>default</code> branches, although the latter is preferred as it does not permanently override user settings. <code>default</code> branch prefs are simple to reset since they do not persist past a restart.</p>
<p><strong>In order for features to be activated experimentally using <code>default branch</code> prefs</strong>:</p>
<ul>
<li>The feature must not start up before <code>final-ui-startup</code> is observed.</li>
</ul>
<p>For instance, to set an observer:</p>
<pre><code class="language-js">Services.obs.addObserver(this, &quot;final-ui-startup&quot;, true);
</code></pre>
<p>In this example, <code>this</code> would implement an <code>observe(subject, topic, data)</code> function which will be called when <code>final-ui-startup</code> is observed. See the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Reference/Interface/nsIObserverService#addObserver()">Observer documentation</a> for more information.</p>
<ul>
<li>It must be possible to enable/disable the feature at runtime, via a pref change.</li>
</ul>
<p>This is similar to the observer pattern above:</p>
<pre><code class="language-js">Services.prefs.addObserver(&quot;pref_name&quot;, this);
</code></pre>
<p>More information is available in the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Reference/Interface/nsIPrefService">Preference service documentation</a>.</p>
<ul>
<li>
<p>Never use <code>Services.prefs.prefHasUserValue()</code>, or any other function specific to <code>user branch</code> prefs.</p>
</li>
<li>
<p>Prefs should be set by default in <code>firefox.js</code></p>
</li>
</ul>
<p>If your feature cannot abide by one or more of these rules (for instance, it needs to run at startup and/or cannot be toggled at runtime) then experimental preferences can be set on the <code>user branch</code>. This is more complex than using the methods described above; user branch prefs override the users choice, which is a really complex thing to try to support when flipping prefs experimentally. We also need to be careful to back up and reset the pref, and then figure out how to resolve conflicts if the user has changed the pref in the meantime.</p>
<h2><a class="header" href="#feature-gates" id="feature-gates">Feature Gates</a></h2>
<p>A new Feature Gate library for Firefox Desktop is now available.</p>
<p><strong>Each feature gate should represent a different experimental treatment</strong>. If your experimental feature requires multiple flags, then Normandy will not be able to support this directly and an <a href="cookbooks/client_guidelines.html#extensions">extension</a> may be used.</p>
<h3><a class="header" href="#feature-gate-caveats" id="feature-gate-caveats">Feature Gate caveats</a></h3>
<p>The current Feature Gate library comes with a few caveats, and may not be appropriate for your situation:</p>
<ul>
<li>Only JS is supported.</li>
<li>Always asynchronous.</li>
</ul>
<p>Future versions of the Feature Gate API will include C++/Rust support and a synchronous API.</p>
<h3><a class="header" href="#using-the-feature-gate-library" id="using-the-feature-gate-library">Using the Feature Gate library</a></h3>
<p>Read <a href="https://firefox-source-docs.mozilla.org/toolkit/components/featuregates/featuregates/index.html">the documentation</a> to get started.</p>
<h2><a class="header" href="#extensions" id="extensions">Extensions</a></h2>
<p>Firefox currently supports the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions">Web Extensions API</a>.</p>
<p><strong>If new WebExtension APIs are needed, they should land in-tree</strong>. Extensions which are signed by Mozilla can load privileged code using the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/extensions/webextensions/index.html">WebExtension Experiments</a>, but this is not preferred.</p>
<p>WebExtensions go through the same correctness and performance tests as other features. This is possible using the Mozilla tryserver by dropping your XPI into <code>testing/profiles/common/extensions</code> in <code>mozilla-central</code> and pushing to Tryserver - see the <a href="cookbooks/client_guidelines.html#testing-extensions">Testing Extensions</a> section below.</p>
<p>NOTE - it is ideal to test against the version of Firefox which the extension will release against, but there is a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1435403">bug related to artifact builds on release channels</a> which must be worked around. The workaround is pretty simple (modify an <code>artifacts.py</code> file), but this bug being resolved will make it much simpler.</p>
<p><strong>Each extension can represent a different experimental treatment (preferred), or the extension can choose the branch internally</strong>.</p>
<h3><a class="header" href="#shield-studies" id="shield-studies">SHIELD studies</a></h3>
<p>The previous version of the experiments program, SHIELD, always bundled privileged code with extensions and would do things such as mock UI features in Firefox.</p>
<p>This sort of approach is discouraged for new features - land these (or the necessary WebExtension APIs) in-tree instead.</p>
<p>For the moment, the <a href="https://github.com/mozilla/shield-studies-addon-utils/">SHIELD Study Add-on Utilities</a> may be used if the extension needs to control the lifecycle of the study, but using one extension per experimental treatment makes this unnecessary and is preferred. The APIs provided by the SHIELD Study Add-on Utilities will be available as privileged APIs shipped with Firefox soon.</p>
<h1><a class="header" href="#development-and-testing" id="development-and-testing">Development and Testing</a></h1>
<h2><a class="header" href="#testing-built-in-features" id="testing-built-in-features">Testing Built-in Features</a></h2>
<p>Firefox features go through standard development and testing processes. See the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide">Firefox developer guide</a> for more information.</p>
<h2><a class="header" href="#testing-extensions" id="testing-extensions">Testing Extensions</a></h2>
<p>Extensions do not need to go through the same process, but should take advantage of Mozilla CI and bug tracking systems:</p>
<ol>
<li>Use the Mozilla CI to test changes (tryserver).</li>
<li>Performance tests (<strong>this step is required</strong>) - extension XPI files should be placed in <code>testing/profiles/common/extensions/</code>, which will cause test harnesses to load the XPI.</li>
<li>Custom unit/functional tests (AKA <code>xpcshell</code>/<code>mochitest</code>) may be placed in <code>testing/extensions</code>, although running these tests outside Mozilla CI is acceptable so these are <strong>optional</strong>.</li>
<li>Receive reviewer approval. A Firefox peer <strong>must sign off</strong> if this extension contains privileged code, aka WebExtension Experiments.</li>
</ol>
<ul>
<li>Any <a href="https://wiki.mozilla.org/Modules/All#Firefox">Firefox Peer</a> should be able to do the review, or point you to someone who can.</li>
</ul>
<ol start="5">
<li>Extension is signed.</li>
<li>Email to <code>pi-request@mozilla.com</code> is sent to request QA</li>
<li>QA approval signed off in Bugzilla.</li>
<li>Extension is shipped via <a href="https://github.com/mozilla/normandy">Normandy</a>.</li>
</ol>
<h2><a class="header" href="#example-extensions-testing-workflow" id="example-extensions-testing-workflow">Example Extensions Testing Workflow</a></h2>
<p>Note that for the below to work you only need <a href="https://www.mercurial-scm.org/">Mercurial</a> installed, but if you want to do local testing you must be set up to <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Build_Instructions">build Firefox</a>. You don't need to build Firefox from source; <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Build_Instructions/Artifact_builds">artifact builds</a> are sufficient.</p>
<p>In order to use Mozilla CI (AKA &quot;<a href="https://firefox-source-docs.mozilla.org/tools/try/">Tryserver</a>&quot;), you must have a full clone of the <code>mozilla-central</code> repository:</p>
<pre><code class="language-bash">hg clone https://hg.mozilla.org/mozilla-central
cd mozilla-central
</code></pre>
<p>Copy in unsigned XPI, and commit it to your local Mercurial repo:</p>
<pre><code class="language-bash">cp ~/src/my-extension.xpi testing/profiles/common/extensions/
hg add testing/profiles/common/extensions/my-extension.xpi
hg commit -m &quot;Bug nnn - Testing my extension&quot; testing/profiles/common/extensions/my-extension.xpi
</code></pre>
<p>Push to Try:</p>
<pre><code class="language-bash">./mach try -p linux64,macosx64,win64 -b do -u none -t all --artifact
</code></pre>
<p>This will run Mozilla CI tests on all platforms</p>
<p>Note that you must have Level 1 commit access to use tryserver. If you are interested in interacting with Mozilla CI from Github (which only requires users to be in the Mozilla GitHub org), check out the <a href="https://github.com/biancadanforth/taskcluster-integration-poc/">Taskcluster Integration proof-of-concept</a>.</p>
<p>Also note that this requires an investment time to set up just as CircleCI or Travis-CI would, so it's not really appropriate for short-term projects. Use tryserver directly instead.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/client_guidelines.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#telemetry-events-best-practices" id="telemetry-events-best-practices">Telemetry Events Best Practices</a></h1>
<h2><a class="header" href="#overview-2" id="overview-2">Overview:</a></h2>
<p><a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/events.html">The Telemetry Events API</a> allows users to define and record events in the browser.</p>
<p>Events are defined in <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/events.html#the-yaml-definition-file"><code>Events.yaml</code></a> and each events creates records with the following properties:</p>
<ul>
<li>timestamp</li>
<li>category</li>
<li>method</li>
<li>object</li>
<li>value</li>
<li>extra</li>
</ul>
<p>With the following restrictions and features:</p>
<ul>
<li>The category, method, and object properties of any record produced by an event must have a value.</li>
<li>All combinations of values from the category, method, and object properties must be unique to that particular event (no other event can produce events with the same combination).</li>
<li>Events can be 'turned on' or 'turned off' by it's category value. i.e. we can instruct the browser to &quot;stop sending us events from the <code>devtools</code> category.&quot;</li>
</ul>
<p>These records are then stored in <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/data/event-ping.html">event pings</a> and available in the <a href="https://docs.telemetry.mozilla.org/datasets/batch_view/events/reference.html">events dataset</a>.</p>
<h2><a class="header" href="#identifying-events" id="identifying-events">Identifying Events</a></h2>
<p>One challenge with this data is it can be difficult to identify all the records from a particular event.
Unlike Scalars and Histograms, which keep data in individual locations (like <code>scalar_parent_browser_engagement_total_uri_count</code> for <a href="https://searchfox.org/mozilla-central/rev/501eb4718d73870892d28f31a99b46f4783efaa0/toolkit/components/telemetry/Scalars.yaml#204"><code>total_uri_count</code></a>), all event records are stored together, regardless of which event generated them. The records themselves don't have a field identifying which event produced it[1].</p>
<p>Take, for example, the <a href="https://searchfox.org/mozilla-central/rev/501eb4718d73870892d28f31a99b46f4783efaa0/toolkit/components/telemetry/Events.yaml#151"><code>manage</code></a>
event in the <code>addonsManager</code> category.</p>
<pre><code>addonsManager: # category
  manage: # event name
    description: &gt;
      ...
    objects: [&quot;extension&quot;, &quot;theme&quot;, &quot;locale&quot;, &quot;dictionary&quot;, &quot;other&quot;] # object values
    methods: [&quot;disable&quot;, &quot;enable&quot;, &quot;sideload_prompt&quot;, &quot;uninstall&quot;] # method values
    extra_keys: # extra values
      ...
    notification_emails: ...
    expiry_version: ...
    record_in_processes: ...
    bug_numbers: ...
    release_channel_collection: ...
</code></pre>
<p>This event will produce records that look like:</p>
<table><thead><tr><th>timestamp</th><th>category</th><th>method</th><th>object</th><th>value</th><th>extra</th></tr></thead><tbody>
<tr><td>...</td><td><code>addonsManager</code></td><td><code>install</code></td><td><code>extension</code></td><td></td><td>...</td></tr>
<tr><td>...</td><td><code>addonsManager</code></td><td><code>update</code></td><td><code>locale</code></td><td></td><td>...</td></tr>
<tr><td>...</td><td><code>addonsManager</code></td><td><code>sideload_prompt</code></td><td><code>other</code></td><td></td><td>...</td></tr>
</tbody></table>
<p>But none of these records will indicate that it was produced by the <code>manage</code> event. To find all records produced by <code>manage</code>, one would have to query all records where</p>
<pre><code>category = ...
AND method in [...,]
AND object in [...,]
</code></pre>
<p>which is not ideal.</p>
<p>Furthermore, if one encounters this data without knowledge of how the <code>manage</code> event works, they need to look up the event based on the category, method, and object values in order to find the event, and then query the data again to find all the related events. It's not immediately clear from the data if this record:</p>
<table><thead><tr><th>timestamp</th><th>category</th><th>method</th><th>object</th><th>value</th><th>extra</th></tr></thead><tbody>
<tr><td>...</td><td><code>addonsManager</code></td><td><code>update</code></td><td><code>locale</code></td><td></td><td>...</td></tr>
</tbody></table>
<p>and and this record:</p>
<table><thead><tr><th>timestamp</th><th>category</th><th>method</th><th>object</th><th>value</th><th>extra</th></tr></thead><tbody>
<tr><td>...</td><td><code>addonsManager</code></td><td><code>install</code></td><td><code>extension</code></td><td></td><td>...</td></tr>
</tbody></table>
<p>are related or not.</p>
<p>Another factor that can add to confusion is the fact that other events can share similar values for methods or objects (or even the combination of method and object). For example:</p>
<table><thead><tr><th>timestamp</th><th>category</th><th>method</th><th>object</th><th>value</th><th>extra</th></tr></thead><tbody>
<tr><td>...</td><td><code>normandy</code></td><td><code>update</code></td><td><code>preference_rollout</code></td><td></td><td>...</td></tr>
</tbody></table>
<p>which can further confuser users.</p>
<p>[1]: Events do have name fields, but they aren't included in the event records and thus are not present in the resulting dataset. Also, If a user defines an event in <code>Events.yaml</code> without specifying a list of acceptable methods, the method will default to the name of the event for records created by that event.</p>
<h4><a class="header" href="#suggested-convention" id="suggested-convention">Suggested Convention:</a></h4>
<p>To simplify things in the future, we suggest adding the event name to the category field using dot notation when designing new events:</p>
<pre><code>&quot;category.event_name&quot;
</code></pre>
<p>For example:</p>
<ul>
<li><code>&quot;navigation.search&quot;</code></li>
<li><code>&quot;addonsManager.manage&quot;</code></li>
<li><code>&quot;frame.tab&quot;</code></li>
</ul>
<p>This provides 3 advantages:</p>
<ol>
<li>Records produced by this event will be easily identifiable. Also, the event which produced the record will be easier to locate in the code.</li>
<li>Events can be controlled more easily. The category field is what we use to &quot;turn on&quot; and &quot;turn off&quot; events. By creating a 1 to 1 mapping between categories and events, we can control events on an individual level.</li>
<li>By having the category field act as the event identifier, it makes it easier to pass on events to Amplitude and other platforms.</li>
</ol>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/events_best_practices.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#sending-a-custom-ping" id="sending-a-custom-ping">Sending a Custom Ping</a></h1>
<p>Got some new data you want to send to us? How in the world do you send a new ping? Follow this guide
to find out.</p>
<p><strong>Note</strong>: Most new data collection in Firefox via Telemetry or Glean does not require creating a new
ping document type. To add a histogram, scalar, or event collection to Firefox, please see the
documentation on <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/start/adding-a-new-probe.html">adding a new
probe</a>.</p>
<h2><a class="header" href="#write-your-questions" id="write-your-questions">Write Your Questions</a></h2>
<p>Do not try and implement new pings unless you know specifically what questions you're trying to
answer. General questions about &quot;How do users use our product?&quot; won't cut it - these need to be
specific, concrete asks that can be translated to data points. This will also make it easier down
the line as you start data review.</p>
<p>More detail on how to design and implement new pings for Firefox Desktop <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/custom-pings.html">can be found
here</a>.</p>
<h2><a class="header" href="#choose-a-namespace-and-doctype" id="choose-a-namespace-and-doctype">Choose a Namespace and DocType</a></h2>
<p>Choose a namespace that uniquely identifies the product that will be generating the data. The
<code>telemetry</code> namespace is reserved for pings added by the Firefox Desktop Telemetry team.</p>
<p>The DocType is used to differentiate pings within a namespace. It can be as simple as <code>event</code>, but
should generally be descriptive of the data being collected.</p>
<p>Both namespace and DocType are limited to the pattern <code>[a-z-]</code>. In other words, hyphens and
lowercase letters from the <a href="https://en.wikipedia.org/wiki/ISO_basic_Latin_alphabet">ISO basic Latin alphabet</a>.</p>
<h2><a class="header" href="#create-a-schema" id="create-a-schema">Create a Schema</a></h2>
<p>Write a JSON Schema. See the <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas#adding-a-new-schema">&quot;Adding a new schema&quot;
documentation</a> and
examples schemas in the <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/">Mozilla Pipeline Schemas
repo</a>. This schema is used to
validate the incoming data; any ping that doesn't match the schema will be removed. This schema will
also be transformed into a BigQuery table schema via the <a href="https://github.com/mozilla/mozilla-schema-generator">Mozilla Schema
Generator</a>. Note that parquet schemas are no
longer necessary because of the generated schemas. Validate your JSON Schema using a <a href="https://jsonschemalint.com/#/version/draft-04/markup/json">validation
tool</a>.</p>
<h2><a class="header" href="#start-a-data-review" id="start-a-data-review">Start a Data Review</a></h2>
<p>Data review for new pings is often more complicated than adding new probes. See <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1347266">Data Review for
Focus-Event Ping</a> as an example.
Consider where the data falls under the
<a href="https://wiki.mozilla.org/Firefox/Data_Collection">Data Collection Categories</a>.</p>
<h2><a class="header" href="#submit-schema-to-mozilla-servicesmozilla-pipeline-schemas" id="submit-schema-to-mozilla-servicesmozilla-pipeline-schemas">Submit Schema to <code>mozilla-services/mozilla-pipeline-schemas</code></a></h2>
<p>Create a pull request including both a template and rendered schema to <code>mozilla-pipeline-schemas</code>.
Add at least one validation ping that exercises the structure of schema as a test.
These pings are validated during the build and help catch mistakes during the writing process.</p>
<h3><a class="header" href="#example-a-rendered-schema-for-response-times" id="example-a-rendered-schema-for-response-times">Example: A rendered schema for response times</a></h3>
<p>Imagine we want to collect a set of response measurements in milliseconds on a per-client basis.
The pings take on the following shape:</p>
<pre><code class="language-json">{&quot;id&quot;: &quot;08317b11-85f7-4688-9b35-48af10c3ccdf&quot;, &quot;clientId&quot;: &quot;1d5ce2fc-a554-42f0-ab21-2ad8ada9bb88&quot;, &quot;payload&quot;: {&quot;response_ms&quot;: 324}}
{&quot;id&quot;: &quot;a97108ac-483b-40be-9c64-3419326f5113&quot;, &quot;clientId&quot;: &quot;3f1b2e1c-c241-464f-aa46-576f5795e488&quot;, &quot;payload&quot;: {&quot;response_ms&quot;: 221}}
{&quot;id&quot;: &quot;b8a7e3f9-38c0-4a13-b42a-c969feb454f6&quot;, &quot;clientId&quot;: &quot;14f27409-5f6f-46e0-9f9d-da5cd716ee42&quot;, &quot;payload&quot;: {&quot;response_ms&quot;: 549}}
</code></pre>
<p>This document can be described in the following way:</p>
<pre><code class="language-json">{
  &quot;$schema&quot;: &quot;http://json-schema.org/draft-04/schema#&quot;,
  &quot;type&quot;: &quot;object&quot;,
  &quot;properties&quot;: {
    &quot;id&quot;: {
      &quot;type&quot;: &quot;string&quot;,
      &quot;description&quot;: &quot;The document identifier&quot;
    },
    &quot;clientId&quot;: {
      &quot;type&quot;: &quot;string&quot;,
      &quot;description&quot;: &quot;The client identifier&quot;
    },
    &quot;payload&quot;: {
      &quot;type&quot;: &quot;object&quot;,
      &quot;properties&quot;: {
        &quot;response_ms&quot;: {
          &quot;type&quot;: &quot;integer&quot;,
          &quot;minimum&quot;: 0,
          &quot;description&quot;: &quot;Response time of the client, in milliseconds&quot;
        }
      }
    }
  }
}
</code></pre>
<p>Fields like <code>id</code> and <code>clientId</code> have template components as part of the build-system. These would be
included as <code>@TELEMETRY_ID_1_JSON@</code> and <code>@TELEMETRY_CLIENTID_1_JSON@</code> respectively. The best way to
become familiar with template schemas is to browse the repository; the
<a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/blob/master/templates/telemetry/main/main.4.schema.json"><code>telemetry/main/main.4.schema.json</code>
document</a>
a good starting place.</p>
<p>As part of the automated deployment process, the JSON schemas are translated into a table schema
used by BigQuery. These schemas closely reflect the schemas used for data validation.</p>
<pre><code class="language-json">[
  {
    &quot;mode&quot;: &quot;NULLABLE&quot;,
    &quot;name&quot;: &quot;clientId&quot;,
    &quot;type&quot;: &quot;STRING&quot;
  },
  {
    &quot;mode&quot;: &quot;NULLABLE&quot;,
    &quot;name&quot;: &quot;id&quot;,
    &quot;type&quot;: &quot;STRING&quot;
  },
  {
    &quot;fields&quot;: [
      {
        &quot;mode&quot;: &quot;NULLABLE&quot;,
        &quot;name&quot;: &quot;response_ms&quot;,
        &quot;type&quot;: &quot;INT64&quot;
      }
    ],
    &quot;mode&quot;: &quot;NULLABLE&quot;,
    &quot;name&quot;: &quot;payload&quot;,
    &quot;type&quot;: &quot;RECORD&quot;
  }
]
</code></pre>
<h3><a class="header" href="#ingestion-metadata" id="ingestion-metadata">Ingestion Metadata</a></h3>
<p>The generated schemas contain metadata added to the schema before deployment to the ingestion
service. These are fields added to the ping at ingestion time; they might come from the URL
submitted to the edge server, or the IP Address used to make the request. <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/blob/master/schemas/metadata/telemetry-ingestion/telemetry-ingestion.1.schema.json">This
document</a>
lists available metadata fields for the telemetry-ingestion pings, which are largely shared across
all namespaces.</p>
<p>A list of metadata fields are included here for reference, but refer to the above document or the
schema explorer for an up-to-date list of metadata fields.</p>
<!-- table generated via `scripts/new_ping_metadata_table.py > src/cookbooks/new_ping_metadata_table.md` -->
<table><thead><tr><th>field</th><th>description</th></tr></thead><tbody>
<tr><td><code>additional_properties</code></td><td>A JSON string containing any payload properties not present in the schema</td></tr>
<tr><td><code>document_id</code></td><td>The document ID specified in the URI when the client sent this message</td></tr>
<tr><td><code>normalized_app_name</code></td><td>Set to &quot;Other&quot; if this message contained an unrecognized app name</td></tr>
<tr><td><code>normalized_channel</code></td><td>Set to &quot;Other&quot; if this message contained an unrecognized channel name</td></tr>
<tr><td><code>normalized_country_code</code></td><td>An ISO 3166-1 alpha-2 country code</td></tr>
<tr><td><code>normalized_os</code></td><td>Set to &quot;Other&quot; if this message contained an unrecognized OS name</td></tr>
<tr><td><code>normalized_os_version</code></td><td>N/A</td></tr>
<tr><td><code>sample_id</code></td><td>Hashed version of client_id (if present) useful for partitioning; ranges from 0 to 99</td></tr>
<tr><td><code>submission_timestamp</code></td><td>Time when the ingestion edge server accepted this message</td></tr>
<tr><td><code>metadata.user_agent.browser</code></td><td>N/A</td></tr>
<tr><td><code>metadata.user_agent.os</code></td><td>N/A</td></tr>
<tr><td><code>metadata.user_agent.version</code></td><td>N/A</td></tr>
<tr><td><code>metadata.uri.app_build_id</code></td><td>N/A</td></tr>
<tr><td><code>metadata.uri.app_name</code></td><td>N/A</td></tr>
<tr><td><code>metadata.uri.app_update_channel</code></td><td>N/A</td></tr>
<tr><td><code>metadata.uri.app_version</code></td><td>N/A</td></tr>
<tr><td><code>metadata.header.date</code></td><td>Date HTTP header</td></tr>
<tr><td><code>metadata.header.dnt</code></td><td>DNT (Do Not Track) HTTP header</td></tr>
<tr><td><code>metadata.header.x_debug_id</code></td><td>X-Debug-Id HTTP header</td></tr>
<tr><td><code>metadata.header.x_pingsender_version</code></td><td>X-PingSender-Version HTTP header</td></tr>
<tr><td><code>metadata.geo.city</code></td><td>City name</td></tr>
<tr><td><code>metadata.geo.country</code></td><td>An ISO 3166-1 alpha-2 country code</td></tr>
<tr><td><code>metadata.geo.db_version</code></td><td>The specific <a href="https://dev.maxmind.com/geoip/geoip2/geoip2-city-country-csv-databases/">Geo database</a> version used for this lookup</td></tr>
<tr><td><code>metadata.geo.subdivision1</code></td><td>First major country subdivision, typically a state, province, or county</td></tr>
<tr><td><code>metadata.geo.subdivision2</code></td><td>Second major country subdivision; not applicable for most countries</td></tr>
<tr><td><code>metadata.isp.db_version</code></td><td>The specific <a href="https://dev.maxmind.com/geoip/geoip2/geoip2-isp-csv-database/">ISP database</a> version used for this lookup</td></tr>
<tr><td><code>metadata.isp.name</code></td><td>The name of the Internet Service Provider</td></tr>
<tr><td><code>metadata.isp.organization</code></td><td>The name of a specific business entity when available; otherwise the ISP name</td></tr>
</tbody></table>
<h3><a class="header" href="#testing-the-schema" id="testing-the-schema">Testing The Schema</a></h3>
<p>For new data, use the <a href="https://github.com/mozilla-services/edge-validator">edge validator</a> to test
your schema.</p>
<h2><a class="header" href="#deployment" id="deployment">Deployment</a></h2>
<p>Schemas are automatically deployed once a day around 00:00 UTC, scheduled after the probe scraper in
the following <a href="https://github.com/mozilla/telemetry-airflow/blob/master/dags/probe_scraper.py">Airflow
DAG</a>. The latest
schemas can be viewed at
<a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/tree/generated-schemas"><code>mozilla-pipeline-schemas/generated-schemas</code></a>.</p>
<h2><a class="header" href="#start-sending-data" id="start-sending-data">Start Sending Data</a></h2>
<p>Use the built-in Telemetry APIs when possible. A few examples are the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/custom-pings.html">Gecko Telemetry
APIs</a>,
or the <a href="https://github.com/mozilla-mobile/telemetry-ios">iOS Telemetry APIs</a>.</p>
<p><strong>Users on Android should use <a href="cookbooks/../concepts/glean/glean.html">Glean</a></strong>, which does not require building out custom pings.</p>
<p>For all other use-cases, send documents to the ingestion endpoint:</p>
<pre><code class="language-text">https://incoming.telemetry.mozilla.org
</code></pre>
<p>See <a href="cookbooks/../concepts/pipeline/http_edge_spec.html">the HTTP edge server specification</a> for documentation
about the expected format.</p>
<h2><a class="header" href="#access-your-data" id="access-your-data">Access Your Data</a></h2>
<p>First confirm with the reviewers of <a href="cookbooks/new_ping.html#submit-schema-to-mozilla-servicesmozilla-pipeline-schemas">your schema pull
request</a> that your schemas have been
deployed. You may also check the diff of the latest commit to <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/tree/generated-schemas"><code>mozilla-pipeline-schemas/generated schemas</code></a>.</p>
<p>In the following links, replace <code>&lt;namespace&gt;</code>, <code>&lt;doctype&gt;</code> And <code>&lt;docversion&gt;</code> with appropriate
values. Also replace <code>-</code> with <code>_</code> in <code>&lt;namespace&gt;</code> if your namespace contains <code>-</code> characters.</p>
<h3><a class="header" href="#stmo--bigquery" id="stmo--bigquery">STMO / BigQuery</a></h3>
<p>In the <code>Telemetry (BigQuery)</code> data source, several new tables will be created for your data.</p>
<p>The first table is the <code>live</code> table found under
<code>moz-fx-data-shared-prod.&lt;namespace&gt;_live.&lt;doctype&gt;_v&lt;docversion&gt;</code>. This table is updated on a 5
minute interval, partitioned on <code>submission_timestamp</code>, and may contain partial days of data.</p>
<pre><code class="language-sql">SELECT
    count(*) AS n_rows
FROM
  `moz-fx-data-shared-prod.telemetry_live.main_v4`
WHERE
  submission_timestamp &gt; TIMESTAMP_SUB(current_timestamp, INTERVAL 30 minute)
</code></pre>
<p>The second table that is created is the <code>stable</code> clustered table (and corresponding view) under
<code>moz-fx-data-shared-prod.&lt;namespace&gt;.&lt;doctype&gt;</code>. This view will only contain complete
days of submissions. The data is clustered by <code>normalized_channel</code> and <code>sample_id</code> to improve the
efficiency of queries.</p>
<pre><code class="language-sql">SELECT
  COUNT(DISTINCT client_id)*100 AS dau
FROM
  `moz-fx-data-shared-prod.telemetry.main`
WHERE
  submission_timestamp &gt; TIMESTAMP_SUB(current_timestamp, INTERVAL 1 day)
  AND sample_id = 1
</code></pre>
<p>This table may take up to a day to appear in the BigQuery source; if you still don't see a table for
your new ping after 24 hours, <a href="https://mana.mozilla.org/wiki/display/SVCOPS/Contacting+Data+Operations">contact Data
Operations</a> so that they
can investigate. Once the table is available, it should contain all the pings sent during that first
day, regardless of how long it takes for the table to appear.</p>
<h3><a class="header" href="#spark-1" id="spark-1">Spark</a></h3>
<p>Refer to the <a href="cookbooks/../cookbooks/bigquery/access.html#from-spark">Spark notes</a> for details on accessing the data
via Spark.</p>
<h2><a class="header" href="#build-dashboards-using-spark-or-stmo" id="build-dashboards-using-spark-or-stmo">Build Dashboards Using Spark or STMO</a></h2>
<p>Last steps! What are you using this data for anyway?</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/cookbooks/new_ping.md">Edit this file on GitHub.</a></footer><h3><a class="header" href="#data-platform-reference" id="data-platform-reference">Data Platform Reference</a></h3>
<p>This section contains detailed reference material on the Mozilla data platform, including links to other resources where appropriate.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/reference/index.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#guiding-principles-for-data-infrastructure" id="guiding-principles-for-data-infrastructure">Guiding Principles for Data Infrastructure</a></h1>
<p>So you want to build a data lake... Where do you start? What building blocks are
available? How can you integrate your data with the rest of the organization?</p>
<p>This document is intended for a few different audiences. Data consumers within
Mozilla will gain a better understanding of the data they interact with by
learning how the Firefox telemetry pipeline functions. Mozilla teams outside of
Firefox will get some concrete guidance about how to provision and lay out data
in a way that will let them integrate with the rest of Mozilla. Technical
audiences outside Mozilla will learn some general principles and come away with
links to concrete examples of code implementing those principles.</p>
<p>Considering that Mozilla has chosen GCP as its major cloud provider, BigQuery
stands out as the clear integration point for data at rest among GCP's portfolio
of products. BigQuery has proven to be a best-in-class data warehouse with
impressive performance and a familiar SQL interface. Beyond that, it provides
many conveniences that become important when scaling across an organization such
as automated retention policies and well-defined access controls that can be
provisioned across projects to allow different teams to have control over their
own data.</p>
<p>Data can be loaded into BigQuery or presented as external tables through a
growing list of Google-provided integrations (objects in GCS, logs in
Stackdriver, etc.). Users within Mozilla can also take advantage of
purpose-built infrastructure that other teams within the company have used for
loading data to BigQuery. The major example is our telemetry ingestion system
which accepts payloads from Firefox clients across the world but also provides a
generic interface for defining custom schemas and accepting payloads from any
system capable of making an HTTP request. We also have tooling available for
transforming data (ETL) once it's in BigQuery.</p>
<p>Once data is accessible through BigQuery, users within Mozilla also get the
benefit of leveraging common tools for data access. Beyond the Google-provided
BigQuery console, Mozilla provides access to instances of Redash,
Tableau, and other tools either with connections to BigQuery already available
or with concrete instructions for provisioning connections.</p>
<p>Some near real-time use cases can be handled via BigQuery as well, with BigQuery
supporting dozens of batch loads per table per hour and even streaming inserts.
For true latency-sensitive applications, however, we pass data via Cloud
Pub/Sub, GCP's hosted messaging backend. Pub/Sub integrates very closely with
Cloud Dataflow to provide auto-scaling pipelines with relatively little setup
needed. We can also easily provision topics for subsets of data flowing through
the telemetry pipeline as input for custom streaming applications.</p>
<p>To avoid getting too abstract, we'll next dive into a case study of what it
looked like for a team within Mozilla to migrate from a custom pipeline to the
main GCP-based pipeline that supports telemetry data. From there, we'll discuss
specific best practice recommendations for use of each of the major GCP services
in use at Mozilla.</p>
<h2><a class="header" href="#integrating-with-the-data-pipeline-a-case-study" id="integrating-with-the-data-pipeline-a-case-study">Integrating with the Data Pipeline: A Case Study</a></h2>
<p>Mozilla's core data platform has been built to support <em>structured ingestion</em> of
arbitrary JSON payloads whether they come from browser products on client
devices or from server-side applications that have nothing to do with Firefox;
any team at Mozilla can hook into structured ingestion by defining a schema and
registering it with pipeline. Once a schema is registered, everything else is
automatically provisioned, from an HTTPS endpoint for accepting payloads to a
set of tables in BigQuery for holding the processed data.</p>
<p>Over the course of 2019, the Activity Stream team migrated analytics for Firefox
Desktop's New Tab page from a custom service to the core data platform. The old
system already relied on sending JSON data over HTTP, so the team wanted to
minimize client-side development effort by maintaining the existing payload
structure. They registered the structure of these payloads by sending pull
requests to our schema repository with relevant <a href="https://json-schema.org/">JSON
Schema</a> definitions. As an example,
<a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/pull/228"><code>mozilla-pipeline-schemas#228</code></a>
adds a new document namespace <code>activity-stream</code> and under that a document type
<code>impression-stats</code> with version specified as <code>1</code>. These changes are picked up by
an automated job that translates them into relevant BigQuery schemas and
provisions tables for each unique schema (see
<a href="tools/guiding_principles.html#defining-tables">Defining Tables</a> below).</p>
<p>With the schema now registered with the pipeline, clients can send payloads to
an endpoint corresponding to the new namespace, document type, and version:</p>
<pre><code>https://incoming.telemetry.mozilla.org/submit/activity-stream/impression-stats/1/&lt;document_id&gt;
</code></pre>
<p>where <code>&lt;document_id&gt;</code> should be a UUID that uniquely identifies the payload;
<code>document_id</code> is used within the pipeline for deduplication of repeated
documents. The payload is processed by a small edge service that returns a 200
response to the client and publishes the message to a <em>raw</em> Pub/Sub topic. A
<em>decoder</em> Dataflow job reads from this topic with low latency, validates that
the payload matches the schema registered for the endpoint, does some additional
metadata processing, and then emits the message back to Pub/Sub in a <em>decoded</em>
topic. A final job reads the <em>decoded</em> topic, batches together records
destined for the same table, and loads the records into the relevant <em>live ping
table</em> in BigQuery (<code>activity_stream_live.impression_stats_v1</code> in this case). A
nightly job reads all records for the previous day from the live ping table,
deduplicates the records based on <code>document_id</code> values, and loads the final
deduplicated day to the relevant <em>historical ping table</em>
(<code>activity_stream_stable.impression_stats_v1</code>). The results are automatically
presented to users through a view (<code>activity_stream.impression_stats</code>).</p>
<p>While most analysis use cases for this data are served via queries on the
user-facing BigQuery view, the Pocket team also needed to build an application
with access to <code>activity-stream</code> messages in real-time. To serve that need,
Pocket provisioned a Pub/Sub topic in a separate GCP project and worked with
Data Operations to provide write access to a relevant service account within the
telemetry pipeline. The pipeline is now configured to republish all messages
associated with the <code>activity-stream</code> namespace to Pocket's topic, and this has
been able to serve their real-time needs.</p>
<h2><a class="header" href="#glean-2" id="glean-2">Glean</a></h2>
<p>While the Activity Stream case study above serves as an encouraging example of
the flexibility of the pipeline to accept custom payloads, we hope to insulate
most data producers in the future from having to interact directly with HTTP
requests and JSON Schema definitions at all. The state of the art for analytics
at Mozilla is
<a href="tools/../concepts/glean/glean.html">Glean</a>, a set of
projects that reimagines the end-to-end experience of reporting and consuming
analytics data.</p>
<p>Glean sits on top of structured ingestion, but provides helpful
abstractions — instead of building JSON payloads and making HTTP requests, your
application declares logical metrics and makes calls to a generated SDK
idiomatic to your application's language. Support is emerging not only for a
wide range of language SDKs, but also for a variety of prebuilt reporting tools
that understand Glean schemas such that your application's metrics are
automatically processed and presented.</p>
<p>All new use cases for producing analytics payloads within Mozilla should
consider Glean first. If a mature Glean SDK is available for your project's
language, building on top of Glean promises maintainable reporting code for your
application and data that can be more richly understood by the full ecosystem of
analytics tools at Mozilla.</p>
<h2><a class="header" href="#structured-ingestion" id="structured-ingestion">Structured Ingestion</a></h2>
<p>We discussed the overall shape of Mozilla's structured ingestion system and how
to integrate with it in the case study earlier in this article, so this section
will be brief.</p>
<p>When you choose to build on top of structured ingestion, whether
using the Glean SDK or by registering custom named schemas, consider the
following concerns which are automatically handled for you:</p>
<ul>
<li>Validation of payloads against a JSON schema; messages failing validation are
routed to an errors table in BigQuery where they can be monitored and
backfilled if necessary.</li>
<li>Geo lookup using a GeoIP database; geo-city information is
presented as metadata, allowing the pipeline to discard source IP addresses to
protect user privacy.</li>
<li>User agent parsing; major user agent features are extracted and presented as
metadata, allowing the pipeline to discard the raw user agent string to
protect user privacy.</li>
<li>Extraction of client-level identifiers as metadata to use for generating a
<a href="https://docs.telemetry.mozilla.org/concepts/sample_id.html"><code>sample_id</code></a> field
and to support automated deletion of data upon user request.</li>
<li>Deduplication of messages; we provide best-effort deduplication for output
Pub/Sub topics and full deduplication within each UTC day in the historical
ping tables in BigQuery.</li>
</ul>
<p>If you have doubts about whether structured ingestion is appropriate for your
use case, <a href="https://docs.telemetry.mozilla.org/concepts/getting_help.html">please reach out to the Data Platform
team</a> and we can
consult on current and planned features for the pipeline.</p>
<h2><a class="header" href="#bigquery-1" id="bigquery-1">BigQuery</a></h2>
<p><a href="https://cloud.google.com/bigquery/docs/">BigQuery</a> is the standard choice within
Mozilla's environment for storing structured data for non-real time analysis. It
is especially well suited to large and diverse organizations because of its access
controls and full separation between storage and compute infrastructure. Different
teams within Mozilla can provision BigQuery tables in separate GCP projects,
retaining full control over how they ingest data and how they grant access to
other teams. Once access is granted, though, it becomes trivial to write queries
that join data across projects.</p>
<p>The per-GB pricing for storing data in BigQuery is identical to pricing for GCS,
so BigQuery can in some ways be treated as an advanced filesystem that has deep
knowledge of and control over data structure. Be aware that while BigQuery
compresses data under the hood, pricing reflects the uncompressed data size and
users have no view into how data is compressed. It is still possible, however,
to use BigQuery as an economical store for compressed data by saving compressed
blobs in a <code>BYTES</code> column. Additional fields can be used like metadata. For
examples, see the <em>raw</em> schema from the pipeline
(<a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/blob/80386c53b8e6910068964bd7c09904326b9480fd/schemas/metadata/raw/raw.1.schema.json">JSON schema</a>
and final
<a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/blob/43edf3ffff932eb89f3e2a1092696d0d0081c43b/schemas/metadata/raw/raw.1.bq">BigQuery schema</a>).</p>
<h3><a class="header" href="#defining-tables" id="defining-tables">Defining tables</a></h3>
<p>BigQuery tables can express complex nested structures via compound <code>STRUCT</code>
types and <code>REPEATED</code> fields. It's possible to model arbitrary JSON payloads as
BigQuery tables, but there are
<a href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-json#limitations">limitations to JSON modeling</a>
that are well-described in BigQuery's documentation.</p>
<p>We have developed tooling for translating JSON schemas into BigQuery table
schemas along with some conversion code to transform payloads to match the final
structure needed in BigQuery. One major example is map types; when the number of
possible keys is finite, they can be baked into the schema to present the map as
a BigQuery <code>STRUCT</code> type, but free-form maps have to be modeled in BigQuery as a
repeated <code>STRUCT</code> of keys and values. This is one case where we have chosen to
follow the same conventions that BigQuery itself uses for <a href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-avro#complex_types">converting complex
Avro types to BigQuery
fields</a>,
which requires modifying the JSON payload to convert</p>
<pre><code class="language-json">{
  &quot;key1&quot;: &quot;value1&quot;,
  &quot;key2&quot;: &quot;value2&quot;
}
</code></pre>
<p>into</p>
<pre><code class="language-json">[
  {
    &quot;key&quot;: &quot;key1&quot;,
    &quot;value&quot;: &quot;value1&quot;
  },
  {
    &quot;key&quot;: &quot;key2&quot;,
    &quot;value&quot;: &quot;value2&quot;
  }
]
</code></pre>
<p>For more detail on how the data pipeline prepares schemas and translates
payloads, see the
<a href="https://github.com/mozilla/jsonschema-transpiler"><code>jsonschema-transpiler</code></a>
project which is used by
<a href="https://github.com/mozilla/mozilla-schema-generator/"><code>mozilla-schema-generator</code></a>.</p>
<h3><a class="header" href="#how-to-get-data-into-bigquery" id="how-to-get-data-into-bigquery">How to get data into BigQuery</a></h3>
<p>Google provides a variety of methods for loading data into BigQuery as discussed
in their <a href="https://cloud.google.com/bigquery/docs/loading-data">Introduction to Loading
Data</a>. The traditional path
for loading data is a custom application that uses a Google Cloud SDK to stage
objects in GCS and then issue BigQuery load jobs, but there is also a growing
list of more fully managed integrations for loading data. It is also possible to
present views into data stored in other Google services without loading via
external tables.</p>
<p>If you already have well-structured data being produced to Stackdriver or GCS,
it may be minimal effort to set up BigQuery Transfer Service to import that data
or even to modify your existing server application to additionally issue
BigQuery load jobs. Google does not yet provide an integration with Cloud SQL,
but there has been significant interest within Mozilla for that feature and we
may look into providing a standard solution for ingesting Cloud SQL databases to
BigQuery in 2020.</p>
<p>And don't forget about the possibility of hooking into the core telemetry
pipeline through <em>structured ingestion</em> as discussed earlier.</p>
<p>If you have a more complex processing need that doesn't fit into an existing
server application, you may want to consider building your application as a
Dataflow pipeline (discussed further down in this document). Dataflow provides a
unified model for batch and streaming processing and includes a variety of
high-level I/O modules for reading from and writing to Google services such as
BigQuery.</p>
<h3><a class="header" href="#time-based-partitioning-and-data-retention-in-bigquery" id="time-based-partitioning-and-data-retention-in-bigquery">Time-based partitioning and data retention in BigQuery</a></h3>
<p>BigQuery provides built-in support for <a href="https://cloud.google.com/bigquery/docs/best-practices-storage">rolling time-based retention at the
dataset and table
level</a>. For the
telemetry pipeline, we have chosen to partition nearly all of our tables based
on the date we receive the payloads at our edge servers. Most tables will
contain a field named <code>submission_timestamp</code> or <code>submission_date</code> that
BigQuery automatically uses to control the assignment of rows to partitions as
they are loaded.</p>
<p>Full day partitions are the fundamental unit we use for all backfill and ETL
activities and BigQuery provides convenient support for operating on discrete
partitions. In particular, BigQuery jobs can be configured to specify an
individual partition as the destination for output (using a partition decorator
looks like <code>telemetry_stable.main_v4$20191201</code>), allowing processing to be
idempotent.</p>
<p>Partitions can also be used as the unit for data retention. For the telemetry
pipeline, we have long retention periods only for the <em>historical ping tables</em>
(e.g. <code>telemetry_stable.main_v4</code>) and downstream derived tables (e.g.
<code>telemetry_derived.clients_daily_v6</code>). Storing intermediate data for long periods
can be expensive and expose risk, so all of the intermediate tables including the
<em>live ping tables</em> (e.g. <code>telemetry_live.main_v4</code>) have partition-based expiration
such that partitions older than 30 days are automatically cleaned up. This
policy balances cost efficiency with the need for a window where we can recover
from errors in the pipeline.</p>
<p>The telemetry pipeline is building support for accepting <code>deletion-request</code> pings
from users and purging rows associated with those users via scheduled jobs. Such
a mechanism can be helpful in addressing policy and business requirements, so
the same considerations should be applied to custom applications storing
messages that contain user identifiers.</p>
<h3><a class="header" href="#access-controls-in-bigquery" id="access-controls-in-bigquery">Access controls in BigQuery</a></h3>
<p>BigQuery provides 3 levels for organizing data: <em>tables</em> live within <em>datasets</em>
inside <em>projects</em>. Fully qualified table references look like
<code>&lt;project&gt;.&lt;dataset&gt;.&lt;table&gt;</code>; a query that references
<code>moz-fx-data-shared-prod.telemetry_live.main_v4</code> is looking for a table named
<code>main_v4</code> in a dataset named <code>telemetry_live</code> defined in GCP project
<code>moz-fx-data-shared-prod</code>.</p>
<p>At the time of writing, BigQuery's access controls primarily function at the
dataset level, which has implications for how you choose to name tables and
group them into datasets. If all of your data can use the same access policy,
then a single dataset is sufficient and can hold all of your tables, but you may
still choose to use multiple datasets for logical organization of related
tables.</p>
<p>You can also publish SQL views which are essentially prebuilt queries that are
presented alongside tables in BigQuery. View logic is executed at query time, so
views take up no space and users are subject to the same access controls when
querying a view as they would be querying the underlying tables themselves; a
query will fail if the user does not have read access to all of the datasets
accessed in the view.</p>
<p>Views, however, can also be <em>authorized</em> so that specific groups of users can
run queries who would not normally be allowed to read the underlying tables.
This allows view authors to provide finer-grained controls and to hide specific
columns or rows.</p>
<h2><a class="header" href="#pubsub" id="pubsub">Pub/Sub</a></h2>
<p><a href="https://cloud.google.com/pubsub/docs/">Google Cloud Pub/Sub</a> is the standard
choice within Mozilla's environment for transferring data between systems in
real-time. It shares many of the same benefits as BigQuery in terms of being
fully hosted, scalable, and well-integrated with the rest of the GCP environment,
particularly when it comes to access controls.</p>
<p>We use Pub/Sub as the messaging backbone for the telemetry ingestion system and
we can easily provision new Pub/Sub topics containing republished subsets of the
telemetry data for other systems to hook into. We have support for either
producing messages into an external topic controlled by a different team or for
provisioning a new topic within the telemetry infrastructure and granting read
access to individual service accounts as needed.</p>
<p>Pub/Sub is the clear integration point with the telemetry system for any
application that is concerned with up-to-the-minute latency. For applications
that only need to see periodic recent views of telemetry data, be aware that
<em>live ping tables</em> (i.e. <code>telemetry_live.main_v4</code>) in BigQuery are also an option.
New data is loaded into those tables throughout the day either on a 10 minute
cadence or as they arrive via streaming inserts to BigQuery. Please contact us
if there's a subset of data you'd like us to consider opting in for streaming
inserts.</p>
<h2><a class="header" href="#dataflow" id="dataflow">Dataflow</a></h2>
<p><a href="https://cloud.google.com/dataflow/docs/">Google Cloud Dataflow</a> is a service
for running data processing applications using the Apache Beam SDKs in both
batch and streaming modes. Understanding the Beam programming model requires
a certain amount of developer investment, but Beam provides powerful abstractions
for data transformations like windowed joins that are difficult to implement
reliably by hand.</p>
<p>The Dataflow jobs in use by the data platform actually don't require complex
joins or windowing features, but we have found Beam's I/O abstractions useful
for being able to adapt a single code base to handle reading from and writing to
a variety of data stores. Dataflow also provides good built-in support for
auto-scaling streaming jobs based on latency and observed throughput, especially
when interacting with Pub/Sub. That said, the I/O abstractions allow only
limited control over performance and we have found the need to replace some of
our Dataflow jobs with custom applications running on GKE — particularly
the jobs focused on batching together messages from Pub/Sub and sinking to GCS
or BigQuery.</p>
<p>Beam's <code>BigQueryIO</code> module requires shuffling data several times when writing,
checkpointing the intermediate state to local disk. This incurs expense for
provisioning local solid state drives to handle the checkpointing throughput and
introduces the possibility of data loss on unclean shutdown since messages have
to be acknowledged back to Pub/Sub at the time data is first checkpointed rather
than when it is finally written to BigQuery. We were able to achieve lower cost
and more straight-forward delivery guarantees by writing a custom application
using the Google Cloud Java SDK. We still use a streaming Dataflow job for the
<em>decoder</em> step of the pipeline since no checkpointing is needed for a simple job
that both reads from and writes to Pub/Sub. We also rely on Dataflow batch jobs
for all backfill activities.</p>
<p>If your team has streaming needs where Dataflow makes sense, be aware that the
Data Operations team can provide operational support to help you launch and
manage pipelines.</p>
<h2><a class="header" href="#derived-data-and-airflow" id="derived-data-and-airflow">Derived Data and Airflow</a></h2>
<p>The structure in which data is ingested to BigQuery is often not the most
convenient or efficient structure for analysis queries, so it is often necessary
to provide logical views of the data to support users. Our interface for
defining such views is the
<a href="https://github.com/mozilla/bigquery-etl"><code>bigquery-etl</code></a> repository which
provides instructions for how to propose new tables and views by sending pull
requests containing SQL queries.</p>
<p>We use BigQuery <em>views</em> heavily to improve the usability of raw data and we
recommend that you do too! As discussed in the
<a href="tools/guiding_principles.html#access-controls-in-bigquery">BigQuery Access Controls</a> section above,
views take up no storage resources and are essentially reusable snippets
that appear like tables, but the underlying logic is executed every time a user
queries a view. For simple cases like renaming fields or unnesting array
columns, a view is often the right choice as it can be defined once and requires
no ongoing scheduling or maintenance.</p>
<p>If, however, you want to provide users with a view that involves joins or
aggregations that hit a great deal of data, you may find that queries slow down
and become expensive. In those cases, it may be better to materialize the
results of the view into a derived table. See the <a href="https://docs.telemetry.mozilla.org/cookbooks/bigquery-airflow.html">Scheduling BigQuery Queries
in Airflow</a>
cookbook for a walk-through of how to define a query in <code>bigquery-etl</code> and
get it scheduled to run nightly on the data platform's Airflow instance. We hope
to simplify that process in 2020 and provide better support for being able to
access and write data in arbitrary GCP projects rather than just in the data
pipeline's <code>shared-prod</code> project.</p>
<h2><a class="header" href="#final-thoughts" id="final-thoughts">Final Thoughts</a></h2>
<p>While no single data architecture can meet all needs, the core pipeline at
Mozilla has been built with flexibility in mind. We have a growing list of
success cases and some major projects in the works to migrate legacy pipelines
to the system — these are good indicators that we are meeting a broad set of
needs for the majority data warehousing use case and that we provide a stable
ingestion system for streaming applications as well.</p>
<p>GCP's roster of services is fairly well-focused compared to other cloud
providers, but it can still be overwhelming to sort through the available
options, particularly where multiple services seem to occupy the same space.
Consult the unofficial <a href="https://grumpygrace.dev/posts/gcp-flowcharts/">GCP
flowcharts</a> for a broad view of
how to sort through the features of services that apply to different problem
domains. We encourage the use of BigQuery, Pub/Sub, and Dataflow as core
building blocks for custom data applications across Mozilla for ease of access
control across projects and for leveraging shared knowledge about how to operate
and integrate with those services. Possibilities in the cloud can seem endless,
but the more we can standardize architectural approaches across the company, the
better prepared we will be to collaborate across product teams and ultimately
the better positioned we will be to realize our mission. Let's work together to
keep individuals empowered, safe, and independent on the Internet.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/tools/guiding_principles.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#glean-3" id="glean-3">Glean</a></h1>
<p>For Mozilla, getting reliable data from our products is critical to inform our decision making. Glean is our new product analytics &amp; telemetry solution that provides a consistent experience and behavior across all of our products.</p>
<p>The list of supported platforms and implementations is <a href="https://mozilla.github.io/glean/dev/core/internal/implementations.html">available in the Glean SDK Book</a>.</p>
<blockquote>
<p>Note that this is different from Telemetry for Firefox Desktop (<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/index.html">library</a>, <a href="concepts/glean/../choosing_a_dataset.html">datasets</a>), although it provides similar capabilities.</p>
</blockquote>
<p>Contents:</p>
<ul>
<li><a href="concepts/glean/glean.html#overview">Overview</a></li>
<li><a href="concepts/glean/glean.html#the-glean-design-principles">The Glean design principles</a></li>
<li><a href="concepts/glean/glean.html#how-to-use-glean">How to use Glean</a></li>
<li><a href="concepts/glean/glean.html#contact">Contact</a></li>
<li><a href="concepts/glean/glean.html#references">References</a></li>
</ul>
<h1><a class="header" href="#overview-3" id="overview-3">Overview</a></h1>
<p><img src="concepts/glean/../../assets/Glean_overview.jpg" alt="drawing" /></p>
<p>The <strong>Glean SDK</strong> performs measurements and sends data from our products.
It provides a set of <strong><a href="https://mozilla.github.io/glean/book/user/metrics">metric types</a></strong> for individual measurements that are carefully designed to avoid common pitfalls with measurement.
Metrics are then rolled up into <strong><a href="https://mozilla.github.io/glean/book/user/pings">pings</a></strong> to send over the network.
There are a number of built-in pings that are sent on predefined schedules, but it also possible to send custom pings at any desired cadence.</p>
<p>The <strong>Data Platform</strong> validates and stores these pings in database tables.
A fault tolerant design allows data to be retained in the event of problems such as traffic spikes or invalid data.
Derived and cleaned data can also be automatically created at this stage.</p>
<p>The <strong>Analysis Tools</strong> are used to query and visualize the data.
Because Glean knows more about the individual data, such as its type and the ranges of acceptable values, it can in many cases provide the most appropriate visualization automatically.</p>
<!-- TODO: Link to GLAM -->
<h1><a class="header" href="#the-glean-design-principles" id="the-glean-design-principles">The Glean design principles</a></h1>
<p><strong>Provide a consistent base of telemetry</strong></p>
<p>A baseline of analysis is important for all our products, from counting active users to retention and session times. This is supported out-of-the-box by the SDK, and funnels directly into visualization tools like the <a href="https://gud.telemetry.mozilla.org/">Growth and Usage Dashboard (GUD)</a>.</p>
<p>Metrics that are common to all products, such as the operating system and architecture, are provided automatically in a consistent way.</p>
<p>Any issues found with these base metrics only need be fixed in Glean to benefit all SDK-using products.</p>
<p><strong>Encourage specificity</strong></p>
<p>Rather than just treating metrics as generic data points, Glean wants to know as much as possible about the things being measured, and be opinionated about how data is measured and aggregated.</p>
<p>From this information, it can:</p>
<ul>
<li>Provide a well-designed API to perform specific types of measurements, which is consistent and avoids common pitfalls</li>
<li>Reject invalid data, and report them as errors</li>
<li>Store the data in a consistent way, rather than custom, ad hoc data structures</li>
<li>Provide the most appropriate visualization and analysis automatically</li>
</ul>
<p>A side-effect of this design is that Glean telemetry is write-only: it would be impossible to enforce all of these constraints and achieve all of these benefits if client code could read, modify and update data.</p>
<p><strong>Follow <a href="https://leandatapractices.com/">lean data practices</a></strong></p>
<p>The Glean system enforces that all measurements received <a href="https://wiki.mozilla.org/Firefox/Data_Collection">data review</a>, and it is impossible to collect measurements that haven't been declared.
It also makes it easy to limit data collection to only what's necessary:</p>
<ul>
<li>Enforced expiration dates for every metric</li>
<li>Some metric types can automatically limit resolution</li>
<li>It's easy to send data that isn't associated with the client id</li>
</ul>
<p>Glean also supports data transparency by automatically generating documentation for all of the metrics sent by an application.</p>
<p><strong>Provide a self-serve experience</strong></p>
<p>Adding new metric is designed to be as easy as possible.
Simply by adding a few lines of configuration, everything to make them work across the entire suite of tools happens automatically.
This includes previously manual and error-prone steps such as updating the ping payload and database schemas.</p>
<h1><a class="header" href="#how-to-use-glean" id="how-to-use-glean">How to use Glean</a></h1>
<ul>
<li>
<p><a href="https://mozilla.github.io/glean/book/user/adding-glean-to-your-project.html">Integrate the Glean SDK / library</a> into your product.</p>
</li>
<li>
<p><a href="https://sql.telemetry.mozilla.org/">Use Redash</a> to write SQL queries &amp; build dashboards using your products datasets, e.g.:</p>
<ul>
<li><code>org_mozilla_fenix.baseline</code></li>
<li><code>org_mozilla_fenix.events</code></li>
<li><code>org_mozilla_fenix.metrics</code></li>
<li>There is <a href="concepts/glean/accessing_glean_data.html">more documentation about accessing Glean data</a>.</li>
</ul>
</li>
<li>
<p><em>(Work in progress)</em> Use events and <a href="https://sso.mozilla.com/amplitude">Amplitude</a> for product analytics.</p>
</li>
<li>
<p>For experimentation, you can use <a href="https://github.com/mozilla-mobile/android-components/blob/master/components/service/experiments/README.md">Android experiments library</a>, which integrates with Glean.</p>
</li>
</ul>
<h1><a class="header" href="#contact" id="contact">Contact</a></h1>
<ul>
<li><code>#glean</code> on slack</li>
<li><a href="https://chat.mozilla.org/#/room/#glean:mozilla.org">#glean:mozilla.org</a> on matrix</li>
<li><a href="mailto:glean-team@mozilla.com"><code>glean-team@mozilla.com</code></a> to reach out</li>
</ul>
<h1><a class="header" href="#references" id="references">References</a></h1>
<ul>
<li>The <a href="https://github.com/mozilla/glean/">Glean SDK</a> implementation.</li>
<li><a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Data%20Platform%20and%20Tools&amp;component=Glean%3A%20SDK">Reporting issues &amp; bugs for the Glean SDK</a>.</li>
<li>Datasets documentation (TBD)</li>
<li><a href="https://debug-ping-preview.firebaseapp.com/">Glean Debug pings viewer</a></li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/glean/glean.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#an-overview-of-mozillas-data-pipeline" id="an-overview-of-mozillas-data-pipeline">An overview of Mozilla’s Data Pipeline</a></h1>
<p>This post describes the architecture of Mozilla’s data pipeline,
which is used to collect Telemetry data from our products and logs from various services.</p>
<p>The bulk of the data handled by this pipeline is Firefox Telemetry data, but the
same tool-chain is used to collect, store, and analyze data coming from many
sources, including <a href="concepts/pipeline/../glean/glean.html">Glean</a> applications.</p>
<p>Here is a simplified diagram of how data is ingested into the data warehouse.</p>
<p>The code for the ingestion pipeline lives in the <a href="https://github.com/mozilla/gcp-ingestion"><code>gcp-ingestion</code></a> repository.</p>
<pre class="mermaid">graph TD

f1(fa:fa-firefox Firefox) --&gt;|HTTP Post| d0(fa:fa-filter Ingestion Edge)
d0 --&gt; p1(fa:fa-stream Raw Topic)
p1 --&gt; d1(fa:fa-exchange-alt Landfill Sink)
d1 --&gt; b1(fa:fa-database Landfill BQ)
p1 --&gt; d2(fa:fa-exchange-alt Decoder)
d2 --&gt;|success| p2(fa:fa-stream Decoded Topic)
d2 -.-&gt;|fail| p3(fa:fa-stream Errors Topic)
p3 --&gt; d4(fa:fa-exchange-alt Errors Sink)
p2 --&gt; d3(fa:fa-exchange-alt BigQuery Sink)
d3 --&gt; b2(fa:fa-database Live Tables BQ)
d4 --&gt; b3(fa:fa-database Error Tables BQ)

classDef pubsub fill:#eff,stroke:#099;
classDef exec fill:#efe,stroke:#090;
classDef producers fill:#fee,stroke:#f90;
classDef bq fill:#ececff,stroke:#9370db;
class p1,p2,p3 pubsub
class d0,d1,d2,d3,d4 exec
class f1 producers
class b1,b2,b3 bq
</pre>
<h2><a class="header" href="#firefox" id="firefox">Firefox</a></h2>
<p>There are different APIs and formats to <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/index.html">collect data</a> in Firefox, all suiting different use cases:</p>
<ul>
<li><a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/histograms.html">histograms</a> – for recording multiple data points;</li>
<li><a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/scalars.html">scalars</a> – for recording single values;</li>
<li><a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/measuring-time.html">timings</a> – for measuring how long operations take;</li>
<li><a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/events.html">events</a> – for recording time-stamped events.</li>
</ul>
<p>These are commonly referred to as <em><a href="concepts/pipeline/../../datasets/new_data.html">probes</a></em>.
Each probe must declare the <a href="https://wiki.mozilla.org/Firefox/Data_Collection">collection policy</a> it conforms to: either <em>release</em> or <em>prerelease</em>.
When adding a new measurement data-reviewers carefully inspect the probe and eventually approve the requested collection policy:</p>
<ul>
<li>Release data is collected from all Firefox users.</li>
<li>Prerelease data is collected from users on Firefox Nightly and Beta channels.</li>
</ul>
<p>Users may choose to turn the data collection off in preferences.</p>
<p>A <em>session</em> begins when Firefox starts up and ends when it shuts down.
As a session could be long-running and last weeks, it gets sliced into
smaller logical units called <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/concepts/sessions.html#subsessions">subsessions</a>.
Each subsession generates a batch of data containing the current state
of all probes collected so far, in the form of a [<code>main</code> ping], which is
sent to our servers.
The <code>main</code> ping is just one of the many <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/concepts/pings.html#ping-types">ping types</a> we support.
Developers can <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/custom-pings.html">create their own ping types</a> if needed.</p>
<p><em>Pings</em> are submitted via an <a href="https://searchfox.org/mozilla-central/rev/501eb4718d73870892d28f31a99b46f4783efaa0/toolkit/components/telemetry/app/TelemetryController.jsm#231">API</a> that performs a HTTP POST request to our edge servers.
If a ping fails to successfully <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/concepts/submission.html#submission">submit</a> (e.g. because of missing internet connection),
Firefox will store the ping on disk and retry to send it until the maximum ping age is exceeded.</p>
<h2><a class="header" href="#ingestion-1" id="ingestion-1">Ingestion</a></h2>
<p>Submissions coming in from the wild hit a load balancer and then an
HTTP Server that <a href="concepts/pipeline/http_edge_spec.html">accepts POST requests</a> containing a
message body of optionally-gzipped JSON.</p>
<p>These messages are forwarded to a PubSub message queue with minimal processing,
and made available in a <strong>Raw</strong> topic.</p>
<p>A <a href="https://cloud.google.com/dataflow/docs/">Dataflow</a> job reads this topic and writes the raw messages to a BigQuery <strong>Landfill</strong> sink.
This Landfill data is not used for analysis, but is stored in its raw form for
recovery and backfill purposes.</p>
<p>If there is a processing error or data-loss downstream in the pipeline, this is an important fail-safe.</p>
<h2><a class="header" href="#decoding" id="decoding">Decoding</a></h2>
<p>Once the raw data has been added to the PubSub queue, it's time to process it.</p>
<p>The decoder is implemented as a <a href="https://cloud.google.com/dataflow/docs/">Dataflow</a> job, and is written in Java.</p>
<p>The decoding process tackles decompression, parsing, validation, deduplication,
and enrichment of incoming messages.</p>
<p>After a message is decompressed and parsed as JSON, we apply <a href="https://json-schema.org/understanding-json-schema/">JSONSchema validation</a>
to ensure that submissions are well-formed.</p>
<p>Sometimes duplicate submissions are sent to the pipeline, either due to normal
networking failures or <a href="https://chuttenblog.wordpress.com/2017/05/02/data-science-is-hard-anomalies-part-2/">weird behaviour</a> out there in the world.
We watch for duplicate submissions, and discard any subsequent occurrences of
already-seen records.</p>
<p>Submissions are also enriched with some metadata about the request itself,
including things like HTTP headers, GeoIP information, and submission timestamp.</p>
<p>Messages that pass <em>successfully</em> through all these steps are written to another
PubSub <strong>Decoded</strong> topic.</p>
<p>A failure in any of these steps results in messages being sent to the <strong>Errors</strong> sink.
This separates invalid data from valid data, while still making it available for
monitoring and debugging.
This is a good way to keep an eye on the health of the pipeline and the data
flowing through.</p>
<h2><a class="header" href="#data-warehouse" id="data-warehouse">Data Warehouse</a></h2>
<p>Decoded data is ultimately written out to BigQuery, which acts as the data warehouse.</p>
<p>By this time, incoming data has already been validated against the corresponding
JSONSchema specification for each document type.
Part of the decoding process above transforms this JSON structure into something
more easily represented in BigQuery.
One important transformation here is to convert all incoming fields from
<code>UPPER CASE</code> or <code>camelCase</code> to <code>snake_case</code>.
Another important transformation is to incorporate metadata about known probes
and metrics to generate more complete schemas.</p>
<p>This is handled by a combination of the decoder above, the <a href="https://github.com/mozilla/jsonschema-transpiler">schema transpiler</a>
and the <a href="https://github.com/mozilla/mozilla-schema-generator">schema generator</a>.
The result are tables that contains SQL-friendly field names for all known
measures, as implemented in the <a href="https://github.com/mozilla/probe-scraper">probe scraper</a>.</p>
<p>A <a href="https://cloud.google.com/dataflow/docs/">Dataflow</a> job reads from the Decoded topic and writes out to
<strong><a href="concepts/pipeline/../../cookbooks/bigquery/querying.html#table-layout-and-naming">live ping tables</a></strong>.
These tables are updated frequently, and typically reflect data within a few
minutes of it being ingested. They are optimized for accessing recent data,
but are only guaranteed to contain a few days of history.</p>
<p>Historical raw ping data is stored in <strong><a href="concepts/pipeline/../../cookbooks/bigquery/querying.html#table-layout-and-naming">historical ping tables</a></strong>,
also known as <strong>stable tables</strong>.
These tables include only completed days of data, are populated once a day
shortly after midnight UTC.
Data in the Stable tables is partitioned by day, and optimized for accessing
larger time periods. It is also optimized for limiting analysis to a fraction
of the data using the <a href="concepts/pipeline/../channels/channel_normalization.html"><code>normalized_channel</code></a> and <a href="concepts/pipeline/../sample_id.html"><code>sample_id</code></a> fields.</p>
<h1><a class="header" href="#beyond-the-data-warehouse" id="beyond-the-data-warehouse">Beyond the Data Warehouse</a></h1>
<p>The diagram above shows the path data takes to get into the data warehouse.
After that, we have to start using it!</p>
<h2><a class="header" href="#workflow-management-and-etl" id="workflow-management-and-etl">Workflow Management and ETL</a></h2>
<p>We use <a href="https://github.com/mozilla/telemetry-airflow/">Airflow</a> for workflow management.</p>
<p>It orchestrates the daily creation of the Stable tables described above,
as well as many other derived datasets.</p>
<p>The ETL code to create derived datasets is commonly implemented using queries in BigQuery.</p>
<p>Many examples can be found in the <a href="https://github.com/mozilla/bigquery-etl">bigquery-etl</a> repository.</p>
<p>Data in BigQuery is also accessible via Spark, and several ETL jobs also run via Dataproc.</p>
<p>These jobs produce data sets that are used for downstream analysis and data
applications (such as <a href="https://telemetry.mozilla.org/">measurement</a> and <a href="https://missioncontrol.telemetry.mozilla.org">stability</a> dashboards,
<a href="https://github.com/mozilla/taar">addon recommendation</a>, and other <a href="concepts/pipeline/../../tools/projects.html#data-applications">data products</a>).</p>
<h2><a class="header" href="#data-analysis" id="data-analysis">Data Analysis</a></h2>
<p>Once the data reaches our data warehouse in BigQuery it can be processed
in a number of ways as described in the <a href="concepts/pipeline/../../cookbooks/bigquery.html">Accessing BigQuery</a> article.</p>
<p>Data analysis is most commonly done using <a href="https://sql.telemetry.mozilla.org/">SQL queries</a> or using <a href="concepts/pipeline/../../tools/spark.html">Spark</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/pipeline/gcp_data_pipeline.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#http-edge-server-specification" id="http-edge-server-specification">HTTP Edge Server Specification</a></h1>
<p>This document specifies the behavior of the server that accepts submissions from
any HTTP client e.g. Firefox telemetry.</p>
<p>The original implementation of the HTTP Edge Server was tracked in
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1129222">Bug 1129222</a>.</p>
<h2><a class="header" href="#general-data-flow" id="general-data-flow">General Data Flow</a></h2>
<p>HTTP submissions come in from the wild, hit a load balancer,
then the HTTP Edge Server described in this document.
Data is accepted via a POST/PUT request from clients,
and forwarded to the <a href="concepts/pipeline/gcp_data_pipeline.html">Data Pipeline</a>, where
any further processing, analysis, and storage will be handled.</p>
<p>Submission payloads are expected to be optionally-gzipped JSON
documents described by a <a href="https://json-schema.org/">JSONSchema</a>.</p>
<h2><a class="header" href="#server-requestresponse" id="server-requestresponse">Server Request/Response</a></h2>
<h3><a class="header" href="#get-request" id="get-request">GET Request</a></h3>
<p>Accept GET on <code>/status</code>, returning <code>OK</code> if all is well. This can be used to
check the health of web servers.</p>
<h3><a class="header" href="#get-response-codes" id="get-response-codes">GET Response codes</a></h3>
<ul>
<li><em>200</em> - OK. <code>/status</code> and all's well</li>
<li><em>404</em> - Any GET other than <code>/status</code></li>
<li><em>500</em> - All is not well</li>
</ul>
<h3><a class="header" href="#postput-request" id="postput-request">POST/PUT Request</a></h3>
<p>Treat POST and PUT the same. Accept POST or PUT to URLs of the form:</p>
<p><code>/submit/&lt;namespace&gt;/&lt;docType&gt;/&lt;docVersion&gt;/&lt;docId&gt;</code></p>
<p>A specific example submission URL looks like:</p>
<p><code>/submit/eng-workflow/hgpush/1/2c3a0767-d84a-4d02-8a92-fa54a3376049</code></p>
<p>With the following components:</p>
<ul>
<li><code>namespace</code> - an identifier used for grouping a set of related document types. Typically this represents an application that produces data.</li>
<li><code>docType</code> - a short descriptive name of the document type. Examples include <code>event</code>, <code>crash</code>, or <code>baseline</code></li>
<li><code>docVersion</code> - a numeric value indicating the version of the schema for this <code>docType</code></li>
<li><code>docId</code> - a UUID identifying the exact submission. If the same <code>docId</code> is seen more than once, it will be discarded as a duplicate.</li>
</ul>
<p>The combination of <code>namespace</code>, <code>docType</code> and <code>docVersion</code> together identify a specific schema to be used for validating submissions to the above endpoint.</p>
<p>If a schema is not present in the [schemas repository] corresponding to this combination, the submission
will be considered an error and will not proceed to the data lake.</p>
<h4><a class="header" href="#special-handling-for-firefox-desktop-telemetry" id="special-handling-for-firefox-desktop-telemetry">Special handling for Firefox Desktop Telemetry</a></h4>
<p>Firefox Desktop Telemetry uses a slightly different URL scheme:</p>
<p><code>/submit/telemetry/docId/docType/appName/appVersion/appUpdateChannel/appBuildID?v=4</code></p>
<p>A specific example:</p>
<p><code>/submit/telemetry/ce39b608-f595-4c69-b6a6-f7a436604648/main/Firefox/61.0a1/nightly/20180328030202?v=4</code></p>
<p>Here the <code>namespace</code> is fixed as &quot;telemetry&quot;, and there is no <code>docVersion</code> in the URL.
This means that incoming JSON documents must be parsed to determine the schema version
to apply for validation. This logic is part of the downstream [decoder] job.
Also note the required query parameter suffix <code>?v=4</code>.
Documents sent under <code>/submit/telemetry</code> without <code>v=4</code> will be rejected at the edge.</p>
<h3><a class="header" href="#postput-response-codes" id="postput-response-codes">POST/PUT Response codes</a></h3>
<ul>
<li><em>200</em> - OK. Request accepted into the pipeline.</li>
<li><em>400</em> - Bad request, for example an un-encoded space in the URL.</li>
<li><em>404</em> - not found - POST/PUT to an unknown namespace</li>
<li><em>405</em> - wrong request type (anything other than POST/PUT)</li>
<li><em>411</em> - missing content-length header</li>
<li><em>413</em> - request body too large (Note that if we have badly-behaved clients that retry on <code>4XX</code>, we may opt to send back 202 on body/path too long).</li>
<li><em>414</em> - request path too long (See above)</li>
<li><em>500</em> - internal error</li>
</ul>
<h3><a class="header" href="#supported-http-headers" id="supported-http-headers">Supported HTTP Headers</a></h3>
<p>The following headers will be passed through the pipeline and made available as metadata.</p>
<ul>
<li><code>Date</code> - The client-supplied timestamp of the incoming request.
Used for computing client clock skew.</li>
<li><code>DNT</code> - The &quot;Do Not Track&quot; header.</li>
<li><code>X-PingSender-Version</code> - The version of <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/internals/pingsender.html">Pingsender</a> used to send this ping (if applicable).</li>
<li><code>X-Debug-ID</code> - An optional tag used to make data available to the [Glean Debug View].</li>
<li><code>X-Source-Tags</code> - An optional comma-separated list of tags related to the client source; pings sent from automated testing should include the &quot;automation&quot; tag so that they are not included in analyses</li>
</ul>
<h2><a class="header" href="#other-considerations-1" id="other-considerations-1">Other Considerations</a></h2>
<h3><a class="header" href="#compression" id="compression">Compression</a></h3>
<p>Compression of submission payloads is optional but recommended.</p>
<p>The supported compression scheme is <code>gzip</code>.</p>
<p>We do not decompress or validate the content of submissions at the edge,
the server will reply with a success code even if a message is badly formed.</p>
<p>Badly formed data is still accepted and made available for monitoring, recovery,
analysis, and analysis purposes.</p>
<h3><a class="header" href="#bad-messages" id="bad-messages">Bad Messages</a></h3>
<p>Since the actual message is not examined by the edge server the only failures
that occur are defined by the response status codes above. Messages are only
forwarded to the pipeline when a response code of <code>200</code> is returned to the client.</p>
<h3><a class="header" href="#geoip-lookups" id="geoip-lookups">GeoIP Lookups</a></h3>
<p>No GeoIP lookup is performed by the edge server. If a client IP is available the
the decoder performs the lookup and then discards the IP before the message hits
long-term storage.</p>
<h3><a class="header" href="#data-retention" id="data-retention">Data Retention</a></h3>
<p>The edge server only stores data while waiting for it to be accepted to
PubSub, spilling to local disk in the case of a PubSub outage.</p>
<p>This means that in the normal case, data is not retained on the edge at all.
In the case of errors writing to PubSub, data is retained until the service
is restored and messages can be flushed to the queue.
Based on <a href="https://status.cloud.google.com/incident/cloud-pubsub">past outages</a>, this is typically a few hours or less.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/pipeline/http_edge_spec.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#event-data-pipeline" id="event-data-pipeline">Event Data Pipeline</a></h1>
<p>We collect event-oriented data from different sources. This data is collected and processed in a
specific path through our data pipeline, which we will detail here.</p>
<pre class="mermaid">graph TD

subgraph Products
fx_code(fa:fa-cog Firefox code) --&gt; firefox(fa:fa-firefox Firefox Telemetry)
fx_extensions(fa:fa-cog Mozilla extensions) --&gt; firefox
mobile(fa:fa-cog Mobile products) --&gt; mobile_telemetry(fa:fa-firefox Mobile Telemetry)
end

subgraph Data Platform
firefox -.-&gt;|main ping, Firefox &lt;62| pipeline((fa:fa-database Firefox Data Pipeline))
firefox --&gt;|event ping, Firefox 62+| pipeline
mobile_telemetry --&gt; |mobile events ping| pipeline
pipeline --&gt;|Firefox &lt;62 events| main_summary[fa:fa-bars main summary table]
pipeline --&gt;|Firefox 62+ events| events_table[fa:fa-bars events table]
main_summary --&gt; events_table
pipeline --&gt;|Mobile events| mobile_events_table[fa:fa-bars mobile events table]
end

subgraph Data Tools
events_table --&gt; redash
mobile_events_table --&gt; redash
main_summary --&gt; redash(fa:fa-bar-chart Redash)
pipeline --&gt;|on request| amplitude(fa:fa-bar-chart Amplitude)
end

style fx_code fill:#f94,stroke-width:0px
style fx_extensions fill:#f94,stroke-width:0px
style mobile fill:#f94,stroke-width:0px
style firefox fill:#f61,stroke-width:0px
style mobile_telemetry fill:#f61,stroke-width:0px
style pipeline fill:#79d,stroke-width:0px
style main_summary fill:lightblue,stroke-width:0px
style events_table fill:lightblue,stroke-width:0px
style mobile_events_table fill:lightblue,stroke-width:0px
style redash fill:salmon,stroke-width:0px
style amplitude fill:salmon,stroke-width:0px
</pre>
<h1><a class="header" href="#overview-4" id="overview-4">Overview</a></h1>
<p>Across the different Firefox teams there is a common need for a more fine grained understanding of
product usage, like understanding the order of interactions or how they occur over time.
To address that our data pipeline needs to support working with event-oriented data.</p>
<p>We specify a common event data format, which allows for broader, shared usage of data processing tools.
To make working with event data feasible, we provide different mechanisms to get the event data
from products to our data pipeline and make the data available in tools for analysis.</p>
<h1><a class="header" href="#the-event-format" id="the-event-format">The event format</a></h1>
<p>Events are submitted as an array, e.g.:</p>
<pre><code class="language-javascript">[
  [2147, &quot;ui&quot;, &quot;click&quot;, &quot;back_button&quot;],
  [2213, &quot;ui&quot;, &quot;search&quot;, &quot;search_bar&quot;, &quot;google&quot;],
  [
    2892,
    &quot;ui&quot;,
    &quot;completion&quot;,
    &quot;search_bar&quot;,
    &quot;yahoo&quot;,
    { querylen: &quot;7&quot;, results: &quot;23&quot; },
  ],
  [5434, &quot;dom&quot;, &quot;load&quot;, &quot;frame&quot;, null, { prot: &quot;https&quot;, src: &quot;script&quot; }],
  // ...
];
</code></pre>
<p>Each event is of the form:</p>
<pre><code class="language-javascript">[timestamp, category, method, object, value, extra];
</code></pre>
<p>Where the individual fields are:</p>
<ul>
<li><code>timestamp</code>: <code>Number</code>, positive integer. This is the time in ms when the event was recorded, relative to the main process start time.</li>
<li><code>category</code>: <code>String</code>, identifier. The category is a group name for events and helps to avoid name conflicts.</li>
<li><code>method</code>: <code>String</code>, identifier. This describes the type of event that occurred, e.g. <code>click</code>, <code>keydown</code> or <code>focus</code>.</li>
<li><code>object</code>: <code>String</code>, identifier. This is the object the event occurred on, e.g. <code>reload_button</code> or <code>urlbar</code>.</li>
<li><code>value</code>: <code>String</code>, optional, may be null. This is a user defined value, providing context for the event.</li>
<li><code>extra</code>: <code>Object</code>, optional, may be null. This is an object of the form <code>{&quot;key&quot;: &quot;value&quot;, ...}</code>, both keys and values need to be strings. This is used for events when additional richer context is needed.</li>
</ul>
<p>See also the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/events.html#serialization-format">Firefox Telemetry documentation</a>.</p>
<h1><a class="header" href="#event-data-collection" id="event-data-collection">Event data collection</a></h1>
<h2><a class="header" href="#firefox-event-collection" id="firefox-event-collection">Firefox event collection</a></h2>
<p>To collect this event data in Firefox there are different APIs in Firefox, all addressing different
use cases:</p>
<ul>
<li>The <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/events.html"><em>Telemetry event API</em></a>
allows easy recording of events from Firefox code.</li>
<li>The <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/events.html#registerevents"><em>dynamic event API</em></a>
allows code from Mozilla addons to record new events into Telemetry without shipping Firefox
code.</li>
<li>The <em><a href="https://searchfox.org/mozilla-central/rev/55da592d85c2baf8d8818010c41d9738c97013d2/toolkit/components/extensions/schemas/telemetry.json#87">Telemetry WebExtension API</a></em> (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1280234">introduced here</a>)
which allows Mozilla extensions to record new events into Telemetry.</li>
</ul>
<p>For all these APIs, events will get sent to the pipeline through the
<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/event-ping.html">event ping</a>, which gets sent hourly, if any pings were recorded, or up to every 10 minutes whenever 1000 events were recorded.
Before Firefox 62, events were sent through the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/main-ping.html">main ping</a> instead, with a hard limit of 500 events per ping.
From Firefox 61, all events recorded through these APIs are <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1440673">automatically counted in scalars</a>.</p>
<p>Finally, <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/custom-pings.html"><em>custom pings</em></a>
can follow the event data format and potentially connect to the existing tooling with some integration work.</p>
<h2><a class="header" href="#mobile-event-collection" id="mobile-event-collection">Mobile event collection</a></h2>
<p>Mobile events data primarily flows through the mobile events ping (<a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/tree/master/schemas/telemetry/mobile-event">ping schema</a>), from e.g. <a href="https://github.com/mozilla-mobile/firefox-ios/wiki/Event-Tracking-with-Mozilla&#x27;s-Telemetry-Service#event-ping">Firefox iOS</a>, Firefox for Fire TV and Rocket.</p>
<p>Currently we also collect event data from Firefox Focus through the <a href="https://github.com/mozilla-mobile/focus-ios/wiki/Event-Tracking-with-Mozilla%27s-Telemetry-Service#event-ping"><code>focus-events</code> ping</a>,
using the <a href="https://github.com/mozilla-mobile/telemetry-ios"><code>telemetry-ios</code></a> and
<a href="https://github.com/mozilla-mobile/telemetry-android"><code>telemetry-android</code></a> libraries.</p>
<h1><a class="header" href="#datasets" id="datasets">Datasets</a></h1>
<p>On the pipeline side, the event data is made available in different datasets:</p>
<ul>
<li><a href="concepts/pipeline/../choosing_a_dataset.html#mainsummary"><code>main_summary</code></a> has a row for each main ping and includes
its event payload for Firefox versions before 62.</li>
<li><a href="concepts/pipeline/../../datasets/batch_view/events/reference.html"><code>events</code></a> contains a row for each event received from main pings and event pings. See <a href="https://sql.telemetry.mozilla.org/queries/52582/source">this sample query</a>.</li>
<li><code>telemetry_mobile_event_parquet</code> contains a row for each mobile event ping. See <a href="https://sql.telemetry.mozilla.org/queries/52581/source">this sample query</a>.</li>
<li><code>focus_events_longitudinal</code> currently contains events from Firefox Focus.</li>
</ul>
<h1><a class="header" href="#data-tooling" id="data-tooling">Data tooling</a></h1>
<p>The above datasets are all accessible through <a href="concepts/pipeline/../../tools/stmo.html">STMO</a> and <a href="concepts/pipeline/../../tools/spark.html">Spark jobs</a>.</p>
<p>For product analytics based on event data, we have <a href="https://sso.mozilla.com/amplitude">Amplitude</a>
(hosted by the IT data team). We can connect our event data sources data to Amplitude.
We have an active connector to Amplitude for mobile events, which can push event data over
daily. For Firefox Desktop events this will be available soon.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/pipeline/event_pipeline.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#generated-schemas" id="generated-schemas">Generated Schemas</a></h1>
<ul>
<li><a href="concepts/pipeline/schemas.html#overview">Overview</a></li>
<li><a href="concepts/pipeline/schemas.html#schema-deploys-faq">Schema deploys FAQ</a>
<ul>
<li><a href="concepts/pipeline/schemas.html#how-do-i-make-changes-to-a-schema">How do I make changes to a schema?</a></li>
<li><a href="concepts/pipeline/schemas.html#when-will-i-see-new-changes-to-the-schema">When will I see new changes to the schema?</a></li>
<li><a href="concepts/pipeline/schemas.html#what-does-it-mean-when-a-schema-deploy-is-blocked">What does it mean when a schema deploy is blocked?</a></li>
</ul>
</li>
<li><a href="concepts/pipeline/schemas.html#schema-repository">Schema Repository</a>
<ul>
<li><a href="concepts/pipeline/schemas.html#schema-transpiler">Schema Transpiler</a></li>
<li><a href="concepts/pipeline/schemas.html#mozilla-schema-generator">Mozilla Schema Generator</a></li>
</ul>
</li>
<li><a href="concepts/pipeline/schemas.html#data-ingestion">Data Ingestion</a>
<ul>
<li><a href="concepts/pipeline/schemas.html#validation">Validation</a></li>
<li><a href="concepts/pipeline/schemas.html#decoding">Decoding</a>
<ul>
<li><a href="concepts/pipeline/schemas.html#name-normalization">Name Normalization</a></li>
<li><a href="concepts/pipeline/schemas.html#data-structure-normalization">Data Structure Normalization</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="concepts/pipeline/schemas.html#deploying-to-bigquery">Deploying to BigQuery</a>
<ul>
<li><a href="concepts/pipeline/schemas.html#updating-generated-schemas">Updating generated-schemas</a></li>
<li><a href="concepts/pipeline/schemas.html#deploying-schemas-to-production">Deploying schemas to production</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#overview-5" id="overview-5">Overview</a></h2>
<p>Schemas describe the structure of ingested data. They are used in the pipeline to validate the types
and values of data, and to define a table schema in a data store. We use a repository of JSON
Schemas to sort incoming data into <a href="concepts/pipeline/../../cookbooks/bigquery/querying.html#projects-with-bigquery-datasets"><code>decoded</code> and <code>error</code> datasets</a>. We also generate
BigQuery table schemas on business days from the JSON Schemas: you can see the current status of
this job on the <a href="https://protosaur.dev/mps-deploys/"><code>mozilla-pipeline-schemas</code> deploy dashboard</a>.</p>
<pre class="mermaid">graph TD

%% Nodes
subgraph mozilla-pipeline-schemas
  master
  schemas(generated-schemas)
end

generator(mozilla-schema-generator)
transpiler(jsonschema-transpiler)
probe-info(probe-scraper)
airflow(telemetry-airflow)
ingestion(gcp-ingestion)
bigquery(BigQuery)

%% Node hyperlinks
click bigquery &quot;../../cookbooks/bigquery.html&quot;
click master &quot;https://github.com/mozilla-services/mozilla-pipeline-schemas&quot;
click schemas &quot;https://github.com/mozilla-services/mozilla-pipeline-schemas/tree/generated-schemas&quot;
click generator &quot;https://github.com/mozilla/mozilla-schema-generator&quot;
click transpiler &quot;https://github.com/mozilla/jsonschema-transpiler&quot;
click probe-info &quot;https://github.com/mozilla/probe-scraper&quot;
click ingestion &quot;https://mozilla.github.io/gcp-ingestion/ingestion-beam/&quot;
click airflow &quot;https://github.com/mozilla/telemetry-airflow&quot;


%% Edges
master --&gt; |git clone| generator
transpiler --&gt; |used by| generator
probe-info --&gt; |used by| generator
generator --&gt; |scheduled by| airflow
airflow --&gt; |run nightly| schemas

schemas --&gt; |defines table| bigquery
schemas --&gt; |defines is valid| ingestion
schemas --&gt; |defines normalization| ingestion
ingestion --&gt; |inserts into| bigquery
</pre>
<p><strong>Figure</strong>: <em>An overview of generated schemas. Click on a node to navigate to the relevant
repository or documentation.</em></p>
<h2><a class="header" href="#schema-deploys-faq" id="schema-deploys-faq">Schema deploys FAQ</a></h2>
<p>This section answers some basic questions about the schema deployment pipeline.</p>
<h3><a class="header" href="#how-do-i-make-changes-to-a-schema" id="how-do-i-make-changes-to-a-schema">How do I make changes to a schema?</a></h3>
<p>This is dependent on what application you are working on.</p>
<p>If you are working on Firefox Telemetry and are adding a new probe, then you don't have to do
anything. Changes are automatically picked up by the <a href="https://github.com/mozilla/probe-scraper"><code>probe-scraper</code></a> from the
<code>histograms.json</code> and <code>scalars.yaml</code> files in <code>mozilla-central</code>. Non-probe changes (for example,
modifications to the telemetry environment) will require you to make changes to
<a href="https://github.com/mozilla-services/mozilla-pipeline-schemas"><code>mozilla-pipeline-schemas</code></a>.</p>
<p>If you are working on an application using the <a href="concepts/pipeline/../glean/glean.html">Glean SDK</a>, then the
probe-scraper will automatically pick up changes from <code>metrics.yaml</code>.</p>
<h3><a class="header" href="#when-will-i-see-new-changes-to-the-schema" id="when-will-i-see-new-changes-to-the-schema">When will I see new changes to the schema?</a></h3>
<p>Schema deploys happen on business days around UTC+04 when new changes are found in the
<a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/tree/generated-schema"><code>generated-schemas</code> branch of <code>mozilla-pipeline-schemas</code></a>. This means that any
changes merged after UTC+04 on Friday will not propagate until Monday UTC+04. See the
<a href="https://protosaur.dev/mps-deploys/"><code>mozilla-pipeline-schemas</code> deploy</a> dashboard for up-to-date information on the most
recent deploys.</p>
<h3><a class="header" href="#what-does-it-mean-when-a-schema-deploy-is-blocked" id="what-does-it-mean-when-a-schema-deploy-is-blocked">What does it mean when a schema deploy is blocked?</a></h3>
<p>The schema deployment pipeline has a hard dependency on the [<code>probe-scraper</code>], a service that scours
repositories for new metrics to include in generated schemas. When the probe-scraper fails, it will
prevent the <a href="https://github.com/mozilla/mozilla-schema-generator"><code>mozilla-schema-generator</code></a> from running. If there are new changes to the main
branch of <code>mozilla-pipeline-schemas</code>, then they will not be added to the <code>generated-schemas</code> branch
until the failure has been resolved. Similarly, new probes and pings in either Telemetry or Glean
will not be picked up until the <code>probe-scraper</code> failures are resolved.</p>
<p>If a new schema field is not registered in the schema repository before collection begins, it will
be available in the <code>additional_properties</code> field of the generated table. If a new schema for a ping
is not registered before collection begins, then it will be sorted into the error stream. Please
<a href="concepts/pipeline/../reporting_a_problem.html">file a bug</a> or <a href="concepts/pipeline/../getting_help.html">reach out</a> if you believe your data
may be affected by blocked schema deploys.</p>
<h2><a class="header" href="#schema-repository" id="schema-repository">Schema Repository</a></h2>
<pre class="mermaid">graph LR

subgraph mozilla-pipeline-schemas
  subgraph origin/master
    templates --&gt;|cmake| schemas
  end

  subgraph origin/generated-schemas
    schemas --&gt;|mozilla-schema-generator| artifact(schemas)
  end
end
</pre>
<p><strong>Figure</strong>: <em>Template schemas are built locally to generate static JSON Schema. On a regular basis,
the Mozilla Schema Generator is run to generate BigQuery schemas.</em></p>
<p>Refer to <a href="concepts/pipeline/../../cookbooks/new_ping.html">Sending a Custom Ping</a> for an in-depth guide for adding new
schemas to the repository.</p>
<h3><a class="header" href="#schema-transpiler" id="schema-transpiler">Schema Transpiler</a></h3>
<p>The structure validated in JSON Schema can be mapped to BigQuery columns.
This is done by the <code>jsonschema-transpiler</code>, a Rust application for translating between schema formats.
<a href="concepts/pipeline/schemas.html#decoding">Data normalization as part of decoding</a> is required before inserting into BigQuery e.g. snake casing and type casting.
These workarounds are based transformations that are done when importing Avro into BigQuery.</p>
<pre class="mermaid">graph LR

%% nodes
subgraph input
  json(JSON Schemas)
end
subgraph output
  avro(Avro schemas)
  bigquery(BigQuery schemas)
end
transpiler[jsonschema-transpiler]

%% hyperlinks
click json &quot;https://json-schema.org/&quot;
click avro &quot;https://avro.apache.org/docs/current/spec.html&quot;
click bigquery &quot;https://cloud.google.com/bigquery/docs/schemas&quot;
click transpiler &quot;https://github.com/mozilla/jsonschema-transpiler&quot;

%% edges
json --&gt; transpiler
transpiler --&gt; avro
transpiler --&gt; bigquery
</pre>
<h3><a class="header" href="#mozilla-schema-generator" id="mozilla-schema-generator">Mozilla Schema Generator</a></h3>
<p>The schema generator will populate schemas with metadata and insert generated sub-schemas at certain paths.
It generates JSON Schemas that are translated into BigQuery schemas, but <em>not</em> used for validation.
It uses the probe information service to enumerate map-type fields.
These fields are converted into a structured column that can be accessed in BigQuery with <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators">Standard SQL</a>.
Metadata includes fields added during <a href="concepts/pipeline/schemas.html#data-ingestion">data ingestion</a> including fields like <code>submission_timestamp</code> and <code>sample_id</code>.</p>
<p>In addition to generating BigQuery schemas, schemas are aliased in several locations.
For example, the <code>first_shutdown</code> ping is a copy of the <code>main_ping</code>.
Schemas are also altered in the generator to accommodate various edge-cases in the data.
For example, a field that validates both boolean and integer types may be altered to assume a boolean type.</p>
<p>The main entry-point is a script that merges and generates <code>*.schema.json</code> under the <code>schemas</code> directory, then translates these to <code>*.bq</code>.
It commits the schema to the <code>generated-schemas</code> branch, with a change-log referencing commits in the <code>master</code> branch.</p>
<h2><a class="header" href="#data-ingestion" id="data-ingestion">Data Ingestion</a></h2>
<h3><a class="header" href="#validation" id="validation">Validation</a></h3>
<p>Data that fails validation is sent to the <code>payload_bytes_error</code> table. Each row contains an
information about the error that caused it, as well as the name of the job associated with it.</p>
<pre><code class="language-sql">SELECT
  document_namespace,
  document_type,
  document_version,
  error_message,
  error_type,
  exception_class,
  job_name
FROM
  `moz-fx-data-shared-prod`.payload_bytes_error.telemetry
WHERE
  submission_timestamp &gt; TIMESTAMP_SUB(current_timestamp, INTERVAL 1 hour)
  AND exception_class = 'org.everit.json.schema.ValidationException'
LIMIT 5
</code></pre>
<table><thead><tr><th>Column</th><th>Example Value</th><th>Notes</th></tr></thead><tbody>
<tr><td><code>document_namespace</code></td><td>telemetry</td><td></td></tr>
<tr><td><code>document_type</code></td><td>main</td><td></td></tr>
<tr><td><code>document_version</code></td><td>null</td><td>The version in the <code>telemetry</code> namespace is generated after validation</td></tr>
<tr><td><code>error_message</code></td><td><code>org.everit.json.schema.ValidationException: #/environment/system/os/version: #: no subschema matched out of the total 1 subschemas</code></td><td></td></tr>
<tr><td><code>error_type</code></td><td><code>ParsePayload</code></td><td>The <code>ParsePayload</code> type is associated with schema validation or corrupt data</td></tr>
<tr><td><code>exception_class</code></td><td><code>org.everit.json.schema.ValidationException </code></td><td>Java <a href="https://github.com/everit-org/json-schema">JSON Schema Validator</a> library</td></tr>
<tr><td><code>job_name</code></td><td><code>decoder-0-0121192636-9c56ac6a</code></td><td>Name of the Dataflow job that can be used to determine the version of the schema artifact</td></tr>
</tbody></table>
<h3><a class="header" href="#decoding-1" id="decoding-1">Decoding</a></h3>
<p>The BigQuery schemas are used to normalize relevant payload data and determine additional
properties. Normalization involves renaming field names and transforming certain types of data.
Snake casing is employed across all schemas and ensures a consistent querying experience. Some data
must be transformed before insertion, such as map-types (a.k.a. dictionaries in Python), due to
limitations in BigQuery data representation. Other data may not be specified in the schema, and
instead placed into a specially constructed column named <code>additional_properties</code>.</p>
<h4><a class="header" href="#name-normalization" id="name-normalization">Name Normalization</a></h4>
<p>A reference <a href="https://github.com/acmiyaguchi/test-casing/blob/master/src/main.py">Python
implementation</a> of the snake
casing algorithm is ensured to be compatible with the implementations in the decoder and transpiler using <a href="https://github.com/acmiyaguchi/test-casing/tree/master/test-cases">a shared
test-suite</a>. To illustrate the
transformation, consider the <a href="https://probes.telemetry.mozilla.org/?view=detail&amp;probeId=scalar%2Fa11y.theme"><code>a11y.theme</code> keyed
scalar</a> in the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/data/main-ping.html">main
ping</a>. In
the JSON document, as seen in <code>about:telemetry</code>, it is accessed as follows:</p>
<pre><code class="language-python"># Python/Javascript syntax
ping[&quot;payload&quot;][&quot;processes&quot;][&quot;parent&quot;][&quot;keyedScalars&quot;][&quot;a11y.theme&quot;]
</code></pre>
<p>The decoder will normalize the path with snake casing in BigQuery:</p>
<pre><code class="language-sql">SELECT
  payload.processes.parent.keyed_scalars.a11y_theme
FROM `moz-fx-data-shared-prod`.telemetry.main
WHERE date(submission_timestamp) = date_sub(current_date, interval 1 day)
LIMIT 1
</code></pre>
<h4><a class="header" href="#data-structure-normalization" id="data-structure-normalization">Data Structure Normalization</a></h4>
<p>Thee decoder is also responsible for transforming the data to
accommodate BigQuery limitations in data representation. All transformations are defined in
<a href="https://github.com/mozilla/gcp-ingestion/blob/master/ingestion-beam/src/main/java/com/mozilla/telemetry/transforms/PubsubMessageToTableRow.java"><code>ingestion-beam</code> under
<code>com.mozilla.telemtry.transforms.PubsubMessageToTableRow</code></a>.</p>
<p>The following transformations are currently applied:</p>
<table><thead><tr><th>Transformation</th><th>Description</th></tr></thead><tbody>
<tr><td>Map Types</td><td>JSON objects that contain an unbounded number of keys with a shared value type are represented as a <a href="concepts/pipeline/../../cookbooks/bigquery/querying.html#accessing-map-like-fields">repeated structure containing a <code>key</code> and <code>value</code> column</a>.</td></tr>
<tr><td>Nested Arrays</td><td>Nested lists are represented using a structure containing a repeated <code>list</code> column.</td></tr>
<tr><td>Tuples to Anonymous Structures</td><td>A <a href="https://json-schema.org/understanding-json-schema/reference/array.html#tuple-validation">tuple of items</a> is represented as an anonymous structure with column names starting at <code>_0</code> up to <code>_{n}</code> where <code>n</code> is the length of the tuple.</td></tr>
<tr><td>JSON to String coercion</td><td>A sub-tree in a JSON document will be coerced to string if specified in the BigQuery schema. One example is of transformation is to <a href="concepts/pipeline/../../cookbooks/bigquery/querying.html#accessing-histograms">represent histograms in the main ping</a>.</td></tr>
<tr><td>Boolean to Integer coercion</td><td>A boolean may be cast into an integer type.</td></tr>
</tbody></table>
<p>Additional properties are fields within the ingested JSON document that are not found in the schema.
When all transformations are completed, any fields that were not traversed in the schema will be
reconstituted into the <a href="concepts/pipeline/../../cookbooks/bigquery/querying.html#structure-of-ping-tables-in-bigquery">top-level <code>additional_properties</code>
field</a>.</p>
<h2><a class="header" href="#deploying-to-bigquery" id="deploying-to-bigquery">Deploying to BigQuery</a></h2>
<p>In this section, we discuss deployment of generated schemas to BigQuery. Refer to <a href="concepts/pipeline/../../cookbooks/bigquery/querying.html#table-layout-and-naming">Table Layout and
Naming</a> for details about the resulting
structure of the projects.</p>
<p>Tables are updated on every push to <code>generated-schemas</code>. The schemas must be backwards
compatible, otherwise the checks in the staging Dataflow and BigQuery instances will fail. This must
be resolved by pushing a new tip to the <code>generated-schemas</code> branch in the schema repository. <a href="https://cloud.google.com/bigquery/docs/managing-table-schemas">Valid
changes to schemas</a> include relaxing
a column mode from <code>REQUIRED</code> to <code>NULLABLE</code> or adding new columns.</p>
<p>Each table is tagged with the revision of schema repository attached. Consider the
<code>org_mozilla_fenix</code> namespace:</p>
<pre><code class="language-bash">$ bq ls --max_results=3 moz-fx-data-shared-prod:org_mozilla_fenix_stable

       tableId        Type                   Labels                           Time Partitioning                 Clustered Fields
 ------------------- ------- --------------------------------------- ----------------------------------- -------------------------------
  activation_v1       TABLE   schema_id:glean_ping_1                  DAY (field: submission_timestamp)   normalized_channel, sample_id
                              schemas_build_id:202001230145_be1f11e
  baseline_v1         TABLE   schema_id:glean_ping_1                  DAY (field: submission_timestamp)   normalized_channel, sample_id
                              schemas_build_id:202001230145_be1f11e
  bookmarks_sync_v1   TABLE   schema_id:glean_ping_1                  DAY (field: submission_timestamp)   normalized_channel, sample_id
</code></pre>
<p>The <code>schema_id</code> is derived from the value of the <code>$schema</code> property of each JSON Schema.
The <code>schemas_build_id</code> label contains an identifier that includes the timestamp of the generated schema.
This label may be used to trace the last deployed commit from <code>generated-schemas</code>.</p>
<h3><a class="header" href="#updating-generated-schemas" id="updating-generated-schemas">Updating generated-schemas</a></h3>
<pre class="mermaid">graph TD

subgraph workflow.tmo
  manual
  scheduled
end

subgraph mozilla-pipeline-schemas
  master
  schemas(generated-schemas)
end

generator(mozilla-schema-generator)

%%

manual --&gt; |run now| generator
scheduled --&gt; |run at midnight UTC| generator

master --&gt;|git pull| generator
generator --&gt; |git push| schemas
</pre>
<p>A new push to the <code>generated-schemas</code> branch is made every time the <a href="https://github.com/mozilla/telemetry-airflow/blob/master/dags/probe_scraper.py"><code>probe-scraper.schema_generator</code></a> task is run by Airflow.
<code>mozilla-schema-generator</code> runs in a container that commits snapshots of generated schemas to the remote repository.
Generated schemas may change when <code>probe-scraper</code> finds new probes in defined repositories e.g. <code>hg.mozilla.org</code> or <a href="https://github.com/mozilla/probe-scraper/blob/master/repositories.yaml"><code>glean</code></a>.
It may also change when the <code>master</code> branch contains new or updated schemas under the <code>schemas/</code> directory.</p>
<p>To manually trigger a new push, clear the state of a single task in the workflow admin UI.
To update the schedule and dependencies, update the DAG definition.</p>
<h3><a class="header" href="#deploying-schemas-to-production" id="deploying-schemas-to-production">Deploying schemas to production</a></h3>
<pre class="mermaid">graph TD
subgraph mozilla-pipeline-schemas
  schemas(generated-schemas)
end
artifact[Generate schema artifact]
subgraph moz-fx-data-shar-nonprod-efed
  bigquery[Update BigQuery tables]
  views[Update BigQuery views]
  ingestion[Redeploy Dataflow ingestion]
end
status{Deploy prod}

schemas --&gt; |labeled and archived| artifact
artifact --&gt; |run terraform| bigquery
bigquery --&gt; |run terraform| views
views --&gt; |drain and submit| ingestion

ingestion --&gt; status
</pre>
<p>Jenkins is used to automate deploys of the pipeline in the <code>nonprod</code> and <code>prod</code> projects.
Jenkins polls the <code>generated-schemas</code> branch for new commits.
The tip of the branch will be labeled and archived into an artifact that is used during deploys.
The artifact is first used update the table schemas in the <code>nonprod</code> project.
This staging step will stop on schema incompatible changes, such as removing a schema or a column in a schema.
Once the tables are up to date, the Dataflow job will be drained and redeployed so it is writing to the updated tables.
Once schemas have successfully deployed to the <code>nonprod</code> project, then it may be manually promoted to production by an operator.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/pipeline/schemas.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#channel-normalization" id="channel-normalization">Channel Normalization</a></h1>
<p>This document describes how the data pipeline normalizes channel information
sent by Firefox and makes it accessible to data consumers.</p>
<ul>
<li><a href="concepts/channels/channel_normalization.html#what-are-firefox-channels">What are Firefox channels?</a></li>
<li><a href="concepts/channels/channel_normalization.html#app-update-channel">App Update Channel</a></li>
<li><a href="concepts/channels/channel_normalization.html#normalized-channel">Normalized Channel</a></li>
</ul>
<h2><a class="header" href="#what-are-firefox-channels" id="what-are-firefox-channels">What are Firefox channels?</a></h2>
<p>In addition to the the <code>release</code> channel, which is what we ship to most users,
we also ship development versions of Firefox and an &quot;extended support&quot; (<code>esr</code>).
The full list is:</p>
<ul>
<li><code>release</code></li>
<li><code>beta</code></li>
<li><code>aurora</code> (this is <code>dev-edition</code>, and <a href="https://developer.mozilla.org/en-US/Firefox/Developer_Edition">is just a beta repack</a>)</li>
<li><code>nightly</code></li>
<li><code>esr</code></li>
</ul>
<p>For more information on this topic, see the <a href="https://wiki.mozilla.org/Release_Management/Release_Process">Firefox Release Process page</a>.</p>
<h2><a class="header" href="#app-update-channel" id="app-update-channel">App Update Channel</a></h2>
<p>This is the channel reported by Firefox.
This could really be anything, but is usually one of the expected release channels listed above.</p>
<p>For BigQuery tables corresponding to Telemetry Ping types, such as <code>main</code>, <code>crash</code> or <code>event</code>,
the field here is called <code>app_update_channel</code> and is found in <code>metadata.uri</code>. For example:</p>
<pre><code class="language-sql">SELECT
  metadata.uri.app_update_channel
FROM
  telemetry.main
WHERE
  DATE(submission_timestamp) = '2019-09-01'
LIMIT
  10
</code></pre>
<h2><a class="header" href="#normalized-channel" id="normalized-channel">Normalized Channel</a></h2>
<p>This field is a normalization of the directly reported channel, and replaces unusual
and unexpected values with the string <code>Other</code>.
There are a couple of exceptions, notably that variations on <code>nightly-cck-*</code> become <code>nightly</code>.
<a href="https://github.com/mozilla/gcp-ingestion/blob/92ba503c4debc887e746d5f2ff5ee60becb8072f/ingestion-beam/src/main/java/com/mozilla/telemetry/transforms/NormalizeAttributes.java#L38">See the relevant code here</a>.</p>
<p>Normalized channel is available in the Telemetry Ping tables as a top-level field
called <code>normalized_channel</code>.
For example:</p>
<pre><code class="language-sql">SELECT
  normalized_channel
FROM
  telemetry.crash
WHERE
  DATE(submission_timestamp) = '2019-09-01'
LIMIT
  10
</code></pre>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/channels/channel_normalization.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#sampling-in-telemetry-data" id="sampling-in-telemetry-data">Sampling in Telemetry data</a></h1>
<p>Since the early days of Telemetry, it has been desirable to have a quick and
simple way to do analysis on a sample of the full population of Firefox
clients.</p>
<p>The mechanism for doing that is encoded in the data itself, namely the
<code>sample_id</code> field.</p>
<p>This is a field that is computed from the telemetry <code>client_id</code> using
the <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check">CRC</a> hash function.</p>
<p>This CRC hash is then bucketed into 100 possible values from 0 to 99,
each of which represents a roughly 1% uniform sample of the <code>client_id</code> space.</p>
<p>All ping tables that contain a client id, as well as many derived datasets,
include the <code>sample_id</code> field.</p>
<p>TL;DR <code>sample_id = crc32(client_id) % 100</code></p>
<p>An example python implementation:</p>
<pre><code class="language-python"># USAGE: python cid2sid.py 859c8a32-0b73-b547-a5e7-8ef4ed9c4c2d
# Prints
#        Client ID b'859c8a32-0b73-b547-a5e7-8ef4ed9c4c2d' =&gt; Sample ID 55
import binascii
import sys

clientid = sys.argv[1].encode()

crc = binascii.crc32(clientid)
sampleid = (crc &amp; 0xFFFFFFFF) % 100
print(&quot;Client ID {} =&gt; Sample ID {}&quot;.format(clientid, sampleid))
</code></pre>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/sample_id.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#filtering-data" id="filtering-data">Filtering Data</a></h1>
<h2><a class="header" href="#table-of-contents-9" id="table-of-contents-9">Table of Contents</a></h2>
<ul>
<li><a href="concepts/pipeline/filtering.html#overview">Overview</a></li>
<li><a href="concepts/pipeline/filtering.html#stages">Stages</a>
<ul>
<li><a href="concepts/pipeline/filtering.html#edge-filtering">Edge filtering</a></li>
<li><a href="concepts/pipeline/filtering.html#beam-filtering">Beam Filtering</a></li>
<li><a href="concepts/pipeline/filtering.html#json-schema-filtering">JSON Schema Filtering</a></li>
<li><a href="concepts/pipeline/filtering.html#filtering-from-the-stable-tables">Filtering from the stable tables</a></li>
<li><a href="concepts/pipeline/filtering.html#filtering-from-the-exposed-views">Filtering from the exposed views</a></li>
<li><a href="concepts/pipeline/filtering.html#optional-filtering-in-looker-explores">Optional filtering in Looker Explores</a></li>
</ul>
</li>
<li><a href="concepts/pipeline/filtering.html#querying-the-error-stream">Querying the Error Stream</a></li>
</ul>
<h2><a class="header" href="#overview-6" id="overview-6">Overview</a></h2>
<p>Data is filtered out of production streams at almost every stage of the pipeline.
The following outlines each stage and both the data currently filtered and the
data that could be filtered. This should help answer two classes of questions:</p>
<ol>
<li>Did my data get filtered out?</li>
<li>We've uncovered spurious data being ingested, how should we handle that?</li>
</ol>
<p><em>Note</em>: <a href="concepts/pipeline/filtering.html#json-schema-filtering">JSON Schema filtering</a> is our primary method of filtering out bad data. That should be used before any other methods of dropping data from the pipeline.</p>
<h2><a class="header" href="#stages" id="stages">Stages</a></h2>
<p><strong>Where</strong> - Which stage of the pipeline this filtering occurs in</p>
<p><strong>What</strong> - What happens to the data when filtered here</p>
<p><strong>When</strong> - Which situations this filtering should be, and is, used in</p>
<p><strong>How</strong> - What kind of data can be filtered at this stage</p>
<h3><a class="header" href="#edge-filtering" id="edge-filtering">Edge filtering</a></h3>
<p>Where: Filtered by nginx, <a href="https://github.com/mozilla-services/cloudops-infra/blob/master/projects/data-ingestion/k8s/charts/data-ingestion/templates/filter-configmap.yaml#L14-L41">currently we use it to filter out non-v4 pings</a>
(<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1678497">to be removed, but capability to remain</a>).</p>
<p>What: Drops data entirely from the pipeline; there will be no traces of it downstream from the edge server.</p>
<p>When: Only to be used in extreme situations (e.g. PII exposure). We also use it for dropping <a href="https://github.com/mozilla/gcp-ingestion/blob/master/docs/architecture/overview.md#limits">too-large messages</a> and <a href="https://github.com/mozilla/gcp-ingestion/blob/master/ingestion-edge/ingestion_edge/util.py#L95">headers</a>.</p>
<p>How: Can be used to filter by URI, namespaces, apps, etc. (from the URL or from the HTTP headers); but not anything in the payload. </p>
<h3><a class="header" href="#beam-filtering" id="beam-filtering">Beam Filtering</a></h3>
<p>Where: Filtered in the <a href="https://github.com/mozilla/gcp-ingestion/blob/master/ingestion-beam/src/main/java/com/mozilla/telemetry/decoder/MessageScrubber.java">message scrubber</a>.</p>
<p>What: Causes data to be written to the <a href="concepts/pipeline/filtering.html#querying-the-error-stream">error stream</a> or to be dropped entirely.</p>
<p>When: Filter out data we absolutely know we will never need to see (e.g. data from forked applications).</p>
<p>How: Can filter out namespaces, doctypes, or URIs currently; in the extreme can filter on any <a href="https://github.com/mozilla/gcp-ingestion/blob/master/ingestion-core/src/main/java/com/mozilla/telemetry/ingestion/core/Constant.java#L8">message Attribute</a> or payload field.</p>
<h3><a class="header" href="#json-schema-filtering" id="json-schema-filtering">JSON Schema Filtering</a></h3>
<p>Where: During ingestion, as defined in the <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/">payload schema</a>.</p>
<p>What: Causes data to be written to the <a href="concepts/pipeline/filtering.html#querying-the-error-stream">error stream</a>.</p>
<p>When: When trying to remove bad analysis data that we know we will never need (e.g. huge values, improper strings, etc.). Usually these indicate something went wrong with the payload.</p>
<p>How: Can filter on values in the payload, using the <a href="https://json-schema.org/understanding-json-schema/">JSON schema</a>.</p>
<h3><a class="header" href="#filtering-from-the-stable-tables" id="filtering-from-the-stable-tables">Filtering from the stable tables</a></h3>
<p>Where: After ingestion to live tables, but <a href="https://github.com/mozilla/bigquery-etl/blob/master/bigquery_etl/copy_deduplicate.py#L40">before copying to the stable tables</a>.</p>
<p>What: Allows data to exist in the live tables, but removes it from the stable tables.</p>
<p>When: Use for data that may be needed for some analyses on recent data, but not for data that will need long-term historical analyses or for use in any downstream reporting. For example, we <a href="https://mozilla.github.io/glean/book/user/debugging/index.html?highlight=sourcetags#enabling-debugging-features-through-environment-variables">filter out pings from automation</a> (e.g. CI) here, so that analysis is unaffected by them, but we can still analyze what the recent CI data looks like. We also drop duplicate pings (per the document-id).</p>
<p>How: Can filter on any field in the schema, or any metadata.</p>
<h3><a class="header" href="#filtering-from-the-exposed-views" id="filtering-from-the-exposed-views">Filtering from the exposed views</a></h3>
<p>Where: After ingestion to stable tables (<a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry/lockwise_mobile_events_v1/view.sql#L17">example</a>).</p>
<p>What: Allows data to exist in stable tables, but not be exposed to users when accessing views.</p>
<p>When: Use for data that is a footgun for end-users (e.g. data that was collected before a product was launched), but will probably be needed by data science or eng.</p>
<p>How: Can filter on any field in the schema, or any metadata.</p>
<h3><a class="header" href="#optional-filtering-in-looker-explores" id="optional-filtering-in-looker-explores">Optional filtering in Looker Explores</a></h3>
<p>Where: In the explore, Looker creates a <a href="https://docs.looker.com/reference/field-params/default_value">default filter for a field</a>.</p>
<p>What: Allows data to exist in views, and optionally allows users to query that data (but not by default).</p>
<p>When: Use this for data that most of the time should not be queried in Looker. Downside is too many of these will clutter the Looker explore.</p>
<p>How: Can filter on any field in the schema, or any metadata.</p>
<h2><a class="header" href="#querying-the-error-stream" id="querying-the-error-stream">Querying the Error Stream</a></h2>
<p>The data engineering team has exposed some tables to make querying the error stream easier.</p>
<p><a href="https://sql.telemetry.mozilla.org/dashboard/schema-errors">The schema errors dashboard</a> will let you choose your namespace and doctype to see
errors over the past week.</p>
<p>If that data is not granular enough, the error stream can be queried directly:</p>
<pre><code class="language-sql">SELECT
  udf.parse_desktop_telemetry_uri(uri) AS parsed_uri,
  * EXCEPT(payload),
  udf_js.gunzip(payload) AS payload
FROM
  `moz-fx-data-shared-prod.payload_bytes_error.telemetry`
WHERE
  DATE(submission_timestamp) = &quot;2021-01-07&quot;
LIMIT
  1000
</code></pre>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/pipeline/filtering.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#sql-style-guide" id="sql-style-guide">SQL Style Guide</a></h1>
<h2><a class="header" href="#table-of-contents-10" id="table-of-contents-10">Table of Contents</a></h2>
<ul>
<li><a href="concepts/sql_style.html#consistency">Consistency</a></li>
<li><a href="concepts/sql_style.html#reserved-words">Reserved Words</a></li>
<li><a href="concepts/sql_style.html#variable-names">Variable Names</a></li>
<li><a href="concepts/sql_style.html#be-explicit">Be Explicit</a>
<ul>
<li><a href="concepts/sql_style.html#aliasing">Aliasing</a></li>
<li><a href="concepts/sql_style.html#joins">Joins</a></li>
<li><a href="concepts/sql_style.html#grouping-columns">Grouping Columns</a></li>
</ul>
</li>
<li><a href="concepts/sql_style.html#left-align-root-keywords">Left Align Root Keywords</a></li>
<li><a href="concepts/sql_style.html#code-blocks">Code Blocks</a></li>
<li><a href="concepts/sql_style.html#parentheses">Parentheses</a></li>
<li><a href="concepts/sql_style.html#boolean-at-the-beginning-of-line">Boolean at the Beginning of Line</a></li>
<li><a href="concepts/sql_style.html#nested-queries">Nested Queries</a></li>
<li><a href="concepts/sql_style.html#about-this-document">About this Document</a></li>
</ul>
<h2><a class="header" href="#consistency" id="consistency">Consistency</a></h2>
<p>From <a href="https://www.python.org/dev/peps/pep-0008/#a-foolish-consistency-is-the-hobgoblin-of-little-minds">Pep8</a>:</p>
<blockquote>
<p>A style guide is about consistency.
Consistency with this style guide is important.
Consistency within a project is more important.
Consistency within one module or function is the most important.</p>
<p>However, know when to be inconsistent --
sometimes style guide recommendations just aren't applicable.
When in doubt, use your best judgment.
Look at other examples and decide what looks best.
And don't hesitate to ask!</p>
</blockquote>
<h2><a class="header" href="#reserved-words" id="reserved-words">Reserved Words</a></h2>
<p>Always use uppercase for reserved keywords like <code>SELECT</code>, <code>WHERE</code>, or <code>AS</code>.</p>
<h2><a class="header" href="#variable-names" id="variable-names">Variable Names</a></h2>
<ol>
<li>Use consistent and descriptive identifiers and names.</li>
<li>Use lower case names with underscores, such as <code>first_name</code>.
Do not use CamelCase.</li>
<li>Functions, such as <code>cardinality</code>, <code>approx_distinct</code>, or <code>substr</code>,
<a href="https://www.postgresql.org/docs/10/static/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS">are identifiers</a>
and should be treated like variable names.</li>
<li>Names must begin with a letter and may not end in an underscore.</li>
<li>Only use letters, numbers, and underscores in variable names.</li>
</ol>
<h2><a class="header" href="#be-explicit" id="be-explicit">Be Explicit</a></h2>
<p>When choosing between explicit or implicit syntax, prefer explicit.</p>
<h3><a class="header" href="#aliasing" id="aliasing">Aliasing</a></h3>
<p>Always include the <code>AS</code> keyword when aliasing a variable or table name,
it's easier to read when explicit.</p>
<p><strong>Good</strong></p>
<pre><code class="language-sql">SELECT
  date(submission_timestamp) AS day
FROM
  telemetry.main
LIMIT
  10
</code></pre>
<p><strong>Bad</strong></p>
<pre><code class="language-sql">SELECT
  date(submission_timestamp) day
FROM
  telemetry.main
LIMIT
  10
</code></pre>
<h3><a class="header" href="#joins" id="joins">Joins</a></h3>
<p>Always include the <code>JOIN</code> type rather than relying on the default join.</p>
<p><strong>Good</strong></p>
<pre><code class="language-sql">-- BigQuery Standard SQL Syntax
SELECT
  submission_date,
  experiment.key AS experiment_id,
  experiment.value AS experiment_branch,
  count(*) AS count
FROM
  telemetry.clients_daily
CROSS JOIN
  UNNEST(experiments.key_value) AS experiment
WHERE
  submission_date &gt; '2019-07-01'
  AND sample_id = '10'
GROUP BY
  submission_date,
  experiment_id,
  experiment_branch
</code></pre>
<p><strong>Bad</strong></p>
<pre><code class="language-sql">-- BigQuery Standard SQL Syntax
SELECT
  submission_date,
  experiment.key AS experiment_id,
  experiment.value AS experiment_branch,
  count(*) AS count
FROM
  telemetry.clients_daily,
  UNNEST(experiments.key_value) AS experiment -- Implicit JOIN
WHERE
  submission_date &gt; '2019-07-01'
  AND sample_id = '10'
GROUP BY
  1, 2, 3 -- Implicit grouping column names
</code></pre>
<h3><a class="header" href="#grouping-columns" id="grouping-columns">Grouping Columns</a></h3>
<p>In the previous example, implicit grouping columns were discouraged, but there are cases where it makes sense.</p>
<p>In some SQL flavors (such as <a href="https://prestodb.github.io/docs/current/sql/select.html">Presto</a>) grouping elements must refer to the expression before any aliasing is done. If you are grouping by a complex expression it may be desirable to use implicit grouping columns rather than repeating the expression.</p>
<p><strong>Good</strong></p>
<pre><code class="language-sql">-- BigQuery SQL Syntax
SELECT
  submission_date,
  normalized_channel IN ('nightly', 'aurora', 'beta') AS is_prerelease,
  count(*) AS count
FROM
  telemetry.clients_daily
WHERE
  submission_date &gt; '2019-07-01'
GROUP BY
  submission_date,
  is_prerelease -- Grouping by aliases is supported in BigQuery
</code></pre>
<p><strong>Good</strong></p>
<pre><code class="language-sql">-- Presto SQL Syntax
SELECT
  submission_date,
  normalized_channel IN ('nightly', 'aurora', 'beta') AS is_prerelease,
  count(*) AS count
FROM
  telemetry.clients_daily
WHERE
  submission_date &gt; '20190701'
GROUP BY
  1, 2 -- Implicit grouping avoids repeating expressions
</code></pre>
<p><strong>Bad</strong></p>
<pre><code class="language-sql">-- Presto SQL Syntax
SELECT
  submission_date,
  normalized_channel IN ('nightly', 'aurora', 'beta') AS is_prerelease,
  count(*) AS count
FROM
  telemetry.clients_daily
WHERE
  submission_date &gt; '20190701'
GROUP BY
  submission_date,
  normalized_channel IN ('nightly', 'aurora', 'beta')
</code></pre>
<h2><a class="header" href="#left-align-root-keywords" id="left-align-root-keywords">Left Align Root Keywords</a></h2>
<p>Root keywords should all start on the same character boundary.
This is counter to the common &quot;rivers&quot; pattern
<a href="https://www.sqlstyle.guide/#spaces">described here</a>.</p>
<p><strong>Good</strong>:</p>
<pre><code class="language-sql">SELECT
  client_id,
  submission_date
FROM
  main_summary
WHERE
  sample_id = '42'
  AND submission_date &gt; '20180101'
LIMIT
  10
</code></pre>
<p><strong>Bad</strong>:</p>
<pre><code class="language-sql">SELECT client_id,
       submission_date
  FROM main_summary
 WHERE sample_id = '42'
   AND submission_date &gt; '20180101'
</code></pre>
<h2><a class="header" href="#code-blocks" id="code-blocks">Code Blocks</a></h2>
<p>Root keywords should be on their own line.
For example:</p>
<p><strong>Good</strong>:</p>
<pre><code class="language-sql">SELECT
  client_id,
  submission_date
FROM
  main_summary
WHERE
  submission_date &gt; '20180101'
  AND sample_id = '42'
LIMIT
  10
</code></pre>
<p>It's acceptable to include an argument on the same line as the root keyword,
if there is exactly one argument.</p>
<p><strong>Acceptable</strong>:</p>
<pre><code class="language-sql">SELECT
  client_id,
  submission_date
FROM main_summary
WHERE
  submission_date &gt; '20180101'
  AND sample_id = '42'
LIMIT 10
</code></pre>
<p>Do not include multiple arguments on one line.</p>
<p><strong>Bad</strong>:</p>
<pre><code class="language-sql">SELECT client_id, submission_date
FROM main_summary
WHERE
  submission_date &gt; '20180101'
  AND sample_id = '42'
LIMIT 10
</code></pre>
<p><strong>Bad</strong></p>
<pre><code class="language-sql">SELECT
  client_id,
  submission_date
FROM main_summary
WHERE submission_date &gt; '20180101'
  AND sample_id = '42'
LIMIT 10
</code></pre>
<h2><a class="header" href="#parentheses" id="parentheses">Parentheses</a></h2>
<p>If parentheses span multiple lines:</p>
<ol>
<li>The opening parenthesis should terminate the line.</li>
<li>The closing parenthesis should be lined up under
the first character of the line that starts the multi-line construct.</li>
<li>The contents of the parentheses should be indented one level.</li>
</ol>
<p>For example:</p>
<p><strong>Good</strong></p>
<pre><code class="language-sql">WITH sample AS (
  SELECT
    client_id,
  FROM
    main_summary
  WHERE
    sample_id = '42'
)
</code></pre>
<p><strong>Bad</strong> (Terminating parenthesis on shared line)</p>
<pre><code class="language-sql">WITH sample AS (
  SELECT
    client_id,
  FROM
    main_summary
  WHERE
    sample_id = '42')
</code></pre>
<p><strong>Bad</strong> (No indent)</p>
<pre><code class="language-sql">WITH sample AS (
SELECT
  client_id,
FROM
  main_summary
WHERE
  sample_id = '42'
)
</code></pre>
<h2><a class="header" href="#boolean-at-the-beginning-of-line" id="boolean-at-the-beginning-of-line">Boolean at the Beginning of Line</a></h2>
<p><code>AND</code> and <code>OR</code> should always be at the beginning of the line.
For example:</p>
<p><strong>Good</strong></p>
<pre><code class="language-sql">...
WHERE
  submission_date &gt; 20180101
  AND sample_id = '42'
</code></pre>
<p><strong>Bad</strong></p>
<pre><code class="language-sql">...
WHERE
  submission_date &gt; 20180101 AND
  sample_id = '42'
</code></pre>
<h2><a class="header" href="#nested-queries" id="nested-queries">Nested Queries</a></h2>
<p>Do not use nested queries.
Instead, use common table expressions to improve readability.</p>
<p><strong>Good</strong>:</p>
<pre><code class="language-sql">WITH sample AS (
  SELECT
    client_id,
    submission_date
  FROM
    main_summary
  WHERE
    sample_id = '42'
)

SELECT *
FROM sample
LIMIT 10
</code></pre>
<p><strong>Bad</strong>:</p>
<pre><code class="language-sql">SELECT *
FROM (
  SELECT
    client_id,
    submission_date
  FROM
    main_summary
  WHERE
    sample_id = '42'
)
LIMIT 10
</code></pre>
<h2><a class="header" href="#about-this-document" id="about-this-document">About this Document</a></h2>
<p>This document was heavily influenced by https://www.sqlstyle.guide/</p>
<p>Changes to the style guide should be reviewed by at least one member of
both the Data Engineering team and the Data Science team.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/sql_style.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#telemetry-reference" id="telemetry-reference">Telemetry Reference</a></h1>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/index.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#a-brief-history-of-mozilla-data-collection" id="a-brief-history-of-mozilla-data-collection">A brief history of Mozilla data collection</a></h1>
<blockquote>
<p>This section was originally included in the <a href="https://mozilla-private.report/smoot-existing-metrics/book/05_overview.html">Project Smoot existing metrics report</a>
(Mozilla internal link); the DTMO version has been updated to reflect changes to the data platform.</p>
</blockquote>
<h2><a class="header" href="#blocklistxml-and-active-daily-installs-adi" id="blocklistxml-and-active-daily-installs-adi"><code>blocklist.xml</code> and Active Daily Installs (ADI)</a></h2>
<p>The <a href="https://wiki.mozilla.org/Blocklisting">blocklist</a> was a mechanism
for informing Firefox clients about malicious add-ons, DLLs, and other
extension content that should be blocked. The blocklist also noted when
hardware acceleration features should be avoided on certain graphics
cards. To be effective, the blocklist needed to be updated on a faster
cadence than Firefox releases.</p>
<p>The blocklist was <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=271166">first
implemented</a> in
2006 for Firefox 2, and reported the app ID and version to the blocklist
server.</p>
<p>Several additional variables, including OS version, locale, and
distribution, were <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=430120">added to the
URL</a> for Firefox 3
in 2008. Being able to count users was already expressed as a priority
in the bug comments.</p>
<p>A count of blocklist fetches was used to produce a metric called Active
Daily Users, which was <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=812282">renamed to Active Daily
Installs</a> (ADI) by 2012.</p>
<p>As of August 2020, this mechanism has been superseded by a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1257565#c120">Remote
Settings-based</a>
replacement and the ADI measure is no longer in use. See the <a href="concepts/./censuses.html#adi--active-daily-installs-blocklist-fetches">historical
reference on ADI</a>
for more information.</p>
<h2><a class="header" href="#telemetry-1" id="telemetry-1">Telemetry</a></h2>
<p>The <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=585196">earliest telemetry
infrastructure</a>
landed in Firefox 6, and was driven <a href="https://wiki.mozilla.org/Platform/Features/Telemetry">by engineering
needs</a>.</p>
<p>Telemetry was originally opt-out on the nightly and aurora channels, and
opt-in otherwise. It originally lacked persistent client identifiers.</p>
<h2><a class="header" href="#firefox-health-report" id="firefox-health-report">Firefox Health Report</a></h2>
<p>The Firefox Health Report (FHR) was specified to enable longitudinal and
retention analyses. FHR aimed to enable analyses that were not possible
based on the blocklist ping, update ping, telemetry, Test Pilot and
crash stats datasets that were already available.</p>
<p>FHR was <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=718066">first
implemented</a> in
Firefox 20. It was introduced in blog posts by <a href="https://blog.lizardwrangler.com/2012/09/21/firefox-health-report/">Mitchell
Baker</a>
and <a href="https://blog.mozilla.org/metrics/2012/09/21/firefox-health-report/">Gilbert
Fitzgerald</a>.</p>
<p>To avoid introducing a persistent client identifier, FHR originally
relied on a “document ID” system. The client would generate a new UUID
(a random, unique ID) for each FHR document, and remember a list of its
most recent previous document IDs. While uploading a new FHR document,
the client would ask the server to remove its previous documents. The
intent was that the server would end up holding at most one document
from each user, and longitudinal metrics could be accumulated by the
client. This approach proved fragile and was abandoned. A <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=968419">persistent
client identifier</a>
was implemented for Firefox 30.</p>
<h2><a class="header" href="#firefox-desktop-telemetry-today" id="firefox-desktop-telemetry-today">Firefox Desktop Telemetry today</a></h2>
<p>FHR was retired and merged with telemetry to produce the current
generation of telemetry data, distinguished as “v4 telemetry” or
“unified telemetry.”</p>
<p>Instead of mapping FHR probes directly to telemetry, the Unified
Telemetry project built upon the telemetry system to answer the
questions Mozilla had attempted to answer with FHR.</p>
<p>The <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1122515">implementation of unified
telemetry</a> and
opt-out delivery to the release channel was completed for Firefox 42, in 2015.</p>
<p>Telemetry payloads are uploaded in documents called pings. Several kinds
of pings are defined, representing different kinds of measurement. These
include:</p>
<ul>
<li><code>main</code>: activity, performance, technical, and other measurements;
the workhorse of Firefox desktop telemetry</li>
<li><code>crash</code>: information about crashes, including stack traces</li>
<li><code>opt-out</code>: a farewell ping sent when a user disables telemetry</li>
<li><code>module</code>: on Windows, records DLLs injected into the Firefox process</li>
</ul>
<p>and others.</p>
<p>Browser sessions and subsessions are important concepts in telemetry. A
<strong>session</strong> begins when the browser launches and ends—perhaps seconds or
days later— when the parent browser process terminates.</p>
<p>A <strong>subsession</strong> ends</p>
<ul>
<li>when its parent session ends, or</li>
<li>at local midnight, or</li>
<li>when the telemetry environment changes,</li>
</ul>
<p>whichever comes first.</p>
<p>The <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/environment.html">telemetry
environment</a>
describes the hardware and operating system of the client computer. It
can change during a Firefox session when e.g. hardware is plugged into a
laptop.</p>
<p>The subsession is the reporting unit for activity telemetry; each <code>main</code>
ping describes a single subsession. Activity counters are reset once a
subsession ends. Data can be accumulated for analysis by summing over a
client’s pings.</p>
<p>Telemetry pings can contain several different types of measurements:</p>
<ul>
<li>scalars are integers describing either an event count or a
measurement that occurs only once during a subsession;
<code>simpleMeasurement</code>s are an older, less flexible scalar
implementation in the process of being deprecated</li>
<li>histograms represent measurements that can occur repeatedly during a
subsession; histograms report the count of measurements that fell
into each of a set of predefined buckets (e.g. between zero and one,
between one and two, etc).</li>
<li>events represent discrete events; the time and ordering of the
events are preserved, which clarifies sequences of user actions</li>
</ul>
<p>Data types are discussed in more depth in the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/index.html">telemetry data
collection</a>
documentation.</p>
<h2><a class="header" href="#firefox-desktop-telemetry-the-next-generation" id="firefox-desktop-telemetry-the-next-generation">Firefox Desktop Telemetry: The Next Generation</a></h2>
<p>The next step for Firefox Desktop Telemetry is to prototype an implementation
using <a href="concepts/glean/glean.html">Glean</a>.</p>
<p>This effort is known as &quot;Firefox on Glean&quot; or FOG. This effort is expected to
begin in late 2019 / early 2020.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/history.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#profile-behavior" id="profile-behavior">Profile behavior</a></h1>
<h2><a class="header" href="#a-hrefconceptsprofileprofile_creationhtmlprofile-creationa" id="a-hrefconceptsprofileprofile_creationhtmlprofile-creationa"><a href="concepts/profile/profile_creation.html">Profile Creation</a></a></h2>
<h2><a class="header" href="#a-hrefconceptsprofilerealworldusagehtmlreal-world-usagea" id="a-hrefconceptsprofilerealworldusagehtmlreal-world-usagea"><a href="concepts/profile/realworldusage.html">Real World Usage</a></a></h2>
<h2><a class="header" href="#a-hrefconceptsprofileprofilehistoryhtmlprofile-historya" id="a-hrefconceptsprofileprofilehistoryhtmlprofile-historya"><a href="concepts/profile/profilehistory.html">Profile History</a></a></h2>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/profile/index.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#profile-creation---the-technical-part" id="profile-creation---the-technical-part">Profile Creation - The technical part</a></h1>
<ul>
<li><a href="concepts/profile/profile_creation.html#what-is-a-profile">What is a profile?</a></li>
<li><a href="concepts/profile/profile_creation.html#profile-behaviors">Profile Behaviors</a>
<ul>
<li><a href="concepts/profile/profile_creation.html#profile-creation">Profile Creation</a>
<ul>
<li><a href="concepts/profile/profile_creation.html#managed-first-use">Managed: First use</a></li>
<li><a href="concepts/profile/profile_creation.html#managed-profile-manager-creation">Managed: Profile Manager creation</a></li>
<li><a href="concepts/profile/profile_creation.html#unmanaged-command-line-start">Unmanaged: Command-line start</a></li>
</ul>
</li>
<li><a href="concepts/profile/profile_creation.html#profile-reset">Profile Reset</a></li>
<li><a href="concepts/profile/profile_creation.html#profile-deletion">Profile Deletion</a></li>
<li><a href="concepts/profile/profile_creation.html#telemetry-opt-out">Telemetry opt-out</a></li>
</ul>
</li>
<li><a href="concepts/profile/profile_creation.html#profile-creation-date">Profile Creation Date</a>
<ul>
<li><a href="concepts/profile/profile_creation.html#managed-during-profile-creation">Managed: During Profile Creation</a></li>
<li><a href="concepts/profile/profile_creation.html#unmanaged-empty-profile-directory">Unmanaged: Empty profile directory</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#what-is-a-profile" id="what-is-a-profile">What is a profile?</a></h2>
<p>All of the changes a user makes in Firefox, like the home page, what toolbars you use, installed addons, saved passwords and your bookmarks, are all stored in a special folder, called a profile.
Telemetry stores archived and pending pings in the profile directory as well as metadata like the client ID.</p>
<p>Every run of Firefox needs a profile. However a single installation can use multiple profiles for different runs.
The profile folder is stored in a separate place from the Firefox program so that, if something ever goes wrong with Firefox, the profile information will still be there.</p>
<p>Firefox also comes with a Profile Manager, a different run mode to create, migrate and delete the profiles.</p>
<h2><a class="header" href="#profile-behaviors" id="profile-behaviors">Profile Behaviors</a></h2>
<p>In order to understand the behavior of users and base analysis on things like the profile creation date,
it is essential to understand how a profile is created and identified by the browser.
Also, it is important to understand how user actions with and within profiles affect our ability to reason about profiles from a data perspective.
This includes resetting or deleting profiles or opting into or out of sending Telemetry data.</p>
<p>The different cases are described in more detail in the following sections.</p>
<h3><a class="header" href="#profile-creation" id="profile-creation">Profile Creation</a></h3>
<p>There are multiple ways a Firefox profile can be created.
Some of these behave slightly differently.</p>
<p>Profiles can be created and managed by the Firefox Profile Manager:</p>
<ul>
<li>New profile on first launch</li>
<li>New profile from Profile Manager</li>
<li><code>--createprofile</code> command line argument</li>
</ul>
<p>Profiles can be created externally and not be managed by the Firefox Profile Manager:</p>
<ul>
<li><code>--profile</code> command line argument</li>
</ul>
<h4><a class="header" href="#managed-first-use" id="managed-first-use">Managed: First use</a></h4>
<p>When Firefox is opened for the first time after a fresh install, without any prior Firefox profile on disk visible to Firefox, it will create a new profile.
Firefox uses &quot;Default User&quot; as the profile name, creates the profile's directory with a random suffix and marks the new profile as default for subsequent starts of Firefox.
Read <a href="https://support.mozilla.org/en-US/kb/profiles-where-firefox-stores-user-data">where Firefox stores your profile data</a>.</p>
<h4><a class="header" href="#managed-profile-manager-creation" id="managed-profile-manager-creation">Managed: Profile Manager creation</a></h4>
<p>The user can create a new profile through the Profile Manager.
This can either be done on <code>about:profiles</code> in a running Firefox or by starting Firefox with the <code>--ProfileManager</code> flag.
The Profile Manager will ask for a name for the profile and picks a new directory for it.
The Profile Manager allows the user to create a new profile from an existing directory (in which case any files will be included) or from scratch (in which case the directory will be created).</p>
<p>The <code>--createprofile</code> flag can be used from the command line and works the same as creating a profile through the Profile Manager.</p>
<h4><a class="header" href="#unmanaged-command-line-start" id="unmanaged-command-line-start">Unmanaged: Command-line start</a></h4>
<p>Firefox can be started on the command line with a path to a profile directory: <code>firefox --profile path/to/directory</code>.
If the directory does not exist it will be created.</p>
<p>A profile created like this will not be picked up by the Profile Manager.
Its data will persist after Firefox is closed, but the Profile Manager will not know about it.
The profile will not turn up in <code>about:profiles</code>.</p>
<h3><a class="header" href="#profile-reset" id="profile-reset">Profile Reset</a></h3>
<p>A user can reset the profile (see <a href="https://support.mozilla.org/en-US/kb/refresh-firefox-reset-add-ons-and-settings">Refresh Firefox - reset addons and settings</a>).
This will copy over most user data to a new directory, keeping things like the history, bookmarks and cookies, but will remove extensions, modified preferences and added search engines.</p>
<p>A profile reset will not change the Telemetry <code>clientID</code>.
The date of the most recent profile reset is saved and will be contained in Telemetry pings in the <code>profile.resetDate</code> field.</p>
<h3><a class="header" href="#profile-deletion" id="profile-deletion">Profile Deletion</a></h3>
<p>A profile can be deleted through the Profile Manager, which will delete all stored data from disk.
The profile can also be deleted by simply removing the profile's directory.
We will never know about a deletion. We simply won't see that profile in new Telemetry data anymore.</p>
<p>Uninstalling the Firefox installation will not remove any profile data.</p>
<p><strong>Note:</strong> Removing a profile's directory while it is in use is not recommended and will lead to a corrupt state.</p>
<h3><a class="header" href="#telemetry-opt-out" id="telemetry-opt-out">Telemetry opt-out</a></h3>
<p>The user can opt out of sending Telemetry data.
When the user opts out, Telemetry sends a <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/data/deletion-request-ping.html">&quot;deletion-request&quot; ping</a>, containing an empty payload.
The local <code>clientID</code> is reset to a fixed value.</p>
<p>When a user opts into sending Telemetry data, a new <code>clientID</code> is generated and used in subsequent pings.
The profile itself and the profile creation date are unaffected by this.</p>
<h2><a class="header" href="#profile-creation-date" id="profile-creation-date">Profile Creation Date</a></h2>
<p>The <em>profile creation date</em> is the assumed date of initial profile creation.
However it proved to be not reliable for all cases.
There are multiple ways this date is determined.</p>
<h3><a class="header" href="#managed-during-profile-creation" id="managed-during-profile-creation">Managed: During Profile Creation</a></h3>
<p>When a profile is created explicitly the profile directory is created and a <code>times.json</code> containing a timestamp of the current time is stored inside that profile directory<sup class="footnote-reference"><a href="#1">1</a></sup>.
It is read at later times when the profile creation date is used.</p>
<pre class="mermaid">graph TD
A[Start Firefox] --&gt;B[Select profile dir, default or defined]
B --&gt; C{Selected dir exist?}
C --&gt; |No| D[Create directory]
C --&gt; |Yes| E[Write times.json]
D --&gt; E
E --&gt; F[Show Browser]
F --&gt; G[ProfileAge.jsm is called]
G --&gt; J[Read time from times.json]
J --&gt; S[Return creation date]
</pre>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>Relevant parts in the code: <a href="https://searchfox.org/mozilla-central/rev/292d295d6b084b43b70de26a42e68513bb7b36a3/toolkit/xre/nsAppRunner.cpp#2394-2395,2397-2398,2527-2533"><code>nsAppRunner::SelectProfile</code></a> calling <a href="https://searchfox.org/mozilla-central/rev/196560b95f191b48ff7cba7c2ba9237bba6b5b6a/toolkit/profile/nsToolkitProfileService.cpp#789-793"><code>nsToolkitProfileService::CreateProfile</code></a>.</p>
</div>
<h3><a class="header" href="#unmanaged-empty-profile-directory" id="unmanaged-empty-profile-directory">Unmanaged: Empty profile directory</a></h3>
<p>When <code>--profile path/to/directory</code> is passed on the command line, the directory is created if it does not exist, but no <code>times.json</code> is written<sup class="footnote-reference"><a href="#2">2</a></sup>.
On the first access of the profile creation date (through <code>ProfileAge.jsm</code>) the module will detect that the <code>times.json</code> is missing.
It will then iterate through all files in the current profile's directory, reading file creation or modification timestamps.
The oldest of these timestamps is then assumed to be the profile creation date and written to <code>times.json</code>.
Subsequent runs of Firefox will then use this date.</p>
<pre class="mermaid">graph TD
A[Start Firefox --profile path/to/dir] --&gt;H{path/to/dir exist?}
H --&gt; |No| K[Create directory]
K --&gt; F[Show Browser]
H --&gt; |Yes| F
F --&gt; O[ProfileAge.jsm is called]
O --&gt; R{times.json exists?}
R --&gt;|Yes| Q[Read time from times.json]
R --&gt;|No| L[Scan profile dir for oldest file, write to times.json]
L --&gt; S
Q --&gt; S[Return creation date]
</pre>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>Relevant part in the code: <a href="https://searchfox.org/mozilla-central/rev/292d295d6b084b43b70de26a42e68513bb7b36a3/toolkit/xre/nsAppRunner.cpp#2357-2363"><code>nsAppRunner::SelectProfile</code></a> creating the directory.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/profile/profile_creation.md">Edit this file on GitHub.</a></footer></div>
<h1><a class="header" href="#real-world-usage" id="real-world-usage">Real World Usage</a></h1>
<p>This page backs away from our profile-focused data view and examines what Firefox Desktop usage looks like in the real world. There are many components and layers that exist between a user acquiring and running Firefox, and this documentation will illuminate what those are and how they can affect the meaning of a profile.</p>
<h2><a class="header" href="#real-life-components-of-firefox-desktop-usage" id="real-life-components-of-firefox-desktop-usage">Real Life Components of Firefox Desktop Usage</a></h2>
<p><img src="concepts/profile/images/real-life-usage-components.png" alt="" /></p>
<p>The above image illustrates all the layers that sit between a user acquiring and running Firefox Desktop and the Telemetry pings we receive.</p>
<ul>
<li>1: The user
<ul>
<li>A human being presumably.</li>
</ul>
</li>
<li>2: The machine
<ul>
<li>The physical hardware running Firefox.</li>
</ul>
</li>
<li>3: The disk image / hard drive
<ul>
<li>A single machine could have separate partitions running different OSes.</li>
<li>Multiple machines could run copies of a single disk image</li>
<li>Disk images are also used as backups to restore a machine.</li>
</ul>
</li>
<li>4: OS user profile
<ul>
<li>Most operating systems allow users to log into different user profiles with separate user directories (such as a &quot;Guest&quot; account).</li>
<li>Usually, Firefox is installed into a system directory that all users profiles will share, but Firefox profiles are saved within the user directories, effectively segregating them.</li>
</ul>
</li>
<li>5: Firefox binary / installer
<ul>
<li>The downloaded binary package or stub installer which installs Firefox into the disk image. Users can get these from our website or one of our managed properties, but they can also acquire these from 3rd party sources as well.</li>
<li>Our website is instrumented with Google Analytics to track download numbers, but other properties (FTP) and 3rd party sources are not. Google Analytics data is not directly connected to Telemetry data.</li>
<li>A user can produce multiple installations from a single Firefox binary / installer. For example, if a user copies it to a USB stick or keeps it in cloud storage, they could install Firefox on multiple machines from a single binary / installer.</li>
</ul>
</li>
<li>6: Firefox installation
<ul>
<li>The installed Firefox program on a given disk image.</li>
<li>Since Firefox is usually installed in a system directory, the single installation of Firefox will be shared by all the OS user profiles in the disk image.</li>
<li>Stub installers are instrumented with pings to report new install counts, however, full binaries are not.</li>
</ul>
</li>
<li>7: Firefox profile
<ul>
<li>The profile Firefox uses during a user's session.</li>
<li>A user can create multiple Firefox profiles using the Firefox Profile Manager, or by specifying a custom directory to use at startup. More details <a href="concepts/profile/profile_creation.html">here</a>.</li>
<li>This is the entity that we see in Telemetry. Profiles send pings to Telemetry with a client ID as its identifier.</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#desktop-browser-use-cases" id="desktop-browser-use-cases">Desktop Browser Use Cases</a></h2>
<p>Below are the rough categories of Firefox use cases that we know happen in the real world.</p>
<p>Note, these categories are rough approximations, and are not necessarily mutually exclusive.</p>
<h4><a class="header" href="#regular-user" id="regular-user">Regular User</a></h4>
<p>What we imagine a typical user to be. Someone who buys a computer, always uses a default OS user profile, downloads Firefox once, installs it, and continues using the default Firefox profile.</p>
<p><img src="concepts/profile/images/regular-user.png" alt="" /></p>
<p>In Telemetry, this user would just show up as a single client ID.</p>
<p>Assuming they went through our normal funnel, they should show up once in Google Analytics as a download and once in stub installer pings as a new installation (if they used a stub installer).</p>
<h4><a class="header" href="#multi-profile-user" id="multi-profile-user">Multi-Profile User</a></h4>
<p>A more advanced user, who uses multiple Firefox profiles in their normal, everyday use, but otherwise is pretty 'normal' (uses the same OS user profile, etc.).</p>
<p><img src="concepts/profile/images/multi-profile-user.png" alt="" /></p>
<p>In Telemetry, this user would show up as 2 (or more) separate client IDs.
We would have no way to know they came from the same computer and user without identifying that the subsessions are never overlapping and that large portions of the environment (CPU, GPU, Displays) are identical and that would be no guarantee.</p>
<p>Assuming they went through our normal funnel, they would show up once in Google Analytics as a download and once in stub installer pings as a new installation (if they used a stub installer).</p>
<p>However, any subsequent new Firefox profile creations would not have any corresponding downloads or installations.
Since Firefox 55 however, any newly created profile will send a &quot;new-profile&quot; ping.</p>
<h4><a class="header" href="#shared-computer" id="shared-computer">Shared Computer</a></h4>
<p>A situation where there is a computer that is shared across multiple users and each user uses a different OS user profile. Since Firefox profiles live at the user directory level, each user would have a separate Firefox profile. Note, users logging in under a &quot;Guest&quot; account in most machines falls into this category.</p>
<p><img src="concepts/profile/images/shared-computer.png" alt="" /></p>
<p>In this case, every user who logged into this one computer with a different OS user profile would show up as a different client ID. We have no way of knowing they came from the same computer.</p>
<p>Furthermore, if the computer wiped the user directory after use, like Guest accounts and university computer labs often do, then they would show up as a <strong>new</strong> client ID every time they logged in, even if they have used the same computer multiple times. This use case could inflate new profile counts.</p>
<p>Similar to Multi-Profile Users, in this use case, there would be only one download event and install event (assuming normal funnel and stub installer), but multiple client ID's.</p>
<h4><a class="header" href="#cloned-machines" id="cloned-machines">Cloned Machines</a></h4>
<p>In this case, there are actually multiple users with computers that all share the same disk image at some point.</p>
<p>Think of the situation where the IT staff sets up the computer for a new hire at a company. Instead of going through to trouble of installing all the required programs and setting them up correctly for each computer, they'll do it once on one computer, save the disk image, and simply copy it over each time they need to issue a new machine.</p>
<p>Or think of the case where the IT staff of a library needs to set up 2 dozen machines at once.</p>
<p><img src="concepts/profile/images/cloned-machines.png" alt="" /></p>
<p>In this case, depending on the state of the disk image when it was copied, we could see multiple client ID's for each user+machine, or we could see all the user+machines sharing the same client ID.</p>
<p>If the disk image was copied after a Firefox profile was created, then the old user+machine and new user+machine will share the same client ID, and be submitting pings to us concurrently.</p>
<p>If the disk image was copied after the Firefox installation but before an initial Firefox profile was created, then each user+machine will get their own Firefox profile and client ID when they run Firefox for the first time.</p>
<p>As with the Multi-Profile User and Shared Computer case, even though there could be multiple Firefox profiles in this use case, there will only be one download and install event.</p>
<h4><a class="header" href="#migrations" id="migrations">Migrations</a></h4>
<h5><a class="header" href="#type-1-migrate-disk-image" id="type-1-migrate-disk-image">Type 1: Migrate Disk Image</a></h5>
<p>A user has a backup of their disk image and when they switch to a new computer or their current computer crashes, they simply reboot from the old disk image.</p>
<p><img src="concepts/profile/images/migration-1.png" alt="" /></p>
<p>In this case, the old machine and the new machine will just share the same client ID (assuming that the disk was copied after a Firefox profile was created). In fact, it will look exactly like the Cloned Machines case, except that instead of sending pings concurrently, they'll be sending us pings first from the old machine and then from the new machine.</p>
<p>Also, it should be noted that their Firefox profile will 'revert' back to the state that it was in when the disk image was copied, essentially starting over from the past, and any unsent pings on the image (if they exist) will be resent.
For instance, we will see another ping with the <code>profile_subsession_count</code> (the count of how many subsessions a profile has seen in its history) we previously saw some time before.</p>
<p>Again, there will only be one download and install associated with this use case (assuming normal funnel and stub installer).</p>
<h5><a class="header" href="#type-2-migrate-os-user-directory" id="type-2-migrate-os-user-directory">Type 2: Migrate OS User Directory</a></h5>
<p>A user has a backup of their OS user directory and copies it to a new machine.</p>
<p><img src="concepts/profile/images/migration-2.png" alt="" /></p>
<p>This is similar to Type 1 migration, but instead of copying the entire disk, the user only copies the OS user directory. Since the Firefox profile lives in the OS user directory, the old machine and new machine will share the same client ID.</p>
<p>The only difference is since the Firefox Installation lives in system directories, the client might have to re-download and re-install the browser. However, if they also copy the Firefox binary / installer, there will not be a download event, only an install event.</p>
<h5><a class="header" href="#type-3-migrate-firefox-binary--installer" id="type-3-migrate-firefox-binary--installer">Type 3: Migrate Firefox Binary / Installer</a></h5>
<p>A user has the Firefox binary or installer saved on their old machine and copies it over to a new machine to install Firefox.</p>
<p><img src="concepts/profile/images/migration-3.png" alt="" /></p>
<p>In this case, there will not be a second download event, but there will be an install event and the new and old machines will have separate client ID's.</p>
<h5><a class="header" href="#type-4-migrate-firefox-profile" id="type-4-migrate-firefox-profile">Type 4: Migrate Firefox Profile</a></h5>
<p>A user copies their old Firefox profile from their old machine to a new computer, and runs Firefox using the copied Firefox profile.</p>
<p><img src="concepts/profile/images/migration-4.png" alt="" /></p>
<p>In this case, since the Firefox profile is being copied over, both the new and the old machine will have profiles with the same client ID. Again, the profile on the new computer will revert back to the point in its history where it was copied.
And since the profile contains any unsent Telemetry pings, we may receive duplicated submissions of pings from the same client ID.</p>
<p>If the Firefox binary / installer was downloaded, there will be a download and install event. If it was migrated via USB stick, it will only have an install event.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/profile/realworldusage.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#profile-history" id="profile-history">Profile History</a></h1>
<p>A profile's history is simply the progression of that profile's subsessions over its lifetime. We can see this in our main pings by checking:</p>
<ul>
<li><code>profile_subsession_counter</code>
<ul>
<li>A counter which starts at 1 on the very first run of a profile and increments for each subsession. This counter will be reset to 1 if a user resets / refreshes their profile.</li>
</ul>
</li>
<li><code>subsession_start_date</code>
<ul>
<li>The date and time the subsession starts in, truncated to hours. This field is not always reliable due to local clock skew.</li>
</ul>
</li>
<li><code>previous_subsession_id</code>
<ul>
<li>The ID of the previous subsession. Will be <code>null</code> for the very first subsession, or the first subsession after a user resets / refreshes their profile.</li>
</ul>
</li>
<li><code>subsession_id</code>
<ul>
<li>The ID of the current subsession.</li>
</ul>
</li>
<li><code>submission_date_s3</code>
<ul>
<li>The date we received the ping. This date is sourced from the server's time and reliable.</li>
</ul>
</li>
<li><code>profile_reset_date</code>
<ul>
<li>The date the profile was reset. Will be <code>null</code> if the profile was not reset.</li>
</ul>
</li>
</ul>
<p><img src="concepts/profile/images/profile-history/basic-example.png" alt="" /></p>
<p>This is a nice clean example of profile history. It has a clear <strong>starting ping</strong> and it progresses linearly, with each subsession connecting to the next via <code>subsession_id</code>. However, due to the fact that profiles can be shared across machines, and restored manually, etc. strange behaviors can arise (see <a href="concepts/profile/realworldusage.html">Real World Usage</a>).</p>
<h2><a class="header" href="#profile-history-start-conditions" id="profile-history-start-conditions">Profile History Start Conditions</a></h2>
<p>Under normal assumptions, we expect to see the <strong>starting ping</strong> in a profile's history in our telemetry data. The starting ping in the profile's history is the ping from their very first subsession. We expect this ping to have <code>profile_subsession_counter = 1</code> and <code>previous_subsession_id is null</code> and <code>profile_reset_date is null</code>.</p>
<p>However, not all profiles appear in our data with a starting ping and instead appear to us mid-history.</p>
<p><img src="concepts/profile/images/profile-history/ping-diagram-start-condition.png" alt="" /></p>
<h4><a class="header" href="#history-has-beginning" id="history-has-beginning">History Has Beginning</a></h4>
<p><img src="concepts/profile/images/profile-history/example-starting.png" alt="" /></p>
<p>As you can see, this profile starts with a ping where <code>profile_subsession_counter = 1</code> and <code>previous_subsession_id is null</code>.</p>
<h4><a class="header" href="#history-has-no-beginning" id="history-has-no-beginning">History Has No Beginning</a></h4>
<p><img src="concepts/profile/images/profile-history/example-midhistory.png" alt="" /></p>
<p>In this example, the profile simply appears in our data mid-history, with presumably the 25th subsession in it's history. Its previous history is a mystery.</p>
<h2><a class="header" href="#profile-history-progression-events" id="profile-history-progression-events">Profile History Progression Events</a></h2>
<p>After a profile appears, in 'normal' conditions, there should be a linear, straightforward progression with each subsession linking to the next.</p>
<p><img src="concepts/profile/images/profile-history/ping-diagram-events.png" alt="" /></p>
<p>However, the following abnormal events can occur.</p>
<h4><a class="header" href="#history-gap" id="history-gap">History Gap</a></h4>
<p>There is a gap in the profile history.</p>
<p>It's possible this behavior is due to dropped pings.</p>
<p><img src="concepts/profile/images/profile-history/example-gap.png" alt="" /></p>
<p>Here, we see a gap between the 30th ping and the 41st ping and the 44th ping.</p>
<h4><a class="header" href="#history-splits" id="history-splits">History Splits</a></h4>
<p>The history of a profile splits, and after a single subsession, there are two (or more) subsessions that link back to it.</p>
<p>This is probably due to cloned machines or disk image restores. Note, after the profile splits, the two branches might continue concurrently or one branch might die while the other continues.
It is very hard to distinguish between the different branches of the same profile.</p>
<ul>
<li>Profile begins</li>
</ul>
<p><img src="concepts/profile/images/profile-history/example-splits-1.png" alt="" /></p>
<ul>
<li>Profile splits: branch 1</li>
</ul>
<p><img src="concepts/profile/images/profile-history/example-splits-2.png" alt="" /></p>
<ul>
<li>Profile splits: branch 2</li>
</ul>
<p><img src="concepts/profile/images/profile-history/example-splits-3.png" alt="" /></p>
<p>In this example, the profile history starts normally, but on the 5th ping, the history splits into two branches that seem to progress concurrently.</p>
<h4><a class="header" href="#history-restarts" id="history-restarts">History Restarts</a></h4>
<p>The history of a profile suddenly starts over, with a brand new starting ping.</p>
<ul>
<li>Profile begins</li>
</ul>
<p><img src="concepts/profile/images/profile-history/example-restart-1.png" alt="" /></p>
<ul>
<li>Profile restarts</li>
</ul>
<p><img src="concepts/profile/images/profile-history/example-restart-2.png" alt="" /></p>
<p>Here, we see the profile start their history normally, but then they begin a new, totally unconnected branch with a starting ping that is <strong>not</strong> the same as the original starting ping (different <code>subsession_id</code>s).</p>
<h4><a class="header" href="#history-reruns" id="history-reruns">History Reruns</a></h4>
<p><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1631935">(Work in Progress)</a></p>
<h2><a class="header" href="#how-to-order-history" id="how-to-order-history">How to Order History</a></h2>
<p><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1631934">(Work in Progress)</a></p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/profile/profilehistory.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#engagement-metrics" id="engagement-metrics">Engagement metrics</a></h1>
<blockquote>
<p>This section was originally included in the <a href="https://mozilla-private.report/smoot-existing-metrics/book/05_overview.html">Project Smoot existing metrics report</a>
(Mozilla internal link).</p>
</blockquote>
<p>A handful of metrics have been adopted as engagement metrics, either as
censuses of the population or to describe user activity within a
session. This chapter aims to describe what those metrics are and how
they’re defined.</p>
<h2><a class="header" href="#engagement-metrics-1" id="engagement-metrics-1">Engagement metrics</a></h2>
<h3><a class="header" href="#active_ticks" id="active_ticks"><code>active_ticks</code></a></h3>
<p>The <code>active_ticks</code> probe <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1187069#c6">is
specified</a> to
increment once in every 5-second window that a user performs an action
that could interact with content or chrome, including mousing over the
window while it lacks focus. One additional tick is recorded after the
activity stops.</p>
<p>Main pings provide two measurements of <code>active_ticks</code>: a
<code>simpleMeasurement</code> and a scalar.</p>
<p>The <code>simpleMeasurement</code> was <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1106122">implemented in Firefox
37</a> before the
launch of unified telemetry, and had previously been
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=826893">implemented</a> for
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=827157">FHR</a>.</p>
<p>The <code>simpleMeasurement</code> was discovered to be resetting incorrectly,
which was <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1482466">fixed</a>
in Firefox 62.</p>
<p>The scalar (which was not affected by the same bug) was
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1376942">implemented</a> in
Firefox 56. The scalar is aggregated into <code>main_summary</code>, but should
always be identical to the <code>simpleMeasurement</code>.</p>
<h3><a class="header" href="#subsession_length" id="subsession_length"><code>subsession_length</code></a></h3>
<p><code>subsession_length</code> is the wall-clock duration of a subsession.
<code>subsession_length</code> includes time that the computer was asleep for
Windows, but not for OS X or Linux; there is a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1205567">long-outstanding
bug</a> to include
sleep time on all platforms.</p>
<p>There is <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1205985">another
bug</a> to count only
time that the computer is not in sleep.</p>
<p><code>subsession_length</code> was first implemented with <a href="https://mail.mozilla.org/pipermail/fhr-dev/2015-January/000384.html">the advent of
subsessions</a>,
which came with unified telemetry.</p>
<h3><a class="header" href="#total_uri_count" id="total_uri_count"><code>total_uri_count</code></a></h3>
<p><code>total_uri_count</code> was
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1271313">implemented</a> for
Firefox 50.</p>
<p><code>total_uri_count</code> is intended to capture the number of distinct
navigation events a user performs. It includes changes to the URI
fragment (i.e. anchor navigation) on the page. It excludes
<code>XmlHttpRequest</code> fetches and <code>iframes</code>.</p>
<p>It works by attaching an instance of <code>URICountListener</code> as a
<code>TabsProgressListener</code> which responds to <code>onLocationChange</code> events.</p>
<p>Some filters are applied to <code>onLocationChange</code> events:</p>
<ul>
<li>Error pages are excluded.</li>
<li>Only top-level pageloads (where <code>webProgress.isTopLevel</code>,
<a href="https://searchfox.org/mozilla-central/rev/f1c7ba91fad60bfea184006f3728dd6ac48c8e56/uriloader/base/nsIWebProgress.idl#144">documented inline</a>, is true) are counted – i.e,
not navigations within a frame.</li>
<li>Tab restore events are excluded.</li>
<li>URIs visited in private browsing mode are excluded unless
<code>browser.engagement.total_uri_count.pbm</code> is true. (The pref has been
flipped on for small populations in a couple of short studies, but,
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1535169">for now</a> remains false by default.)</li>
</ul>
<h3><a class="header" href="#unfiltered_uri_count" id="unfiltered_uri_count"><code>unfiltered_uri_count</code></a></h3>
<p>The unfiltered count,
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1304647">implemented</a> for
Firefox 51, differs only in that it includes URIs using protocol specs
other than HTTP and HTTPS. It excludes some (but not all) <code>about:</code> pages
– the set of “initial pages” defined in <code>browser.js</code> are excluded, but
e.g. <code>about:config</code> and <code>about:telemetry</code> are included.</p>
<p>No applications of <code>unfiltered_uri_count</code> have been identified.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/engagement.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#user-statessegments" id="user-statessegments">User states/segments</a></h1>
<p>A user state is a group of clients who fit a set of criteria at a point in time.
The set of criteria itself can also be referred to as a &quot;user state&quot;.</p>
<p>In data science these are normally called &quot;segments&quot;; for Firefox we call them &quot;user states&quot;.</p>
<p>Typically you'll use user states to gain more insight into what is going on, by asking
&quot;Regarding the thing I'm interested in,
do users in different user states behave differently,
and what insights does this give me into the users and the product?&quot;
For example, &quot;In this experiment, how do new users react to this feature,
and how does this differ from established users?&quot;.
Or &quot;DAU moved dramatically -
is this restricted to users in this particular country (i.e. a user state)
where there's an event happening, which would raise our suspicions,
or is it global and therefore not solely due to that event?&quot;</p>
<h2><a class="header" href="#versioning" id="versioning">Versioning</a></h2>
<p>We are building out our library of user states,
and we want room to iterate to improve them in the future.
So please quote user states' versions with their names, e.g. &quot;regular users v3&quot;
so that your communication is forwards compatible.</p>
<h2><a class="header" href="#current-user-statessegments" id="current-user-statessegments">Current user states/segments</a></h2>
<h3><a class="header" href="#regular-users-v3" id="regular-users-v3">Regular users v3</a></h3>
<p><code>clients_last_seen.is_regular_user_v3</code></p>
<p>This user state contains clients who sent pings on <em>at least 14</em> of the previous 27 days. As of February 2020 this user state contained approximately 2/3 of DAU and its users had a 1-week retention of around 95%.</p>
<h3><a class="header" href="#new-or-resurrected-v3" id="new-or-resurrected-v3">New or Resurrected v3</a></h3>
<p><code>clients_last_seen.is_new_or_resurrected_v3</code></p>
<p>This user state contains clients who sent pings on <em>none</em> of the previous 27 days. As of February 2020 this user state contained approximately 4% of DAU and its users had a 1-week retention of approximately 30%.</p>
<h3><a class="header" href="#weekday-regulars-v1" id="weekday-regulars-v1">Weekday regulars v1</a></h3>
<p><code>clients_last_seen.is_weekday_regular_v1</code></p>
<p>This user state contains clients in <em>Regular users v3</em> who typically use the browser only on weekdays. This user state is responsible for a slight majority of the weekly seasonality in DAU for <em>Regular users v3</em>. Of the previous 27 days, these users submitted a ping on at most one weekend day (UTC). Due to differing timezones, we allow flexibility: the &quot;weekend&quot; could be Friday/Saturday, Saturday/Sunday, or Sunday/Monday; we only ask that each client is self-consistent for the 27 day period.</p>
<h3><a class="header" href="#all-week-regulars-v1" id="all-week-regulars-v1">All-week regulars v1</a></h3>
<p><code>clients_last_seen.is_allweek_regular_v1</code></p>
<p>This user state contains clients in <em>Regular users v3</em> who do not fit in <em>Weekday regulars v1</em> - clients that used the browser on a weekend at least twice in the previous 27 days. DAU for this user state does have some weekly seasonality, so some of the clients in this user state use the browser on weekdays preferentially, but not exclusively.</p>
<h3><a class="header" href="#core-actives-v1" id="core-actives-v1">Core Actives v1</a></h3>
<p><code>clients_last_seen.is_core_active_v1</code></p>
<p>This user state contains clients that browsed at least 1 URI in at least 21 of the previous 28 days (including the current date). URI counts are derived from the column <code>scalar_parent_browser_engagement_total_uri_count_sum</code> in <a href="concepts/../datasets/batch_view/clients_daily/reference.html"><code>clients_daily</code></a> and <a href="concepts/../datasets/bigquery/clients_last_seen/reference.html"><code>clients_last_seen</code></a>. Note that <code>is_core_active_v1</code> can be <code>true</code> on days where clients did not send a ping or browse at least 1 URI, so long as the aforesaid condition still holds.</p>
<h3><a class="header" href="#activity-segments-informal" id="activity-segments-informal">Activity Segments (informal)</a></h3>
<p><code>clients_last_seen.activity_segments_v1</code></p>
<p>This column classifies each client-day based into one of four informal segments, defined below:</p>
<ul>
<li>
<p><code>infrequent_user</code>: client that browsed at least 1 URI in at least 1 and up to 6 days in the past 28 days.</p>
</li>
<li>
<p><code>casual_user</code>: client that browsed at least 1 URI in at least 7 and up to 13 days in the past 28 days.</p>
</li>
<li>
<p><code>regular_user</code>: client that browsed at least 1 URI in at least 14 and up to 20 days in the past 28 days.
(note that this differs from <code>regular_user_v3</code>)</p>
</li>
<li>
<p><code>core_user</code>: client that browsed at least 1 URI in at least 21 of the past 28 days.</p>
</li>
<li>
<p><code>other</code>: client does not meet any of the criteria above (i.e. they sent pings in at least 1 day out of the previous
28 but did not browse any URIs).</p>
</li>
</ul>
<p>Note that these are informal segments and are provided for convenience - one should not, for example, assume that
there are inherent differences between infrequent and casual users, for example. Also note that they do not divide up
the past 28 days evenly. One can use <code>clients_last_seen.days_visited_1_uri_bits</code> to define their own criteria if a
different breakdown is desired.</p>
<h2><a class="header" href="#writing-queries-with-user-statessegments" id="writing-queries-with-user-statessegments">Writing queries with user states/segments</a></h2>
<p>When a user state is defined with respect to a user's <em>behavior</em> (e.g. usage levels) as opposed to more stable
traits (e.g. country),
we should evaluate each user's user state eligibility
using data collected <em>before</em> the time period in which we want to study their actions.
Else we run the risk of making trivial discoveries
like &quot;heavy users use the product heavily&quot; instead of more meaningful ones
like &quot;heavy users go on to continue using the product heavily&quot;.</p>
<p>So, when writing queries to compute user states directly from their definition,
be sure to compute users' user states using only
data collected before the time period you're analyzing their behavior.</p>
<p>User states are found as columns in the <code>clients_last_seen</code> dataset: the user state listed for a client on a <code>submission_date</code> is valid for that <code>submission_date</code> because it is computed only using behavioral data collected <em>before</em> the <code>submission_date</code>.</p>
<p>TODO: mention that user states are only really defined on days the user is active</p>
<h3><a class="header" href="#wau-and-mau" id="wau-and-mau">WAU and MAU</a></h3>
<p>Users can move in or out of specific user states part way through a week or a month.
This poses a conundrum if we want to plot the WAU or MAU for a user state.</p>
<p>Our convention is to <em>count the number of distinct users who were active in the user state in the period</em>: e.g. &quot;MAU(sent a ping as a regular user v3)&quot;.
So if a user was active as a regular user v3 on e.g. the second day of a 28-day window, then they will contribute to &quot;regular user v3 MAU&quot; regardless of whether they lost their &quot;regular user v3&quot; status at any point in the 28-day window.</p>
<p>Since many user states use the full extent of the <code>*_bits</code> column wizardry in <code>clients_last_seen</code>, you'll have to query WAU or MAU the old fashioned way:</p>
<pre><code class="language-sql">WITH dates AS (
    SELECT *
    FROM UNNEST(GENERATE_DATE_ARRAY('2020-05-01', '2020-07-01')) as d
) SELECT
    dates.d AS submission_date,
    COUNT(DISTINCT client_id) * 100 AS regular_user_v3_mau,
FROM dates
INNER JOIN telemetry.clients_last_seen cls
    ON cls.submission_date BETWEEN DATE_SUB(dates.d, INTERVAL 27 DAY) AND dates.d
    AND cls.submission_date BETWEEN '2020-04-01' AND '2020-07-01'
WHERE cls.sample_id = 42
    AND cls.is_regular_user_v3
    AND cls.days_since_seen = 0
GROUP BY dates.d
ORDER BY dates.d
</code></pre>
<p>Our convention has the potentially counterintuitive consequence that a user can count towards &quot;MAU(sent a ping as a regular user v3)&quot; and &quot;MAU(sent a ping as not a regular user v3)&quot; for the same 28-day window.
If you need to break MAU down into the sum of MAU for various user states, then in this instance you would need to break it down into &quot;only regular v3&quot;, &quot;only not regular v3&quot;, and &quot;both&quot;.</p>
<p>It might be tempting to assign users to whichever user state they happened to be in at the end of the window: this quantity is easy to query.
But many of the user states were defined to be meaningful <em>on days the users were active</em>.
&quot;Regular users v3&quot; is predictive of retention, <em>given that the user was active on the day of interest as a regular user</em>.
If someone has been using the browser every day for a year but then suddenly churns, then it's misleading to consider them to be active as a &quot;not regular user v3&quot; for MAU on the period ending the 15th day after their last activity.
A user can be &quot;new or resurrected v3&quot; for only one day in a 28-day period: unless they appear for the first time on the last day of the month, the user will not qualify as &quot;new or resurrected v3&quot; at the end of the MAU window!
So beware this trap and try to only use user states on days the users are active.</p>
<h3><a class="header" href="#example-queries" id="example-queries">Example queries</a></h3>
<p>DAU for <em>regular users v3</em>:</p>
<pre><code class="language-sql">SELECT
    submission_date,
    COUNTIF(is_regular_user_v3) AS dau_regular_users_v3
FROM moz-fx-data-shared-prod.telemetry.clients_last_seen
WHERE
    submission_date BETWEEN '2020-01-01' AND '2020-03-01'
    AND days_since_seen = 0  -- Get DAU from clients_last_seen
GROUP BY submission_date
</code></pre>
<p>DAU for <em>regular users v3</em>, but joining from a different table:</p>
<pre><code class="language-sql">SELECT
    cd.submission_date,
    COUNTIF(is_regular_user_v3) AS dau_regular_users_v3
FROM clients_daily cd
INNER JOIN clients_last_seen cls
    ON cls.client_id = cd.client_id
    AND cls.submission_date = cd.submission_date
    AND cls.submission_date BETWEEN '2020-01-01' AND '2020-03-01'
WHERE
    cd.submission_date BETWEEN '2020-01-01' AND '2020-03-01'
</code></pre>
<p>Using <code>_is_core_active_v1_</code>:</p>
<p>Here are two basic ways to calculate a time series that counts the number of clients qualifying as Core Active:</p>
<ol>
<li>On a 28 day basis. Here we ask: for a given 28 day period, how many clients qualify as Core Active on that day?
This is equivalent to looking at a sliding 28 day window where we evaluate the 28 day history of each client on
the last day of the window and ask whether they meet the criteria. This means that they do not necessarily have to
be active (either sent a ping or browsed at least 1 URI) on the last day of the window to qualify. Below we show an
example of a query that returns this time series.</li>
</ol>
<pre><code class="language-sql">SELECT submission_date,
    COUNTIF(is_core_active_v1) as number_core_actives
FROM telemetry.clients_last_seen
WHERE submission_date &gt;= DATE_SUB(CURRENT_DATE, INTERVAL 7 DAY)
GROUP BY 1
ORDER BY 1
</code></pre>
<ol start="2">
<li>On a daily basis. Here we ask: of all the users who sent a ping on a given day, how many of them qualify as Core
Active? In this case, we restrict ourselves to looking only at clients who reported telemetry (sent a main ping)
on a given day, and then ask how many of them qualify as core active based on their history in the most recent
28 day window. This is equivalent to asking what subset of DAU qualifies as Core Active. The query here is similar
to the one above, with one addition to the WHERE clause:</li>
</ol>
<pre><code class="language-sql">SELECT submission_date,
    COUNTIF(is_core_active_v1) as number_core_actives
FROM telemetry.clients_last_seen
WHERE submission_date &gt;= DATE_SUB(CURRENT_DATE, INTERVAL 7 DAY) AND days_since_seen = 0
GROUP BY 1
ORDER BY 1
</code></pre>
<h2><a class="header" href="#obsolete-user-states" id="obsolete-user-states">Obsolete user states</a></h2>
<h3><a class="header" href="#usage-regularity-v2" id="usage-regularity-v2">Usage regularity v2</a></h3>
<p>This is a set of three segments.
On a given day, every client falls into exactly one of these segments.
Each client's segment can be computed from <code>telemetry.clients_last_seen.days_visited_5_uri_bits</code>.</p>
<p><em>Regular users v2</em> is defined as
clients who browsed &gt;=5 URIs on <em>at least eight</em> of the previous 27 days.
As of February 2020 this segment contained approximately 2/3 of DAU
and its users had a 1-week retention for a 5 URI day usage criterion of approximately 95%.</p>
<p><em>New/irregular users v2</em> is defined as
clients who browsed &gt;=5 URIs on <em>none</em> of the previous 27 days.
As of February 2020 this segment contained approximately 15% of DAU,
and had a retention for a 5 URI day usage criterion of about 10%
(though &quot;activation&quot; is likely a more relevant word than &quot;retention&quot; for many of these clients).</p>
<p><em>Semi-regular users v2</em> is defined as
clients who browsed &gt;=5 URIs on <em>between one and seven</em> of the previous 27 days,
i.e. it contains users who do not fit the other two segments at this time.
As of February 2020 this segment contained approximately 20% of DAU,
and had a retention for a 5 URI day usage criterion of about 60%.
We do not yet know what proportion of users in this segment stay in this segment for an extended period, and what proportion are in transition between other segments.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/segments.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#projects" id="projects">Projects</a></h1>
<p>Below are a number of trailheads that lead into the projects and code that comprise the Firefox Data Platform.</p>
<h2><a class="header" href="#telemetry-apis" id="telemetry-apis">Telemetry APIs</a></h2>
<table><thead><tr><th>Name and repo</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/mozilla/python_moztelemetry"><code>python_moztelemetry</code></a></td><td>Python APIs for Mozilla Telemetry</td></tr>
<tr><td><a href="https://github.com/mozilla/moztelemetry"><code>moztelemetry</code></a></td><td>Scala APIs for Mozilla Telemetry</td></tr>
<tr><td><a href="https://github.com/mozilla/spark-hyperloglog"><code>spark-hyperloglog</code></a></td><td>Algebird's HyperLogLog support for Apache Spark</td></tr>
<tr><td><a href="https://github.com/mozilla/mozanalysis"><code>mozanalysis</code></a></td><td>A library for Mozilla experiments analysis</td></tr>
<tr><td><a href="https://github.com/mozilla-mobile/android-components/tree/master/components/service/glean"><code>glean</code></a></td><td>A client-side mobile Telemetry SDK for collecting metrics and sending them to Mozilla's Telemetry service</td></tr>
</tbody></table>
<h2><a class="header" href="#etl-code-and-datasets" id="etl-code-and-datasets">ETL code and Datasets</a></h2>
<table><thead><tr><th>Name and repo</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/mozilla/bigquery-etl"><code>bigquery-etl</code></a></td><td>SQL ETL code for building derived datasets in BigQuery</td></tr>
<tr><td><a href="https://github.com/mozilla/telemetry-batch-view"><code>telemetry-batch-view</code></a></td><td>Scala ETL code for derived datasets</td></tr>
<tr><td><a href="https://github.com/mozilla/python_mozetl"><code>python_mozetl</code></a></td><td>Python ETL code for derived datasets</td></tr>
<tr><td><a href="https://github.com/mozilla/telemetry-airflow"><code>telemetry-airflow</code></a></td><td>Airflow configuration and DAGs for scheduled jobs</td></tr>
<tr><td><a href="https://github.com/mozilla/python_mozaggregator"><code>python_mozaggregator</code></a></td><td>Aggregation job for <code>telemetry.mozilla.org</code> aggregates</td></tr>
<tr><td><a href="https://github.com/mozilla/telemetry-streaming"><code>telemetry-streaming</code></a></td><td>Spark Streaming ETL jobs for Mozilla Telemetry</td></tr>
</tbody></table>
<p>See also <a href="https://docs.telemetry.mozilla.org"><code>data-docs</code></a> for documentation on datasets.</p>
<h2><a class="header" href="#infrastructure" id="infrastructure">Infrastructure</a></h2>
<table><thead><tr><th>Name and repo</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/mozilla-services/mozilla-pipeline-schemas"><code>mozilla-pipeline-schemas</code></a></td><td>JSON and Parquet Schemas for Mozilla Telemetry and other structured data</td></tr>
<tr><td><a href="https://github.com/mozilla/gcp-ingestion"><code>gcp-ingestion</code></a></td><td>Documentation and implementation of the Mozilla telemetry ingestion system on Google Cloud Platform</td></tr>
<tr><td><a href="https://github.com/mozilla/jsonschema-transpiler"><code>jsonschema-transpiler</code></a></td><td>Convert JSON Schema into BigQuery table definitions</td></tr>
<tr><td><a href="https://github.com/mozilla/mozilla-schema-generator"><code>mozilla-schema-generator</code></a></td><td>Incorporate probe metadata to generate BigQuery table schemas</td></tr>
<tr><td><a href="https://github.com/mozilla-services/hindsight"><code>hindsight</code></a></td><td>Real-time data processing</td></tr>
<tr><td><a href="https://github.com/mozilla-services/lua_sandbox"><code>lua_sandbox</code></a></td><td>Generic sandbox for safe data analysis</td></tr>
<tr><td><a href="https://github.com/mozilla-services/lua_sandbox_extensions"><code>lua_sandbox_extensions</code></a></td><td>Modules and packages that extend the Lua sandbox</td></tr>
<tr><td><a href="https://github.com/mozilla-services/nginx_moz_ingest"><code>nginx_moz_ingest</code></a></td><td>Nginx module for Telemetry data ingestion</td></tr>
<tr><td><a href="https://github.com/mozilla-services/puppet-config/tree/master/pipeline"><code>puppet-config</code></a></td><td>Cloud services puppet config for deploying infrastructure</td></tr>
<tr><td><a href="https://github.com/mozilla/parquet2hive"><code>parquet2hive</code></a></td><td>Hive import statement generator for Parquet datasets</td></tr>
<tr><td><a href="https://github.com/mozilla-services/edge-validator"><code>edge-validator</code></a></td><td>A service endpoint for validating incoming data</td></tr>
</tbody></table>
<h2><a class="header" href="#data-applications" id="data-applications">Data applications</a></h2>
<table><thead><tr><th>Name and repo</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/mozilla/telemetry-dashboard"><code>telemetry.mozilla.org</code></a></td><td>Main entry point for viewing <a href="https://telemetry.mozilla.org">aggregate Telemetry data</a></td></tr>
<tr><td><a href="https://github.com/mozilla/GUD">Growth &amp; Usage dashboard</a></td><td>Dashboard for questions about <a href="https://growth-stage.bespoke.nonprod.dataops.mozgcp.net">product growth and usage</a>)</td></tr>
<tr><td><a href="https://github.com/mozilla/glam">Glean Aggregate Metrics</a></td><td>Aggregate info about probes and measures</td></tr>
<tr><td><a href="https://debug-ping-preview.firebaseapp.com">Glean Debug View</a></td><td>Tag and view Glean submissions with low latency</td></tr>
<tr><td><a href="https://github.com/mozilla/cerberus">Cerberus</a> &amp; <a href="https://github.com/mozilla/medusa">Medusa</a></td><td>Automatic alert system for telemetry aggregates</td></tr>
<tr><td><a href="https://github.com/mozilla/missioncontrol">Mission Control</a></td><td>Low latency dashboard for stability and health metrics</td></tr>
<tr><td><a href="https://github.com/mozilla/redash">Redash</a></td><td>Mozilla's fork of the <a href="https://sql.telemetry.mozilla.org">data query / visualization system</a></td></tr>
<tr><td><a href="https://github.com/mozilla/redash-stmo"><code>redash-stmo</code></a></td><td>Mozilla's extensions to Redash</td></tr>
<tr><td><a href="https://github.com/mozilla/taar">TAAR</a></td><td>Telemetry-aware addon recommender</td></tr>
<tr><td><a href="https://github.com/mozilla/ensemble">Ensemble</a></td><td>A minimalist platform for publishing data</td></tr>
<tr><td><a href="https://github.com/mozilla/firefox-hardware-report">Hardware Report</a></td><td>Firefox Hardware Report, <a href="https://data.firefox.com/dashboard/hardware">available here</a></td></tr>
<tr><td><a href="https://github.com/mozilla/python-zeppelin"><code>python-zeppelin</code></a></td><td>Convert Zeppelin notebooks to Markdown</td></tr>
<tr><td><a href="https://github.com/mozilla/stmocli">St. Mocli</a></td><td>A command-line interface to <a href="https://sql.telemetry.mozilla.org">STMO</a></td></tr>
<tr><td><a href="https://github.com/mozilla/probe-scraper">probe-scraper</a></td><td>Scrape and publish Telemetry probe data from Firefox</td></tr>
<tr><td><a href="https://github.com/mozilla/firefox-test-tube">test-tube</a></td><td>Compare data across branches in experiments</td></tr>
<tr><td><a href="https://github.com/mozilla/experimenter">experimenter</a></td><td>A web application for managing experiments</td></tr>
<tr><td><a href="https://github.com/mozilla/stmoab">St. Moab</a></td><td>Automatically generate Redash dashboard for A/B experiments</td></tr>
<tr><td><a href="http://iodide.telemetry.mozilla.org/">Iodide</a> (<a href="https://github.com/iodide-project/iodide">code</a>)</td><td>Literate scientific computing and communication for the web</td></tr>
</tbody></table>
<h2><a class="header" href="#legacy-projects" id="legacy-projects">Legacy projects</a></h2>
<p>Projects in this section are less active, but may not be officially
deprecated. Please check with the <code>fx-data-dev</code> mailing list before
starting a new project using anything in this section.</p>
<table><thead><tr><th>Name and repo</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/mozilla/telemetry-next-node"><code>telemetry-next-node</code></a></td><td>A <code>node.js</code> package for accessing Telemetry Aggregates data</td></tr>
<tr><td><a href="https://github.com/mozilla/emr-bootstrap-spark"><code>emr-bootstrap-spark</code></a></td><td>AWS bootstrap scripts for Spark.</td></tr>
<tr><td><a href="https://github.com/mozilla/emr-bootstrap-presto"><code>emr-bootstrap-presto</code></a></td><td>AWS bootstrap scripts for Presto.</td></tr>
</tbody></table>
<h2><a class="header" href="#reference-materials" id="reference-materials">Reference materials</a></h2>
<h3><a class="header" href="#public" id="public">Public</a></h3>
<table><thead><tr><th>Name and repo</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/mozilla/data-docs"><code>data-docs</code></a></td><td>All the info you need to <a href="https://docs.telemetry.mozilla.org">answer questions about Firefox users with data</a></td></tr>
<tr><td>Firefox source docs</td><td><a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/">Mozilla Source Tree Docs - Telemetry section</a></td></tr>
<tr><td><a href="https://github.com/mozilla/mozilla-reports"><code>reports.t.m.o</code></a></td><td>Knowledge repository for <a href="https://mozilla.report">public reports</a></td></tr>
</tbody></table>
<h3><a class="header" href="#non-public" id="non-public">Non-public</a></h3>
<table><thead><tr><th>Name and repo</th><th>Description</th></tr></thead><tbody>
</tbody></table>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/tools/projects.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#dataset-reference" id="dataset-reference">Dataset Reference</a></h1>
<p>After completing <a href="datasets/../concepts/choosing_a_dataset.html">Choosing a Dataset</a>
you should have a high level understanding of what questions each dataset is able to answer.
This section contains references that focus on a single dataset each.
Reading this section front to back is not recommended.
Instead, identify a dataset you'd like to understand better and read through
the relevant documentation.
After reading the tutorial, you should know all you need about the dataset.</p>
<p>Each tutorial should include:</p>
<ul>
<li>Introduction
<ul>
<li>A short overview of why we built the dataset and what need it's meant to solve</li>
<li>What data source the data is collected from,
and a high level overview of how the data is organized</li>
<li>How it is stored and how to access the data</li>
</ul>
</li>
<li>Reference
<ul>
<li>An example query to give the reader an idea of what the data looks like
and how it is meant to be used</li>
<li>How the data is processed and sampled</li>
<li>How frequently it's updated, and how it's scheduled</li>
<li>An up-to-date schema for the dataset</li>
<li>How to augment or modify the dataset</li>
</ul>
</li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#raw-ping-data" id="raw-ping-data">Raw Ping Data</a></h1>
<blockquote>
<p><strong>⚠</strong> This article discusses pings sent by Firefox's legacy v4 telemetry system.
See the <a href="https://mozilla.github.io/glean/book/user/pings/index.html">Glean documentation on pings</a> for newer applications written using the Glean SDK.</p>
</blockquote>
<ul>
<li><a href="datasets/pings.html#introduction">Introduction</a></li>
<li><a href="datasets/pings.html#ping-types">Ping Types</a>
<ul>
<li><a href="datasets/pings.html#main-ping">&quot;main&quot; ping</a></li>
<li><a href="datasets/pings.html#first-shutdown-ping">&quot;first-shutdown&quot; ping</a></li>
<li><a href="datasets/pings.html#event-ping">&quot;event&quot; ping</a></li>
<li><a href="datasets/pings.html#update-ping">&quot;update&quot; ping</a></li>
<li><a href="datasets/pings.html#new-profile-ping">&quot;new-profile&quot; ping</a></li>
<li><a href="datasets/pings.html#crash-ping">&quot;crash&quot; ping</a></li>
<li><a href="datasets/pings.html#deletion-request-ping">&quot;deletion-request&quot; ping</a></li>
<li><a href="datasets/pings.html#coverage-ping">&quot;coverage&quot; ping</a></li>
</ul>
</li>
<li><a href="datasets/pings.html#pingsender">Pingsender</a></li>
<li><a href="datasets/pings.html#ping-metadata">Ping Metadata</a></li>
<li><a href="datasets/pings.html#analysis">Analysis</a></li>
<li><a href="datasets/pings.html#further-reading">Further Reading</a></li>
</ul>
<h2><a class="header" href="#introduction-1" id="introduction-1">Introduction</a></h2>
<p>We receive data from our users via <strong>pings</strong>.
There are several types of pings,
each containing different measurements and sent for different purposes.
To review a complete list of ping types and their schemata, see
<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/index.html">this section of the Mozilla Source Tree Docs</a>.</p>
<p>Pings are also described by a JSONSchema specification which can be found in <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/tree/master/schemas/telemetry">the <code>mozilla-pipeline-schemas</code> repository</a>.</p>
<p>There are a few pings that are central to delivering our core data collection
primitives (Histograms, Events, Scalars) and for keeping an eye on Firefox
behaviour (Environment, New Profiles, Updates, Crashes).</p>
<p>For instance, a user's first session in Firefox might have four pings like this:</p>
<p><img src="datasets//datasets/images/first_session_pings.png" alt="Flowchart of pings in the user's first session" /></p>
<h2><a class="header" href="#ping-types" id="ping-types">Ping Types</a></h2>
<h3><a class="header" href="#main-ping" id="main-ping">&quot;main&quot; ping</a></h3>
<p>The <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/main-ping.html">&quot;main&quot; ping</a> is the workhorse of the Firefox Telemetry system.
It delivers the Telemetry Environment as well as Histograms and Scalars for all
process types that collect data in Firefox. It has several variants each with
specific delivery characteristics:</p>
<table><thead><tr><th>Reason</th><th>Sent when</th><th>Notes</th></tr></thead><tbody>
<tr><td>shutdown</td><td>Firefox session ends cleanly</td><td>Accounts for about <a href="https://sql.telemetry.mozilla.org/queries/3434">80%</a> of all &quot;main&quot; pings. Sent by Pingsender immediately after Firefox shuts down, subject to conditions: Firefox 55+, if the OS isn't also shutting down, and if this isn't the client's first session. If Pingsender fails or isn't used, the ping is sent by Firefox at the beginning of the next Firefox session.</td></tr>
<tr><td>daily</td><td>It has been more than 24 hours since the last &quot;main&quot; ping, and it is around local midnight</td><td>In long-lived Firefox sessions we might go days without receiving a &quot;shutdown&quot; ping. Thus the &quot;daily&quot; ping is sent to ensure we occasionally hear from long-lived sessions.</td></tr>
<tr><td>environment-change</td><td>Telemetry Environment changes</td><td>Is sent immediately when triggered by Firefox (Installing or removing an addon or changing a monitored user preference are common ways for the Telemetry Environment to change)</td></tr>
<tr><td>aborted-session</td><td>Firefox session doesn't end cleanly</td><td>Sent by Firefox at the beginning of the next Firefox session.</td></tr>
</tbody></table>
<p>It was introduced in Firefox 38.</p>
<h3><a class="header" href="#first-shutdown-ping" id="first-shutdown-ping">&quot;first-shutdown&quot; ping</a></h3>
<p>The <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/first-shutdown-ping.html">&quot;first-shutdown&quot; ping</a> is identical to the &quot;main&quot;
ping with reason &quot;shutdown&quot; created at the end of the user's first session,
but sent with a different ping type. This was introduced when we started
using Pingsender to send shutdown pings as there would be a lot of
first-session &quot;shutdown&quot; pings that we'd start receiving all of a sudden.</p>
<p>It is sent using Pingsender.</p>
<p>It was introduced in Firefox 57.</p>
<h3><a class="header" href="#event-ping" id="event-ping">&quot;event&quot; ping</a></h3>
<p>The <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/event-ping.html">&quot;event&quot; ping</a> provides low-latency eventing support to Firefox
Telemetry. It delivers the Telemetry Environment, Telemetry Events from all
Firefox processes, and some diagnostic information about Event Telemetry. It is
sent every hour if there have been events recorded, and up to once every 10
minutes (governed by a <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/internals/preferences.html">preference</a>) if the maximum event limit
for the ping (default to 1000 per process, governed by a
<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/internals/preferences.html">preference</a>) is reached before the hour is up.</p>
<p>It was introduced in Firefox 62.</p>
<h3><a class="header" href="#update-ping" id="update-ping">&quot;update&quot; ping</a></h3>
<p>Firefox Update is the most important means we have of reaching our users with
the latest fixes and features. The <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/update-ping.html">&quot;update&quot; ping</a> notifies us
when an update is downloaded and ready to be applied (reason: &quot;ready&quot;) and when
the update has been successfully applied (reason: &quot;success&quot;). It contains the
Telemetry Environment and information about the update.</p>
<p>It was introduced in Firefox 56.</p>
<h3><a class="header" href="#new-profile-ping" id="new-profile-ping">&quot;new-profile&quot; ping</a></h3>
<p>When a user starts up Firefox for the first time, a profile is created.
Telemetry marks the occasion with the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/new-profile-ping.html">&quot;new-profile&quot; ping</a>
which sends the Telemetry Environment. It is sent either 30 minutes after Firefox
starts running for the first time in this profile (reason: &quot;startup&quot;) or at the
end of the profile's first session (reason: &quot;shutdown&quot;), whichever comes first.
&quot;new-profile&quot; pings are sent immediately when triggered. Those with reason
&quot;startup&quot; are sent by Firefox. Those with reason &quot;shutdown&quot; are sent by
Pingsender.</p>
<p>It was introduced in Firefox 55.</p>
<h3><a class="header" href="#crash-ping" id="crash-ping">&quot;crash&quot; ping</a></h3>
<p>The <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/crash-ping.html">&quot;crash&quot; ping</a> provides diagnostic information whenever a
Firefox process exits abnormally. Unlike the &quot;main&quot; ping with reason
&quot;aborted-session&quot;, this ping does not contain Histograms or Scalars. It
contains a Telemetry Environment, <a href="https://searchfox.org/mozilla-central/source/toolkit/crashreporter/CrashAnnotations.yaml">Crash Annotations</a>, and
<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/crash-ping.html#stack-traces">Stack Traces</a>.</p>
<p>It was introduced in Firefox 40.</p>
<h3><a class="header" href="#deletion-request-ping" id="deletion-request-ping">&quot;deletion-request&quot; ping</a></h3>
<p>In the event a user opts out of Telemetry, we send one final
<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/data/deletion-request-ping.html">&quot;deletion-request&quot; ping</a> to let us know. It contains
only the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/common-ping.html">common ping data</a> and an empty payload.</p>
<p>It was introduced in Firefox 72, replacing the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/obsolete/optout-ping.html">&quot;optout&quot; ping</a>
(which was in turn introduced in Firefox 63).</p>
<h3><a class="header" href="#coverage-ping" id="coverage-ping">&quot;coverage&quot; ping</a></h3>
<p>The <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/coverage-ping.html">coverage ping</a> (<a href="https://blog.mozilla.org/data/2018/08/20/effectively-measuring-search-in-firefox/">announcement</a>)
is a periodic census intended to estimate telemetry opt-out rates.</p>
<p>We estimate that <a href="https://metrics.mozilla.com/%7Erharter/reports/coverage/index.html">93% of release channel
profiles</a>
have telemetry enabled (and are therefore included in DAU).</p>
<h2><a class="header" href="#pingsender-1" id="pingsender-1">Pingsender</a></h2>
<p><a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/internals/pingsender.html">Pingsender</a> is a small application shipped with Firefox which
attempts to send pings even if Firefox is not running. If Firefox has crashed or has already shut
down we would otherwise have to wait for the next Firefox session to begin to
send pings.</p>
<p>Pingsender was introduced in Firefox 54 to send &quot;crash&quot; pings. It was expanded
to send &quot;main&quot; pings of reason &quot;shutdown&quot; in Firefox 55 (excepting the first
session). It sends the &quot;first-shutdown&quot; ping since its introduction in Firefox 57.</p>
<h2><a class="header" href="#ping-metadata" id="ping-metadata">Ping Metadata</a></h2>
<p>The data pipeline appends metadata to arriving pings containing
information about the ingestion environment including timestamps,
Geo-IP data about the client,
and fields extracted from the ping or client headers that are useful for downstream processing.</p>
<p>These fields are available in BigQuery ping tables inside the <code>metadata</code> struct, described in detail
in <a href="datasets/../cookbooks/new_ping.html">the &quot;Ingestion Metadata&quot; section of this article</a>.</p>
<p>Since the metadata are not present in the ping as it is sent by the client,
these fields are documented here, instead of in the source tree docs.</p>
<p>As of September 28, 2018, members of the <code>meta</code> key on main pings include:</p>
<!-- table generated via `scripts/new_ping_metadata_table.py > src/cookbooks/new_ping_metadata_table.md` -->
<table><thead><tr><th>field</th><th>description</th></tr></thead><tbody>
<tr><td><code>additional_properties</code></td><td>A JSON string containing any payload properties not present in the schema</td></tr>
<tr><td><code>document_id</code></td><td>The document ID specified in the URI when the client sent this message</td></tr>
<tr><td><code>normalized_app_name</code></td><td>Set to &quot;Other&quot; if this message contained an unrecognized app name</td></tr>
<tr><td><code>normalized_channel</code></td><td>Set to &quot;Other&quot; if this message contained an unrecognized channel name</td></tr>
<tr><td><code>normalized_country_code</code></td><td>An ISO 3166-1 alpha-2 country code</td></tr>
<tr><td><code>normalized_os</code></td><td>Set to &quot;Other&quot; if this message contained an unrecognized OS name</td></tr>
<tr><td><code>normalized_os_version</code></td><td>N/A</td></tr>
<tr><td><code>sample_id</code></td><td>Hashed version of client_id (if present) useful for partitioning; ranges from 0 to 99</td></tr>
<tr><td><code>submission_timestamp</code></td><td>Time when the ingestion edge server accepted this message</td></tr>
<tr><td><code>metadata.user_agent.browser</code></td><td>N/A</td></tr>
<tr><td><code>metadata.user_agent.os</code></td><td>N/A</td></tr>
<tr><td><code>metadata.user_agent.version</code></td><td>N/A</td></tr>
<tr><td><code>metadata.uri.app_build_id</code></td><td>N/A</td></tr>
<tr><td><code>metadata.uri.app_name</code></td><td>N/A</td></tr>
<tr><td><code>metadata.uri.app_update_channel</code></td><td>N/A</td></tr>
<tr><td><code>metadata.uri.app_version</code></td><td>N/A</td></tr>
<tr><td><code>metadata.header.date</code></td><td>Date HTTP header</td></tr>
<tr><td><code>metadata.header.dnt</code></td><td>DNT (Do Not Track) HTTP header</td></tr>
<tr><td><code>metadata.header.x_debug_id</code></td><td>X-Debug-Id HTTP header</td></tr>
<tr><td><code>metadata.header.x_pingsender_version</code></td><td>X-PingSender-Version HTTP header</td></tr>
<tr><td><code>metadata.geo.city</code></td><td>City name</td></tr>
<tr><td><code>metadata.geo.country</code></td><td>An ISO 3166-1 alpha-2 country code</td></tr>
<tr><td><code>metadata.geo.db_version</code></td><td>The specific <a href="https://dev.maxmind.com/geoip/geoip2/geoip2-city-country-csv-databases/">Geo database</a> version used for this lookup</td></tr>
<tr><td><code>metadata.geo.subdivision1</code></td><td>First major country subdivision, typically a state, province, or county</td></tr>
<tr><td><code>metadata.geo.subdivision2</code></td><td>Second major country subdivision; not applicable for most countries</td></tr>
<tr><td><code>metadata.isp.db_version</code></td><td>The specific <a href="https://dev.maxmind.com/geoip/geoip2/geoip2-isp-csv-database/">ISP database</a> version used for this lookup</td></tr>
<tr><td><code>metadata.isp.name</code></td><td>The name of the Internet Service Provider</td></tr>
<tr><td><code>metadata.isp.organization</code></td><td>The name of a specific business entity when available; otherwise the ISP name</td></tr>
</tbody></table>
<h2><a class="header" href="#analysis-1" id="analysis-1">Analysis</a></h2>
<p>The <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/main-ping.html">main ping</a> includes histograms, scalars, and other performance and diagnostic data.
Since Firefox 62, it <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1460595">no longer contains event data</a>; events are now sent in a separate <code>event</code> ping.</p>
<p><a href="datasets/./derived.html">Derived datasets</a> are processed from ping tables. They are intended to be:</p>
<ul>
<li>Easier and faster to query</li>
<li>Organized to make the data easier to analyze</li>
</ul>
<p>Ping data lives in BigQuery and is accessible in <a href="https://sql.telemetry.mozilla.org/">STMO</a>;
see the <a href="datasets/../cookbooks/bigquery.html">BigQuery cookbook section</a> for more information.
Before analyzing raw ping data,
check if a derived dataset can answer your question.
If you do need to work with raw ping data, be aware that the volume of data can be high.
Try to limit the size of your data by controlling the date range, and start off using a sample.</p>
<h2><a class="header" href="#further-reading" id="further-reading">Further Reading</a></h2>
<p>You can find <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/index.html">the complete ping documentation</a> in the Firefox source documentation.
To augment our data collection, see <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Performance/Adding_a_new_Telemetry_probe">Collecting New Data</a> and the
<a href="https://wiki.mozilla.org/Firefox/Data_Collection">Data Collection Policy</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/pings.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#derived-datasets-1" id="derived-datasets-1">Derived Datasets</a></h1>
<p>See <a href="datasets/../concepts/choosing_a_dataset.html">Choosing a Dataset</a>
for a discussion on the differences between pings and derived datasets.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/derived.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#intro" id="intro">Intro</a></h1>
<p>The <code>active_profiles</code> dataset gives client-level estimates of whether a profile
is still an active user of the browser at a given point in time, as well as probabilistic forecasts
of the client's future activity. These quantities are estimated by a model that attempts to infer
and decouple a client's latent propensity to leave Firefox and become inactive, as well as their
latent propensity to use the browser while still active. These estimates are currently
generated for release desktop browser profiles only, across all operating systems and
geographies.</p>
<h1><a class="header" href="#model" id="model">Model</a></h1>
<p>The model generates predictions for each client by looking at just the recency and frequency of a
client's daily usage within the previous 90 day window. Usage is defined by the daily level binary
indicator of whether they show up in <code>clients_daily</code> on a given day.</p>
<p>The table contains columns related to these quantities:</p>
<ul>
<li><code>submission_date</code>: Day marking the end of the 90 day window. Earliest <code>submission_date</code> that
the table covers is <code>'2019-05-13'</code>.</li>
<li><code>min_day</code>: First day in the window that the client was seen. This could be anywhere between
the first day in the window and the last day in the window.</li>
<li><code>max_day</code>: Last day in the window the client was seen. The highest value this can be is
<code>submission_date</code>.</li>
<li><code>recency</code>: Age of client in days.</li>
<li><code>frequency</code>: Number of days in the window that a client has returned to use the browser
after <code>min_day</code>.</li>
<li><code>num_opportunities</code>: Given a first appearance at <code>min_day</code>, what is the highest number of
days a client could have returned. That is, what is the highest possible value for <code>frequency</code>.</li>
</ul>
<p>Since the model is only using these 2 coarse-grained statistics, these columns should make it
relatively straightforward to interpret why the model made the predictions that it did for a given
profile.</p>
<h2><a class="header" href="#latent-quantities" id="latent-quantities">Latent quantities</a></h2>
<p>The model estimates the expected value for 2 related latent probability variables for a user. The
values in <code>prob_daily_leave</code> give our expectation of the probability that they will become inactive
on a given day, and <code>prob_daily_usage</code> represents the probability that a user will return on a given
day, <em>given that they are still active</em>.</p>
<p>These quantities could be useful for disentangling usage <em>rate</em> from the likelihood that a user is
still using the browser. We could, for example, identify intense users who are at risk of
churning, or users who at first glance appear to have churned, but are actually just infrequent
users.</p>
<p><code>prob_active</code> is the expected value of the probability that a user is still active on
<code>submission_date</code>, given their most recent 90 days' of activity. 'Inactive' in this sense
means that the profile will not use the browser again, whether because they have uninstalled
the browser or for some other reason.</p>
<h2><a class="header" href="#predictions" id="predictions">Predictions</a></h2>
<p>There are several columns of the form <code>e_total_days_in_next_7_days</code>, which give the expected
number of times that a user will show up in the next 7 days (or 14, 21, 28 days). These
predictions take into account both the likelihood that a user will become inactive in the
future, as well as their daily propensity to use the browser, given that they are still active.
The values in <code>e_total_days_in_next_7_days</code> will be between 0 and 7.</p>
<p>An estimate for the probability that a client will contribute to MAU is available in the
column <code>prob_mau</code>. This is simply the probability that the user will return at any point in
the following 28 days, thereby contributing to MAU. Since it is a probability, the values will
range between 0 and 1, just like <code>prob_daily_leave</code> and <code>prob_daily_usage</code>.</p>
<h2><a class="header" href="#attributes" id="attributes">Attributes</a></h2>
<p>There are several columns that contain attributes of the client, like <code>os</code>, <code>locale</code>,
<code>normalized_channel</code>, <code>normalized_os_version</code>, and <code>country</code>. <code>sample_id</code> is also included,
which can be useful for quicker queries, as the table is clustered by this column in BigQuery.</p>
<h2><a class="header" href="#remarks-on-the-model" id="remarks-on-the-model">Remarks on the model</a></h2>
<p>A way to think about the model that infers these quantities is to imagine a simple process
where each client is given 2 weighted coins when they become users, and that they flip each
day. Since they're weighted, the probability of heads won't be 50%, but rather some probability
between 0 and 100%, specific to each client's coin. One coin, called <code>L</code>, comes up heads with
probability <code>prob_daily_leave</code>, and if it ever comes up heads, the client will never use the
browser again. The daily usage coin, <code>U</code>, has heads <code>prob_daily_usage</code>% of the time. <em>While
they are still active</em>, clients flip this coin to decide whether they will use the browser
on that day, and show up in <code>clients_daily</code>.</p>
<p>The combination of these two coin flipping processes results in a history of activity that we
can see in <code>clients_daily</code>. While the model is simple, it has very good predictive power that
can tell, <em>in aggregate</em>, how many users will still be active at some point in the future.
A downside of the model's simplicity, however, is that its predictions are not highly tailored
to an individual client. The very simplified features do not take into account things like
seasonality, or finer grained attributes of their usage (like active hours, addons, etc.).
Further, the predictions in this table only account for existing users that have been seen in
the 90 days of history, and so longer term forecasts of user activity would need to somehow model
new users separately.</p>
<h1><a class="header" href="#caveats-and-future-work" id="caveats-and-future-work">Caveats and future work</a></h1>
<p>Due to the lightweight feature space of the model, the predictions perform better at the
population level rather than the individual client level, and there will be a lot of client-level
variation in behavior. That is, when grouping clients by different dimensions, say all of the
<code>en-IN</code> users on Darwin, the <em>average</em> MAU prediction should be quite close, but a lot of users'
behavior can deviate significantly from the predictions.</p>
<p>The model will also be better at medium- to longer- term forecasts. In particular, the model
will not be well suited to give predictions for new users who have appeared only once in the data
set very recently. These constitute a disproportionately large share of users, but do not
have enough history for this model to make good use of.
These single day profiles are currently the subject of
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1507073">an investigation</a>
that will hopefully yield good heuristics for users that only show up for a single day.</p>
<h1><a class="header" href="#sample-query" id="sample-query">Sample query</a></h1>
<p><a href="https://console.cloud.google.com/bigquery?sq=630180991450:648f8e0a2faa4d86847fe8d27daf1938">Here</a> is
a sample query that will give averages for predicted MAU, probability that users are still
active, and other quantities across different operating systems:</p>
<pre><code class="language-sql">SELECT
  os,
  cast(sum(prob_mau) AS int64) AS predicted_mau,
  count(*) AS n,
  round(avg(prob_active) * 100, 1) AS prob_active,
  round(avg(prob_daily_leave) * 100, 1) AS prob_daily_leave,
  round(avg(prob_daily_usage) * 100, 1) AS prob_daily_usage,
  round(avg(e_total_days_in_next_28_days), 1) AS e_total_days_in_next_28_days
FROM
  `telemetry.active_profiles`
WHERE
  submission_date = '2019-08-01'
  AND sample_id = 1
GROUP BY
  1
HAVING
  count(*) &gt; 100
ORDER BY
  avg(prob_daily_usage) DESC
</code></pre>
<h2><a class="header" href="#scheduling" id="scheduling">Scheduling</a></h2>
<p>The code behind the model can be found in the <a href="https://github.com/wcbeard/bgbb_lib/"><code>bgbb_lib</code> repo</a>,
or on <a href="https://pypi.org/project/bgbb/">PyPI</a>. The airflow job is defined in the
<a href="https://github.com/wcbeard/bgbb_airflow"><code>bgbb_airflow</code> repo</a>.</p>
<p>The model to fit the parameters is run weekly, and the table is updated daily.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/active_profiles.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#addons" id="addons">Addons</a></h1>
<p>Addon usage by client, partitioned by day.</p>
<p>This documentation is a work in progress. Work is
being tracked in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1364172">bug 1364172</a></p>
<h2><a class="header" href="#data-reference" id="data-reference">Data Reference</a></h2>
<p>This dataset contains one or more records for every entry in the main ping table
that contain a non-null value for <code>client_id</code>.
Each Addons record contains info for a single addon,
or if the main ping did not contain any active addons,
there will be a row with nulls for all the addon fields
(to identify <code>client_id</code>s/records without any addons).</p>
<h2><a class="header" href="#scheduling-1" id="scheduling-1">Scheduling</a></h2>
<p>This dataset is updated daily via the <a href="https://github.com/mozilla/telemetry-airflow">telemetry-airflow</a> infrastructure.
The job DAG runs every day after the Main Summary data has been generated.
The DAG defined in <a href="https://github.com/mozilla/bigquery-etl/blob/master/dags/bqetl_addons.py"><code>dags/bqetl_addons.py</code></a></p>
<h2><a class="header" href="#code-reference" id="code-reference">Code Reference</a></h2>
<p>This dataset is generated by <a href="https://github.com/mozilla/bigquery-etl/">BigQuery ETL</a>. The query that generates the dataset is <a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/addons_v2/query.sql"><code>sql/moz-fx-data-shared-prod/telemetry_derived/addons_v2/query.sql</code></a>.</p>
<p>You may find the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/environment.html#addons">environment reference</a> in The Firefox Source Documentation helpful for understanding the source data.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/batch_view/addons/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#addons-daily" id="addons-daily">Addons Daily</a></h1>
<ul>
<li><a href="datasets/other/addons_daily/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/other/addons_daily/reference.html#contents">Contents</a></li>
<li><a href="datasets/other/addons_daily/reference.html#accessing-the-data">Accessing the Data</a></li>
</ul>
</li>
<li><a href="datasets/other/addons_daily/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/other/addons_daily/reference.html#example-queries">Example Queries</a>
<ul>
<li><a href="datasets/other/addons_daily/reference.html#dau-wau-and-mau-for-ublock-origin">DAU, WAU and MAU for uBlock Origin</a></li>
<li><a href="datasets/other/addons_daily/reference.html#add-ons-with-highest-organicsap-search-ratio">Add-ons with Highest Organic:SAP search ratio</a></li>
</ul>
</li>
<li><a href="datasets/other/addons_daily/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/other/addons_daily/reference.html#schema">Schema</a></li>
</ul>
</li>
<li><a href="datasets/other/addons_daily/reference.html#code-reference">Code Reference</a></li>
</ul>
<h1><a class="header" href="#introduction-2" id="introduction-2">Introduction</a></h1>
<p>The <code>addons_daily</code> table is a small and fast dataset with data on specific add-ons, and the users who have them installed. It contains one row per <code>addon_id</code> and <code>submission_date</code>.</p>
<h4><a class="header" href="#contents" id="contents">Contents</a></h4>
<p>Many questions about add-ons are of the form: &quot;How many users have add-on A installed?&quot; or &quot;Are users with add-on Z more active than users with add-on Y?&quot; This dataset is aimed at answering these type of questions without having to do cumbersome joins or filters.</p>
<p>This dataset also has detailed search aggregates by each add-on, broken out by our major search engines (<code>google</code>, <code>bing</code>, <code>ddg</code>, <code>amazon</code>, <code>yandex</code>, <code>other</code>), along with total aggregates (<code>total</code>). This allows us to identify strange search patterns for add-ons who change a user's search settings on their behalf, often siphoning away SAP searches and Mozilla revenue (see the second example query below).</p>
<h4><a class="header" href="#accessing-the-data" id="accessing-the-data">Accessing the Data</a></h4>
<p>The <code>addons_daily</code> table is accessible through STMO using the
<code>Telemetry (BigQuery)</code> data source.</p>
<p>Here's an <a href="https://sql.telemetry.mozilla.org/queries/71007/source">example query</a>.</p>
<h1><a class="header" href="#data-reference-1" id="data-reference-1">Data Reference</a></h1>
<h2><a class="header" href="#example-queries-1" id="example-queries-1">Example Queries</a></h2>
<h4><a class="header" href="#dau-wau-and-mau-for-ublock-origin" id="dau-wau-and-mau-for-ublock-origin">DAU, WAU and MAU for uBlock Origin</a></h4>
<pre><code class="language-sql">SELECT
    submission_date,
    dau,
    wau,
    mau
FROM
    `moz-fx-data-shared-prod.telemetry.addons_daily`
WHERE
    submission_date &gt;= DATE_SUB(CURRENT_DATE, INTERVAL 28 DAY)
    AND addon_id = 'uBlock0@raymondhill.net'
</code></pre>
<h4><a class="header" href="#add-ons-with-highest-organicsap-search-ratio" id="add-ons-with-highest-organicsap-search-ratio">Add-ons with Highest Organic:SAP search ratio</a></h4>
<pre><code class="language-sql">SELECT
    addon_id,
    ANY_VALUE(name) as name,
    AVG(dau) as avg_dau,
    SAFE_DIVIDE(SUM(organic_searches.total), SUM(sap_searches.total)) as organic_sap_ratio
FROM
    telemetry.addons_daily
WHERE
    submission_date &gt;= DATE_SUB(CURRENT_DATE, INTERVAL 7 DAY)
    AND is_system = false
GROUP BY
    1
HAVING
    avg(dau) &gt; 1000
ORDER BY
    4 DESC
</code></pre>
<h2><a class="header" href="#scheduling-2" id="scheduling-2">Scheduling</a></h2>
<p>This dataset is updated daily via the
<a href="https://github.com/mozilla/telemetry-airflow">telemetry-airflow</a> infrastructure.
The job runs as part of the <a href="https://github.com/mozilla/bigquery-etl/blob/master/dags/bqetl_addons.py"><code>addons_daily</code> DAG</a>.</p>
<h2><a class="header" href="#schema-1" id="schema-1">Schema</a></h2>
<p>The data is partitioned by <code>submission_date</code>.</p>
<p>As of 2020-04-17, the current version of the <code>addons_daily</code> dataset is <code>v1</code>.</p>
<h1><a class="header" href="#code-reference-1" id="code-reference-1">Code Reference</a></h1>
<p>This dataset is generated by
<a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/addons_daily_v1/query.sql"><code>bigquery-etl</code></a>.
Refer to this repository for information on how to run or augment the dataset.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/other/addons_daily/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#autonomous-system-aggregates" id="autonomous-system-aggregates">Autonomous system aggregates</a></h1>
<p>In the normal course of processing incoming telemetry,
the contents of pings are separated from the IP address of the client that sent the ping.
Analysts do not have access to the IP address data,
and the IP address data is discarded after several days.</p>
<p>To provide some insight about the different experiences users have on different ISP networks,
while preserving the IP privacy of individual users,
this dataset computes some aggregates from the telemetry data
before the IP address information is discarded.
The dataset is computed each day from the pings received the prior day.</p>
<p>The motivating question for this dataset was to understand
which network operators are using the
<a href="https://use-application-dns.net"><code>use-application-dns.net</code></a>
canary domain to disable DNS over HTTPS (DoH) by default for clients using their networks.
If a user has not specifically turned DoH on or off,
Firefox checks for indications that DoH should not be enabled.
One of these checks is to perform a lookup for the canary domain
using the client's default DNS resolver.
If the lookup returns a <code>NXDOMAIN</code> error code indicating the canary domain does not exist,
DoH will not be enabled by default.
Network operators control this behavior
by configuring the resolvers they provision for their clients.</p>
<p>An <a href="https://en.wikipedia.org/wiki/Autonomous_system_(Internet)">autonomous system</a>
represents a network with a common routing policy,
often because it is controlled by a single entity.
Autonomous systems advertise a set of routes, representing blocks of network addresses.
We use them as a way to identify the entity controlling an IP address.</p>
<p>The <code>asn_aggregates</code> dataset,
created in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1615269">bug 1615269</a>,
contains the columns:</p>
<ul>
<li><code>autonomous_system_number</code> (int64): the number of the autonomous system
from which pings were submitted</li>
<li><code>submission_date</code> (date): the date that pings reached the ingestion endpoint</li>
<li><code>n_clients</code> (int64): number of Firefox clients sending event pings that day, from that AS</li>
<li><code>doh_enabled</code> (int64): number of clients who sent a <code>enable_doh</code> result
<strong>for the canary heuristic</strong> that day, from that AS</li>
<li><code>doh_disabled</code> (int64): number of clients who sent a <code>disable_doh</code> result
<strong>for the canary heuristic</strong> that day, from that AS</li>
</ul>
<p>The canary heuristic indicates whether a client was able to resolve
<a href="https://use-application-dns.net"><code>use-application-dns.net</code></a>;
this is a mechanism available to network operators
who may choose to disable DoH by default for their clients.</p>
<p>We record rows only for ASs where <code>n_clients</code> is at least 500.</p>
<p>The ingestion endpoint only accepts connections with IPv4.
If that changes, clients submitting telemetry from IPv6 addresses will be ignored by this dataset.</p>
<p>The client AS number is determined by looking up the client's IP address in a MaxMind database.</p>
<p>Some notes on interpretation:</p>
<ul>
<li>ASs can change route announcements frequently, so the MaxMind database may be stale</li>
<li>Telemetry is not necessarily sent on network change events,
so users may record activity on one network and submit it from another.</li>
<li>The number of distinct client evaluating DoH heuristics is not currently captured;
if clients report both enabled and disabled states for DoH, they will be double-counted.</li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/other/asn_aggregates/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#attitudes-daily" id="attitudes-daily">Attitudes Daily</a></h1>
<ul>
<li><a href="datasets/other/attitudes_daily/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/other/attitudes_daily/reference.html#contents">Contents</a></li>
<li><a href="datasets/other/attitudes_daily/reference.html#accessing-the-data">Accessing the Data</a></li>
</ul>
</li>
<li><a href="datasets/other/attitudes_daily/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/other/attitudes_daily/reference.html#example-queries">Example Queries</a>
<ul>
<li><a href="datasets/other/attitudes_daily/reference.html#distribution-of-user-responses-to-the-internet-is-open-and-accessible-to-all-over-time">Distribution of user responses to &quot;The internet is open and accessible to all&quot; over time</a></li>
<li><a href="datasets/other/attitudes_daily/reference.html#distribution-of-responses-to-i-was-able-to-get-what-i-wanted-from-using-the-internet-today-by-default-search-engine">Distribution of responses to &quot;I was able to get what I wanted from using the Internet today&quot; by default search engine.</a></li>
</ul>
</li>
<li><a href="datasets/other/attitudes_daily/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/other/attitudes_daily/reference.html#schema">Schema</a></li>
</ul>
</li>
<li><a href="datasets/other/attitudes_daily/reference.html#code-reference">Code Reference</a></li>
</ul>
<h1><a class="header" href="#introduction-3" id="introduction-3">Introduction</a></h1>
<p>The <code>attitudes_daily</code> table is a Telemetry instantiation of user responses to the <a href="https://qsurvey.mozilla.com/collab/daily-attitude-survey">Daily Attitudes Survey (DAS)</a> over time.
It is joined to <code>clients_daily</code> using <code>client_id</code> and <code>submission_date</code>.</p>
<h4><a class="header" href="#contents-1" id="contents-1">Contents</a></h4>
<p>Most Firefox surveys are point-in-time without longitudinal insights.
The DAS is completed by ~300 Firefox users every day, allowing us to measure long term attitudinal trends combined with users' corresponding Telemetry attributes.</p>
<h4><a class="header" href="#accessing-the-data-1" id="accessing-the-data-1">Accessing the Data</a></h4>
<p>The <code>attitudes_daily</code> table is accessible through STMO using the
<code>Telemetry (BigQuery)</code> data source.
The full table name is <code>moz-fx-data-shared-prod.telemetry.attitudes_daily</code>.</p>
<p>Here's an <a href="https://sql.telemetry.mozilla.org/queries/63937/source#163424">example query</a>.</p>
<h1><a class="header" href="#data-reference-2" id="data-reference-2">Data Reference</a></h1>
<p>The DAS shows the user the following four statements, all having the same possible responses of &quot;Agree&quot;, &quot;Disagree&quot; or &quot;Neutral or not sure&quot;.
Each question has an identifier in the <code>attitudes_daily</code> table as the <code>question_key</code>field (shown in parentheses after each statement below)</p>
<ul>
<li>The internet is open and accessible to all (<code>internet_accessible</code>)</li>
<li>I trust Firefox to help me with my online privacy (<code>trust_firefox</code>)</li>
<li>All the sites I’ve visited recently have worked; none of them seem broken (<code>sites_work</code>)</li>
<li>Using the internet helped me meet my goals today (<code>met_goals</code>)</li>
</ul>
<p>User responses are processed and mapped to their <code>question_key</code>'s in <a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/surveygizmo_daily_attitudes/import_responses.py">this script</a>, creating a table <code>moz-fx-data-shared-prod.external.survey_gizmo_daily_attitudes</code> which is subsequently joined to <code>clients_daily</code>.</p>
<h2><a class="header" href="#example-queries-2" id="example-queries-2">Example Queries</a></h2>
<h4><a class="header" href="#distribution-of-user-responses-to-the-internet-is-open-and-accessible-to-all-over-time" id="distribution-of-user-responses-to-the-internet-is-open-and-accessible-to-all-over-time">Distribution of user responses to &quot;The internet is open and accessible to all&quot; over time</a></h4>
<pre><code class="language-sql">SELECT
    submission_date,
    value,
    count(DISTINCT client_id) as n
FROM `moz-fx-data-shared-prod.telemetry.attitudes_daily`
WHERE
    question_key = 'internet_accessible'
    AND value IS NOT NULL
GROUP BY 1, 2
</code></pre>
<iframe src="https://sql.telemetry.mozilla.org/embed/query/65079/visualization/165757?api_key=oSjO27fGmpCsnBXBEhaysRVrLZpX1SKMCpYcxA5h&" width="100%" height="530" frameborder="0" scrolling="no"></iframe>
<h4><a class="header" href="#distribution-of-responses-to-i-was-able-to-get-what-i-wanted-from-using-the-internet-today-by-default-search-engine" id="distribution-of-responses-to-i-was-able-to-get-what-i-wanted-from-using-the-internet-today-by-default-search-engine">Distribution of responses to &quot;I was able to get what I wanted from using the Internet today&quot; by default search engine.</a></h4>
<pre><code class="language-sql">SELECT
    value,
    CASE
      WHEN STARTS_WITH(default_search_engine, 'google') THEN 'Google'
      WHEN STARTS_WITH(default_search_engine, 'ddg') THEN 'DuckDuckGo'
      WHEN STARTS_WITH(default_search_engine, 'bing') THEN 'Bing'
      ELSE 'Other'
    END AS search_engine,
   count(*) AS n
FROM
    `moz-fx-data-shared-prod.telemetry.attitudes_daily`
WHERE
    question_key = 'met_goals'
    AND value IS NOT NULL
    AND submission_date &gt; DATE_SUB(CURRENT_DATE, INTERVAL '7' DAY)
GROUP BY 1, 2
</code></pre>
<iframe src="https://sql.telemetry.mozilla.org/embed/query/63957/visualization/163467?api_key=gzCopzybDta4t3JGkx2urB9MQa67akAehJUybVdW&" width="100%" height="570" frameborder="0" scrolling="no"></iframe>
<h2><a class="header" href="#scheduling-3" id="scheduling-3">Scheduling</a></h2>
<p>This dataset is updated daily via the
<a href="https://github.com/mozilla/telemetry-airflow">telemetry-airflow</a> infrastructure.
The job runs as part of the <a href="https://github.com/mozilla/telemetry-airflow/blob/master/dags/attitudes_daily.py"><code>attitudes_daily</code> DAG</a>.</p>
<h2><a class="header" href="#schema-2" id="schema-2">Schema</a></h2>
<p>The data is partitioned by <code>submission_date</code>.</p>
<p>As of 2019-09-15, the current version of the <code>attitudes_daily</code> dataset is <code>v1</code>.</p>
<h1><a class="header" href="#code-reference-2" id="code-reference-2">Code Reference</a></h1>
<p>This dataset is generated by
<a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/attitudes_daily_v1/query.sql"><code>bigquery-etl</code></a>.
Refer to this repository for information on how to run or augment the dataset. You can view the task run status in airflow <a href="https://workflow.telemetry.mozilla.org/tree?dag_id=attitudes_daily">here</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/other/attitudes_daily/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#clients-daily-1" id="clients-daily-1">Clients Daily</a></h1>
<p>Many questions about Firefox take the form &quot;What did clients with
characteristics X, Y, and Z do during the period S to E?&quot; The
<code>clients_daily</code> table aims to answer these questions. Each row in
the table is a (<code>client_id</code>, <code>submission_date</code>) and contains a
number of aggregates about that day's activity.</p>
<h2><a class="header" href="#accessing-the-data-2" id="accessing-the-data-2">Accessing the Data</a></h2>
<p>The <code>clients_daily</code> table is accessible through STMO using the
<code>Telemetry (BigQuery)</code> data source.</p>
<h2><a class="header" href="#data-reference-3" id="data-reference-3">Data Reference</a></h2>
<h3><a class="header" href="#example-queries-3" id="example-queries-3">Example Queries</a></h3>
<h4><a class="header" href="#compute-churn-for-a-one-day-cohort" id="compute-churn-for-a-one-day-cohort">Compute Churn for a one-day cohort:</a></h4>
<pre><code class="language-sql">SELECT
  submission_date,
  approx_count_distinct(client_id) AS cohort_dau
FROM
  telemetry.clients_daily
WHERE
  submission_date &gt; '2017-08-31'
  AND submission_date &lt; '2017-10-01'
  AND profile_creation_date LIKE '2017-09-01%'
GROUP BY 1
ORDER BY 1
</code></pre>
<h4><a class="header" href="#distribution-of-pings-per-client-per-day" id="distribution-of-pings-per-client-per-day">Distribution of pings per client per day:</a></h4>
<pre><code class="language-sql">SELECT
  normalized_channel,
  CASE
    WHEN pings_aggregated_by_this_row &gt; 50 THEN 50
    ELSE pings_aggregated_by_this_row
  END AS pings_per_day,
  approx_count_distinct(client_id) AS client_count
FROM telemetry.clients_daily
WHERE
  submission_date = '2017-09-01'
  AND normalized_channel &lt;&gt; 'Other'
GROUP BY
  normalized_channel,
  pings_per_day
ORDER BY
  pings_per_day,
  normalized_channel
</code></pre>
<h2><a class="header" href="#scheduling-4" id="scheduling-4">Scheduling</a></h2>
<p>This dataset is updated daily via the
<a href="https://github.com/mozilla/telemetry-airflow">telemetry-airflow</a> infrastructure.
The job runs as part of the <a href="https://github.com/mozilla/bigquery-etl/blob/master/dags/bqetl_main_summary.py"><code>main_summary</code> DAG</a>.</p>
<h2><a class="header" href="#schema-3" id="schema-3">Schema</a></h2>
<p>The data is partitioned by <code>submission_date</code>.</p>
<p>As of 2019-11-28, the current version of the <code>clients_daily</code> dataset is <code>v6</code>.</p>
<h2><a class="header" href="#code-reference-3" id="code-reference-3">Code Reference</a></h2>
<p>This dataset is generated by <a href="https://github.com/mozilla/bigquery-etl/">BigQuery ETL</a>. The query that generates the dataset is <a href="https://github.com/mozilla/bigquery-etl/blob/ad84a15d580333b41d36cfe8331e51238f3bafa1/sql/moz-fx-data-shared-prod/telemetry_derived/clients_daily_v6/query.sql"><code>sql/moz-fx-data-shared-prod/telemetry_derived/clients_daily_v6/query.sql</code></a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/batch_view/clients_daily/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#clients-last-seen-reference" id="clients-last-seen-reference">Clients Last Seen Reference</a></h1>
<ul>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#content">Content</a></li>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#background-and-caveats">Background and Caveats</a></li>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#accessing-the-data">Accessing the Data</a></li>
</ul>
</li>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#field-descriptions">Field Descriptions</a>
<ul>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#activity-segmentuser-statecore-active-specific">Activity Segment/User State/Core Active Specific</a></li>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#usage-specific">Usage Specific</a></li>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#new-profile-specific">New Profile Specific</a></li>
</ul>
</li>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#example-queries">Example Queries</a>
<ul>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#compute-dau-for-non-windows-clients-for-the-last-week">Compute DAU for non-windows clients for the last week</a></li>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#compute-wau-by-channel-for-the-last-week">Compute WAU by Channel for the last week</a></li>
</ul>
</li>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#schema">Schema</a></li>
</ul>
</li>
<li><a href="datasets/bigquery/clients_last_seen/reference.html#code-reference">Code Reference</a></li>
</ul>
<h1><a class="header" href="#introduction-4" id="introduction-4">Introduction</a></h1>
<p>The <code>clients_last_seen</code> dataset is useful for efficiently determining exact
user counts such as <a href="datasets/bigquery/clients_last_seen/../../../cookbooks/dau.html">DAU and MAU</a>.
It can also allow efficient calculation of other windowed usage metrics like retention via its
<a href="datasets/bigquery/clients_last_seen/../../../cookbooks/clients_last_seen_bits.html">bit pattern fields</a>.
It includes the most recent values in a 28 day window for all columns in the
<a href="datasets/bigquery/clients_last_seen//datasets/batch_view/clients_daily/reference.html"><code>clients_daily</code> dataset</a>.</p>
<h4><a class="header" href="#content" id="content">Content</a></h4>
<p>For each <code>submission_date</code> this dataset contains one row per <code>client_id</code>
that appeared in <code>clients_daily</code> in a 28 day window including
<code>submission_date</code> and preceding days.</p>
<p>The <code>days_since_seen</code> column indicates the difference between <code>submission_date</code>
and the most recent <code>submission_date</code> in <code>clients_daily</code> where the <code>client_id</code>
appeared. A client observed on the given <code>submission_date</code> will have <code>days_since_seen = 0</code>.</p>
<p>Other <code>days_since_</code> columns use the most recent date in <code>clients_daily</code> where
a certain condition was met. If the condition was not met for a <code>client_id</code> in
a 28 day window <code>NULL</code> is used. For example <code>days_since_visited_5_uri</code> uses the
condition <code>scalar_parent_browser_engagement_total_uri_count_sum &gt;= 5</code>. These
columns can be used for user counts where a condition must be met on any day
in a window instead of using the most recent values for each <code>client_id</code>.</p>
<p>The <code>days_seen_bits</code> field stores the daily history of a client in the 28 day
window. The daily history is converted into a sequence of bits, with a <code>1</code> for
the days a client is in <code>clients_daily</code> and a <code>0</code> otherwise, and this sequence
is converted to an integer. A tutorial on how to use these bit patterns to
create filters in SQL can be found in
<a href="https://colab.research.google.com/drive/13AwwORpOtRsq22op_3rMSwPssQkJU1ok">this notebook</a>.</p>
<p>The rest of the columns use the most recent value in <code>clients_daily</code> where
the <code>client_id</code> appeared.</p>
<h4><a class="header" href="#background-and-caveats" id="background-and-caveats">Background and Caveats</a></h4>
<p>User counts generated using <code>days_since_seen</code> only reflect the most recent
values from <code>clients_daily</code> for each <code>client_id</code> in a 28 day window. This means
<a href="datasets/bigquery/clients_last_seen/../../../cookbooks/active_dau.html">Active MAU</a>
as defined cannot be efficiently calculated using <code>days_since_seen</code> because if
a given <code>client_id</code> appeared every day in February and only on February 1st had
<code>scalar_parent_browser_engagement_total_uri_count_sum &gt;= 5</code> then it would only
be counted on the 1st, and not the 2nd-28th. Active MAU can be efficiently and
correctly calculated using <code>days_since_visited_5_uri</code>.</p>
<p>MAU can be calculated over a <code>GROUP BY submission_date[, ...]</code> clause using
<code>COUNT(*)</code>, because there is exactly one row in the dataset for each
<code>client_id</code> in the 28 day MAU window for each <code>submission_date</code>.</p>
<p>User counts generated using <code>days_since_seen</code> can use <code>SUM</code> to reduce groups,
because a given <code>client_id</code> will only be in one group per <code>submission_date</code>. So
if MAU were calculated by <code>country</code> and <code>channel</code>, then the sum of the MAU for
each <code>country</code> would be the same as if MAU were calculated only by <code>channel</code>.</p>
<h4><a class="header" href="#accessing-the-data-3" id="accessing-the-data-3">Accessing the Data</a></h4>
<p>The data is available in Re:dash and BigQuery. Take a look at this full running
<a href="https://sql.telemetry.mozilla.org/queries/62029/source#159510">example query in Re:dash</a>.</p>
<h1><a class="header" href="#data-reference-4" id="data-reference-4">Data Reference</a></h1>
<h2><a class="header" href="#field-descriptions" id="field-descriptions">Field Descriptions</a></h2>
<p>The <a href="datasets/bigquery/clients_last_seen/../../../cookbooks/clients_last_seen_bits.html"><code>*_bits</code> fields</a> store the relevant activity of a client in a 28 day
window, as a 28 bit integer.
For each bit, a 1 corresponds to the specific activity occurring on that day.</p>
<h3><a class="header" href="#activity-segmentuser-statecore-active-specific" id="activity-segmentuser-statecore-active-specific">Activity Segment/User State/Core Active Specific</a></h3>
<p>Please see this <a href="datasets/bigquery/clients_last_seen/../../../concepts/segments.html">section</a> for descriptions regarding user states/segments.</p>
<ul>
<li><code>is_core_active_v1</code>: Boolean indicating if the client satisfies conditions of being core active on that day.</li>
<li><code>activity_segments_v1</code>: The activity segment applicable to the client that day.</li>
<li><code>is_regular_user_v3</code>: Boolean indicating if the client satisfies conditions of being a regular user on that day.</li>
<li><code>is_new_or_resurrected_v3</code>: Boolean indicating if the client satisfies conditions of being a regular user on that day.</li>
<li><code>is_weekday_regular_v1</code>: Boolean indicating if the client satisfies conditions of being a weekday regular user on that day.</li>
<li><code>is_allweek_regular_v1</code>: Boolean indicating if the client satisfies conditions of being an all-week regular user on that day.</li>
</ul>
<h3><a class="header" href="#usage-specific" id="usage-specific">Usage Specific</a></h3>
<ul>
<li><code>days_visited_1_uri_bits</code>: Each bit field represents if a client browsed at least 1 URI on that day.</li>
<li><code>days_since_visited_1_uri</code>: Number of days since the client browsed at least 1 URI.</li>
<li><code>days_interacted_bits</code>: Each bit field represents if a client had at least 1 active tick on that day.
This is derived from the <code>active_hours_sum</code> in <code>clients_daily</code>.</li>
<li><code>days_since_interacted</code>: Number of days since the clients had at least 1 active tick.</li>
<li><code>days_had_8_active_ticks_bits</code>: Each bit field represents if a client had at least 8 active ticks on that day.
This can be used to approximate the threshold of 1 URI, and is useful for determining activity for clients using
Private Browsing Mode where URI counts are not recorded.</li>
<li><code>days_since_visited_8_active_ticks</code>: Number of days since the client had at least 8 active ticks.</li>
</ul>
<h3><a class="header" href="#new-profile-specific" id="new-profile-specific">New Profile Specific</a></h3>
<ul>
<li><code>first_seen_date</code>: Date the client sent their first main ping.</li>
<li><code>second_seen_date</code>: Date the client sent their first main ping.</li>
<li><code>days_since_first_seen</code>: Number of days since <code>first_seen_date</code></li>
<li><code>days_since_second_seen</code>: Number of days since <code>second_seen_date</code></li>
<li><code>new_profile_5_day_activated_v1</code>: Boolean indicating if a new profile has sent a ping 5 out of their first 7 days.</li>
<li><code>new_profile_14_day_activated_v1</code>: Boolean indicating if a new profile has sent a ping 8 out of their first 14 days.</li>
<li><code>new_profile_21_day_activated_v1</code>: Boolean indicating if a new profile has sent a ping 12 out of their first 21 days.</li>
<li><code>days_since_created_profile</code>: Number of days since the profile creation date. This field is only populated when the
value is 27 days or less. Otherwise, it is NULL. <code>profile_age_in_days</code> can be used in the latter cases for all clients
who have a profile creation date.</li>
</ul>
<h2><a class="header" href="#example-queries-4" id="example-queries-4">Example Queries</a></h2>
<h4><a class="header" href="#compute-dau-for-non-windows-clients-for-the-last-week" id="compute-dau-for-non-windows-clients-for-the-last-week">Compute DAU for non-windows clients for the last week</a></h4>
<pre><code class="language-sql">SELECT
    submission_date,
    os,
    COUNT(*) AS count
FROM
    mozdata.telemetry.clients_last_seen
WHERE
    submission_date &gt;= DATE_SUB(CURRENT_DATE, INTERVAL 1 WEEK)
    AND days_since_seen = 0
GROUP BY
    submission_date,
    os
HAVING
    count &gt; 10 -- remove outliers
    AND lower(os) NOT LIKE '%windows%'
ORDER BY
    os,
    submission_date DESC
</code></pre>
<h4><a class="header" href="#compute-wau-by-channel-for-the-last-week" id="compute-wau-by-channel-for-the-last-week">Compute WAU by Channel for the last week</a></h4>
<pre><code class="language-sql">SELECT
    submission_date,
    normalized_channel,
    COUNT(*) AS count
FROM
    mozdata.telemetry.clients_last_seen
WHERE
    submission_date &gt;= DATE_SUB(CURRENT_DATE, INTERVAL 1 WEEK)
    AND days_since_seen &lt; 7
GROUP BY
    submission_date,
    normalized_channel
HAVING
    count &gt; 10 -- remove outliers
ORDER BY
    normalized_channel,
    submission_date DESC
</code></pre>
<h2><a class="header" href="#scheduling-5" id="scheduling-5">Scheduling</a></h2>
<p>This dataset is updated daily via the
<a href="https://github.com/mozilla/telemetry-airflow">telemetry-airflow</a>
infrastructure. The job runs as part of the
<a href="https://github.com/mozilla/bigquery-etl/blob/ad84a15d580333b41d36cfe8331e51238f3bafa1/dags/bqetl_main_summary.py#L104"><code>main_summary</code> DAG</a>.</p>
<h2><a class="header" href="#schema-4" id="schema-4">Schema</a></h2>
<p>The data is partitioned by <code>submission_date</code>.</p>
<p>As of 2019-03-25, the current version of the <code>clients_last_seen</code> dataset is
<code>v1</code>, and the schema is visible in the BigQuery console
<a href="https://console.cloud.google.com/bigquery?p=mozdata&amp;d=telemetry&amp;t=clients_last_seen_v1&amp;page=table">here</a>.</p>
<h1><a class="header" href="#code-reference-4" id="code-reference-4">Code Reference</a></h1>
<p>This dataset is generated by
<a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/clients_last_seen_v1/query.sql"><code>bigquery-etl</code></a>.
Refer to this repository for information on how to run or augment the dataset.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/bigquery/clients_last_seen/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#events" id="events">Events</a></h1>
<p>This derived dataset makes it easier to analyze the Firefox <a href="datasets/batch_view/events/../../pings.html#event-ping">event ping</a>.
It has the following advantages over accessing the raw ping table (<code>telemetry.event</code>):</p>
<ul>
<li>There is no need to <code>UNNEST</code> the <code>events</code> column: this is already done for you.</li>
<li>You don't have to know which process type emitted your event. If you care, you can query the <code>event_process</code> column.</li>
<li>It is clustered on the <code>event_category</code> column, which can dramatically speed up your query.</li>
</ul>
<h2><a class="header" href="#data-reference-5" id="data-reference-5">Data Reference</a></h2>
<p>The events dataset contains one row for each event submitted in an event ping for that day.</p>
<p>The <code>timestamp</code>, <code>category</code>, <code>method</code>, <code>object</code>, <code>value</code>, and <code>extra</code> fields of the event
are mapped to columns named <code>event_timestamp</code>, <code>event_category</code>, <code>event_method</code>, <code>event_object</code>,
<code>event_string_value</code>, and <code>event_map_values</code>.
To access the <code>event_map_values</code>, you can use the <code>mozfun.map.get_key</code> UDF,
like <code>SELECT mozfun.map.get_key(event_map_values, &quot;branch&quot;) AS branch FROM telemetry.events</code>.</p>
<p>Please note that <code>event_timestamp</code> refers to the time in milliseconds when the event was recorded <em>relative to the main process start time</em> (<code>session_start_time</code>), while the <code>timestamp</code> column refers to the time the ping was ingested. <code>event_timestamp</code> is useful for determining relative order of events within a single session. Adding <code>event_timestamp</code> to <code>session_start_time</code> will allow you to approximate the absolute time an event occurred, subject to client clock skew and other factors.</p>
<h3><a class="header" href="#example-query" id="example-query">Example Query</a></h3>
<p>This query gets the count of the number of times the user initiated the <code>dismiss_breach_alert</code>
and <code>learn_more_breach</code> actions. Note the use of the <code>event_category</code> to optimize the query:
for this example, this reduces the amount of data scanned from 450 GB to 52 MB.</p>
<pre><code class="language-sql">SELECT countif(event_method = 'dismiss_breach_alert') AS n_dismissing_breach_alert,
       countif(event_method = 'learn_more_breach') AS n_learn_more
FROM telemetry.events_v1
WHERE event_category = 'pwmgr'
  AND submission_date='2020-04-20'
  AND sample_id=0
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/73401/source">link</a></p>
<h2><a class="header" href="#scheduling-6" id="scheduling-6">Scheduling</a></h2>
<p>The events dataset is updated daily.
The job is scheduled on <a href="https://github.com/mozilla/telemetry-airflow">Airflow</a>.
The DAG is defined in <a href="https://github.com/mozilla/telemetry-airflow/blob/master/dags/copy_deduplicate.py"><code>dags/copy_deduplicate.py</code></a>.</p>
<h2><a class="header" href="#code-reference-5" id="code-reference-5">Code Reference</a></h2>
<p>This dataset is generated by <a href="https://github.com/mozilla/bigquery-etl/">BigQuery ETL</a>. The query that generates the dataset is <a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/event_events_v1/query.sql"><code>sql/moz-fx-data-shared-prod/telemetry_derived/event_events_v1/query.sql</code></a>.</p>
<h2><a class="header" href="#more-information" id="more-information">More Information</a></h2>
<p>Firefox has an API to record events, which are then submitted through the main ping.
The format and mechanism of event collection in Firefox is documented <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/events.html">in the Firefox source documentation</a>.</p>
<p>The full events data pipeline is <a href="datasets/batch_view/events/../../../concepts/pipeline/event_pipeline.html">documented in the event pipeline documentation</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/batch_view/events/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#exact-mau-data" id="exact-mau-data">Exact MAU Data</a></h1>
<h2><a class="header" href="#introduction-5" id="introduction-5">Introduction</a></h2>
<p>This article introduces the usage of and methodology behind the &quot;exact MAU&quot;
tables in BigQuery:</p>
<ul>
<li><code>firefox_desktop_exact_mau28_by_dimensions_v1</code>,</li>
<li><code>firefox_nondesktop_exact_mau28_by_dimensions_v1</code>, and</li>
<li><code>firefox_accounts_exact_mau28_by_dimensions_v1</code>.</li>
</ul>
<p>The calculation of MAU (monthly active users) has historically been fraught
with troubling details around exact definitions and computational limitations,
leading to disagreements between analyses.
These tables contain pre-computed MAU, WAU, and DAU aggregates for
various usage criteria and dimensions, allowing efficient calculation of
aggregates across arbitrary slices of those dimensions.
The tables follow a consistent methodology which is intended as a standard
across Mozilla for MAU analysis going forward.</p>
<p>Note that this data model is used in the <a href="https://gud.telemetry.mozilla.org/">Growth &amp; Usage Dashboard (GUD)</a> and that some of this documentation is replicated in the <a href="https://mozilla.github.io/gud">GUD documentation</a>.</p>
<h2><a class="header" href="#table-of-contents-11" id="table-of-contents-11">Table of Contents</a></h2>
<ul>
<li><a href="datasets/bigquery/exact_mau/reference.html#conceptual-model">Conceptual Model</a>
<ul>
<li><a href="datasets/bigquery/exact_mau/reference.html#metric">Metric</a></li>
<li><a href="datasets/bigquery/exact_mau/reference.html#usage-criteria">Usage Criteria</a></li>
<li><a href="datasets/bigquery/exact_mau/reference.html#slice">Slice</a></li>
</ul>
</li>
<li><a href="datasets/bigquery/exact_mau/reference.html#using-the-tables">Using the Tables</a></li>
<li><a href="datasets/bigquery/exact_mau/reference.html#additional-details">Additional Details</a>
<ul>
<li><a href="datasets/bigquery/exact_mau/reference.html#inclusive-tier-1-calculation-for-fxa">Inclusive Tier 1 Calculation for FxA</a></li>
<li><a href="datasets/bigquery/exact_mau/reference.html#confidence-intervals">Confidence Intervals</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#conceptual-model" id="conceptual-model">Conceptual Model</a></h1>
<h2><a class="header" href="#metric-1" id="metric-1">Metric</a></h2>
<p>A metric is anything want to (and can) measure. In order for a metric to be
calculated, a <em>usage criterion</em> and a <em>slice</em> must be specified. The metric
will produce a single value per day, summarizing data:</p>
<ul>
<li>for one day or more days (i.e. the metric value for a particular day may depend on data from other days as well)</li>
<li>for all users (whatever notion of user makes sense for the data, generally profiles) in a particular sub-population</li>
<li>where the sub-population will include users that meet the specified usage criteria and are in the specified slice.</li>
</ul>
<p>A simple <em>usage criterion</em> is &quot;All Desktop Activity&quot;, which includes all Firefox Desktop users that we have any data (telemetry ping) for on the day in question. The simplest slice is &quot;All&quot; which places no restrictions on the sub-population.</p>
<p>For example, the metric &quot;Daily Active Users (DAU)&quot; with usage criteria &quot;All Desktop Activity&quot; and slice &quot;All&quot; involves summarizing data on all users of Firefox Desktop over a single day.</p>
<h2><a class="header" href="#usage-criteria-1" id="usage-criteria-1">Usage Criteria</a></h2>
<p>Active user counts must always be calculated in reference to some specific
<em>usage criterion</em>, a binary condition we use to determine whether a given
user should be considered &quot;active&quot; in a given product or feature.
It may be something simple like &quot;All Desktop Activity&quot; (as above) or,
similarly, &quot;All Mobile Activity&quot;. It may also be something more specific like
&quot;Desktop Visited 5 URI&quot; corresponding to calculation of
<a href="datasets/bigquery/exact_mau/../../../cookbooks/active_dau.html">aDAU</a>.</p>
<p>Distinct usage criteria correspond to distinct <code>*_mau</code> columns in the Exact MAU tables.</p>
<h2><a class="header" href="#slice" id="slice">Slice</a></h2>
<p>A slice defines the sub-population on which we can calculate a metric and
is specified by setting restrictions in different dimensions.
Examples of dimensions include: &quot;Country&quot;, &quot;Attribution Source&quot;,
and &quot;Firefox Version&quot;.
Thus an example slice may be &quot;Country = US; Firefox Version = 60|61&quot;, which
restricts to profiles that report usage in the US on Firefox versions 60 or 61.
There is implicitly no restriction on any other dimensions.
Thus, the empty slice - &quot;All&quot; - is also a valid slice and simply places no
restrictions on any dimension.
Note there are some complexities here:</p>
<ul>
<li>Firstly, a dimension may be scalar and need to be suitably bucketed (instead of every possible profile age being a unique slice element, maybe we prefer to group users between 12 and 16 months old into a single slice element); likewise we may need to use normalized versions of string fields</li>
<li>Secondly, we require that dimensions be non-overlapping, especially for metrics calculated over multiple days of user activity. In a given day, a profile may be active in multiple countries, but we aggregate that to a single value by taking the most frequent value seen in that day, breaking ties by taking the value that occurs last. In a given month, the assigned country may change from day to day; we use the value from the most recent active day up to the day we're calculating usage for.</li>
</ul>
<p>A slice is expressed as a set of conditions in <code>WHERE</code> or <code>GROUP BY</code> clauses
when querying Exact MAU tables.</p>
<h1><a class="header" href="#using-the-tables" id="using-the-tables">Using the Tables</a></h1>
<p>The various Exact MAU datasets are computed daily from the <code>*_last_seen</code>
tables (see <a href="datasets/bigquery/exact_mau//datasets/bigquery/clients_last_seen/reference.html"><code>clients_last_seen</code></a>)
and contain pre-computed DAU, WAU, and MAU counts per usage criterion
per each unique combination of dimensions values.
Because of our restriction that dimension values be non-overlapping, we
can recover MAU for a particular slice of the data by summing over all rows
matching the slice definition.</p>
<p>The simple case of retrieving MAU for usage criterion
&quot;All Desktop Activity&quot; and slice &quot;All&quot; looks like:</p>
<pre><code class="language-sql">SELECT
    submission_date,
    SUM(mau) AS mau
FROM
    `mozdata.telemetry.firefox_desktop_exact_mau28_by_dimensions_v1`
GROUP BY
    submission_date
ORDER BY
    submission_date
</code></pre>
<p>Now, let's refine our slice to &quot;Country = US; Campaign = <code>whatsnew</code>&quot;
via a <code>WHERE</code> clause:</p>
<pre><code class="language-sql">SELECT
    submission_date,
    SUM(mau) AS mau
FROM
    `mozdata.telemetry.firefox_desktop_exact_mau28_by_dimensions_v1`
WHERE
    country = 'US'
    AND campaign = 'whatsnew'
GROUP BY
    submission_date
ORDER BY
    submission_date
</code></pre>
<p>Perhaps we want to compare MAU as above to <a href="datasets/bigquery/exact_mau/../../../cookbooks/active_dau.html">aDAU</a>
over the same slice. The column <code>visited_5_uri_dau</code> gives DAU as calculated
with the &quot;Desktop Visited 5 URI&quot; usage criterion, corresponding to aDAU:</p>
<pre><code class="language-sql">SELECT
    submission_date,
    SUM(mau) AS mau,
    SUM(visited_5_uri_dau) AS adau
FROM
    `mozdata.telemetry.firefox_desktop_exact_mau28_by_dimensions_v1`
WHERE
    country = 'US'
    AND campaign = 'whatsnew'
GROUP BY
    submission_date
ORDER BY
    submission_date
</code></pre>
<p>Additional usage criteria may be added in the future as new columns named
<code>*_*mau</code>, etc. where the prefix describes the usage criterion.</p>
<p>For convenience and clarity, we make the exact data presented in the <a href="https://go.corp.mozilla.com/kpi-dash">Key Performance Indicator Dashboard</a> available as views that do not require any aggregation:</p>
<ul>
<li><code>firefox_desktop_exact_mau28_v1</code>,</li>
<li><code>firefox_nondesktop_exact_mau28_v1</code>, and</li>
<li><code>firefox_accounts_exact_mau28_v1</code>.</li>
</ul>
<p>An example query for desktop:</p>
<pre><code class="language-sql">SELECT
    submission_date,
    mau,
    tier1_mau
FROM
    mozdata.telemetry.firefox_desktop_exact_mau28_v1
</code></pre>
<p>These views contain no dimensions and abstract away the detail that FxA
data uses the &quot;Last Seen in Tier 1 Country&quot; usage criterion while desktop
and non-desktop data use the &quot;Country&quot; dimension to determine tier 1 membership.</p>
<h1><a class="header" href="#additional-details" id="additional-details">Additional Details</a></h1>
<h2><a class="header" href="#inclusive-tier-1-calculation-for-fxa" id="inclusive-tier-1-calculation-for-fxa">Inclusive Tier 1 Calculation for FxA</a></h2>
<p>The 2019 Key Performance Indicator definition for Relationships relies on a MAU calculation restricted
to a specific set of &quot;Tier 1&quot; countries.
In the Exact MAU datasets, country is a dimension that would normally be specified
in a slice definition.
Indeed, for desktop and non-desktop clients, the definition of &quot;Tier 1 MAU&quot; looks like:</p>
<pre><code class="language-sql">SELECT
    submission_date,
    SUM(mau) AS mau
FROM
    mozdata.telemetry.firefox_desktop_exact_mau28_by_dimensions_v1
WHERE
    country IN ('US', 'UK', 'DE', 'FR', 'CA')
GROUP BY
    submission_date
ORDER BY
    submission_date
</code></pre>
<p>Remember that our non-overlapping dimensions methodology means that the filter
in the query above considers only the country value from the most recent daily
aggregation, so a user that appeared in one of the specified countries early
in the month but then changed location to a non-tier 1 country would not count
toward MAU.</p>
<p>Due to the methodology used when forecasting goal values for the year, however, we need to
follow a more inclusive definition for &quot;Tier 1 FxA MAU&quot; where a user counts if they register
even a single FxA event originating from a tier 1 country in the 28 day MAU window.
That calculation requires a separate &quot;FxA Seen in Tier 1 Country&quot; criterion
and is represented in the exact MAU table as <code>seen_in_tier1_country_mau</code>:</p>
<pre><code class="language-sql">SELECT
    submission_date,
    SUM(seen_in_tier1_country_mau) AS tier1_mau
FROM
    mozdata.telemetry.firefox_accounts_exact_mau28_by_dimensions_v1
GROUP BY
    submission_date
ORDER BY
    submission_date
</code></pre>
<h2><a class="header" href="#confidence-intervals-1" id="confidence-intervals-1">Confidence Intervals</a></h2>
<p>The Exact MAU tables enable tracking of MAU for potentially very small
subpopulations of users where statistical variation can often overwhelm
real trends in the data.
In order to support statistical inference (confidence intervals and hypothesis tests),
these tables include a &quot;pseudo-dimension&quot; we call <code>id_bucket</code>. We assign
each client (or user, in the case of FxA data) to one of 20 buckets based on a
hash of their <code>client_id</code> (or <code>user_id</code>), with the effect that each user is
randomly assigned to one and only one bucket. If we sum MAU numbers for each
bucket individually, we can use resampling techniques to determine the magnitude
of variation and assign a confidence interval to our sums.</p>
<p>As an example of calculating confidence intervals, see the
<a href="https://sql.telemetry.mozilla.org/queries/61957/source">Desktop MAU KPI query in STMO</a>
which uses a jackknife resampling technique implemented as a BigQuery UDF.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/bigquery/exact_mau/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#main-ping-tables" id="main-ping-tables">Main Ping Tables</a></h1>
<p>As described in the <a href="https://docs.telemetry.mozilla.org/concepts/pipeline/schemas.html">pipeline schemas deployment docs</a>,
data engineering has a process of generating schemas for pings and deploying them to BigQuery. The Main Ping table (<code>telemetry.main</code>)
is one of those generated tables.</p>
<p>As the number of telemetry probes defined in Firefox grows, so does the number of columns in <code>telemetry.main</code>. As of January 2021, we have nearly 10,000 columns, and we ingest many terabytes of main ping data per day. This combination of a very wide schema and a high data volume means that <a href="https://console.cloud.google.com/support/cases/detail/25679061?project=moz-fx-data-shared-prod">BigQuery has to reference metadata for a very large number of files</a> each time it runs a query, even if it only ends up needing to read a small fraction of those files. This has led to a problematic experience for iterative analysis use cases.</p>
<p>To reduce the time for querying main ping data, we have included two new tables: <code>telemetry.main_1pct</code>, and <code>telemetry.main_nightly</code>. These can return results for simple queries in a matter of seconds where a logically equivalent query on <code>telemetry.main</code> may take minutes.</p>
<h2><a class="header" href="#main-ping-sample-telemetrymain_1pct" id="main-ping-sample-telemetrymain_1pct">Main Ping Sample: <code>telemetry.main_1pct</code></a></h2>
<p>This table includes a 1% sample across all channels from <code>telemetry.main</code> (<code>sample_id = 0</code>).
It includes 6 months of history.</p>
<p>It includes an additional <code>subsample_id</code> field that is similar to <code>sample_id</code> and allows
efficient sampling for even smaller population sizes. The following query would reflect
a 0.01% sample (one thousandth) of the total desktop Firefox population:</p>
<pre><code class="language-sql">SELECT
  COUNT(*) AS n
FROM
  mozdata.telemetry.main_1pct
WHERE
  subsample_id = 0
  AND DATE(submission_timestamp) = '2021-01-01'
</code></pre>
<p>The choice of implementation for <code>subsample_id</code> is not particularly well vetted;
it's simply chosen to be a hash that's stable, has a reasonable
avalanche effect, and is <em>different</em> from <code>sample_id</code>.
The definition is <code>MOD(ABS(FARM_FINGERPRINT(client_id)), 100) AS subsample_id</code>
which is the same approach we use for choosing <code>id_bucket</code> in Exact MAU tables.</p>
<h2><a class="header" href="#nightly-main-ping-data-telemetrymain_nightly" id="nightly-main-ping-data-telemetrymain_nightly">Nightly Main Ping Data: <code>telemetry.main_nightly</code></a></h2>
<p>This table includes only data from the nightly release channel (<code>normalized_channel = 'nightly'</code>).
It includes 6 months of history.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/main_ping_tables.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#main-summary" id="main-summary">Main Summary</a></h1>
<blockquote>
<p><strong>⚠</strong> Since the introduction of BigQuery, we are able to represent the
full <code>main</code> ping structure in a table, available as <code>telemetry.main</code>.
New analyses should avoid <code>main_summary</code>, which exists only for compatibility.</p>
</blockquote>
<p>The <code>main_summary</code> table contains one row for each ping.
Each column represents one field from the main ping payload,
though only a subset of all main ping fields are included.
This dataset <strong>does not include most histograms</strong>.</p>
<p>This table is massive, and due to its size, it can be difficult to work with.</p>
<p>Instead, we recommend using the <code>clients_daily</code> or <code>clients_last_seen</code> dataset
where possible.</p>
<p>If you do need to query this table, make use of the <code>sample_id</code> field and
limit to a short submission date range.</p>
<h2><a class="header" href="#table-of-contents-12" id="table-of-contents-12">Table of Contents</a></h2>
<ul>
<li><a href="datasets/batch_view/main_summary/reference.html#accessing-the-data">Accessing the Data</a></li>
<li><a href="datasets/batch_view/main_summary/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/batch_view/main_summary/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/batch_view/main_summary/reference.html#sampling">Sampling</a></li>
<li><a href="datasets/batch_view/main_summary/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/batch_view/main_summary/reference.html#schema">Schema</a></li>
<li><a href="datasets/batch_view/main_summary/reference.html#time-formats">Time formats</a></li>
<li><a href="datasets/batch_view/main_summary/reference.html#user-preferences">User Preferences</a></li>
</ul>
</li>
<li><a href="datasets/batch_view/main_summary/reference.html#code-reference">Code Reference</a></li>
</ul>
<h2><a class="header" href="#accessing-the-data-4" id="accessing-the-data-4">Accessing the Data</a></h2>
<p>The <code>main_summary</code> table is accessible through STMO.
Here's an <a href="https://sql.telemetry.mozilla.org/queries/4201/source">example query</a>.</p>
<h2><a class="header" href="#data-reference-6" id="data-reference-6">Data Reference</a></h2>
<h3><a class="header" href="#example-queries-5" id="example-queries-5">Example Queries</a></h3>
<p>Compare the search volume for different search source values:</p>
<pre><code class="language-sql">WITH search_data AS (
  SELECT
    s.source AS search_source,
    s.count AS search_count
  FROM
    telemetry.main_summary
    CROSS JOIN UNNEST(search_counts) AS s
  WHERE
    submission_date_s3 = '2019-11-11'
    AND sample_id = 42
    AND search_counts IS NOT NULL
)

SELECT
  search_source,
  sum(search_count) as total_searches
FROM search_data
GROUP BY search_source
ORDER BY sum(search_count) DESC
</code></pre>
<h3><a class="header" href="#sampling" id="sampling">Sampling</a></h3>
<p>The <code>main_summary</code> dataset contains one record for each <code>main</code> ping
as long as the record contains a non-null value for
<code>documentId</code>, <code>submissionDate</code>, and <code>Timestamp</code>.
We do not ever expect nulls for these fields.</p>
<h3><a class="header" href="#scheduling-7" id="scheduling-7">Scheduling</a></h3>
<p>This dataset is updated daily via the <a href="https://github.com/mozilla/telemetry-airflow">telemetry-airflow</a> infrastructure.
The DAG is defined in
<a href="https://github.com/mozilla/bigquery-etl/blob/master/dags/bqetl_main_summary.py"><code>dags/bqetl_main_summary.py</code></a></p>
<h3><a class="header" href="#schema-5" id="schema-5">Schema</a></h3>
<p>As of 2019-11-28, the current version of the <code>main_summary</code> dataset is <code>v4</code>.</p>
<p>For more detail on where these fields come from in the
<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/main-ping.html">raw data</a>,
please look <a href="https://github.com/mozilla/bigquery-etl/tree/ad84a15d580333b41d36cfe8331e51238f3bafa1/sql/moz-fx-data-shared-prod/telemetry_derived/main_summary_v4">in the <code>main_summary</code> ETL code</a>.</p>
<p>Most of the fields are simple scalar values, with a few notable exceptions:</p>
<ul>
<li>The <code>search_count</code> field is an array of structs, each item in the array representing
a 3-tuple of (<code>engine</code>, <code>source</code>, <code>count</code>). The <code>engine</code> field represents the name of
the search engine against which the searches were done. The <code>source</code> field represents
the part of the Firefox UI that was used to perform the search. It contains values
such as <code>abouthome</code>, <code>urlbar</code>, and <code>searchbar</code>. The <code>count</code> field contains the number
of searches performed against this engine+source combination during that subsession.
Any of the fields in the struct may be null (for example if the search key did not
match the expected pattern, or if the count was non-numeric).</li>
<li>The <code>loop_activity_counter</code> field is a simple struct containing inner fields for each
expected value of the <code>LOOP_ACTIVITY_COUNTER</code> Enumerated Histogram. Each inner field
is a count for that histogram bucket.</li>
<li>The <code>popup_notification_stats</code> field is a map of <code>String</code> keys to struct values,
each field in the struct being a count for the expected values of the
<code>POPUP_NOTIFICATION_STATS</code> Keyed Enumerated Histogram.</li>
<li>The <code>places_bookmarks_count</code> and <code>places_pages_count</code> fields contain the <strong>mean</strong>
value of the corresponding Histogram, which can be interpreted as the average number
of bookmarks or pages in a given subsession.</li>
<li>The <code>active_addons</code> field contains an array of structs, one for each entry in
the <code>environment.addons.activeAddons</code> section of the payload. More detail in
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1290181">Bug 1290181</a>.</li>
<li>The <code>disabled_addons_ids</code> field contains an array of strings, one for each entry in
the <code>payload.addonDetails</code> which is not already reported in the <code>environment.addons.activeAddons</code>
section of the payload. More detail in
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1390814">Bug 1390814</a>.
Please note that while using this field is generally OK, this was introduced to support
the <a href="https://github.com/mozilla/taar/pulls">TAAR</a> project and you should not count on it
in the future. The field can stay in the <code>main_summary</code>, but we might need to slightly change
the ping structure to something better than <code>payload.addonDetails</code>.</li>
<li>The <code>theme</code> field contains a single struct in the same shape as the items in the
<code>active_addons</code> array. It contains information about the currently active browser
theme.</li>
<li>The <code>user_prefs</code> field contains a struct with values for preferences of interest.</li>
<li>The <code>events</code> field contains an array of event structs.</li>
<li>Dynamically-included histogram fields are present as key-&gt;value maps,
or key-&gt;(key-&gt;value) nested maps for keyed histograms.</li>
</ul>
<h3><a class="header" href="#time-formats" id="time-formats">Time formats</a></h3>
<p>Columns in <code>main_summary</code> may use one of a handful of time formats with different precisions:</p>
<table><thead><tr><th>Column Name</th><th>Origin</th><th>Description</th><th>Example</th><th>Spark</th><th>Presto</th></tr></thead><tbody>
<tr><td><code>timestamp</code></td><td>stamped at ingestion</td><td>nanoseconds since epoch</td><td><code>1504689165972861952</code></td><td><code>from_unixtime(timestamp/1e9)</code></td><td><code>from_unixtime(timestamp/1e9)</code></td></tr>
<tr><td><code>submission_date_s3</code></td><td>derived from timestamp</td><td><code>YYYYMMDD</code> date string of timestamp in UTC</td><td><code>20170906</code></td><td><code>from_unixtime(unix_timestamp(submission_date, 'yyyyMMdd'))</code></td><td><code>date_parse(submission_date, '%Y%m%d')</code></td></tr>
<tr><td><code>client_submission_date</code></td><td>derived from HTTP header: <code>Fields[Date]</code></td><td>HTTP date header string sent with the ping</td><td><code>Tue, 27 Sep 2016 16:28:23 GMT</code></td><td><code>unix_timestamp(client_submission_date, 'EEE, dd M yyyy HH:mm:ss zzz')</code></td><td><code>date_parse(substr(client_submission_date, 1, 25), '%a, %d %b %Y %H:%i:%s')</code></td></tr>
<tr><td><code>creation_date</code></td><td><code>creationDate</code></td><td>time of ping creation ISO8601 at UTC+0</td><td><code>2017-09-06T08:21:36.002Z</code></td><td><code>to_timestamp(creation_date, &quot;yyyy-MM-dd'T'HH:mm:ss.SSSXXX&quot;)</code></td><td><code>from_iso8601_timestamp(creation_date) AT TIME ZONE 'GMT'</code></td></tr>
<tr><td><code>timezone_offset</code></td><td><code>info.timezoneOffset</code></td><td>timezone offset in minutes</td><td><code>120</code></td><td></td><td></td></tr>
<tr><td><code>subsession_start_date</code></td><td><code>info.subsessionStartDate</code></td><td>hourly precision, ISO8601 date in local time</td><td><code>2017-09-06T00:00:00.0+02:00</code></td><td></td><td><code>from_iso8601_timestamp(subsession_start_date) AT TIME ZONE 'GMT'</code></td></tr>
<tr><td><code>subsession_length</code></td><td><code>info.subsessionLength</code></td><td>subsession length in seconds</td><td><code>599</code></td><td></td><td><code>date_add('second', subsession_length, subsession_start_date)</code></td></tr>
<tr><td><code>profile_creation_date</code></td><td><code>environment.profile.creationDate</code></td><td>days since epoch</td><td><code>15,755</code></td><td></td><td><code>from_unixtime(profile_creation_date * 86400)</code></td></tr>
</tbody></table>
<h3><a class="header" href="#user-preferences" id="user-preferences">User Preferences</a></h3>
<p>These are added in the <a href="https://github.com/mozilla/bigquery-etl/blob/ad84a15d580333b41d36cfe8331e51238f3bafa1/sql/moz-fx-data-shared-prod/telemetry_derived/main_summary_v4/part1.sql#L476-L501">Main Summary ETL code</a>.
They must be available in the <a href="http://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/environment.html">ping environment</a> to be included here.</p>
<p>Once added, they will show as top-level fields, with the string <code>user_pref</code> prepended.
For example, <code>dom.ipc.processCount</code> becomes <code>user_pref_dom_ipc_processcount</code>.</p>
<h2><a class="header" href="#code-reference-6" id="code-reference-6">Code Reference</a></h2>
<p>This dataset is generated by <a href="https://github.com/mozilla/bigquery-etl/tree/ad84a15d580333b41d36cfe8331e51238f3bafa1/sql/moz-fx-data-shared-prod/telemetry_derived/main_summary_v4">bigquery-etl</a>.
Refer to this repository for information on how to run or augment the dataset.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/batch_view/main_summary/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#socorro-crash-reports" id="socorro-crash-reports">Socorro Crash Reports</a></h1>
<ul>
<li><a href="datasets/other/socorro_crash/reference.html#introduction">Introduction</a></li>
<li><a href="datasets/other/socorro_crash/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/other/socorro_crash/reference.html#example">Example</a></li>
<li><a href="datasets/other/socorro_crash/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/other/socorro_crash/reference.html#schema">Schema</a></li>
<li><a href="datasets/other/socorro_crash/reference.html#code-reference">Code Reference</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#introduction-6" id="introduction-6">Introduction</a></h2>
<p>Public crash statistics for Firefox are available through the Data Platform in a <code>socorro_crash</code> dataset.
The crash data in <a href="https://wiki.mozilla.org/Socorro">Socorro</a> is sanitized and made available to STMO.
A nightly import job converts batches of JSON documents into a columnar format using the associated JSON Schema.</p>
<h2><a class="header" href="#data-reference-7" id="data-reference-7">Data Reference</a></h2>
<h3><a class="header" href="#example" id="example">Example</a></h3>
<p>The dataset can be queried using SQL.
For example, we can aggregate the number of crashes and total up-time by date and reason.</p>
<pre><code class="language-sql">SELECT crash_date,
       reason,
       count(*) as n_crashes,
       avg(uptime) as avg_uptime,
       stddev(uptime) as stddev_uptime,
       approx_percentile(uptime, ARRAY [0.25, 0.5, 0.75]) as qntl_uptime
FROM socorro_crash
WHERE crash_date='20180520'
GROUP BY 1,
         2
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/53884/source">STMO Source</a></p>
<h3><a class="header" href="#scheduling-8" id="scheduling-8">Scheduling</a></h3>
<p>The job is schedule on a nightly basis on airflow.
The dag is available under <a href="https://github.com/mozilla/telemetry-airflow/blob/master/dags/socorro_import.py"><code>mozilla/telemetry-airflow:/dags/socorro_import.py</code></a>.</p>
<h3><a class="header" href="#schema-6" id="schema-6">Schema</a></h3>
<p>The source schema is available on the <a href="https://raw.githubusercontent.com/mozilla-services/socorro/main/socorro/schemas/telemetry_socorro_crash.json"><code>mozilla-services/socorro</code> GitHub repository</a>.
This schema is transformed into a Spark-SQL structure and serialized to parquet after transforming column names from <code>camelCase</code> to <code>snake_case</code>.</p>
<h3><a class="header" href="#code-reference-7" id="code-reference-7">Code Reference</a></h3>
<p>The code is <a href="https://github.com/mozilla-services/data-pipeline/blob/master/reports/socorro_import/ImportCrashData.ipynb">a notebook in the <code>mozilla-services/data-pipeline</code> repository</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/other/socorro_crash/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#ssl-ratios" id="ssl-ratios">SSL Ratios</a></h1>
<ul>
<li><a href="datasets/other/ssl/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/other/ssl/reference.html#content">Content</a></li>
<li><a href="datasets/other/ssl/reference.html#background-and-caveats">Background and Caveats</a></li>
<li><a href="datasets/other/ssl/reference.html#accessing-the-data">Accessing the Data</a></li>
</ul>
</li>
<li><a href="datasets/other/ssl/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/other/ssl/reference.html#combining-rows">Combining Rows</a></li>
<li><a href="datasets/other/ssl/reference.html#schema">Schema</a></li>
<li><a href="datasets/other/ssl/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/other/ssl/reference.html#public-data">Public Data</a></li>
<li><a href="datasets/other/ssl/reference.html#code-reference">Code Reference</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#introduction-7" id="introduction-7">Introduction</a></h1>
<p>The public SSL dataset publishes the percentage of page loads Firefox users have performed
that were conducted over SSL. This dataset is used to produce graphs like
<a href="https://letsencrypt.org/stats/">Let's Encrypt's</a> to determine SSL adoption on the Web
over time.</p>
<h4><a class="header" href="#content-1" id="content-1">Content</a></h4>
<p>The public SSL dataset is a table where each row is a distinct set of dimensions, with their
associated SSL statistics. The dimensions are <code>submission_date</code>, <code>os</code>, and <code>country</code>. The
statistics are <code>reporting_ratio</code>, <code>normalized_pageloads</code>, and <code>ratio</code>.</p>
<h4><a class="header" href="#background-and-caveats-1" id="background-and-caveats-1">Background and Caveats</a></h4>
<ul>
<li>We're using normalized values in <code>normalized_pageloads</code> to obscure absolute page load counts.</li>
<li>This is across the entirety of release, not per-version, because we're looking at Web health,
not Firefox user health.</li>
<li>Any dimension tuple (any given combination of <code>submission_date</code>, <code>os</code>, and <code>country</code>) with
fewer than 5000 page loads is omitted from the dataset.</li>
<li>This is hopefully just a temporary dataset to stopgap release aggregates going away
until we can come up with a better way to publicly publish datasets.</li>
</ul>
<h4><a class="header" href="#accessing-the-data-5" id="accessing-the-data-5">Accessing the Data</a></h4>
<p>For details on accessing the data, please look at
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1414839">bug 1414839</a>.</p>
<h1><a class="header" href="#data-reference-8" id="data-reference-8">Data Reference</a></h1>
<h2><a class="header" href="#combining-rows" id="combining-rows">Combining Rows</a></h2>
<p>This is a dataset of ratios. You can't combine ratios if they have different bases. For example,
if 50% of 10 loads (5 loads) were SSL and 5% of 20 loads (1 load) were SSL, you cannot calculate
that 20% (6 loads) of the total loads (30 loads) were SSL unless you know that the 50% was for
10 and the 5% was for 20.</p>
<p>If you're reluctant, for product reasons, to share the numbers 10 and 20, this gets tricky.</p>
<p>So what we've done is normalize the whole batch of 30 down to 1. That means we tell you that
50% of one-third of the loads (0.333...) was SSL and 5% of the other two-thirds of the loads
(0.666...) was SSL. Then you can figure out the overall 20% figure by this calculation:</p>
<p><code>0.5 * 0.333 + 0.05 * 0.666 = 0.2</code></p>
<p>For this dataset the same rule applies. To combine rows' ratios (to, for example, see what the
SSL ratio was across all <code>os</code> and <code>country</code> for a given <code>submission_date</code>), you must first
multiply them by the rows' <code>normalized_pageviews</code> values.</p>
<p>Or, in JavaScript:</p>
<pre><code class="language-js">let rows = query_result.data.rows;
let ratioForDateInQuestion = rows
  .filter((row) =&gt; row.submission_date == dateInQuestion)
  .reduce((row, acc) =&gt; acc + row.normalized_pageloads * row.ratio, 0);
</code></pre>
<h2><a class="header" href="#schema-7" id="schema-7">Schema</a></h2>
<p>The data is output in STMO API format:</p>
<pre><code>&quot;query_result&quot;: {
  &quot;retrieved_at&quot;: &lt;timestamp&gt;,
  &quot;query_hash&quot;: &lt;hash&gt;,
  &quot;query&quot;: &lt;SQL&gt;,
  &quot;runtime&quot;: &lt;number of seconds&gt;,
  &quot;id&quot;: &lt;an id&gt;,
  &quot;data_source_id&quot;: 26, // Athena
  &quot;data_scanned&quot;: &lt;some really large number, as a string&gt;,
  &quot;data&quot;: {
    &quot;data_scanned&quot;: &lt;some really large number, as a number&gt;,
    &quot;columns&quot;: [
      {&quot;friendly_name&quot;: &quot;submission_date&quot;, &quot;type&quot;: &quot;datetime&quot;, &quot;name&quot;: &quot;submission_date&quot;},
      {&quot;friendly_name&quot;: &quot;os&quot;, &quot;type&quot;: &quot;string&quot;, &quot;name&quot;: &quot;os&quot;},
      {&quot;friendly_name&quot;: &quot;country&quot;, &quot;type&quot;: &quot;string&quot;, &quot;name&quot;: &quot;country&quot;},
      {&quot;friendly_name&quot;: &quot;reporting_ratio&quot;, &quot;type&quot;: &quot;float&quot;, &quot;name&quot;: &quot;reporting_ratio&quot;},
      {&quot;friendly_name&quot;: &quot;normalized_pageloads&quot;, &quot;type&quot;: &quot;float&quot;, &quot;name&quot;: &quot;normalized_pageloads&quot;},
      {&quot;friendly_name&quot;: &quot;ratio&quot;, &quot;type&quot;: &quot;float&quot;, &quot;name&quot;: &quot;ratio&quot;}
    ],
    &quot;rows&quot;: [
      {
        &quot;submission_date&quot;: &quot;2017-10-24T00:00:00&quot;, // date string, day resolution
        &quot;os&quot;: &quot;Windows_NT&quot;, // operating system family of the clients reporting the pageloads. One of &quot;Windows_NT&quot;, &quot;Linux&quot;, or &quot;Darwin&quot;.
        &quot;country&quot;: &quot;CZ&quot;, // ISO 639 two-character country code, or &quot;??&quot; if we have no idea. Determined by performing a geo-IP lookup of the clients that submitted the pings.
        &quot;reporting_ratio&quot;: 0.006825266611977031, // the ratio of pings that reported any pageloads at all. A number between 0 and 1. See [bug 1413258](https://bugzilla.mozilla.org/show_bug.cgi?id=1413258).
        &quot;normalized_pageloads&quot;: 0.00001759145263985348, // the proportion of total pageloads in the dataset that are represented by this row. Provided to allow combining rows. A number between 0 and 1.
        &quot;ratio&quot;: 0.6916961976822144 // the ratio of the pageloads that were performed over SSL. A number between 0 and 1.
      }, ...
    ]
  }
}
</code></pre>
<h2><a class="header" href="#scheduling-9" id="scheduling-9">Scheduling</a></h2>
<p>The dataset updates every 24 hours.</p>
<h2><a class="header" href="#public-data-1" id="public-data-1">Public Data</a></h2>
<p>The data is publicly available on BigQuery: <code>mozilla-public-data.telemetry_derived.ssl_ratios_v1</code>.
Data can also be accessed through the public HTTP endpoint: <a href="https://public-data.telemetry.mozilla.org/api/v1/tables/telemetry_derived/ssl_ratios/v1/files">https://public-data.telemetry.mozilla.org/api/v1/tables/telemetry_derived/ssl_ratios/v1/files</a></p>
<h2><a class="header" href="#code-reference-8" id="code-reference-8">Code Reference</a></h2>
<p>You can find the query that generates the SSL dataset
<a href="https://sql.telemetry.mozilla.org/queries/49323/source#table">here</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/other/ssl/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#telemetry-aggregates-reference" id="telemetry-aggregates-reference">Telemetry Aggregates Reference</a></h1>
<ul>
<li><a href="datasets/batch_view/telemetry_aggregates/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/batch_view/telemetry_aggregates/reference.html#rows-and-columns">Rows and Columns</a></li>
<li><a href="datasets/batch_view/telemetry_aggregates/reference.html#accessing-the-data">Accessing the Data</a></li>
</ul>
</li>
<li><a href="datasets/batch_view/telemetry_aggregates/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/batch_view/telemetry_aggregates/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/batch_view/telemetry_aggregates/reference.html#sampling">Sampling</a>
<ul>
<li><a href="datasets/batch_view/telemetry_aggregates/reference.html#invalid-pings">Invalid Pings</a></li>
</ul>
</li>
<li><a href="datasets/batch_view/telemetry_aggregates/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/batch_view/telemetry_aggregates/reference.html#schema">Schema</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#introduction-8" id="introduction-8">Introduction</a></h1>
<p>The <code>telemetry_aggregates</code> dataset is a daily aggregation of the pings,
aggregating the histograms across a set of dimensions.</p>
<h4><a class="header" href="#rows-and-columns" id="rows-and-columns">Rows and Columns</a></h4>
<p>There's one column for each of the dimensions and the histogram and each row
is a distinct set of dimensions, along with their associated histograms.</p>
<h4><a class="header" href="#accessing-the-data-6" id="accessing-the-data-6">Accessing the Data</a></h4>
<p>This dataset is accessible via STMO by selecting from <code>telemetry_aggregates</code>.</p>
<p>The data is stored as a parquet table in S3 at the following address.</p>
<pre><code>s3://telemetry-parquet/aggregates_poc/v1/
</code></pre>
<h1><a class="header" href="#data-reference-9" id="data-reference-9">Data Reference</a></h1>
<h2><a class="header" href="#example-queries-6" id="example-queries-6">Example Queries</a></h2>
<p>Here's an example query that shows the number of pings received per
<code>submission_date</code> for the dimensions provided.</p>
<pre><code class="language-sql">SELECT
    submission_date,
    SUM(count) AS pings
FROM
    telemetry_aggregates
WHERE
    channel = 'nightly'
    AND metric = 'GC_MS'
    AND aggregate_type = 'build_id'
    AND period = '201901'
GROUP BY
    submission_date
ORDER BY
    submission_date
;
</code></pre>
<h2><a class="header" href="#sampling-1" id="sampling-1">Sampling</a></h2>
<h3><a class="header" href="#invalid-pings" id="invalid-pings">Invalid Pings</a></h3>
<p>We ignore invalid pings in our processing. Invalid pings are defined as those that:</p>
<ul>
<li>The submission dates are invalid or missing.</li>
<li>The build ID is malformed.</li>
<li>The <code>docType</code> field is missing or unknown.</li>
<li>The build ID is older than a defined cutoff days.
(See the <code>BUILD_ID_CUTOFFS</code> variable in the
<a href="https://github.com/mozilla/python_mozaggregator/">code</a> for the max days per channel)</li>
</ul>
<h2><a class="header" href="#scheduling-10" id="scheduling-10">Scheduling</a></h2>
<p>The <code>telemetry_aggregates</code> job is run daily, at midnight UTC.
The job is scheduled on <a href="https://github.com/mozilla/telemetry-airflow">Airflow</a>.
The DAG is <a href="https://github.com/mozilla/telemetry-airflow/blob/831fe84a36347f440ede4f5a90e0bf83d4fa1e1e/dags/mozaggregator_parquet.py">here</a></p>
<h2><a class="header" href="#schema-8" id="schema-8">Schema</a></h2>
<p>The <code>telemetry_aggregates</code> table has a set of dimensions and set of
aggregates for those dimensions.</p>
<p>The partitioned dimensions are the following columns. Filtering by one of
these fields to limit the resulting number of rows can run significantly
faster:</p>
<ul>
<li><code>metric</code> is the name of the metric, like <code>&quot;GC_MS&quot;</code>.</li>
<li><code>aggregate_type</code> is the type of aggregation, either <code>&quot;build_id&quot;</code> or
<code>&quot;submission_date&quot;</code>, representing how this aggregation was grouped.</li>
<li><code>period</code> is a string representing the month in <code>YYYYMM</code> format that a ping
was submitted, like <code>'201901'</code>.</li>
</ul>
<p>The rest of the dimensions are:</p>
<ul>
<li><code>submission_date</code> is the date pings were submitted for a particular aggregate.</li>
<li><code>channel</code> is the channel, like <code>release</code> or <code>beta</code>.</li>
<li><code>version</code> is the program version, like <code>46.0a1</code>.</li>
<li><code>build_id</code> is the <code>YYYYMMDDhhmmss</code> timestamp the program was built, like
<code>20190123192837</code>.</li>
<li><code>application</code> is the program name, like <code>Firefox</code> or <code>Fennec</code>.</li>
<li><code>architecture</code> is the architecture that the program was built for (not
necessarily the one it is running on).</li>
<li><code>os</code> is the name of the OS the program is running on, like <code>Darwin</code> or <code>Windows_NT</code>.</li>
<li><code>os_version</code> is the version of the OS the program is running on.</li>
<li><code>key</code> is the key of a keyed metric. This will be empty if the underlying
metric is not a keyed metric.</li>
<li><code>process_type</code> is the process the histogram was recorded in, like <code>content</code>
or <code>parent</code>.</li>
</ul>
<p>The aggregates are:</p>
<ul>
<li><code>count</code> is the aggregate sum of the number of pings per dimensions.</li>
<li><code>sum</code> is the aggregate sum of the histogram values per dimensions.</li>
<li><code>histogram</code> is the aggregated histogram per dimensions.</li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/batch_view/telemetry_aggregates/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#work-in-progress" id="work-in-progress">Work in Progress</a></h1>
<p>This article is a work in progress.
The work is being tracked in
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1341812">this bug</a>.</p>
<h1><a class="header" href="#guide-to-our-experimental-tools" id="guide-to-our-experimental-tools">Guide to our Experimental Tools</a></h1>
<h2><a class="header" href="#shield" id="shield">Shield</a></h2>
<ul>
<li>Shield is an addon-based experimentation platform with fine-tuned enrollment criteria. The system add-on landed in FF 53.</li>
<li>For the moment, it sends back data in its own <code>shield</code> type ping, so there's lots of flexibility in data you can collect.</li>
<li>Uses the Normandy server to serve out study “recipes” (?)</li>
<li>Annotates the main ping in the environment/experiments block</li>
<li>The shield system is itself a system add-on, so rolling out changes to the entire system does not require riding release trains</li>
<li>Strategy and Insights (strategyandinsights@mozilla.com) team are product owners and shepherd the study development and release process along</li>
<li>Opt-out experiments should be available soon?</li>
<li>Further reading:
<ul>
<li>https://wiki.mozilla.org/Firefox/SHIELD</li>
<li>https://wiki.mozilla.org/Firefox/Shield/Shield_Studies</li>
<li><a href="tools/BROKEN:https://mozilla.github.io/shield-studies-docs/study-process/">https://mozilla.github.io/shield-studies-docs/study-process/</a></li>
<li>When should you use SHIELD over other options?</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#preference-flipping-experiments" id="preference-flipping-experiments">Preference Flipping experiments</a></h2>
<p>Uses Normandy, requires NO additional addon as long as a preference rides the release train</p>
<h2><a class="header" href="#heartbeat" id="heartbeat">Heartbeat</a></h2>
<p>Survey mechanism, also run via Normandy</p>
<h2><a class="header" href="#telemetry-experiments" id="telemetry-experiments">Telemetry Experiments</a></h2>
<p>Pre-release only
<a href="tools/BROKEN:https://gecko.readthedocs.io/en/latest/browser/experiments/experiments/index.html">https://gecko.readthedocs.io/en/latest/browser/experiments/experiments/index.html</a></p>
<h2><a class="header" href="#funnelcake" id="funnelcake">Funnelcake</a></h2>
<p>Custom builds of Firefox that are served to some percentage of the direct download population</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/tools/experiments.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#jetstream-datasets" id="jetstream-datasets">Jetstream datasets</a></h1>
<ul>
<li><a href="datasets/jetstream.html#statistics-tables">Statistics tables</a>
<ul>
<li><a href="datasets/jetstream.html#examples">Examples</a></li>
</ul>
</li>
<li><a href="datasets/jetstream.html#client-window-aggregate-tables">Client-window aggregate tables</a></li>
<li><a href="datasets/jetstream.html#scheduling">Scheduling</a></li>
<li><a href="datasets/jetstream.html#code-reference">Code reference</a></li>
</ul>
<p>Statistical summaries of telemetry data from experiments run in Mozilla
products are provided by <a href="https://github.com/mozilla/jetstream">Jetstream</a>. These summaries are published to
BigQuery and serve both as the substrate for the result visualization
platform and as a resource for data scientists.</p>
<p>Jetstream runs as part of the nightly ETL job (see <a href="datasets/jetstream.html#scheduling">Scheduling</a> below).
Jetstream is also run after pushes to the <a href="https://github.com/mozilla/jetstream-config"><code>jetstream-config</code></a> repository.
Jetstream publishes tables to the dataset <code>moz-fx-data-experiments.mozanalysis</code>.</p>
<p>Experiments are analyzed using the concept of analysis windows. Analysis
windows describe an interval marked from each client’s day of
enrollment. The “day 0” analysis window aggregates data from the days
that each client enrolled in the experiment. Because the intervals are
demarcated from enrollment, they are not calendar dates; for some
clients in an experiment, day 0 could be a Tuesday, and for others a
Saturday.</p>
<p>The week 0 analysis window aggregates data from each client’s days 0
through 6, the week 1 window aggregates data from days 7 through 13, and
so on.</p>
<p>Clients are given a fixed amount of time, specified in Experimenter and
often a week long, to enroll. Final day 0 results are available for
reporting at the end of the enrollment period, after the last eligible
client has enrolled, and week 0 results are available a week after the
enrollment period closes. Results for each window are published as soon
as complete data is available for all enrolled clients.</p>
<p>The “overall” window, published after the experiment has ended, is a
window beginning on each client’s day 0 that spans the longest period
for which all clients have complete data.</p>
<p>Jetstream computes statistics over several metrics by default, including
for any features associated with the experiment in Experimenter. Data
scientists can provide configuration to add additional metrics. Advice
on configuring Jetstream can be found at the <a href="https://github.com/mozilla/jetstream-config"><code>jetstream-config</code></a> repository.</p>
<h2><a class="header" href="#statistics-tables" id="statistics-tables">Statistics tables</a></h2>
<p>The statistics tables contain statistical summaries of their
corresponding aggregate tables. These tables are suitable for plotting
directly without additional transformations.</p>
<p>Statistics tables are named like:</p>
<p><code>statistics_&lt;slug&gt;_{day, week, overall}_&lt;index&gt;</code></p>
<p>A view is also created that concatenates all statistics tables for an
experiment of a given period type, named like:</p>
<p><code>statistics_&lt;slug&gt;_{daily, weekly, overall}</code></p>
<p>Statistics tables have the schema:</p>
<table><thead><tr><th>Column name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>segment</code></td><td><code>STRING</code></td><td>The segment of the population being analyzed. “all” for the entire population.</td></tr>
<tr><td><code>metric</code></td><td><code>STRING</code></td><td>The slug of the metric, like <code>active_ticks</code> or <code>retained</code></td></tr>
<tr><td><code>statistic</code></td><td><code>STRING</code></td><td>The slug of the statistic that was used to summarize the metric, like “mean” or “deciles”</td></tr>
<tr><td><code>parameter</code></td><td><code>NUMERIC</code> (decimal)</td><td>A statistic-dependent quantity. For two-dimensional statistics like “decile,” this represents the x axis of the plot. For one-dimensional statistics, this is NULL.</td></tr>
<tr><td><code>comparison</code></td><td><code>STRING</code></td><td>If this row represents a comparison between two branches, this row describes what kind of comparison, like <code>difference</code> or <code>relative_uplift</code>. If this row represents a measurement of a single branch, then this column is NULL.</td></tr>
<tr><td><code>comparison_to_branch</code></td><td><code>STRING</code></td><td>If this row represents a comparison between two branches, this row describes which branch is being compared to. For simple A/B tests, this will be “control.”</td></tr>
<tr><td><code>ci_width</code></td><td><code>FLOAT64</code></td><td>A value between 0 and 1 describing the width of the confidence interval represented by the lower and upper columns. Valued at 0.95 for 95% confidence intervals.</td></tr>
<tr><td><code>point</code></td><td><code>FLOAT64</code></td><td>The point estimate of the statistic for the metric given the parameter.</td></tr>
<tr><td><code>lower</code></td><td><code>FLOAT64</code></td><td>The lower bound of the confidence interval for the estimate.</td></tr>
<tr><td><code>upper</code></td><td><code>FLOAT64</code></td><td>The upper bound of the confidence interval for the estimate.</td></tr>
<tr><td><code>window_index</code></td><td><code>INT64</code></td><td>(views only) A base-1 index reflecting the analysis window from which the row is drawn (i.e. day 1, day 2, …).</td></tr>
</tbody></table>
<p>Each combination of <code>(segment, metric, statistic, parameter, comparison, comparison_to_branch, ci_width)</code> uniquely describes a single data
point.</p>
<p>The available segments in a table should be derived from inspection of
the table.</p>
<p><a href="https://github.com/mozilla/jetstream/wiki">Jetstream’s Github wiki</a> has a description of each statistic and
comparison.</p>
<h3><a class="header" href="#examples" id="examples">Examples</a></h3>
<p>To extract the mean of <code>active_hours</code> for each branch from a weekly
statistics view with a name like <code>statistics_bug_12345_slug_weekly</code>,
you could run the query:</p>
<pre><code class="language-sql">SELECT
    segment,
    window_index AS week,
    branch,
    point,
    lower,
    upper
FROM `moz-fx-data-experiments`.mozanalysis.statistics_bug_12345_slug_weekly
WHERE
    metric = &quot;active_hours&quot;
    AND statistic = &quot;mean&quot;
    AND comparison IS NULL
</code></pre>
<p>This query would return a row for each user segment, for each week of
the experiment, for each branch, with the mean of the <code>active_hours</code>
metric.</p>
<p>To see whether the absolute difference of the mean of <code>active_hours</code> was
different between the control and treatment branches, you could run:</p>
<pre><code class="language-sql">SELECT
    window_index AS week,
    branch,
    point,
    lower,
    upper
FROM `moz-fx-data-experiments`.mozanalysis.statistics_bug_12345_slug_weekly
WHERE
    metric = &quot;active_hours&quot;
    AND statistic = &quot;mean&quot;
    AND comparison = &quot;difference&quot;
    AND branch = &quot;treatment&quot;
    AND comparison_to_branch = &quot;control&quot;
    AND segment = &quot;all&quot;
</code></pre>
<p>This query would return a row for each week of the experiment containing
an estimate of the absolute difference between the treatment and control
branches for the segment containing all users.</p>
<h2><a class="header" href="#client-window-aggregate-tables" id="client-window-aggregate-tables">Client-window aggregate tables</a></h2>
<p>The aggregate tables contain one row per enrolled <code>client_id</code>. An
aggregate table is written for each analysis window. The statistics
tables are derived from the aggregate tables. The aggregate tables are
less useful without additional processing but they may be useful for
diagnostics.</p>
<p>Aggregate tables are named like:</p>
<p><code>&lt;slug&gt;_{day,week,overall}_&lt;index&gt;</code></p>
<p>Aggregate tables have flexible schemas. Every table contains the
columns:</p>
<table><thead><tr><th>Column name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>client_id</code></td><td><code>STRING</code></td><td>Client’s telemetry <code>client_id</code></td></tr>
<tr><td><code>branch</code></td><td><code>STRING</code></td><td>Branch client enrolled in</td></tr>
<tr><td><code>enrollment_date</code></td><td><code>DATE</code></td><td>First date that the client enrolled in the branch</td></tr>
<tr><td><code>num_enrollment_events</code></td><td><code>INT64</code></td><td>Number of times a client enrolled in the given branch</td></tr>
<tr><td><code>analysis_window_start</code></td><td><code>INT64</code></td><td>The day after enrollment that this analysis window began; day 0 is the day of enrollment</td></tr>
<tr><td><code>analysis_window_end</code></td><td><code>INT64</code></td><td>The day after enrollment that this analysis window terminated (inclusive)</td></tr>
</tbody></table>
<p>The combination of <code>(client_id, branch)</code> is unique.</p>
<p>Each metric associated with the experiment defines an additional
(arbitrarily-typed) column.</p>
<p>Each data source associated with the experiment defines additional
<code>&lt;data_source&gt;_has_contradictory_branch</code> and
<code>&lt;data_source&gt;_has_non_enrolled_data</code> columns, which respectively
indicate whether <code>client_id</code> reported data from more than one branch or
without any tagged branch in that dataset over that analysis window.</p>
<p>Each segment associated with the experiment defines an additional boolean column.</p>
<h2><a class="header" href="#scheduling-11" id="scheduling-11">Scheduling</a></h2>
<p>Jetstream is updated nightly by telemetry-airflow.
It is invoked by the <a href="https://github.com/mozilla/telemetry-airflow/blob/master/dags/jetstream.py"><code>jetstream</code> DAG</a>.</p>
<h2><a class="header" href="#code-reference-9" id="code-reference-9">Code reference</a></h2>
<p>Jetstream's datasets are generated by invoking <a href="https://github.com/mozilla/jetstream">Jetstream</a>.
Data scientists can configure Jetstream or trigger a Jetstream invocation
by interacting with the <a href="https://github.com/mozilla/jetstream-config"><code>jetstream-config</code></a> repository.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/jetstream.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#accessing-heartbeat-data" id="accessing-heartbeat-data">Accessing Heartbeat data</a></h1>
<p><a href="https://docs.telemetry.mozilla.org/tools/experiments.html#heartbeat">Heartbeat</a> survey studies return telemetry on user engagement with the survey prompt.
The heartbeat pings do not contain the survey responses themselves,
which are stored by SurveyGizmo.</p>
<p>The telemetry is received using the <code>heartbeat</code> document type,
which is <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/heartbeat-ping.html">described in the Firefox source tree docs</a>.</p>
<h2><a class="header" href="#linking-heartbeat-responses-to-telemetry" id="linking-heartbeat-responses-to-telemetry">Linking Heartbeat responses to telemetry</a></h2>
<p>Heartbeat responses may be linked to Firefox telemetry
if there is a <code>&quot;includeTelemetryUUID&quot;: true</code> key in the <code>arguments</code> object
of the <a href="https://mozilla.github.io/normandy/user/actions/show-heartbeat.html"><code>show-heartbeat</code> recipe</a>.</p>
<p>Heartbeat never reports telemetry <code>client_id</code>s to SurveyGizmo, but,
when <code>includeTelemetryUUID</code> is true,
the Normandy <code>user_id</code> is reported to SurveyGizmo
as the <code>userid</code> URL variable.
Simultaneously, a <code>heartbeat</code> ping is sent to Mozilla,
containing both the telemetry <code>client_id</code> and the Normandy <code>userid</code> that was reported to SurveyGizmo.</p>
<p>The <code>userid</code> is reported by appending it to the <code>surveyId</code> field of the ping, like:</p>
<pre><code>hb-example-slug::e87bcae5-bb63-4829-822a-85ba41ee5d53
</code></pre>
<p>These can be extracted from the ping table for analysis using expressions like:</p>
<pre><code class="language-sql">SPLIT(payload.survey_id,'::')[OFFSET(1)] AS surveygizmo_userid
</code></pre>
<h2><a class="header" href="#data-reference-10" id="data-reference-10">Data reference</a></h2>
<p>Heartbeat data is available in the <code>telemetry.heartbeat</code> table in BigQuery.</p>
<p>Its structure matches the <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/blob/8b0641ebb8aad570b79e811ae10fd81c718af48f/schemas/telemetry/heartbeat/heartbeat.4.schema.json">heartbeat ping schema</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/heartbeat.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#analyzing-data-from-shield-studies" id="analyzing-data-from-shield-studies">Analyzing data from SHIELD studies</a></h1>
<p>This article introduces the datasets that are useful for analyzing SHIELD studies.
After reading this article,
you should understand how to answer questions about
study enrollment,
identify telemetry from clients enrolled in an experiment,
and locate telemetry from add-on studies.</p>
<h2><a class="header" href="#table-of-contents-13" id="table-of-contents-13">Table of contents</a></h2>
<ul>
<li><a href="datasets/shield.html#dashboards">Dashboards</a></li>
<li><a href="datasets/shield.html#experiment-slugs">Experiment slugs</a></li>
<li><a href="datasets/shield.html#tables">Tables</a>
<ul>
<li><a href="datasets/shield.html#experiments-column"><code>experiments</code> column</a></li>
<li><a href="datasets/shield.html#experiments"><code>experiments</code></a></li>
<li><a href="datasets/shield.html#events"><code>events</code></a></li>
<li><a href="datasets/shield.html#telemetryshield_study_addon"><code>telemetry.shield_study_addon</code></a></li>
<li><a href="datasets/shield.html#telemetryshield_study"><code>telemetry.shield_study</code></a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#dashboards-3" id="dashboards-3">Dashboards</a></h2>
<p><a href="https://experimenter.services.mozilla.com/">Experimenter</a> is the place to find lists of live experiments.</p>
<h2><a class="header" href="#experiment-slugs" id="experiment-slugs">Experiment slugs</a></h2>
<p>Each experiment is associated with a slug,
which is the label used to identify the experiment to Normandy clients.
The slug is also used to identify the experiment in most telemetry.
The slug for pref-flip experiments is defined in the recipe by a field named <code>slug</code>;
the slug for add-on experiments is defined in the recipe by a field named <code>name</code>.</p>
<p>You can determine the slug for a particular experiment by consulting
<a href="https://metrics.mozilla.com/%7Esguha/report/normandy_recipes.html">this summary table</a>
or the list of active recipes at
https://normandy.cdn.mozilla.net/api/v1/recipe/signed/.</p>
<h2><a class="header" href="#tables-2" id="tables-2">Tables</a></h2>
<p>These tables are accessible from BigQuery and Databricks.</p>
<h3><a class="header" href="#experiments-column" id="experiments-column"><code>experiments</code> column</a></h3>
<p><a href="datasets/batch_view/main_summary/reference.html"><code>main_summary</code></a>,
<a href="datasets/batch_view/clients_daily/reference.html"><code>clients_daily</code></a>,
and some other tables
include a <code>experiments</code> column
which is a mapping from experiment slug to branch.</p>
<p>You can collect rows from enrolled clients using query syntax like:</p>
<pre><code class="language-sql">SELECT
  ... some fields ...,
  udf.get_key(experiments, 'some-experiment-slug-12345') AS branch
FROM
  telemetry.clients_daily
WHERE
  udf.get_key(experiments, 'some-experiment-slug-12345') IS NOT NULL
</code></pre>
<h3><a class="header" href="#experiments" id="experiments"><code>experiments</code></a></h3>
<p>The <code>experiments</code> table is a subset of rows from <code>main_summary</code>
reflecting pings from clients that are currently enrolled in an experiment.
The <code>experiments</code> table has additional string-type
<code>experiment_id</code> and <code>experiment_branch</code> columns,
and is partitioned by <code>experiment_id</code>, which makes it efficient to query.</p>
<p>Experiments deployed to large fractions of the release channel
may have the <code>isHighVolume</code> flag set in the Normandy recipe;
those experiments will not be aggregated into the <code>experiments</code> table.</p>
<p>Please note that the <code>experiments</code> table cannot be used
for calculating retention for periods extending beyond
the end of the experiment.
Once a client is unenrolled from an experiment,
subsequent pings will not be captured by the <code>experiments</code> table.</p>
<h3><a class="header" href="#events-1" id="events-1"><code>events</code></a></h3>
<p>The <a href="datasets/batch_view/events/reference.html"><code>events</code> table</a> includes
Normandy enrollment and unenrollment events
for both pref-flip and add-on studies.</p>
<p>Normandy events have event category <code>normandy</code>.
The event value will contain the experiment slug.</p>
<p>The event schema is described
<a href="https://hg.mozilla.org/mozilla-central/file/tip/toolkit/components/normandy/lib/TelemetryEvents.jsm">in the Firefox source tree</a>.</p>
<p>The <code>events</code> table is updated daily.</p>
<h3><a class="header" href="#telemetryshield_study_addon" id="telemetryshield_study_addon"><code>telemetry.shield_study_addon</code></a></h3>
<p>The <code>telemetry.shield_study_addon</code> table contains SHIELD telemetry from add-on experiments,
i.e. key-value pairs sent with the
<code>browser.study.sendTelemetry()</code> method from the
<a href="https://github.com/mozilla/shield-studies-addon-utils/">SHIELD study add-on utilities</a>
library.</p>
<p>The <code>study_name</code> attribute of the <code>payload</code> column will contain the identifier
registered with the SHIELD add-on utilities.
This is set by the add-on; sometimes it takes the value of
<code>applications.gecko.id</code> from the add-on's <code>manifest.json</code>.
This is often not the same as the Normandy slug.</p>
<p>The schema for shield-study-addon pings is described in the
<a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/tree/master/schemas/telemetry/shield-study-addon"><code>mozilla-pipeline-schemas</code> repository</a>.</p>
<p>The key-value pairs are present in <code>data</code> attribute of the <code>payload</code> column.</p>
<p>The <code>telemetry.shield_study_addon</code> table contains only full days of data.
If you need access to data with lower latency, you can use the &quot;live&quot; table
<code>telemetry_live.shield_study_addon_v4</code> which should have latency significantly
less than 1 hour.</p>
<h3><a class="header" href="#telemetryshield_study" id="telemetryshield_study"><code>telemetry.shield_study</code></a></h3>
<p>The <code>telemetry.shield_study</code> dataset includes
enrollment and unenrollment events for add-on experiments only,
sent by the <a href="https://github.com/mozilla/shield-studies-addon-utils/">SHIELD study add-on utilities</a>.</p>
<p>The <code>study_name</code> attribute of the <code>payload</code> column will contain the identifier
registered with the SHIELD add-on utilities.
This is set by the add-on; sometimes it takes the value of
<code>applications.gecko.id</code> from the add-on's <code>manifest.json</code>.
This is often not the same as the Normandy slug.</p>
<p>Normandy also emits its own enrollment and unenrollment events for these studies,
which are available in the <code>events</code> table.</p>
<p>The <code>telemetry.shield_study</code> table contains only full days of data.
If you need access to data with lower latency, you can use the &quot;live&quot; table
<code>telemetry_live.shield_study_v4</code> which should have latency significantly
less than 1 hour.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/shield.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#dynamic-telemetry" id="dynamic-telemetry">Dynamic telemetry</a></h1>
<p>Add-on studies may choose to implement new
<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/collection/scalars.html">scalar</a> or <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/collection/events.html">event</a> telemetry probes.
These probes are not described in
the probe metadata files in the Firefox source tree
and are not described in the <a href="https://probes.telemetry.mozilla.org/">probe dictionary</a>.
Often, they are documented in the repositories
associated with the add-on studies instead.</p>
<p>There is no complete central reference for these.
This page is intended as a partial historical reference
for these probes.</p>
<table><thead><tr><th>Start date</th><th>Study</th><th>Probe type</th><th>Probe names</th><th>Documentation</th></tr></thead><tbody>
<tr><td>2020-08</td><td><a href="https://github.com/mozilla-extensions/doh-resolver-usage-study">DoH Resolver Usage Study</a></td><td>event</td><td><code>doh.study.resolverusage#resolve.domains</code></td><td>https://github.com/mozilla-extensions/doh-resolver-usage-study/blob/master/docs/TELEMETRY.md</td></tr>
<tr><td>2020-06</td><td><a href="https://github.com/mozilla-extensions/login-study">Google Accounts Login Check</a></td><td>custom ping</td><td><a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/pull/561"><code>normandy-login-study</code></a> ping ingested to the <code>telemetry.normandy_login_study</code> table</td><td>https://github.com/mozilla-extensions/login-study/blob/master/login-check-metrics.md</td></tr>
<tr><td>2020-04</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1623996">HTTP Upgrade</a></td><td>scalar</td><td><code>httpsUpgradeStudy.https</code>, <code>httpsUpgradeStudy.nonupgradable</code>, <code>httpsUpgradeStudy.upgradable</code></td><td>https://bugzilla.mozilla.org/show_bug.cgi?id=1629585</td></tr>
<tr><td>2020-02</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1564506">Search interventions</a></td><td>scalar</td><td><code>urlbarInterventionsExperiment.tipShownCount</code>, <code>.tipPickedCount</code></td><td>missing</td></tr>
<tr><td>2019-10</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594926">Delegated credentials</a></td><td>event</td><td><code>delegatedcredentials#connectDC</code>, <code>#connectNoDC</code></td><td>https://github.com/kjacobs-moz/dc-experiment-addon</td></tr>
<tr><td>2019-10</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1573840">DNS over HTTPS heuristics</a></td><td>event</td><td><code>doh#evaluate.heuristics</code>, <code>doh#state</code></td><td>https://github.com/mozilla/doh-rollout/blob/6787458a6901ef3b2a8fef86a179899213809534/docs/telemetry.md</td></tr>
</tbody></table>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/dynamic_telemetry.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#experiment-monitoring-datasets" id="experiment-monitoring-datasets">Experiment monitoring datasets</a></h1>
<ul>
<li><a href="datasets/experiment_monitoring.html#experiment-enrollment-data">Experiment enrollment data</a></li>
<li><a href="datasets/experiment_monitoring.html#experiment-search-metrics-data">Experiment search metrics data</a></li>
<li><a href="datasets/experiment_monitoring.html#derived-tables">Derived tables</a></li>
<li><a href="datasets/experiment_monitoring.html#gcs-data-export">GCS data export</a></li>
<li><a href="datasets/experiment_monitoring.html#scheduling">Scheduling</a></li>
<li><a href="datasets/experiment_monitoring.html#code-reference">Code reference</a></li>
</ul>
<p>Experiment monitoring datasets are designed to power dashboards, such as <a href="https://grafana.telemetry.mozilla.org/d/XspgvdxZz/experiment-enrollment?orgId=1">Experiment Enrollment Grafana dashboard</a>, for monitoring experiments in real time. Currently, datasets for monitoring the number or enrollments and number of searches performed by clients enrolled in experiments are available.</p>
<h2><a class="header" href="#experiment-enrollment-data" id="experiment-enrollment-data">Experiment enrollment data</a></h2>
<p><code>moz-fx-data-shared-prod.telemetry_derived.experiment_enrollment_aggregates_live</code> provides enrollment, unenrollment, graduate, update and failure aggregates for experiments and branches over 5-minute intervals. This live view is also the basis of several derived tables:</p>
<table><thead><tr><th>Dataset name</th><th>Description</th></tr></thead><tbody>
<tr><td><code>mozdata.telemetry.experiment_unenrollment_overall</code></td><td>Overall number of clients that unenrolled from experiments</td></tr>
<tr><td><code>mozdata.telemetry.experiment_enrollment_other_events_overall</code></td><td>Number of events other than <code>enroll</code> and <code>unenroll</code> sent by clients</td></tr>
<tr><td><code>mozdata.telemetry.experiment_enrollment_cumulative_population_estimate</code></td><td>Cumulative number of clients enrolled in experiments</td></tr>
<tr><td><code>mozdata.telemetry.experiment_enrollment_overall</code></td><td>Overall number of clients enrolled in experiments</td></tr>
<tr><td><code>mozdata.telemetry.experiment_enrollment_daily_active_population</code></td><td>Number of daily active clients enrolled in experiments</td></tr>
</tbody></table>
<h2><a class="header" href="#experiment-search-metrics-data" id="experiment-search-metrics-data">Experiment search metrics data</a></h2>
<p><code>moz-fx-data-shared-prod.telemetry_derived.experiment_search_aggregates_live_v1</code> provides aggregated search metrics of clients enrolled in experiments, such as the number of searches performed, the number of searches with ads and the number of ad clicks. This live view is also the basis of several derived tables:</p>
<table><thead><tr><th>Dataset name</th><th>Description</th></tr></thead><tbody>
<tr><td><code>mozdata.telemetry.experiment_cumulative_ad_clicks</code></td><td>Cumulative number of ad clicks by clients enrolled in experiments</td></tr>
<tr><td><code>mozdata.telemetry.experiment_cumulative_search_count</code></td><td>Cumulative number of searches by clients enrolled in experiments</td></tr>
<tr><td><code>mozdata.telemetry.experiment_cumulative_search_with_ads_count</code></td><td>Cumulative number of searches with ads by clients enrolled in experiments</td></tr>
</tbody></table>
<h2><a class="header" href="#derived-tables" id="derived-tables">Derived tables</a></h2>
<p>Derived tables all have the same schema:</p>
<table><thead><tr><th>Column name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>time</code></td><td><code>TIMESTAMP</code></td><td>Timestamp when value was recorded</td></tr>
<tr><td><code>branch</code></td><td><code>STRING</code></td><td>Experiment branch</td></tr>
<tr><td><code>experiment</code></td><td><code>STRING</code></td><td>Experiment slug</td></tr>
<tr><td><code>value</code></td><td><code>INT64</code></td><td>Aggregated value</td></tr>
</tbody></table>
<p>As an example of how these derived tables can be used, the following query determines the number of cumulative clients enrolled
in a the <code>multi-stage-aboutwelcome-set-default-as-first-screen</code> experiment to date in each branch of a study:</p>
<pre><code class="language-sql">SELECT
    branch,
    SUM(value) AS total_enrolled
FROM `mozdata.telemetry.experiment_enrollment_cumulative_population_estimate`
WHERE experiment = 'multi-stage-aboutwelcome-set-default-as-first-screen'
GROUP BY 1
ORDER BY 2
</code></pre>
<h2><a class="header" href="#gcs-data-export" id="gcs-data-export">GCS data export</a></h2>
<p>As some dashboard solutions, such as the Experimenter console, might not have access to BigQuery, data from derived experiment monitoring tables is also exported as JSON to <code>monitoring/</code> in the <code>mozanalysis</code> bucket in <code>moz-fx-data-experiments</code>. JSON files are named like: <code>&lt;experiment_slug&gt;_&lt;monitoring_dataset_name&gt;.json</code>, for example: <code>gs://mozanalysis/monitoring/bug-1683348-rollout-tab-modal-print-ui-roll-out-release-84-85_experiment_unenrollment_overall.json</code></p>
<p>A script for exporting this data is <a href="https://github.com/mozilla/telemetry-airflow/blob/ad3d678cb45c7ac67cb96a46efb6b4e731b856f0/dags/experiments_live.py#L70">scheduled to run via Airflow</a> every 5 minutes.</p>
<h2><a class="header" href="#scheduling-12" id="scheduling-12">Scheduling</a></h2>
<p>To keep cost low for populating the monitoring live tables, several jobs have been set up for each enrollments and search metrics monitoring live tables:</p>
<ul>
<li><a href="https://github.com/mozilla/bigquery-etl/blob/master/dags/bqetl_experiments_hourly.py">Hourly jobs</a> that materialize data from the live tables from the past hour and write it to the hourly-partitioned <code>telemetry_derived.experiment_enrollment_aggregates_hourly_v1</code> and <code>telemetry_derived.experiment_search_aggregates_hourly_v1</code> tables. The jobs are scheduled with some lag (30 minutes) to account for BigQuery sink delays.</li>
<li><a href="https://github.com/mozilla/bigquery-etl/blob/master/dags/bqetl_experiments_daily.py">Daily jobs</a> for updating <code>telemetry_derived.experiment_enrollment_aggregates_v1</code> and <code>telemetry_derived.experiment_search_aggregates_v1</code> to finalize numbers from the stable tables.</li>
<li><a href="https://github.com/mozilla/telemetry-airflow/blob/ad3d678cb45c7ac67cb96a46efb6b4e731b856f0/dags/experiments_live.py#L18">Jobs scheduled to run every 5 minutes</a> that dump experiment enrollment aggregates and experiment search metrics aggregates that are very recent and have not been processed by the hourly job yet into <code>telemetry_derived.experiment_enrollment_aggregates_recents_v1</code> and <code>telemetry_derived.experiment_search_aggregates_recents_v1</code>.</li>
</ul>
<p>The tables derived from the experiment monitoring live tables are also <a href="https://github.com/mozilla/telemetry-airflow/blob/ad3d678cb45c7ac67cb96a46efb6b4e731b856f0/dags/experiments_live.py#L18">scheduled to run every 5 minutes together with the data export script</a>.</p>
<h2><a class="header" href="#code-reference-10" id="code-reference-10">Code reference</a></h2>
<p><a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/experiment_enrollment_aggregates_live/view.sql"><code>moz-fx-data-shared-prod.telemetry_derived.experiment_enrollment_aggregates_live</code></a> and derived datasets are part of bigquery-etl:</p>
<ul>
<li><a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/experiment_enrollment_other_events_overall_v1/query.sql"><code>mozdata.telemetry.experiment_enrollment_other_events_overall</code></a></li>
<li><a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/experiment_enrollment_cumulative_population_estimate_v1/query.sql"><code>mozdata.telemetry.experiment_enrollment_cumulative_population_estimate</code></a></li>
<li><a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/experiment_enrollment_overall_v1/query.sql"><code>mozdata.telemetry.experiment_enrollment_overall</code></a></li>
<li><a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/experiment_unenrollment_overall_v1/query.sql"><code>mozdata.telemetry.experiment_unenrollment_overall</code></a></li>
<li><a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/experiment_enrollment_daily_active_population_v1/query.sql"><code>mozdata.telemetry.experiment_enrollment_daily_active_population</code></a></li>
</ul>
<p><a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/experiment_search_aggregates_live_v1/view.sql"><code>moz-fx-data-shared-prod.telemetry_derived.experiment_search_aggregates_live_v1</code></a> and derived datasets are part of bigquery-etl:</p>
<ul>
<li><a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/experiment_cumulative_ad_clicks_v1/query.sql"><code>mozdata.telemetry.experiment_cumulative_ad_clicks</code></a></li>
<li><a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/experiment_cumulative_search_count_v1/query.sql"><code>mozdata.telemetry.experiment_cumulative_search_count</code></a></li>
<li><a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/experiment_cumulative_search_with_ads_count_v1/query.sql"><code>mozdata.telemetry.experiment_cumulative_search_with_ads_count</code></a></li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/experiment_monitoring.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#search-data" id="search-data">Search Data</a></h1>
<h2><a class="header" href="#introduction-9" id="introduction-9">Introduction</a></h2>
<p>This article introduces the datasets we maintain for search analyses:
<code>search_aggregates</code> and <code>search_clients_daily</code>. After reading this article,
you should understand the search datasets well enough to produce moderately
complex analyses.</p>
<h2><a class="header" href="#table-of-contents-14" id="table-of-contents-14">Table of Contents</a></h2>
<ul>
<li><a href="datasets/search.html#terminology">Terminology</a>
<ul>
<li><a href="datasets/search.html#direct-vs-follow-on-search">Direct vs Follow-on Search</a></li>
<li><a href="datasets/search.html#tagged-vs-untagged-searches">Tagged vs Untagged Searches</a></li>
</ul>
</li>
<li><a href="datasets/search.html#standard-search-aggregates">Standard Search Aggregates</a>
<ul>
<li><a href="datasets/search.html#outlier-filtering">Outlier Filtering</a></li>
</ul>
</li>
<li><a href="datasets/search.html#in-content-telemetry-issues">In Content Telemetry Issues</a>
<ul>
<li><a href="datasets/search.html#relies-on-whitelists">Relies on whitelists</a></li>
<li><a href="datasets/search.html#limited-historical-data">Limited historical data</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#terminology-1" id="terminology-1">Terminology</a></h1>
<h2><a class="header" href="#direct-vs-follow-on-search" id="direct-vs-follow-on-search">Direct vs Follow-on Search</a></h2>
<p>Searches can be split into three major classes: <em>sap</em>, <em>follow-on</em>, and <em>organic</em>.</p>
<p>SAP searches result from a direct interaction with a <code>search access point</code> (SAP),
which is part of the Firefox UI.
These searches are often called SAP searches.
There are currently 7 SAPs:</p>
<ul>
<li><code>urlbar</code> - entering a search query in the Awesomebar</li>
<li><code>searchbar</code> - the main search bar; not present by default for new profiles on Firefox 57+</li>
<li><code>newtab</code> - the search bar on the <code>about:newtab</code> page</li>
<li><code>abouthome</code> - the search bar on the <code>about:home</code> page</li>
<li><code>contextmenu</code> - selecting text and clicking &quot;Search&quot; from the context menu</li>
<li><code>system</code> - starting Firefox from the command line with an option that immediately makes a search</li>
<li><code>webextension</code> - initiated from a web extension (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1492233">added</a> as of Firefox 63)</li>
<li><code>alias</code> - initiated from a search keyword (like @google) (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1499193">added</a> as of Firefox 64)</li>
</ul>
<p>Users will often interact with the Search Engine Results Page (SERP)
to create &quot;downstream&quot; queries.
These queries are called <code>follow-on queries</code>.
These are sometimes also referred to as <strong>in-content queries</strong>
since they are initiated from the content of the page itself
and not from the Firefox UI.</p>
<p>For example, follow-on queries can be caused by:</p>
<ul>
<li>Revising a query (<code>restaurants</code> becomes <code>restaurants near me</code>)</li>
<li>Clicking on the &quot;next&quot; button</li>
<li>Accepting spelling suggestions</li>
</ul>
<p>Finally, we track the number of <em>organic</em> searches. These would be searches initiated directly
from a search engine provider, not through a search access point.</p>
<h2><a class="header" href="#tagged-vs-untagged-searches" id="tagged-vs-untagged-searches">Tagged vs Untagged Searches</a></h2>
<p>Our partners (search engines) attribute queries to Mozilla using <strong>partner codes</strong>.
When a user issues a query through one of our SAPs,
we include our partner code in the URL of the resulting search.</p>
<p><strong>Tagged queries</strong> are queries that <strong>include one of our partner codes</strong>.</p>
<p><strong>Untagged queries</strong> are queries that <strong>do not include one of our partner codes</strong>.
If a query is untagged,
it's usually because we do not have a partner deal for that search engine and region
(or it is an organic search that did not start from an SAP).</p>
<p>If an SAP query is tagged, any follow-on query should also be tagged.</p>
<h1><a class="header" href="#standard-search-aggregates" id="standard-search-aggregates">Standard Search Aggregates</a></h1>
<p>We report five types of searches in our search datasets:
<code>sap</code>, <code>tagged-sap</code>, <code>tagged-follow-on</code>, <code>organic</code>, and <code>unknown</code>.
These aggregates show up as columns in the
<code>search_aggregates</code> and <code>search_clients_daily</code> datasets.
Our search datasets are all derived from <code>main_summary</code>.
The aggregate columns are derived from the <code>SEARCH_COUNTS</code> histogram.</p>
<p>The <strong><code>sap</code> column counts all SAP (or direct) searches</strong>.
<code>sap</code> search counts are collected via
<a href="https://firefox-source-docs.mozilla.org/browser/browser/BrowserUsageTelemetry.html#search-telemetry">probes</a>
within the Firefox UI
These counts are <strong>very reliable, but do not count follow-on queries</strong>.</p>
<p>In 2017-06 we deployed the <a href="https://github.com/mozilla/followonsearch"><code>followonsearch</code> addon</a>, which adds probes for <code>tagged-sap</code> and <code>tagged-follow-on</code> searches.
These columns <strong>attempt to count all tagged searches</strong>
by looking for Mozilla partner codes in the URL of requests to partner search engines.
These search counts are critical to understanding revenue
since they exclude untagged searches and include follow-on searches.
However, these search counts have <strong>important caveats affecting their reliability</strong>.
See <a href="datasets/search.html#in-content-telemetry-issues">In Content Telemetry Issues</a> for more information.</p>
<p>In 2018, we
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1475571">incorporated</a> this code
into the product (as of version 61) and also started tracking so-called
&quot;organic&quot; searches that weren't initiated through a search access point (sap).
This data has the same caveats as those for follow on searches, above.</p>
<p>We also started tracking &quot;unknown&quot; searches, which generally correspond
to clients submitting random/unknown search data to our servers as part
of their telemetry payload. This category can generally safely be ignored, unless its value
is extremely high (which indicates a bug in either Firefox or the aggregation code
which creates our datasets).</p>
<p>In <code>main_summary</code>, all of these searches are stored in <code>search_counts.count</code>,
<strong>which makes it easy to over count searches</strong>.
However, in general, please avoid using <code>main_summary</code> for search analyses --
it's slow and you will need to duplicate much of the work done to make
analyses of our search datasets tractable.</p>
<h2><a class="header" href="#outlier-filtering" id="outlier-filtering">Outlier Filtering</a></h2>
<p>We remove search count observations representing more than
10,000 searches for a single search engine in a single ping.</p>
<h1><a class="header" href="#in-content-telemetry-issues" id="in-content-telemetry-issues">In Content Telemetry Issues</a></h1>
<p>The search code module inside Firefox (formerly implemented
as an addon until version 60) implements the probe used to measure <code>tagged-sap</code> and
<code>tagged-follow-on</code> searches and also tracks organic searches. This probe is critical
to understanding our revenue. It's the only tool that gives us a view of follow-on searches
and differentiates between tagged and untagged queries.
However, it comes with some notable caveats.</p>
<h2><a class="header" href="#relies-on-whitelists" id="relies-on-whitelists">Relies on whitelists</a></h2>
<p>Firefox's search module attempts to count all tagged searches
by looking for Mozilla partner codes in the URL of requests to partner search engines.
To do this, it relies on a whitelist of partner codes and URL formats.
The list of partner codes is incomplete and only covers a few top partners.
These codes also occasionally change so there will be gaps in the data.</p>
<p>Additionally, changes to search engine URL formats can cause problems with our data collection.
See
<a href="https://sql.telemetry.mozilla.org/queries/47631/source#128887">this query</a>
for a notable example.</p>
<h2><a class="header" href="#limited-historical-data" id="limited-historical-data">Limited historical data</a></h2>
<p>The <a href="https://github.com/mozilla/followonsearch"><code>followonsearch</code> addon</a> was first deployed in 2017-06.
There is no <code>tagged-*</code> search data available before this.</p>
<p><code>default_private_search_engine</code> is only available starting 2019-11-19.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/search.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#search-aggregates" id="search-aggregates">Search Aggregates</a></h1>
<ul>
<li><a href="datasets/search/search_aggregates/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/search/search_aggregates/reference.html#contents">Contents</a></li>
</ul>
</li>
<li><a href="datasets/search/search_aggregates/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/search/search_aggregates/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/search/search_aggregates/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/search/search_aggregates/reference.html#schema">Schema</a></li>
</ul>
</li>
<li><a href="datasets/search/search_aggregates/reference.html#code-reference">Code Reference</a></li>
</ul>
<h1><a class="header" href="#introduction-10" id="introduction-10">Introduction</a></h1>
<p><code>search_aggregates</code> is designed to power high level search dashboards.
It's quick and easy to query, but the data are coarse.
In particular, this dataset allows you to segment
by a limited number of client characteristics which are relevant to search markets.
However, it is not possible to normalize by client count.
If you need fine-grained data, consider using <code>search_clients_daily</code>
which breaks down search counts by client</p>
<h2><a class="header" href="#contents-2" id="contents-2">Contents</a></h2>
<p>Each row of <code>search_aggregates</code> contains
the standard search count aggregations
for each unique combination of the following columns.
Unless otherwise noted, these columns are taken directly from <code>main_summary</code>.</p>
<ul>
<li><code>submission_date</code> - <code>yyyymmdd</code></li>
<li><code>engine</code> - e.g. <code>google</code>, <code>bing</code>, <code>yahoo</code></li>
<li><code>source</code> - The UI component used to issue a search - e.g. <code>urlbar</code>, <code>abouthome</code></li>
<li><code>country</code></li>
<li><code>locale</code></li>
<li><code>addon_version</code> - The installed version of the [<code>followonsearch</code> addon] (before version 61)</li>
<li><code>app_version</code></li>
<li><code>distribution_id</code> - <code>NULL</code> means the standard Firefox build</li>
<li><code>search_cohort</code> - <code>NULL</code> except for small segments relating to search experimentation</li>
</ul>
<p>There are five aggregation columns:
<code>sap</code>, <code>tagged-sap</code>, and <code>tagged-follow-on</code>, <code>organic</code> and <code>unknown</code>.
Each of these columns represent different types of searches.
For more details, see the <a href="datasets/search/search_aggregates/../../search.html">search data documentation</a></p>
<!--
#### Further Reading
-->
<h1><a class="header" href="#data-reference-11" id="data-reference-11">Data Reference</a></h1>
<h2><a class="header" href="#example-queries-7" id="example-queries-7">Example Queries</a></h2>
<p><a href="https://sql.telemetry.mozilla.org/queries/51140/source">This query</a>
calculates daily US searches.
If you have trouble viewing this query,
it's likely you don't have the proper permissions.
For more details see the <a href="datasets/search/search_aggregates/../../search.html">search data documentation</a>.</p>
<h2><a class="header" href="#scheduling-13" id="scheduling-13">Scheduling</a></h2>
<p>This job is
<a href="https://github.com/mozilla/bigquery-etl/blob/ad84a15d580333b41d36cfe8331e51238f3bafa1/dags/bqetl_search.py#L40">scheduled on airflow</a>
to run daily.</p>
<h2><a class="header" href="#schema-9" id="schema-9">Schema</a></h2>
<p>As of 2019-11-27,
the current version of <code>search_aggregates</code> is <code>v8</code>,
and has a schema as follows.
The dataset is backfilled through 2016-03-11</p>
<pre><code>root
 |-- submission_date: date (nullable = true)
 |-- submission_date_s3: date (nullable = true)
 |-- country: string (nullable = true)
 |-- engine: string (nullable = true)
 |-- source: string (nullable = true)
 |-- app_version: string (nullable = true)
 |-- distribution_id: string (nullable = true)
 |-- locale: string (nullable = true)
 |-- search_cohort: string (nullable = true)
 |-- addon_version: string (nullable = true)
 |-- tagged-sap: long (nullable = true)
 |-- tagged-follow-on: long (nullable = true)
 |-- sap: long (nullable = true)
 |-- organic: long (nullable = true)
 |-- search_with_ads: long (nullable = true)
 |-- ad_click: long (nullable = true)
 |-- unknown: long (nullable = true)
 |-- client_count: long (nullable = true)
 |-- default_search_engine: string (nullable = true)
 |-- default_private_search_engine: string (nullable = true)
 |-- os: string (nullable = true)
 |-- os_version: string (nullable = true)
 |-- addon_version: string (nullable = true)
</code></pre>
<h1><a class="header" href="#code-reference-11" id="code-reference-11">Code Reference</a></h1>
<p>The <code>search_aggregates</code> job is
<a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/search_derived/search_aggregates_v8/query.sql">defined in <code>bigquery-etl</code></a></p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/search/search_aggregates/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#search-clients-daily" id="search-clients-daily">Search Clients Daily</a></h1>
<ul>
<li><a href="datasets/search/search_clients_daily/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/search/search_clients_daily/reference.html#contents">Contents</a></li>
<li><a href="datasets/search/search_clients_daily/reference.html#background-and-caveats">Background and Caveats</a></li>
</ul>
</li>
<li><a href="datasets/search/search_clients_daily/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/search/search_clients_daily/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/search/search_clients_daily/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/search/search_clients_daily/reference.html#schema">Schema</a></li>
</ul>
</li>
<li><a href="datasets/search/search_clients_daily/reference.html#code-reference">Code Reference</a></li>
</ul>
<h1><a class="header" href="#introduction-11" id="introduction-11">Introduction</a></h1>
<p><code>search_clients_daily</code> is designed to enable client-level search analyses.
Querying this dataset can be slow;
consider using <code>search_aggregates</code> for coarse analyses.</p>
<h2><a class="header" href="#contents-3" id="contents-3">Contents</a></h2>
<p><code>search_clients_daily</code> has one row for each unique combination of:
(<code>client_id</code>, <code>submission_date</code>, <code>engine</code>, <code>source</code>).</p>
<p>In addition to the standard search count aggregations,
this dataset includes some descriptive data for each client.
For example, we include <code>country</code> and <code>channel</code> for each row of data.
In the event that a client sends multiple pings on a given <code>submission_date</code>
we choose an arbitrary value from the pings for that (<code>client_id</code>, <code>submission_date</code>),
unless otherwise noted.</p>
<p>There are five standard search count aggregation columns:
<code>sap</code>, <code>tagged-sap</code>, and <code>tagged-follow-on</code>, <code>organic</code> and <code>unknown</code>.
Note that, if there were no such searches in a row's segment
(i.e. the count would be 0),
the column value is <code>null</code>.
Each of these columns represent different types of searches.
For more details, see the <a href="datasets/search/search_clients_daily/../../search.html">search data documentation</a></p>
<h2><a class="header" href="#background-and-caveats-2" id="background-and-caveats-2">Background and Caveats</a></h2>
<p><code>search_clients_daily</code> does not include
(<code>client_id</code> <code>submission_date</code>) pairs
if we did not receive a ping for that <code>submission_date</code>.</p>
<p>We impute a <code>NULL</code> <code>engine</code> and <code>source</code> for pings with no search counts.
This ensures users who never search are included in this dataset.</p>
<p>This dataset is large.
If you're querying this dataset from STMO,
heavily limit the data you read using <code>submission_date</code> or <code>sample_id</code>.</p>
<!--
#### Further Reading
-->
<h1><a class="header" href="#data-reference-12" id="data-reference-12">Data Reference</a></h1>
<h2><a class="header" href="#example-queries-8" id="example-queries-8">Example Queries</a></h2>
<p><a href="https://sql.telemetry.mozilla.org/queries/51141/source">This query</a>
calculates searches per <code>normalized_channel</code> for US clients on an arbitrary day.
If you have trouble viewing this query,
it's likely you don't have the proper permissions.
For more details see the <a href="datasets/search/search_clients_daily/../../search.html">search data documentation</a>.</p>
<h2><a class="header" href="#scheduling-14" id="scheduling-14">Scheduling</a></h2>
<p>This dataset is scheduled on Airflow
(<a href="https://github.com/mozilla/bigquery-etl/blob/ad84a15d580333b41d36cfe8331e51238f3bafa1/dags/bqetl_search.py#L64">source</a>).</p>
<h2><a class="header" href="#schema-10" id="schema-10">Schema</a></h2>
<p>As of 2019-11-27, the current version of <code>search_clients_daily</code> is <code>v8</code>,
and has a schema as follows.
It's backfilled through 2016-03-12</p>
<pre><code>root
 |-- client_id: string (nullable = true)
 |-- submission_date: date (nullable = true)
 |-- submission_date_s3: date (nullable = true)
 |-- engine: string (nullable = true)
 |-- source: string (nullable = true)
 |-- country: string (nullable = true)
 |-- app_version: string (nullable = true)
 |-- distribution_id: string (nullable = true)
 |-- locale: string (nullable = true)
 |-- search_cohort: string (nullable = true)
 |-- addon_version: string (nullable = true)
 |-- os: string (nullable = true)
 |-- os_version: string (nullable = true)
 |-- channel: string (nullable = true)
 |-- profile_creation_date: long (nullable = true)
 |-- default_search_engine: string (nullable = true)
 |-- default_search_engine_data_load_path: string (nullable = true)
 |-- default_search_engine_data_submission_url: string (nullable = true)
 |-- default_private_search_engine: string (nullable = true)
 |-- default_private_search_engine_data_load_path: string (nullable = true)
 |-- default_private_search_engine_data_submission_url: string (nullable = true)
 |-- sample_id: long (nullable = true)
 |-- sessions_started_on_this_day: long (nullable = true)
 |-- profile_age_in_days: integer (nullable = true)
 |-- subsession_hours_sum: double (nullable = true)
 |-- active_addons_count_mean: double (nullable = true)
 |-- max_concurrent_tab_count_max: integer (nullable = true)
 |-- tab_open_event_count_sum: long (nullable = true)
 |-- active_hours_sum: double (nullable = true)
 |-- total_uri_count: long (nullable = true)
 |-- tagged_sap: long (nullable = true)
 |-- tagged_follow_on: long (nullable = true)
 |-- sap: long (nullable = true)
 |-- tagged_sap: long (nullable = true)
 |-- tagged_follow_on: long (nullable = true)
 |-- organic: long (nullable = true)
 |-- search_with_ads: long (nullable = true)
 |-- ad_click: long (nullable = true)
 |-- unknown: long (nullable = true)
 |-- normalized_engine: string (nullable = true)
 |-- user_pref_browser_search_region: string (nullable = true)
 |-- is_default_browser: boolean (nullable = true)
 |-- experiments: map (nullable = true)
 |    |-- key: string
 |    |-- value: string
</code></pre>
<h1><a class="header" href="#code-reference-12" id="code-reference-12">Code Reference</a></h1>
<p>The <code>search_clients_daily</code> job is
<a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/search_derived/search_clients_daily_v8/query.sql">defined in <code>bigquery-etl</code></a></p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/search/search_clients_daily/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#search-clients-last-seen" id="search-clients-last-seen">Search Clients Last Seen</a></h1>
<ul>
<li><a href="datasets/search/search_clients_last_seen/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/search/search_clients_last_seen/reference.html#contents">Contents</a></li>
<li><a href="datasets/search/search_clients_last_seen/reference.html#utilizing-byte-columns">Utilizing BYTE columns</a></li>
<li><a href="datasets/search/search_clients_last_seen/reference.html#engine-searches">Engine Searches</a></li>
<li><a href="datasets/search/search_clients_last_seen/reference.html#background-and-caveats">Background and Caveats</a></li>
<li><a href="datasets/search/search_clients_last_seen/reference.html#accessing-the-data">Accessing the Data</a></li>
</ul>
</li>
<li><a href="datasets/search/search_clients_last_seen/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/search/search_clients_last_seen/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/search/search_clients_last_seen/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/search/search_clients_last_seen/reference.html#schema">Schema</a></li>
</ul>
</li>
<li><a href="datasets/search/search_clients_last_seen/reference.html#code-reference">Code Reference</a></li>
</ul>
<h1><a class="header" href="#introduction-12" id="introduction-12">Introduction</a></h1>
<p><code>search_clients_last_seen</code> is designed for individual search analysis for clients over the past year.
This can be useful when wondering about client search behavior over the past year.</p>
<p><strong>NOTE</strong>: <code>search_clients_last_seen</code> is currently a 1% sample, and the first day with a full year of
search activity is 2020-01-01.</p>
<h3><a class="header" href="#contents-4" id="contents-4">Contents</a></h3>
<p><code>search_clients_last_seen</code> has just one row per-client, for any client
who was active over the past year. Here we define active as &quot;sent a main
ping&quot;; so if they are present that does not mean they searched.</p>
<p><strong>NOTE</strong>: Always choose a single <code>submission_date</code> when querying <code>search_clients_last_seen</code>.</p>
<p>The key pieces of this dataset are byte arrays that contain
daily information about client activity over the past year.
We have these for a variety of activity types:</p>
<ul>
<li><code>days_seen_bytes</code>: Days when we received a main ping from the client</li>
<li><code>days_searched_bytes</code>: Days that the client searched in any form</li>
<li><code>days_tagged_searched_bytes</code>: Days that the client performed a tagged search</li>
<li><code>days_searched_with_ads_bytes</code>: Days that the client performed a search that contained ads</li>
<li><code>days_clicked_ads_bytes</code>: Days that the client clicked an ad post-search
See &quot;Utilizing BYTE columns&quot; for how to use these fields.</li>
</ul>
<p>There are some convenience columns around these, that give the number of days
since the client was last active for that usage criteria:</p>
<ul>
<li><code>days_since_seen</code></li>
<li><code>days_since_searched</code></li>
<li><code>days_since_tagged_searched</code></li>
<li><code>days_since_searched_with_ads</code></li>
<li><code>days_since_clicked_ad</code></li>
<li><code>days_since_created_profile</code></li>
</ul>
<p>We also include a variety of dimension information (e.g. os,
country, channel, default_search) to aggregate on. The
<a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/search_derived/search_clients_last_seen_v1/query.sql#L37">query itself</a>
lays out all of the available dimensional fields.</p>
<p>There are, finally, a few fields with daily activity data.
These include <code>active_hours_sum</code>, <code>organic</code> for organic searches,
and <code>total_searches</code>. Please note that these are just for the current day,
and not over the entire year of history contained in the <code>days_*_bytes</code> columns.</p>
<h4><a class="header" href="#utilizing-byte-columns" id="utilizing-byte-columns">Utilizing BYTE columns</a></h4>
<p>These are stored as BigQuery <code>BYTE</code> type, so they can be a bit confusing
to use. We have a few convenience functions for using them. For these functions,
anytime we say &quot;was active&quot;, we mean &quot;within the usage criteria defined by that
column&quot;; for example, it could be days that clients searched with ads.:</p>
<p><code>udf.bits_to_days_seen</code> - The number of days the user was active.
<code>udf.bits_to_days_since_seen</code> - The number of days since the user was last active.
<code>udf.bits_to_days_since_first_seen</code> - The number of days since the user's <em>first</em>
active day. Note that this will be at most 365 days, since that is the beginning
of history for this dataset.
<code>udf.bits_to_active_n_weeks_ago</code> - Returns whether or not the user was active n weeks
ago for the given activity type.</p>
<h4><a class="header" href="#engine-searches" id="engine-searches">Engine Searches</a></h4>
<p>Warning: This column was designed specifically for use with the revenue data, and probably isn't good for other kinds of analysis.</p>
<p>For each search engine, we store an array that contains the number of searches that user
completed each month for the past 12 months. This is across calendar months, so the number of
days are not directly comparable.</p>
<p>We have the same data for tagged searches, search with ads, and ad clicks.</p>
<h4><a class="header" href="#background-and-caveats-3" id="background-and-caveats-3">Background and Caveats</a></h4>
<p><code>search_clients_last_seen</code> does includes
(<code>client_id</code> <code>submission_date</code>) pairs
even if we did not receive a ping for that <code>submission_date</code>.
Any client who was active over the past year will be included.</p>
<h4><a class="header" href="#accessing-the-data-7" id="accessing-the-data-7">Accessing the Data</a></h4>
<p>Access the data at <code>search.search_clients_last_seen</code>.</p>
<!--
#### Further Reading
-->
<h1><a class="header" href="#data-reference-13" id="data-reference-13">Data Reference</a></h1>
<h2><a class="header" href="#example-queries-9" id="example-queries-9">Example Queries</a></h2>
<p><a href="https://sql.telemetry.mozilla.org/queries/70349/source#177176">This retention query</a>
gives the WoW retention of users in different segments. Similar to GUD, a user is
considered retained if they do they same activity the next week. Note here the
outage from Armagaddon, and the outage for ad click telemetry in October.</p>
<p><a href="https://sql.telemetry.mozilla.org/queries/70348/source#177160">This query</a>
shows the amount of different search activity taken by clients. We can use it
to determine the % of clients who partake in each activity, regardless of their
baseline amount of activity.</p>
<h2><a class="header" href="#scheduling-15" id="scheduling-15">Scheduling</a></h2>
<p>This dataset is scheduled on Airflow
(<a href="https://github.com/mozilla/bigquery-etl/blob/ad84a15d580333b41d36cfe8331e51238f3bafa1/dags/bqetl_search.py#L52">source</a>).</p>
<h2><a class="header" href="#schema-11" id="schema-11">Schema</a></h2>
<p>As of 2020-04-22, the current version of <code>search_clients_last_seee</code> is <code>v1</code>,
and has a schema as follows.
It's backfilled through 2020-01-01</p>
<pre><code>root
    |- submission_date: date
    |- client_id: string
    |- sample_id: integer
    |- country: string
    |- app_version: string
    |- distribution_id: string
    |- locale: string
    |- search_cohort: string
    |- addon_version: string
    |- os: string
    |- channel: string
    |- profile_creation_date: integer
    |- default_search_engine: string
    |- default_search_engine_data_load_path: string
    |- default_search_engine_data_submission_url: string
    |- profile_age_in_days: integer
    |- active_addons_count_mean: float
    |- user_pref_browser_search_region: string
    |- os_version: string
    |- max_concurrent_tab_count_max: integer
    |- tab_open_event_count_sum: integer
    |- active_hours_sum: float
    |- subsession_hours_sum: float
    |- sessions_started_on_this_day: integer
    |- organic: integer
    |- sap: integer
    |- unknown: integer
    |- tagged_sap: integer
    |- tagged_follow_on: integer
    |- ad_click: integer
    |- search_with_ads: integer
    |- total_searches: integer
    |- tagged_searches: integer
    +- engine_searches: record (repeated)
    |  |- key: string
    |  +- value: record
    |  |  |- total_searches: integer (repeated)
    |  |  |- tagged_searches: integer (repeated)
    |  |  |- search_with_ads: integer (repeated)
    |  |  |- ad_click: integer (repeated)
    |- days_seen_bytes: bytes
    |- days_searched_bytes: bytes
    |- days_tagged_searched_bytes: bytes
    |- days_searched_with_ads_bytes: bytes
    |- days_clicked_ads_bytes: bytes
    |- days_created_profile_bytes: bytes
</code></pre>
<h1><a class="header" href="#code-reference-13" id="code-reference-13">Code Reference</a></h1>
<p>The <code>search_clients_last_seen</code> job is
<a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/search_derived/search_clients_last_seen_v1/query.sql">defined in <code>bigquery-etl</code></a></p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/search/search_clients_last_seen/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#normalized-client-lifetime-value-ltv" id="normalized-client-lifetime-value-ltv">Normalized Client Lifetime Value (LTV)</a></h1>
<ul>
<li><a href="datasets/search/client_ltv/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/search/client_ltv/reference.html#contents">Contents</a></li>
<li><a href="datasets/search/client_ltv/reference.html#ltv">LTV</a></li>
<li><a href="datasets/search/client_ltv/reference.html#background-and-caveats">Background and Caveats</a></li>
</ul>
</li>
<li><a href="datasets/search/client_ltv/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/search/client_ltv/reference.html#schema">Schema</a></li>
<li><a href="datasets/search/client_ltv/reference.html#code-references">Code References</a></li>
<li><a href="datasets/search/client_ltv/reference.html#model-performance">Model Performance</a></li>
</ul>
<h1><a class="header" href="#introduction-13" id="introduction-13">Introduction</a></h1>
<p><code>client_ltv</code> is designed to enable relative user value estimates based on their past and expected search and ad click behavior. This behavior is revenue-generating for Firefox.</p>
<h2><a class="header" href="#contents-5" id="contents-5">Contents</a></h2>
<p><code>client_ltv</code> has one row for each (<code>client_id</code>, <code>engine</code>, <code>submission_date</code>) triplet.</p>
<p>Each row captures a year's worth of history for the <code>client_id</code> on the given <code>engine</code>, therefore the values will not change much when looking at <code>submission_date</code> in 1-day (or even 1-month) sequences, since there is significant overlap. For <strong>most</strong> analyses, using yesterday's <code>submission_date</code> will be sufficient. To get users active in the last i.e. 7 days, a join with <code>clients_last_seen</code> is required. We plan to propagate the necessary fields into <code>client_ltv</code> in the future so such a join isn't necessary.</p>
<p>Using yesterday's date, a client's row will contain the total number of searches, ad clicks, etc for the last 365 days, along with active search and ad click days (how many days did a user search or click an ad). Additionally each row contains the predicted number active search/ad click days for the <em>next</em> 365 days. See the schema at the bottom of this page for a full list of the fields.</p>
<h2><a class="header" href="#ltv" id="ltv">LTV</a></h2>
<p>A client's &quot;lifetime&quot; is maxed out at 2 years given the structure of this dataset. Of course a client can exist for longer, but one year on either side of the date in question controls for seasonal trends and lets us easily produce annual estimates for, say, user acquisition ROI.</p>
<p>The procedure for calculating a user's LTV is as follows:</p>
<ul>
<li>Step 1: Determine the ad click value for the user's region/engine
<ul>
<li>(<em>Revenue in Country C for Engine E</em>) / (<em>Total Ad Clicks in Country C for Engine E</em>)</li>
</ul>
</li>
<li>Step 2: Determine the user's ad clicks per day for the past 365 days
<ul>
<li>(<em>Total Ad Clicks for User</em>) / (<em>Total Active Ad Click Days for User</em>)</li>
</ul>
</li>
<li>Step 3: Calculate a user's past LTV by multiplying the following:
<ul>
<li><em>Total Active Ad Click Days for User</em></li>
<li><em>Ad Clicks per Day for User</em> (derived in step 2)</li>
<li><em>Ad Click Value in Country C for Engine E</em> (derived from step 1)</li>
</ul>
</li>
<li>Step 4: Calculate a user's future LTV by multiplying the following:
<ul>
<li><em>Total <strong>Predicted</strong> Active Ad Click Days for User</em></li>
<li><em>Ad Clicks per Day for User</em> (derived in step 2)</li>
<li><em>Ad Click Value in Country C for Engine E</em> (derived from step 1)</li>
</ul>
</li>
<li>Step 5: Normalized the LTV values from (3) and (4)
<ul>
<li>(<em>User past LTV</em>) / (<em>Sum of all past user LTVs</em>)</li>
<li>(<em>User future LTV</em>) / (<em>Sum of all future user LTVs</em>)</li>
</ul>
</li>
</ul>
<p>The normalized LTV for a user can roughly be interpreted as a user's <strong>contribution</strong> to the collective value of our user-base. Note that the above procedure omits some outlier handling steps for simplicity.</p>
<h2><a class="header" href="#background-and-caveats-4" id="background-and-caveats-4">Background and Caveats</a></h2>
<p>The <code>normalized_ltv_ad_clicks_current</code> field, for example, does <strong>not</strong> represent a user's contribution to revenue directly. It should be treated as a rough proxy. It is not appropriate to multiply revenue by this number.</p>
<p>LTV is broken down by engine, so the LTV for a user who searches on multiple engines must be interpreted in context. <strong>LTV is only available for Google and Bing on Firefox Desktop</strong> at this time.</p>
<p>We <strong>do</strong> have the ability to calculate a dollar value per user, however the (unnormalized) table is restricted to those with proper revenue access. For more information, see <a href="datasets/search/client_ltv/../../../concepts/getting_help.html">Getting Help</a>.</p>
<h1><a class="header" href="#example-queries-10" id="example-queries-10">Example Queries</a></h1>
<p><em>Percent of users we predict will click an ad in the <strong>next</strong> 365 days by Engine.</em> (<a href="https://sql.telemetry.mozilla.org/queries/74878/source">source</a>)</p>
<pre><code class="language-sql">SELECT
  engine,
  AVG(IF(pred_num_days_seeing_ads &gt; 0, 1, 0)) as pct_predicted_ad_viewers_next_year,
  AVG(IF(pred_num_days_clicking_ads &gt; 0, 1, 0)) as pct_predicted_ad_clickers_next_year,
FROM
  `moz-fx-data-shared-prod`.revenue_derived.client_ltv_v1
WHERE
  submission_date = DATE_SUB(CURRENT_DATE, INTERVAL 1 DAY)
GROUP BY
  1
</code></pre>
<p><em>LTV Value of Users Over Lifetime (by <code>days_since_created_profile</code>) of Users Active in Past 7 Days</em> (<a href="https://sql.telemetry.mozilla.org/queries/74867/source#187036">source</a>)</p>
<pre><code class="language-sql">SELECT
  days_since_created_profile,
  SUM(normalized_ltv_ad_clicks_current) AS sum_normalized_ltv_ad_clicks_current,
  SUM(normalized_ltv_ad_clicks_future) AS normalized_ltv_ad_clicks_future,
  SUM(normalized_ltv_ad_clicks_future) / COUNT(*) AS avg_normalized_ltv_ad_clicks_future,
FROM
  `moz-fx-data-shared-prod`.revenue_derived.client_ltv_v1
JOIN
  `moz-fx-data-shared-prod`.search.search_clients_last_seen
  USING(submission_date, client_id)
WHERE
  submission_date = '2020-09-16'
  AND days_since_created_profile &lt;= 365
  AND days_since_seen &lt;= 6
GROUP BY
  days_since_created_profile
ORDER BY
  days_since_created_profile DESC


</code></pre>
<h1><a class="header" href="#schema-12" id="schema-12">Schema</a></h1>
<p>As of 2020-09-16,
the current version of <code>client_ltv</code> is <code>v1</code>,
and has a schema as follows.
The dataset is backfilled through 2020-09-14.</p>
<pre><code>root
 |-- submission_date: date (nullable = true)
 |-- engine: string (nullable = true)
 |-- country: string (nullable = true)
 |-- client_id: string (nullable = true)
 |-- total_client_searches_past_year: long (nullable = true)
 |-- total_client_tagged_searches_past_year: long (nullable = true)
 |-- total_client_ad_clicks_past_year: long (nullable = true)
 |-- total_client_searches_with_ads_past_year: long (nullable = true)
 |-- ad_click_days: long (nullable = true)
 |-- search_days: long (nullable = true)
 |-- search_with_ads_days: long (nullable = true)
 |-- tagged_search_days: long (nullable = true)
 |-- active_days: long (nullable = true)
 |-- pred_num_days_clicking_ads: double (nullable = true)
 |-- pred_num_days_seeing_ads: double (nullable = true)
 |-- pred_num_days_searching: double (nullable = true)
 |-- pred_num_days_tagged_searching: double (nullable = true)
 |-- ad_clicks_per_day: double (nullable = true)
 |-- searches_with_ads_per_day: double (nullable = true)
 |-- searches_per_day: double (nullable = true)
 |-- tagged_searches_per_day: double (nullable = true)
 |-- ad_clicks_cutoff: double (nullable = true)
 |-- searches_with_ads_cutoff: double (nullable = true)
 |-- searches_cutoff: double (nullable = true)
 |-- tagged_searches_cutoff: double (nullable = true)
 |-- ad_clicks_per_day_capped: double (nullable = true)
 |-- searches_with_ads_per_day_capped: double (nullable = true)
 |-- searches_per_day_capped: double (nullable = true)
 |-- tagged_searches_per_day_capped: double (nullable = true)
 |-- total_ad_clicks: long (nullable = true)
 |-- normalized_ltv_ad_clicks_current: double (nullable = true)
 |-- normalized_ltv_search_with_ads_current: double (nullable = true)
 |-- normalized_ltv_search_current: double (nullable = true)
 |-- normalized_ltv_tagged_search_current: double (nullable = true)
 |-- normalized_ltv_ad_clicks_future: double (nullable = true)
 |-- normalized_ltv_search_with_ads_future: double (nullable = true)
 |-- normalized_ltv_search_future: double (nullable = true)
 |-- normalized_ltv_tagged_search_future: double (nullable = true)
</code></pre>
<h1><a class="header" href="#code-references" id="code-references">Code References</a></h1>
<ul>
<li><a href="https://github.com/mozilla/telemetry-airflow/blob/master/jobs/ltv_daily.py">LTV daily model fitting</a></li>
<li>Unnormalized <a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/revenue_derived/client_ltv_v1/query.sql"><code>client_ltv</code> query</a> (restricted query access)</li>
<li><a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/revenue_derived/client_ltv_normalized/query.sql"><code>client_ltv</code> view</a> (for broad use)</li>
</ul>
<h1><a class="header" href="#model-performance" id="model-performance">Model Performance</a></h1>
<p>There is additionally a dataset, <code>ltv_daily_model_perf</code>, that tracks the LTV model's prediction performance each day it is re-trained. For a given day, one could check the performance with the following <a href="https://sql.telemetry.mozilla.org/queries/75244/source#187873">query</a>:</p>
<pre><code class="language-sql">SELECT
  active_days,
  actual,
  model
FROM
  `moz-fx-data-shared-prod.analysis.ltv_daily_model_perf`
WHERE
  date = '2020-09-29'
AND
  metric = 'days_clicked_ads'
ORDER BY
  active_days
</code></pre>
<p>This produces a histogram for the observed user frequencies and the model's predicted frequencies, allowing a chart similar to the one shown in the <a href="https://lifetimes.readthedocs.io/en/latest/Quickstart.html#assessing-model-fit">&quot;assessing model fit&quot; example</a> in the <code>lifetimes</code> documentation. This table only checks performance for clients the model expects have, for example, clicked an ad in 0 to 28 days in the past year, since most of the distribution is contained in that interval.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/search/client_ltv/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#non-desktop-data" id="non-desktop-data">Non-Desktop Data</a></h1>
<p>Non-Desktop data includes data for all mobile browser products as well as non browser products such as Lockwise, Firefox for Echo Show, Mozilla VPN, and Web XR Viewer among others.</p>
<h2><a class="header" href="#list-of-datasets" id="list-of-datasets">List of Datasets</a></h2>
<ul>
<li><a href="datasets/./non_desktop/day_2_7_activation/reference.html">Day 2-7 Activation</a> - Used to calculate the <a href="datasets/../metrics/metrics.html#day-2-7-activation">Day 2-7 Activation metric</a>, a key result in 2020 for non-desktop products.</li>
<li><a href="datasets/./non_desktop/google_play_store/reference.html">Google Play Store Data</a> - Used to understand the acquisition performance for non-desktop products on the Google Play Store.</li>
<li><a href="datasets/./non_desktop/apple_app_store/reference.html">Apple App Store Data</a> - Used to understand the acquisition performance for the non-desktop products on the Apple App Store.</li>
<li><a href="datasets/./non_desktop/events_daily/reference.html">Events Daily</a> - Used to answer event-based questions, such as funnels and counts.</li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/non_desktop.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#non-desktop-day-2-7-activation" id="non-desktop-day-2-7-activation">Non-Desktop Day 2-7 Activation</a></h1>
<ul>
<li><a href="datasets/non_desktop/day_2_7_activation/reference.html#introduction">Introduction</a></li>
<li><a href="datasets/non_desktop/day_2_7_activation/reference.html#contents">Contents</a></li>
<li><a href="datasets/non_desktop/day_2_7_activation/reference.html#accessing-the-data">Accessing the Data</a></li>
<li><a href="datasets/non_desktop/day_2_7_activation/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/non_desktop/day_2_7_activation/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/non_desktop/day_2_7_activation/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/non_desktop/day_2_7_activation/reference.html#schema">Schema</a></li>
</ul>
</li>
<li><a href="datasets/non_desktop/day_2_7_activation/reference.html#code-reference">Code Reference</a></li>
<li><a href="datasets/non_desktop/day_2_7_activation/reference.html#background-and-caveats">Background and Caveats</a></li>
</ul>
<h1><a class="header" href="#introduction-14" id="introduction-14">Introduction</a></h1>
<p><code>firefox_nondesktop_day_2_7_activation</code> is designed for use in calculating the <a href="datasets/non_desktop/day_2_7_activation/../../../metrics/metrics.html#day-2-7-activation">Day 2-7 Activation metric</a>, a key result in 2020 for non-desktop products.</p>
<h1><a class="header" href="#contents-6" id="contents-6">Contents</a></h1>
<p><code>firefox_nondesktop_day_2_7_activation</code> is a table with two key metrics: <code>new_profiles</code> and <code>day_2_7_activated</code>, aggregated over <code>submission_date</code>. It is derived from the <a href="https://docs.telemetry.mozilla.org/cookbooks/clients_last_seen_bits.html">non-desktop clients last seen table</a>.</p>
<ul>
<li><code>new_profiles</code>: Unique count of client ids with a given profile creation date. As not all initial pings are received exactly on the day of profile creation, we wait for 7 days after the profile creation date before establishing the New Profile cohort to ensure the data is complete.</li>
<li><code>days_2_7_activated</code>: Unique count of client ids who use the product at any point starting the day after they created a profile up to 6 days after.
We also include a variety of dimension information (e.g. <code>product</code>, <code>app_name</code>, <code>app_version</code>, <code>os</code>, <code>normalized_channel</code> and <code>country</code>) to aggregate on.</li>
</ul>
<p>This dataset is backfilled through 2017-01-01.</p>
<h1><a class="header" href="#accessing-the-data-8" id="accessing-the-data-8">Accessing the Data</a></h1>
<p>Access the data at <a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-shared-prod&amp;p=moz-fx-data-shared-prod&amp;d=telemetry&amp;t=firefox_nondesktop_day_2_7_activation&amp;page=table"><code>moz-fx-data-shared-prod.telemetry.firefox_nondesktop_day_2_7_activation</code></a></p>
<h1><a class="header" href="#data-reference-14" id="data-reference-14">Data Reference</a></h1>
<h2><a class="header" href="#example-queries-11" id="example-queries-11">Example Queries</a></h2>
<p>This query gives the <code>day 2-7 activation</code> by product:</p>
<pre><code class="language-sql">SELECT
  cohort_date,
  product,
  SUM(day_2_7_activated) as day_2_7_activated,
  SUM(new_profiles) as new_profiles,
  SAFE_DIVIDE(SUM(day_2_7_activated), SUM(new_profiles)) as day_2_7_activation
FROM
  mozdata.telemetry.firefox_nondesktop_day_2_7_activation
WHERE
  cohort_date = &quot;2020-03-01&quot;
GROUP BY 1,2
ORDER BY 1
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/72054">Link to query in STMO</a></p>
<h2><a class="header" href="#scheduling-16" id="scheduling-16">Scheduling</a></h2>
<p>This dataset is scheduled on Airflow (<a href="https://github.com/mozilla/telemetry-airflow/blob/59effc6ead0b764a9ef3d30f40fbdb4b0b3394ec/dags/copy_deduplicate.py#L337">source</a>).</p>
<h2><a class="header" href="#schema-13" id="schema-13">Schema</a></h2>
<p>As of 2020-07-24, the current version of <code>firefox_nondesktop_day_2_7_activation</code> is v1, and has a schema as follows:</p>
<pre><code>root
    |- submission_date: date
    |- product: string
    |- app_name: string
    |- app_version: string
    |- os: string
    |- normalized_channel: string
    |- country: string
    |- new_profiles: integer
    |- day_2_7_activated: integer
</code></pre>
<h1><a class="header" href="#code-reference-14" id="code-reference-14">Code Reference</a></h1>
<p>The <code>firefox_nondesktop_day_2_7_activation job is</code> <a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/telemetry_derived/firefox_nondesktop_day_2_7_activation_v1/query.sql">defined in <code>bigquery-etl</code></a>.</p>
<h1><a class="header" href="#background-and-caveats-5" id="background-and-caveats-5">Background and Caveats</a></h1>
<p>Due to the delay in receiving all the initial pings and subsequent 7 day wait prior to establishing the new profile cohort, the table will lag <code>nondesktop_clients_last_seen</code> by 7 days.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/non_desktop/day_2_7_activation/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#google-play-store" id="google-play-store">Google Play Store</a></h1>
<ul>
<li><a href="datasets/non_desktop/google_play_store/reference.html#introduction">Introduction</a></li>
<li><a href="datasets/non_desktop/google_play_store/reference.html#contents">Contents</a>
<ul>
<li><a href="datasets/non_desktop/google_play_store/reference.html#background-and-caveats">Background and Caveats</a></li>
<li><a href="datasets/non_desktop/google_play_store/reference.html#accessing-the-data">Accessing the Data</a></li>
</ul>
</li>
<li><a href="datasets/non_desktop/google_play_store/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/non_desktop/google_play_store/reference.html#schema">Schema</a></li>
<li><a href="datasets/non_desktop/google_play_store/reference.html#example-queries">Example Queries</a>
<ul>
<li><a href="datasets/non_desktop/google_play_store/reference.html#calculate-google-play-store-activity-for-a-given-day-and-app-by-country">Calculate Google Play Store activity for a given day and app by country</a></li>
<li><a href="datasets/non_desktop/google_play_store/reference.html#calculate-google-play-store-activity-for-a-given-day-by-source-and-app">Calculate Google Play Store activity for a given day by source and app</a></li>
</ul>
</li>
<li><a href="datasets/non_desktop/google_play_store/reference.html#scheduling">Scheduling</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#introduction-15" id="introduction-15">Introduction</a></h1>
<p>The <a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;folder=&amp;organizationId=&amp;p=moz-fx-data-marketing-prod&amp;d=google_play_store&amp;page=dataset"><code>google_play_store</code></a> dataset is used to understand the acquisition performance for mobile products on the Google Play Store along key metrics and dimensions. Google’s documentation for all metrics and dimensions can be found <a href="https://support.google.com/googleplay/android-developer/answer/6263332?hl=en">on the Play Store support portal</a>.</p>
<h1><a class="header" href="#contents-7" id="contents-7">Contents</a></h1>
<p>The <a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;folder=&amp;organizationId=&amp;p=moz-fx-data-marketing-prod&amp;d=google_play_store&amp;page=dataset"><code>google_play_store</code></a> dataset contains a collection of tables and views exported from Google. The key tables currently being used for non-desktop reporting are:</p>
<ul>
<li><a href="https://console.cloud.google.com/bigquery?p=moz-fx-data-marketing-prod&amp;d=google_play_store&amp;t=Retained_installers_channel_v1&amp;page=table"><code>Retained_installers_channel_v1</code></a> - Store activity by acquisition channels. Acquisition channels include:
<ul>
<li><strong>Play Store (organic)</strong> - Unique users who saw the app’s store listing by browsing or searching on the Play Store app</li>
<li><strong>Third-party referrers</strong> - Unique users who visited the app's store listing on the Play Store app from an untagged deep link to the Play Store.</li>
<li><strong>Tracked Channels (UTM)</strong> - Unique users who visited the app’s store listing on the Play Store app from a UTM-tagged link.</li>
<li><strong>Google Search (organic)</strong> - Unique users who visited the app’s store listing on the Play Store app from a Google Search</li>
<li><strong>Google Ads</strong> - Unique users who visited the app’s store listing on the Play Store app from a Google Ads ad. Data between Google Ads and the Play Console can differ.</li>
<li><strong>Other</strong></li>
</ul>
</li>
<li><a href="https://console.cloud.google.com/bigquery?p=moz-fx-data-marketing-prod&amp;d=google_play_store&amp;t=Retained_installers_country_v1&amp;page=table"><code>Retained_installers_country_v1</code></a> - Store activity by country.</li>
<li><a href="https://console.cloud.google.com/bigquery?p=moz-fx-data-marketing-prod&amp;d=google_play_store&amp;t=Retained_installers_play_country_v1&amp;page=table"><code>Retained_installers_play_country_v1</code></a> - Store activity for the Play Store (organic) acquisition channel. Includes a country breakdown for the channel.</li>
<li><a href="https://console.cloud.google.com/bigquery?p=moz-fx-data-marketing-prod&amp;d=google_play_store&amp;t=Retained_installers_utm_tagged_v1&amp;page=table"><code>Retained_installers_utm_tagged_v1</code></a> - Store activity for the Tracked Channels (UTM) acquisition channel by campaign UTM.</li>
</ul>
<p>There are other tables available that are yet to be explored / incorporated into regular reporting. Some that may be of interest include:</p>
<ul>
<li>Crashes by app version</li>
<li>Device and OS</li>
<li>Installs</li>
<li>Ratings</li>
</ul>
<p>The metrics included in the <code>retained_installers</code> tables are:</p>
<ul>
<li><strong><code>Store_Listing_Visitors</code></strong> - Unique users who visited the app’s store listing on the Play Store app but haven’t installed the app</li>
<li><strong><code>Installers</code></strong> - Unique users who installed the app after visiting the app’s store listing on the Play Store app.</li>
<li><strong><code>Visitors_to_installer_conversion_rate</code></strong> - Percentage of <code>Store_Listing_visitors</code> that install the app.</li>
<li><strong><code>Installers_retained_for_1_day</code></strong> - Installers who kept the app on at least one of their devices for 1 day. Installation doesn’t mean the app was opened over this period.</li>
<li><strong><code>Installers_to_1_day_retention_rate</code></strong> - Percentage of installers who have the app on one of their devices 1 day after install.</li>
<li><strong><code>Installers_retained_for_7_days</code></strong> - Installers who kept the app on at least one of their devices for 7 days. Installation doesn’t mean the app was opened over this period.</li>
<li><strong><code>Installers_to_7_days_retention_rate</code></strong> - Percentage of installers who have the app on one of their devices 7 days after install.</li>
<li><strong><code>Installers_retained_for_15_days</code></strong> - Installers who kept the app on at least one of their devices for 15 days. Installation doesn’t mean the app was opened over this period.</li>
<li><strong><code>Installers_to_15_days_retention_rate</code></strong> - Percentage of installers who have the app on one of their devices 15 days after install.</li>
<li><strong><code>Installers_retained_for_30_days</code></strong> - Installers who kept the app on at least one of their devices for 30 days. Installation doesn’t mean the app was opened over this period.</li>
<li><strong><code>Installers_to_30_days_retention_rate</code></strong> - Percentage of installers who have the app on one of their devices 30 days after install.</li>
</ul>
<h2><a class="header" href="#background-and-caveats-6" id="background-and-caveats-6">Background and Caveats</a></h2>
<p>As of Aug 25 2020 not all the tables available in the dataset have been explored and vetted for accuracy by the data science team. Tables that were fully reviewed and being documented here are the <code>Retained_installers</code> tables whose primary use case is to explain acquisition.</p>
<p><strong>Note:</strong> Google does not make the play store data available for export every day. The export job checks for new files every day. However, having monitored the job, it appears the data is made available every 7 - 14 days, and seems to primarily be made available on weekends. Due to this lack of consistency, there will be delays in the data available for this dataset. The data currently in BigQuery is the most current data available from Google.</p>
<h2><a class="header" href="#accessing-the-data-9" id="accessing-the-data-9">Accessing the Data</a></h2>
<p>Access the data at <code>moz-fx-data-marketing-prod.google_play_store</code></p>
<h1><a class="header" href="#data-reference-15" id="data-reference-15">Data Reference</a></h1>
<h2><a class="header" href="#schema-14" id="schema-14">Schema</a></h2>
<pre><code>Retained_installer tables schema
root
    |- Date: date
    |- Package_Name: string
    |- [Acquisition_channel | country | UTM_source_campaign]: string
    |- Store_Listing_Visitors: integer
    |- Installers: integer
    |- Visitor_to_installer_conversion_rate: float
    |- installers_retained_for_1_day: integer
    |- installers_to_1_day_retention_rate: float
    |- installers_retained_for_7_days: integer
    |- installers_to_7_days_retention_rate: float
    |- installers_retained_for_15_days: integer
    |- installers_to_15_days_retention_rate: float
    |- installers_retained_for_30_days: integer
    |- installers_to_30_days_retention_rate: float
</code></pre>
<h2><a class="header" href="#example-queries-12" id="example-queries-12">Example Queries</a></h2>
<h3><a class="header" href="#calculate-google-play-store-activity-for-a-given-day-and-app-by-country" id="calculate-google-play-store-activity-for-a-given-day-and-app-by-country">Calculate Google Play Store activity for a given day and app by country</a></h3>
<pre><code class="language-sql">SELECT
  Date,
  Package_Name,
  Country,
  SUM(Store_Listing_Visitors) as Store_Visits,
  SUM(Installers) as installs,
  SAFE_DIVIDE(SUM(Installers), SUM(Store_Listing_Visitors)) as install_rate
FROM
  `moz-fx-data-marketing-prod.google_play_store.p_Retained_installers_country_v1`
WHERE
  Date = &quot;2020-08-01&quot;
  AND Package_Name = &quot;org.mozilla.firefox&quot;
GROUP BY
  date, Package_name, Country
ORDER BY
  Store_Visits DESC
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/74289/source">link to query on STMO</a></p>
<h3><a class="header" href="#calculate-google-play-store-activity-for-a-given-day-by-source-and-app" id="calculate-google-play-store-activity-for-a-given-day-by-source-and-app">Calculate Google Play Store activity for a given day by source and app</a></h3>
<pre><code class="language-sql">SELECT
  Date,
  Package_Name,
  Acquisition_Channel,
  SUM(Store_Listing_Visitors) as Store_Visits,
  SUM(Installers) as installs,
  SAFE_DIVIDE(SUM(Installers), SUM(Store_Listing_Visitors)) as install_rate
FROM
  `moz-fx-data-marketing-prod.google_play_store.p_Retained_installers_channel_v1`
WHERE
  Date = &quot;2020-08-01&quot;
GROUP BY
  date, Package_name, Acquisition_Channel
ORDER BY
  package_name, Store_Visits
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/74288/source">link to query on STMO</a></p>
<h2><a class="header" href="#scheduling-17" id="scheduling-17">Scheduling</a></h2>
<p>The job to retrieve the raw data from the Google Play Store can be found in <a href="https://github.com/mozilla/play-store-export">the <code>play-store-export</code> repository</a> and it is scheduled in <a href="https://github.com/mozilla/telemetry-airflow/blob/master/dags/play_store_export.py">airflow</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/non_desktop/google_play_store/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#apple-app-store" id="apple-app-store">Apple App Store</a></h1>
<ul>
<li><a href="datasets/non_desktop/apple_app_store/reference.html#introduction">Introduction</a></li>
<li><a href="datasets/non_desktop/apple_app_store/reference.html#contents">Contents</a>
<ul>
<li><a href="datasets/non_desktop/apple_app_store/reference.html#background-and-caveats">Background and Caveats</a></li>
<li><a href="datasets/non_desktop/apple_app_store/reference.html#accessing-the-data">Accessing the Data</a></li>
</ul>
</li>
<li><a href="datasets/non_desktop/apple_app_store/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/non_desktop/apple_app_store/reference.html#schema">Schema</a></li>
<li><a href="datasets/non_desktop/apple_app_store/reference.html#example-queries">Example Queries</a>
<ul>
<li><a href="datasets/non_desktop/apple_app_store/reference.html#calculate-apple-app-store-activity-for-a-given-day-by-app">Calculate Apple App Store Activity for a given day by app</a></li>
<li><a href="datasets/non_desktop/apple_app_store/reference.html#calculate-apple-app-store-activity-for-a-given-day-and-app-by-source">Calculate Apple App Store Activity for a given day and app by source</a></li>
</ul>
</li>
<li><a href="datasets/non_desktop/apple_app_store/reference.html#scheduling">Scheduling</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#introduction-16" id="introduction-16">Introduction</a></h1>
<p>The <a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;folder=&amp;organizationId=&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;page=dataset"><code>apple_app_store</code></a> dataset is used to understand the acquisition performance for non-desktop products on the Apple App Store along the key metrics and dimensions. Apple’s documentation for all metrics and dimensions can be found <a href="https://help.apple.com/app-store-connect/#/itc21781223f">in the app store connect reference</a>.</p>
<h1><a class="header" href="#contents-8" id="contents-8">Contents</a></h1>
<p>The <a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;folder=&amp;organizationId=&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;page=dataset"><code>apple_app_store</code></a> dataset contains a collection of aggregated tables by a singular dimension that explains the performance of acquisition activity through the Apple App Store.</p>
<p>The dimensions (saved as individual derived tables) include:</p>
<ul>
<li><a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;t=metrics_by_platform&amp;page=table"><code>moz-fx-data-marketing-prod.apple_app_store.metrics_by_platform</code></a> - The device type on which the app was downloaded or used. E.g. iPad, iPod, or iPhone.</li>
<li><a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;t=metrics_by_platform_version&amp;page=table"><code>moz-fx-data-marketing-prod.apple_app_store.platform version</code></a> - The OS version on which the app was downloaded or used. App Units, In-App Purchases, and Sales are based on the version on which the app is downloaded. Active in Last 30 Days, Product Page Views, Retention, and Sessions are based on the iOS version on which the app is used.</li>
<li><a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;t=metrics_by_app_version&amp;page=table"><code>moz-fx-data-marketing-prod.apple_app_store.app version</code></a> - The version of the app displayed on the app store at the time of activity.</li>
<li><a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;t=metrics_by_region&amp;page=table"><code>moz-fx-data-marketing-prod.apple_app_store.region</code></a> - The App Store region in which purchases were made, based on the customer’s billing address. Regions include (USA and Canada, Europe, Latin America and The Caribbean, Asia Pacific, Africa, The Middle East, and India)</li>
<li><a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;t=metrics_by_storefront&amp;page=table"><code>moz-fx-data-marketing-prod.apple_app_store.storefront</code></a> - The app store country in which purchases were made, based on the customer’s billing address.</li>
<li><a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;t=metrics_by_source&amp;page=table"><code>moz-fx-data-marketing-prod.apple_app_store.source</code></a> - The source from which a customer tapped a link to your App Store product page to view your app or download it for the first time. You can view metrics based on the source from which users are finding your app. Source types include (App Store Browse, App Store Search, App Referrers, Web Referrers)</li>
<li><a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;t=metrics_by_app_referrer&amp;page=table"><code>moz-fx-data-marketing-prod.apple_app_store.app referrer</code></a> - People landing on the app store via links from within other apps. This also includes apps using the store kit API and excludes the native Safari.</li>
<li><a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;t=metrics_by_web_referrer&amp;page=table"><code>moz-fx-data-marketing-prod.apple_app_store.web Referrer</code></a> - Previously top websites. Shows the referring website for the app download. Web referrals must be from Safari on devices with iOS 8 or tvOS 9 or later. Taps from websites using web browsers like chrome are attributed to that app.</li>
<li><a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;t=metrics_by_campaign&amp;page=table"><code>moz-fx-data-marketing-prod.apple_app_store.campaign</code></a> - Previously top campaigns. Tracks app and website referrals to measure the impact of an advertising campaign. Tracked by adding two tokens to any app store link to see results in app analytics.</li>
<li><a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;t=metrics_total&amp;page=table"><code>moz-fx-data-marketing-prod.apple_app_store.total</code></a>: Total metric activity without any dimension breakdown.</li>
</ul>
<p>The metrics included in the aggregated tables are:</p>
<ul>
<li><strong><code>app_units</code></strong> - The number of first-time app purchases made on the App Store using iOS 8 and tvOS 9 or later. Updates, re-downloads, download onto other devices are not counted. Family sharing downloads are included for free apps, but not for paid apps.</li>
<li><strong><code>impressions</code></strong> - The number of times the app was viewed in the Featured, Categories, Top Charts and Search Sections of the App Store. Also includes views of the product page.</li>
<li><strong><code>impressions_unique_device</code></strong> - The number of times the app was viewed in the Featured, Categories, Top Charts and Search Sections of the App Store by unique device. Also includes views of the product page.</li>
<li><strong><code>product_page_views</code></strong> - Number of times the app's product page has been viewed on devices iOS 8 and tvOS 9 or later. Includes both App Store app and store kit API</li>
<li><strong><code>product_page_views_unique_device</code></strong> - Number of times the app's product page has been viewed on devices iOS 8 and tvOS 9 or later by unique device. Includes both App Store app and store kit API</li>
<li><strong><code>active_devices_opt_in</code></strong> - The number of devices with at least one session during the selected period. Only devices with iOS 8 and tvOS 9 or later are included. Data for this metric is “opt-in” - collected only if users have agreed to share their diagnostics and usage information with app developers.</li>
<li><strong><code>active_devices_last_30_days_opt_in</code></strong> - The number of active devices with at least one session during the previous 30 days. Data for this metric is “opt-in” - collected only if users have agreed to share their diagnostics and usage information with app developers.</li>
<li><strong><code>deletions_opt_in</code></strong> - The number of times your app was deleted on devices running iOS 12.3 or tvOS 9 or later. This data includes deletions of the app from the Home Screen and deletions of the app through Manage Storage. Data from resetting or erasing a device's content and settings is not included. Data for this metric is “opt-in” - collected only if users have agreed to share their diagnostics and usage information with app developers.</li>
<li><strong><code>installations_opt_in</code></strong> - The total number of times your app has been installed on devices with iOS 8 or tvOS 9, or later. Re-downloads on the same device, downloads to multiple devices sharing the same Apple ID, and Family Sharing installations are included. Data for this metric is “opt-in” - collected only if users have agreed to share their diagnostics and usage information with app developers.</li>
<li><strong><code>sessions_opt_in</code></strong> - The number of times the app has been used for at least two seconds. If the app is in the background and is later used again, that counts as another session. Data for this metric is “opt-in” - collected only if users have agreed to share their diagnostics and usage information with app developers.</li>
</ul>
<h2><a class="header" href="#background-and-caveats-7" id="background-and-caveats-7">Background and Caveats</a></h2>
<p>The data is received from Apple with only one dimension per metric. As a result, we are unable to do multi-dimensional analysis. i.e. we can tell how each storefront is performing but we can’t see how specific platforms or sources are contributing to it.</p>
<h2><a class="header" href="#accessing-the-data-10" id="accessing-the-data-10">Accessing the Data</a></h2>
<p>Access the data at <a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;folder=&amp;organizationId=&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;page=dataset"><code>moz-fx-data-marketing-prod.apple_app_store</code></a></p>
<h1><a class="header" href="#data-reference-16" id="data-reference-16">Data Reference</a></h1>
<h2><a class="header" href="#schema-15" id="schema-15">Schema</a></h2>
<pre><code>metrics_by_[dimension] tables
root
    |- date: date
    |- app_name: string
    |- [app_referrer | app_version | campaign | platform | platform_version | region | source | storefront | web_referrer]: string
    |- app_units: integer
    |- impressions: integer
    |- impressions_unique_device: integer
    |- product_page_views: integer
    |- product_page_views_unique_device: integer
    |- active_devices_opt_in: integer
    |- active_devices_last_30_days_opt_in: integer
    |- deletions_opt_in: integer
    |- installations_opt_in: integer
    |- sessions_opt_in: integer
</code></pre>
<h2><a class="header" href="#example-queries-13" id="example-queries-13">Example Queries</a></h2>
<h3><a class="header" href="#calculate-apple-app-store-activity-for-a-given-day-by-app" id="calculate-apple-app-store-activity-for-a-given-day-by-app">Calculate Apple App Store Activity for a given day by app</a></h3>
<pre><code class="language-sql">SELECT
  date,
  app_name,
  SUM(impressions_unique_device) as unique_device_impressions,
  SUM(product_page_views_unique_device) as unique_device_page_views,
  SUM(app_units) as installs,
  SAFE_DIVIDE(SUM(product_page_views_unique_device), SUM(impressions_unique_device)) as unique_device_page_view_rate,
  SAFE_DIVIDE(SUM(app_units), SUM(product_page_views_unique_device)) as install_rate
FROM
  `moz-fx-data-marketing-prod.apple_app_store.metrics_total`
WHERE
  date = &quot;2020-08-20&quot;
GROUP BY
  date, app_name
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/74291/source">link to query on STMO</a></p>
<h3><a class="header" href="#calculate-apple-app-store-activity-for-a-given-day-and-app-by-source" id="calculate-apple-app-store-activity-for-a-given-day-and-app-by-source">Calculate Apple App Store Activity for a given day and app by source</a></h3>
<pre><code class="language-sql">SELECT
  date,
  app_name,
  source,
  SUM(impressions_unique_device) as unique_device_impressions,
  SUM(product_page_views_unique_device) as unique_device_page_views,
  SUM(app_units) as installs,
  SAFE_DIVIDE(SUM(product_page_views_unique_device), SUM(impressions_unique_device)) as unique_device_page_view_rate,
  SAFE_DIVIDE(SUM(app_units), SUM(product_page_views_unique_device)) as install_rate
FROM
  `moz-fx-data-marketing-prod.apple_app_store.metrics_by_source`
WHERE
  date = &quot;2020-08-20&quot;
  AND app_name = &quot;Firefox&quot;
GROUP BY
  date, app_name, source
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/queries/74290/source">link to query on STMO</a></p>
<h2><a class="header" href="#scheduling-18" id="scheduling-18">Scheduling</a></h2>
<p>The job to retrieve the raw data from the Apple App Store can be found in <a href="https://github.com/mozilla/app-store-analytics-export">the <code>app-store-analytics-export</code> repository</a>. The exported results are individual metrics grouped by a single dimension. These exports are initially loaded into the <a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store_exported&amp;page=dataset"><code>apple_app_store_exported</code></a> data source. The exports are scheduled in <a href="https://github.com/mozilla/telemetry-airflow/blob/master/dags/app_store_analytics.py"><code>airflow</code></a>. The job to create the derived tables found in <a href="https://console.cloud.google.com/bigquery?project=moz-fx-data-marketing-prod&amp;p=moz-fx-data-marketing-prod&amp;d=apple_app_store&amp;page=dataset"><code>moz-fx-data-marketing-prod.apple_app_store</code></a> can be found in <a href="https://github.com/mozilla/bigquery-etl/tree/master/sql/moz-fx-data-marketing-prod/apple_app_store"><code>bigquery-etl</code> under <code>apple_app_store</code></a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/non_desktop/apple_app_store/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#events-daily" id="events-daily">Events Daily</a></h1>
<ul>
<li><a href="datasets/non_desktop/events_daily/reference.html#introduction">Introduction</a></li>
<li><a href="datasets/non_desktop/events_daily/reference.html#contents">Contents</a></li>
<li><a href="datasets/non_desktop/events_daily/reference.html#limitations">Limitations</a></li>
<li><a href="datasets/non_desktop/events_daily/reference.html#accessing-the-data">Accessing the Data</a></li>
<li><a href="datasets/non_desktop/events_daily/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/non_desktop/events_daily/reference.html#example-queries">Example Queries</a></li>
</ul>
</li>
<li><a href="datasets/non_desktop/events_daily/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/non_desktop/events_daily/reference.html#schema">Schema</a></li>
<li><a href="datasets/non_desktop/events_daily/reference.html#code-reference">Code Reference</a></li>
<li><a href="datasets/non_desktop/events_daily/reference.html#background-and-caveats">Background and Caveats</a></li>
</ul>
<h2><a class="header" href="#introduction-17" id="introduction-17">Introduction</a></h2>
<p><code>org_mozilla_firefox.events_daily</code> is designed to answer questions about events. These include:</p>
<ul>
<li>Funnels</li>
<li>Event Counts</li>
<li>User Flows</li>
</ul>
<h2><a class="header" href="#contents-9" id="contents-9">Contents</a></h2>
<p><code>events_daily</code> has one row per-client per-day, much the same as <code>clients_daily</code>. The table is created in a two-step process:</p>
<ol>
<li>An ancillary table, <code>event_types</code>, is updated with the new events seen on that day. Each event is mapped to a unique
unicode character, and each event property (the <code>extras</code> fields) are also mapped to a unique unicode character.</li>
<li>For every user, that day's events are mapped to their associated unicode characters (including <code>event_properties</code>).
The strings are aggregated and comma-separated, giving a single ordered string that represents all of that user's
events on that day.</li>
</ol>
<p>For Fenix, we aggregate the events ping data <em>only</em>. If you're looking for events in other pings, you'll need to query them directly.</p>
<p>Included in this data is a set of dimensional information about the user, also derived from the events ping. The full list of fields is available <a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/org_mozilla_firefox_derived/events_daily_v1/query.sql#L48">in the query</a>.</p>
<h2><a class="header" href="#limitations" id="limitations">Limitations</a></h2>
<p>This approach makes some queries fast and easy, but has some limits:</p>
<ol>
<li>Each product is limited to at most 1 Million unique event types</li>
<li>Each event property is limited to at most 1 Million values. As a result, <a href="https://github.com/mozilla/bigquery-etl/blob/ad84a15d580333b41d36cfe8331e51238f3bafa1/sql/moz-fx-data-shared-prod/org_mozilla_firefox_derived/event_types_v1/query.sql#L89">some Fenix event properties are not included in this table</a>.</li>
<li>Queries do not know the amount of time that passed between events, only that they occurred on the same day
<em>Note</em>: This can be alleviated by sessionizing and splitting the events string using a <code>session_start</code> event.
For Fenix this could be <a href="https://github.com/mozilla-mobile/fenix/blob/master/app/metrics.yaml#L11"><code>events.app_opened_all_startup</code></a>.</li>
</ol>
<h2><a class="header" href="#accessing-the-data-11" id="accessing-the-data-11">Accessing the Data</a></h2>
<p>While it is possible to build queries that access this events data directly, the Data Platform instead recommends using a set of stored procedures we have available.
These procedures create BigQuery views that hide the complexity of the event representation. The <a href="https://mozilla.github.io/bigquery-etl/mozfun/event_analysis/"><code>mozfun</code> library documentation</a>
has information about these procedures and examples of their usage.</p>
<h2><a class="header" href="#data-reference-17" id="data-reference-17">Data Reference</a></h2>
<h3><a class="header" href="#example-queries-14" id="example-queries-14">Example Queries</a></h3>
<p>This query gives the event-count and client-counts per-event per-day.</p>
<pre><code class="language-sql">SELECT
  submission_date,
  category,
  event,
  COUNT(*) AS client_count,
  SUM(count) AS event_count
FROM
  `moz-fx-data-shared-prod`.org_mozilla_firefox.events_daily
CROSS JOIN
  UNNEST(mozfun.event_analysis.extract_event_counts(events))
JOIN
  `moz-fx-data-shared-prod`.org_mozilla_firefox.event_types
  USING (index)
WHERE
  submission_date &gt;= DATE_SUB(current_date, INTERVAL 28 DAY)
GROUP BY
  submission_date,
  category,
  event
</code></pre>
<p><a href="https://sql.telemetry.mozilla.org/dashboard/fenix-events">Link to a dashboard using this query in STMO</a>.</p>
<h2><a class="header" href="#scheduling-19" id="scheduling-19">Scheduling</a></h2>
<p>This dataset is scheduled on Airflow and updated daily.</p>
<h2><a class="header" href="#schema-16" id="schema-16">Schema</a></h2>
<p>As of 2020-10-01, the current version of <code>events_daily</code> is v1, and has a schema as follows:</p>
<pre><code>root
    |- submission_date: date
    |- client_id: string
    |- events: string
    |- android_sdk_version: string
    |- app_build: string
    |- app_channel: string
    |- app_display_version: string
    |- architecture: string
    |- device_manufacturer: string
    |- device_model: string
    |- first_run_date: string
    |- telemetry_sdk_build: string
    |- locale: string
    |- city: string
    |- country: string
    |- subdivision1: string
    |- channel: string
    |- os: string
    |- os_version: string
    |- experiments: record
    |  |- key: string
    |  |- value: string
</code></pre>
<h2><a class="header" href="#code-reference-15" id="code-reference-15">Code Reference</a></h2>
<p>The job is <a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/org_mozilla_firefox_derived/events_daily_v1/query.sql">defined in <code>bigquery-etl</code></a>.
The job for updating <code>event_types</code> is <a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/org_mozilla_firefox_derived/event_types_v1/query.sql">also defined in <code>bigquery-etl</code></a>.</p>
<h2><a class="header" href="#background-and-caveats-8" id="background-and-caveats-8">Background and Caveats</a></h2>
<p>See <a href="https://docs.google.com/presentation/d/1hY82h_hP-pJd1j_7PsPPHn469XIQ7p4BfTH3aqRpYTk">this presentation</a> for background.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/non_desktop/events_daily/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#other-datasets" id="other-datasets">Other Datasets</a></h1>
<p>These datasets are for projects outside of the Firefox telemetry domain.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/other.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#hgpush" id="hgpush">hgpush</a></h1>
<p>This dataset records facts about individual commits to the Firefox source tree
in the <a href="https://hg.mozilla.org/mozilla-central/"><code>mozilla-central</code></a> source
code repository.</p>
<h1><a class="header" href="#data-reference-18" id="data-reference-18">Data Reference</a></h1>
<p>The dataset is accessible via <a href="https://sql.telemetry.mozilla.org"><code>STMO</code></a>.
Use the <code>eng_workflow_hgpush_parquet_v1</code> table with the <code>Athena</code> data source.
(The <code>Presto</code> data source is also available, but much slower.)</p>
<h2><a class="header" href="#field-types-and-descriptions" id="field-types-and-descriptions">Field Types and Descriptions</a></h2>
<p>See the <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/blob/master/schemas/eng-workflow/hgpush/hgpush.1.schema.json"><code>hgpush</code> ping schema</a>
for a description of available fields.</p>
<p>Be careful to:</p>
<ul>
<li>Use the latest schema version. e.g. <code>v1</code>. Browse the <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/tree/master/schemas/eng-workflow/hgpush"><code>hgpush</code> schema directory</a> in the GitHub repo to be sure.</li>
<li>Change dataset field names from <code>camelCaseNames</code> to <code>under_score_names</code> in STMO. e.g. <code>reviewSystemUsed</code> in the ping schema becomes <code>review_system_used</code> in STMO.</li>
</ul>
<h2><a class="header" href="#example-queries-15" id="example-queries-15">Example Queries</a></h2>
<p>Select the number of commits with an 'unknown' review system in the last 7 days:</p>
<pre><code class="language-sql">select
    count(1)
from
    eng_workflow_hgpush_parquet_v1
where
    review_system_used = 'unknown'
    and date_diff('day', from_unixtime(push_date), now()) &lt; 7
</code></pre>
<h1><a class="header" href="#code-reference-16" id="code-reference-16">Code Reference</a></h1>
<p>The dataset is populated via the <a href="https://github.com/mozilla-conduit/commit-telemetry-service">Commit Telemetry Service</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/other/hgpush/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#what-is-the-stub-installer-ping" id="what-is-the-stub-installer-ping">What is the Stub Installer ping?</a></h1>
<p>When the stub installer completes with almost any result, it generates a ping containing some data about the system and about how the installation went. This ping isn't part of Firefox unified telemetry, it's a bespoke system; we can't use the telemetry client code when it isn't installed yet.</p>
<p>No ping is sent if the installer exits early because initial system requirements checks fail.</p>
<h2><a class="header" href="#how-its-processed" id="how-its-processed">How it’s processed</a></h2>
<p>They are formed and sent from NSIS code (!) in the stub installer, in the <a href="https://searchfox.org/mozilla-central/source/browser/installer/windows/nsis/stub.nsi">SendPing subroutine</a>.</p>
<p>They are processed into Redshift by <a href="https://github.com/whd/dsmo_load"><code>dsmo_load</code></a>.</p>
<h2><a class="header" href="#how-to-access-the-data" id="how-to-access-the-data">How to access the data</a></h2>
<p>The Redshift tables are accessible from the <code>DSMO-RS</code> data source in <a href="https://sql.telemetry.mozilla.org/">STMO</a>.</p>
<p>The canonical documentation is in <a href="https://searchfox.org/mozilla-central/source/toolkit/components/telemetry/docs/data/install-ping.rst">this tree</a>.</p>
<p>There are three tables produced every day (you can see them in Redshift as <code>{tablename}_YYYYMMDD</code>:</p>
<ul>
<li><code>download_stats_YYYYMMDD</code> (<a href="https://github.com/whd/dsmo_load/blob/master/hindsight/hs_run/output/dsmo_redshift.lua">source</a>)</li>
<li><code>download_stats_funnelcake_YYYYMMDD</code> (<a href="https://github.com/whd/dsmo_load/blob/master/hindsight/hs_run/output/dsmo_funnelcake_redshift.lua">source</a>)</li>
<li><code>download_stats_errors_YYYYMMDD</code> (<a href="https://github.com/whd/dsmo_load/blob/master/hindsight/hs_run/output/dsmo_errors_redshift.lua">source</a>)</li>
</ul>
<p>The funnelcake tables aggregate funnelcake builds, which have additional metadata for tracking distribution experiments. <a href="https://wiki.mozilla.org/Funnelcake">More on Funnelcake</a>.</p>
<p><code>download_stats</code> (without the date appended) and <code>download_stats_year</code> are views that union all (or a year's worth) of the per-day tables together, which makes e.g. <code>SELECT * LIMIT 10</code> operations on them quite slow.</p>
<p>Note about <code>os_version</code>: Previous versions of Windows have used a very small set of build numbers through their entire life cycle. However, Windows 10 gets a new build number with every major update (about every 6 months), and many more builds have been released on its insider channels. So, to prevent a huge amount of noise, queries using this field should generally filter out the build number and only use the major and minor version numbers to differentiate Windows versions, unless the build number is specifically needed.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/other/stub_installer/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#activity-stream-datasets" id="activity-stream-datasets">Activity Stream Datasets</a></h1>
<p>This article describes the various BigQuery tables Mozilla uses to store Activity Stream data, along with some examples of how to access them.</p>
<h2><a class="header" href="#table-of-contents-15" id="table-of-contents-15">Table of Contents</a></h2>
<ul>
<li><a href="datasets/other/activity-stream/reference.html#what-is-activity-stream">What is Activity Stream?</a></li>
<li><a href="datasets/other/activity-stream/reference.html#activity-stream-pings">Activity Stream Pings</a></li>
<li><a href="datasets/other/activity-stream/reference.html#accessing-activity-stream-data">Accessing Activity Stream Data</a>
<ul>
<li><a href="datasets/other/activity-stream/reference.html#activity_stream"><code>activity_stream</code></a></li>
<li><a href="datasets/other/activity-stream/reference.html#messaging_system"><code>messaging_system</code></a></li>
</ul>
</li>
<li><a href="datasets/other/activity-stream/reference.html#gotchas-and-caveats">Gotchas and Caveats</a></li>
<li><a href="datasets/other/activity-stream/reference.html#examples">Examples</a>
<ul>
<li><a href="datasets/other/activity-stream/reference.html#sessions-per-client_id">Sessions per <code>client_id</code></a></li>
<li><a href="datasets/other/activity-stream/reference.html#topsite-clicks-and-highlights-clicks">Topsite clicks and Highlights clicks</a></li>
<li><a href="datasets/other/activity-stream/reference.html#snippet-impressions-blocks-clicks-and-dismissals">Snippet impressions, blocks, clicks, and dismissals</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#what-is-activity-stream" id="what-is-activity-stream">What is Activity Stream?</a></h2>
<p>Activity Stream is the Firefox module which manages the in product content pages for Firefox:</p>
<ul>
<li><code>about:home</code></li>
<li><code>about:newtab</code></li>
<li><code>about:welcome</code>
<ul>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1448918">starting with Firefox 62</a></li>
</ul>
</li>
<li><code>Snippets</code></li>
<li><code>CFR</code></li>
<li><code>Onboarding</code></li>
<li><code>What's new panel</code></li>
<li><code>Moments pages</code></li>
</ul>
<p>The Activity Stream team has implemented data collection in and around these pages. This data has some overlap with the standard Firefox Telemetry system, however it is a custom system, designed and maintained by that team.</p>
<p>For specific questions about this data, reach out to the <code>#fx-messaging-system</code> Slack channel directly.</p>
<h2><a class="header" href="#activity-stream-pings" id="activity-stream-pings">Activity Stream Pings</a></h2>
<p>This data is measured in various custom pings that are sent via <a href="https://searchfox.org/mozilla-central/source/browser/modules/PingCentre.jsm">PingCentre</a> (different from <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/internals/pingsender.html">Pingsender</a>).</p>
<ul>
<li><a href="https://firefox-source-docs.mozilla.org/browser/components/newtab/docs/v2-system-addon/data_events.html">Activity Stream Pings: <code>data_events.md</code></a></li>
<li><a href="https://firefox-source-docs.mozilla.org/browser/components/newtab/docs/v2-system-addon/data_dictionary.html">Activity Stream Pings: <code>data_dictionary.md</code></a></li>
</ul>
<h2><a class="header" href="#accessing-activity-stream-data" id="accessing-activity-stream-data">Accessing Activity Stream Data</a></h2>
<p>Activity Stream pings are stored in BigQuery (like other Firefox Telemetry). There are two datasets: <code>activity_stream</code> and <code>messaging_system</code>.</p>
<h4><a class="header" href="#activity_stream" id="activity_stream"><code>activity_stream</code></a></h4>
<p>The <code>activity_stream</code> dataset contains the following tables:</p>
<ul>
<li><code>events</code> stores user interactions with the <code>about:home</code> and <code>about:newtab</code> pages</li>
<li><code>sessions</code> stores sessions of <code>about:home</code> and <code>about:newtab</code> pages</li>
<li><code>impression_stats</code> stores impression/click/block events for the Pocket recommendations on the <code>about:home</code> and <code>about:newtab</code> pages</li>
<li><code>spoc_fills</code> stores &quot;Pocket Sponsored&quot; recommendation related pings</li>
</ul>
<h4><a class="header" href="#messaging_system" id="messaging_system"><code>messaging_system</code></a></h4>
<p>The <code>messaging_system</code> dataset contains the following tables:</p>
<ul>
<li><code>cfr</code> stores metrics on user interactions with the CFR (Contextual Feature Recommendation) system</li>
<li><code>moments</code> stores &quot;Moments Pages&quot; related pings</li>
<li><code>onboarding</code> stores metrics on user interactions with onboarding features</li>
<li><code>snippets</code> stores impression/click/dismissal metrics for Firefox Snippets</li>
<li><code>whats_new_panel</code> stores &quot;What's New Panel&quot; related pings</li>
<li><code>undesired_events</code> stores system health related events</li>
</ul>
<h2><a class="header" href="#gotchas-and-caveats" id="gotchas-and-caveats">Gotchas and Caveats</a></h2>
<p>Since this data collection isn't collected or maintained through our standard Telemetry API, there are a number of &quot;gotchas&quot; to keep in mind when working on this data:</p>
<ul>
<li>
<p><strong>Ping send conditions</strong>: Activity Stream pings have different send conditions, both from Telemetry pings as well as from each other. For example, <a href="https://firefox-source-docs.mozilla.org/browser/components/newtab/docs/v2-system-addon/data_events.html#session-end-pings">AS Session Pings</a> get sent by profiles that entered an Activity Stream session, at the end of that session, regardless of how long that session is. Compare this to <code>main</code> pings, which get sent by all Telemetry enabled profiles upon subsession end (browser shutdown, environment change, or local midnight cutoff).</p>
<p>Due to these inconsistencies, using data from different sources can be tricky. For example, if we wanted to know how much of DAU (from <code>main</code> pings) had a custom <code>about:home</code> page (available in AS Health Pings), joining on <code>client_id</code> and a date field would only provide information on profiles that started the session on that same day (active profiles on multi-day sessions would be excluded).</p>
</li>
<li>
<p><strong>Population covered</strong>: In addition to the usual considerations when looking at a measurement (in what version of Firefox did this measurement start getting collected? In what channels is it enabled in? etc.), when working with this data, there are additional Activity Stream specific conditions to consider when deciding &quot;who is eligible to send this ping?&quot;</p>
<p>For example, Pocket recommendations are only enabled in the US, CA, UK, and DE countries, for profiles that are on en-US, en-CA, en-GB, and de locales. Furthermore, users can set their <code>about:home</code> and <code>about:newtab</code> page to non-Activity Stream pages. This information can be important when deciding denominators for certain metrics.</p>
</li>
<li>
<p><strong>Different ping types in the same table</strong>: The tables in the <code>activity_stream</code> namespace can contain multiple types of pings. For example, the <code>events</code> table contains both <a href="https://firefox-source-docs.mozilla.org/browser/components/newtab/docs/v2-system-addon/data_events.html#page-takeover-ping">AS Page Takeover pings</a> as well as <a href="https://firefox-source-docs.mozilla.org/browser/components/newtab/docs/v2-system-addon/data_events.html#user-event-pings">AS User Event pings</a>.</p>
</li>
<li>
<p><strong>Null handling</strong>: Some fields in the Activity Stream data encode nulls with a <code>'N/A'</code> string or a <code>-1</code> value.</p>
</li>
<li>
<p><strong>Changes in ping behaviors</strong>: These pings continue to undergo development and the behavior as well as possible values for a given ping seem to change over time. For example, older versions of the event pings for clicking on a Topsite do not seem to report <code>card_types</code> and <code>icon_types</code>, while newer versions do. Caution is advised.</p>
</li>
<li>
<p><strong>Pocket data</strong>: Data related to Pocket interaction and usage in the <code>about:home</code> and <code>about:newtab</code> pages get sent to Pocket via this data collection and pipeline. However, due to privacy reasons, the <code>client_id</code> is omitted in the ping whenever the Pocket recommendation identifiers are included, instead it reports with another user unique identifier <code>impression_id</code>. Though all the Pocket user interactions, such as clicks, dismisses, and save to pocket are still reported as the regular events with the <code>client_id</code> as long as they don't contain the Pocket recommendation identifiers.</p>
</li>
</ul>
<h2><a class="header" href="#examples-1" id="examples-1">Examples</a></h2>
<h3><a class="header" href="#sessions-per-client_id" id="sessions-per-client_id">Sessions per <code>client_id</code></a></h3>
<p>Note: only includes <code>client_ids</code> that completed an Activity Stream session that day.</p>
<pre><code class="language-sql">SELECT
    client_id,
    DATE(submission_timestamp) AS date,
    count(DISTINCT session_id) as num_sessions
FROM
    `moz-fx-data-shared-prod.activity_stream.sessions`
WHERE
    DATE(submission_timestamp) = '20200601'
GROUP BY
    1
</code></pre>
<h3><a class="header" href="#topsite-clicks-and-highlights-clicks" id="topsite-clicks-and-highlights-clicks">Topsite clicks and Highlights clicks</a></h3>
<pre><code class="language-sql">SELECT
    client_id,
    DATE(submission_timestamp) AS date,
    session_id,
    page,
    source,
    action_position,
    experiments
FROM
    `moz-fx-data-shared-prod.activity_stream.events`
WHERE
    source in ('TOP_SITES', 'HIGHLIGHTS')
    AND event = 'CLICK'
    DATE(submission_timestamp) = '20200601'
</code></pre>
<h3><a class="header" href="#snippet-impressions-blocks-clicks-and-dismissals" id="snippet-impressions-blocks-clicks-and-dismissals">Snippet impressions, blocks, clicks, and dismissals</a></h3>
<p>Note: Which snippet message a record corresponds to can be identified by the <code>message_id</code> (check with Marketing for snippet recipes published).</p>
<pre><code class="language-sql">SELECT
    client_id,
    DATE(submission_timestamp) AS date,
    event,
    message_id,
    event_context,
    experiments
FROM
    `moz-fx-data-shared-prod.messaging_system.snippets`
WHERE
    DATE(submission_timestamp) = '20200601'
</code></pre>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/other/activity-stream/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#bmobugs" id="bmobugs"><code>bmobugs</code></a></h1>
<p>This dataset mirrors bugs (defects, enhancements, tasks) reported in the
<a href="https://bugzilla.mozilla.org/"><code>Bugzilla</code></a> bug tracker.</p>
<h1><a class="header" href="#data-reference-19" id="data-reference-19">Data Reference</a></h1>
<p>The dataset is accessible via <a href="https://sql.telemetry.mozilla.org"><code>STMO</code></a>.
Use the <code>eng_workflow.bmobugs</code> table with the <code>Telemetry (BigQuery)</code> data source.</p>
<h2><a class="header" href="#field-types-and-descriptions-1" id="field-types-and-descriptions-1">Field Types and Descriptions</a></h2>
<p><code>bug_id</code></p>
<p>The unique ID of the bug. The bug can be accessed at
<code>https://bugzilla.mozilla.org/show_bug.cgi?id=&lt;bug_id&gt;</code></p>
<p><code>reporter</code></p>
<p>The <code>bugmail</code> of the user who filed the bug</p>
<p><code>assigned_to</code></p>
<p>The <code>bugmail</code> of the user the bug has been assigned to
by default, this is <code>nobody@mozilla.org</code></p>
<p><code>qa_contact</code></p>
<p>The <code>bugmail</code> of the user who is responsible for answering
QA questions about the bug; This field is assigned on a per-
product::component basis</p>
<p><code>product</code></p>
<p>The product in which the bug was filed; see the
<a href="https://bugzilla.mozilla.org/describecomponents.cgi">Bugzilla product descriptions</a>
for details</p>
<p><code>component</code></p>
<p>The component of the product in which the bug was filed</p>
<p><code>bug_status</code></p>
<p>The status of the bug:</p>
<ul>
<li><code>UNCONFIRMED</code></li>
<li><code>NEW</code></li>
<li><code>ASSIGNED</code></li>
<li><code>RESOLVED</code></li>
<li><code>CLOSED</code></li>
</ul>
<p><code>keywords</code></p>
<p>Controlled vocabulary <a href="https://bugzilla.mozilla.org/describekeywords.cgi">keywords</a>
assigned to the bug</p>
<p><code>groups</code></p>
<p><code>Bugzilla</code> groups to which the bug has been assigned</p>
<p><code>flags</code></p>
<p>Flags requested by users of other users</p>
<ul>
<li><code>name</code>: the name of the flag such as <code>needinfo</code></li>
<li><code>status</code>: <code>?</code>, <code>+</code>, <code>-</code></li>
<li><code>setter_id</code>: the <code>bugmail</code> of the user requesting the flag</li>
<li><code>requestee_id</code>: the <code>bugmail</code> of the user who the flag was requested of</li>
</ul>
<p><code>priority</code></p>
<p>The bug's priority, as set by the developers who triage the product::component</p>
<p><code>resolution</code></p>
<p>If non-default, <code>---</code>, the resolution of the bug; which includes <code>FIXED</code>, <code>VERIFIED</code>,
<code>WORKSFORME</code>, <code>DUPLICATE</code>, <code>INVALID</code>, <code>WONTFIX</code>, and <code>MOVED</code>.</p>
<p><code>blocked_by</code></p>
<p>Bugs which much be resolved before this bug can be worked on
or resolved</p>
<p><code>depends_on</code></p>
<p>Bugs depending on the resolution of this bug before they can be resolved.</p>
<p><code>duplicate_of</code></p>
<p>If the bug has been resolved as <code>DUPLICATE</code>, the id of the bug of which
this is a duplicate</p>
<p><code>duplicates</code></p>
<p>List of bugs which have been resolved as duplicates of this bug</p>
<p><code>target_milestone</code></p>
<p>The version number of the branch of Nightly in which the change
set associated with the bug was landed; note that version
numbers vary by product</p>
<p><code>version</code></p>
<p>The version of Firefox in which the bug was reported</p>
<p><code>delta_ts</code></p>
<p>The timestamp of when the bug was last modified</p>
<p><code>creation_ts</code></p>
<p>The timestamp of when the bug was filed</p>
<h2><a class="header" href="#example-queries-16" id="example-queries-16">Example Queries</a></h2>
<p>Select the number of bugs in the Core product filed
in the past 7 days:</p>
<pre><code class="language-sql">SELECT
  count(distinct bug_id)
FROM
  eng_workflow.bmobugs
WHERE
  product = 'Core'
  AND date_diff(current_date(), date(parse_timestamp('%Y-%m-%d %H:%M:%S', creation_ts)), DAY) &lt;= 7
  AND date(submission_timestamp) &gt;= '2019-01-01' -- required submission date filter
</code></pre>
<h1><a class="header" href="#code-reference-17" id="code-reference-17">Code Reference</a></h1>
<p>The dataset is populated via the
<a href="https://github.com/mozilla-bteam/bmo/blob/master/Bugzilla/Report/Ping/Simple.pm">simple ping service on Bugzilla</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/other/bmobugs/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#firefox-accounts-data" id="firefox-accounts-data">Firefox Accounts Data</a></h1>
<h2><a class="header" href="#table-of-contents-16" id="table-of-contents-16">Table of Contents</a></h2>
<ul>
<li><a href="datasets/fxa.html#introduction">Introduction</a></li>
<li><a href="datasets/fxa.html#what-is-firefox-accounts">What is Firefox Accounts?</a></li>
<li><a href="datasets/fxa.html#metrics-background">Metrics Background</a></li>
<li><a href="datasets/fxa.html#metrics-taxonomies">Metrics Taxonomies</a></li>
</ul>
<h2><a class="header" href="#introduction-18" id="introduction-18">Introduction</a></h2>
<p>This article provides an overview of Firefox Accounts metrics: what is measured and how. See the other articles in this chapter for more details about the specific measurements that are available for analysis.</p>
<h2><a class="header" href="#what-is-firefox-accounts" id="what-is-firefox-accounts">What is Firefox Accounts?</a></h2>
<p><a href="https://www.mozilla.org/en-US/firefox/accounts/">Firefox Accounts</a> is Mozilla's authentication solution for account-based end-user services and features. At the time of writing, sync is by far the most popular account-relying service. Below is a partial list of current FxA-relying services (by the time you are reading this others will likely have been added; we will endeavor to update the list periodically):</p>
<ul>
<li><a href="https://support.mozilla.org/en-US/kb/how-do-i-set-sync-my-computer">Sync</a>
<ul>
<li>Requires FxA.</li>
</ul>
</li>
<li><a href="https://send.firefox.com/">Firefox Send</a>
<ul>
<li>FxA Optional; Required to send large files.</li>
</ul>
</li>
<li><a href="https://lockwise.firefox.com/">Lockwise</a>
<ul>
<li>Requires FxA and sync.</li>
</ul>
</li>
<li><a href="https://addons.mozilla.org/en-US/firefox/">AMO</a>
<ul>
<li>For developer accounts; not required by end-users to use or download addons.</li>
</ul>
</li>
<li><a href="https://getpocket.com/login/?ep=1">Pocket</a>
<ul>
<li>FxA is an optional authentication method among others.</li>
</ul>
</li>
<li><a href="https://monitor.firefox.com">Monitor</a>
<ul>
<li>Required to receive email alerts. Not required for email scans.</li>
</ul>
</li>
<li><a href="https://wiki.mozilla.org/IAM/Frequently_asked_questions">Mozilla IAM</a>
<ul>
<li>Optional authentication method among others.</li>
</ul>
</li>
</ul>
<p>A single account can be used to authenticate with all of the services listed above (though see the note below about Chinese users).</p>
<p>Note that in addition to being the most commonly used relier of FxA, sync is also unique in its integration with FxA - unlike the other reliers in the list above, sync is currently <strong>not</strong> an FxA oauth client. When someone signs into an oauth client using Firefox, nothing in the browser changes - more specifically, client-side telemetry probes such as <a href="https://telemetry.mozilla.org/probe-dictionary/?detailView=histogram%2FFXA_CONFIGURED"><code>FXA_CONFIGURED</code></a> do not change state. Thus at the present time the only way to measure usage of FxA oauth reliers is to use the FxA server-side measures described below.</p>
<p>One more thing: China runs its own stack for sync, but Chinese sign-ups for oauth reliers still go through the &quot;one and only&quot; oauth server. This means that Chinese users who want to use both sync and an oauth service (e.g. Monitor) will have to register for two accounts. It also means that only metrics for Chinese oauth users will show up in the datasets described below; any sync-related measures will not. At present, you must contact those responsible for maintaining the FxA stack in China for metrics on Chinese sync users.</p>
<h2><a class="header" href="#metrics-background" id="metrics-background">Metrics Background</a></h2>
<p>Unlike most telemetry described in these docs, FxA metrics are logged server-side. There are many <a href="https://github.com/mozilla/fxa/tree/main/packages">FxA &quot;servers&quot;</a> that handle different aspects of account authentication and management. The metrics of most interest to data analysts are logged by the FxA auth server, content server and oauth server. Each server writes their metrics into their log stream, and some post-processing scripts combine the metrics events from all three servers into datasets that are available in Databricks, BigQuery, STMO and Amplitude.</p>
<p>In general, metrics logged by the <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-auth-server">FxA auth server</a> reflect authentication events such as account creation, logins to existing accounts, etc.
Metrics logged by the <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server">FxA content server</a> reflect user interaction and progression through the FxA web UI - form views, form engagement, form submission, etc.
The <a href="https://github.com/mozilla/fxa/pull/3176">FxA oauth server</a> logs metrics events when oauth clients (Monitor, Lockwise, etc) create and check authentication tokens.</p>
<h2><a class="header" href="#metrics-taxonomies" id="metrics-taxonomies">Metrics Taxonomies</a></h2>
<p>There are two overlapping taxonomies or sets of FxA event metrics.</p>
<p><a href="https://github.com/mozilla/fxa-auth-server/blob/master/docs/metrics-events.md"><strong>Flow Metrics</strong></a>: these are an older set of metrics events that can be queried through redshift and via the <code>FxA Activity Metrics</code> data source in STMO. The <a href="https://github.com/mozilla/fxa-activity-metrics/">STMO import jobs</a> are run once a day. See <a href="https://github.com/mozilla/fxa-auth-server/blob/master/docs/metrics-events.md">this documentation</a> for detailed description of the types of flow events that are logged and the tables that contain them (note this documentation does not contain an exhaustive list of all flow metrics but is generally still accurate about the ones that are described). Note there are 50% and 10% sampled versions of the major tables, which contain more historical data than their complete counterparts. Complete tables go back 3 months, 50% tables go back 6 months, and 10% tables go back 24 months. Sampling is done at the level of the FxA user id <code>uid</code> (i.e. integer(<code>uid</code>) % 100).</p>
<p><a href="https://analytics.amplitude.com/mozilla-corp/manage/project/178231/advanced/events"><strong>Amplitude Events</strong></a>: FxA started to send metrics events to amplitude circa October 2017. The <a href="https://github.com/mozilla/fxa-amplitude-send">code responsible for batching events to amplitude</a> over HTTP is run in more-or-less real-time. Amplitude events can be queried through the <a href="https://analytics.amplitude.com/mozilla-corp/space/vj9qof9">amplitude UI</a> as well as various views in <code>moz-fx-data-shared-prod.firefox_accounts</code> dataset in BigQuery that maintain copies of the events that are sent to Amplitude. <a href="https://github.com/mozilla/bigquery-etl/blob/master/sql/moz-fx-data-shared-prod/firefox_accounts/fxa_content_auth_events/view.sql"><code>moz-fx-data-shared-prod.firefox_accounts.fxa_content_auth_events</code></a> is probably the easiest BigQuery view to use, though it does not contain email bounce events and (at the time of writing) only contains data starting at 2019-03-01.</p>
<p>Note that the BigQuery <a href="https://github.com/mozilla/bigquery-etl/tree/master/sql">ETL jobs</a> run daily while real-time data is accessible through the amplitude UI.</p>
<p>FxA's amplitude metrics were originally just re-configured and re-named versions of the flow metrics. However things have since diverged a bit and there are now metrics events that only have an amplitude version but no corresponding flow event, and vice-versa. If you are wondering whether a certain event is logged its likely you will have to check both data sources.</p>
<p><strong>Generally speaking, one should first try to use the amplitude metrics rather than the flow events</strong> for these reasons:</p>
<ol>
<li>For quick answers to simple questions the amplitude UI is often more efficient than writing SQL.
<ul>
<li>The caveat here is that is can sometimes be <em>too</em> easy to build a chart in amplitude - it doesn't exactly encourage the careful consideration that having to write a query out by hand implicitly encourages.</li>
</ul>
</li>
<li>By-country data is currently not available in redshift.</li>
<li>There have been outages in the redshift data that have not affected the amplitude data.</li>
<li>Querying redshift is (generally) slower.</li>
</ol>
<p>It is also possible to query the FxA server logs directly through BigQuery (ask an FxA team member for access), though virtually all analytics-related questions are more easily answered using the data sources described above.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/fxa.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#attribution-of-firefox-accounts" id="attribution-of-firefox-accounts">Attribution of Firefox Accounts</a></h1>
<h2><a class="header" href="#table-of-contents-17" id="table-of-contents-17">Table of Contents</a></h2>
<ul>
<li><a href="datasets/fxa_metrics/attribution.html#introduction">Introduction</a></li>
<li><a href="datasets/fxa_metrics/attribution.html#types-of-attribution">Types of Attribution</a>
<ul>
<li><a href="datasets/fxa_metrics/attribution.html#service-attribution">Service Attribution</a></li>
<li><a href="datasets/fxa_metrics/attribution.html#funnel-attribution-entrypoint-and-utm-parameters">Funnel Attribution (entrypoint and utm parameters)</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#introduction-19" id="introduction-19">Introduction</a></h2>
<p>Users can create or login to an account through an increasingly large number of relying services and entrypoints. This article describes how we attribute authentications to their point of origin, and documents some of the most frequently trafficked entrypoints (it would not be feasible to list them all, but we will try to update this document when there are substantial changes).</p>
<h2><a class="header" href="#types-of-attribution" id="types-of-attribution">Types of Attribution</a></h2>
<p>We can attribute accounts to the <strong>service</strong> that they sign up for, as well as the <strong>entrypoint</strong> that they use to begin the authentication flow. Each service typically has many entrypoints; sync, for example, has web-based entrypoints and browser-based entrypoints (see below).</p>
<h3><a class="header" href="#service-attribution" id="service-attribution">Service Attribution</a></h3>
<p>There is a variable called <code>service</code> that we use to (1) attribute users to the relying services of FxA that they have authenticated with and (2) attribute individual events to the services they are associated with. <strong>Except in the case of sync</strong>, <code>service</code> is a mapping from the oauth <code>client_id</code> of the relying service/product to a human readable string. Note that this mapping is currently maintained by hand, and is done after the events have been logged by the server. Currently, mapping to the human-readable <code>service</code> variable is only done for amplitude metrics, where it is treated as a user property. There is also a <code>service</code> variable in the <code>activity_events</code> and <code>flow_metadata</code> STMO tables (FxA Activity Metrics data source), however it only contains the opaque oauth <code>client_id</code>, not the human-readable string. A table of some of the most common oauth <code>client_id</code>s along with their corresponding <code>service</code> mapping is shown below. This is not a complete list.</p>
<table><thead><tr><th><code>service</code></th><th>oauth <code>client_id</code></th><th>Description</th></tr></thead><tbody>
<tr><td><code>lockbox</code></td><td><code>e7ce535d93522896</code></td><td>Lockwise App for Android</td></tr>
<tr><td><code>lockbox</code></td><td><code>98adfa37698f255b</code></td><td>Lockwise App for iOS</td></tr>
<tr><td><code>fenix</code></td><td><code>a2270f727f45f648</code></td><td>Sync implementation for Fenix</td></tr>
<tr><td><code>fx-monitor</code></td><td><code>802d56ef2a9af9fa</code></td><td>Firefox Monitor (<a href="https://monitor.firefox.com">website</a>)</td></tr>
<tr><td><code>send</code></td><td><code>1f30e32975ae5112</code></td><td>Firefox Send (<a href="https://send.firefox.com/">website</a>)</td></tr>
<tr><td><code>send</code></td><td><code>20f7931c9054d833</code></td><td>Firefox Send (android app)</td></tr>
<tr><td><code>pocket-mobile</code></td><td><code>7377719276ad44ee</code></td><td>Pocket Mobile App</td></tr>
<tr><td><code>pocket-web</code></td><td><code>749818d3f2e7857f</code></td><td>Pocket Website</td></tr>
<tr><td><code>firefox-addons</code></td><td><code>3a1f53aabe17ba32</code></td><td><code>addons.mozilla.org</code></td></tr>
<tr><td><code>amo-web</code></td><td><code>a4907de5fa9d78fc</code></td><td><code>addons.mozilla.org</code> (still unsure how this differs from <code>firefox-addons</code>)</td></tr>
<tr><td><code>screenshots</code></td><td><code>5e75409a5a3f096d</code></td><td>Firefox Screenshots (<a href="https://screenshots.firefox.com/">website</a>, no longer supported)</td></tr>
<tr><td><code>notes</code></td><td><code>a3dbd8c5a6fd93e2</code></td><td>Firefox Notes (desktop extension)</td></tr>
<tr><td><code>notes</code></td><td><code>7f368c6886429f19</code></td><td>Firefox Notes (android app)</td></tr>
<tr><td><code>fxa-content</code></td><td><code>ea3ca969f8c6bb0d</code></td><td>Oauth ID used when a user is signing in with cached credentials (i.e. does not have to re-enter username/password) and when the user is logging into the FxA settings page.</td></tr>
<tr><td><code>mozilla-email-preferences</code></td><td><code>c40f32fd2938f0b6</code></td><td>Oauth ID used when a user is signing in to modify their marketing email preferences (e.g., to opt-out.)</td></tr>
</tbody></table>
<p>In amplitude, there is also a <code>fxa_services_used</code> user property which maintains an array of all the services a user has authenticated with.</p>
<p>Some amplitude charts segmenting by service can be found <a href="https://analytics.amplitude.com/mozilla-corp/notebook/detelo9">here</a>.</p>
<h3><a class="header" href="#funnel-attribution-entrypoint-and-utm-parameters" id="funnel-attribution-entrypoint-and-utm-parameters">Funnel Attribution (entrypoint and utm parameters)</a></h3>
<p>We can also attribute users to where they began the authentication process, be it from a website or an application. Attribution is done through query parameters appended to links that point at <code>accounts.firefox.com</code> (which hosts the actual authentication process). These parameters are logged along with with any metrics events that the user generates during the authentication flow. The table below lists the query parameters that are currently in use, along with the values associated with some of the most common funnels. Note that only <code>entrypoint</code> is typically logged for flows beginning within the browser. Web-based entrypoints are listed first, followed by entrypoints that are found within the browser chrome itself.</p>
<p>See the <a href="https://mozilla.github.io/ecosystem-platform/docs/relying-parties/metrics-for-relying-parties">Metrics for Relying Parties</a> documentation for more implementational detail on utm/entrypoint parameters.</p>
<table><thead><tr><th><code>entrypoint</code></th><th>utm parameters</th><th>Description &amp; Notes</th></tr></thead><tbody>
<tr><td><code>activity-stream-firstrun</code></td><td><strong><code>utm_source</code></strong> = <code>activity-stream</code>, <strong><code>utm_campaign</code></strong> = <code>firstrun</code>, <strong><code>utm_medium</code></strong> = <code>referral</code> or <code>email</code></td><td>The <a href="about:welcome">about:welcome</a> page that is shown to new profiles on browser <code>firstrun</code>. <code>utm_term</code> is sometimes used to track variations for experiments.</td></tr>
<tr><td><code>firstrun</code> (not supported for current versions)</td><td><strong><code>utm_source</code></strong> = <code>firstrun</code></td><td>This is the old version of the <code>firstrun</code> page that was hosted on the web as part of mozilla.org (<a href="https://www.mozilla.org/en-US/firefox/62.0/firstrun/">example</a>). Starting with Firefox version 62, it was replaced by an in-browser version (see row above). Although it is not used for newer versions, it is still hosted for the sake of e.g. profiles coming through the dark funnel on older versions.</td></tr>
<tr><td><code>mozilla.org-whatsnewXX</code></td><td><strong><code>utm_source</code></strong> = <code>whatsnewXX</code>, <strong><code>utm_campaign</code></strong> = <code>fxa-embedded-form</code>, <strong><code>utm_content</code></strong> = <code>whatsnew</code>, <strong><code>utm_medium</code></strong> = <code>referral</code> or <code>email</code></td><td>Where <code>XX</code> = the browser version, e.g. 67 (<a href="https://www.mozilla.org/en-US/firefox/67.0.1/whatsnew/">example</a>). The &quot;what's new&quot; page that is shown to users after they upgrade browser versions. Important notes: <strong>(1)</strong> Users who are signed into a Firefox account have a different experience than those that are signed out. Signed-in users typically see a promotion of FxA-relying services, while signed-out users see a Call to Action to create an account. <strong>(2)</strong> The attribution parameters for this page were standardized starting on version 66. <strong>Previous values for entrypoint</strong> include <code>whatsnew</code> and <code>mozilla.org-wnp64</code> - these values should be used when doing historical analysis of versions prior to 66.</td></tr>
<tr><td><code>new-install-page</code> (current), <code>firefox-new</code> (previously)</td><td>varies (can contain values passed through by referrals)</td><td><a href="https://www.mozilla.org/en-US/firefox/new/">example</a>. The &quot;install Firefox&quot; page. This page doesn't always promote FxA and it will often only promote it to a certain % of traffic or to certain segments.</td></tr>
<tr><td><code>fxa-discoverability-native</code></td><td>NA</td><td>The in-browser toolbar icon. This was introduced with version 67.0</td></tr>
<tr><td><code>menupanel</code></td><td>NA</td><td>The in-browser account item in the &quot;hamburger&quot; menu on desktop (three-line menu in the upper right corner) as well as the sync/FxA menu item on android and iOS.</td></tr>
<tr><td><code>preferences</code></td><td>NA</td><td>The &quot;sign into sync&quot; button found in the sync section in desktop preferences.</td></tr>
<tr><td><code>synced-tabs</code></td><td>NA</td><td>The &quot;sign into sync&quot; button found in synced-tabs section under the library menu.</td></tr>
<tr><td><code>sendtab</code></td><td>NA</td><td>The &quot;sign into sync&quot; button found in the &quot;send tab to device&quot; menu accessible by right-clicking on a tab.</td></tr>
<tr><td><code>lockbox-addon</code></td><td>NA</td><td>The &quot;sign into sync&quot; button found within the the Lockwise desktop extension. This is likely to change once Lockwise becomes fully integrated into the browser.</td></tr>
</tbody></table>
<p>Example amplitude charts: <a href="https://analytics.amplitude.com/mozilla-corp/chart/1ush8xd">registrations by <code>entrypoint</code></a>, <a href="https://analytics.amplitude.com/mozilla-corp/chart/y8t2k1z">logins by <code>entrypoint</code></a>, <a href="https://analytics.amplitude.com/mozilla-corp/chart/jjbkusl">registrations by <code>utm_source</code></a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/fxa_metrics/attribution.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#firefox-account-funnels" id="firefox-account-funnels">Firefox Account Funnels</a></h1>
<h2><a class="header" href="#table-of-contents-18" id="table-of-contents-18">Table of Contents</a></h2>
<ul>
<li><a href="datasets/fxa_metrics/funnels.html#introduction">Introduction</a></li>
<li><a href="datasets/fxa_metrics/funnels.html#registration-funnel">Registration Funnel</a></li>
<li><a href="datasets/fxa_metrics/funnels.html#login-funnel">Login Funnel</a></li>
<li><a href="datasets/fxa_metrics/funnels.html#branches-off-the-login-funnel-password-reset-account-recovery-2fa">Branches off the Login Funnel: Password Reset, Account Recovery, 2FA.</a>
<ul>
<li><a href="datasets/fxa_metrics/funnels.html#password-reset-and-recovery-codes">Password Reset and Recovery Codes</a>
<ul>
<li><a href="datasets/fxa_metrics/funnels.html#password-reset-funnel-without-recovery-key">Password Reset Funnel Without Recovery Key</a></li>
<li><a href="datasets/fxa_metrics/funnels.html#password-reset-funnel-with-recovery-key">Password Reset Funnel With Recovery Key</a></li>
</ul>
</li>
<li><a href="datasets/fxa_metrics/funnels.html#login-with-2fa-totp">Login with 2FA (TOTP)</a>
<ul>
<li><a href="datasets/fxa_metrics/funnels.html#login-with-2fatotp-funnel-no-recovery-code">Login with 2FA/TOTP Funnel (No Recovery Code)</a></li>
<li><a href="datasets/fxa_metrics/funnels.html#login-with-2fatotp-funnel-w-recovery-code">Login with 2FA/TOTP Funnel w/ Recovery Code</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="datasets/fxa_metrics/funnels.html#connect-another-device--sms">Connect Another Device / SMS</a>
<ul>
<li><a href="datasets/fxa_metrics/funnels.html#sms-funnel">SMS Funnel</a></li>
<li><a href="datasets/fxa_metrics/funnels.html#connect-another-device-funnel-non-sms">Connect Another Device Funnel (Non-SMS)</a></li>
</ul>
</li>
<li><a href="datasets/fxa_metrics/funnels.html#settings">Settings</a></li>
</ul>
<h2><a class="header" href="#introduction-20" id="introduction-20">Introduction</a></h2>
<p>There are two primary &quot;funnels&quot; that users step through when authenticating with FxA. The <strong>registration</strong> funnel reflects the steps required for a <strong>new</strong> FxA user (or more precisely, email address) to create an account. The <strong>login</strong> funnel reflects the steps necessary for an <strong>existing</strong> FxA user to sign into their account.</p>
<p>We are also in the process of developing funnels for paying subscribers. We will add documentation on that once the work is is closer to complete.</p>
<h2><a class="header" href="#registration-funnel" id="registration-funnel">Registration Funnel</a></h2>
<p>While there are some variations, the typical registration funnel is comprised of the steps described in the chart below. Except where noted, these events are emitted by the FxA content server.</p>
<table><thead><tr><th>Step</th><th>Amplitude Event</th><th>Flow Event</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td><code>fxa_email_first - view</code></td><td><code>flow.enter-email.view</code></td><td>View (impression) of the form that the user enters their email address into to start the process. Note that this form can be hosted by FxA, or hosted by the relying party. In the latter case, the relier is responsible for handing the user's email address off to the FxA funnel. See &quot;counting top of funnel events&quot; below.</td></tr>
<tr><td>2</td><td><code>fxa_reg - view</code></td><td><code>flow.signup.view</code></td><td>View of the registration form. If the user got to this step via step 1, FxA has detected that their email address is not present in the DB, and thus a new account can be created. The user creates their password and enters their age.</td></tr>
<tr><td>3</td><td><code>fxa_reg - engage</code></td><td><code>flow.signup.engage</code></td><td>A user focuses/clicks on one of the registration form fields.</td></tr>
<tr><td>4</td><td><code>fxa_reg - submit</code></td><td><code>flow.signup.submit</code></td><td>A user submits the registration form (could be unsuccessfully).</td></tr>
<tr><td>5</td><td><code>fxa_reg - created</code></td><td><code>account.created</code></td><td>This event is emitted by the auth server. It indicates that user has entered a valid email address and password, and that their account has been created and added to the DB. However, the account is still &quot;unverified&quot; at this point and therefore not accessible by the user.</td></tr>
<tr><td>6</td><td><code>fxa_email - sent</code> (<code>email_type</code> = <code>registration</code>)</td><td><code>email.verification.sent</code></td><td>An email is sent to the user to verify their new account. Depending on the service, it either contains a verification link or a verification code that the user enters into the registration form to verify their email address.</td></tr>
<tr><td>7</td><td><code>fxa_reg - cwts_view</code></td><td><code>flow.signup.choose-what-to-sync.view</code></td><td>User views the &quot;choose what to sync&quot; screen which allows the users to select what types of browser data they want to synchronize. <strong>Note that the user is not required to submit this page</strong> - if they do not take any action then all the data types will be synced by default. Thus you may not want to include this (and the following two events) in your funnel analysis if you do not care about the user's actions here.</td></tr>
<tr><td>8</td><td><code>fxa_reg - cwts_engage</code></td><td>Not Implemented</td><td>User clicks on the &quot;choose what to sync&quot; screen.</td></tr>
<tr><td>9</td><td><code>fxa_reg - cwts_submit</code></td><td>Not Implemented</td><td>User submits the &quot;choose what to sync&quot; screen. See also the amplitude user property <code>sync_engines</code> which stores which data types the user selected.</td></tr>
<tr><td>10</td><td><code>fxa_email - click</code></td><td><code>email.verify_code.clicked</code></td><td>A user has clicked on the verification link contained in the email sent in step 6. Note this only applies to cases where a clickable link is sent; for reliers that use activation codes, this event will not be emitted (so be aware of this when constructing your funnels).</td></tr>
<tr><td>11</td><td><code>fxa_reg - email_confirmed</code></td><td><code>account.verified</code></td><td>This event is emitted by the auth server. A user has successfully verified their account. They should now be able to use it.</td></tr>
<tr><td>12</td><td><code>fxa_reg - complete</code></td><td><code>flow.complete</code></td><td>The account registration process is complete. Note there are NO actions required of the user to advance from step 8 to step 9; there should be virtually no drop-off there. The flow event is identical for registration and login.</td></tr>
</tbody></table>
<p>See <a href="https://analytics.amplitude.com/mozilla-corp/chart/a9yjkzf">this chart</a> for an example of how this funnel can be constructed for the <code>firstrun</code> (about:welcome) page in amplitude. <a href="https://sql.telemetry.mozilla.org/queries/62595#160701">Here</a> is a version in STMO using the flow events.</p>
<p>The chart above provides the most detailed version of the registration funnel that can currently be constructed. However, it should not be considered the &quot;canonical&quot; version of the funnel - depending on the question it may make sense to omit some of the steps. For example, at the time of writing some browser entrypoints (e.g. <code>menupanel</code>) link directly to step 2 and skip the initial email form. Having both steps 7 and 8 may also be redundant in some cases, etc. Also, as noted above, you may want to omit the &quot;choose what to sync&quot; steps if you do not care about the users' actions there.</p>
<h2><a class="header" href="#login-funnel" id="login-funnel">Login Funnel</a></h2>
<p>The login funnel describes the steps required for an existing FxA user to login to their account. With some exceptions, most of the steps here are parallel to the registration funnel (but named differently).</p>
<p>Users must confirm their login via email in the following cases:</p>
<ol>
<li>A user is logging into sync with an account that is more than 4 hours old.</li>
<li>A user is logging into an oauth relier that uses encryption keys (e.g., Firefox send), if the user had not logged into their account in the previous 72? (check this) hours.</li>
</ol>
<table><thead><tr><th>Step</th><th>Amplitude Event</th><th>Flow Event</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td><code>fxa_email_first - view</code></td><td><code>flow.enter-email.view</code></td><td>Similar to the registration funnel, a view (impression) of the form that the user enters their email address into to start the process. Note that this form can be hosted by FxA, or hosted by the relying party. In the latter case, the relier is responsible for handing the user's email address off to the FxA funnel. See &quot;counting top of funnel events&quot; below.</td></tr>
<tr><td>2</td><td><code>fxa_login - view</code></td><td><code>flow.signin.view</code></td><td>View of the login form. If the user got to this step via step 1, FxA has detected that their email address IS present in the DB, and thus an existing account can be logged into. The user enters their password on this form.</td></tr>
<tr><td>3</td><td><code>fxa_login - engage</code></td><td><code>flow.signup.engage</code></td><td>A user focuses/clicks on the login form field</td></tr>
<tr><td>4</td><td><code>fxa_login - submit</code></td><td><code>flow.signup.submit</code></td><td>A user submits the login form (could be unsuccessfully).</td></tr>
<tr><td>5</td><td><code>fxa_login - success</code></td><td><code>account.login</code></td><td>This event is emitted by the auth server. It indicates that user has submitted the correct password. However, in some cases the user may still have to confirm their login via email (see above).</td></tr>
<tr><td>6</td><td><code>fxa_email - sent</code> (<code>email_type</code> = <code>login</code>)</td><td><code>email.confirmation.sent</code></td><td>An email is sent to the user to confirm the login. Depending on the service, it either contains a confirmation link or a verification code that the user enters into the login form.</td></tr>
<tr><td>7</td><td><code>fxa_email - click</code></td><td><code>email.verify_code.clicked</code></td><td>A user has clicked on the confirmation link contained in the email sent in step 6. Note this only applies to cases where a clickable link is sent; for reliers that use confirmation codes, this event will not be emitted (so be aware of this when constructing your funnels). Note that this event is identical to its counterpart in the registration funnel.</td></tr>
<tr><td>8</td><td><code>fxa_login - email_confirmed</code></td><td><code>account.confirmed</code></td><td>This event is emitted by the auth server. A user has successfully confirmed the login via email.</td></tr>
<tr><td>9</td><td><code>fxa_login - complete</code></td><td><code>flow.complete</code></td><td>The account registration process is complete. Note there are NO actions required of the user to advance from step 8 to step 9; there should be virtually no drop-off there. The flow event is identical for registration and login.</td></tr>
</tbody></table>
<p>See <a href="https://analytics.amplitude.com/mozilla-corp/chart/53dqtlo">this chart</a> for an example of how this funnel can be constructed for the <code>firstrun</code> (about:welcome) page. <a href="https://sql.telemetry.mozilla.org/queries/63048#161676">Here</a> is a version in STMO using the flow events.</p>
<p>Note again that you may want to check whether the service you are analyzing requires email confirmation on login.</p>
<h2><a class="header" href="#branches-off-the-login-funnel-password-reset-account-recovery-2fa" id="branches-off-the-login-funnel-password-reset-account-recovery-2fa">Branches off the Login Funnel: Password Reset, Account Recovery, 2FA.</a></h2>
<p>Some additional funnels are &quot;branches&quot; off the main login funnel above:</p>
<ol>
<li>The password reset funnel</li>
</ol>
<ul>
<li>Optionally - the user resets their password with a recovery key</li>
</ul>
<ol start="2">
<li>Login with 2FA (TOTP)</li>
</ol>
<ul>
<li>Optionally - user uses a 2FA recovery code to login to their 2FA-enabled account (e.g. if they misplace their second factor.)</li>
</ul>
<h3><a class="header" href="#password-reset-and-recovery-codes" id="password-reset-and-recovery-codes">Password Reset and Recovery Codes</a></h3>
<p>Users can click &quot;Forgot Password?&quot; during sign-in to begin the password reset process. The funnel is described in the chart below.</p>
<p><strong>An important &quot;FYI&quot; here</strong>: passwords are used to encrypt accounts' sync data. This implies a <strong>bad scenario</strong> where a change of password can lead to loss of sync data, if there are no longer any devices that can connect to the account and re-upload/restore the data after the reset occurs. This would happen, for example, if you only had one device connected to sync, lost the device, then tried to login to a new device to access your synced data. If you do a password reset while logging into the second device, the remote copy of your sync data will be overwritten (with whatever happens to be on the second device).</p>
<p>Thus the recovery codes. If a user (1) sets up recovery codes via settings (and stores them somewhere accessible) (2) tries to reset their password and (3) enters a valid recovery code during the password reset process, sync data can be restored without risking the &quot;bad scenario&quot; above.</p>
<h4><a class="header" href="#password-reset-funnel-without-recovery-key" id="password-reset-funnel-without-recovery-key">Password Reset Funnel Without Recovery Key</a></h4>
<p><em>Note: There may be other places where a user can initiate the password reset process, but I think that its most common during login. In any case, the steps starting at 2 should all be the same.</em></p>
<table><thead><tr><th>Step</th><th>Amplitude Event</th><th>Flow Event</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td><code>fxa_login - view</code></td><td><code>flow.signin.view</code></td><td>View of the login form, which contains the &quot;Forgot Password&quot; Link.</td></tr>
<tr><td>2</td><td><code>fxa_login - forgot_password</code></td><td><code>flow.signin.forgot-password</code></td><td>User clicks on the &quot;Forgot Password&quot; Link.</td></tr>
<tr><td>3</td><td>Not Implemented</td><td><code>flow.reset-password.view</code></td><td>View of the form asking the user to confirm that they want to reset.</td></tr>
<tr><td>4</td><td><code>fxa_login - forgot_submit</code></td><td><code>flow.reset-password.engage</code>, <code>flow.reset-password.submit</code></td><td>User clicks on the button confirming that they want to reset.</td></tr>
<tr><td>5</td><td><code>fxa_email - delivered</code> (<code>email_template</code> = <code>recoveryEmail</code>)</td><td><code>email.recoveryEmail.delivered</code></td><td>Delivery of the PW reset link to the user via email.</td></tr>
<tr><td>5-a</td><td>Not Implemented</td><td><code>flow.confirm-reset-password.view</code></td><td>View of the screen telling the user to confirm the reset via email.</td></tr>
<tr><td>6</td><td>Not Implemented</td><td><code>flow.complete-reset-password.view</code></td><td>User views the form to create a new password. (viewable after clicking the link in the email above)</td></tr>
<tr><td>7</td><td>Not Implemented</td><td><code>flow.complete-reset-password.engage</code></td><td>User clicks on the form to create a new password.</td></tr>
<tr><td>8</td><td>Not Implemented</td><td><code>flow.complete-reset-password.submit</code></td><td>User submits the form to create a new password.</td></tr>
<tr><td>9</td><td><code>fxa_login - forgot_complete</code></td><td><code>flow.complete</code> (the auth server also emits <code>account.reset</code>)</td><td>User has completed the password reset funnel.</td></tr>
</tbody></table>
<h4><a class="header" href="#password-reset-funnel-with-recovery-key" id="password-reset-funnel-with-recovery-key">Password Reset Funnel With Recovery Key</a></h4>
<p><em>Note we still need to implement amplitude events for the recovery code part of this funnel. The funnel is identical to the one above up until step 6.</em></p>
<table><thead><tr><th>Step</th><th>Amplitude Event</th><th>Flow Event</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td><code>fxa_login - view</code></td><td><code>flow.signin.view</code></td><td>View of the login form, which contains the &quot;Forgot Password&quot; Link.</td></tr>
<tr><td>2</td><td><code>fxa_login - forgot_password</code></td><td><code>flow.signin.forgot-password</code></td><td>User clicks on the &quot;Forgot Password&quot; Link.</td></tr>
<tr><td>3</td><td>Not Implemented</td><td><code>flow.reset-password.view</code></td><td>View of the form asking the user to confirm that they want to reset.</td></tr>
<tr><td>4</td><td><code>fxa_login - forgot_submit</code></td><td><code>flow.reset-password.engage</code>, <code>flow.reset-password.submit</code></td><td>User clicks on the button confirming that they want to reset.</td></tr>
<tr><td>5</td><td><code>fxa_email - delivered</code> (<code>email_template</code> = <code>recoveryEmail</code>)</td><td><code>email.recoveryEmail.delivered</code></td><td>Delivery of the PW reset link to the user via email.</td></tr>
<tr><td>5-a</td><td>Not Implemented</td><td><code>flow.confirm-reset-password.view</code></td><td>View of the screen telling the user to confirm the reset via email.</td></tr>
<tr><td>6</td><td>Not Implemented</td><td><code>flow.account-recovery-confirm-key.view</code></td><td>User views the form to enter their account recovery key. (viewable after clicking the link in the email above)</td></tr>
<tr><td>7</td><td>Not Implemented</td><td><code>flow.account-recovery-confirm-key.engage</code></td><td>User clicks on the form to enter their account recovery key.</td></tr>
<tr><td>8</td><td>Not Implemented</td><td><code>flow.account-recovery-confirm-key.submit</code></td><td>User submits the form to enter their account recovery key.</td></tr>
<tr><td>9</td><td>Not Implemented</td><td><code>flow.account-recovery-confirm-key.success</code> or <code>flow.account-recovery-confirm-key.invalidRecoveryKey</code></td><td>User submitted a valid (success) or invalid recovery key.</td></tr>
<tr><td>10</td><td>Not Implemented</td><td><code>flow.account-recovery-reset-password.view</code></td><td>User views the form to change their password after submitting a valid recovery key.</td></tr>
<tr><td>11</td><td>Not Implemented</td><td><code>flow.account-recovery-reset-password.view</code></td><td>User clicks on the form to change their password after submitting a valid recovery key.</td></tr>
<tr><td>12</td><td>Not Implemented</td><td><code>flow.account-recovery-reset-password.view</code></td><td>User submits the form to change their password after submitting a valid recovery key.</td></tr>
<tr><td>13</td><td><code>fxa_login - forgot_complete</code></td><td><code>flow.complete</code> (the auth server also emits <code>account.reset</code>)</td><td>User has completed the password reset funnel.</td></tr>
</tbody></table>
<h3><a class="header" href="#login-with-2fa-totp" id="login-with-2fa-totp">Login with 2FA (TOTP)</a></h3>
<p>Users can setup two factor authentication (2FA) on account login. 2FA is implemented via time-based one-time password (TOTP). If a user has set up 2FA (via settings), they will be required to enter a pass code generated by their second factor whenever they login to their account.</p>
<p>Users are also provisioned a set of recovery codes as part of the 2FA setup process. These are one-time use codes that can be used to login to an account if a user loses access to their second factor. <strong>Note that these 2FA recovery codes are different than the account recovery keys described above</strong>.</p>
<h4><a class="header" href="#login-with-2fatotp-funnel-no-recovery-code" id="login-with-2fatotp-funnel-no-recovery-code">Login with 2FA/TOTP Funnel (No Recovery Code)</a></h4>
<p><em>This funnel starts after the <code>fxa_login - success</code> / <code>account.login</code> step of the login funnel</em></p>
<table><thead><tr><th>Step</th><th>Amplitude Event</th><th>Flow Event</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td><code>fxa_login - totp_code_view</code></td><td><code>flow.signin-totp-code.view</code></td><td>View of the TOTP form.</td></tr>
<tr><td>2</td><td><code>fxa_login - totp_code_engage</code></td><td><code>flow.signin-totp-code.engage</code></td><td>Click on the TOTP form.</td></tr>
<tr><td>3</td><td><code>fxa_login - totp_code_submit</code></td><td><code>flow.signin-totp-code.submit</code></td><td>Submission of the TOTP form.</td></tr>
<tr><td>4</td><td><code>fxa_login - totp_code_success</code></td><td><code>flow.signin-totp-code.success</code></td><td>Successful submission of the TOTP form. Auth server also emits <code>totpToken.verified</code></td></tr>
</tbody></table>
<h4><a class="header" href="#login-with-2fatotp-funnel-w-recovery-code" id="login-with-2fatotp-funnel-w-recovery-code">Login with 2FA/TOTP Funnel w/ Recovery Code</a></h4>
<p><em>This funnel starts after user clicks to use a recovery code during the TOTP funnel.</em></p>
<table><thead><tr><th>Step</th><th>Amplitude Event</th><th>Flow Event</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td><code>fxa_login - totp_code_view</code></td><td><code>flow.signin-totp-code.view</code></td><td>View of the TOTP form.</td></tr>
<tr><td>2</td><td>Not Implemented</td><td><code>flow.sign_in_recovery_code.view</code></td><td>View of the TOTP recovery code form.</td></tr>
<tr><td>3</td><td>Not Implemented</td><td><code>recoveryCode.verified</code> (auth server)</td><td>User submitted a valid recovery code.</td></tr>
</tbody></table>
<h2><a class="header" href="#connect-another-device--sms" id="connect-another-device--sms">Connect Another Device / SMS</a></h2>
<p>Sync is most valuable to users who have multiple devices connected to their account. Thus after a user completes a sync login or registration funnel, they are shown the &quot;connect another device&quot; form. This Call to Action contains a form for a phone number, as well as links to the Google Play and Apple stores where users can download mobile versions of Firefox. If a user submits a valid phone number (associated with a country that our service supports), then we send them an SMS message with links to their mobile phone's app store.</p>
<p>At one point, at least for iOS, the SMS message contained a deep link that pre-filled the user's email address on the sign-in form once they installed the mobile browser. There is some uncertainty about whether this still works...</p>
<h3><a class="header" href="#sms-funnel" id="sms-funnel">SMS Funnel</a></h3>
<p><em>This funnel begins either (1) after a user has completed the login or registration funnel, or (2) if they click on &quot;connect another device&quot; from the FxA toolbar menu within the desktop browser (provided they are signed in). In the latter case the <code>signin</code> segment of the flow event will be omitted.</em></p>
<table><thead><tr><th>Step</th><th>Amplitude Event</th><th>Flow Event</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td><code>fxa_connect_device - view</code> (<code>connect_device_flow</code> = <code>sms</code>)</td><td><code>flow.signin.sms.view</code></td><td>User viewed the SMS form.</td></tr>
<tr><td>2</td><td><code>fxa_connect_device - engage</code> (<code>connect_device_flow</code> = <code>sms</code>)</td><td><code>flow.signin.sms.engage</code></td><td>User clicked somewhere on the SMS form.</td></tr>
<tr><td>3</td><td><code>fxa_connect_device - submit</code> (<code>connect_device_flow</code> = <code>sms</code>)</td><td><code>flow.signin.sms.submit</code></td><td>User submitted the SMS form.</td></tr>
<tr><td>4</td><td>Not Implemented</td><td><code>sms.region.{country_code}</code></td><td>An SMS was sent to a number with the two letter <code>country_code</code>.</td></tr>
<tr><td>5</td><td>Not Implemented</td><td><code>flow.sms.sent.view</code></td><td>User views the message confirming that the SMS has been sent.</td></tr>
</tbody></table>
<p>The SMS form also contains app store links. If they are clicked, flow events <code>flow.signin.sms.link.app-store.android</code> or <code>flow.signin.sms.link.app-store.ios</code> will be logged.</p>
<h3><a class="header" href="#connect-another-device-funnel-non-sms" id="connect-another-device-funnel-non-sms">Connect Another Device Funnel (Non-SMS)</a></h3>
<table><thead><tr><th>Step</th><th>Amplitude Event</th><th>Flow Event</th><th>Description</th></tr></thead><tbody>
<tr><td>1</td><td><code>fxa_connect_device - view</code> (<code>connect_device_flow</code> = <code>cad</code>)</td><td><code>flow.signin.connect-another-device.view</code></td><td>User viewed the CAD form.</td></tr>
<tr><td>2</td><td><code>fxa_connect_device - view</code> (<code>connect_device_flow</code> = <code>cad</code>)</td><td><code>flow.signin.connect-another-device.link.app-store.(android\|ios)</code></td><td>User clicked on either the android or iOS app store button. In amplitude, use the event property <code>connect_device_os</code> to disambiguate which link was clicked.</td></tr>
</tbody></table>
<h2><a class="header" href="#settings" id="settings">Settings</a></h2>
<p>A variety of metrics are logged that reflect user interaction with the settings page (https://accounts.firefox.com/settings). The chart below outlines some of these events (this may not be an exhaustive list).</p>
<table><thead><tr><th>Amplitude Event</th><th>Flow Event</th><th>Description</th></tr></thead><tbody>
<tr><td><code>fxa_pref - view</code></td><td><code>flow.settings.view</code></td><td>User viewed the settings page.</td></tr>
<tr><td><code>fxa_pref - engage</code></td><td><code>flow.settings.*.engage</code></td><td>User clicked somewhere on the settings page.</td></tr>
<tr><td><code>fxa_pref - two_step_authentication_view</code></td><td><code>flow.settings.two-step-authentication.view</code></td><td>User viewed 2FA settings.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.two-step-authentication.recovery-codes.view</code></td><td>User viewed their 2FA recovery codes. These are only viewable one time only, after a user sets up 2FA, or after they generate new codes.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.two-step-authentication.recovery-codes.print-option</code></td><td>User clicks to print their 2FA recovery codes.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.two-step-authentication.recovery-codes.download-option</code></td><td>User clicks to download their 2FA recovery codes.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.two-step-authentication.recovery-codes.copy-option</code></td><td>User clicks to copy their 2FA recovery codes to the clipboard (this is fired only when they click the copy button, not if they copy using e.g. a keyboard shortcut).</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.change-password.view</code></td><td>User viewed the form to change their password.</td></tr>
<tr><td><code>fxa_pref - password</code></td><td><code>settings.change-password.success</code></td><td>User changed their password via settings.</td></tr>
<tr><td><code>fxa_pref - newsletter</code> (see also user property <code>newsletter_state</code>)</td><td><code>settings.communication-preferences.(optIn\|optOut).success</code></td><td>User changed their newsletter email preferences.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.account_recovery.view</code></td><td>User viewed account recovery settings.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.account_recovery.engage</code></td><td>User clicked somewhere in account recovery settings.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.account-recovery.confirm-password.view</code></td><td>User viewed the password form prior to turning on account recovery. (user first has to verify their email address)</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.account-recovery.confirm-password.view</code></td><td>User clicked the password form prior to turning on account recovery.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.account-recovery.confirm-password.submit</code></td><td>User submitted the password form prior to turning on account recovery.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.account-recovery.confirm-password.success</code></td><td>User successfully submitted the password form prior to turning on account recovery.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.account-recovery.recovery-key.view</code></td><td>User viewed their recovery key. This is viewable one time only, after a user sets up account recovery, or after they generate a new key.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.account-recovery.recovery-key.print-option</code></td><td>User clicks to print their recovery key.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.account-recovery.recovery-key.download-option</code></td><td>User clicks to download their recovery key.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.account-recovery.recovery-key.copy-option</code></td><td>User clicks to copy their recovery key to the clipboard (this is fired only when they click the copy button, not if they copy using e.g. a keyboard shortcut).</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.account-recovery.refresh</code></td><td>User generated a new recovery key.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.clients.view</code></td><td>User viewed the list of clients (&quot;Devices &amp; Apps&quot;) connected to their account. AKA the device manager.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.clients.engage</code></td><td>User clicked somewhere the list of clients connected to their account.</td></tr>
<tr><td>Not Implemented</td><td><code>flow.settings.clients.disconnect.view</code></td><td>User viewed the dialog asking to confirm disconnection of a device.</td></tr>
</tbody></table>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/fxa_metrics/funnels.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#fxa-email-metrics" id="fxa-email-metrics">FxA Email Metrics</a></h1>
<h2><a class="header" href="#table-of-contents-19" id="table-of-contents-19">Table of Contents</a></h2>
<ul>
<li><a href="datasets/fxa_metrics/emails.html#introduction">Introduction</a></li>
<li><a href="datasets/fxa_metrics/emails.html#email-templates-and-email-types">Email Templates and Email Types</a></li>
</ul>
<h2><a class="header" href="#introduction-21" id="introduction-21">Introduction</a></h2>
<p>Users must provide an email address when they sign up for a Firefox Account. Emails are sent to users to confirm authentication, alert them to new sign-ins, and to complete password resets. Users can also opt-in to marketing emails, however metrics for those are not covered in this article.</p>
<p>Events that we track relating to email:</p>
<ol>
<li>When the email is sent.</li>
<li>If the email bounces.</li>
<li>If the email contains a verification/confirmation link, whether the user clicked on it.</li>
</ol>
<p>Metrics relating to emails also contain the following properties:</p>
<ol>
<li>The email service of the recipient</li>
<li>The <code>email_template</code> - the <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-auth-server/lib/senders/templates">template</a> of the email that was sent (we currently only track this for sending events, not click events). This is more specific than the</li>
<li><code>email_type</code>, which is broader grouping of many email templates into related categories, see chart below.</li>
</ol>
<h2><a class="header" href="#email-templates-and-email-types" id="email-templates-and-email-types">Email Templates and Email Types</a></h2>
<p>Only emails sent by the FxA auth server are represented in the table below. TBD on marketing emails.</p>
<table><thead><tr><th><code>email_template</code></th><th><code>email_type</code></th><th>Description &amp; Notes</th></tr></thead><tbody>
<tr><td><code>verifySyncEmail</code></td><td><code>registration</code></td><td>Sent to users setting up a new sync account. Contains a verification link (user must click it for their account to become functional).</td></tr>
<tr><td><code>verifyEmail</code></td><td><code>registration</code></td><td>Sent to users setting up a new NON-sync account. Contains a verification link (user must click it for their account to become functional).</td></tr>
<tr><td><code>postVerifyEmail</code></td><td><code>registration</code></td><td>Sent after users confirm their email. Contains instructions for how to connect another device to sync.</td></tr>
<tr><td><code>verifyTrailheadEmail</code></td><td><code>registration</code></td><td>Updated version of <code>verifySyncEmail</code> for the trailhead promotion.</td></tr>
<tr><td><code>postVerifyTrailheadEmail</code></td><td><code>registration</code></td><td>Updated version of <code>postVerifyEmail</code> for the trailhead promotion.</td></tr>
<tr><td><code>verificationReminderFirstEmail</code></td><td><code>registration</code></td><td>If a users does not verify their account within 24 hours, they receive this email with an additional verification link.</td></tr>
<tr><td><code>verificationReminderSecondEmail</code></td><td><code>registration</code></td><td>If a users does not verify their account within 48 hours, they receive this email with an additional verification link.</td></tr>
<tr><td><code>verifyLoginEmail</code></td><td><code>login</code></td><td>Sent to existing accounts when they try to login to sync. User must click the verification link before the logged-in device can begin syncing.</td></tr>
<tr><td><code>newDeviceLoginEmail</code></td><td><code>login</code></td><td>Sent to existing accounts after they have logged into a device that FxA has not previously recognized.</td></tr>
<tr><td><code>verifyLoginCodeEmail</code></td><td><code>login</code></td><td>Sent to existing accounts when they try to login to sync, containing a code (rather than a link) the user must enter into the login form. Note that currently the use of confirmation codes is limited to some login contexts only - they are never used for registration.</td></tr>
<tr><td><code>recoveryEmail</code></td><td><code>reset_password</code></td><td>After a user opts to reset their password (during login, because they clicked &quot;forgot password&quot;), they receive this email with a link to reset their password (without using a recovery key).</td></tr>
<tr><td><code>passwordResetEmail</code></td><td><code>reset_password</code></td><td>Sent to users after they reset their password (without using a recovery key).</td></tr>
<tr><td><code>postAddAccountRecoveryEmail</code></td><td><code>account_recovery</code></td><td>Sent to users after they successfully add account recovery capabilities to their account (i.e. after generating recovery codes).</td></tr>
<tr><td><code>postRemoveAccountRecoveryEmail</code></td><td><code>account_recovery</code></td><td>Sent to users after they successfully REMOVE account recovery capabilities from their account.</td></tr>
<tr><td><code>passwordResetAccountRecoveryEmail</code></td><td><code>account_recovery</code></td><td>After a user resets their password using a recovery key, they receive this email telling them to generate a new recovery key.</td></tr>
<tr><td><code>passwordChangedEmail</code></td><td><code>change_password</code></td><td>Sent to users after they change their password via FxA settings (NOT during password reset; they must be logged in to do this).</td></tr>
<tr><td><code>verifyPrimaryEmail</code></td><td><code>verify</code></td><td>Sent to users when they request to change their primary email address via settings (is sent to their new email).</td></tr>
<tr><td><code>postChangePrimaryEmail</code></td><td><code>change_email</code></td><td>Sent to users after they successfully change their primary email address (is sent to their new email).</td></tr>
<tr><td><code>verifySecondaryEmail</code></td><td><code>secondary_email</code></td><td>Sent to users when they add a secondary email address via account settings. Contains a verification link (sent to the secondary email address).</td></tr>
<tr><td><code>postVerifySecondaryEmail</code></td><td><code>secondary_email</code></td><td>Sent to users after they successfully verified a secondary email address (sent to the secondary email address).</td></tr>
<tr><td><code>postRemoveSecondaryEmail</code></td><td><code>secondary_email</code></td><td>Sent to users after they successfully remove a secondary email address (sent to the secondary email address).</td></tr>
<tr><td><code>postAddTwoStepAuthenticationEmail</code></td><td><code>2fa</code></td><td>Sent to users after they successfully add 2 factor authentication to their account (TOTP)</td></tr>
<tr><td><code>postRemoveTwoStepAuthenticationEmail</code></td><td><code>2fa</code></td><td>Sent to users after they successfully REMOVE 2 factor authentication from their account (TOTP)</td></tr>
<tr><td><code>postConsumeRecoveryCodeEmail</code></td><td><code>2fa</code></td><td>Sent to users after they successfully use a recovery code to login to their account after not being able to use their second factor.</td></tr>
<tr><td><code>postNewRecoveryCodesEmail</code></td><td><code>2fa</code></td><td>Sent to users after they successfully generate a new set of 2FA recovery codes.</td></tr>
<tr><td><code>lowRecoveryCodesEmail</code></td><td><code>2fa</code></td><td>Sent when a user is running low on 2FA recovery codes.</td></tr>
</tbody></table>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/fxa_metrics/emails.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#static-datasets" id="static-datasets">Static Datasets</a></h1>
<p>Tables containing static data exist in the <code>static</code> dataset in BigQuery.
These tables are generated from CSV files named <code>data.csv</code> in subdirectories of the <code>sql/&lt;project&gt;/static/</code>
directory in <a href="https://github.com/mozilla/bigquery-etl/tree/master/sql/moz-fx-data-shared-prod/static"><code>bigquery-etl</code></a>.</p>
<h2><a class="header" href="#creating-a-static-table" id="creating-a-static-table">Creating a Static Table</a></h2>
<p>To create a new table, create a directory in <code>sql/&lt;project&gt;/static/</code>.
This directory should be named whatever you wish the table to be named.
Then, put a CSV file named <code>data.csv</code> in the directory.
It is expected that the first line of <code>data.csv</code> is a header row containing the column
names of the data.</p>
<p>e.g. In <code>sql/moz-fx-data-shared-prod/static/new_table/data.csv</code>:</p>
<pre><code>id,val
a,1
b,2
c,3
</code></pre>
<p>An optional <code>description.txt</code> and <code>schema.json</code> can be added. <code>description.txt</code> will fill the description
field in BigQuery. <code>schema.json</code> will set the schema of the table; if no schema is provided, it is assumed
that all fields are nullable strings.</p>
<p>See <a href="https://github.com/mozilla/bigquery-etl/tree/master/sql/moz-fx-data-shared-prod/static/country_names_v1"><code>country_names_v1</code></a> for an example.</p>
<p>To create the table in BigQuery, run <a href="https://github.com/mozilla/bigquery-etl/blob/master/script/publish_static"><code>script/publish_static</code></a>.</p>
<h3><a class="header" href="#notes-1" id="notes-1">Notes</a></h3>
<p>Static tables can be created in any dataset in bigquery-etl. However, it is recommended for consistency and
organization to keep them in the <code>static</code> dataset.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/static.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#normalized-os" id="normalized-os">Normalized OS</a></h1>
<p>The OS names and versions received in telemetry is not necessarily the accepted common name.
The <code>normalized_os_name</code> and <code>normalized_os_version</code> tables in the <code>static</code> dataset serve as a
lookup table for mapping the telemetry name to the common name.</p>
<h3><a class="header" href="#os-names" id="os-names">OS Names</a></h3>
<p>For OS names, Mac clients send <code>Darwin</code>, Windows clients send <code>Windows_NT</code>, and Linux may send the
distribution name.
Pings should already have a <code>normalized_os</code> field that corrects this.
The <code>normalized_os_name</code> table exists as an alternative lookup table.</p>
<p>Example query:</p>
<pre><code class="language-sql">SELECT
  client_id,
  environment.system.os.name,
  normalized_os_name
FROM
  telemetry_stable.main_v4
LEFT JOIN
  static.normalized_os_name
ON
  (environment.system.os.name = os_name)
</code></pre>
<h3><a class="header" href="#os-versions" id="os-versions">OS Versions</a></h3>
<p>OS versions for some OS's are not properly normalized in telemetry. For example, the version
reported by Mac clients is the Darwin version instead of the MacOS version and the version
reported by Android Fennec clients is the Android SDK version instead of the Android version.
The <code>normalized_os_version</code> table can be used to map the sent version to the &quot;display version&quot;
of the OS.</p>
<p>The table uses a regular expression to look up the OS version so <code>REGEXP_CONTAINS</code> should be used.
An example query can be found here: <a href="https://sql.telemetry.mozilla.org/queries/67040/source">https://sql.telemetry.mozilla.org/queries/67040/source</a></p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/static/normalized_os.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#historical-reference" id="historical-reference">Historical Reference</a></h1>
<p>This section contains some documentation of things that used to be part of the Mozilla Data Platform, but are no
longer. You can generally safely ignore this section, it is intended only to answer questions like &quot;what happened to X?&quot;.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/historical/index.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#an-overview-of-mozillas-data-pipeline-1" id="an-overview-of-mozillas-data-pipeline-1">An overview of Mozilla’s Data Pipeline</a></h1>
<blockquote>
<p>Note: This article describes the AWS-based pipeline which
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1598815">has been retired</a>;
the client-side concepts here still apply, but this article has been updated
to reflect the <a href="concepts/pipeline/gcp_data_pipeline.html">new GCP pipeline</a>.</p>
</blockquote>
<p>This post describes the architecture of Mozilla’s data pipeline, which is used to collect Telemetry data from our users and logs from various services. One of the cool perks of working at Mozilla is that most of what we do is out in the open and because of that I can do more than just show you some diagram with arrows of our architecture; I can point you to the code, script &amp; configuration that underlies it!</p>
<p>To make the examples concrete, the following description is centered around the collection of Firefox Telemetry data. The same tool-chain is used to collect, store and analyze data coming from disparate sources though, such as service logs.</p>
<pre class="mermaid">graph TD
  firefox((fa:fa-firefox Firefox))--&gt;|JSON| elb
  elb[Load Balancer]--&gt;|JSON| nginx
  nginx--&gt;|JSON| landfill(fa:fa-database S3 Landfill)
  nginx--&gt;|protobuf| kafka[fa:fa-files-o Kafka]
  kafka--&gt;|protobuf| cep(Hindsight CEP)
  kafka--&gt;|protobuf| dwl(Hindsight DWL)
  cep--&gt; hsui(Hindsight UI)
  dwl--&gt;|protobuf| datalake(fa:fa-database S3 Data Lake)
  dwl--&gt;|parquet| datalake
  datalake--&gt;|parquet| prestodb
  prestodb--&gt;redash[fa:fa-line-chart Redash]
  datalake--&gt;spark
  spark--&gt;datalake
  airflow[fa:fa-clock-o Airflow]--&gt;|Scheduled tasks|spark{fa:fa-star Spark}
  spark--&gt;|aggregations|rdbms(fa:fa-database PostgreSQL)
  rdbms--&gt;tmo[fa:fa-bar-chart TMO]
  rdbms--&gt;cerberus[fa:fa-search-plus Cerberus]


style firefox fill:#f61
style elb fill:#777
style nginx fill:green
style landfill fill:tomato
style datalake fill:tomato
style kafka fill:#aaa
style cep fill:palegoldenrod
style dwl fill:palegoldenrod
style hsui fill:palegoldenrod
style prestodb fill:cornflowerblue
style redash fill:salmon
style spark fill:darkorange
style airflow fill:lawngreen
style rdbms fill:cornflowerblue
style tmo fill:lightgrey
style cerberus fill:royalblue
</pre>
<h1><a class="header" href="#firefox-1" id="firefox-1">Firefox</a></h1>
<p>There are different APIs and formats to <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/index.html">collect data</a> in Firefox, all suiting different use cases:</p>
<ul>
<li><a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/histograms.html">histograms</a> – for recording multiple data points;</li>
<li><a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/scalars.html">scalars</a> – for recording single values;</li>
<li><a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/measuring-time.html">timings</a> – for measuring how long operations take;</li>
<li><a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/events.html">events</a> – for recording time-stamped events.</li>
</ul>
<p>These are commonly referred to as <em><a href="concepts/pipeline/../../datasets/new_data.html">probes</a></em>. Each probe must declare the <a href="https://wiki.mozilla.org/Firefox/Data_Collection">collection policy</a> it conforms to: either <em>release</em> or <em>prerelease</em>. When adding a new measurement data-reviewers carefully inspect the probe and eventually approve the requested collection policy:</p>
<ul>
<li>Release data is collected from all Firefox users.</li>
<li>Prerelease data is collected from users on Firefox Nightly and Beta channels.</li>
</ul>
<p>Users may choose to turn the data collection off in preferences.</p>
<p>A <em>session</em> begins when Firefox starts up and ends when it shuts down. As a session could be long-running and last weeks, it gets sliced into smaller logical units called <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/concepts/sessions.html#subsessions">subsessions</a>. Each subsession generates a batch of data containing the current state of all probes collected so far, i.e. a <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/main-ping.html">main ping</a>, which is sent to our servers. The main ping is just one of the many <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/concepts/pings.html#ping-types">ping types</a> we support. Developers can <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/custom-pings.html">create their own ping types</a> if needed.</p>
<p><em>Pings</em> are submitted via an <a href="https://searchfox.org/mozilla-central/rev/501eb4718d73870892d28f31a99b46f4783efaa0/toolkit/components/telemetry/app/TelemetryController.jsm#231">API</a> that performs a HTTP POST request to our edge servers. If a ping fails to successfully <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/concepts/submission.html#submission">submit</a> (e.g. because of missing internet connection), Firefox will store the ping on disk and retry to send it until the maximum ping age is exceeded.</p>
<h1><a class="header" href="#kafka" id="kafka">Kafka</a></h1>
<p>HTTP submissions coming in from the wild hit a <a href="https://aws.amazon.com/elasticloadbalancing/">load balancer</a> and then an NGINX <a href="https://github.com/mozilla-services/nginx_moz_ingest">module</a>. The <a href="https://github.com/mozilla-services/nginx_moz_ingest">module</a> accepts data via a <a href="https://wiki.mozilla.org/CloudServices/DataPipeline/HTTPEdgeServerSpecification">HTTP request</a> which it wraps in a Hindsight protobuf message and forwards to two places: a Kafka cluster and a short-lived S3 bucket (landfill) which acts as a fail-safe in case there is a processing error and/or data loss within the rest of the pipeline. The deployment scripts and configuration files of NGINX and Kafka live in a <a href="https://github.com/mozilla-services/puppet-config/tree/02f716a3e0df1117fc2494b41e85a1416f8e2a64/pipeline">private repository</a>.</p>
<p>The data from Kafka is read from the Complex Event Processors (CEP) and the Data Warehouse Loader (DWL), both of which use Hindsight.</p>
<h1><a class="header" href="#hindsight" id="hindsight">Hindsight</a></h1>
<p><a href="https://github.com/mozilla-services/hindsight">Hindsight</a>, an open source stream processing software system developed by Mozilla as <a href="https://github.com/mozilla-services/heka">Heka</a>’s successor, is useful for a wide variety of different tasks, such as:</p>
<ul>
<li>converting data from one format to another;</li>
<li>shipping data from one location to another;</li>
<li>performing real time analysis, graphing, and anomaly detection.</li>
</ul>
<p>Hindsight’s core is a lightweight data processing kernel written in C that controls a set of Lua <a href="https://github.com/mozilla-services/hindsight/blob/9593668e84a642aff9dd95ccc648b6585948abfe/docs/index.md">plugins</a> executed inside a sandbox.</p>
<p>The CEP are custom plugins that are created, configured and deployed from an <a href="https://github.com/mozilla-services/hindsight_admin">UI</a> which produce real-time plots like the number of pings matching a certain criteria. Mozilla employees can <a href="concepts/pipeline/BROKEN:https://pipeline-cep.prod.mozaws.net/">access the UI</a> and create/deploy their own custom plugin in real-time without interfering with other plugins running.</p>
<p><img src="concepts/pipeline/../../assets/CEP_custom_plugin.jpeg" alt="CEP Custom Plugin" title="CEP – a custom plugin in action" /></p>
<p>The DWL is composed of a set of plugins that transform, convert &amp; finally shovel pings into S3 for long term storage. In the specific case of Telemetry data, an input plugin <a href="https://github.com/mozilla-services/lua_sandbox_extensions/blob/0895238e32d25241ef46f561e43039beb201c7cd/kafka/sandboxes/heka/input/kafka.lua">reads pings from Kafka</a>, <a href="https://github.com/mozilla-services/lua_sandbox_extensions/blob/5d8907ee9f1a20e3a02bfe5b57d4312b173487a3/moz_telemetry/io_modules/decoders/moz_telemetry/ping.lua">pre-processes</a> them and <a href="https://github.com/mozilla-services/lua_sandbox_extensions/blob/5d8907ee9f1a20e3a02bfe5b57d4312b173487a3/moz_telemetry/sandboxes/heka/output/moz_telemetry_s3.lua">sends batches to S3</a>, our data lake, for long term storage. The data is compressed and partitioned by a set of dimensions, like date and application.</p>
<p>The data has traditionally been serialized to <a href="https://hekad.readthedocs.io/en/latest/message/index.html#stream-framing">Protobuf</a> sequence files which contain some nasty “free-form” JSON fields. Hindsight gained recently the ability to <a href="https://github.com/mozilla-services/lua_sandbox_extensions/pull/48">dump data directly in Parquet form</a> though.</p>
<p>The deployment scripts and configuration files of the CEP &amp; DWL live in a <a href="https://github.com/mozilla-services/puppet-config/tree/02f716a3e0df1117fc2494b41e85a1416f8e2a64/pipeline">private repository</a>.</p>
<h1><a class="header" href="#spark-2" id="spark-2">Spark</a></h1>
<p>Once the data reaches our data lake on S3 it can be processed with Spark on Mozilla's Databricks instance. Databricks allows Mozilla employees to write custom analyses in notebooks, and also schedule Databricks jobs to run periodically.</p>
<p>As mentioned earlier, most of our data lake contains data serialized to Protobuf with free-form JSON fields. Needless to say, parsing JSON is terribly slow when ingesting Terabytes of data per day. A set of <a href="https://github.com/mozilla/telemetry-batch-view">ETL jobs</a>, written in Scala by Data Engineers and scheduled with <a href="https://github.com/mozilla/telemetry-airflow/">Airflow</a>, create <a href="concepts/pipeline/../choosing_a_dataset.html">Parquet views</a> of our raw data. We have a Github repository <a href="https://github.com/mozilla/telemetry-batch-view/">telemetry-batch-view</a> that showcases this.</p>
<h1><a class="header" href="#aggregates-dataset" id="aggregates-dataset">Aggregates Dataset</a></h1>
<pre class="mermaid">graph TD
%% Data Flow Diagram for mozaggregator/TMO-adjacent services
firefox((fa:fa-firefox Firefox)) --&gt; |main ping| pipeline
fennec((fa:fa-firefox Fennec)) --&gt; |saved-session ping| pipeline
pipeline((Telemetry Pipeline))

subgraph mozaggregator
  service(service)
  aggregator
  rdbms(fa:fa-database PostgreSQL)
end

pipeline --&gt; aggregator
pipeline --&gt; spark{fa:fa-star Spark}
pipeline --&gt; redash[fa:fa-line-chart Redash]

subgraph telemetry.mozilla.org
  telemetry.js(telemetry.js) --&gt; dist
  telemetry.js --&gt; evo
  orphan[Update Orphaning]
  crashdash[tmo/crashes]
end

redash --&gt; crashdash
service --&gt; telemetry.js
spark --&gt; orphan

telemetry.js --&gt; telemetry-next-node(telemetry-next-node)
subgraph alerts.tmo
  cerberus[fa:fa-search-plus Cerberus] --&gt;medusa
  medusa --&gt; html
  medusa --&gt; email
end

telemetry-next-node --&gt; cerberus

style redash fill:salmon
style spark fill:darkorange
style rdbms fill:cornflowerblue
style cerberus fill:royalblue
style firefox fill:#f61
style fennec fill:#f61
style telemetry.js fill:lightgrey
style dist fill:lightgrey
style evo fill:lightgrey
</pre>
<p>A dedicated Spark job feeds daily aggregates to a PostgreSQL database which powers a <a href="https://github.com/mozilla/python_mozaggregator/#api">HTTP service</a> to easily retrieve faceted roll-ups. The service is mainly used by <a href="https://telemetry.mozilla.org/">TMO</a>, a dashboard that visualizes distributions and time-series, and <a href="https://github.com/mozilla/cerberus/">Cerberus</a>, an anomaly detection tool that detects and alerts developers of changes in the distributions. Originally the sole purpose of the Telemetry pipeline was to feed data into this dashboard but in time its scope and flexibility grew to support more general use-cases.</p>
<p><img src="concepts/pipeline/../../assets/TMO_example.jpeg" alt="TMO" title="TMO – timeseries" /></p>
<h1><a class="header" href="#presto--stmo" id="presto--stmo">Presto &amp; STMO</a></h1>
<p>We maintain a couple of <a href="https://github.com/mozilla/emr-bootstrap-presto">Presto clusters</a> and a centralized Hive metastore to query Parquet data with SQL. The Hive metastore provides an universal view of our Parquet dataset to both Spark and Presto clusters.</p>
<p>Presto, and other databases, are behind a <a href="https://redash.io/">Redash</a> service (<a href="https://sql.telemetry.mozilla.org/">STMO</a>) which provides a convenient &amp; powerful interface to query SQL engines and build dashboards that can be shared within the company. Mozilla maintains its own <a href="https://github.com/mozilla/redash">fork of Redash</a> to iterate quickly on new features, but as good open source citizen we push our changes upstream.</p>
<p><img src="concepts/pipeline/../../assets/STMO_example.jpeg" alt="STMO" title="STMO – who doesn’t love SQL?" /></p>
<h1><a class="header" href="#is-that-it" id="is-that-it">Is that it?</a></h1>
<p>No, not really. If you want to read more, check out <a href="concepts/pipeline/data_pipeline_detail.html">this article</a>. For example, the DWL pushes some of the Telemetry data to Redshift and other tools that satisfy more niche needs. The pipeline ingests logs from services as well and there are many specialized dashboards out there I haven’t mentioned.</p>
<p>There is a vast ecosystem of tools for processing data at scale, each with their pros &amp; cons. The pipeline grew organically and we added new tools as new use-cases came up that we couldn’t solve with our existing stack. There are still scars left from that growth though which require some effort to get rid of, like ingesting data from schema-less format.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/pipeline/data_pipeline.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#a-detailed-look-at-the-data-platform" id="a-detailed-look-at-the-data-platform">A Detailed Look at the Data Platform</a></h1>
<p>For a more gentle introduction to the data platform, please read the <a href="concepts/pipeline/data_pipeline.html">Pipeline Overview</a> article.</p>
<p>This article goes into more depth about the architecture and flow of data in the platform.</p>
<h2><a class="header" href="#the-entire-platform" id="the-entire-platform">The Entire Platform</a></h2>
<p>The full detail of the platform can get quite complex, but at a high level the structure is fairly simple.</p>
<pre class="mermaid">graph LR
  Producers[Data Producers] --&gt; Ingestion
  Ingestion --&gt; Storage[Long-term Storage]
  Ingestion --&gt; Stream[Stream Processing]
  Stream --&gt; Storage
  Batch[Batch Processing] --&gt; Storage
  Storage --&gt; Batch
  Self[Self Serve] -.- Stream
  Self -.- Batch
  Stream -.-&gt; Visualization
  Batch -.-&gt; Visualization
  Stream --&gt; Export
  Batch --&gt; Export
</pre>
<p>Each of these high-level parts of the platform are described in more detail below.</p>
<h2><a class="header" href="#data-producers" id="data-producers">Data Producers</a></h2>
<p>By far most data handled by the Data Platform is <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/main-ping.html">produced by Firefox</a>. There are other producers, though, and the eventual aim is to generalize data production using a client SDK or set of standard tools.</p>
<p>Most data is submitted via HTTP POST, but data is also produced in the form of service logs and <code>statsd</code> messages.</p>
<p>If you would like to locally test a new data producer, the <a href="https://github.com/mozilla/gzipServer"><code>gzipServer</code></a> project provides a simplified server that makes it easy to inspect submitted messages.</p>
<h2><a class="header" href="#ingestion-2" id="ingestion-2">Ingestion</a></h2>
<pre class="mermaid">graph LR
  subgraph HTTP
    tee
    lb[Load Balancer]
    mozingest
  end
  subgraph Kafka
    kafka_unvalidated[Kafka unvalidated]
    kafka_validated[Kafka validated]
    zookeeper[ZooKeeper] -.- kafka_unvalidated
    zookeeper -.- kafka_validated
  end
  subgraph Storage
    s3_heka[S3 Heka Protobuf Storage]
    s3_parquet[S3 Parquet Storage]
  end
  subgraph Data Producers
    Firefox --&gt; lb
    more_producers[Other Producers] --&gt; lb
  end

  lb --&gt; tee
  tee --&gt; mozingest
  mozingest --&gt; kafka_unvalidated
  mozingest --&gt; Landfill
  kafka_unvalidated --&gt; dwl[Data Store Loader]
  kafka_validated --&gt; cep[Hindsight CEP]
  kafka_validated --&gt; sparkstreaming[Spark Streaming]
  Schemas -.-&gt;|validation| dwl
  dwl --&gt; kafka_validated
  dwl --&gt; s3_heka
  dwl --&gt; s3_parquet
  sparkstreaming --&gt; s3_parquet
</pre>
<p>Data arrives as an HTTP POST of an optionally gzipped payload of JSON. See the common <a href="concepts/pipeline/http_edge_spec.html">Edge Server</a> specification for details.</p>
<p>Submissions hit a load balancer which handles the SSL connection, then forwards to a &quot;tee&quot; server, which may direct some or all submissions to alternate backends. In the past, the tee was used to manage the <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1302265">cutover between different versions of the backend</a> infrastructure. It is implemented as an <a href="http://openresty.org/en/"><code>OpenResty</code></a> plugin.</p>
<p>From there, the <a href="https://github.com/mozilla-services/nginx_moz_ingest"><code>mozingest</code></a> HTTP Server receives submissions from the tee and batches and stores data durably on Amazon S3 as a fail-safe (we call this &quot;Landfill&quot;). Data is then passed along via <a href="https://kafka.apache.org/">Kafka</a> for validation and further processing. If there is a problem with decoding, validation, or any of the code described in the rest of this section, data can be re-processed from this fail-safe store. The <code>mozingest</code> server is implemented as an <code>nginx</code> module.</p>
<p>Validation, at a minimum, ensures that a payload is valid JSON (possibly compressed). Many document types also have a <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas">JSONSchema specification</a>, and are further validated against that.</p>
<p>Invalid messages are redirected to a separate &quot;errors&quot; stream for debugging and inspection.</p>
<p>Valid messages proceed for further decoding and processing. This involves things like doing GeoIP lookup and discarding the IP address, and attaching some HTTP header info as annotated metadata.</p>
<p>Validated and annotated messages become available for stream processing.</p>
<p>They are also batched and stored durably for later batch processing and ad-hoc querying.</p>
<p>See also the &quot;<a href="https://docs.google.com/document/d/1PqiF1rF2fCk_kQuGSwGwildDf4Crg9MJTY44E6N5DSk/edit">generic ingestion</a>&quot; proposal which aims to make ingestion, validation, storage, and querying available as self-serve for platform users.</p>
<h5><a class="header" href="#data-flow-for-valid-submissions" id="data-flow-for-valid-submissions">Data flow for valid submissions</a></h5>
<pre class="mermaid">sequenceDiagram
    participant Fx as Firefox
    participant lb as Load Balancer
    participant mi as mozingest
    participant lf as Landfill
    participant k as Kafka
    participant dwl as Data Store Loader
    participant dl as Data Lake

    Fx-&gt;&gt;lb: HTTPS POST
    lb-&gt;&gt;mi: forward
    mi--&gt;&gt;lf: failsafe store
    mi-&gt;&gt;k: enqueue
    k-&gt;&gt;dwl: validate, decode
    dwl-&gt;&gt;k: enqueue validated
    dwl-&gt;&gt;dl: store durably
</pre>
<h5><a class="header" href="#other-ingestion-methods" id="other-ingestion-methods">Other ingestion methods</a></h5>
<p>Hindsight is used for <a href="https://mozilla-services.github.io/lua_sandbox_extensions/moz_logging/">ingestion of logs</a> from applications and services, it supports parsing of log lines and appending similar metadata as the HTTP ingestion above (timestamp, source, and so on).</p>
<p><a href="https://github.com/etsy/statsd"><code>Statsd</code></a> messages are ingested in the usual way.</p>
<h2><a class="header" href="#storage" id="storage">Storage</a></h2>
<pre class="mermaid">graph TD
  subgraph RDBMS
    PostgreSQL
    Redshift
    MySQL
    BigQuery
  end
  subgraph NoSQL
    DynamoDB
  end
  subgraph S3
    landfill[Landfill]
    s3_heka[Heka Data Lake]
    s3_parquet[Parquet Data Lake]
    s3_analysis[Analysis Outputs]
    s3_public[Public Outputs]
  end

  Ingestion --&gt; s3_heka
  Ingestion --&gt; s3_parquet
  Ingestion --&gt; landfill
  Ingestion -.-&gt; stream[Stream Processing]
  stream --&gt; s3_parquet
  batch[Batch Processing] --&gt; s3_parquet
  batch --&gt; PostgreSQL
  batch --&gt; DynamoDB
  batch --&gt; s3_public
  selfserve[Self Serve] --&gt; s3_analysis
  s3_analysis --&gt; selfserve
  Hive --&gt;|Presto| STMO[STMO]
  PostgreSQL --&gt; STMO
  Redshift --&gt; STMO
  MySQL --&gt; STMO
  BigQuery --&gt; STMO

  s3_parquet -.- Hive
</pre>
<p><a href="https://aws.amazon.com/s3/">Amazon S3</a> forms the backbone of the platform storage layer. The primary format used in the Data Lake is <a href="https://parquet.apache.org/">parquet</a>, which is a strongly typed columnar storage format that can easily be read and written by <a href="https://spark.apache.org/docs/latest/index.html">Spark</a>, as well as being compatible with SQL interfaces such as <a href="https://cwiki.apache.org/confluence/display/Hive/Home">Hive</a> and <a href="http://prestosql.io/">Presto</a>. Some data is also stored in <a href="https://hekad.readthedocs.io/en/dev/message/index.html#stream-framing">Heka-framed protobuf</a> format. This custom format is usually reserved for data where we do not have a complete <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas">JSONSchema specification</a>.</p>
<p>Using S3 for storage avoids the need for an always-on cluster, which means that data at rest is inexpensive. S3 also makes it very easy to automatically expire (delete) objects after a certain period of time, which is helpful for implementing data retention policies.</p>
<p>Once written to S3, the data is typically treated as immutable - data is not appended to existing files, nor is data normally updated in place. The exception here is when data is back-filled, in which case previous data may be overwritten.</p>
<p>There are a number of other types of storage used for more specialized applications, including relational databases (such as PostgreSQL for the <a href="https://github.com/mozilla/python_mozaggregator/#api">Telemetry Aggregates</a>) and NoSQL databases (DynamoDB is used for a backing store for the <a href="https://github.com/mozilla/python_mozetl/blob/master/mozetl/taar/taar_dynamo.py">TAAR project</a>). Reading data from a variety of RDBMS sources is also supported via STMO.</p>
<p>The data stored in Heka format is <a href="concepts/pipeline/../../tools/spark.html">readable from Spark</a> using libraries in <a href="https://github.com/mozilla/moztelemetry/blob/master/src/main/scala/com/mozilla/telemetry/heka/Dataset.scala">Scala</a> or <a href="https://mozilla.github.io/python_moztelemetry/api.html#dataset">Python</a>.</p>
<p>Parquet data can be read and written natively from Spark, and many datasets are indexed in a <a href="https://cwiki.apache.org/confluence/display/Hive/Home">Hive</a> Metastore, making them available through a SQL interface on STMO and in notebooks via Spark SQL. Many other SQL data sources are also made available via STMO, see <a href="concepts/pipeline/../../tools/stmo.html">this article</a> for more information on accessing data using SQL.</p>
<p>There is a separate data store for self-serve <strong>Analysis Outputs</strong>, intended to keep ad-hoc, temporary data out of the Data Lake. This is implemented as a separate S3 location, with personal output locations prefixed with each person's user id, similar to the layout of the <code>/home</code> directory on a Unix system.</p>
<p>Analysis outputs can also be made public using the <strong>Public Outputs</strong> bucket. This is a web-accessible S3 location for powering public dashboards. This public data is available at <code>https://analysis-output.telemetry.mozilla.org/&lt;job name&gt;/data/&lt;files&gt;</code>.</p>
<h2><a class="header" href="#stream-processing" id="stream-processing">Stream Processing</a></h2>
<p>Stream processing is done using <a href="https://github.com/mozilla-services/hindsight">Hindsight</a> and <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html">Spark Streaming</a>.</p>
<p>Hindsight allows you to run <a href="http://mozilla-services.github.io/lua_sandbox/">plugins written in Lua inside a sandbox</a>. This gives a safe, performant way to do self-serve streaming analysis. Hindsight plugins do the initial data validation and decoding, as well as writing out to long-term storage in both <a href="https://hekad.readthedocs.io/en/dev/message/index.html#stream-framing">Heka-framed protobuf</a> and <a href="https://mozilla-services.github.io/lua_sandbox_extensions/parquet/">parquet</a> forms.</p>
<p>Spark Streaming is used to read from Kafka and perform <a href="https://github.com/mozilla/telemetry-streaming">low-latency ETL and aggregation tasks</a>. These aggregates are currently used by <a href="https://data-missioncontrol.dev.mozaws.net">Mission Control</a> and are also available for querying via <a href="concepts/pipeline/../../tools/stmo.html">STMO</a>.</p>
<h2><a class="header" href="#batch-processing" id="batch-processing">Batch Processing</a></h2>
<p>Batch processing is done using <a href="https://spark.apache.org/docs/latest/index.html">Spark</a>. Production ETL code is written in both <a href="https://github.com/mozilla/python_mozetl">Python</a> and <a href="https://github.com/mozilla/telemetry-batch-view">Scala</a>.</p>
<p>There are <a href="https://mozilla.github.io/python_moztelemetry/api.html#dataset">Python</a> and <a href="https://github.com/mozilla/moztelemetry/blob/master/src/main/scala/com/mozilla/telemetry/heka/Dataset.scala">Scala</a> libraries for reading data from the Data Lake in <a href="https://hekad.readthedocs.io/en/dev/message/index.html#stream-framing">Heka-framed protobuf</a> form, though it is much easier and more performant to make use of a <a href="concepts/pipeline/../../concepts/choosing_a_dataset.html">derived dataset</a> whenever possible.</p>
<p>Datasets in parquet format can be read natively by Spark, either using Spark SQL or by reading data directly from S3.</p>
<p>Data produced by production jobs go into the Data Lake, while output from ad-hoc jobs go into Analysis Outputs.</p>
<p>Job scheduling and dependency management is done using <a href="https://github.com/mozilla/telemetry-airflow">Airflow</a>. Most jobs run once a day, processing data from &quot;yesterday&quot; on each run. A typical job launches a cluster, which fetches the specified ETL code as part of its bootstrap on startup, runs the ETL code, then shuts down upon completion. If something goes wrong, a job may time out or fail, and in this case it is retried automatically.</p>
<h2><a class="header" href="#self-serve-data-analysis" id="self-serve-data-analysis">Self Serve Data Analysis</a></h2>
<pre class="mermaid">graph TD
  subgraph Storage
    lake[Data Lake]
    s3_output_public[Public Outputs]
    s3_output_private[Analysis Outputs]
  end
  subgraph STMO
    STMO[STMO] --&gt;|read| lake
  end
  subgraph TMO
    evo[Evolution Dashboard]
    histo[Histogram Dashboard]
    agg[Telemetry Aggregates]
    evo -.- agg
    histo -.- agg
  end
  subgraph Databricks
    db_notebook[Notebook]
    db_notebook --&gt;|read + write| lake
  end
</pre>
<p>Most of the data analysis tooling has been developed with the goal of being &quot;self-serve&quot;. This means that people should be able to access and analyze data on their own, without involving data engineers or operations. Thus can data access scale beyond a small set of people with specialized knowledge of the entire pipeline.</p>
<p>The use of these self-serve tools is described in the <a href="concepts/pipeline/../../concepts/analysis_intro.html">Getting Started</a> article. This section focuses on how these tools integrate with the platform infrastructure.</p>
<h5><a class="header" href="#stmo-sql-analysis" id="stmo-sql-analysis">STMO: SQL Analysis</a></h5>
<p><a href="concepts/pipeline/../../tools/stmo.html">STMO</a> is a customized <a href="https://redash.io">Redash</a> installation that provides self-serve access to a a variety of different <a href="concepts/pipeline/../../concepts/choosing_a_dataset.html">datasets</a>. From here, you can query data in the Parquet Data Lake as well as various RDBMS data sources.</p>
<p>STMO interfaces with the data lake using both <a href="http://prestosql.io/">Presto</a> and Amazon <a href="https://aws.amazon.com/athena/">Athena</a>. Each has its own data source in STMO. Since Athena does not support user-defined functions, datasets with HyperLogLog columns, such as <a href="concepts/pipeline/../../datasets/obsolete/client_count_daily/reference.html"><code>client_count_daily</code></a>, are only available via Presto..</p>
<p>Different <strong>Data Sources</strong> in STMO connect to different backends, and each backend might use a slightly different flavor of SQL. You should find a link to the documentation for the expected SQL variant next to the Data Sources list.</p>
<p>Queries can be run just once, or scheduled to run periodically to keep data up-to-date.</p>
<p>There is a command-line interface to STMO called <a href="https://github.com/mozilla/stmocli">St. Mocli</a>, if you prefer writing SQL using your own editor and tools.</p>
<h5><a class="header" href="#databricks-managed-spark-analysis" id="databricks-managed-spark-analysis">Databricks: Managed Spark Analysis</a></h5>
<p>Our Databricks instance (see <a href="https://docs.databricks.com/user-guide/notebooks/index.html">Databricks docs</a>) offers another notebook interface for doing analysis in Scala, SQL, Python and R.</p>
<p>Databricks provides an always-on shared server which is nice for quick data investigations.</p>
<h5><a class="header" href="#tmo-aggregate-graphs" id="tmo-aggregate-graphs">TMO: Aggregate Graphs</a></h5>
<p><a href="https://telemetry.mozilla.org">TMO</a> provides easy visualizations of histogram and scalar measures over time. Time can be in terms of either builds or submission dates. This is the most convenient interface to the Telemetry data, as it does not require any custom code.</p>
<h2><a class="header" href="#visualization" id="visualization">Visualization</a></h2>
<p>There are a number of visualization libraries and tools being used to display data.</p>
<h5><a class="header" href="#tmo-dashboards" id="tmo-dashboards">TMO Dashboards</a></h5>
<p>The landing page at <a href="https://telemetry.mozilla.org"><code>telemetry.mozilla.org</code></a> is a good place to look for existing graphs, notably the <a href="https://telemetry.mozilla.org/new-pipeline/dist.html">measurement dashboard</a> which gives a lot of information about histogram and scalar measures collected on pre-release channels.</p>
<h5><a class="header" href="#notebooks" id="notebooks">Notebooks</a></h5>
<p>Use of interactive notebooks has become a standard in the industry, and Mozilla makes heavy use of this approach. Databricks makes it easy to run, share, and schedule notebooks.</p>
<h5><a class="header" href="#others" id="others">Others</a></h5>
<p><a href="concepts/pipeline/../../tools/stmo.html">STMO</a> lets you query the data using SQL, but it also supports a number of useful visualizations.</p>
<p><a href="concepts/pipeline/BROKEN:http://pipeline-cep.prod.mozaws.net/">Hindsight's web interface</a> has the ability to visualize time-series data.</p>
<p><a href="https://data-missioncontrol.dev.mozaws.net">Mission Control</a> gives a low-latency view into release health.</p>
<p>Many bespoke visualizations are built using the <a href="http://metricsgraphicsjs.org/">Metrics Graphics</a> library as a display layer.</p>
<h2><a class="header" href="#monitoring-and-alerting" id="monitoring-and-alerting">Monitoring and Alerting</a></h2>
<p>There are multiple layers of monitoring and alerting.</p>
<p>At a low level, the system is monitored to ensure that it is functioning as expected. This includes things like machine-level resources (network capacity, disk space, available RAM, CPU load) which are typically monitored using <a href="http://datadoghq.com/">DataDog</a>.</p>
<p>Next, we monitor the &quot;transport&quot; functionality of the system. This includes monitoring incoming submission rates, payload sizes, traffic patterns, schema validation failure rates, and alerting if anomalies are detected. This type of anomaly detection and alerting is handled by <a href="https://github.com/mozilla-services/hindsight">Hindsight</a>.</p>
<p>Once data has been safely ingested and stored, we run some automatic regression detection on all Telemetry <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/collection/histograms.html">histogram measures</a> using <a href="https://github.com/mozilla/cerberus">Cerberus</a>. This code looks for changes in the distribution of a measure, and emails probe owners if a significant change is observed.</p>
<p>Production ETL jobs are run via <a href="https://github.com/mozilla/telemetry-airflow">Airflow</a>, which monitors batch job progress and alerts if there are failures in any job. Self-serve batch jobs running via Databricks also generate alerts upon failure.</p>
<p>Scheduled <a href="concepts/pipeline/../../tools/stmo.html">STMO</a> queries may also be configured to generate alerts, which is used to monitor the last-mile user facing status of derived datasets. STMO may also be used to monitor and alert on high-level characteristics of the data, or really anything you can think of.</p>
<h2><a class="header" href="#data-exports" id="data-exports">Data Exports</a></h2>
<p>Data is exported from the pipeline to a few other tools and systems. Examples include integration with <a href="https://amplitude.com/">Amplitude</a> for mobile and product analytics and shipping data to other parts of the Mozilla organization.</p>
<p>There are also a few data sets which are made publicly available, such as the <a href="https://data.firefox.com/dashboard/hardware">Firefox Hardware Report</a>.</p>
<h2><a class="header" href="#bringing-it-all-together" id="bringing-it-all-together">Bringing it all together</a></h2>
<p>Finally, here is a more detailed view of the entire platform. Some connections are omitted for clarity.</p>
<pre class="mermaid">graph LR
 subgraph Data Producers
  Firefox
  more_producers[...]
 end
 subgraph Storage
  Landfill
  warehouse_heka[Heka Data Lake]
  warehouse_parquet[Parquet Data Lake]
  warehouse_analysis[Analysis Outputs]
  PostgreSQL
  Redshift
  MySQL
  hive[Hive] -.- warehouse_parquet
 end
 subgraph Stream Processing
  cep[Hindsight Streaming]
  dwl[Data Store Loader] --&gt; warehouse_heka
  dwl --&gt; warehouse_parquet
  sparkstreaming[Spark Streaming] --&gt; warehouse_parquet
 end
 subgraph Ingestion
  Firefox --&gt; lb[Load Balancer]
  more_producers --&gt; lb
  lb --&gt; tee
  tee --&gt; mozingest
  mozingest --&gt; kafka
  mozingest --&gt; Landfill
  ZooKeeper -.- kafka[Kafka]
  kafka --&gt; dwl
  kafka --&gt; cep
  kafka --&gt; sparkstreaming
 end
 subgraph Batch Processing
  Airflow -.-&gt;|spark|tbv[telemetry-batch-view]
  Airflow -.-&gt;|spark|python_mozetl
  warehouse_heka --&gt; tbv
  warehouse_parquet --&gt; tbv
  warehouse_heka --&gt; python_mozetl
  warehouse_parquet --&gt; python_mozetl
  tmo_agg[Telemetry Aggregates]
 end
 subgraph Visualization
  Hindsight
  Jupyter
  Zeppelin
  TMO
  redash_graphs[STMO]
  MissionControl
  bespoke_viz[Bespoke Viz]
 end
 subgraph Export
  tbv --&gt; Amplitude
  sparkstreaming --&gt; Amplitude
 end
 subgraph Self Serve
  redash[STMO] -.-&gt; Presto
  Presto --&gt; hive
  redash -.-&gt; Athena
  Athena --&gt; hive
  warehouse_heka --&gt; spcluster
  warehouse_parquet --&gt; spcluster
  spcluster --&gt; warehouse_analysis
 end
 Schemas -.-&gt;|validation| dwl
</pre>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/pipeline/data_pipeline_detail.md">Edit this file on GitHub.</a></footer><h2><a class="header" href="#legacy-census-metrics" id="legacy-census-metrics">Legacy Census Metrics</a></h2>
<blockquote>
<p><strong>⚠</strong> The information in this document is obsolete: see the <a href="concepts/../metrics/metrics.html">metrics section</a> for currently-used metrics measuring our users. This content was originally included in the <a href="https://mozilla-private.report/smoot-existing-metrics/book/05_overview.html">Project Smoot existing metrics report</a> (Mozilla internal link).</p>
</blockquote>
<p>ADI and DAU are oft-discussed censuses. This chapter discusses their history and definition.</p>
<h3><a class="header" href="#adi--active-daily-installs-blocklist-fetches" id="adi--active-daily-installs-blocklist-fetches">ADI / Active Daily Installs (blocklist fetches)</a></h3>
<blockquote>
<p><strong>⚠</strong> The Blocklist mechanism described below is no longer used and has been replaced with <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1257565">remote settings</a>. The content is left verbatim for historical reference.</p>
</blockquote>
<p>ADI, one of Firefox’s oldest client censuses, is computed as the number
of conforming requests to the Firefox
<a href="https://wiki.mozilla.org/Blocklisting">blocklist</a> endpoint. ADI data is
available since July 13, 2008.</p>
<p>It is not possible to opt-out of the blocklist using the Firefox UI, but
users can disable the update mechanism by changing preference values.</p>
<p>A blocklist is shipped in each release and updated when Firefox notices
that more than 24 hours have elapsed since the last update.</p>
<p>The blocklist request does not contain the telemetry <code>client_id</code> or any
other persistent identifiers. Some data about the install are provided
as URI parameters:</p>
<ul>
<li>App ID</li>
<li>App version</li>
<li>Product name</li>
<li>Build ID</li>
<li>Build target</li>
<li>Locale</li>
<li>Update channel</li>
<li>OS version</li>
<li>Distribution</li>
<li>Distribution version</li>
<li>Number of pings sent by this client for this version of Firefox
(stored in the pref <code>extensions.blocklist.pingCountVersion</code>)</li>
<li>Total ping count (stored in the pref
<code>extensions.blocklist.pingCountTotal</code>)</li>
<li>Number of full days since last ping</li>
</ul>
<p>so subsets of ADI may be queried along these dimensions.</p>
<p>The blocklist is kept up-to-date locally using the <code>UpdateTimerManager</code>
facility; the update is scheduled in a <a href="https://searchfox.org/mozilla-central/rev/b36e97fc776635655e84f2048ff59f38fa8a4626/toolkit/mozapps/extensions/extensions.manifest#1">manifest</a> and performed by
<a href="https://searchfox.org/mozilla-central/rev/b36e97fc776635655e84f2048ff59f38fa8a4626/toolkit/mozapps/extensions/Blocklist.jsm#569"><code>Blocklist#notify</code></a>.</p>
<p>Upon browser startup, after a delay (30 seconds by default),
<code>UpdateTimerManager</code> checks whether any of its scheduled tasks are
ready. At each wakeup, the single most-overdue task is triggered, if one
exists. <code>UpdateTimerManager</code> then sleeps at least two minutes or until
the next task is scheduled.</p>
<p>Failures are ignored.</p>
<p>The raw data is available in BigQuery (see an example <a href="https://sql.telemetry.mozilla.org/queries/66481">ADI query in Redash</a>).</p>
<p>Telemetry only reports whether blocklist checking is enabled or disabled
on the client; there is no data in telemetry about blocklist fetches,
age, or update failures.</p>
<h3><a class="header" href="#dau--daily-active-users" id="dau--daily-active-users">DAU / Daily Active Users</a></h3>
<blockquote>
<p><strong>⚠</strong> This description of DAU is not authoritative; please see the <a href="concepts/../metrics/metrics.html#daily-active-users-dau">DAU definition in metrics</a> for the canonical definition.</p>
</blockquote>
<p>Firefox DAU is currently computed as the number of unique <code>client_id</code>s
observed in <code>main</code> pings received on a calendar day. The DAU count
excludes users who have <a href="https://support.mozilla.org/en-US/kb/share-data-mozilla-help-improve-firefox">opted out of telemetry</a>.</p>
<p>Each <code>main</code> ping describes a single subsession of browser activity.</p>
<p>When and how a ping is sent depends on the reason the subsession ends:</p>
<div id="tbl:pingreasons">
<table style="width:99%;">
<caption>Table 1: When <code>main</code> pings are sent, and why.</caption>
<colgroup>
<col style="width: 9%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Reason</th>
<th style="text-align: left;">Trigger</th>
<th style="text-align: left;">Percent of subsessions [1]</th>
<th style="text-align: left;">Mechanism</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>shutdown</code></td>
<td style="text-align: left;">Browser is closed</td>
<td style="text-align: left;">77%</td>
<td style="text-align: left;">For Firefox 55 or later, sent by <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/internals/pingsender.html"><code>Pingsender</code></a> on browser close unless the OS is shutting down. Otherwise, sent by <a href="https://searchfox.org/mozilla-central/rev/532e4b94b9e807d157ba8e55034aef05c1196dc9/toolkit/components/telemetry/app/TelemetrySend.jsm#677">`TelemetrySendImpl.setup`</a> on the following browser launch.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>environment-change</code></td>
<td style="text-align: left;">The telemetry environment changed</td>
<td style="text-align: left;">13%</td>
<td style="text-align: left;">Sent when change is detected by <a href="https://searchfox.org/mozilla-central/rev/532e4b94b9e807d157ba8e55034aef05c1196dc9/toolkit/components/telemetry/pings/TelemetrySession.jsm#1510">`TelemetrySession._onEnvironmentChange`</a></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>daily</code></td>
<td style="text-align: left;">more than 24 hours have elapsed since the last ping was sent and the time is local midnight</td>
<td style="text-align: left;">8%</td>
<td style="text-align: left;">Sent at local midnight after a random 0-60 min delay</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>aborted-session</code></td>
<td style="text-align: left;">A session terminates uncleanly (e.g. crash or lost power)</td>
<td style="text-align: left;">3%</td>
<td style="text-align: left;">Sent by the browser on the next launch; the payload to send is <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/concepts/crashes.html">written to disk every 5 minutes</a> during an active session and removed by a clean shutdown</td>
</tr>
</tbody>
</table>
</div>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/concepts/censuses.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#obsolete-datasets" id="obsolete-datasets">Obsolete Datasets</a></h1>
<p>These datasets are no longer updated or maintained. Please reach out to the Data Platform team
if you think your needs are best met by an obsolete dataset.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/obsolete.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#churn" id="churn">Churn</a></h1>
<blockquote>
<p>As of 2019-08-21, this dataset has been deprecated and is no longer
maintained. See <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1561048">Bug
1561048</a> for historical
sources. See the <a href="datasets/obsolete/churn/../../../cookbooks/retention.html">retention cookbook</a> for
current best practices.</p>
</blockquote>
<ul>
<li><a href="datasets/obsolete/churn/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/obsolete/churn/reference.html#content">Content</a></li>
<li><a href="datasets/obsolete/churn/reference.html#background-and-caveats">Background and Caveats</a></li>
<li><a href="datasets/obsolete/churn/reference.html#accessing-the-data">Accessing the Data</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/churn/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/obsolete/churn/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/obsolete/churn/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/obsolete/churn/reference.html#schema">Schema</a></li>
<li><a href="datasets/obsolete/churn/reference.html#code-reference">Code Reference</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#introduction-22" id="introduction-22">Introduction</a></h1>
<p>The churn dataset tracks the 7-day churn rate of telemetry profiles. This
dataset is generally used for analyzing cohort churn across segments and time.</p>
<h4><a class="header" href="#content-2" id="content-2">Content</a></h4>
<p>Churn is the rate of attrition defined by <code>(clients seen in week N)/(clients seen in week 0)</code>
for groups of clients with some shared attributes. A group of clients with
shared attributes is called a <em>cohort</em>. The cohorts in this dataset are created
every week and can be tracked over time using the <code>acquisition_date</code> and the
weeks since acquisition or <code>current_week</code>.</p>
<p>The following example demonstrates the current logic for generating this
dataset. Each column represents the days since some arbitrary starting date.</p>
<table><thead><tr><th>client</th><th>00</th><th>01</th><th>02</th><th>03</th><th>04</th><th>05</th><th>06</th><th>07</th><th>08</th><th>09</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th></tr></thead><tbody>
<tr><td>A</td><td>X</td><td></td><td></td><td></td><td></td><td></td><td></td><td>X</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
<tr><td>B</td><td></td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
<tr><td>C</td><td>X</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>X</td></tr>
</tbody></table>
<p>All three clients are part of the same cohort. Client A is retained for weeks 0
and 1 since there is activity in both periods. A client only needs to show up
once in the period to be counted as retained. Client B is acquired in week 0 and
is active frequently but does not appear in following weeks. Client B is
considered churned on week 1. However, a client that is churned can become
retained again. Client C is considered churned on week 1 but retained on week 2.</p>
<p>The following table summarizes the above daily activity into the following view
where every column represents the current week since acquisition date..</p>
<table><thead><tr><th>client</th><th>0</th><th>1</th><th>2</th></tr></thead><tbody>
<tr><td>A</td><td>X</td><td>X</td><td></td></tr>
<tr><td>B</td><td>X</td><td></td><td></td></tr>
<tr><td>C</td><td>X</td><td></td><td>X</td></tr>
</tbody></table>
<p>The clients are then grouped into cohorts by attributes. An attribute describes
a property about the cohort such as the country of origin or the binary
distribution channel. Each group also contains descriptive aggregates of
engagement. Each metric describes the activity of a cohort such as size and
overall usage at a given time instance.</p>
<h4><a class="header" href="#background-and-caveats-9" id="background-and-caveats-9">Background and Caveats</a></h4>
<p>The original concept for churn is captured in <a href="https://mana.mozilla.org/wiki/display/FIREFOX/Project%3A+Firefox+Churn+v1.0">this Mana
page</a>.
The original derived data-set was created in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1198537">bug
1198537</a>. The first
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1389230">major revision (<code>v2</code>)</a> of
this data-set added attribution, search, and uri counts. The second <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1389231">major
revision (<code>v3</code>)</a> included
additional clients through the <code>new-profile</code> ping and adjusted the collection
window from 10 to 5 days.</p>
<ul>
<li>Each row in this dataset describes a unique segment of users
<ul>
<li>The number of rows is exponential with the number of dimensions</li>
<li>New fields should be added sparing to account for data-set size</li>
</ul>
</li>
<li>The dataset lags by 10 days in order account for submission latency
<ul>
<li>This value was determined to be time for 99% of main pings to arrive at the
server. With the shutdown-ping sender, this has been reduced to 4 days.
However, <code>churn_v3</code> still tracks releases older than Firefox 55.</li>
</ul>
</li>
<li>The start of the period is fixed to Sundays. Once it has been aggregated, the
period cannot be shifted due to the way clients are counted.
<ul>
<li>A supplementary 1-day <code>retention</code> dataset using HyperLogLog for client
counts is available for counting over arbitrary retention periods and date
offsets. Additionally, calculating churn or retention over specific cohorts
is tractable in STMO with <code>main_summary</code> or <code>clients_daily</code> datasets.</li>
</ul>
</li>
</ul>
<h4><a class="header" href="#accessing-the-data-12" id="accessing-the-data-12">Accessing the Data</a></h4>
<p><code>churn</code> is available in STMO under Athena and Presto. The data is also
available in parquet for consumption by columnar data engines at
<code>s3://telemetry-parquet/churn/v3</code>.</p>
<h1><a class="header" href="#data-reference-20" id="data-reference-20">Data Reference</a></h1>
<h2><a class="header" href="#example-queries-17" id="example-queries-17">Example Queries</a></h2>
<p>This section walks through a typical query to generate data suitable for
visualization.</p>
<table><thead><tr><th>field</th><th>type</th><th>description</th></tr></thead><tbody>
<tr><td><code>cohort_date</code></td><td>common, attribute</td><td>The start date bucket of the cohort. This is week the client was acquired.</td></tr>
<tr><td><code>elapsed_periods</code></td><td>common, attribute</td><td>The number of periods that have elapsed since the cohort date. In this dataset, the retention period is 7 days.</td></tr>
<tr><td><code>channel</code></td><td>attribute</td><td>Part of the release train model. An attribute that distinguishes cohorts.</td></tr>
<tr><td><code>geo</code></td><td>filter attribute</td><td>Country code. Used to filter out all countries other than the 'US'</td></tr>
<tr><td><code>n_profiles</code></td><td>metric</td><td>Count of users in a cohort. Use sum to aggregate.</td></tr>
</tbody></table>
<p>First the fields are extracted and aliased for consistency. <code>cohort_date</code> and
<code>elapsed_periods</code> are common to most retention queries and are useful concepts
for building on other datasets.</p>
<pre><code class="language-sql">WITH extracted AS (
    SELECT acquisition_period AS cohort_date,
           current_week AS elapsed_periods,
           n_profiles,
           channel,
           geo
    FROM churn
),
</code></pre>
<p>The extracted table is filtered down to the attributes of interest. The cohorts
of interest originate in the US and are in the release or beta channels. Note
that <code>channel</code> here is the concatenation of the normalized channel and the
funnelcake id. Only cohorts appearing after August 6, 2017 are chosen to be in
this population.</p>
<pre><code class="language-sql"> population AS (
    SELECT channel,
           cohort_date,
           elapsed_periods,
           n_profiles
    FROM extracted
    WHERE geo = 'US'
      AND channel IN ('release', 'beta')
      AND cohort_date &gt; '20170806'
      -- filter out noise from clients with incorrect dates
      AND elapsed_periods &gt;= 0
      AND elapsed_periods &lt; 12
),
</code></pre>
<p>The number of profiles is aggregated by the cohort dimensions. The cohort
acquisition date and elapsed periods since acquisition are fundamental to cohort
analysis.</p>
<pre><code class="language-sql"> cohorts AS (
     SELECT channel,
            cohort_date,
            elapsed_periods,
            sum(n_profiles) AS n_profiles
     FROM population
     GROUP BY 1, 2, 3
),
</code></pre>
<p>The table will have the following structure. The table is sorted by the first three columns for demonstration.</p>
<table><thead><tr><th><code>channel</code></th><th><code>cohort_date</code></th><th><code>elapsed_periods</code></th><th><code>n_profiles</code></th></tr></thead><tbody>
<tr><td>release</td><td>20170101</td><td>0</td><td>100</td></tr>
<tr><td>release</td><td>20170101</td><td>1</td><td>90</td></tr>
<tr><td>release</td><td>20170101</td><td>2</td><td>80</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td></tr>
<tr><td>beta</td><td>20170128</td><td>10</td><td>25</td></tr>
</tbody></table>
<p>Finally, retention is calculated through the number of profiles at the time of
the <code>elapsed_period</code> relative to the initial period. This data can be imported
into a pivot table for further analysis.</p>
<pre><code class="language-sql">results AS (
    SELECT c.*,
           iv.n_profiles AS total_n_profiles,
           (0.0+c.n_profiles)*100/iv.n_profiles AS percentage_n_profiles
    FROM cohorts c
    JOIN (
        SELECT *
        FROM cohorts
        WHERE elapsed_periods = 0
    ) iv ON (
        c.cohort_date = iv.cohort_date
        AND c.channel = iv.channel
    )
)
</code></pre>
<table><thead><tr><th><code>channel</code></th><th><code>cohort_date</code></th><th><code>elapsed_periods</code></th><th><code>n_profiles</code></th><th><code>total_n_profiles</code></th><th><code>percentage_n_profiles</code></th></tr></thead><tbody>
<tr><td>release</td><td>20170101</td><td>0</td><td>100</td><td>100</td><td>1.0</td></tr>
<tr><td>release</td><td>20170101</td><td>1</td><td>90</td><td>100</td><td>0.9</td></tr>
<tr><td>release</td><td>20170101</td><td>2</td><td>80</td><td>100</td><td>0.8</td></tr>
<tr><td>...</td><td>....</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
<tr><td>beta</td><td>20170128</td><td>10</td><td>25</td><td>50</td><td>0.5</td></tr>
</tbody></table>
<p>Obtain the results.</p>
<pre><code class="language-sql">SELECT *
FROM results
</code></pre>
<p>You may consider visualizing using cohort graphs, line charts, or a pivot
tables. See <a href="https://sql.telemetry.mozilla.org/dashboard/firefox-telemetry-retention-dataset-example-usage">Firefox Telemetry Retention: Dataset Example Usage</a>
for more examples.</p>
<h2><a class="header" href="#scheduling-20" id="scheduling-20">Scheduling</a></h2>
<p>The aggregated churn data is updated weekly on Wednesday.</p>
<h2><a class="header" href="#schema-17" id="schema-17">Schema</a></h2>
<p>As of 2017-10-15, the current version of <code>churn</code> is <code>v3</code> and has a schema as follows:</p>
<pre><code>root
 |-- channel: string (nullable = true)
 |-- geo: string (nullable = true)
 |-- is_funnelcake: string (nullable = true)
 |-- acquisition_period: string (nullable = true)
 |-- start_version: string (nullable = true)
 |-- sync_usage: string (nullable = true)
 |-- current_version: string (nullable = true)
 |-- current_week: long (nullable = true)
 |-- source: string (nullable = true)
 |-- medium: string (nullable = true)
 |-- campaign: string (nullable = true)
 |-- content: string (nullable = true)
 |-- distribution_id: string (nullable = true)
 |-- default_search_engine: string (nullable = true)
 |-- locale: string (nullable = true)
 |-- is_active: string (nullable = true)
 |-- n_profiles: long (nullable = true)
 |-- usage_hours: double (nullable = true)
 |-- sum_squared_usage_hours: double (nullable = true)
 |-- total_uri_count: long (nullable = true)
 |-- unique_domains_count_per_profile: double (nullable = true)
</code></pre>
<h2><a class="header" href="#code-reference-18" id="code-reference-18">Code Reference</a></h2>
<p>The script for generating <code>churn</code> currently lives in
<a href="https://github.com/mozilla/python_mozetl/tree/9217335652cad46940a51c7c2784cc5c6d3a00f4"><code>mozilla/python_mozetl</code></a>. The job can
be found in
<a href="https://github.com/mozilla/python_mozetl/blob/9217335652cad46940a51c7c2784cc5c6d3a00f4/mozetl/engagement/churn/job.py#L1-L27"><code>mozetl/engagement/churn</code></a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/obsolete/churn/reference.md">Edit this file on GitHub.</a></footer><blockquote>
<p>As of 2019-10-23, this dataset has been deprecated and is no longer
maintained. See <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1585539">Bug 1585539</a>.</p>
</blockquote>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/obsolete/client_count/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#client-count-daily-reference" id="client-count-daily-reference">Client Count Daily Reference</a></h1>
<blockquote>
<p>As of 2019-04-10, this dataset has been deprecated and is no longer maintained. Please use <a href="datasets/obsolete/client_count_daily//datasets/bigquery/clients_last_seen/reference.html"><code>clients_last_seen</code></a> instead. See <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1543518">Bug 1543518</a> for more information.</p>
</blockquote>
<ul>
<li><a href="datasets/obsolete/client_count_daily/reference.html#replacement">Replacement</a></li>
<li><a href="datasets/obsolete/client_count_daily/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/obsolete/client_count_daily/reference.html#content">Content</a></li>
<li><a href="datasets/obsolete/client_count_daily/reference.html#background-and-caveats">Background and Caveats</a></li>
<li><a href="datasets/obsolete/client_count_daily/reference.html#accessing-the-data">Accessing the Data</a></li>
<li><a href="datasets/obsolete/client_count_daily/reference.html#further-reading">Further Reading</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/client_count_daily/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/obsolete/client_count_daily/reference.html#example-queries">Example Queries</a>
<ul>
<li><a href="datasets/obsolete/client_count_daily/reference.html#compute-dau-for-non-windows-clients-for-the-last-week">Compute DAU for non-windows clients for the last week</a></li>
<li><a href="datasets/obsolete/client_count_daily/reference.html#compute-wau-by-channel-for-the-last-week">Compute WAU by Channel for the last week</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/client_count_daily/reference.html#caveats">Caveats</a></li>
<li><a href="datasets/obsolete/client_count_daily/reference.html#schema">Schema</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#replacement" id="replacement">Replacement</a></h1>
<p>We've moved to calculating exact user counts based on
<a href="datasets/obsolete/client_count_daily//datasets/bigquery/clients_last_seen/reference.html"><code>clients_last_seen</code></a>, see
<a href="datasets/obsolete/client_count_daily/../../../cookbooks/dau.html">DAU</a> and
<a href="datasets/obsolete/client_count_daily/../../../cookbooks/active_dau.html">Active DAU</a> for examples.</p>
<h1><a class="header" href="#introduction-23" id="introduction-23">Introduction</a></h1>
<p>The <code>client_count_daily</code> dataset is useful for estimating user counts over a few
<a href="https://github.com/mozilla/telemetry-airflow/blob/adfce4a30895faa607ccf586b292b61ad68d8f75/jobs/client_count_daily_view.sh">pre-defined dimensions</a>.</p>
<p>The <code>client_count_daily</code> dataset is similar to the deprecated
<a href="datasets/obsolete/client_count_daily//datasets/batch_view/client_count/reference.html"><code>client_count</code> dataset</a>
except that is aggregated by submission date and not activity date.</p>
<h4><a class="header" href="#content-3" id="content-3">Content</a></h4>
<p>This dataset includes columns for a dozen factors and an HLL variable.
The <code>hll</code> column contains a
<a href="https://en.wikipedia.org/wiki/HyperLogLog">HyperLogLog</a>
variable, which is an approximation to the exact count.
The factor columns include <strong>submission</strong> date and the dimensions listed
<a href="https://github.com/mozilla/telemetry-airflow/blob/adfce4a30895faa607ccf586b292b61ad68d8f75/jobs/client_count_daily_view.sh">here</a>.
Each row represents one combinations of the factor columns.</p>
<h4><a class="header" href="#background-and-caveats-10" id="background-and-caveats-10">Background and Caveats</a></h4>
<p>It's important to understand that the <code>hll</code> column is <strong>not a standard count</strong>.
The <code>hll</code> variable avoids double-counting users when aggregating over multiple days.
The HyperLogLog variable is a far more efficient way to count distinct elements of a set,
but comes with some complexity.
To find the cardinality of an HLL use <code>cardinality(cast(hll AS HLL))</code>.
To find the union of two HLL's over different dates, use <code>merge(cast(hll AS HLL))</code>.
The <a href="https://sql.telemetry.mozilla.org/queries/81/source#129">Firefox ER Reporting Query</a>
is a good example to review.
Finally, Roberto has a relevant write-up
<a href="https://ravitillo.wordpress.com/2016/04/12/measuring-product-engagment-at-scale/">here</a>.</p>
<h4><a class="header" href="#accessing-the-data-13" id="accessing-the-data-13">Accessing the Data</a></h4>
<p>The data is available in STMO.
Take a look at this
<a href="https://sql.telemetry.mozilla.org/queries/81/source#129">example query</a>.</p>
<h4><a class="header" href="#further-reading-1" id="further-reading-1">Further Reading</a></h4>
<h1><a class="header" href="#data-reference-21" id="data-reference-21">Data Reference</a></h1>
<h2><a class="header" href="#example-queries-18" id="example-queries-18">Example Queries</a></h2>
<h4><a class="header" href="#compute-dau-for-non-windows-clients-for-the-last-week-1" id="compute-dau-for-non-windows-clients-for-the-last-week-1">Compute DAU for non-windows clients for the last week</a></h4>
<pre><code class="language-sql">WITH sample AS (
  SELECT
    os,
    submission_date,
    cardinality(merge(cast(hll AS HLL))) AS count
  FROM client_count_daily
  WHERE submission_date &gt;= DATE_FORMAT(CURRENT_DATE - INTERVAL '7' DAY, '%Y%m%d')
  GROUP BY
    submission_date,
    os
)

SELECT
  os,
  -- formatting date as late as possible improves performance dramatically
  date_parse(submission_date, '%Y%m%d') AS submission_date,
  count
FROM sample
WHERE
  count &gt; 10 -- remove outliers
  AND lower(os) NOT LIKE '%windows%'
ORDER BY
  os,
  submission_date DESC
</code></pre>
<h4><a class="header" href="#compute-wau-by-channel-for-the-last-week-1" id="compute-wau-by-channel-for-the-last-week-1">Compute WAU by Channel for the last week</a></h4>
<pre><code class="language-sql">WITH dau AS (
  SELECT
    normalized_channel,
    submission_date,
    merge(cast(hll AS HLL)) AS hll
  FROM client_count_daily
  -- 2 days of lag, 7 days of results, and 6 days preceding for WAU
  WHERE submission_date &gt; DATE_FORMAT(CURRENT_DATE - INTERVAL '15' DAY, '%Y%m%d')
  GROUP BY
    submission_date,
    normalized_channel
),
wau AS (
  SELECT
    normalized_channel,
    submission_date,
    cardinality(merge(hll) OVER (
      PARTITION BY normalized_channel
      ORDER BY submission_date
      ROWS BETWEEN 6 PRECEDING AND 0 FOLLOWING
    )) AS count
  FROM dau
)

SELECT
  normalized_channel,
  -- formatting date as late as possible improves performance dramatically
  date_parse(submission_date, '%Y%m%d') AS submission_date,
  count
FROM wau
WHERE
  count &gt; 10 -- remove outliers
  AND submission_date &gt; DATE_FORMAT(CURRENT_DATE - INTERVAL '9' DAY, '%Y%m%d') -- only days that have a full WAU
</code></pre>
<h2><a class="header" href="#caveats-5" id="caveats-5">Caveats</a></h2>
<p>The <code>hll</code> column does not product an exact count. <code>hll</code> stands for
<a href="https://en.wikipedia.org/wiki/HyperLogLog">HyperLogLog</a>, a sophisticated
algorithm that allows for the counting of extremely high numbers of items,
sacrificing a small amount of accuracy in exchange for using much less memory
than a simple counting structure.</p>
<p>When count is calculated over a column that may change over time, such as
<code>total_uri_count_threshold</code>, then a client would be counted in every group
where they appear. Over longer windows, like MAU, this is more likely to occur.</p>
<h2><a class="header" href="#schema-18" id="schema-18">Schema</a></h2>
<p>The data is partitioned by <code>submission_date</code> which is formatted as <code>%Y%m%d</code>,
like <code>20180130</code>.</p>
<p>As of 2018-03-15, the current version of the <code>client_count_daily</code> dataset
is <code>v2</code>, and has a schema as follows:</p>
<pre><code>root
 |-- app_name: string (nullable = true)
 |-- app_version: string (nullable = true)
 |-- country: string (nullable = true)
 |-- devtools_toolbox_opened: boolean (nullable = true)
 |-- e10s_enabled: boolean (nullable = true)
 |-- hll: binary (nullable = true)
 |-- locale: string (nullable = true)
 |-- normalized_channel: string (nullable = true)
 |-- os: string (nullable = true)
 |-- os_version: string (nullable = true)
 |-- top_distribution_id: string (nullable = true)
 |-- total_uri_count_threshold: integer (nullable = true)
</code></pre>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/obsolete/client_count_daily/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#crash-aggregates" id="crash-aggregates">Crash Aggregates</a></h1>
<blockquote>
<p>As of 2018-04-02, this dataset has been deprecated and is no longer maintained. See <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1388025">Bug 1388025</a> for more information.</p>
</blockquote>
<ul>
<li><a href="datasets/obsolete/crash_aggregates/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/obsolete/crash_aggregates/reference.html#rows-and-columns">Rows and Columns</a></li>
<li><a href="datasets/obsolete/crash_aggregates/reference.html#accessing-the-data">Accessing the Data</a></li>
<li><a href="datasets/obsolete/crash_aggregates/reference.html#further-reading">Further Reading</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/crash_aggregates/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/obsolete/crash_aggregates/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/obsolete/crash_aggregates/reference.html#sampling">Sampling</a>
<ul>
<li><a href="datasets/obsolete/crash_aggregates/reference.html#invalid-pings">Invalid Pings</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/crash_aggregates/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/obsolete/crash_aggregates/reference.html#schema">Schema</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#introduction-24" id="introduction-24">Introduction</a></h1>
<p>The <code>crash_aggregates</code> dataset compiles crash statistics over various dimensions for each day.</p>
<h4><a class="header" href="#rows-and-columns-1" id="rows-and-columns-1">Rows and Columns</a></h4>
<p>There's one column for each of the stratifying dimensions and the crash statistics.
Each row is a distinct set of dimensions, along with their associated crash stats.
Example stratifying dimensions include channel and country,
example statistics include usage hours and plugin crashes.</p>
<h4><a class="header" href="#accessing-the-data-14" id="accessing-the-data-14">Accessing the Data</a></h4>
<p>This dataset is accessible via STMO.</p>
<p>The data is stored as a parquet table in S3 at the following address.</p>
<pre><code>s3://telemetry-parquet/crash_aggregates/v1/
</code></pre>
<h4><a class="header" href="#further-reading-2" id="further-reading-2">Further Reading</a></h4>
<p>The technical documentation for this dataset can be found in the
<a href="https://github.com/mozilla/telemetry-batch-view/blob/0128b08/docs/CrashAggregateView.md">telemetry-batch-view documentation</a></p>
<h1><a class="header" href="#data-reference-22" id="data-reference-22">Data Reference</a></h1>
<h2><a class="header" href="#example-queries-19" id="example-queries-19">Example Queries</a></h2>
<p>Here's an example query that computes crash rates
for each channel (sorted by number of usage hours):</p>
<pre><code class="language-sql">SELECT dimensions['channel'] AS channel,
       sum(stats['usage_hours']) AS usage_hours,
       1000 * sum(stats['main_crashes']) / sum(stats['usage_hours']) AS main_crash_rate,
       1000 * sum(stats['content_crashes']) / sum(stats['usage_hours']) AS content_crash_rate,
       1000 * sum(stats['plugin_crashes']) / sum(stats['usage_hours']) AS plugin_crash_rate,
       1000 * sum(stats['gmplugin_crashes']) / sum(stats['usage_hours']) AS gmplugin_crash_rate,
       1000 * sum(stats['gpu_crashes']) / sum(stats['usage_hours']) AS gpu_crash_rate
FROM crash_aggregates
GROUP BY dimensions['channel']
ORDER BY -sum(stats['usage_hours'])
</code></pre>
<p>Main process crashes by build date and OS version.</p>
<pre><code class="language-sql">WITH channel_rates AS (
  SELECT dimensions['build_id'] AS build_id,
         SUM(stats['main_crashes']) AS main_crashes, -- total number of crashes
         SUM(stats['usage_hours']) / 1000 AS usage_kilohours, -- thousand hours of usage
         dimensions['os_version'] AS os_version -- os version
   FROM crash_aggregates
   WHERE dimensions['experiment_id'] is null -- not in an experiment
     AND regexp_like(dimensions['build_id'], '^\d{14}$') -- validate build IDs
     AND dimensions['build_id'] &gt; '20160201000000' -- only in the date range that we care about
   GROUP BY dimensions['build_id'], dimensions['os_version']
)
SELECT cast(parse_datetime(build_id, 'yyyyMMddHHmmss') as date) as build_id, -- program build date
       usage_kilohours, -- thousands of usage hours
       os_version, -- os version
       main_crashes / usage_kilohours AS main_crash_rate -- crash rate being defined as crashes per thousand usage hours
FROM channel_rates
WHERE usage_kilohours &gt; 100 -- only aggregates that have statistically significant usage hours
ORDER BY build_id ASC
</code></pre>
<h2><a class="header" href="#sampling-2" id="sampling-2">Sampling</a></h2>
<h3><a class="header" href="#invalid-pings-1" id="invalid-pings-1">Invalid Pings</a></h3>
<p>We ignore invalid pings in our processing. Invalid pings are defined as those that:</p>
<ul>
<li>The submission dates or activity dates are invalid or missing.</li>
<li>The build ID is malformed.</li>
<li>The <code>docType</code> field is missing or unknown.</li>
<li>The ping is a main ping without usage hours or a crash ping with usage hours.</li>
</ul>
<h2><a class="header" href="#scheduling-21" id="scheduling-21">Scheduling</a></h2>
<p>The <code>crash_aggregates</code> job is run daily, at midnight UTC.
The job is scheduled on <a href="https://github.com/mozilla/telemetry-airflow">Airflow</a>.
The DAG is <a href="https://github.com/mozilla/telemetry-airflow/blob/d50b938/dags/crash_aggregates.py">here</a></p>
<h2><a class="header" href="#schema-19" id="schema-19">Schema</a></h2>
<p>The <code>crash_aggregates</code> table has 4 commonly-used columns:</p>
<ul>
<li><code>submission_date</code> is the date pings were submitted for a particular aggregate.
<ul>
<li>For example, <code>select sum(stats['usage_hours']) from crash_aggregates where submission_date = '2016-03-15'</code> will give the total number of user hours represented by pings submitted on March 15, 2016.</li>
<li>The dataset is partitioned by this field. Queries that limit the possible values of <code>submission_date</code> can run significantly faster.</li>
</ul>
</li>
<li><code>activity_date</code> is the day when the activity being recorded took place.
<ul>
<li>For example, <code>select sum(stats['usage_hours']) from crash_aggregates where activity_date = '2016-03-15'</code> will give the total number of user hours represented by activities that took place on March 15, 2016.</li>
<li>This can be several days before the pings are actually submitted, so it will always be before or on its corresponding <code>submission_date</code>.</li>
<li>Therefore, queries that are sensitive to when measurements were taken on the client should prefer this field over <code>submission_date</code>.</li>
</ul>
</li>
<li><code>dimensions</code> is a map of all the other dimensions that we currently care about. These fields include:
<ul>
<li><code>dimensions['build_version']</code> is the program version, like <code>46.0a1</code>.</li>
<li><code>dimensions['build_id']</code> is the <code>YYYYMMDDhhmmss</code> timestamp the program was built, like <code>20160123180541</code>. This is also known as the <code>build ID</code> or <code>buildid</code>.</li>
<li><code>dimensions['channel']</code> is the channel, like <code>release</code> or <code>beta</code>.</li>
<li><code>dimensions['application']</code> is the program name, like <code>Firefox</code> or <code>Fennec</code>.</li>
<li><code>dimensions['os_name']</code> is the name of the OS the program is running on, like <code>Darwin</code> or <code>Windows_NT</code>.</li>
<li><code>dimensions['os_version']</code> is the version of the OS the program is running on.</li>
<li><code>dimensions['architecture']</code> is the architecture that the program was built for (not necessarily the one it is running on).</li>
<li><code>dimensions['country']</code> is the country code for the user (determined using geoIP), like <code>US</code> or <code>UK</code>.</li>
<li><code>dimensions['experiment_id']</code> is the identifier of the experiment being participated in, such as <code>e10s-beta46-noapz@experiments.mozilla.org</code>, or null if no experiment.</li>
<li><code>dimensions['experiment_branch']</code> is the branch of the experiment being participated in, such as <code>control</code> or <code>experiment</code>, or null if no experiment.</li>
<li><code>dimensions['e10s_enabled']</code> is whether E10s is enabled.</li>
<li><code>dimensions['gfx_compositor']</code> is the graphics backend compositor used by the program, such as <code>d3d11</code>, <code>opengl</code> and <code>simple</code>. Null values may be reported as <code>none</code> as well.</li>
<li>All of the above fields can potentially be blank, which means &quot;not present&quot;. That means that in the actual pings, the corresponding fields were null.</li>
</ul>
</li>
<li><code>stats</code> contains the aggregate values that we care about:
<ul>
<li><code>stats['usage_hours']</code> is the number of user-hours represented by the aggregate.</li>
<li><code>stats['main_crashes']</code> is the number of main process crashes represented by the aggregate (or just program crashes, in the non-E10S case).</li>
<li><code>stats['content_crashes']</code> is the number of content process crashes represented by the aggregate.</li>
<li><code>stats['plugin_crashes']</code> is the number of plugin process crashes represented by the aggregate.</li>
<li><code>stats['gmplugin_crashes']</code> is the number of Gecko media plugin (often abbreviated <code>GMPlugin</code>) process crashes represented by the aggregate.</li>
<li><code>stats['content_shutdown_crashes']</code> is the number of content process crashes that were caused by failure to shut down in a timely manner.</li>
<li><code>stats['gpu_crashes']</code> is the number of GPU process crashes represented by the aggregate.</li>
</ul>
</li>
</ul>
<p><code>TODO(harter)</code>: https://bugzilla.mozilla.org/show_bug.cgi?id=1361862</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/obsolete/crash_aggregates/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#crash-summary-reference" id="crash-summary-reference">Crash Summary Reference</a></h1>
<ul>
<li><a href="datasets/obsolete/crash_summary/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/obsolete/crash_summary/reference.html#contents">Contents</a></li>
<li><a href="datasets/obsolete/crash_summary/reference.html#accessing-the-data">Accessing the Data</a></li>
<li><a href="datasets/obsolete/crash_summary/reference.html#further-reading">Further Reading</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/crash_summary/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/obsolete/crash_summary/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/obsolete/crash_summary/reference.html#sampling">Sampling</a></li>
<li><a href="datasets/obsolete/crash_summary/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/obsolete/crash_summary/reference.html#schema">Schema</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#introduction-25" id="introduction-25">Introduction</a></h1>
<blockquote>
<p>As of 2019-11-06, this dataset has been deprecated and is no longer maintained. Please use the <code>telemetry.crash</code> table instead, which is generated directly from live pings and is much more complete. See <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1572069">Bug 1572069</a> for more information.</p>
</blockquote>
<p>The <code>crash_summary</code> table is the a direct representation of a crash ping.</p>
<h4><a class="header" href="#contents-10" id="contents-10">Contents</a></h4>
<p>The <code>crash_summary</code> table contains one row for each crash ping.
Each column represents one field from the crash ping payload,
though only a subset of all crash ping fields are included.</p>
<h4><a class="header" href="#accessing-the-data-15" id="accessing-the-data-15">Accessing the Data</a></h4>
<p>The data is stored as a parquet table in S3 at the following address.</p>
<pre><code>s3://telemetry-parquet/crash_summary/v1/
</code></pre>
<p><code>crash_summary</code> is accessible through STMO.
Here's an <a href="https://sql.telemetry.mozilla.org/queries/4793/source">example query</a>.</p>
<h4><a class="header" href="#further-reading-3" id="further-reading-3">Further Reading</a></h4>
<p>The technical documentation for <code>crash_summary</code> is located in the
<a href="https://github.com/mozilla/telemetry-batch-view/blob/master/docs/CrashSummary.md">telemetry-batch-view documentation</a>.</p>
<p>The code responsible for generating this dataset is
<a href="https://github.com/mozilla/telemetry-batch-view/blob/master/GRAVEYARD.md#crash-summary">here</a></p>
<h1><a class="header" href="#data-reference-23" id="data-reference-23">Data Reference</a></h1>
<h2><a class="header" href="#example-queries-20" id="example-queries-20">Example Queries</a></h2>
<p>Here is an example query to get the total number of main crashes by <code>gfx_compositor</code>:</p>
<pre><code class="language-sql">select gfx_compositor, count(*)
from crash_summary
where application = 'Firefox'
and (payload.processType IS NULL OR payload.processType = 'main')
group by gfx_compositor
</code></pre>
<h2><a class="header" href="#sampling-3" id="sampling-3">Sampling</a></h2>
<p><code>CrashSummary</code> contains one record for every
<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/crash-ping.html">crash ping</a>
submitted by Firefox.</p>
<h2><a class="header" href="#scheduling-22" id="scheduling-22">Scheduling</a></h2>
<p>This dataset is updated daily, shortly after midnight UTC.
The job is scheduled on
<a href="https://github.com/mozilla/telemetry-airflow">telemetry-airflow</a>.
The DAG is <a href="https://github.com/mozilla/telemetry-airflow/blob/166e0a555ee2de0d3c7f0add1011f7771f7ea23d/dags/crash_summary.py">here</a>.</p>
<h2><a class="header" href="#schema-20" id="schema-20">Schema</a></h2>
<pre><code>root
 |-- client_id: string (nullable = true)
 |-- normalized_channel: string (nullable = true)
 |-- build_version: string (nullable = true)
 |-- build_id: string (nullable = true)
 |-- channel: string (nullable = true)
 |-- crash_time: string (nullable = true)
 |-- application: string (nullable = true)
 |-- os_name: string (nullable = true)
 |-- os_version: string (nullable = true)
 |-- architecture: string (nullable = true)
 |-- country: string (nullable = true)
 |-- experiment_id: string (nullable = true)
 |-- experiment_branch: string (nullable = true)
 |-- experiments: map (nullable = true)
 |    |-- key: string
 |    |-- value: string (valueContainsNull = true)
 |-- e10s_enabled: boolean (nullable = true)
 |-- gfx_compositor: string (nullable = true)
 |-- profile_created: integer (nullable = true)
 |-- payload: struct (nullable = true)
 |    |-- crashDate: string (nullable = true)
 |    |-- processType: string (nullable = true)
 |    |-- hasCrashEnvironment: boolean (nullable = true)
 |    |-- metadata: map (nullable = true)
 |    |    |-- key: string
 |    |    |-- value: string (valueContainsNull = true)
 |    |-- version: integer (nullable = true)
 |-- submission_date: string (nullable = true)
</code></pre>
<p>For more detail on where these fields come from in the
<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/crash-ping.html">raw data</a>,
please look at the case classes
<a href="https://github.com/mozilla/telemetry-batch-view/blob/master/GRAVEYARD.md#crash-summary">in the <code>CrashSummaryView</code> code</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/obsolete/crash_summary/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#error-aggregates-reference" id="error-aggregates-reference">Error Aggregates Reference</a></h1>
<blockquote>
<p>As of 2019-11-21, this dataset has been deprecated and is no longer maintained. See <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594112">Bug 1594112</a> for more information.</p>
</blockquote>
<ul>
<li><a href="datasets/obsolete/error_aggregates/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/obsolete/error_aggregates/reference.html#contents">Contents</a></li>
<li><a href="datasets/obsolete/error_aggregates/reference.html#accessing-the-data">Accessing the data</a></li>
<li><a href="datasets/obsolete/error_aggregates/reference.html#further-reading">Further Reading</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/error_aggregates/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/obsolete/error_aggregates/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/obsolete/error_aggregates/reference.html#sampling">Sampling</a>
<ul>
<li><a href="datasets/obsolete/error_aggregates/reference.html#data-sources">Data sources</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/error_aggregates/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/obsolete/error_aggregates/reference.html#schema">Schema</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#introduction-26" id="introduction-26">Introduction</a></h1>
<p>The <code>error_aggregates_v2</code> table represents counts of errors counted from main and crash
pings, aggregated every 5 minutes. It is the dataset backing the main <a href="https://data-missioncontrol.dev.mozaws.net/">mission
control</a> view, but may also be queried
independently.</p>
<h4><a class="header" href="#contents-11" id="contents-11">Contents</a></h4>
<p>The <code>error_aggregates_v2</code> table contains counts of various error measures (for
example: crashes, &quot;the slow script dialog showing&quot;), aggregated across each
unique set of dimensions (for example: channel, operating system) every 5
minutes. You can get an aggregated count for any particular set of dimensions
by summing using SQL.</p>
<h5><a class="header" href="#experiment-unpacking" id="experiment-unpacking">Experiment unpacking</a></h5>
<p>It's important to note that when this dataset is written, pings from clients participating in an experiment
are aggregated on the <code>experiment_id</code> and <code>experiment_branch</code> dimensions corresponding to what experiment and branch
they are participating in. However, they are also aggregated with the rest of the population where the values of
these dimensions are null.
Therefore care must be taken when writing aggregating queries over the whole population - in these cases one needs to
filter for <code>experiment_id is null</code> and <code>experiment_branch is null</code> in order to not double-count pings from experiments.</p>
<h4><a class="header" href="#accessing-the-data-16" id="accessing-the-data-16">Accessing the data</a></h4>
<p>You can access the data via STMO. Choose <code>Athena</code> and then select the
<code>telemetry.error_aggregates_v2</code> table.</p>
<h4><a class="header" href="#further-reading-4" id="further-reading-4">Further Reading</a></h4>
<p>The code responsible for generating this dataset is <a href="https://github.com/mozilla/telemetry-streaming/blob/master/src/main/scala/com/mozilla/telemetry/streaming/ErrorAggregator.scala">here</a>.</p>
<h1><a class="header" href="#data-reference-24" id="data-reference-24">Data Reference</a></h1>
<h2><a class="header" href="#example-queries-21" id="example-queries-21">Example Queries</a></h2>
<p>Getting a large number of different crash measures across many platforms and channels
(<a href="https://sql.telemetry.mozilla.org/queries/4769/source">view on STMO</a>):</p>
<pre><code class="language-sql">SELECT window_start,
       build_id,
       channel,
       os_name,
       version,
       sum(usage_hours) AS usage_hours,
       sum(main_crashes) AS main,
       sum(content_crashes) AS content,
       sum(gpu_crashes) AS gpu,
       sum(plugin_crashes) AS plugin,
       sum(gmplugin_crashes) AS gmplugin
FROM error_aggregates_v2
  WHERE application = 'Firefox'
  AND (os_name = 'Darwin' or os_name = 'Linux' or os_name = 'Windows_NT')
  AND (channel = 'beta' or channel = 'release' or channel = 'nightly' or channel = 'esr')
  AND build_id &gt; '201801'
  AND window_start &gt; current_timestamp - (1 * interval '24' hour)
  AND experiment_id IS NULL
  AND experiment_branch IS NULL
GROUP BY window_start, channel, build_id, version, os_name
</code></pre>
<p>Get the number of <code>main_crashes</code> on Windows over a small interval
(<a href="https://sql.telemetry.mozilla.org/queries/51677">view on STMO</a>):</p>
<pre><code class="language-sql">SELECT window_start as time, sum(main_crashes) AS main_crashes
FROM error_aggregates_v2
  WHERE application = 'Firefox'
  AND os_name = 'Windows_NT'
  AND channel = 'release'
  AND version = '58.0.2'
  AND window_start &gt; timestamp '2018-02-21'
  AND window_end &lt; timestamp '2018-02-22'
  AND experiment_id IS NULL
  AND experiment_branch IS NULL
GROUP BY window_start
</code></pre>
<h2><a class="header" href="#sampling-4" id="sampling-4">Sampling</a></h2>
<h3><a class="header" href="#data-sources-1" id="data-sources-1">Data sources</a></h3>
<p>The aggregates in this data source are derived from main, crash and core <a href="datasets/obsolete/error_aggregates/../../pings.html">pings</a>:</p>
<ul>
<li>crash pings are used to count/gather main and content crash events, all other errors from desktop clients (including all other crashes) are gathered from main pings</li>
<li>core pings are used to count usage hours, first subsession and unique client counts.</li>
</ul>
<h2><a class="header" href="#scheduling-23" id="scheduling-23">Scheduling</a></h2>
<p>The <code>error_aggregates</code> job is run continuously, using the Spark Streaming infrastructure</p>
<h2><a class="header" href="#schema-21" id="schema-21">Schema</a></h2>
<p>The <code>error_aggregates_v2</code> table has the following columns which define its dimensions:</p>
<ul>
<li><code>window_start</code>: beginning of interval when this sample was taken</li>
<li><code>window_end</code>: end of interval when this sample was taken (will always be 5 minutes more
than <code>window_start</code> for any given row)</li>
<li><code>submission_date_s3</code>: the date pings were submitted for a particular aggregate</li>
<li><code>channel</code>: the channel, like <code>release</code> or <code>beta</code></li>
<li><code>version</code>: the version e.g. <code>57.0.1</code></li>
<li><code>display_version</code>: like version, but includes beta number if applicable e.g. <code>57.0.1b4</code></li>
<li><code>build_id</code>: the <code>YYYYMMDDhhmmss</code> timestamp the program was built, like <code>20160123180541</code>. This is also known as the <code>build ID</code> or <code>buildid</code></li>
<li><code>application</code>: application name (e.g. <code>Firefox</code> or <code>Fennec</code>)</li>
<li><code>os_name</code>: name of the OS (e.g. <code>Darwin</code> or <code>Windows_NT</code>)</li>
<li><code>os_version</code>: version of the OS</li>
<li><code>architecture</code>: build architecture, e.g. <code>x86</code></li>
<li><code>country</code>: country code for the user (determined using geoIP), like <code>US</code> or <code>UK</code></li>
<li><code>experiment_id</code>: identifier of the experiment being participated in, such as <code>e10s-beta46-noapz@experiments.mozilla.org</code>, null if no experiment or for unpacked rows (see <a href="datasets/obsolete/error_aggregates/reference.html#experiment-unpacking">Experiment unpacking</a>)</li>
<li><code>experiment_branch</code>: the branch of the experiment being participated in, such as <code>control</code> or <code>experiment</code>, null if no experiment or for unpacked rows (see <a href="datasets/obsolete/error_aggregates/reference.html#experiment-unpacking">Experiment unpacking</a>)</li>
</ul>
<p>And these are the various measures we are counting:</p>
<ul>
<li><code>usage_hours</code>: number of usage hours (i.e. total number of session hours reported by the pings in this aggregate, note that this might include time where
people are not actively using the browser or their computer is asleep)</li>
<li><code>count</code>: number of pings processed in this aggregate</li>
<li><code>main_crashes</code>: number of main process crashes (or just program crashes, in the non-e10s case)</li>
<li><code>startup_crashes</code> : number of startup crashes</li>
<li><code>content_crashes</code>: number of content process crashes (<code>version =&gt; 58</code> only)</li>
<li><code>gpu_crashes</code>: number of GPU process crashes</li>
<li><code>plugin_crashes</code>: number of plugin process crashes</li>
<li><code>gmplugin_crashes</code>: number of Gecko media plugin (often abbreviated <code>GMPlugin</code>) process crashes</li>
<li><code>content_shutdown_crashes</code>: number of content process crashes that were caused by failure to shut down in a timely manner (<code>version =&gt; 58</code> only)</li>
<li><code>browser_shim_usage_blocked</code>: number of times a CPOW shim was blocked from being created by browser code</li>
<li><code>permissions_sql_corrupted</code>: number of times the permissions SQL error occurred (beta/nightly only)</li>
<li><code>defective_permissions_sql_removed</code>: number of times there was a removal of defective <code>permissions.sqlite</code> (beta/nightly only)</li>
<li><code>slow_script_notice_count</code>: number of times the slow script notice count was shown (beta/nightly only)</li>
<li><code>slow_script_page_count</code>: number of pages that trigger slow script notices (beta/nightly only)</li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/obsolete/error_aggregates/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#first-shutdown-summary" id="first-shutdown-summary">First Shutdown Summary</a></h1>
<ul>
<li><a href="datasets/obsolete/first_shutdown_summary/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/obsolete/first_shutdown_summary/reference.html#contents">Contents</a></li>
<li><a href="datasets/obsolete/first_shutdown_summary/reference.html#background-and-caveats">Background and Caveats</a></li>
<li><a href="datasets/obsolete/first_shutdown_summary/reference.html#accessing-the-data">Accessing the Data</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#introduction-27" id="introduction-27">Introduction</a></h1>
<p>The <code>first_shutdown_summary</code> table is a summary of the <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/first-shutdown-ping.html"><code>first-shutdown</code>
ping</a>.</p>
<h4><a class="header" href="#contents-12" id="contents-12">Contents</a></h4>
<p>The first shutdown ping contains first session usage data. The
dataset has rows similar to the
<a href="datasets/obsolete/first_shutdown_summary//datasets/batch_view/new_profile/reference.html"><code>telemetry_new_profile_parquet</code></a>,
but in the shape of
<a href="datasets/obsolete/first_shutdown_summary//datasets/batch_view/main_summary/reference.html"><code>main_summary</code></a>.</p>
<h4><a class="header" href="#background-and-caveats-11" id="background-and-caveats-11">Background and Caveats</a></h4>
<p>Ping latency was reduced through the
shutdown ping-sender mechanism in Firefox 55. To maintain consistent historical
behavior, the first main ping is not sent until the second start up. In Firefox 57, a
separate first-shutdown ping was created to evaluate first-shutdown behavior while maintaining backwards compatibility.</p>
<p>In many cases, the first-shutdown ping is a duplicate of the main ping. The first-shutdown summary can be used in conjunction with the main summary by taking the union and deduplicating on the <code>document_id</code>.</p>
<h4><a class="header" href="#accessing-the-data-17" id="accessing-the-data-17">Accessing the Data</a></h4>
<p>The data can be accessed as <code>first_shutdown_summary</code>.</p>
<p>The data is backfilled to 2017-09-22, the date of its first nightly appearance. This data should be available to all releases on and after Firefox 57.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/obsolete/first_shutdown_summary/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#heavy-users" id="heavy-users">Heavy Users</a></h1>
<blockquote>
<p>As of 2018-05-18, this dataset has been deprecated and is no longer maintained. See <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1455314">Bug 1455314</a></p>
</blockquote>
<ul>
<li><a href="datasets/obsolete/heavy_users/reference.html#replacement">Replacement</a></li>
<li><a href="datasets/obsolete/heavy_users/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/obsolete/heavy_users/reference.html#contents">Contents</a></li>
<li><a href="datasets/obsolete/heavy_users/reference.html#background-and-caveats">Background and Caveats</a></li>
<li><a href="datasets/obsolete/heavy_users/reference.html#accessing-the-data">Accessing the Data</a></li>
<li><a href="datasets/obsolete/heavy_users/reference.html#further-reading">Further Reading</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/heavy_users/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/obsolete/heavy_users/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/obsolete/heavy_users/reference.html#schema">Schema</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/heavy_users/reference.html#code-reference">Code Reference</a></li>
</ul>
<h1><a class="header" href="#replacement-1" id="replacement-1">Replacement</a></h1>
<p>We've moved to assigning user's an active tag based on <code>total_uri_count</code>, see
the <a href="datasets/obsolete/heavy_users/../../../cookbooks/active_dau.html">Active DAU definition</a>.</p>
<p>The activity of a user based on <code>active_ticks</code> is available in <code>clients_daily</code>
in the <code>active_hours_sum</code> field, which has the <code>sum(active_ticks / 720)</code>.</p>
<p>To retrieve a client's 28-day <code>active_hours</code>, use the following query:</p>
<pre><code class="language-sql">SELECT submission_date_s3,
       client_id,
       SUM(active_hours_sum) OVER (PARTITION BY client_id
                                   ORDER BY submission_date_s3 ASC
                                   ROWS 27 PRECEDING) AS monthly_active_hours
FROM
    clients_daily
</code></pre>
<h1><a class="header" href="#introduction-28" id="introduction-28">Introduction</a></h1>
<p>The <code>heavy_users</code> table provides information about whether a given <code>client_id</code> is
considered a &quot;heavy user&quot; on each day (using submission date).</p>
<h4><a class="header" href="#contents-13" id="contents-13">Contents</a></h4>
<p>The <code>heavy_users</code> table contains one row per client-day, where day is
<code>submission_date</code>. A client has a row for a specific <code>submission_date</code> if
they were active at all in the 28 day window ending on that <code>submission_date</code>.</p>
<p>A user is a &quot;heavy user&quot; as of day N if, for the 28 day period ending
on day N, the sum of their <code>active_ticks</code> is in the 90th percentile (or
above) of all clients during that period. For more analysis on this,
and a discussion of new profiles, see
<a href="https://metrics.mozilla.com/protected/sguha/heavy/heavycutoffs5.html">this link</a>.</p>
<h4><a class="header" href="#background-and-caveats-12" id="background-and-caveats-12">Background and Caveats</a></h4>
<ol>
<li>Data starts at 20170801. There is technically data in the table before
this, but the <code>heavy_user</code> column is <code>NULL</code> for those dates because it
needed to bootstrap the first 28 day window.</li>
<li>Because it is top the 10% of clients for each 28 day period, more
than 10% of clients active on a given <code>submission_date</code> will be
considered heavy users. If you join with another data source
(<code>main_summary</code>, for example), you may see a larger proportion of heavy
users than expected.</li>
<li>Each day has a separate, but related, set of heavy users. Initial
investigations show that approximately 97.5% of heavy users as of a
certain day are still considered heavy users as of the next day.</li>
<li>There is no &quot;fixing&quot; or weighting of new profiles - days before the
profile was created are counted as zero <code>active_ticks</code>. Analyses may
need to use the included <code>profile_creation_date</code> field to take this
into account.</li>
</ol>
<h4><a class="header" href="#accessing-the-data-18" id="accessing-the-data-18">Accessing the Data</a></h4>
<p>The data is available both via <code>sql.t.m.o</code> and Spark.</p>
<p>In Spark:</p>
<pre><code class="language-python">spark.read.parquet(&quot;s3://telemetry-parquet/heavy_users/v1&quot;)
</code></pre>
<p>In SQL:</p>
<pre><code class="language-sql">SELECT * FROM heavy_users LIMIT 3
</code></pre>
<h4><a class="header" href="#further-reading-5" id="further-reading-5">Further Reading</a></h4>
<p>The code responsible for generating this dataset is
<a href="https://github.com/mozilla/telemetry-batch-view/blob/master/GRAVEYARD.md#heavy-users">here</a></p>
<h1><a class="header" href="#data-reference-25" id="data-reference-25">Data Reference</a></h1>
<h2><a class="header" href="#example-queries-22" id="example-queries-22">Example Queries</a></h2>
<p>Example queries:</p>
<ul>
<li><a href="https://sql.telemetry.mozilla.org/queries/47041/source#127382">Join <code>heavy_users</code> with <code>main_summary</code> to get distribution of <code>max_concurrent_tab_count</code> for heavy vs. non-heavy users</a></li>
<li><a href="https://sql.telemetry.mozilla.org/queries/47044/source#127385">Join <code>heavy_users</code> with <code>longitudinal</code> to get crash rates for heavy vs. non-heavy users</a></li>
</ul>
<h2><a class="header" href="#schema-22" id="schema-22">Schema</a></h2>
<p>As of 2017-10-05, the current version of the <code>heavy_users</code> dataset is <code>v1</code>, and has a schema as follows:</p>
<pre><code>root
 |-- client_id: string (nullable = true)
 |-- sample_id: integer (nullable = true)
 |-- profile_creation_date: long (nullable = true)
 |-- active_ticks: long (nullable = true)
 |-- active_ticks_period: long (nullable = true)
 |-- heavy_user: boolean (nullable = true)
 |-- prev_year_heavy_user: boolean (nullable = true)
 |-- submission_date_s3: string (nullable = true)
</code></pre>
<h1><a class="header" href="#code-reference-19" id="code-reference-19">Code Reference</a></h1>
<p>This dataset is generated by
<a href="https://github.com/mozilla/telemetry-batch-view/blob/master/GRAVEYARD.md#heavy-users">telemetry-batch-view</a>.
Refer to this repository for information on how to run or augment the dataset.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/obsolete/heavy_users/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#longitudinal-reference" id="longitudinal-reference">Longitudinal Reference</a></h1>
<ul>
<li><a href="datasets/obsolete/longitudinal/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/obsolete/longitudinal/reference.html#contents">Contents</a></li>
<li><a href="datasets/obsolete/longitudinal/reference.html#background-and-caveats">Background and Caveats</a></li>
<li><a href="datasets/obsolete/longitudinal/reference.html#accessing-the-data">Accessing the Data</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/longitudinal/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/obsolete/longitudinal/reference.html#sampling">Sampling</a>
<ul>
<li><a href="datasets/obsolete/longitudinal/reference.html#pings-within-last-6-months">Pings Within Last 6 Months</a></li>
<li><a href="datasets/obsolete/longitudinal/reference.html#1-sample">1% Sample</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/longitudinal/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/obsolete/longitudinal/reference.html#schema">Schema</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/longitudinal/reference.html#code-reference">Code Reference</a></li>
</ul>
<h1><a class="header" href="#introduction-29" id="introduction-29">Introduction</a></h1>
<p>The <code>longitudinal</code> dataset is a 1% sample of main ping data
organized so that each row corresponds to a <code>client_id</code>.
If you're not sure which dataset to use for your analysis,
this is probably what you want.</p>
<h4><a class="header" href="#contents-14" id="contents-14">Contents</a></h4>
<p>Each row in the <code>longitudinal</code> dataset represents one <code>client_id</code>,
which is approximately a user.
Each column represents a field from the main ping.
Most fields contain <strong>arrays of values</strong>, with one value for each ping associated with a <code>client_id</code>.
Using arrays give you access to the raw data from each ping,
but can be difficult to work with from SQL.
Here's a <a href="https://sql.telemetry.mozilla.org/queries/4188#table">query showing some sample data</a>
to help illustrate.</p>
<h4><a class="header" href="#background-and-caveats-13" id="background-and-caveats-13">Background and Caveats</a></h4>
<p>Think of the longitudinal table as wide and short.
The dataset contains more columns than <code>main_summary</code>
and down-samples to 1% of all clients to reduce query computation time and save resources.</p>
<p>In summary, the longitudinal table differs from <code>main_summary</code> in two important ways:</p>
<ul>
<li>The longitudinal dataset groups all data so that one row represents a <code>client_id</code></li>
<li>The longitudinal dataset samples to 1% of all <code>client_id</code>s</li>
</ul>
<p>Please note that this dataset only contains release (or opt-out) histograms and scalars.</p>
<h4><a class="header" href="#accessing-the-data-19" id="accessing-the-data-19">Accessing the Data</a></h4>
<p>The <code>longitudinal</code> is available in STMO,
though it can be difficult to work with the array values in SQL.
Take a look at this <a href="https://sql.telemetry.mozilla.org/queries/4189/source">example query</a>.</p>
<p>The data is stored as a parquet table in S3 at the following address.</p>
<pre><code>s3://telemetry-parquet/longitudinal/
</code></pre>
<h1><a class="header" href="#data-reference-26" id="data-reference-26">Data Reference</a></h1>
<h2><a class="header" href="#sampling-5" id="sampling-5">Sampling</a></h2>
<h3><a class="header" href="#pings-within-last-6-months" id="pings-within-last-6-months">Pings Within Last 6 Months</a></h3>
<p>The <code>longitudinal</code> filters to <code>main</code> pings from within the last 6 months.</p>
<h3><a class="header" href="#1-sample" id="1-sample">1% Sample</a></h3>
<p>The longitudinal dataset samples down to 1% of all clients in the above sample.
The sample is generated by the following process:</p>
<ul>
<li>hash the <code>client_id</code> for each ping from the last 6 months.</li>
<li>project that hash onto an integer from 1:100, inclusive</li>
<li>filter to pings with <code>client_id</code>s matching a 'magic number' (in this case 42)</li>
</ul>
<p>This process has a couple of nice properties:</p>
<ul>
<li>The sample is consistent over time.
The <code>longitudinal</code> dataset is regenerated weekly.
The clients included in each run are very similar with this process.
The only change will come from never-before-seen clients,
or clients without a ping in the last 180 days.</li>
<li>We don't need to adjust the sample as new clients enter or exit our pool.</li>
</ul>
<p>More practically,
the sample is created by filtering to pings with <code>main_summary.sample_id == 42</code>.
If you're working with <code>main_summary</code>,
you can recreate this sample by doing this filter manually.</p>
<h2><a class="header" href="#scheduling-24" id="scheduling-24">Scheduling</a></h2>
<p>The <code>longitudinal</code> job is run weekly, early on Sunday morning UTC.
The job is scheduled on <a href="https://github.com/mozilla/telemetry-airflow">Airflow</a>.
The DAG is <a href="https://github.com/mozilla/telemetry-airflow/blob/54cffc42a2ca24e46056b7030735f0d4d093c0c7/dags/longitudinal.py">here</a>.</p>
<h2><a class="header" href="#schema-23" id="schema-23">Schema</a></h2>
<p><code>TODO(harter)</code>: https://bugzilla.mozilla.org/show_bug.cgi?id=1361862</p>
<h1><a class="header" href="#code-reference-20" id="code-reference-20">Code Reference</a></h1>
<p>This dataset is generated by
<a href="https://github.com/mozilla/telemetry-batch-view/blob/master/GRAVEYARD.md#longitudinal">telemetry-batch-view</a>.
Refer to this repository for information on how to run or augment the dataset.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/obsolete/longitudinal/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#1-day-retention" id="1-day-retention">1 Day Retention</a></h1>
<blockquote>
<p>As of 2019-08-13, this dataset has been deprecated and is no longer
maintained. See <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1571565">Bug
1571565</a> for historical
sources. See the <a href="datasets/obsolete/retention/../../../cookbooks/retention.html">retention cookbook</a> for
current best practices.</p>
</blockquote>
<ul>
<li><a href="datasets/obsolete/retention/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/obsolete/retention/reference.html#contents">Contents</a></li>
<li><a href="datasets/obsolete/retention/reference.html#background-and-caveats">Background and Caveats</a></li>
<li><a href="datasets/obsolete/retention/reference.html#accessing-the-data">Accessing the Data</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/retention/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/obsolete/retention/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/obsolete/retention/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/obsolete/retention/reference.html#schema">Schema</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/retention/reference.html#code-reference">Code Reference</a></li>
</ul>
<h1><a class="header" href="#introduction-30" id="introduction-30">Introduction</a></h1>
<p>The <code>retention</code> table provides client counts relevant to client retention at a
1-day granularity. The project is tracked in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1381840">Bug 1381840</a></p>
<h3><a class="header" href="#contents-15" id="contents-15">Contents</a></h3>
<p>The <code>retention</code> table contains a set of attribute columns used to specify a
cohort of users and a set of metric columns to describe cohort activity. Each
row contains a permutation of attributes, an approximate set of clients in a
cohort, and the aggregate engagement metrics.</p>
<p>This table uses the HyperLogLog (HLL) sketch to create an approximate set of
clients in a cohort. HLL allows counting across overlapping cohorts in a single
pass while avoiding the problem of double counting. This data-structure has the
benefit of being compact and performant in the context of retention analysis,
at the expense of precision. For example, calculating a 7-day retention period
can be obtained by aggregating over a week of retention data using the union
operation. With SQL primitive, this requires a recalculation of COUNT DISTINCT
over <code>client_id</code>'s in the 7-day window.</p>
<h4><a class="header" href="#background-and-caveats-14" id="background-and-caveats-14">Background and Caveats</a></h4>
<ol>
<li>The data starts at 2017-03-06, the <a href="https://wiki.mozilla.org/RapidRelease/Calendar">merge date where Nightly started to
track Firefox 55 in Mozilla-Central</a>. However, there was
not a consistent view into the behavior of first session profiles until the
<a href="datasets/obsolete/retention//datasets/batch_view/new_profile/reference.html"><code>new_profile</code> ping</a>. This means much of the data is inaccurate
before 2017-06-26.</li>
<li>This dataset uses 4 day reporting latency to aggregate at least 99% of the
data in a given submission date. This figure is derived from the
<a href="https://sql.telemetry.mozilla.org/dashboard/telemetry-health">telemetry-health measurements on submission latency</a>, with
the discussion in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1407410">Bug 1407410</a>. This latency metric was reduced
Firefox 55 with the introduction of the shutdown ping-sender mechanism.</li>
<li>Caution should be taken before adding new columns. Additional attribute
columns will grow the number of rows exponentially.</li>
<li>The number of HLL bits chosen for this dataset is 13. This means the default
size of the HLL object is 2^13 bits or 1KiB. This maintains about a 1% error
on average. See <a href="https://github.com/twitter/algebird/blob/develop/algebird-core/src/main/scala/com/twitter/algebird/HyperLogLog.scala#L230-L255">this table from Algebird's HLL implementation</a> for
more details.</li>
</ol>
<h4><a class="header" href="#accessing-the-data-20" id="accessing-the-data-20">Accessing the Data</a></h4>
<p>The data is primarily available through <a href="https://sql.telemetry.mozilla.org">STMO</a> via
the Presto source. This service has been configured to use predefined HLL
functions.</p>
<p>The column should first be cast to the HLL type. The scalar
<code>cardinality(&lt;hll_column&gt;)</code> function will approximate the number of unique
items per HLL object. The aggregate <code>merge(&lt;hll_column&gt;)</code> function will perform
the set union between all objects in a column.</p>
<p>Example: Cast the count column into the appropriate type.</p>
<pre><code class="language-sql">SELECT cast(hll as HLL) as n_profiles_hll FROM retention
</code></pre>
<p>Count the number of clients seen over all attribute combinations.</p>
<pre><code class="language-sql">SELECT cardinality(cast(hll as HLL)) FROM retention
</code></pre>
<p>Group-by and aggregate client counts over different release channels.</p>
<pre><code class="language-sql">SELECT channel, cardinality(merge(cast(hll AS HLL))
FROM retention
GROUP BY channel
</code></pre>
<p>The HyperLogLog library wrappers are available for use outside of the
configured STMO environment, <a href="https://github.com/mozilla/spark-hyperloglog"><code>spark-hyperloglog</code></a> and
<a href="https://github.com/vitillo/presto-hyperloglog"><code>presto-hyperloglog</code></a>.</p>
<p>Also see the <a href="datasets/obsolete/retention//datasets/obsolete/client_count_daily/reference.html"><code>client_count_daily</code> dataset</a>.</p>
<h1><a class="header" href="#data-reference-27" id="data-reference-27">Data Reference</a></h1>
<h2><a class="header" href="#example-queries-23" id="example-queries-23">Example Queries</a></h2>
<p>See the <a href="https://sql.telemetry.mozilla.org/dashboard/firefox-telemetry-retention-dataset-example-usage">Example Usage Dashboard</a> for more usages of datasets of
the same shape.</p>
<h2><a class="header" href="#scheduling-25" id="scheduling-25">Scheduling</a></h2>
<p>The job is scheduled on Airflow on a daily basis after <code>main_summary</code> is run
for the day. This job requires both <code>mozetl</code> and <code>telemetry-batch-view</code> as
dependencies.</p>
<h2><a class="header" href="#schema-24" id="schema-24">Schema</a></h2>
<p>As of 2017-10-10, the current version of <code>retention</code> is <code>v1</code> and has a schema
as follows:</p>
<pre><code>root
 |-- subsession_start: string (nullable = true)
 |-- profile_creation: string (nullable = true)
 |-- days_since_creation: long (nullable = true)
 |-- channel: string (nullable = true)
 |-- app_version: string (nullable = true)
 |-- geo: string (nullable = true)
 |-- distribution_id: string (nullable = true)
 |-- is_funnelcake: boolean (nullable = true)
 |-- source: string (nullable = true)
 |-- medium: string (nullable = true)
 |-- content: string (nullable = true)
 |-- sync_usage: string (nullable = true)
 |-- is_active: boolean (nullable = true)
 |-- hll: binary (nullable = true)
 |-- usage_hours: double (nullable = true)
 |-- sum_squared_usage_hours: double (nullable = true)
 |-- total_uri_count: long (nullable = true)
 |-- unique_domains_count: double (nullable = true)
</code></pre>
<h1><a class="header" href="#code-reference-21" id="code-reference-21">Code Reference</a></h1>
<p>The ETL script for processing the data before aggregation is found in
<a href="https://github.com/mozilla/python_mozetl/blob/ba51f539e5f1218954b7f3536e96f50c57a1b55c/mozetl/engagement/retention/job.py"><code>mozetl.engagement.retention</code></a>. The aggregate job is found in
<a href="https://github.com/mozilla/telemetry-batch-view/blob/9428b1951545dcd7517a3e72c81e7891a6dfa1fa/src/main/scala/com/mozilla/telemetry/views/RetentionView.scala">telemetry-batch-view</a> as the <code>RetentionView</code>.</p>
<p>The <a href="https://github.com/acmiyaguchi/telemetry-airflow/blob/1b4b11d23cdd1191ed2d2be905f116d7c3c67533/jobs/retention.sh">runner script</a> performs all the necessary setup to run on
EMR. This script can be used to perform backfill.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/obsolete/retention/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#sync-summary-and-sync-flat-summary-reference" id="sync-summary-and-sync-flat-summary-reference">Sync Summary and Sync Flat Summary Reference</a></h1>
<ul>
<li><a href="datasets/obsolete/sync_summary/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/obsolete/sync_summary/reference.html#which-dataset-should-i-use">Which dataset should I use?</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/sync_summary/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/obsolete/sync_summary/reference.html#a-note-about-user-ids">A note about user IDs</a></li>
<li><a href="datasets/obsolete/sync_summary/reference.html#which-apps-send-sync-telemetry-what-about-fenix">Which apps send sync telemetry? What about Fenix?</a></li>
<li><a href="datasets/obsolete/sync_summary/reference.html#whats-an-engine">What's an engine?</a></li>
<li><a href="datasets/obsolete/sync_summary/reference.html#example-queries">Example Queries</a></li>
<li><a href="datasets/obsolete/sync_summary/reference.html#sampling">Sampling</a></li>
<li><a href="datasets/obsolete/sync_summary/reference.html#scheduling">Scheduling</a></li>
<li><a href="datasets/obsolete/sync_summary/reference.html#sync-summary-schema">Sync Summary Schema</a></li>
<li><a href="datasets/obsolete/sync_summary/reference.html#sync-flat-summary-schema">Sync Flat Summary Schema</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#introduction-31" id="introduction-31">Introduction</a></h1>
<p><em>Note: some of the information in this chapter is a duplication of the info found on <a href="https://wiki.mozilla.org/CloudServices/Sync/ReDash">this</a> wiki page. You can also find more detailed information about the data contained in the sync ping <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/sync-ping.html">here</a></em></p>
<p><code>sync_summary</code> and <code>sync_flat_summary</code> are the primary datasets that track the health of sync. <code>sync_flat_summary</code> is derived from <code>sync_summary</code> by unpacking/exploding the <code>engines</code> field of the latter, so they ultimately contain the same data (see below).</p>
<h2><a class="header" href="#which-dataset-should-i-use" id="which-dataset-should-i-use">Which dataset should I use?</a></h2>
<p>Which dataset to use depends on whether you are interested in <em>per-engine</em> sync success or <em>per-sync</em> sync success (see below). If you are interested in whether a sync failed overall, regardless of which engine may have caused the failure, then you can use <code>sync_summary</code>. Otherwise, if you are interested in per-engine data, you should use <code>sync_flat_summary</code>.</p>
<p>If you aren't sure, or just trying to get acquainted, you should probably just use <code>sync_flat_summary</code>.</p>
<h1><a class="header" href="#data-reference-28" id="data-reference-28">Data Reference</a></h1>
<h2><a class="header" href="#a-note-about-user-ids" id="a-note-about-user-ids">A note about user IDs</a></h2>
<p>Unlike most other telemetry datasets, these do not contain the profile-level identifier <code>client_id</code>. Because you need to sign up for a <a href="https://www.mozilla.org/en-US/firefox/accounts/">Firefox Account</a> in order to use sync, these datasets instead include an anonymised version of the user's Firefox Account user id <code>uid</code> and an anonymised version of their individual devices' <code>device_id</code>s. Put another way, each <code>uid</code> can have many associated <code>device_id</code>s.</p>
<p><strong>Q:</strong> Why not include <code>client_id</code> in these datasets so that they can be joined on (e.g.) <code>main_summary</code>?</p>
<p><strong>A:</strong> We've had a policy to keep main browser telemetry separate from sync and FxA telemetry. This is in part because FxA <code>uid</code>s are ultimately associated with email addresses in the FxA database, and thus a breach of that database in combination with access to telemetry could in theory de-anonymise client-side browser metrics.</p>
<h2><a class="header" href="#which-apps-send-sync-telemetry-what-about-fenix" id="which-apps-send-sync-telemetry-what-about-fenix">Which apps send sync telemetry? What about Fenix?</a></h2>
<p>Currently, Firefox for desktop, Firefox for iOS and Firefox for Android (fennec) all have sync implemented, and they all send sync telemetry. Though there are some differences in the telemetry that each application sends, it all ends up in the <code>sync_summary</code> and <code>sync_flat_summary</code> datasets.</p>
<p>Starting with Fenix, however, sync telemetry will start to be sent through <a href="https://github.com/mozilla-mobile/android-components/tree/master/components/service/glean">glean</a>. This means that, in all likelihood, Fenix sync telemetry will initially be segregated from existing sync telemetry (one reason is that current sync telemetry is on AWS while glean pings are ingested to GCP).</p>
<h2><a class="header" href="#whats-an-engine" id="whats-an-engine">What's an engine?</a></h2>
<p>Firefox syncs many different types of browser data and (generally speaking) each one of these data types are synced by their own engine. When the app triggers a &quot;sync&quot; each engine makes their own determination of what needs to be synced (if anything). Many syncs can happen in a day (dozens or more on desktop, usually less on mobile). Telemetry about each sync is logged, and each <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/sync-ping.html">sync ping</a> (sent once a day, and whenever the user logs in or out of sync) contains information about multiple syncs. The scala code responsible for creating the <code>sync_summary</code> dataset unpacks each sync ping into one row per sync. The resulting <code>engines</code> field is an array of &quot;engine records&quot;: data about how each engine performed during that sync. <code>sync_flat_summary</code> further unpacking/exploding the <code>engines</code> field and creates a dataset that is one row per engine record.</p>
<p>Existing engines (<code>engine_name</code> in <code>sync_flat_summary</code>) are listed below with brief descriptions in cases where their name isn't transparent.</p>
<p>Note that not every device syncs each of these engines. They can be disabled individually and some are off by default.</p>
<ul>
<li><code>addons</code></li>
<li><code>addresses</code> mailing addresses e.g. for e-commerce; part of form autofill.</li>
<li><code>bookmarks</code></li>
<li><code>clients</code> non-user-facing list of the sync account's associated devices</li>
<li><code>creditcards</code> this used to be nightly only but was recently removed entirely</li>
<li><code>extension-storage</code> WebExtension storage, in support of the <code>storage.sync</code> WebExtension API.</li>
<li><code>history</code> browsing history.</li>
<li><code>passwords</code></li>
<li><code>forms</code> saved values in web forms</li>
<li><code>prefs</code> not all prefs are synced</li>
<li><code>tabs</code> note that this is not the same as the &quot;send tab&quot; feature, this is the engine that syncs the tabs you have open across your devices (used to populate the synced tabs sidebar). For data on the send-tab feature use the <code>sync_events</code> dataset.</li>
</ul>
<h2><a class="header" href="#example-queries-24" id="example-queries-24">Example Queries</a></h2>
<p>See <a href="https://sql.telemetry.mozilla.org/dashboard/sync-leif-status-dashboard-wip">this dashboard</a> to get a general sense of what this dataset is typically used for.</p>
<p>Here's an example of a query that will calculate the failure and success rates for a subset of engines per day.</p>
<pre><code class="language-sql">WITH
    counts AS (
        SELECT
          submission_date_s3 AS day,
          engine_name AS engine,
          COUNT(*) AS total,
          COUNT(CASE WHEN engine_status IS NOT NULL THEN true ELSE NULL END) AS count_errors,
          /* note that `engine_status` is null on sync success. */
          COUNT(CASE WHEN engine_status IS NULL THEN true ELSE NULL END) AS count_success
        FROM telemetry.sync_flat_summary
        WHERE engine_name IN ('bookmarks','history','tabs','addons','addresses','passwords','prefs')
        AND cast(submission_date_s3 AS integer) &gt;= 20190101
        GROUP BY 1,2
        ORDER BY 1
    ),

    rates AS (
        SELECT
          day,
          engine,
          total,
          count_errors,
          count_success,
          CAST(count_errors AS double) / CAST(total AS double) * 100 AS error_rate,
          CAST(count_success AS double) / CAST(total AS double) * 100 AS success_rate
        FROM counts
        ORDER BY 1
    )

SELECT * FROM rates
</code></pre>
<h2><a class="header" href="#sampling-6" id="sampling-6">Sampling</a></h2>
<p>Sadly, these datasets are not sampled. It should be possible to derive a <code>sample_id</code> on <code>uid</code>, however. Someone should do that because querying these datasets for long time horizons is very expensive.</p>
<h2><a class="header" href="#scheduling-26" id="scheduling-26">Scheduling</a></h2>
<p>This dataset was updated daily, shortly after midnight UTC.
The job was scheduled on <a href="https://github.com/mozilla/telemetry-airflow">Airflow</a>.
The DAG was <a href="https://github.com/mozilla/telemetry-airflow/blob/27d34a73db02131a39f469f3950c1da747bc8a95/dags/sync_view.py">here</a>.</p>
<h2><a class="header" href="#sync-summary-schema" id="sync-summary-schema">Sync Summary Schema</a></h2>
<pre><code>root
 |-- app_build_id: string (nullable = true)
 |-- app_display_version: string (nullable = true)
 |-- app_name: string (nullable = true)
 |-- app_version: string (nullable = true)
 |-- app_channel: string (nullable = true)
 |-- uid: string
 |-- device_id: string (nullable = true)
 |-- when: integer
 |-- took: integer
 |-- why: string (nullable = true)
 |-- failure_reason: struct (nullable = true)
 |    |-- name: string
 |    |-- value: string (nullable = true)
 |-- status: struct (nullable = true)
 |    |-- sync: string (nullable = true)
 |    |-- status: string (nullable = true)
 |-- devices: array (nullable = true)
 |    |-- element: struct (containsNull = false)
 |    |    |-- id: string
 |    |    |-- os: string
 |    |    |-- version: string
 |-- engines: array (nullable = true)
 |    |-- element: struct (containsNull = false)
 |    |    |-- name: string
 |    |    |-- took: integer
 |    |    |-- status: string (nullable = true)
 |    |    |-- failure_reason: struct (nullable = true)
 |    |    |    |-- name: string
 |    |    |    |-- value: string (nullable = true)
 |    |    |-- incoming: struct (nullable = true)
 |    |    |    |-- applied: integer
 |    |    |    |-- failed: integer
 |    |    |    |-- new_failed: integer
 |    |    |    |-- reconciled: integer
 |    |    |-- outgoing: array (nullable = true)
 |    |    |    |-- element: struct (containsNull = false)
 |    |    |    |    |-- sent: integer
 |    |    |    |    |-- failed: integer
 |    |    |-- validation: struct (containsNull = false)
 |    |    |    |-- version: integer
 |    |    |    |-- checked: integer
 |    |    |    |-- took: integer
 |    |    |    |-- failure_reason: struct (nullable = true)
 |    |    |    |    |-- name: string
 |    |    |    |    |-- value: string (nullable = true)
 |    |    |    |-- problems: array (nullable = true)
 |    |    |    |    |-- element: struct (containsNull = false)
 |    |    |    |    |    |-- name: string
 |    |    |    |    |    |-- count: integer
</code></pre>
<h2><a class="header" href="#sync-flat-summary-schema" id="sync-flat-summary-schema">Sync Flat Summary Schema</a></h2>
<pre><code>root
|-- app_build_id: string (nullable = true)
|-- app_display_version: string (nullable = true)
|-- app_name: string (nullable = true)
|-- app_version: string (nullable = true)
|-- app_channel: string (nullable = true)
|-- os: string
|-- os_version: string
|-- os_locale: string
|-- uid: string
|-- device_id: string (nullable = true)
|-- when: integer
|-- took: integer
|-- failure_reason: struct (nullable = true)
|    |-- name: string
|    |-- value: string (nullable = true)
|-- status: struct (nullable = true)
|    |-- sync: string (nullable = true)
|    |-- status: string (nullable = true)
|-- why: string (nullable = true)
|-- devices: array (nullable = true)
|    |-- element: struct (containsNull = false)
|    |    |-- id: string
|    |    |-- os: string
|    |    |-- version: string
|-- sync_id: string
|-- sync_day: string
|-- engine_name: string
|-- engine_took: integer
|-- engine_status: string (nullable = true)
|-- engine_failure_reason: struct (nullable = true)
|    |-- name: string
|    |-- value: string (nullable = true)
|-- engine_incoming_applied: integer (nullable = true)
|-- engine_incoming_failed: integer (nullable = true)
|-- engine_incoming_new_failed: integer (nullable = true)
|-- engine_incoming_reconciled: integer (nullable = true)
|-- engine_outgoing_batch_count: integer (nullable = true)
|-- engine_outgoing_batch_total_sent: integer (nullable = true)
|-- engine_outgoing_batch_total_failed: integer (nullable = true)
|-- submission_date_s3: string
</code></pre>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/obsolete/sync_summary/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#update" id="update">Update</a></h1>
<ul>
<li><a href="datasets/obsolete/update/reference.html#introduction">Introduction</a>
<ul>
<li><a href="datasets/obsolete/update/reference.html#contents">Contents</a></li>
<li><a href="datasets/obsolete/update/reference.html#accessing-the-data">Accessing the Data</a></li>
</ul>
</li>
<li><a href="datasets/obsolete/update/reference.html#data-reference">Data Reference</a>
<ul>
<li><a href="datasets/obsolete/update/reference.html#schema">Schema</a></li>
</ul>
</li>
</ul>
<h1><a class="header" href="#introduction-32" id="introduction-32">Introduction</a></h1>
<p>The <a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/update-ping.html">update ping</a>
is sent from Firefox Desktop when a browser update is ready to be applied and after it was correctly applied.
It contains the build information and the update blob information, in addition to some information about the
user environment.</p>
<h4><a class="header" href="#contents-16" id="contents-16">Contents</a></h4>
<p>The table contains one row for each ping. Each column represents one field from the update ping payload, though only a subset of all fields are included.</p>
<h4><a class="header" href="#accessing-the-data-21" id="accessing-the-data-21">Accessing the Data</a></h4>
<p>Query the <code>telemetry.update</code> view in BigQuery as in the <a href="https://sql.telemetry.mozilla.org/queries/31267#table">example query in STMO</a>.</p>
<h1><a class="header" href="#data-reference-29" id="data-reference-29">Data Reference</a></h1>
<h2><a class="header" href="#schema-25" id="schema-25">Schema</a></h2>
<p>As of 2017-09-07, the current version of the <code>telemetry_update_parquet</code> dataset is <code>v1</code>, and has a schema as follows:</p>
<pre><code>root
 |-- id: string (nullable = true)
 |-- client_id: string (nullable = true)
 |-- metadata: struct (nullable = true)
 |    |-- timestamp: long (nullable = true)
 |    |-- date: string (nullable = true)
 |    |-- normalized_channel: string (nullable = true)
 |    |-- geo_country: string (nullable = true)
 |    |-- geo_city: string (nullable = true)
 |    |-- creation_timestamp: long (nullable = true)
 |    |-- x_ping_sender_version: string (nullable = true)
 |-- application: struct (nullable = true)
 |    |-- displayVersion: string (nullable = true)
 |-- environment: struct (nullable = true)
 |    |-- build: struct (nullable = true)
 |    |    |-- application_name: string (nullable = true)
 |    |    |-- architecture: string (nullable = true)
 |    |    |-- version: string (nullable = true)
 |    |    |-- build_id: string (nullable = true)
 |    |    |-- vendor: string (nullable = true)
 |    |    |-- hotfix_version: string (nullable = true)
 |    |-- partner: struct (nullable = true)
 |    |    |-- distribution_id: string (nullable = true)
 |    |    |-- distribution_version: string (nullable = true)
 |    |    |-- partner_id: string (nullable = true)
 |    |    |-- distributor: string (nullable = true)
 |    |    |-- distributor_channel: string (nullable = true)
 |    |    |-- partner_names: array (nullable = true)
 |    |    |    |-- element: string (containsNull = true)
 |    |-- settings: struct (nullable = true)
 |    |    |-- telemetry_enabled: boolean (nullable = true)
 |    |    |-- locale: string (nullable = true)
 |    |    |-- update: struct (nullable = true)
 |    |    |    |-- channel: string (nullable = true)
 |    |    |    |-- enabled: boolean (nullable = true)
 |    |    |    |-- auto_download: boolean (nullable = true)
 |    |-- system: struct (nullable = true)
 |    |    |-- os: struct (nullable = true)
 |    |    |    |-- name: string (nullable = true)
 |    |    |    |-- version: string (nullable = true)
 |    |    |    |-- locale: string (nullable = true)
 |    |-- profile: struct (nullable = true)
 |    |    |-- creation_date: long (nullable = true)
 |-- payload: struct (nullable = true)
 |    |-- reason: string (nullable = true)
 |    |-- target_channel: string (nullable = true)
 |    |-- target_version: string (nullable = true)
 |    |-- target_build_id: string (nullable = true)
 |    |-- target_display_version: string (nullable = true)
 |    |-- previous_channel: string (nullable = true)
 |    |-- previous_version: string (nullable = true)
 |    |-- previous_build_id: string (nullable = true)
 |-- submission_date_s3: string (nullable = true)
</code></pre>
<p>For more detail on the raw ping these fields come from, see the
<a href="https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/data/update-ping.html">raw data</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/datasets/obsolete/update/reference.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#contributing" id="contributing">Contributing</a></h1>
<p>Documentation is critical to making a usable data platform.
In surveys of users of the Mozilla Data Platform,
the most common complaint has been lack of documentation.
It is therefore important to expand and improve the documentation as often as possible.</p>
<ul>
<li><a href="contributing/index.html#bug-reports">Bug reports</a></li>
<li><a href="contributing/index.html#fixing-minor-problems">Fixing minor problems</a></li>
<li><a href="contributing/index.html#building-the-documentation">Building the Documentation</a></li>
<li><a href="contributing/index.html#adding-a-new-article">Adding a new article</a></li>
<li><a href="contributing/index.html#review">Review</a></li>
<li><a href="contributing/index.html#supported-plugins">Supported Plugins</a>
<ul>
<li><a href="contributing/index.html#table-of-contents">Table of contents</a></li>
<li><a href="contributing/index.html#mermaid">Mermaid</a></li>
</ul>
</li>
<li><a href="contributing/index.html#publishing">Publishing</a></li>
</ul>
<h2><a class="header" href="#bug-reports" id="bug-reports">Bug reports</a></h2>
<p>If you see an error in the documentation or want to extend a chapter,
<a href="https://bugzilla.mozilla.org/enter_bug.cgi?assigned_to=nobody%40mozilla.org&amp;bug_file_loc=http%3A%2F%2F&amp;bug_ignored=0&amp;bug_severity=normal&amp;bug_status=NEW&amp;cf_fx_iteration=---&amp;cf_fx_points=---&amp;component=Documentation%20and%20Knowledge%20Repo%20%28RTMO%29&amp;contenttypemethod=autodetect&amp;contenttypeselection=text%2Fplain&amp;defined_groups=1&amp;flag_type-4=X&amp;flag_type-607=X&amp;flag_type-800=X&amp;flag_type-803=X&amp;flag_type-916=X&amp;form_name=enter_bug&amp;maketemplate=Remember%20values%20as%20bookmarkable%20template&amp;op_sys=Linux&amp;priority=--&amp;product=Data%20Platform%20and%20Tools&amp;rep_platform=x86_64&amp;target_milestone=---&amp;version=unspecified">file a bug</a>.</p>
<h2><a class="header" href="#fixing-minor-problems" id="fixing-minor-problems">Fixing minor problems</a></h2>
<p>For smaller issues (for example, a typo or minor inaccuracy), it is not necessary to file a bug or even
check out the source.
Instead, use the <code>Edit on GitHub</code> button on the bottom of any page, make your changes, and file a pull request entirely from the GitHub interface.</p>
<h2><a class="header" href="#building-the-documentation" id="building-the-documentation">Building the Documentation</a></h2>
<p>This documentation is stored as <a href="https://commonmark.org/help/">CommonMark Markdown</a> in the
<a href="https://github.com/mozilla/data-docs"><code>data-docs</code> repository</a> on GitHub.
To build a local copy, fork the repository and check out your copy. Then, <a href="https://github.com/mozilla/data-docs/blob/master/README.md#building-the-documentation">see the README</a> for up-to-date information on how to build the documentation.</p>
<h2><a class="header" href="#adding-a-new-article" id="adding-a-new-article">Adding a new article</a></h2>
<p>You should read the <a href="contributing/./style_guide.html">style guide</a> before adding a new article: it will help you write material that is more useful and fits cohesively into the rest of the documentation.</p>
<p>Be sure to link to your new article from <code>SUMMARY.md</code>, or mdBook will not render the file.</p>
<p>The structure of the repository is outlined in <a href="contributing/./structure.html">this article</a>.</p>
<p>This documentation is under active development,
so we may already be working on the documentation you need.
Take a look at
<a href="https://bugzilla.mozilla.org/buglist.cgi?product=Data%20Platform%20and%20Tools&amp;component=Documentation%20and%20Knowledge%20Repo%20%28RTMO%29&amp;resolution=---">this bug component</a>
to check.</p>
<h2><a class="header" href="#review" id="review">Review</a></h2>
<p>Once you're happy with your contribution, open a pull request (PR). Give your PR a meaningful commit message
(see <a href="https://chris.beams.io/posts/git-commit/">this article on commit message guidelines</a> for some suggestions).
If there is a bug associated with your documentation, title it in the form of <code>Bug 1234 - &lt;descriptive one-liner&gt;</code> - that way, the <a href="https://github.com/mozilla/github-bugzilla-pr-linker">Bugzilla PR linker</a> will pick up the PR and attach it to the bug.</p>
<p>After filing your PR, assign the appropriate person for review (GitHub will usually provide some suggestions), assuming you have permissions to do so yourself.
If you do not have permission to assign a reviewer, see <a href="contributing/../concepts/getting_help.html">getting help</a>.</p>
<h2><a class="header" href="#supported-plugins" id="supported-plugins">Supported Plugins</a></h2>
<h3><a class="header" href="#table-of-contents-20" id="table-of-contents-20">Table of contents</a></h3>
<p>You can insert a table of contents in any article by using the <code>toc</code> shorthand. For example:</p>
<pre><code># My fine title

This article describes how to perform action X.

&lt;!-- toc --&gt;

## Section 1

...

## Section 2
</code></pre>
<p>For an example of what the rendered table of contents looks like, see the beginning of this article.</p>
<h3><a class="header" href="#mermaid" id="mermaid">Mermaid</a></h3>
<p>You can use <a href="https://mermaidjs.github.io/"><code>mermaid.js</code></a> diagrams in code blocks. For example:</p>
<pre><code class="language-md">```mermaid
graph LR
  you --&gt;|write|docs
  docs --&gt; profit!
```
</code></pre>
<p>... is rendered as:</p>
<pre class="mermaid">graph LR
  you --&gt;|write|docs
  docs --&gt; profit!
</pre>
<h2><a class="header" href="#publishing" id="publishing">Publishing</a></h2>
<p>The documentation is hosted on <a href="https://pages.github.com/">Github Pages</a>.</p>
<p>Updates to the documentation are automatically published to
<a href="https://docs.telemetry.mozilla.org">docs.telemetry.mozilla.org</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/contributing/index.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#style-guide" id="style-guide">Style Guide</a></h1>
<p>These are some general style guidelines for articles which appear on <code>docs.telemetry.mozilla.org</code> (DTMO). Reading these guidelines can help you write content that is more accessible and easier to understand.</p>
<ul>
<li><a href="contributing/style_guide.html#audience">Audience</a></li>
<li><a href="contributing/style_guide.html#what-to-write">What to write</a></li>
<li><a href="contributing/style_guide.html#what-not-to-write">What not to write</a>
<ul>
<li><a href="contributing/style_guide.html#implementation-specific-articles">Implementation-specific articles</a></li>
<li><a href="contributing/style_guide.html#lists-of-links">Lists of links</a></li>
</ul>
</li>
<li><a href="contributing/style_guide.html#general-guidelines">General guidelines</a></li>
<li><a href="contributing/style_guide.html#writing-style">Writing style</a></li>
<li><a href="contributing/style_guide.html#colophon">Colophon</a></li>
</ul>
<h2><a class="header" href="#audience" id="audience">Audience</a></h2>
<p><em>Data practitioners</em> at Mozilla represent the primary audience for DTMO. A &quot;data practitioner&quot; is someone who wants to inform themselves or others using Mozilla-collected data. Here are some real-world examples of this persona:</p>
<ul>
<li>A data scientist performing an experiment analysis</li>
<li>An analyst producing a report on the effectiveness of a recent marketing campaign</li>
<li>A Firefox engineer trying to measure the performance of a new feature</li>
<li>A technical product manager trying to understand the characteristics of a particular user segment</li>
<li>A quality assurance engineer trying to understand the severity and frequency of a new Firefox crash</li>
</ul>
<p>In general, you can assume that readers have at least some technical knowledge.
Different articles on DTMO may have different target audiences: when you write a new article, you should consider who you are writing it for and adjust your content appropriately.
For example, a new product manager may require more careful hand-holding (and links to relevant concept or reference material) than a data scientist with many years of experience at Mozilla.</p>
<p>Note that &quot;data engineers&quot; (the maintainers of the Mozilla data platform and tools) are <em>not</em> the target audience for DTMO, though they may find some resources here helpful in the course of the work.
If something is <em>only</em> of interest to a data engineer, it probably belongs elsewhere: see the note below on <a href="contributing/style_guide.html#implementation-specific-articles">implementation-specific articles</a>.</p>
<h2><a class="header" href="#what-to-write" id="what-to-write">What to write</a></h2>
<p>There are three different types of documentation that are useful as part of a site like DTMO:</p>
<ul>
<li>Introductory material: Material intended to help people get their bearings with Mozilla's telemetry system. A set of these articles form the <a href="contributing/../concepts/getting_started.html">Getting Started</a> section on this site.</li>
<li>Tutorials &amp; Cookbooks: Instructions on how to perform specific tasks using Mozilla's data platform. The focus here is on how to do things, rather than on what they are.</li>
<li>Reference: Reference material on either <a href="contributing/../datasets/reference.html">datasets</a> or the <a href="contributing/../reference/index.html">data platform itself</a>. The focus is on describing how things work or what they do, rather than how to use them.</li>
</ul>
<p>In general, the most useful documentation for newcomers is usually a cookbook or tutorial as <a href="https://stevelosh.com/blog/2013/09/teach-dont-tell/">they often don't know where to begin</a>. For advanced users, reference material may be more useful.</p>
<h2><a class="header" href="#what-not-to-write" id="what-not-to-write">What <em>not</em> to write</a></h2>
<p>There are a few types of documentation that are less appropriate for a general-purpose reference like DTMO.</p>
<h3><a class="header" href="#implementation-specific-articles" id="implementation-specific-articles">Implementation-specific articles</a></h3>
<p>Any articles that are specific to the implementation of particular data systems or tools should be published alongside the system or tool itself. Examples of this may include:</p>
<ul>
<li>Usage guides for command-line tools</li>
<li>In-depth documentation on architecture and design choices (beyond a general overview)</li>
<li>A general usage guide for <a href="contributing/../tools/interfaces.html">specific data tool</a></li>
</ul>
<p>In the past, this type of documentation has gone out of date quickly as people update the implementation while forgetting to update what has been written here.
Vast amounts of implementation detail can also be overwhelming to anyone who just wants to get an answer to a data-related question.</p>
<p>That said, it can sometimes be useful to provide a general overview of a topic on DTMO while saving the details for site-specific documentation.
A good example of this is the <a href="https://mozilla.github.io/gcp-ingestion/">gcp-ingestion</a> documentation: while we maintain <a href="contributing/../concepts/pipeline/gcp_data_pipeline.html">a high-level description of the data pipeline here</a>, details on the Beam-specific implementation are stored alongside the source on GitHub.</p>
<h3><a class="header" href="#lists-of-links" id="lists-of-links">Lists of links</a></h3>
<p>Articles which simply link out to other resources are of limited value and tend to go out of date quickly. Instead, consider your motivation for producing the list and think about what your <a href="contributing/style_guide.html#audience">intended audience</a> might need. Concept, reference, or tutorial documentation need not be long to be helpful.</p>
<p>Of course, linking to other resources as part of other documentation is always okay.</p>
<h2><a class="header" href="#general-guidelines" id="general-guidelines">General guidelines</a></h2>
<ul>
<li>Articles should be written in Markdown:
mdBook uses the <a href="https://commonmark.org/help/">CommonMark dialect</a>
as implemented by <a href="https://github.com/raphlinus/pulldown-cmark"><code>pulldown-cmark</code></a>,
which supports certain extensions including GitHub-flavored tables.</li>
<li>Limit lines to <strong>100 characters</strong> where possible.
Try to split lines at the end of sentences,
or use <a href="http://rhodesmill.org/brandon/2012/one-sentence-per-line/">Semantic Line Breaks</a>.
This makes it easier to reorganize your thoughts later.</li>
<li>This documentation is almost always read digitally.
Keep in mind that people read digital content much differently than other media.
Specifically, readers are going to skim your writing,
so make it easy to identify important information.
<ul>
<li>Use <strong>visual markup</strong> like <strong>bold text</strong>, <code>code blocks</code>, and section headers.</li>
<li>Avoid long paragraphs: short paragraphs that describe one concept each makes finding important information easier.</li>
<li>When writing longer articles with many sections, use a <a href="contributing/./index.html#table-of-contents">table of contents</a> to help people quickly navigate to a section of interest.</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#writing-style" id="writing-style">Writing style</a></h2>
<p>The following is a distillation of common best practices for technical writing in a resource like DTMO. Following these guidelines helps give our documentation a consistent voice and makes it easier to read:</p>
<ul>
<li>In general: use a friendly, conversational tone. This makes the documentation more approachable.</li>
<li>Avoid specifying particular people or teams unless absolutely necessary: change is constant at Mozilla, and the person or people who maintains a system today is not necessarily the same as yesterday.</li>
<li>If possible, use &quot;you&quot; when describing how to do something. Avoid use of first person (for example: &quot;I&quot;, &quot;we&quot;, &quot;our&quot;) as this emphasizes the writer rather than the reader and it is often unclear who &quot;I&quot;, &quot;we&quot; or &quot;our&quot; actually refer to.</li>
<li>Avoid unnecessary formalities like &quot;please&quot; or &quot;thank you&quot;.</li>
<li>Where it makes sense, use present tense (as opposed to future tense). For example, &quot;You need to perform the following tasks&quot; is preferable to &quot;You will need to perform the following tasks&quot;.</li>
<li>Where possible, avoid the use of the passive voice (identifying the agent of action as the subject of the sentence): active voice sentences are generally clearer and less verbose. For example, &quot;Press OK to confirm changes&quot; is preferable to &quot;The system will confirm changes when you press OK&quot;. You can use a tool like <a href="https://github.com/btford/write-good">write-good</a> to identify uses of passive voice in your own work.</li>
</ul>
<p>For much more helpful advice on technical writing, you may wish to review the <a href="https://docs.openstack.org/doc-contrib-guide/writing-style/general-writing-guidelines.html">OpenStack General Writing Guidelines</a>, which inspired some of the above.</p>
<h2><a class="header" href="#colophon" id="colophon">Colophon</a></h2>
<p>You can find more context for these guidelines in
<a href="http://blog.harterrt.com/lit-review.html">this literature review</a> and <a href="https://wlach.github.io/blog/2020/05/a-principled-reorganization-of-docs-telemetry-mozilla-org/">this follow-up on organization and audience</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/contributing/style_guide.md">Edit this file on GitHub.</a></footer><h1><a class="header" href="#documentation-structure" id="documentation-structure">Documentation Structure</a></h1>
<p>The directory structure should feel comfortable to anyone who is familiar with the data platform:</p>
<pre><code>.
|--src
   |--datasets - contains dataset level documentation
   |--tools - contains tool level documentation
   |--concepts - contains tutorials meant to introduce a new concept to the reader
   |--cookbooks - focused code examples for reference
</code></pre>
<p>This documentation is meant to take the reader from beginner to expert.</p>
<ul>
<li>Getting Started: Introduce concepts and provides information on how to perform and complete a simple analysis, so the user understands the amount of work involved and what the data platform feels like. Primarily intended for people new to Mozilla's data platform.</li>
<li>Tutorials &amp; Cookbooks: Guides on how to perform specific tasks. Intended for all audiences.</li>
<li>Reference material: In-depth reference material on metrics and the data platform. Intended primarily for more advanced users.</li>
</ul>
<p>This document's structure is heavily influenced by
<a href="https://docs.djangoproject.com/en/1.11/internals/contributing/writing-documentation/">Django's Documentation Style Guide</a>.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/data-docs/edit/master/src/contributing/structure.md">Edit this file on GitHub.</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        
        <!-- Google Analytics Tag -->
        <script type="text/javascript">
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-104326577-1', 'auto');
                ga('send', 'pageview');
            }
        </script>
        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="mermaid.min.js"></script>
        
        <script type="text/javascript" src="mermaid-init.js"></script>
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>
        
        

    </body>
</html>
